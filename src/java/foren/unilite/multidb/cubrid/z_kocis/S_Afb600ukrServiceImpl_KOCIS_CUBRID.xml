<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_afb600ukrServiceImpl_KOCIS">
	
<select id="s_afb600ukrServiceImpl_KOCIS.selectRefCode" parameterType="Map" resultType="rMap">	
/* s_afb600ukrServiceImpl_KOCIS.selectRefCode */
SELECT  CODE_NAME               AS CODE_NAME
     ,  SUB_CODE                AS SUB_CODE
     ,  NVL(REF_CODE5, '')   AS REF_CODE5
     ,  NVL(REF_CODE6, '')   AS REF_CODE6
  FROM    BSA100T  
 WHERE   COMP_CODE = #{S_COMP_CODE}
   AND     MAIN_CODE = 'A171'
   AND     SUB_CODE  = #{ACCNT_GUBUN}
</select>
	
<select id="s_afb600ukrServiceImpl_KOCIS.selectCheck1" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectCheck1 */
SELECT  MAX(MAPPING)       AS MAPPING
     ,  MAX(GWIF)          AS GWIF
     ,  MAX(CONFIRM)       AS CONFIRM
     ,  MAX(CON_BUTTON_YN) AS CON_BUTTON_YN
     ,  MAX(LINE_COPY)     AS LINE_COPY
 FROM    (
        SELECT  CASE WHEN SUB_CODE = '10' THEN UPPER(REF_CODE1) ELSE '' END    AS MAPPING        --지출수입관리 아이디와 1:1 Mapping
              , CASE WHEN SUB_CODE = '22' THEN UPPER(REF_CODE1) ELSE '' END    AS GWIF           --예산기안_그룹웨어 연동여부
              , CASE WHEN SUB_CODE = '23' THEN UPPER(REF_CODE1) ELSE '' END    AS CONFIRM        --예산기안_비연계확정 버튼 사용여부
              , CASE WHEN SUB_CODE = '24' THEN UPPER(REF_CODE1) ELSE '' END    AS CON_BUTTON_YN  --예산기안_결재상신/예산확정 버튼 보임
              , CASE WHEN SUB_CODE = '25' THEN UPPER(REF_CODE1) ELSE '' END    AS LINE_COPY      --예산기안_자동 행복사 기능 사용
        FROM    BSA100T 
        WHERE   COMP_CODE   = #{S_COMP_CODE}
        AND     MAIN_CODE   = 'A169'
        AND     SUB_CODE   IN ('10', '22', '23', '24', '25')
) T
</select>

<select id="s_afb600ukrServiceImpl_KOCIS.selectCheck2" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectCheck2 */
SELECT  A.PERSON_NUMB, B.NAME
      , NVL(C.BUDG_TREE_CODE, B.DEPT_CODE) DEPT_CODE, NVL(C1.TREE_NAME, B.DEPT_NAME) DEPT_NAME, B.DIV_CODE
FROM                BSA300T   A  
        LEFT  JOIN  HUM100T   B   ON B.COMP_CODE   = A.COMP_CODE
                                 AND B.PERSON_NUMB = A.PERSON_NUMB
        LEFT  JOIN  BSA210T   C   ON C.COMP_CODE   = B.COMP_CODE
                                 AND C.TREE_CODE   = B.DEPT_CODE
        LEFT  JOIN  BSA210T   C1  ON C1.COMP_CODE  = C.COMP_CODE
                                 AND C1.TREE_CODE  = C.BUDG_TREE_CODE
WHERE   A.COMP_CODE = #{S_COMP_CODE}
AND     A.USER_ID   = #{S_USER_ID}
	
	
</select>			
<select id="s_afb600ukrServiceImpl_KOCIS.selectCheck3" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectCheck3 */
SELECT  MAX(PATH_INFO_1) + MAX(PATH_INFO_2) PATH_INFO_1
     ,  MAX(PATH_INFO_3) PATH_INFO_3
     ,  MAX(PATH_INFO_4) PATH_INFO_4
FROM    (
        SELECT  CASE WHEN SUB_CODE = '1' THEN REF_CODE3 ELSE '' END    AS PATH_INFO_1 
              , CASE WHEN SUB_CODE = '2' THEN REF_CODE3 ELSE '' END    AS PATH_INFO_2
              , CASE WHEN SUB_CODE = '3' THEN REF_CODE3 ELSE '' END    AS PATH_INFO_3
              , CASE WHEN SUB_CODE = '4' THEN REF_CODE3 ELSE '' END    AS PATH_INFO_4
        FROM    BSA100T 
        WHERE   COMP_CODE   = #{S_COMP_CODE}
        AND     MAIN_CODE   = 'A198'
        AND     SUB_CODE   IN ('1', '2', '3', '4')
) T
</select>			
<select id="s_afb600ukrServiceImpl_KOCIS.selectCheck4" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectCheck4 */
SELECT SUB_CODE
  FROM (
    SELECT  ROWNUM RN, SUB_CODE
    FROM    BSA100T 
    WHERE   COMP_CODE   = #{S_COMP_CODE}
    AND     MAIN_CODE   = 'A211'
    AND     SUB_CODE    = #{S_USER_ID}
) WHERE RN = 1
</select>			
<select id="s_afb600ukrServiceImpl_KOCIS.selectCheck5" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectCheck5 */
SELECT SUB_CODE
  FROM (
    SELECT  ROWNUM RN, SUB_CODE
    FROM    BSA100T 
    WHERE   COMP_CODE   = #{S_COMP_CODE}
    AND     MAIN_CODE   = 'A179'
    AND     SUB_CODE    = #{S_USER_ID}
) WHERE RN = 1
</select>			

<select id="s_afb600ukrServiceImpl_KOCIS.selectPosAmt" parameterType="Map" resultType="rMap">
/* s_afb600ukrServiceImpl_KOCIS.selectPosAmt */
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)
                  , @BUDG_YYYYMM        NVARCHAR(10)
                  , @DEPT_CODE          NVARCHAR(08)
                  , @DEPT_NAME          NVARCHAR(30)
                  , @BUDG_CODE          NVARCHAR(30)
                  , @BUDG_GUBUN         NVARCHAR(01)
                  , @BUDG_AMT           NUMERIC(30,6)

                  , @CONFIRM_YN         NVARCHAR(01)
                  , @USER_ID            NVARCHAR(20)
                  
                  , @LANG_TYPE       	NVARCHAR(2)  
                  , @ERROR_DESC         NVARCHAR(4000)

--  [ 변수 값 할당 ] --------------------------------------------------------------------------------------
    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFT_NO           = #{DRAFT_NO}

    SET @CONFIRM_YN         = #{HDD_CONFIRM_YN}
    SET @USER_ID            = #{S_USER_ID}
   
	SET @LANG_TYPE 			= #{S_LANG_CODE} 
    SET @ERROR_DESC         = N''


    IF ( @CONFIRM_YN = 'N' )
    BEGIN
--  [ 예산기안번호의 과목정보 참조하여 임시테이블에 저장 ] ------------------------------------------------
        SELECT A.COMP_CODE
             , A.DRAFT_NO
             , LEFT(A.DRAFT_DATE, 6) AS BUDG_YYYYMM
             , A.DEPT_CODE
             , C.TREE_NAME           AS DEPT_NAME
             , A.BUDG_GUBUN
             , B.BUDG_CODE
             , SUM(B.BUDG_AMT)       AS BUDG_AMT
        INTO   #AFB610Tmp
        FROM              AFB600T A 
               INNER JOIN AFB610T B  ON B.COMP_CODE = A.COMP_CODE
                                                 AND B.DRAFT_NO  = A.DRAFT_NO
               LEFT  JOIN BSA210T C  ON C.COMP_CODE = A.COMP_CODE
                                                 AND C.TREE_CODE = A.DEPT_CODE
        WHERE  A.COMP_CODE = @COMP_CODE
        AND    A.DRAFT_NO  = @DRAFT_NO
        GROUP BY A.COMP_CODE, A.DRAFT_NO, LEFT(A.DRAFT_DATE, 6), A.DEPT_CODE,C.TREE_NAME, A.BUDG_GUBUN,B.BUDG_CODE


--  [ 등록된 수정자 설정 ] --------------------------------------------------------------------------------------------
        DECLARE         @Amender            NVARCHAR(10)

        IF EXISTS ( SELECT  TOP 1 1
                    FROM    BSA100T M1 
                    WHERE   COMP_CODE   = @COMP_CODE
                    AND     MAIN_CODE   = N'A179'
                    AND     SUB_CODE    = @USER_ID )
            SET @Amender = 'Y'
        ELSE
            SET @Amender = 'N'

--  [ 예산기안(추산) 마감여부 체크 ] ------------------------------------------------
        DECLARE  @DraftCloseFg   NVARCHAR(01)
               , @CloseDate      NVARCHAR(04)

        SELECT @DraftCloseFg = B.DRAFT_CLOSE_FG
             , @CloseDate    = LEFT(A.DRAFT_DATE, 4)
        FROM              AFB600T A 
               INNER JOIN AFB010T B  ON B.COMP_CODE  = A.COMP_CODE
                                                 AND B.CLOSE_DATE = LEFT(A.DRAFT_DATE, 4)
        WHERE  A.COMP_CODE = @COMP_CODE
        AND    A.DRAFT_NO  = @DRAFT_NO

        SET  @DraftCloseFg = NVL(@DraftCloseFg, 'N')

        IF ( @@ROWCOUNT = 0 )
        BEGIN
            -- 기초등록-전표마감정보등록 메뉴에서 마감정보를 먼저 등록하십시오.
            SET @ERROR_DESC = '54331;'
            GOTO ERROR_HANDLER
        END

        IF ( @Amender = 'N' AND @DraftCloseFg = 'Y' )
        BEGIN
            --해당년도의 예산기안(추산)업무가 마감되었으므로 입력, 수정, 삭제가 불가합니다.
            SET @ERROR_DESC = '55530;' + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0273') + ': ' + CONVERT(NVARCHAR(10),CONVERT(DATETIME,@CloseDate),102)
            GOTO ERROR_HANDLER
        END

--  [ 예산사용가능금액 체크 ] -----------------------------------------------------------------------------
        DECLARE         @BalnAmtI           NUMERIC(30, 6)
                      , @BudgI              NUMERIC(30, 6)
                      , @ActI               NUMERIC(30, 6)

        DECLARE CUR_PROC_001 CURSOR FOR
        SELECT COMP_CODE
             , DRAFT_NO
             , BUDG_YYYYMM
             , DEPT_CODE
             , DEPT_NAME
             , BUDG_GUBUN
             , BUDG_CODE
             , BUDG_AMT
        FROM   #AFB610Tmp  

        OPEN CUR_PROC_001

        FETCH NEXT FROM CUR_PROC_001
        INTO @COMP_CODE, @DRAFT_NO, @BUDG_YYYYMM, @DEPT_CODE, @DEPT_NAME, @BUDG_GUBUN, @BUDG_CODE, @BUDG_AMT

        WHILE ( @@FETCH_STATUS = 0 )
        BEGIN
            EXEC uniLITE.SP_ACCNT_GetPossibleBudgAmt   @COMP_CODE, @BUDG_YYYYMM, @DEPT_CODE, @BUDG_CODE, @BUDG_GUBUN
                                                     , @BalnAmtI  OUTPUT
                                                     , @BudgI     OUTPUT
                                                     , @ActI      OUTPUT

            IF ( @@ROWCOUNT = 0 )
            BEGIN
                --잔여예산(또는 예산금액)이 존재하지 않습니다.
                SET @ERROR_DESC = '54334;' + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0012') + ': ' + @DEPT_CODE + ' ' + @DEPT_NAME + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0040') + ': 0' + CHAR(13)
                                   + uniLITE.fnGetTxtLant(@LANG_TYPE, 'A0041') + ': 0' + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0093') + ': ' + REPLACE(CONVERT(NVARCHAR(10), @BUDG_AMT), '.000000', '')
                GOTO ERROR_HANDLER
            END

            IF ( @BalnAmtI &lt; @BUDG_AMT )
            BEGIN
                --예산금액을 초과하였습니다.
                SET @ERROR_DESC = '54381;' + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0012') + ': ' + @DEPT_CODE + ' ' + @DEPT_NAME + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0040') + ': ' + REPLACE(CONVERT(NVARCHAR(10), @BudgI), '.000000', '') + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0041') + ': ' + REPLACE(CONVERT(NVARCHAR(10), @ActI), '.000000', '') + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0093') + ': ' + REPLACE(CONVERT(NVARCHAR(10), @BUDG_AMT), '.000000', '') + CHAR(13)
                                   + uniLITE.fnGetTxtLang(@LANG_TYPE, 'A0320') + ': ' + REPLACE(CONVERT(NVARCHAR(10), @BalnAmtI), '.000000', '')
                GOTO ERROR_HANDLER
            END

            FETCH NEXT FROM CUR_PROC_001
            INTO @COMP_CODE, @DRAFT_NO, @BUDG_YYYYMM, @DEPT_CODE, @DEPT_NAME, @BUDG_GUBUN, @BUDG_CODE, @BUDG_AMT
        END

        CLOSE      CUR_PROC_001
        DEALLOCATE CUR_PROC_001

        DROP TABLE #AFB610Tmp
    END

ERROR_HANDLER:
    SET NOCOUNT OFF
    SET ARITHABORT OFF

    IF CHARINDEX(';', @ERROR_DESC) &gt; 0
        SELECT @ERROR_DESC  AS ERROR_DESC
    ELSE
        SELECT TOP 1  '' ERROR_DESC
END
</select>

<select id="s_afb600ukrServiceImpl_KOCIS.fnCheckPassword" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr[fnAfb600Pro1] Query01
BEGIN
    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFTER            NVARCHAR(10)

    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFTER            = #{DRAFTER}

--  [ 지출관리 아이디와 1:1 매핑여부 설정 ] ---------------------------------------------------------------------------
    DECLARE         @isIdMapping        NVARCHAR(01)

    SELECT  TOP 1 @isIdMapping = REF_CODE1
    FROM    BSA100T 
    WHERE   COMP_CODE   = @COMP_CODE
    AND     MAIN_CODE   = 'A169'
    AND     SUB_CODE    = '10'

    SET @isIdMapping = NVL(@isIdMapping, 'N')

--  [ 주민번호 체크여부 설정 및 주민번호 리턴] ------------------------------------------------------------------------
    IF      ( @isIdMapping = 'Y' )
        BEGIN
            SELECT  'N' CHECK_PASSWORD, '' REPRE_NUM
        END
    ELSE IF ( @isIdMapping = 'N' )
        BEGIN
            SELECT  'Y' CHECK_PASSWORD, uniLITE.fnCipherDecrypt(REPRE_NUM,'') REPRE_NUM
            FROM    HUM100T 
            WHERE   COMP_CODE   = @COMP_CODE
            AND     PERSON_NUMB = @DRAFTER
        END
END
</select>

<select id="s_afb600ukrServiceImpl_KOCIS.selectPro1" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr[fnAfb600Pro1] Query03
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)
                  , @CONFIRM_YN         NVARCHAR(01)
                  , @USER_ID            NVARCHAR(10)

                  , @LANG_TYPE       	NVARCHAR(2)  
                  , @ERROR_DESC         NVARCHAR(4000)

--  [ 변수 값 할당 ] ------------------------------------------------------------------------------------------
    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFT_NO           = #{DRAFT_NO}
    SET @CONFIRM_YN         = #{HDD_CONFIRM_YN}
    SET @USER_ID            = #{S_USER_ID}

    SET @LANG_TYPE 			= #{S_LANG_CODE} 
    SET @ERROR_DESC         = N''

--  [ 그룹웨어 결재상신 연계여부 ] ------------------------------------------------------------------------------------------
    DECLARE         @LinkedGW           NVARCHAR(01)
                  , @ConfirmButton      NVARCHAR(01)

    SELECT @LinkedGW = REF_CODE1
    FROM   BSA100T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    MAIN_CODE    = N'A169'
    AND    SUB_CODE     = N'22'

    SET @LinkedGW = NVL(@LinkedGW, 'N')

--  [ 비연계확정 버튼 사용여부 ] ------------------------------------------------------------------------------------------
    SELECT @ConfirmButton = REF_CODE1
    FROM   BSA100T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    MAIN_CODE    = N'A169'
    AND    SUB_CODE     = N'23'

    SET @ConfirmButton = NVL(@ConfirmButton, 'N')

IF (@LinkedGW = 'N' OR @ConfirmButton = 'Y') -- 그룹웨어 연계사용하지 않거나 비연계확정 버튼을 사용하는 경우만 실행
BEGIN

--  [ 예산확정 처리를 위한 변수 값 설정 ] ---------------------------------------------------------------------
    DECLARE         @ConfirmYN          NVARCHAR(01)
                  , @Status             NVARCHAR(01)
                  , @Sign               NUMERIC(30, 6)

    IF ( @CONFIRM_YN = 'N' )
        BEGIN
            SET @SIGN       = 1
            SET @ConfirmYN  = 'Y'
            SET @Status     = '9'
        END
    ELSE
        BEGIN
            SET @SIGN       = -1
            SET @ConfirmYN  = 'N'
            SET @Status     = '0'
        END

--  [ 확정여부 확인 ] -----------------------------------------------------------------------------------------
    DECLARE         @ProcYN         NVARCHAR(01)

    SET @ProcYN = N''

    SELECT @ProcYN = CASE WHEN CONFIRM_YN = @ConfirmYN THEN 'N'
                          ELSE 'Y'
                     END
    FROM   AFB600T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    DRAFT_NO     = @DRAFT_NO

    IF ( @ProcYN = 'N' )
    BEGIN
        -- 이미 처리된 작업입니다. 재조회하여 예산기안의 예산확정여부를 확인하십시오.
        SET @ERROR_DESC = '56300;'
        GOTO ERROR_HANDLER
    END

--  [ 마감여부 확인 ] -----------------------------------------------------------------------------------------
    SET @ProcYN = N''

    SELECT @ProcYN = CASE WHEN MAX(NVL(CLOSE_YN, '')) = 'Y' THEN 'N'
                          ELSE 'Y'
                     END
    FROM   AFB610T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    DRAFT_NO     = @DRAFT_NO

    IF ( @ProcYN = 'N' )
    BEGIN
        -- 마감된 예산기안입니다. 마감된 예산기안의 확정 및 확정취소는 불가합니다.
        SET @ERROR_DESC = '56302;'
        GOTO ERROR_HANDLER
    END

--  [ 지출결의에서 참조되었는지 확인 ] ------------------------------------------------------------------------
    IF ( @ConfirmYN = 'N' )
    BEGIN
        SET @ProcYN = N''

        SELECT  TOP 1 @ProcYN = 'N'
        FROM              AFB710T A 
                LEFT JOIN T_GWIF  B  ON B.GWIF_KEY1 = A.COMP_CODE
                                                 AND B.GWIF_KEY2 = '80'
                                                 AND B.GWIF_KEY3 = A.PAY_DRAFT_NO
        WHERE   A.COMP_CODE   = @COMP_CODE
        AND     A.DRAFT_NO    = @DRAFT_NO
        AND     NVL(B.GW_STATUS, '') != '5'


        IF ( @ProcYN = 'N' )
        BEGIN
            -- 지출결의가 진행된 예산기안입니다. 이후 프로세스가 진행되었으므로 예산기안의 확정취소가 불가합니다..
            SET @ERROR_DESC = '56303;'
            GOTO ERROR_HANDLER
        END
    END

--  [ 테이블 업데이트 ] ---------------------------------------------------------------------------------------

DECLARE @T_AFB510T
    TABLE (
        ID_NO       INT    IDENTITY(1,1)  ,    
        COMP_CODE       NVARCHAR(100)       ,
        DRAFT_DATE      NVARCHAR(10)        ,
        DEPT_CODE       NVARCHAR(10)        ,
        BUDG_GUBUN      NVARCHAR(1)         ,
        BUDG_CODE       NVARCHAR(20)        ,
        BUDG_AMT        NUMERIC(18,0)
    )

    INSERT @T_AFB510T
    SELECT  S1.COMP_CODE, S1.DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
            , S2.BUDG_CODE
            , CASE WHEN NVL(S1.RETURN_CODE, '') = N'1' THEN SUM(S2.BUDG_AMT) * (-1)
                    ELSE SUM(S2.BUDG_AMT)
            END AS BUDG_AMT
    FROM                AFB600T   S1  
            INNER JOIN  AFB610T   S2   ON S2.COMP_CODE    = S1.COMP_CODE
                                    AND S2.DRAFT_NO     = S1.DRAFT_NO
    WHERE   S1.COMP_CODE    = @COMP_CODE
    AND     S1.DRAFT_NO     = @DRAFT_NO
    AND     S1.CONFIRM_YN   = @CONFIRM_YN
    AND     S2.CLOSE_YN     = 'N'
    GROUP BY    S1.COMP_CODE, S1.DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
                , S2.BUDG_CODE, S1.RETURN_CODE


    DECLARE @I   INT
    DECLARE @MAX_ID   INT
    SET @I = 1
    SET @I = 1
    SELECT @MAX_ID = MAX(ID_NO) FROM @T_AFB510T   

    DECLARE     
                @DRAFT_DATE NVARCHAR(10)
            ,   @DEPT_CODE  NVARCHAR(10)
            ,   @BUDG_GUBUN NVARCHAR(1)
            ,   @BUDG_CODE  NVARCHAR(20)
            ,   @BUDG_AMT   NUMERIC(18)
           
    WHILE @I &lt;= @MAX_ID                    
    BEGIN
        SELECT      @COMP_CODE = COMP_CODE
                ,   @DRAFT_DATE = DRAFT_DATE
                ,   @DEPT_CODE  = DEPT_CODE
                ,   @BUDG_GUBUN = BUDG_GUBUN
                ,   @BUDG_CODE  = BUDG_CODE
                ,   @BUDG_AMT   = BUDG_AMT
        FROM @T_AFB510T  WHERE ID_NO = @I   

        IF  (   SELECT  COUNT(*)
                FROM    AFB510T  
                WHERE   1=1
                AND     COMP_CODE = @COMP_CODE
                AND     DEPT_CODE = @DEPT_CODE
                AND     BUDG_CODE = @BUDG_CODE
                AND     BUDG_GUBUN = @BUDG_GUBUN ) != 12
        BEGIN
    
            INSERT  INTO AFB510T ( COMP_CODE,BUDG_YYYYMM,DEPT_CODE,BUDG_CODE,BUDG_GUBUN,BUDG_I,BUDG_CONF_I,BUDG_CONV_I,BUDG_ASGN_I,BUDG_SUPP_I
                                        ,BUDG_IWALL_I,EX_AMT_I,AC_AMT_I,CAL_DIVI,DRAFT_AMT,ORDER_AMT,REQ_AMT,INSERT_DB_USER,INSERT_DB_TIME,UPDATE_DB_USER
                                        ,UPDATE_DB_TIME,TEMPC_01,TEMPC_02,TEMPC_03,TEMPN_01,TEMPN_02,TEMPN_03)

            SELECT        A.COMP_CODE
                            , A.BUDG_YYYYMM
                            , A.DEPT_CODE
                            , A.BUDG_CODE
                            , A.BUDG_GUBUN
                            , 0 AS BUDG_I
                            , 0 AS BUDG_CONF_I
                            , 0 AS BUDG_CONV_I
                            , 0 AS BUDG_ASGN_I
                            , 0 AS BUDG_SUPP_I
                            , 0 AS BUDG_IWALL_I
                            , 0 AS EX_AMT_I
                            , 0 AS AC_AMT_I
                            , A.CAL_DIVI
                            , 0 AS DRAFT_AMT
                            , 0 AS ORDER_AMT
                            , 0 AS REQ_AMT
                            , @USER_ID AS INSERT_DB_USER
                            , GETDATE()
                            , @USER_ID AS UPDATE_DB_USER
                            , GETDATE()
                            , NULL
                            , NULL
                            , NULL
                            , 0
                            , 0
                            , 0
            FROM (
                SELECT COMP_CODE, BUDG_YYYYMM, BUDG_CODE, BUDG_GUBUN, @DEPT_CODE AS DEPT_CODE , CAL_DIVI
                FROM        AFB510T  
                WHERE 1=1
                AND     COMP_CODE = @COMP_CODE
                AND     BUDG_CODE = @BUDG_CODE
                AND     BUDG_GUBUN = @BUDG_GUBUN
                GROUP BY COMP_CODE,BUDG_YYYYMM, BUDG_CODE, BUDG_GUBUN, CAL_DIVI
            )   A LEFT JOIN AFB510T B     ON  A.COMP_CODE     = B.COMP_CODE
                                        AND A.BUDG_YYYYMM   = B.BUDG_YYYYMM
                                        AND A.BUDG_CODE     = B.BUDG_CODE
                                        AND A.DEPT_CODE     = B.DEPT_CODE

            WHERE   B.COMP_CODE IS NULL

        END      


        SET @I = @I + 1
    END    
    -- 1. 예산확정정보 ----------------------------------------------------------------------------------------
    UPDATE  B
    SET     B.DRAFT_AMT      = NVL(B.DRAFT_AMT, 0) + (A.BUDG_AMT * @Sign)
          , B.UPDATE_DB_USER = @USER_ID
          , B.UPDATE_DB_TIME = GETDATE()
    FROM                (
                        SELECT  S1.COMP_CODE, S1.DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
                              , S2.BUDG_CODE
                              , CASE WHEN NVL(S1.RETURN_CODE, '') = N'1' THEN SUM(S2.BUDG_AMT) * (-1)
                                     ELSE SUM(S2.BUDG_AMT)
                                END AS BUDG_AMT
                        FROM                AFB600T   S1  
                                INNER JOIN  AFB610T   S2   ON S2.COMP_CODE    = S1.COMP_CODE
                                                        AND S2.DRAFT_NO     = S1.DRAFT_NO
                        WHERE   S1.COMP_CODE    = @COMP_CODE
                        AND     S1.DRAFT_NO     = @DRAFT_NO
                        AND     S1.CONFIRM_YN   = @CONFIRM_YN
                        AND     S2.CLOSE_YN     = 'N'
                        GROUP BY    S1.COMP_CODE, S1.DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
                                  , S2.BUDG_CODE, S1.RETURN_CODE
                        )                     A
            INNER JOIN  AFB510T B  ON B.COMP_CODE   = A.COMP_CODE
                                               AND B.BUDG_YYYYMM = LEFT(A.DRAFT_DATE, 6)
                                               AND B.DEPT_CODE   = A.DEPT_CODE
                                               AND B.BUDG_GUBUN  = A.BUDG_GUBUN
                                               AND B.BUDG_CODE   = A.BUDG_CODE

    -- 2. 예산기안마스터 --------------------------------------------------------------------------------------
    UPDATE  AFB600T
    SET     CONFIRM_YN      = @ConfirmYN
          , AGREE_YN        = @ConfirmYN
          , UPDATE_DB_USER  = @USER_ID
          , UPDATE_DB_TIME  = GETDATE()
          , STATUS          = @Status
    WHERE   COMP_CODE   = @COMP_CODE
    AND     DRAFT_NO    = @DRAFT_NO
    AND     CONFIRM_YN  = @CONFIRM_YN
END

ERROR_HANDLER:
    SET NOCOUNT OFF
    SET ARITHABORT OFF

    IF CHARINDEX(';', @ERROR_DESC) &gt; 0
        SELECT @ERROR_DESC  AS ERROR_DESC
      		 , @ConfirmYN   AS CONFIRM_YN
    ELSE
        SELECT TOP 1 '' ERROR_DESC, @ConfirmYN CONFIRM_YN
END
</select>

<select id="s_afb600ukrServiceImpl_KOCIS.selectReCancel1" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr [fnAfb600ReCancel] Query02
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)
                  , @UPDATE_DB_USER     NVARCHAR(10)
                  , @GWIF_TYPE          NVARCHAR(01)

                  , @LANG_TYPE       	NVARCHAR(2)  
                  , @ERROR_DESC         NVARCHAR(4000)

--  [ 변수 값 할당 ] --------------------------------------------------------------------------------------------------
    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFT_NO           = #{DRAFT_NO}
    SET @UPDATE_DB_USER     = #{S_USER_ID}
    SET @GWIF_TYPE          = N'3'

    SET @LANG_TYPE 			= #{S_LANG_CODE} 
    SET @ERROR_DESC         = N''

--  [ 지출결의에서 참조되었는지 확인 ] ---------------------------------------------------------------------------------------
    DECLARE         @ProcYN         NVARCHAR(01)

    SET @ProcYN = N''

    SELECT  TOP 1 @ProcYN = 'N'
    FROM              AFB710T A 
            LEFT JOIN T_GWIF  B  ON B.GWIF_KEY1 = A.COMP_CODE
                                             AND B.GWIF_KEY2 = '80'
                                             AND B.GWIF_KEY3 = A.PAY_DRAFT_NO
    WHERE   A.COMP_CODE   = @COMP_CODE
    AND     A.DRAFT_NO    = @DRAFT_NO
    AND     NVL(B.GW_STATUS, '') != '5'


    IF ( @ProcYN = 'N' )
    BEGIN
        -- 지출결의가 진행된 예산기안입니다. 이후 프로세스가 진행되었으므로 예산기안의 확정취소가 불가합니다.
        SET @ERROR_DESC = '56303;'
        GOTO ERROR_HANDLER
    END

--  [ 기안마감되었는지 확인 ] ---------------------------------------------------------------------------------------
    DECLARE         @CloseYN         NVARCHAR(01)

    SET @CloseYN = N''

    SELECT  TOP 1 @CloseYN = A.CLOSE_YN
    FROM              AFB610T A 
            LEFT JOIN T_GWIF  B  ON B.GWIF_KEY1 = A.COMP_CODE
                                             AND B.GWIF_KEY2 = '3'
                                             AND B.GWIF_KEY3 = A.DRAFT_NO
    WHERE   A.COMP_CODE   = @COMP_CODE
    AND     A.DRAFT_NO    = @DRAFT_NO
    AND     NVL(B.GW_STATUS, '') != '5'

    IF ( @CloseYN = 'Y' )
    BEGIN
        -- 예산기안(추산)이 마감된 자료이므로 임의반려가 불가합니다. 기안마감을 먼저 취소하십시오.
        SET @ERROR_DESC = '55529;'
        GOTO ERROR_HANDLER
    END

ERROR_HANDLER:
    SET NOCOUNT OFF
    SET ARITHABORT OFF

    IF CHARINDEX(';', @ERROR_DESC) &gt; 0
        SELECT @ERROR_DESC  AS ERROR_DESC
    ELSE
        SELECT TOP 1  '' ERROR_DESC
END
</select>
<select id="s_afb600ukrServiceImpl_KOCIS.selectReCancel2" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr [fnAfb600ReCancel] Query02
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)
                  , @UPDATE_DB_USER     NVARCHAR(10)
                  , @GWIF_TYPE          NVARCHAR(01)

                  , @LANG_TYPE       	NVARCHAR(2)  
                  , @ERROR_DESC         NVARCHAR(4000)

--  [ 변수 값 할당 ] --------------------------------------------------------------------------------------------------
    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFT_NO           = #{DRAFT_NO}
    SET @UPDATE_DB_USER     = #{S_USER_ID}
    SET @GWIF_TYPE          = N'3'

    SET @LANG_TYPE 			= #{S_LANG_CODE} 
    SET @ERROR_DESC         = N''

--  [ 그룹웨어 연동여부 설정 ] ----------------------------------------------------------------------------------------
    DECLARE         @LinkedGW           NVARCHAR(01)

    SELECT TOP 1 @LinkedGW = M1.REF_CODE1
    FROM   BSA100T M1 
    WHERE  M1.COMP_CODE = @COMP_CODE
    AND    M1.MAIN_CODE = N'A169'
    AND    M1.SUB_CODE  = N'20'

    SET @LinkedGW = NVL(@LinkedGW, 'N')

--  [ 등록된 수정자일 경우/그룹웨어 연동인 경우, 임의반려 실행 ] -----------------------------------------------------------------------------
    IF EXISTS ( SELECT  TOP 1 1
                    FROM    BSA100T M1 
                    WHERE   COMP_CODE   = @COMP_CODE
                    AND     MAIN_CODE   = N'A179'
                    AND     SUB_CODE    = @UPDATE_DB_USER ) AND (@LinkedGW = 'Y')
    BEGIN

    --  [ 확정취소 SP 실행 ] ----------------------------------------------------------------------------------------------
        DECLARE   @GWIF_ID     NVARCHAR(50)
        
        SELECT  @GWIF_ID    = B.GWIF_ID
        FROM                AFB600T   A  
                LEFT  JOIN  BSA100T   M1  ON M1.COMP_CODE     = A.COMP_CODE
                                                      AND M1.MAIN_CODE     = N'S091'
                                                      AND M1.SUB_CODE      = A.COMP_CODE
                LEFT  JOIN  T_GWIF    B   ON B.GWIF_ID        = M1.REF_CODE1 + @GWIF_TYPE + A.DRAFT_NO
        WHERE   A.COMP_CODE     = @COMP_CODE
        AND     A.DRAFT_NO      = @DRAFT_NO
        AND    (B.GW_STATUS     = '1'
         OR     B.GW_STATUS     = '9')

        EXEC USP_ACCNT_DraftStop   @GWIF_ID, 'HANDY',@LANG_TYPE, @ERROR_DESC OUTPUT

    --  [ 그룹웨어 연계테이블에 반려status UPDATE(결재중(회수/삭제등)과 완결인 건만 처리함] ---------------------------------
        UPDATE  B
        SET     B.GW_STATUS = '5'
        FROM                AFB600T   A  
                LEFT  JOIN  BSA100T   M1  ON M1.COMP_CODE  = A.COMP_CODE
                                                      AND M1.MAIN_CODE  = N'S091'
                                                      AND M1.SUB_CODE   = A.COMP_CODE
                INNER JOIN  T_GWIF    B   ON B.GWIF_ID     = M1.REF_CODE1 + @GWIF_TYPE + A.DRAFT_NO
        WHERE   A.COMP_CODE     = @COMP_CODE
        AND     A.DRAFT_NO      = @DRAFT_NO
        AND    (B.GW_STATUS     = '1'
         OR     B.GW_STATUS     = '9')

    --  [ 결과 리턴 ] -----------------------------------------------------------------------------------------------------
        IF ( @ERROR_DESC != '' )
            BEGIN
                SELECT   @ERROR_DESC    AS ERROR_DESC
            END
        ELSE
            BEGIN
                SELECT   '' ERROR_DESC
                      , NVL(B.GW_STATUS, '0') AS STATUS
                FROM                AFB600T   A  
                        LEFT  JOIN  BSA100T   M1  ON M1.COMP_CODE  = A.COMP_CODE
                                                              AND M1.MAIN_CODE  = N'S091'
                                                              AND M1.SUB_CODE   = A.COMP_CODE
                        LEFT  JOIN  T_GWIF    B   ON B.GWIF_ID     = M1.REF_CODE1 + @GWIF_TYPE + A.DRAFT_NO
                WHERE   A.COMP_CODE     = @COMP_CODE
                AND     A.DRAFT_NO      = @DRAFT_NO
            END
    END

    SET NOCOUNT OFF
    SET ARITHABORT OFF
END
</select>

<select id="s_afb600ukrServiceImpl_KOCIS.selectPro2" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr[fnAfb600Pro2] Query02
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)
                  , @CLOSE_YN           NVARCHAR(01)
                  , @USER_ID            NVARCHAR(10)

                  , @LANG_TYPE       	NVARCHAR(2)  
                  , @ERROR_DESC         NVARCHAR(4000)

--  [ 변수 값 할당 ] ------------------------------------------------------------------------------------------
    SET @COMP_CODE          = #{S_COMP_CODE}
    SET @DRAFT_NO           = #{DRAFT_NO}
    SET @CLOSE_YN           = #{HDD_CLOSE_YN}
    SET @USER_ID            = #{S_USER_ID}

    SET @LANG_TYPE 			= #{S_LANG_CODE} 
    SET @ERROR_DESC         = N''

--  [ 기안마감 처리를 위한 변수 값 설정 ] ---------------------------------------------------------------------
    DECLARE         @CloseYN            NVARCHAR(01)

    IF ( @CLOSE_YN = 'N' )
        SET @CloseYN    = 'Y'

--  [ 마감여부 확인 ] -----------------------------------------------------------------------------------------
    DECLARE         @ProcYN         NVARCHAR(01)

    SELECT @ProcYN = CASE WHEN CLOSE_YN = @CloseYN THEN 'N'
                          ELSE 'Y'
                     END
    FROM   AFB610T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    DRAFT_NO     = @DRAFT_NO

    IF ( @ProcYN = 'N' )
    BEGIN
        -- 이미 처리된 작업입니다. 재조회하여 예산기안의 기안마감여부를 확인하십시오.
        SET @ERROR_DESC = '56301;'
        GOTO ERROR_HANDLER
    END

--  [ 확정여부 확인 ] -----------------------------------------------------------------------------------------
    DECLARE         @ConfirmYN         NVARCHAR(01)

    SELECT @ConfirmYN = CONFIRM_YN
    FROM   AFB600T 
    WHERE  COMP_CODE    = @COMP_CODE
    AND    DRAFT_NO     = @DRAFT_NO

    SET    @ConfirmYN = NVL(@ConfirmYN, 'N')

    IF ( @ConfirmYN = 'N' )
    BEGIN
        -- 확정 또는 결재상신하기 전에는 마감 작업을 할 수 없습니다.
        SET @ERROR_DESC = '55522;'
        GOTO ERROR_HANDLER
    END

IF (@ConfirmYN = 'Y') -- 확정여부가 'Y'인 경우만 기안마감 업데이트 처리
BEGIN
--  [ 테이블 업데이트 ] ---------------------------------------------------------------------------------------

    -- 1. 예산확정정보 ----------------------------------------------------------------------------------------
    UPDATE  B
    SET     B.DRAFT_AMT      = NVL(B.DRAFT_AMT, 0) + (A.DRAFT_REMIND_AMT * (-1))
          , B.UPDATE_DB_USER = @USER_ID
          , B.UPDATE_DB_TIME = GETDATE()
    FROM                (
                        SELECT  S1.COMP_CODE, NVL(CONVERT(NVARCHAR(08), GETDATE(), 112), S1.DRAFT_DATE) AS DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
                              , S2.BUDG_CODE
                              , CASE WHEN NVL(S1.RETURN_CODE, '') = N'1' THEN SUM(S2.DRAFT_REMIND_AMT) * (-1)
                                     ELSE SUM(S2.DRAFT_REMIND_AMT)
                                END AS DRAFT_REMIND_AMT
                        FROM                AFB600T   S1  
                                INNER JOIN  AFB610T   S2   ON S2.COMP_CODE    = S1.COMP_CODE
                                                        AND S2.DRAFT_NO     = S1.DRAFT_NO
                        WHERE   S1.COMP_CODE    = @COMP_CODE
                        AND     S1.DRAFT_NO     = @DRAFT_NO
                        AND     S1.CONFIRM_YN   = N'Y'
                        AND     S2.CLOSE_YN     = @CLOSE_YN
                        GROUP BY    S1.COMP_CODE, S1.DRAFT_DATE, S1.DEPT_CODE, S1.BUDG_GUBUN
                                  , S2.BUDG_CODE, S1.RETURN_CODE
                        )                     A
            INNER JOIN  AFB510T B  ON B.COMP_CODE   = A.COMP_CODE
                                               AND B.BUDG_YYYYMM = LEFT(A.DRAFT_DATE, 6)
                                               AND B.DEPT_CODE   = A.DEPT_CODE
                                               AND B.BUDG_GUBUN  = A.BUDG_GUBUN
                                               AND B.BUDG_CODE   = A.BUDG_CODE

    -- 2. 예산기안디테일 --------------------------------------------------------------------------------------
    UPDATE  AFB610T
    SET     DRAFT_REMIND_AMT    = 0
          , CLOSE_YN            = @CloseYN
          , CLOSE_DATE          = CONVERT(NVARCHAR(08), GETDATE(), 112)
          , UPDATE_DB_USER      = @USER_ID
          , UPDATE_DB_TIME      = GETDATE()
    WHERE   COMP_CODE   = @COMP_CODE
    AND     DRAFT_NO    = @DRAFT_NO
    AND     CLOSE_YN    = @CLOSE_YN
END

ERROR_HANDLER:
    SET NOCOUNT OFF
    SET ARITHABORT OFF

    IF CHARINDEX(';', @ERROR_DESC) &gt; 0
       SELECT @ERROR_DESC  AS ERROR_DESC
      		, @CloseYN     AS CLOSE_YN
    ELSE
        SELECT TOP 1  '' ERROR_DESC, @CloseYN CLOSE_YN
END
	
</select>
<select id="s_afb600ukrServiceImpl_KOCIS.selectMaster" parameterType="Map" resultType="rMap">
--afb600ukr.Cafb600ukr[fnAfb600Qstd] QUERY02
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)

--  [ 변수 값 할당 ] --------------------------------------------------------------------------------------------------
    SET @COMP_CODE      = #{S_COMP_CODE}
    SET @DRAFT_NO       = #{DRAFT_NO}

--  [ 날짜 포맷 유형 설정 ] -------------------------------------------------------------------------------------------
    DECLARE         @DateFormat         NVARCHAR(10)

    SELECT TOP 1 @DateFormat = M1.CODE_NAME
    FROM   BSA100T M1 
    WHERE  M1.COMP_CODE = @COMP_CODE
    AND    M1.MAIN_CODE = N'B044'
    AND    M1.REF_CODE1 = N'Y'

    SET @DateFormat = NVL(@DateFormat, 'YYYY/MM/DD')

--  [ 데이터 조회 ] ---------------------------------------------------------------------------------------------------
    SELECT  A.COMP_CODE
          , A.DRAFT_NO
          , REPLACE(
            REPLACE(
            REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DRAFT_DATE, 1, 4))
                               , 'MM'  , SUBSTRING(A.DRAFT_DATE, 5, 2))
                               , 'DD'  , SUBSTRING(A.DRAFT_DATE, 7, 2))     AS DRAFT_DATE
          , A.DRAFTER
          , D1.NAME                                                         AS DRAFTER_NM
          , A.PAY_USER
          , D2.NAME                                                         AS PAY_USER_NM
          , A.DEPT_CODE
          , D3.TREE_NAME                                                    AS DEPT_NAME
          , A.DIV_CODE
          , A.BUDG_GUBUN
          , A.TITLE
          , A.CONFIRM_YN
          , NVL(A.ACCNT_GUBUN,'') AS ACCNT_GUBUN 
          , B.CLOSE_YN
          , A.INSERT_DB_USER
          , CASE WHEN A.STATUS != '0' THEN A.STATUS
                 ELSE NVL(C.GW_STATUS, A.STATUS)
            END                                                             AS STATUS
          , CASE WHEN (A.STATUS != '0' OR NVL(C.GW_STATUS, '') = '0') THEN ''
                 ELSE NVL(C.GW_STATUS, '')
            END                                                             AS GW_STATUS
            
          , A.NEXT_MONTH          
          , A.AC_GUBUN           
          , A.AC_TYPE              
          , A.CLOSE_YN
    FROM                AFB600T   A  
            INNER JOIN  (
                        SELECT  COMP_CODE, DRAFT_NO, MIN(NVL(CLOSE_YN, '')) CLOSE_YN
                        FROM    AFB610T 
                        WHERE   COMP_CODE   = @COMP_CODE
                        AND     DRAFT_NO    = @DRAFT_NO
                        GROUP BY COMP_CODE, DRAFT_NO
                        )         B                ON B.COMP_CODE       = A.COMP_CODE
                                                  AND B.DRAFT_NO        = A.DRAFT_NO
            LEFT  JOIN  T_GWIF    C   ON C.GWIF_KEY1       = A.COMP_CODE
                                                  AND C.GWIF_KEY2       = N'3'
                                                  AND C.GWIF_KEY3       = A.DRAFT_NO
            LEFT  JOIN  HUM100T   D1  ON D1.COMP_CODE      = A.COMP_CODE
                                                  AND D1.PERSON_NUMB    = A.DRAFTER
            LEFT  JOIN  HUM100T   D2  ON D2.COMP_CODE      = A.COMP_CODE
                                                  AND D2.PERSON_NUMB    = A.PAY_USER
            LEFT  JOIN  BSA210T   D3  ON D3.COMP_CODE      = A.COMP_CODE
                                                  AND D3.TREE_CODE      = A.DEPT_CODE
    WHERE   A.COMP_CODE     = @COMP_CODE
    AND     A.DRAFT_NO      = @DRAFT_NO

    SET NOCOUNT OFF
    SET ARITHABORT OFF
END
</select>
<select id="s_afb600ukrServiceImpl_KOCIS.selectDetail" parameterType="Map" resultType="rMap">
	--afb600ukr.Cafb600ukr[fnAfb600Qstd] QUERY03
BEGIN
    SET NOCOUNT ON
    SET ARITHABORT ON

    DECLARE         @COMP_CODE          NVARCHAR(08)
                  , @DRAFT_NO           NVARCHAR(20)

--  [ 변수 값 할당 ] --------------------------------------------------------------------------------------------------
    SET @COMP_CODE      = #{S_COMP_CODE}
    SET @DRAFT_NO       = #{DRAFT_NO}

--  [ 데이터 조회 ] ---------------------------------------------------------------------------------------------------
    SELECT  
            B.COMP_CODE
          , B.DRAFT_NO
          , B.DRAFT_SEQ
          , B.BUDG_CODE
          , D.BUDG_NAME  
          
          , B.PJT_CODE
          , D1.PJT_NAME
          , B.BUDG_GUBUN
          , uniLITE.fnPossibleBudgAmt(A.COMP_CODE, A.DRAFT_DATE, A.DEPT_CODE, B.BUDG_CODE, B.BUDG_GUBUN)    AS BUDG_POSS_AMT
          , B.BUDG_AMT
          , B.REMARK
          , B.EXPEN_REQ_AMT
          , B.PAY_DRAFT_AMT
          , B.DRAFT_REMIND_AMT
          , B.CLOSE_YN
          , B.INSERT_DB_USER
          , B.INSERT_DB_TIME
          , B.UPDATE_DB_USER
          , B.UPDATE_DB_TIME
          
          , B.CURR_RATE
          , B.CURR_UNIT
          , B.WON_AMT
    FROM                AFB600T   A  
            INNER JOIN  AFB610T   B  ON B.COMP_CODE   = A.COMP_CODE
                                    AND B.DRAFT_NO    = A.DRAFT_NO
             
              LEFT JOIN AFB400T   D  ON D.COMP_CODE = A.COMP_CODE 
                                    AND D.AC_YYYY   = SUBSTRING(A.DRAFT_DATE,1,4)
                                    AND D.BUDG_CODE = B.BUDG_CODE
                                                  

            LEFT  JOIN  BCM600T   D1  ON D1.COMP_CODE  = B.COMP_CODE
                                                  AND D1.PJT_CODE   = B.PJT_CODE
    WHERE   A.COMP_CODE     = @COMP_CODE
    AND     A.DRAFT_NO      = @DRAFT_NO
    ORDER BY B.DRAFT_SEQ

    SET NOCOUNT OFF
    SET ARITHABORT OFF
END
</select>

<insert id="s_afb600ukrServiceImpl_KOCIS.insertLogMaster" parameterType="Map">    	
 	INSERT INTO L_AFB600T
           (KEY_VALUE           ,OPR_FLAG
           ,COMP_CODE           ,DRAFT_NO           ,DRAFT_DATE           ,DRAFTER           ,PAY_USER
           ,DEPT_CODE           ,DIV_CODE           ,BUDG_GUBUN           ,TITLE             ,CONFIRM_YN
           ,STATUS              ,ACCNT_GUBUN        ,RETURN_CODE          ,INSERT_DB_USER
           ,INSERT_DB_TIME      ,UPDATE_DB_USER     ,UPDATE_DB_TIME       ,TEMPC_01          ,TEMPC_02
           ,TEMPC_03            ,TEMPN_01           ,TEMPN_02             ,TEMPN_03
           ,PASSWORD
           
           ,NEXT_MONTH          ,AC_GUBUN           ,AC_TYPE              ,CLOSE_YN
           )
     VALUES
           ( #{KEY_VALUE}         ,#{OPR_FLAG}                                                                    
			,#{COMP_CODE}         ,#{DRAFT_NO}           ,#{DRAFT_DATE}           ,#{DRAFTER}           ,#{DRAFTER}      
			,#{DEPT_CODE}         ,#{DEPT_CODE}           ,#{BUDG_GUBUN}           ,#{TITLE}             ,#{HDD_CONFIRM_YN}     
			,#{STATUS}            ,'X'        ,#{RETURN_CODE}       	  ,#{S_USER_ID} 
			,GETDATE()    		  ,#{S_USER_ID}          ,GETDATE()               ,NULL                 ,NULL       
			,NULL          		  ,NULL           		 ,NULL             		  ,NULL
			,uniLITE.fnCipherEncrypt(#{PASSWORD}, '')
			
			,#{NEXT_MONTH}          ,#{AC_GUBUN}           ,#{AC_TYPE}              ,#{CLOSE_YN}
			)                         
</insert>	  	

<insert id="s_afb600ukrServiceImpl_KOCIS.insertLogDetail" parameterType="Map">    	
 	INSERT INTO L_AFB610T
           (KEY_VALUE           ,OPR_FLAG
           ,COMP_CODE           ,DRAFT_NO           ,DRAFT_SEQ           ,BUDG_CODE           ,PJT_CODE
           ,BUDG_GUBUN          ,BUDG_AMT           ,EXPEN_REQ_AMT       ,PAY_DRAFT_AMT       ,DRAFT_REMIND_AMT
           ,CLOSE_YN            ,CLOSE_DATE         ,REMARK              ,INSERT_DB_USER      ,INSERT_DB_TIME
           ,UPDATE_DB_USER      ,UPDATE_DB_TIME     ,TEMPC_01            ,TEMPC_02            ,TEMPC_03
           ,TEMPN_01            ,TEMPN_02           ,TEMPN_03
           
           ,CURR_RATE           ,CURR_UNIT          ,WON_AMT
           )
     VALUES
           ( #{KEY_VALUE}           ,#{OPR_FLAG}                                                                      
			,#{COMP_CODE}           ,#{DRAFT_NO}           ,#{DRAFT_SEQ}           ,#{BUDG_CODE}           ,#{PJT_CODE}        
			,#{BUDG_GUBUN}          ,#{BUDG_AMT}           ,0       ,0       ,#{DRAFT_REMIND_AMT}
			,#{CLOSE_YN}            ,#{CLOSE_DATE}         ,#{REMARK}              ,#{S_USER_ID}           ,GETDATE() 
			,#{S_USER_ID}      		,GETDATE()      	   ,NULL 				   ,NULL 			       ,NULL        
			,NULL             		,NULL            	   ,NULL 
			
			,#{CURR_RATE}           ,#{CURR_UNIT}          ,#{WON_AMT}
			)                                                 
</insert>
	  	

	  	
<update id="spUspAccntAfb600ukr" parameterType="Map" statementType="CALLABLE">
	{call USP_ACCNT_AFB600UKR_KOCIS (
		#{KeyValue, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{LangCode, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{UserId, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{DraftNo, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String},
		#{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
	)}
</update>	

<update id="spUspAccntAfb600ukrDelA" parameterType="Map" statementType="CALLABLE">
	{call USP_ACCNT_AFB600UKR_DelA_KOCIS (
		#{S_COMP_CODE, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{DRAFT_NO, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{S_LANG_CODE, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{S_USER_ID, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{DRAFTER, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{PASSWORD, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
	)}
</update>	

<select id="s_afb600ukrServiceImpl_KOCIS.getUseColList" parameterType="Map" resultType="rMap">
	/*UBsaExKrv.CBsaExSKr[fnSheetHiddenYn] Query01*/
BEGIN
    DECLARE @COMP_CODE     NVARCHAR(20)
          , @PGM_ID        NVARCHAR(40)
          , @SHEET_ID      NVARCHAR(40)

    SET @COMP_CODE = #{S_COMP_CODE}
    SET @PGM_ID    = N'afb600ukr_01'
    SET @SHEET_ID  = N'grdSheet1'

    SELECT REF_CODE3
         , CASE WHEN NVL(REF_CODE4, 'Y') = 'N' THEN 'False'
                                                  ELSE 'True'
           END                                                 AS REF_CODE4
      FROM BSA100T WITH(NOLOCK)
     WHERE COMP_CODE = @COMP_CODE
       AND MAIN_CODE = 'B114'
       AND REF_CODE1 = @PGM_ID
       AND REF_CODE2 = @SHEET_ID
     ORDER BY REF_CODE2

END		
</select>
<select id="s_afb600ukrServiceImpl_KOCIS.sAutoNoYN_sGapBase" parameterType="Map" resultType="rMap">
	/*afb600ukr.Cafb600UKR[fnafb600q] Query02*/
	DECLARE @COMP_CODE  NVARCHAR(08)
	      , @MAIN_CODE  NVARCHAR(10)
	      , @REF_CODE1  NVARCHAR(01)
	      , @SUB_CODE   NVARCHAR(01)
	
	SET     @COMP_CODE  = #{S_COMP_CODE}
	SET     @MAIN_CODE  = N'A151'
	
	/* 자동채번유무*/
	SELECT  TOP 1
	        @REF_CODE1  = NVL(REF_CODE1, 'N')
	FROM    BSA100T 
	WHERE   COMP_CODE   = @COMP_CODE
	AND     MAIN_CODE   = @MAIN_CODE
	AND     NVL(REF_CODE1, 'N') = 'Y'
	
	SET     @REF_CODE1   = NVL(@REF_CODE1, 'N')
	
	/* 회계기준사용(1:K-GAAP, 2:K-IFRS)*/
	SELECT  TOP 1
	        @SUB_CODE   = NVL(SUB_CODE, '1')
	FROM    BSA100T 
	WHERE   COMP_CODE   = @COMP_CODE
	AND     MAIN_CODE   = @MAIN_CODE
	AND     NVL(REF_CODE2, '') = 'Y'
	
	SET     @SUB_CODE   = NVL(@SUB_CODE, '1')
	
	SELECT  @REF_CODE1  AS REF_CODE1
	     ,  @SUB_CODE   AS SUB_CODE
</select>
</mapper>