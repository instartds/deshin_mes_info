<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="agc340ukrServiceImpl">
	
	<select id="agc340ukrServiceImpl.fnDispYN" parameterType="Map" resultType="rMap">
		SELECT DIS_DIVI FROM ABA120T   WITH (NOLOCK) WHERE COMP_CODE = #{S_COMP_CODE} AND  DIVI = '20' AND ACCNT_CD = #{sAccntCD}
	</select>

	
	<select id="agc340ukrServiceImpl.produceBudget" parameterType="Map" resultType="rMap">
		
			--agc340ukr.Cagc340UKR[fnagc340QStd] Query03
		    SELECT A.ACCNT
		         , CONVERT(BIT, 0)             AS CHK
		         , MAX(C.ACCNT_NAME)           AS ACCNT_NAME
		         , SUM(CASE C.JAN_DIVI
		                    WHEN '1' THEN ISNULL(B.DR_AMT_I,0.0) - ISNULL(B.CR_AMT_I,0.0)
		                    WHEN '2' THEN ISNULL(B.CR_AMT_I,0.0) - ISNULL(B.DR_AMT_I,0.0)
		                END)                   AS OCCU_AMT_I
		         , CONVERT(NUMERIC(30, 6), 0)  AS RPLC_AMT_I
		         , MAX(A1.ACCNT_CD)            AS ACCNT_CD
		      FROM            ${sSrcTbl}  B WITH (NOLOCK)
		           INNER JOIN ABA120TV AS A WITH (NOLOCK) ON A.COMP_CODE = B.COMP_CODE
		                                                 AND A.ACCNT     = B.ACCNT
		                                                 AND A.GUBUN     = #{GUBUN}
		                                                 AND A.DIVI      = '31'
		                                                 AND A.ACCNT_CD IN ('1050', '2000','3000')     -- 1050은 외주비
		           INNER JOIN ABA130T  AS A1 WITH (NOLOCK) ON A1.COMP_CODE = A.COMP_CODE
		                                                  AND A1.GUBUN     = A.GUBUN
		                                                  AND A1.DIVI      = A.DIVI
		                                                  AND A1.ACCNT     = A.ACCNT
		           INNER JOIN ABA400T  AS C WITH (NOLOCK) ON C.COMP_CODE = B.COMP_CODE
		                                                 AND C.ACCNT     = B.ACCNT
		     WHERE B.COMP_CODE 	  = #{S_COMP_CODE}
		       AND B.AC_DATE  &gt;= #{sFrDate}
		       AND B.AC_DATE  &lt;= #{sToDate}
		       AND B.INPUT_PATH != '52'
		    
		     <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
		       AND  B.DIV_CODE IN
					<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
						#{item}
					</foreach>									
			   </if>
		    
		    <if test="sSrcTbl == &quot;AGB200T&quot;">
		            AND   ((B.BOOK_CODE1 = 'E1' AND B.BOOK_DATA1 = #{AC_PROJECT_CODE})
		             OR    (B.BOOK_CODE2 = 'E1' AND B.BOOK_DATA2 = #{AC_PROJECT_CODE}))
		    </if>
		    
		      GROUP   BY A.ACCNT_CD, A.ACCNT
		      HAVING  SUM(CASE C.JAN_DIVI
		                       WHEN '1' THEN ISNULL(B.DR_AMT_I,0.0) - ISNULL(B.CR_AMT_I,0.0)
		                       WHEN '2' THEN ISNULL(B.CR_AMT_I,0.0) - ISNULL(B.DR_AMT_I,0.0)
		                   END) != 0
		      ORDER   BY A.ACCNT_CD, A.ACCNT
	</select>
	
	
	
	<select id="agc340ukrServiceImpl.produceBudgetSearch" parameterType="Map" resultType="rMap">
		--agc340ukr.Cagc340UKR[fnagc340Q340] Query04
	    SELECT A.ACCNT
	         , CONVERT(BIT, 1)            AS CHK
	         , C.ACCNT_NAME
	         , CONVERT(NUMERIC(30, 6), 0) AS OCCU_AMT_I
	         , B.COST_AMT                 AS RPLC_AMT_I
	         , A1.ACCNT_CD
	      FROM            AGC341T  AS B  WITH (NOLOCK)
	           INNER JOIN ABA120TV AS A  WITH (NOLOCK) ON A.COMP_CODE  = B.COMP_CODE
	                                                  AND A.ACCNT      = B.ACCNT
	                                                  AND A.GUBUN      = #{GUBUN}
	                                                  AND A.DIVI       = '31'
	                                                  AND (A.ACCNT_CD  = '2000'
	                                                   OR  A.ACCNT_CD  = '3000'
	                                                   OR  A.ACCNT_CD  = '1050')
	           INNER JOIN ABA130T  AS A1 WITH (NOLOCK) ON A1.COMP_CODE = A.COMP_CODE
	                                                  AND A1.GUBUN     = A.GUBUN
	                                                  AND A1.DIVI      = A.DIVI
	                                                  AND A1.ACCNT     = A.ACCNT
	           INNER JOIN ABA400T  AS C  WITH (NOLOCK) ON C.COMP_CODE  = A.COMP_CODE
	                                                  AND C.ACCNT      = A.ACCNT
	     WHERE B.COMP_CODE  = #{S_COMP_CODE}
	       AND B.AC_YYYYMM  = #{ST_DATE}
	       AND B.FR_AC_DATE = #{FR_DATE}
	       AND B.TO_AC_DATE = #{TO_DATE}
	       AND B.DIV_CODE   = #{ACCNT_DIV_CODE}
	       AND B.PJT_CODE   = #{AC_PROJECT_CODE}
	     ORDER BY A.SEQ, A.ACCNT_CD, A.ACCNT
		
	</select>
	
	<select id="agc340ukrServiceImpl.costInformation" parameterType="Map" resultType="rMap">
		
	--agc340ukr.Cagc340UKR[fnagc340Q340] Query05
    SELECT DISTINCT
           ISNULL(A.COST_PRPD,0.0)                          AS COST_PRPD
         , ISNULL(A.COST_PD,0.0)                            AS COST_PD
         , unilite.fnGetUserDate(A.COMP_CODE, A.EX_DATE)    AS EX_DATE
         , CASE A.EX_NUM
                WHEN 0 THEN NULL
                ELSE        A.EX_NUM
            END                                             AS EX_NUM
         , ISNULL(B.AP_STS,'')                              AS AP_STS
      FROM           AGC340T AS A WITH (NOLOCK)
           LEFT JOIN AGJ110T AS B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                               AND B.EX_DATE   = A.EX_DATE
                                               AND B.EX_NUM    = A.EX_NUM
                                               AND (B.MOD_DIVI = ''
                                                OR  B.MOD_DIVI IS NULL)
     WHERE A.COMP_CODE  = #{S_COMP_CODE}
       AND AC_YYYYMM  = #{ST_DATE}
       AND FR_AC_DATE = #{FR_DATE}
       AND TO_AC_DATE = #{TO_DATE}
       AND A.DIV_CODE   = #{DIV_CODE}
       AND PJT_CODE   = #{AC_PROJECT_CODE}
	</select>
	
	<select id="agc340ukrServiceImpl.selectRef1" parameterType="Map" resultType="rMap">
		--agc340ukr.Cagc340UKR[fnagc340QPop] Query12
	    DECLARE @COMP_CODE  NVARCHAR(8)
	          , @AC_YYYYMM  NVARCHAR(6)
	          , @FR_AC_DATE NVARCHAR(6)
	          , @TO_AC_DATE NVARCHAR(6)
	          , @DIV_CODE   NVARCHAR(255)
	          , @PJT_CODE   NVARCHAR(20)
	    
		    SET @COMP_CODE  = #{S_COMP_CODE}
		    SET @AC_YYYYMM  = #{ST_AC_DATE}
		    SET @FR_AC_DATE = #{FR_AC_DATE}
		    SET @TO_AC_DATE = #{TO_AC_DATE}
		    SET @DIV_CODE   = #{DIV_CODE}
		    SET @PJT_CODE   = #{AC_PROJECT_CODE}
		    
		    SELECT unilite.fnGetUserDate(A.COMP_CODE, A.AC_YYYYMM)          AS AC_YYYYMM
		         , unilite.fnGetUserDate(A.COMP_CODE, A.FR_AC_DATE)         AS FR_AC_DATE
		         , unilite.fnGetUserDate(A.COMP_CODE, A.TO_AC_DATE)         AS TO_AC_DATE
		         , A.DIV_CODE
		         , A.PJT_CODE
		         , unilite.fnGetUserDate(A.COMP_CODE, A.EX_DATE)            AS EX_DATE
		         , CASE MAX(A.EX_NUM)
		                WHEN 0 THEN NULL
		                ELSE        MAX(A.EX_NUM)
		            END                                                     AS EX_NUM
		         , MAX(B.DIV_CODE)                                          AS EX_DIV_CODE
		         , MAX(ISNULL(M1.CODE_NAME, ''))                            AS INPUT_USER_ID
		         , unilite.fnGetUserDate(A.COMP_CODE, B.INPUT_DATE)         AS INPUT_DATE
		         , MAX(B.AP_STS)                                            AS AP_STS
		      FROM            AGC340T AS A  WITH (NOLOCK)
		           LEFT  JOIN AGJ110T AS B  WITH (NOLOCK) ON B.COMP_CODE  = A.COMP_CODE
		                                                 AND B.EX_DATE    = A.EX_DATE
		                                                 AND B.EX_NUM     = A.EX_NUM
		                                                 AND (B.MOD_DIVI IS NULL OR B.MOD_DIVI = '')
		           LEFT  JOIN BSA100T AS M1 WITH (NOLOCK) ON M1.COMP_CODE = B.COMP_CODE
		                                                 AND M1.MAIN_CODE = N'A009'
		                                                 AND M1.REF_CODE1 = B.INPUT_USER_ID
		     WHERE A.COMP_CODE = @COMP_CODE
		       AND A.AC_YYYYMM = @AC_YYYYMM
		    
		    <if test="DATE_OPT == &quot;FR_DATE&quot;"> 
	           AND  A.FR_AC_DATE &gt;= @FR_AC_DATE
	           AND  A.FR_AC_DATE &lt;= @TO_AC_DATE
		    </if>
		    <if test="DATE_OPT != &quot;FR_DATE&quot;">  
		           AND  A.TO_AC_DATE &gt;= @FR_AC_DATE
		           AND  A.TO_AC_DATE &lt;= @TO_AC_DATE
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">	
		           AND  A.DIV_CODE = #{DIV_CODE}
		    </if>
		       AND ((A.PJT_CODE = @PJT_CODE AND @PJT_CODE != '') OR (@PJT_CODE = ''))
		     GROUP BY A.COMP_CODE, A.AC_YYYYMM, A.FR_AC_DATE, A.TO_AC_DATE, A.DIV_CODE, A.PJT_CODE
		            , A.EX_DATE  , B.INPUT_DATE
	</select>
	
	
	<select id="agc340ukrServiceImpl.fnCreateTable" parameterType="Map" resultType="rMap">
		--임시테이블 생성
		
		--1. 작업할 데이터를 temp table 로 만든다.
	    --agc340ukr.Cagc340UKR[fnCreateTable] Query6
	    
	    
	    IF OBJECT_ID('tempdb..${sTblName}')  IS NOT NULL
	    DROP TABLE ${sTblName}
	    
	    SELECT *
	    INTO  ${sTblName}
	    FROM (
	    
	          SELECT  A.DIV_CODE,     A.ACCNT
	          		, A.AC_DATE,      A.INPUT_PATH
				<if test="sSrcTbl == &quot;AGB200T&quot;">	
					, A.BOOK_DATA1,   A.BOOK_DATA2
					, A.BOOK_CODE1,   A.BOOK_CODE2
				</if> 
	          		, A.DR_AMT_I,     A.CR_AMT_I
	          		, A.SPEC_DIVI,    A.PROFIT_DIVI,      A.JAN_DIVI
	          		
	          		
	            FROM ${sSrcTbl} A
	                INNER JOIN ABA400T AS B WITH (NOLOCK) ON  B.COMP_CODE = A.COMP_CODE
	                                                     AND B.ACCNT     = A.ACCNT
	                                                     AND ISNULL(B.SPEC_DIVI, '') != 'H'
	           WHERE A.COMP_CODE = #{S_COMP_CODE}
	           
	    
	  
	    <if test="SEARCH == &quot;SEARCH&quot;">
	             AND A.AC_DATE  &gt;= #{ST_DATE}
	             AND A.AC_DATE  &lt;= #{TO_DATE} + '31'
	    </if>
	    <if test="SEARCH != &quot;SEARCH&quot;">
	             AND A.AC_DATE  &gt;= #{ST_DATE}
	             AND A.AC_DATE  &lt;= #{TO_DATE} + '31'
	    </if>
	    
	    
		--손익현황의 기술용역원가는 용역원가의 당기용역원가를 참조한다.
		--계정은 손익특성이 용역매출원가로 설정된 계정(결산계정:profit_divi='C7')을 사용한다.
		
	    <if test="sDivi == &quot;20&quot;">
	    	UNION ALL
			
	        SELECT ${sDivCode}  AS DIV_CODE
	             , A.ACCNT
	             , ${sToDate} AS AC_DATE
	             , '' AS INPUT_PATH
	        
	        <if test="sSrcTbl == &quot;AGB200T&quot;">	
	            
	             , CASE WHEN ISNULL(B.BOOK_CODE1,'') = 'E1' THEN #{AC_PROJECT_CODE}
	                    ELSE ''
	                END AS BOOK_DATA1
	             , CASE WHEN ISNULL(B.BOOK_CODE2,'') = 'E1' THEN #{AC_PROJECT_CODE}
	                    ELSE ''
	                END AS BOOK_DATA2
	             , ISNULL(B.BOOK_CODE1, '') AS BOOK_CODE1
	             , ISNULL(B.BOOK_CODE2, '') AS BOOK_CODE2
	        
	        </if>
	        
	             , CASE WHEN B.JAN_DIVI = '1' THEN ${dAmt7000}
	                    ELSE 0.0
	                END AS DR_AMT_I
	             , CASE WHEN B.JAN_DIVI = '1' THEN 0.0
	                    ELSE ${dAmt7000}
	                END AS CR_AMT_I
	             , ISNULL(B.SPEC_DIVI  ,'') AS SPEC_DIVI
	             , ISNULL(B.PROFIT_DIVI,'') AS PROFIT_DIVI
	             , ISNULL(B.JAN_DIVI   ,'') AS JAN_DIVI
	        
	          FROM           ABA120TV AS A  WITH (NOLOCK)
	              INNER JOIN ABA400T  AS B WITH (NOLOCK)  ON  B.COMP_CODE = A.COMP_CODE
	                                                      AND B.ACCNT     = A.ACCNT
	                                                      AND ISNULL(B.PROFIT_DIVI,'') = 'C7'
	         WHERE A.COMP_CODE = #{S_COMP_CODE}
	           AND A.GUBUN     = #{GUBUN}
	           AND A.DIVI      = #{sDivi}
	           AND A.ACCNT_CD  = #{COST_PD}
	     --    ORDER BY A.ACCNT
	        
	    </if>
		) A
	    
	</select>
	
	<select id="agc340ukrServiceImpl.fnMakeSQL" parameterType="Map" resultType="rMap">
	--agc340ukr.Cagc340UKR[fnMakeSQL] Query07"
	    DECLARE @COMP_CODE  NVARCHAR(8)
	          , @GUBUN      NVARCHAR(2)
	          , @DIVI       NVARCHAR(2)
	    
	    SET @COMP_CODE = #{S_COMP_CODE}
	    SET @GUBUN     = #{GUBUN}
	    SET @DIVI      = #{sDivi}
	    
	    SELECT ISNULL(ACCNT_CD,'') AS ACCNT_CD
	         , CASE ISNULL(ACCNT,'')
	                WHEN '' THEN  CASE ISNULL(MAX(OPT_DIVI),'')
	                                   WHEN '1' THEN CASE WHEN ISNULL(SUM(AMT_I),0.0) &gt;= 0 
	                                                      THEN (SELECT ${sItemNm}
	                                                              FROM ABA120T  WITH (NOLOCK)
	                                                             WHERE COMP_CODE = @COMP_CODE
	                                                               AND GUBUN     = @GUBUN
	                                                               AND DIVI      = @DIVI
	                                                               AND ACCNT_CD  = Z.ACCNT_CD)
	                                                      ELSE (SELECT ${sItemNm}
	                                                              FROM ABA120T  WITH (NOLOCK)
	                                                             WHERE COMP_CODE = @COMP_CODE
	                                                               AND GUBUN     = @GUBUN
	                                                               AND DIVI      = @DIVI
	                                                               AND ACCNT_CD  = (SELECT MIN(ACCNT_CD)
	                                                                                  FROM ABA120T  WITH (NOLOCK)
	                                                                                 WHERE COMP_CODE = @COMP_CODE
	                                                                                   AND GUBUN     = @GUBUN
	                                                                                   AND DIVI      = @DIVI
	                                                                                   AND ACCNT_CD &gt;= Z.ACCNT_CD
	                                                                                   AND OPT_DIVI  = '2'))
	                                                  END
	                                   ELSE (SELECT ${sItemNm}
	                                           FROM ABA120T  WITH (NOLOCK)
	                                          WHERE COMP_CODE = @COMP_CODE
	                                            AND GUBUN     = @GUBUN
	                                            AND DIVI      = @DIVI
	                                            AND ACCNT_CD  = Z.ACCNT_CD)
	                               END
	                ELSE (SELECT SPACE(4) + ${sAccntNm}
	                        FROM ABA400T  WITH (NOLOCK)
	                       WHERE COMP_CODE = @COMP_CODE
	                         AND ACCNT     = Z.ACCNT)
	            END AS ACCNT_NAME
	         , ISNULL(SUM(AMT_I),0.0)    AS AMT_I
	         , ISNULL(MAX(OPT_DIVI),'')  AS OPT_DIVI
	         , ISNULL((SELECT CAL_DIVI
	                     FROM ABA130T  WITH (NOLOCK)
	                    WHERE COMP_CODE = @COMP_CODE
	                      AND GUBUN     = @GUBUN
	                      AND DIVI      = @DIVI
	                      AND ACCNT     = Z.ACCNT_CD
	                      AND ISNULL(REFER,'') = ''),'') AS CAL_DIVI
	         , CASE ISNULL(ACCNT,'')
	                WHEN '' THEN (SELECT ACCNT_CD
	                                FROM ABA130T  WITH (NOLOCK)
	                               WHERE COMP_CODE = @COMP_CODE
	                                 AND GUBUN = @GUBUN
	                                 AND DIVI  = @DIVI
	                                 AND ACCNT = Z.ACCNT_CD
	                                 AND ISNULL(REFER,'') = '')
	                ELSE ''
	            END AS UPPER_ACCNT
	      FROM (
	      
	      
	-- fnGetThisTerm begine

				SELECT MAX(ISNULL(SEQ,0 ))        AS SEQ
	                 , ISNULL(ACCNT_CD,'')        AS ACCNT_CD
	                 , ISNULL(ACCNT,'')           AS ACCNT
	                 , MAX(ISNULL(DIS_DIVI,''))   AS DIS_DIVI
	                 , MAX(ISNULL(OPT_DIVI,''))   AS OPT_DIVI
	                 , SUM(ISNULL(AMT_I,0.0))     AS AMT_I
	              FROM (
	                    SELECT SEQ
	                         , ACCNT_CD
	                         , ACCNT
	                         , OPT_DIVI
	                         , DIS_DIVI
	                         , (CASE DR_CR   WHEN '10' THEN ISNULL(AMT_I10,0.0)
	                                         WHEN '20' THEN ISNULL(AMT_I20,0.0)
	                                         WHEN '30' THEN ISNULL(AMT_I30,0.0)
	                                         WHEN '40' THEN ISNULL(AMT_I30,0.0) - ISNULL(AMT_I20,0.0)
	                                         WHEN '50' THEN ISNULL(AMT_I50,0.0)
	                                         WHEN '60' THEN ISNULL(AMT_I60,0.0)
	                                         WHEN '70' THEN ISNULL(AMT_I50,0.0) - ISNULL(AMT_I60,0.0)
	                                         WHEN '80' THEN ISNULL(AMT_I80,0.0)
	                             END) * (CASE CAL_DIVI WHEN '1' THEN   1 
	                                                   WHEN '2' THEN (-1)
	                                      END) AS AMT_I
	                      FROM (
	                            SELECT A.SEQ
	                                 , A.ACCNT_CD
	                                 , '' AS ACCNT
	                                 , A.DR_CR
	                                 , A.CAL_DIVI
	                                 , A.OPT_DIVI
	                                 , A.DIS_DIVI
	    -------------------------------------------------------------------------------
	    --년초
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(CASE JAN_DIVI WHEN '1' THEN ISNULL(DR_AMT_I,0.0) - ISNULL(CR_AMT_I,0.0)
	                                                             WHEN '2' THEN ISNULL(CR_AMT_I,0.0) - ISNULL(DR_AMT_I,0.0)
	                                                             ELSE 0.0
	                                                END)
	                                      FROM ${sTblName}
	                                     WHERE AC_DATE    = #{ST_DATE}
	                                       AND INPUT_PATH IN ('A0','10','11')
	                                       
	                                       
	                                       AND COMP_CODE = A.COMP_CODE
										   AND ACCNT     = A.ACCNT
										   <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
									       	    AND  ISNULL(DIV_CODE,'') IN
												<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
													#{item}
												</foreach>									
										   </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>                       
	                                                            
	                                                             
	                                   ) AS AMT_I10
	    -------------------------------------------------------------------------------
	    --기초잔액
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(CASE JAN_DIVI WHEN '1' THEN ISNULL(DR_AMT_I,0.0) - ISNULL(CR_AMT_I,0.0)
	                                                             WHEN '2' THEN ISNULL(CR_AMT_I,0.0) - ISNULL(DR_AMT_I,0.0)
	                                                             ELSE 0.0
	                                                END)
	                                      FROM ${sTblName}
	    
	    <if test="sFrDate == ST_DATE + &quot;01&quot;">	
	                                         WHERE AC_DATE    = #{ST_DATE}
	                                           AND INPUT_PATH IN ('A0','10','11')
	    </if>
	    <if test="sFrDate != ST_DATE + &quot;01&quot;">	
	                                         WHERE AC_DATE   &gt;= #{ST_DATE}
	                                           AND AC_DATE   &lt;  #{sFrDate}
	    </if>
	    
	    									   AND COMP_CODE = A.COMP_CODE
										       AND ACCNT     = A.ACCNT
										   <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
									       	   AND  ISNULL(DIV_CODE,'') IN
												<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
													#{item}
												</foreach>									
										   </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>
	                                      
	                                      
	                                   ) AS AMT_I20
	    -------------------------------------------------------------------------------
	    --기말잔액
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(CASE JAN_DIVI WHEN '1' THEN ISNULL(DR_AMT_I,0.0) - ISNULL(CR_AMT_I,0.0)
	                                                             WHEN '2' THEN ISNULL(CR_AMT_I,0.0) - ISNULL(DR_AMT_I,0.0)
	                                                             ELSE 0.0
	                                                END)
	                                      FROM ${sTblName}
	                                     WHERE AC_DATE   &gt;= #{ST_DATE}
	                                       AND AC_DATE   &lt;= #{sToDate}
	                                       
	                                       
	                                       AND COMP_CODE = A.COMP_CODE
										   AND ACCNT     = A.ACCNT
										   <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
									       AND  ISNULL(DIV_CODE,'') IN
												<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
													#{item}
												</foreach>									
										   </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>     
	                                      
	                                      
	                                   ) AS AMT_I30
	    -------------------------------------------------------------------------------
	    --차변발생
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(DR_AMT_I)
	                                      FROM ${sTblName}
	                                     WHERE ((AC_DATE    &gt;= #{sFrDate}
	                                       AND   AC_DATE    &lt;= #{sToDate}
	                                       AND   INPUT_PATH != 'A1')
	    
	    <if test="FR_DATE == ST_DATE">	 
	                                            OR  (AC_DATE   &gt;= #{ST_DATE}
	                                           AND   AC_DATE   &lt;= #{sToDate}
	                                           AND   INPUT_PATH = 'A1')
	    </if>
	                                           )
	    
	
										   AND COMP_CODE = A.COMP_CODE
										   AND ACCNT     = A.ACCNT
										   <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
									       AND  ISNULL(DIV_CODE,'') IN
												<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
													#{item}
												</foreach>									
										   </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>
	                                      
	    
	    --경비 대체할 때 차변발생이더라도 원가대체 조회할 경우는 나오지 않도록 하기 위해(검색인 경우는 제외)
	    <if test="SEARCH != &quot;SEARCH&quot;">
	                                       AND ACCNT NOT IN (SELECT ACCNT
	                                                           FROM ABA120TV WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT
	                                                            AND GUBUN     = A.GUBUN
	                                                            AND DIVI      = '31'
	                                                            AND ACCNT_CD IN ('1050', '2000', '3000'))
	    </if>
	                                   ) AS AMT_I50
	    -------------------------------------------------------------------------------
	    --대변발생
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(CR_AMT_I)
	                                      FROM ${sTblName}
	                                     WHERE ((AC_DATE   &gt;= #{sFrDate}
	                                       AND   AC_DATE   &lt;= #{sToDate}
	                                       AND   INPUT_PATH != 'A1')
	    
	    <if test="FR_DATE == ST_DATE">	
	                                            OR  (AC_DATE   &gt;= #{sFrDate}
	                                           AND   AC_DATE   &lt;= #{sToDate}
	                                           AND   INPUT_PATH = 'A1')
	    </if>
	    
	                                           )
	                                           
	                                           
	    								AND COMP_CODE = A.COMP_CODE
										AND ACCNT     = A.ACCNT
									   <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
								        AND  ISNULL(DIV_CODE,'') IN
											<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
												#{item}
											</foreach>									
									   </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>
	    
	    
	    --경비 대체할 때 차변발생이더라도 원가대체 조회할 경우는 나오지 않도록 하기 위해(검색인 경우는 제외)
	    <if test="SEARCH != &quot;SEARCH&quot;">
	                                       AND ACCNT NOT IN (SELECT ACCNT
	                                                           FROM ABA120TV WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT
	                                                            AND GUBUN     = A.GUBUN
	                                                            AND DIVI      = '31'
	                                                            AND ACCNT_CD IN ('1050', '2000', '3000'))
	    </if>
	                                   ) AS AMT_I60
	    -------------------------------------------------------------------------------
	    --대체대변
	    -------------------------------------------------------------------------------
	                                 , (SELECT SUM(CR_AMT_I)
	                                      FROM ${sTblName}
	                                     WHERE AC_DATE   &gt;= #{sFrDate}
	                                       AND AC_DATE   &lt;= #{sToDate}
	                                       AND INPUT_PATH = '52'
	    
										
										   AND COMP_CODE = A.COMP_CODE
										   AND ACCNT     = A.ACCNT
									       <if test="@foren.Ognl@isNotEmpty(ACCNT_DIV_CODE)">					
								           AND  ISNULL(DIV_CODE,'') IN
											<foreach collection="ACCNT_DIV_CODE" item="item" separator="," close=")" open="(">
												#{item}
											</foreach>									
									       </if>
									-- 관세환급액은 손익계산서에서 계산하므로, 원가대체에서도 반영하면 2번 빠지는 결과가 생긴다.
								    -- 따라서 원가대체시에는 관세환급액(spec_divi='H')인 계정과목은 계산하지 않는다.
								    -- 제조원가명세서에도 적용(2006.06.20 song)
										  AND 'H' != ISNULL((SELECT SPEC_DIVI
	                                                           FROM ABA400T  WITH (NOLOCK)
	                                                          WHERE COMP_CODE = A.COMP_CODE
	                                                            AND ACCNT     = A.ACCNT),'')
	                                      <if test="sSrcTbl == &quot;AGB200T&quot;">	 
	                                      AND ((BOOK_CODE1 = 'E1' AND BOOK_DATA1 = #{AC_PROJECT_CODE})
	                                       OR  (BOOK_CODE2 = 'E1' AND BOOK_DATA2 = #{AC_PROJECT_CODE}))
	                                      </if>	
	
	
	                                  ) AS AMT_I80
	    
	                              FROM ABA120TV A WITH (NOLOCK)
	                             WHERE A.COMP_CODE = #{S_COMP_CODE}
	                               AND A.GUBUN     = #{GUBUN}
	                               AND A.DIVI      = #{sDivi}
	                               AND ISNULL(A.DR_CR,'') != '90'
	                               AND ISNULL(A.DIS_DIVI,'') != '4'
	    
	    						<if test="@foren.Ognl@isNotEmpty(sAccntCd)">
	                               AND ISNULL(A.ACCNT_CD,'') = #{sAccntCd}
	    						</if>
	    
	    -------------------------------------------------------------------------------
	    -- 2005.06.08 jeong
	    -- 손익현황에서
	    -- 기술용역원가 항목에 해당하는 계정은 집계대상 계정에서 제외한다.
	    
	    -- 단, profit_divi = 'C7'인 계정을 포함하는 이유는
	    --     용역원가의 당기용역원가의 금액을 profit_divi = 'C7'인 계정을 사용하여
	    --     손익현황의 기술용역원가 항목에 반영하기 위해
	    -------------------------------------------------------------------------------
	    <if test="sDivi == &quot;20&quot;">
	        
	                                   AND A.ACCNT+'::'+A.DR_CR NOT IN (SELECT ACCNT+'::'+DR_CR
	                                                                      FROM ABA120TV T WITH (NOLOCK)
	                                                                     WHERE COMP_CODE = #{S_COMP_CODE}
											                               AND GUBUN     = #{GUBUN}
											                               AND DIVI      = #{sDivi}
	                                                                       AND ACCNT_CD  = #{COST_PD}
	                                                                       AND 'C7' != (SELECT PROFIT_DIVI
	                                                                                     FROM ABA400T  WITH (NOLOCK)
	                                                                                    WHERE COMP_CODE = T.COMP_CODE
	                                                                                      AND ACCNT     = T.ACCNT))
	    
	    </if>
	                           ) Z
	    
	    -------------------------------------------------------------------------------
	    -- 인쇄여부:"제목+우"
	    -- 집계구분:"기말재고액"인 항목은 데이터가 없더라도 표시하기 위해 쿼리 삽입
	    -------------------------------------------------------------------------------
	    
	                     UNION ALL
	    
	                    SELECT A.SEQ
	                         , A.ACCNT_CD
	                         , ''   AS ACCNT
	                         , A.OPT_DIVI
	                         , A.DIS_DIVI
	                         , NULL AS AMT_I
	                      FROM ABA120T A WITH (NOLOCK)
	                     WHERE A.COMP_CODE = #{S_COMP_CODE}
	                       AND A.GUBUN     = #{GUBUN}
	                       AND A.DIVI      = #{sDivi}
	                       AND (ISNULL(A.DIS_DIVI,'') = '3' OR ISNULL(A.OPT_DIVI,'') = '8')
	                       AND ISNULL(A.DIS_DIVI,'') != '4'
	                       AND ISNULL(A.OPT_DIVI,'') != '2'
						<if test="@foren.Ognl@isNotEmpty(sAccntCd)">
	                       AND ISNULL(A.ACCNT_CD,'') = #{sAccntCd}
						</if>
	        
	    -------------------------------------------------------------------------------
	    -- 손익현황의 "당기용역원가" 항목은 데이터가 없더라도 표시하기 위해 쿼리 삽입
	    -------------------------------------------------------------------------------
	    <if test="sDivi == &quot;20&quot;">
	    
	                         UNION ALL
	                        SELECT A.SEQ
	                             , A.ACCNT_CD
	                             , ''   AS ACCNT
	                             , A.OPT_DIVI
	                             , A.DIS_DIVI
	                             , NULL AS AMT_I
	                          FROM ABA120T A WITH (NOLOCK)
	                         WHERE A.COMP_CODE = #{S_COMP_CODE}
		                       AND A.GUBUN     = #{GUBUN}
		                       AND A.DIVI      = #{sDivi}
	                           AND ISNULL(A.ACCNT_CD,'') = #{COST_PD}
	        
	    </if>
	    
	                   ) Z
	             GROUP BY Z.ACCNT_CD, Z.ACCNT
	             HAVING ISNULL(MAX(Z.DIS_DIVI),'') != '4'
	    			<if test="@foren.Ognl@isEmpty(FR_DATE)">
	                    AND ISNULL(Z.ACCNT_CD,'') = ''
	    			</if>
			
	--fnGetThisTerm end

	           ) Z
	     GROUP BY Z.SEQ, Z.ACCNT_CD, Z.ACCNT
	     HAVING     (ISNULL(MAX(Z.DIS_DIVI),'') = '3'
	             OR  ISNULL(MAX(Z.OPT_DIVI),'') = '5'
	             OR  ISNULL(MAX(Z.OPT_DIVI),'') = '8'
	    
	    <if test="sDivi == &quot;31&quot;">
	                 OR  (SELECT ACCNT_CD
	                        FROM ABA130T   WITH (NOLOCK)
	                       WHERE COMP_CODE = @COMP_CODE
	                         AND GUBUN     = @GUBUN
	                         AND DIVI      = @DIVI
	                         AND ACCNT     = Z.ACCNT_CD) IN ('1050', '2000','3000')
	    </if>
	    
	             OR  ISNULL(SUM(Z.AMT_I),0) != 0)
	    
	     ORDER BY Z.SEQ, Z.ACCNT_CD, Z.ACCNT
	</select>
	
	
	<select id="agc340ukrServiceImpl.fnagd058Canc" parameterType="Map" resultType="rMap">
		--UAgd01Krv.Cagd058UKR[fnagd058Canc] Query08
	    BEGIN
	        DECLARE @COMP_CODE      NVARCHAR(08)     --UI 로부터 받은 파라메터
	              , @AC_YYYYMM      NVARCHAR(06)
	              , @FR_AC_DATE     NVARCHAR(06)
	              , @TO_AC_DATE     NVARCHAR(06)
	              , @DIV_CODEQ      NVARCHAR(255)
	              , @PJT_CODE       NVARCHAR(20)
	              , @INPUT_USER_ID  NVARCHAR(100)
	              , @INPUT_DATE     NVARCHAR(08)
	              , @INPUT_PATH     NVARCHAR(10)
	    
	              , @ERR_DESC       NVARCHAR(4000)  --에러정보 
	              , @CANCLE_CNT     INT             --취소건수
	    
	        SET     @COMP_CODE      = #{S_COMP_CODE}
	        SET     @AC_YYYYMM      = #{ST_DATE}
	        SET     @FR_AC_DATE     = #{FR_DATE}
	        SET     @TO_AC_DATE     = #{TO_DATE}
	        SET     @DIV_CODEQ      = #{ACCNT_DIV_CODE}
	        SET     @PJT_CODE       = #{AC_PROJECT_CODE}
	        SET     @INPUT_USER_ID  = #{S_USER_ID}
	        SET     @INPUT_DATE     = #{INPUT_DATE}
	        SET     @INPUT_PATH     = #{sGubun}
	    
	        SET     @ERR_DESC       = ''
	        SET     @CANCLE_CNT     = 0
	    
	        SET NOCOUNT ON
	        SET ARITHABORT ON
	    
	        /*----------------------------------------------*/
	        /* 0. 사용자권한 확인                           */
	        /*----------------------------------------------*/
	        DECLARE @AUTHO_YN   NUMERIC(01)
	        SET     @AUTHO_YN   = 0
	    
	        SELECT @AUTHO_YN = COUNT(1)
	        FROM  BSA500TV  WITH (NOLOCK)
	        WHERE COMP_CODE = @COMP_CODE
	        AND   USER_ID   = @INPUT_USER_ID
	        AND   PGM_ID    = N'AGJ260UKR'
	    
	        IF ( @AUTHO_YN = 0 )
	        BEGIN
	            --사용 권한이 없습니다.
	            SET @ERR_DESC = '54363;'
	            GOTO ERROR_HANDLER
	        END
	    
	        /*----------------------------------------------*/
	        /* 3. 자동기표취소 할 데이터 추출               */
	        /*----------------------------------------------*/
	        DECLARE ADT_0002_CURSOR CURSOR FOR
	        SELECT  DISTINCT 
	                A.EX_DATE
	             ,  A.EX_NUM
	             ,  ISNULL(B.AP_STS,'')     AS AP_STS
	             ,  ISNULL(B.DRAFT_YN,'')   AS DRAFT_YN
	        FROM           AGC340T  AS A
	            INNER JOIN AGJ110T  AS B  ON  B.COMP_CODE = A.COMP_CODE
	                                      AND B.EX_DATE   = A.EX_DATE
	                                      AND B.EX_NUM    = A.EX_NUM
	                                      AND (B.MOD_DIVI = '' OR B.MOD_DIVI IS NULL)
	        WHERE A.COMP_CODE  = @COMP_CODE
	        AND   A.AC_YYYYMM  = @AC_YYYYMM
	        AND   A.FR_AC_DATE = @FR_AC_DATE
	        AND   A.TO_AC_DATE = @TO_AC_DATE
	        AND   A.DIV_CODE   = @DIV_CODEQ
	        AND   A.PJT_CODE   = @PJT_CODE
	    
	        /*----------------------------------------------*/
	        /* 4. 자동기표취소                              */
	        /*----------------------------------------------*/
	        DECLARE @ExDate        NVARCHAR(08)
	              , @ExNum         NUMERIC(07, 0)
	              , @ApSts         NVARCHAR(01)
	              , @DraftYN       NVARCHAR(01)
	    
	              , @DrCr          NVARCHAR(01)
	              , @Accnt         NVARCHAR(16)
	              , @AmtI          NUMERIC(30, 6)
	              , @DeptCode      NVARCHAR(08)
	              , @JanDivi       NVARCHAR(01)
	              , @BudgYN        NVARCHAR(01)
	    
	              , @ExCloseFg     NVARCHAR(01)     --전표마감정보
	              , @ExCloseDate   NVARCHAR(08)
	    
	    
	        OPEN ADT_0002_CURSOR
	    
	        FETCH NEXT FROM ADT_0002_CURSOR
	        INTO  @ExDate, @ExNum, @ApSts, @DraftYN
	    
	        WHILE ( @@FETCH_STATUS = 0 )
	        BEGIN
	    
	            /*----------------------------------------------*/
	            /* 4.1. 승인여부 확인                           */
	            /*----------------------------------------------*/
	            IF ( @ApSts = '2' )
	            BEGIN
	                --이미 승인된 전표입니다.
	                SET @ERR_DESC = '54341;A0034:' + @ExDate + ',A0035:' + CONVERT(NVARCHAR, @ExNum)
	                GOTO ERROR_HANDLER
	            END
	    
	            /*----------------------------------------------*/
	            /* 4.2. 결재상신여부 확인                       */
	            /*----------------------------------------------*/
	            IF ( @DraftYN = 'Y' )
	            BEGIN
	                --이미 전자결재 상신된 전표입니다
	                SET @ERR_DESC = '55329;A0034:' + @ExDate + ',A0035:' + CONVERT(NVARCHAR, @ExNum)
	                GOTO ERROR_HANDLER
	            END
	    
	            /*----------------------------------------------*/
	            /* 4.3. 전표마감정보 체크                       */
	            /*----------------------------------------------*/
	            SELECT @ExCloseFg   = EX_CLOSE_FG
	                 , @ExCloseDate = EX_CLOSE_DATE
	            FROM   ABA160T WITH (NOLOCK)
	            WHERE  COMP_CODE  = @COMP_CODE
	            AND    CLOSE_DATE = LEFT(@ExDate,6)
	    
	            IF ( @@ROWCOUNT = 0 )
	            BEGIN
	                --기초등록-전표마감정보등록 메뉴에서 마감정보를 먼저 등록하십시오.
	                SET @ERR_DESC = '54331;'
	                GOTO ERROR_HANDLER
	            END
	    
	            IF ( @ExCloseFg = 'Y' )
	            BEGIN
	                --이미 전표가 마감되었습니다. 
	                SET @ERR_DESC = '54332;A0106:' + @ExCloseFg + ',A0043:' + @ExCloseDate + ',A0034:' + @ExDate
	                GOTO ERROR_HANDLER
	            END
	    
	            IF ( @ExCloseDate &lt; @INPUT_DATE )
	            BEGIN
	                --이미 전표가 마감되었습니다.
	                SET @ERR_DESC = '54332;A0106:' + @ExCloseFg + ',A0043:' + @ExCloseDate + ',A0107:' + @INPUT_DATE
	                GOTO ERROR_HANDLER
	            END
	    
	            /*----------------------------------------------*/
	            /* 4.6. 전표 데이터 삭제                        */
	            /*----------------------------------------------*/
	            UPDATE AGJ110T
	               SET MOD_DIVI    = N'D'
	                 , MOD_DATE    = GETDATE()
	                 , MOD_USER_ID = @INPUT_USER_ID
	             WHERE COMP_CODE   = @COMP_CODE
	               AND EX_DATE     = @ExDate
	               AND EX_NUM      = @ExNum
	               AND INPUT_PATH  = @INPUT_PATH
	               AND AP_STS      = N'1'
	               AND ( MOD_DIVI IS NULL OR MOD_DIVI = '' )
	    
	            /*----------------------------------------------*/
	            /* 4.7. 용역원가대체 마스터 테이블에 UPDATE     */
	            /*----------------------------------------------*/
	            UPDATE AGC340T
	               SET EX_DATE        = NULL
	                 , EX_NUM         = NULL
	                 , UPDATE_DB_USER = @INPUT_USER_ID
	                 , UPDATE_DB_TIME = GETDATE()
	             WHERE COMP_CODE = @COMP_CODE
	               AND EX_DATE   = @ExDate
	               AND EX_NUM    = @ExNum
	    
	            SET @CANCLE_CNT = @CANCLE_CNT + 1
	    
	            /*----------------------------------------------*/
	            /* 4.8. 커서 이동                               */
	            /*----------------------------------------------*/
	            FETCH NEXT FROM ADT_0002_CURSOR
	            INTO @ExDate, @ExNum, @ApSts, @DraftYN
	        END
	    
	        CLOSE ADT_0002_CURSOR
	        DEALLOCATE ADT_0002_CURSOR
	    
	        IF ( @CANCLE_CNT = 0 )
	        BEGIN
	            --자동기표를 취소할 자료가 없습니다.
	            SET @ERR_DESC = '54359;' 
	            GOTO ERROR_HANDLER
	        END
	    
	    
	     ERROR_HANDLER:
	        SET NOCOUNT OFF
	        SET ARITHABORT OFF
	    
	        IF CHARINDEX(';', @ERR_DESC) > 0
	            SELECT SUBSTRING(@ERR_DESC, 1, CHARINDEX(';', @ERR_DESC) - 1)               AS ERROR_CODE
	                 , SUBSTRING(@ERR_DESC, CHARINDEX(';', @ERR_DESC) + 1, LEN(@ERR_DESC))  AS ERROR_DESC
	        ELSE
	            SELECT TOP 1 '' ERROR_CODE, '' ERROR_DESC
	     END
	    
	</select>
	
	
	
	<select id="agc340ukrServiceImpl.beforeSaveCheck" parameterType="Map" resultType="rMap">
    ----------------------------------------------
    -- 전표생성여부, 승인여부 및 결재상신여부 확인  
    ----------------------------------------------
    SELECT ISNULL(A.EX_DATE,'')   AS EX_DATE
		 , ISNULL(A.EX_NUM,0)     AS EX_NUM
		 , ISNULL(B.AP_STS,'1')   AS AP_STS
		 , ISNULL(B.DRAFT_YN,'N') AS DRAFT_YN
		 
	  FROM        AGC340T AS A WITH (NOLOCK)
       LEFT  JOIN AGJ110T AS B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                          AND B.EX_DATE   = A.EX_DATE
                                          AND B.EX_NUM    = A.EX_NUM
                                          AND B.EX_SEQ    = 1
                                          AND (B.MOD_DIVI = ''
                                           OR  B.MOD_DIVI IS NULL)	          

     WHERE A.COMP_CODE  = #{S_COMP_CODE} 
       AND A.AC_YYYYMM  = #{ST_DATE}     
       AND A.FR_AC_DATE = #{FR_DATE}     
       AND A.TO_AC_DATE = #{TO_DATE}     
       AND A.DIV_CODE   = #{ACCNT_DIV_CODE}    
       AND (
           (#{AC_PROJECT_CODE}  =  '')
        OR (#{AC_PROJECT_CODE} != '' AND A.PJT_CODE = #{AC_PROJECT_CODE})
           )
     
	</select>
	
	
	<update id="agc340ukrServiceImpl.deleteMaster" parameterType="Map">
	    --agc340ukrv.Cagc340UKR.deleteMaster
	    DELETE FROM AGC340T
	    WHERE COMP_CODE       = #{S_COMP_CODE}
			   AND AC_YYYYMM  = #{ST_DATE}
			   AND FR_AC_DATE = #{FR_DATE}
			   AND TO_AC_DATE = #{TO_DATE}
			   AND DIV_CODE   = #{ACCNT_DIV_CODE}
			   AND PJT_CODE   = #{AC_PROJECT_CODE}
	</update>
	<update id="agc340ukrServiceImpl.deleteDetail" parameterType="Map">
		--agc340ukrv.Cagc340UKR.deleteDetail
	    DELETE FROM AGC341T
	    WHERE COMP_CODE       = #{S_COMP_CODE}
			   AND AC_YYYYMM  = #{ST_DATE}
			   AND FR_AC_DATE = #{FR_DATE}
			   AND TO_AC_DATE = #{TO_DATE}
			   AND DIV_CODE   = #{ACCNT_DIV_CODE}
			   AND PJT_CODE   = #{AC_PROJECT_CODE}
	</update>
	
	
	<insert id="agc340ukrServiceImpl.insertDetail1" parameterType="Map">
		--agc340ukr.Cagc340UKR[fnagc340Save] Query09
            IF (SELECT COUNT(*) 
                  FROM AGC340T   WITH (NOLOCK)
                 WHERE COMP_CODE  = #{S_COMP_CODE}
                   AND AC_YYYYMM  = #{ST_DATE}
                   AND FR_AC_DATE = #{FR_DATE}
                   AND TO_AC_DATE = #{TO_DATE}
                   AND DIV_CODE   = #{ACCNT_DIV_CODE}
                   AND PJT_CODE   = #{AC_PROJECT_CODE}) != 0
            
                UPDATE AGC340T
                   SET COST_PD        =  ${COST_PD}
              --     , COST_GD        =  ${COST_GD}
                     , UPDATE_DB_USER = #{S_USER_ID}
                     , UPDATE_DB_TIME = GETDATE()
                 WHERE COMP_CODE      = #{S_COMP_CODE}             
                   AND AC_YYYYMM      = #{ST_DATE}                 
                   AND FR_AC_DATE     = #{FR_DATE}                 
                   AND TO_AC_DATE     = #{TO_DATE}                 
                   AND DIV_CODE       = #{ACCNT_DIV_CODE}          
                   AND PJT_CODE       = #{AC_PROJECT_CODE}
            ELSE
                INSERT INTO AGC340T ( COMP_CODE
                                    , AC_YYYYMM
                                    , FR_AC_DATE
                                    , TO_AC_DATE
                                    , DIV_CODE
                                    , PJT_CODE
                                    , COST_PD
                           --       , COST_GD
                                    , UPDATE_DB_USER
                                    , UPDATE_DB_TIME )
                             VALUES ( #{S_COMP_CODE}             
                                    , #{ST_DATE}                 
                                    , #{FR_DATE}                 
                                    , #{TO_DATE}                 
                                    , #{ACCNT_DIV_CODE}          
                                    , #{AC_PROJECT_CODE}   
                                    , ${COST_PD}
                          --        , ${COST_GD}
                                    , #{S_USER_ID}
                                    , GETDATE() )
		
	</insert>	
	
	<update id="agc340ukrServiceImpl.updateDetail1" parameterType="Map">		
	</update>
	
	<insert id="agc340ukrServiceImpl.insertDetail2" parameterType="Map">
		--agc340ukr.Cagc340UKR[fnagc340Save] Query10
		IF (SELECT COUNT(*) 
                  FROM AGC340T   WITH (NOLOCK)
                 WHERE COMP_CODE  = #{S_COMP_CODE}     
                   AND AC_YYYYMM  = #{ST_DATE}         
                   AND FR_AC_DATE = #{FR_DATE}         
                   AND TO_AC_DATE = #{TO_DATE}         
                   AND DIV_CODE   = #{ACCNT_DIV_CODE}  
                   AND PJT_CODE   = #{AC_PROJECT_CODE}) != 0
            
                UPDATE AGC340T
                   SET COST_PRPD      = ${COST_PRPD}
                     , UPDATE_DB_USER = #{S_USER_ID}
                     , UPDATE_DB_TIME = GETDATE()
                 WHERE COMP_CODE      = #{S_COMP_CODE}      
                   AND AC_YYYYMM      = #{ST_DATE}          
                   AND FR_AC_DATE     = #{FR_DATE}          
                   AND TO_AC_DATE     = #{TO_DATE}          
                   AND DIV_CODE       = #{ACCNT_DIV_CODE}   
                   AND PJT_CODE       = #{AC_PROJECT_CODE}
            ELSE
                INSERT INTO AGC340T ( COMP_CODE
                                    , AC_YYYYMM
                                    , FR_AC_DATE
                                    , TO_AC_DATE
                                    , DIV_CODE
                                    , PJT_CODE
                                    , COST_PRPD
                                    , UPDATE_DB_USER
                                    , UPDATE_DB_TIME )
                             VALUES ( #{S_COMP_CODE}      
                                    , #{ST_DATE}          
                                    , #{FR_DATE}          
                                    , #{TO_DATE}          
                                    , #{ACCNT_DIV_CODE}   
                                    , #{AC_PROJECT_CODE}  
                                    , ${COST_PRPD} 
                                    , #{S_USER_ID}
                                    , GETDATE() )
	</insert>
	
	<update id="agc340ukrServiceImpl.updateDetail2" parameterType="Map">		
	
	</update>
	
	
	<insert id="agc340ukrServiceImpl.insertDetail3" parameterType="Map">
		
	</insert>
	
	<update id="agc340ukrServiceImpl.updateDetail3" parameterType="Map">
		--agc340ukr.Cagc340UKR[fnagc340Save] Query11
		INSERT INTO AGC341T ( COMP_CODE
                            , AC_YYYYMM
                            , FR_AC_DATE
                            , TO_AC_DATE
                            , DIV_CODE
                            , PJT_CODE
                            , ACCNT
                            , COST_AMT
                            , UPDATE_DB_USER
                            , UPDATE_DB_TIME )
                     VALUES ( #{S_COMP_CODE}
                            , #{ST_DATE}        
                            , #{FR_DATE}        
                            , #{TO_DATE}        
                            , #{ACCNT_DIV_CODE} 
                            , #{AC_PROJECT_CODE}
                            , #{ACCNT}
                            , #{RPLC_AMT_I}
                            , #{S_USER_ID}
                            , GETDATE() )
	</update>
	
</mapper>