<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_emp130skrv_hsServiceImpl">
	<select id="s_emp130skrv_hsServiceImpl.selectList" parameterType="Map" resultType="rMap">
		--	s_emp130skrv_hsServiceImpl.selectList

		DECLARE @COMP_CODE NVARCHAR(8), @DIV_CODE NVARCHAR(8),  @TO_DAY NVARCHAR(8)

		SET @COMP_CODE =#{S_COMP_CODE}
		SET @DIV_CODE  =#{S_DIV_CODE}
		SET @TO_DAY = CONVERT(VARCHAR(8), DATEADD(DAY, -1, GETDATE()), 112)	--전일기준
				
		SELECT *
		  FROM (

				SELECT M.GUBUN
					 , M.EQU_NAME
					 , B.MAX_PUNCH_Q AS PRODT_CAPA	--일생산능력
					 , SUM(CASE WHEN LEFT(A.PRODT_DATE,8) = @TO_DAY THEN A.PRODT_Q ELSE 0 END) AS PRODT_Q				--일생산량
					 , SUM(CASE WHEN LEFT(A.PRODT_DATE,8) = @TO_DAY THEN A.PRODT_Q ELSE 0 END) / B.MAX_PUNCH_Q * 100 AS OPER_RATE	--일가동율
					 , SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = LEFT(@TO_DAY,6) THEN A.PRODT_Q ELSE 0 END) AS M_PRODT_Q		--월생산량
					 , CASE WHEN ISNULL(T.M_WORKING_CNT,0) = 0 THEN 0 ELSE SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = LEFT(@TO_DAY,6) THEN A.PRODT_Q ELSE 0 END) / (ISNULL(T.M_WORKING_CNT,0) * B.MAX_PUNCH_Q) * 100 END AS M_OPER_RATE	--월가동율
					 , SUM(CASE WHEN LEFT(A.PRODT_DATE,4) = LEFT(@TO_DAY,4) THEN A.PRODT_Q ELSE 0 END) AS Y_PRODT_Q	--년생산량
					 , CASE WHEN ISNULL(T.Y_WORKING_CNT,0) = 0 THEN 0 ELSE SUM(CASE WHEN LEFT(A.PRODT_DATE,4) = LEFT(@TO_DAY,4) THEN A.PRODT_Q ELSE 0 END) / (ISNULL(T.Y_WORKING_CNT,0)* B.MAX_PUNCH_Q) * 100 END AS Y_OPER_RATE	--년가동율
					 , ROW_NUMBER() OVER(ORDER BY M.WORK_SHOP_CODE)											AS [ROW_NUMBER]
					 , COUNT(*) OVER()																		AS TOTAL			 
					-- , M.WORK_SHOP_CODE
					--, ISNULL(T.M_WORKING_CNT,0) M_WORKING_CNT, ISNULL(T.Y_WORKING_CNT,0) Y_WORKING_CNT, B.CAVIT_BASE_Q
					--, ISNULL(T.M_WORKING_CNT,0) * B.CAVIT_BASE_Q
					--, ISNULL(T.Y_WORKING_CNT,0)* B.CAVIT_BASE_Q
				FROM (
						SELECT A.COMP_CODE, @DIV_CODE AS DIV_CODE, A.REF_CODE2 AS GUBUN, A.CODE_NAME AS EQU_NAME, REF_CODE1 AS WORK_SHOP_CODE
						FROM BSA100T A
						WHERE A.COMP_CODE=@COMP_CODE
						AND A.MAIN_CODE='ZP02'
						AND A.SUB_CODE != '$'
					 ) M
					 LEFT JOIN PMR110T A ON A.COMP_CODE=M.COMP_CODE AND A.DIV_CODE=M.DIV_CODE AND A.WORK_SHOP_CODE=M.WORK_SHOP_CODE
					 INNER JOIN EQU200T B ON B.COMP_CODE=M.COMP_CODE AND B.DIV_CODE=M.DIV_CODE AND B.WORK_SHOP_CODE=M.WORK_SHOP_CODE
					 LEFT JOIN (
								SELECT COMP_CODE, DIV_CODE, WORK_SHOP_CODE, COUNT(1) AS Y_WORKING_CNT, SUM(CASE WHEN LEFT(PRODT_DATE,6)=LEFT(@TO_DAY, 6) THEN 1 ELSE 0 END) AS M_WORKING_CNT
								FROM (
										SELECT COMP_CODE, DIV_CODE, WORK_SHOP_CODE, PRODT_DATE
										FROM PMR110T WITH (NOLOCK)
										WHERE COMP_CODE=@COMP_CODE
										AND DIV_CODE=@DIV_CODE
										AND PRODT_DATE LIKE LEFT(@TO_DAY, 4) + '%'
										GROUP BY COMP_CODE, DIV_CODE, WORK_SHOP_CODE, PRODT_DATE
									) X
								GROUP BY COMP_CODE, DIV_CODE, WORK_SHOP_CODE	 
					 ) T ON T.COMP_CODE=M.COMP_CODE AND T.DIV_CODE=M.DIV_CODE AND T.WORK_SHOP_CODE=M.WORK_SHOP_CODE
				GROUP BY M.COMP_CODE, M.GUBUN, M.EQU_NAME, B.MAX_PUNCH_Q , M.WORK_SHOP_CODE, ISNULL(T.M_WORKING_CNT,0), ISNULL(T.Y_WORKING_CNT,0)
 
					 
			   ) T
		<if test="@foren.Ognl@isNotEmpty(page)"> 
		 WHERE T.[ROW_NUMBER] BETWEEN ${start} + 1 AND ${limit} * ${page}
		</if>
		ORDER BY T.GUBUN, T.EQU_NAME
	</select>
	
	<select id="s_emp130skrv_hsServiceImpl.selectExchg" parameterType="Map" resultType="rMap">
		SELECT A.MONEY_UNIT
			 , BASE_EXCHG
			 , CASE WHEN CHANGE_PRICE &lt; 0 THEN '▼'
					WHEN CHANGE_PRICE = 0 THEN '-'
					ELSE '▲' 
			   END ID_SIGN
			 , CHANGE_PRICE
			 , CHANGE_RATE
		  FROM BCM520T A WITH (NOLOCK)
				LEFT OUTER JOIN	BSA100T B WITH (NOLOCK)
							 ON B.COMP_CODE	= A.COMP_CODE
							AND B.MAIN_CODE	= 'B004'
							AND B.SUB_CODE	= A.MONEY_UNIT
		 WHERE A.COMP_CODE	= #{S_COMP_CODE}
		   AND A.BASE_DATE	= (	SELECT MAX(BASE_DATE)
								  FROM BCM520T WITH (NOLOCK)
								 WHERE COMP_CODE	 = A.COMP_CODE
								   AND MONEY_UNIT	 = A.MONEY_UNIT
								   AND BASE_DATE	&lt;= CONVERT(NVARCHAR(8), GETDATE(), 112)	)
		   AND A.BASE_DATE + A.BASE_TIME	= (	SELECT MAX(BASE_DATE + BASE_TIME)
												  FROM BCM520T WITH (NOLOCK)
												 WHERE COMP_CODE	= A.COMP_CODE
												   AND BASE_DATE	= A.BASE_DATE
												   AND MONEY_UNIT	= A.MONEY_UNIT	)
		 ORDER BY ISNULL(B.SORT_SEQ, '99')
	</select>
</mapper>