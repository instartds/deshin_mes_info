<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_ppl100ukrv_inServiceImpl">
 
    <select id="s_ppl100ukrv_inServiceImpl.selectDetailList" parameterType="Map" resultType="rMap">
    	--s_ppl100ukrv_inServiceImpl.selectDetailList
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
            
            
            SET NOCOUNT ON

			DECLARE @COMP_C0DE NVARCHAR(10), 
							@DIV_CODE NVARCHAR(10), 
							@PLAN_YM NVARCHAR(6),
							@SEMI_ITEM_CODE NVARCHAR(50)
			
			SET @COMP_C0DE = #{S_COMP_CODE}
			SET @DIV_CODE = #{DIV_CODE}
			SET @PLAN_YM = #{FR_MONTH}
			SET @SEMI_ITEM_CODE = #{SEMI_ITEM_CODE}
			
			IF EXISTS (SELECT TOP 1 1 FROM tempdb..sysobjects WHERE ID=OBJECT_ID('tempdb..#TMP_PLAN'))
				DROP TABLE #TMP_PLAN	
				
			SELECT *
			INTO #TMP_PLAN
			FROM (
					--수주
					SELECT '10' AS GUBUN
							, S1.COMP_CODE, S1.DIV_CODE
							, '' AS MP_NO
							, '' WKORD_NUM
							, ISNULL(S5.CHILD_ITEM_CODE,'') AS SEMI_ITEM_CODE
							, ISNULL(S5.ITEM_NAME,'') AS SEMI_ITEM_NAME
							, NULL WKORD_Q
							, NULL AS PLAN_Q
							, NULL AS ADD_Q	--추가수량
							, NULL AS PROD_PLAN_Q	--생산계획량
							, NULL WORK_SHOP_CODE
							, S1.ORDER_NUM, S2.SER_NO
							, S1.CUSTOM_CODE, S4.CUSTOM_NAME
							, S2.ITEM_CODE, S3.ITEM_NAME
							, S2.ORDER_UNIT_Q AS ORDER_UNIT_Q, S2.ORDER_UNIT_Q - S2.OUTSTOCK_Q * S2.TRANS_RATE AS NOT_ISSUE_Q
							, 0 AS GOOD_STOCK_Q
							, 0 AS SAFE_STOCK_Q
							, S1.ORDER_DATE, S2.DVRY_DATE
							, S6.PRODT_PLAN_DATE -- NEW ADD
					FROM SOF100T S1
						 INNER JOIN SOF110T S2 ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.DIV_CODE AND S1.ORDER_NUM=S2.ORDER_NUM
						 INNER JOIN BPR200T S3 ON S2.COMP_CODE=S3.COMP_CODE AND S2.DIV_CODE=S3.DIV_CODE AND S2.ITEM_CODE=S3.ITEM_CODE
						 LEFT  JOIN BCM100T S4 ON S1.COMP_CODE=S4.COMP_CODE AND S1.CUSTOM_CODE=S4.CUSTOM_CODE
						 LEFT  JOIN (
									SELECT K1.COMP_CODE, K1.DIV_CODE, K1.PROD_ITEM_CODE, K1.CHILD_ITEM_CODE, K2.ITEM_NAME
								    FROM BPR500T K1 WITH (NOLOCK)
									 	 INNER JOIN BPR200T K2 WITH (NOLOCK) ON K1.COMP_CODE=K2.COMP_CODE AND K1.DIV_CODE=K2.DIV_CODE AND K1.CHILD_ITEM_CODE=K2.ITEM_CODE
								    WHERE K1.COMP_CODE=@COMP_C0DE
									AND K1.DIV_CODE=@DIV_CODE
									AND K2.ITEM_ACCOUNT='20'		
									AND K1.BOM_YN = '1'	 
									) S5 ON S2.COMP_CODE=S5.COMP_CODE AND S5.DIV_CODE=S2.DIV_CODE AND S5.PROD_ITEM_CODE=S2.ITEM_CODE
						 LEFT  JOIN (
									--수주대비 작업지시완료(마감)된 수주는 제외
									SELECT S1.COMP_CODE, S1.DIV_CODE, S1.ORDER_NUM, S1.SEQ, S1.ITEM_CODE
									, S1.PRODT_PLAN_DATE -- NEW ADD
									FROM PPL100T S1 WITH (NOLOCK)
										 INNER JOIN PMP100T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.DIV_CODE AND S1.WK_PLAN_NUM=S2.WK_PLAN_NUM 
									WHERE S1.COMP_CODE=@COMP_C0DE
									AND S1.DIV_CODE=@DIV_CODE
									AND ISNULL(S1.ORDER_NUM,'') &lt;&gt; ''
									AND S2.WKORD_STATUS IN ('80','90')						 
									) S6 ON S2.COMP_CODE=S6.COMP_CODE AND S6.DIV_CODE=S2.DIV_CODE AND S6.ORDER_NUM=S2.ORDER_NUM AND S6.SEQ=S2.SER_NO									
					WHERE S1.COMP_CODE=@COMP_C0DE
					AND S1.DIV_CODE=@DIV_CODE
					AND S3.ITEM_ACCOUNT='10'
					AND ISNULL(S2.ORDER_Q, 0) - ISNULL(S2.ISSUE_REQ_Q, 0) &gt; 0
		      AND S2.ORDER_STATUS &lt;&gt; 'Y'  --강제마감여부

        <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_FR)">
				  AND S2.DVRY_DATE &gt;= #{ISSUE_DATE_FR}
        </if> 				  
        <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_TO)">
  				AND S2.DVRY_DATE &lt;= #{ISSUE_DATE_TO}
        </if> 
    			AND S6.COMP_CODE IS NULL
			    UNION ALL
					SELECT '15' AS GUBUN
							, S1.COMP_CODE
							, S1.DIV_CODE
							, NULL AS MP_NO
							, S1.WK_PLAN_NUM AS WKORD_NUM
							, CASE WHEN S2.ITEM_ACCOUNT = '10' THEN ISNULL(S3.CHILD_ITEM_CODE,'') ELSE S1.ITEM_CODE END AS SEMI_ITEM_CODE
							, CASE WHEN S2.ITEM_ACCOUNT = '10' THEN ISNULL(S3.CHILD_ITEM_NAME,'') ELSE S2.ITEM_NAME END AS SEMI_ITEM_NAME
							, S1.WK_PLAN_Q AS WKORD_Q
							, NULL AS PLAN_Q
							, NULL AS ADD_Q	--추가수량
							, NULL AS PROD_PLAN_Q	--생산계획량
							, S1.WORK_SHOP_CODE
							, NULL AS ORDER_NUM, NULL AS SER_NO
							, NULL AS  CUSTOM_CODE, NULL AS CUSTOM_NAME
--							, (SELECT MIN(PROD_ITEM_CODE) FROM BPR500T WHERE COMP_CODE=S1.COMP_CODE AND DIV_CODE=S1.DIV_CODE AND CHILD_ITEM_CODE=S1.ITEM_CODE) AS ITEM_CODE
              , S1.ITEM_CODE
							, S2.ITEM_NAME
							, NULL AS ORDER_UNIT_Q
							, NULL AS NOT_ISSUE_Q
							, 0 AS GOOD_STOCK_Q
							, 0 AS SAFE_STOCK_Q
							, S1.PRODT_PLAN_DATE AS ORDER_DATE
							, NULL AS DVRY_DATE
							, S1.PRODT_PLAN_DATE --NEW ADD
					FROM PPL100T S1 WITH (NOLOCK)
						 INNER JOIN BPR200T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.DIV_CODE AND S1.ITEM_CODE=S2.ITEM_CODE
  						LEFT JOIN (
  									SELECT S1.COMP_CODE, S1.DIV_CODE, S1.PROD_ITEM_CODE, S1.CHILD_ITEM_CODE, S2.ITEM_NAME AS CHILD_ITEM_NAME
  									FROM BPR500T S1 WITH (NOLOCK)
  										INNER JOIN BPR200T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.DIV_CODE AND S1.CHILD_ITEM_CODE=S2.ITEM_CODE
  									WHERE S1.COMP_CODE=@COMP_C0DE
  									AND S1.DIV_CODE=@DIV_CODE
  										AND S2.ITEM_ACCOUNT='20'
  						) S3 ON S3.COMP_CODE=S1.COMP_CODE AND S3.DIV_CODE=S1.DIV_CODE AND s3.PROD_ITEM_CODE=S1.ITEM_CODE						 
					WHERE S1.COMP_CODE = @COMP_C0DE
					AND S1.DIV_CODE = @DIV_CODE
--					AND S2.ITEM_ACCOUNT='20'
					AND WKORD_YN = 'N'
					AND S1.WORK_SHOP_CODE IN (SELECT TREE_CODE FROM BSA230T WHERE COMP_CODE=S1.COMP_CODE AND TYPE_LEVEL=S1.DIV_CODE AND TREE_CODE=S1.WORK_SHOP_CODE AND GROUP_CD='1')


					UNION ALL
			
					SELECT  '20' AS GUBUN
							, S1.COMP_CODE
							, S1.DIV_CODE
							, (SELECT TOP 1 EQUIP_CODE FROM PMP100T WITH (NOLOCK) WHERE COMP_CODE=S1.COMP_CODE AND DIV_CODE=S1.DIV_CODE AND WKORD_NUM=S1.WKORD_NUM AND WORK_SHOP_CODE=S1.WORK_SHOP_CODE AND PROG_WORK_CODE='P10') AS MP_NO
							, S1.WKORD_NUM
							, S1.ITEM_CODE AS SEMI_ITEM_CODE
							, ISNULL(S2.ITEM_NAME,'') AS SEMI_ITEM_NAME
							, S1.WKORD_Q AS WKORD_Q
							, NULL AS PLAN_Q
							, NULL AS ADD_Q	--추가수량
							, NULL AS PROD_PLAN_Q	--생산계획량
							, S1.WORK_SHOP_CODE
							, NULL AS ORDER_NUM, NULL AS SER_NO
							, NULL AS  CUSTOM_CODE, NULL AS CUSTOM_NAME
							, (SELECT MIN(PROD_ITEM_CODE) FROM BPR500T WHERE COMP_CODE=S1.COMP_CODE AND DIV_CODE=S1.DIV_CODE AND CHILD_ITEM_CODE=S1.ITEM_CODE) AS ITEM_CODE
							, S2.ITEM_NAME
							, NULL AS ORDER_UNIT_Q
							, NULL AS NOT_ISSUE_Q							
--							, S1.WKORD_Q AS ORDER_UNIT_Q
--							, S1.WKORD_Q - S1.PRODT_Q AS NOT_ISSUE_Q
							, 0 AS GOOD_STOCK_Q
							, 0 AS SAFE_STOCK_Q
							, S1.PRODT_START_DATE AS ORDER_DATE
							, S1.PRODT_END_DATE AS DVRY_DATE
							, NULL AS PRODT_PLAN_DATE -- NEW ADD
					FROM PMP100T S1
						 INNER JOIN BPR200T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.DIV_CODE AND S1.ITEM_CODE=S2.ITEM_CODE
					WHERE S1.COMP_CODE = @COMP_C0DE
					AND S1.DIV_CODE = @DIV_CODE
					AND S1.LINE_END_YN='Y'
					AND S2.ITEM_ACCOUNT='20'
					AND S1.WKORD_STATUS NOT IN ('8','9')
					AND S1.WORK_SHOP_CODE IN (SELECT TREE_CODE FROM BSA230T WHERE COMP_CODE=S1.COMP_CODE AND TYPE_LEVEL=S1.DIV_CODE AND TREE_CODE=S1.WORK_SHOP_CODE AND GROUP_CD='1')
			
					UNION ALL
					SELECT '30' AS GUBUN
							, S1.COMP_CODE
							, S1.DIV_CODE
							, '' AS MP_NO
							, '' WKORD_NUM
							, S1.ITEM_CODE AS SEMI_ITEM_CODE
							, S1.ITEM_NAME AS SEMI_ITEM_NAME
							, NULL AS WKORD_Q
							, NULL AS PLAN_Q
							, NULL AS ADD_Q	--추가수량
							, NULL AS PROD_PLAN_Q	--생산계획량
							, S1.WORK_SHOP_CODE
							, NULL AS ORDER_NUM, NULL AS SER_NO
							, NULL AS  CUSTOM_CODE, NULL AS CUSTOM_NAME
							, (SELECT MIN(PROD_ITEM_CODE) FROM BPR500T WHERE COMP_CODE=S1.COMP_CODE AND DIV_CODE=S1.DIV_CODE AND CHILD_ITEM_CODE=S1.ITEM_CODE) AS ITEM_CODE
							, S1.ITEM_NAME
							, 0 AS ORDER_UNIT_Q
							, 0 AS NOT_ISSUE_Q
							, 0 AS GOOD_STOCK_Q
							, SAFE_STOCK_Q
							, '' AS ORDER_DATE
							, '' AS DVRY_DATE
							, NULL AS PRODT_PLAN_DATE -- NEW ADD
					FROM BPR200T S1 WITH (NOLOCK)
					WHERE ITEM_ACCOUNT='20'
					AND ISNULL(SAFE_STOCK_Q,0) &gt; 0
					
				) X
			WHERE ISNULL(X.SEMI_ITEM_CODE,'')  &lt;&gt;  ''
			<if test="@foren.Ognl@isNotEmpty(SEMI_ITEM_CODE)">
			AND ISNULL(X.SEMI_ITEM_CODE,'') = @SEMI_ITEM_CODE  --반제품조건
			</if>
			
			UPDATE A SET ITEM_NAME		= M1.ITEM_NAME
			FROM #TMP_PLAN A
				 INNER JOIN BPR100T M1 ON A.COMP_CODE=M1.COMP_CODE AND A.ITEM_CODE=M1.ITEM_CODE
				 
				 			
			INSERT INTO #TMP_PLAN (GUBUN, COMP_CODE, DIV_CODE, MP_NO, WKORD_NUM, SEMI_ITEM_CODE, SEMI_ITEM_NAME, WKORD_Q, PLAN_Q, ADD_Q, PROD_PLAN_Q, WORK_SHOP_CODE
									, ORDER_NUM, SER_NO, CUSTOM_CODE, CUSTOM_NAME, ITEM_CODE, ITEM_NAME, ORDER_UNIT_Q, NOT_ISSUE_Q
									, GOOD_STOCK_Q, SAFE_STOCK_Q
									, ORDER_DATE, DVRY_DATE, PRODT_PLAN_DATE)
			
			SELECT '90' GUBUN, COMP_CODE, DIV_CODE, '' MP_NO, '' WKORD_NUM, SEMI_ITEM_CODE, SEMI_ITEM_NAME, SUM(ISNULL(WKORD_Q,0)), 0 PLAN_Q, 0 ADD_Q, 0 PROD_PLAN_Q, '' WORK_SHOP_CODE
									, '' ORDER_NUM, NULL SER_NO, '' CUSTOM_CODE, '' CUSTOM_NAME, ITEM_CODE,  ITEM_NAME, SUM(ORDER_UNIT_Q), SUM(NOT_ISSUE_Q)
									, 0 GOOD_STOCK_Q, 0 SAFE_STOCK_Q
									, '' ORDER_DATE, '' DVRY_DATE, '' PRODT_PLAN_DATE
			FROM #TMP_PLAN
			GROUP BY COMP_CODE, DIV_CODE, SEMI_ITEM_CODE, SEMI_ITEM_NAME, ITEM_CODE,  ITEM_NAME
			ORDER BY SEMI_ITEM_CODE
			
			DECLARE @PLAN_Q NUMERIC(30,6)
			UPDATE A SET @PLAN_Q = (ORDER_UNIT_Q + ISNULL(B.SAFE_STOCK_Q,0)) -  (WKORD_Q+ISNULL(C.GOOD_STOCK_Q,0))
						, SAFE_STOCK_Q=ISNULL(B.SAFE_STOCK_Q,0)
						, GOOD_STOCK_Q=ISNULL(C.GOOD_STOCK_Q,0)
						, PLAN_Q		= CASE WHEN @PLAN_Q  &lt; 0 THEN 0 ELSE @PLAN_Q END
						, PROD_PLAN_Q	= CASE WHEN @PLAN_Q &lt; 0 THEN 0 ELSE @PLAN_Q END
			FROM #TMP_PLAN A
				 INNER JOIN BPR200T B ON A.COMP_CODE=B.COMP_CODE AND A.DIV_CODE=B.DIV_CODE AND A.SEMI_ITEM_CODE=B.ITEM_CODE
				 LEFT  JOIN (
								SELECT S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE, SUM(S1.GOOD_STOCK_Q-ISNULL(S3.ISSUE_REQ_QTY,0)) AS GOOD_STOCK_Q
								FROM BIV100T S1
									 INNER JOIN BSA220T S2 ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.TYPE_LEVEL AND S1.WH_CODE=S2.TREE_CODE
									 LEFT  JOIN (
													SELECT A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE, SUM((A.ISSUE_REQ_QTY-A.ISSUE_QTY)*A.TRANS_RATE) AS ISSUE_REQ_QTY
													FROM SRQ100T A WITH (NOLOCK)
															INNER JOIN SOF110T B WITH (NOLOCK) ON A.COMP_CODE=B.COMP_CODE AND A.DIV_CODE=B.DIV_CODE AND A.ORDER_NUM=B.ORDER_NUM AND A.SER_NO=B.SER_NO
													WHERE A.COMP_CODE=@COMP_C0DE
													AND A.DIV_CODE=@DIV_CODE
													AND B.ORDER_STATUS='N'
													AND A.ISSUE_REQ_QTY != A.ISSUE_QTY
													GROUP BY A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE
												) S3 ON S1.COMP_CODE=S3.COMP_CODE AND S1.DIV_CODE=S3.DIV_CODE AND S1.WH_CODE=S3.WH_CODE AND S1.ITEM_CODE=S3.ITEM_CODE									 
								WHERE S1.COMP_CODE=@COMP_C0DE
								AND S1.DIV_CODE=@DIV_CODE
								--AND S2.PABSTOCK_YN = 'Y'
								GROUP BY S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE	 
				 
				 ) C ON A.COMP_CODE=C.COMP_CODE AND A.DIV_CODE=C.DIV_CODE AND A.ITEM_CODE=C.ITEM_CODE
			WHERE 1=1 
			AND A.GUBUN='90'
			
			<if test="WK_PLAN_MORE_0 == &quot;on&quot;"> 
			--생산계획수량 > 0 것만 조회시
			DELETE A
			FROM	#TMP_PLAN A
					INNER JOIN (
								SELECT * 
								FROM #TMP_PLAN  
								WHERE PROD_PLAN_Q &lt;= 0		
					) B ON A.COMP_CODE=B.COMP_CODE AND A.DIV_CODE=B.DIV_CODE AND A.SEMI_ITEM_CODE=B.SEMI_ITEM_CODE AND A.ITEM_CODE=B.ITEM_CODE
			</if>		
								
			SELECT GUBUN
				, CASE GUBUN  WHEN '10' THEN '수주'
        				WHEN '15' THEN '생산계획'
							  WHEN '20' THEN '작지'
							  WHEN '30' THEN '안전재고'
							  WHEN '90' THEN ''
				  END AS GUBUN_NAME
				, MP_NO, WKORD_NUM, SEMI_ITEM_CODE, SEMI_ITEM_NAME, WKORD_Q, PLAN_Q, ADD_Q, PROD_PLAN_Q, WORK_SHOP_CODE
				, ORDER_NUM, SER_NO, CUSTOM_CODE, CUSTOM_NAME, ITEM_CODE, ITEM_NAME, ORDER_UNIT_Q, NOT_ISSUE_Q
				, GOOD_STOCK_Q, SAFE_STOCK_Q
				, ORDER_DATE, DVRY_DATE, PRODT_PLAN_DATE
			FROM #TMP_PLAN A
			<if test="GUBUN_90 == &quot;on&quot;"> 
			WHERE GUBUN = '90'
			</if>	
			ORDER BY SEMI_ITEM_CODE, ITEM_CODE, GUBUN
			

                   
                    
       
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

	<insert id="s_ppl100ukrv_inServiceImpl.insertDetail" parameterType="Map">

	    DECLARE @workPlanNum            NVARCHAR(20)            -- 발주예정정보
					     , @todayDate      NVARCHAR(8)
		SET  @todayDate = CONVERT(NVARCHAR(8), GETDATE(), 112)
	          
		EXEC SP_GetAutoNumComp #{S_COMP_CODE}, #{S_DIV_CODE}, 'PPL100T', 'P', @todayDate, '1', @workPlanNum OUTPUT 
		
		INSERT INTO PPL100T(
					COMP_CODE					, DIV_CODE								,WK_PLAN_NUM					,WORK_SHOP_CODE					
					,ITEM_CODE
					,WK_PLAN_Q					,PRODT_PLAN_DATE				,ORDER_NUM							,SEQ
					,ORDER_Q						,AGREE_STATUS						,WKORD_YN								,PRODT_Q
					,WORK_END_YN			,PLAN_TYPE							,PROJECT_NO								,REMARK
					,CAPA_OVER_FLAG		,HFG_FLAG								,SCHEDULE_SEQ							,STD_CAPACITY
					,STAN_PRODT_Q			,LOT_SIZING_Q						
					,INSERT_DB_USER			,INSERT_DB_TIME					,UPDATE_DB_USER					,UPDATE_DB_TIME	
		)VALUES(
					#{S_COMP_CODE}     	,#{S_DIV_CODE}						,@workPlanNum   				,#{WORK_SHOP_CODE} 
					,#{SAVE_ITEM_CODE}
					,#{PROD_PLAN_Q} 		, #{PRODT_PLAN_DATE}		,#{ORDER_NUM}					,#{SER_NO}  
					,#{ORDER_Q}  				,'2'											,'N'											,'0.00000'
					,'N'									,''											,''												,''
					,'N'									,'N'											,'0'											,'0.000000'
					,'0.000000'						,'0.000000'								
					, #{S_USER_ID}			    , GETDATE()  						    , #{S_USER_ID}					    , GETDATE()
		)
		           
	</insert>

</mapper>
