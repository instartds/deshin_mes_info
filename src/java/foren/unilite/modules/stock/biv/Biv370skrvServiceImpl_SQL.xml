<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="biv370skrvServiceImpl">
	
	<select id="biv370skrvServiceImpl.selectMaster" parameterType="Map" resultType="rMap">		/* LOT별 */
	   BEGIN

SET NOCOUNT ON
SET ARITHABORT ON	

  SELECT * INTO #TEMP_STOCK
  FROM
  (
  SELECT A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE, B.PURCHASE_CUSTOM_CODE
				  ,B.PURCHASE_P, B.PURCHASE_RATE, B.PURCHASE_TYPE, B.SALES_TYPE, A.STOCK_Q AS STOCK_Q
				 FROM BIV150T A WITH(NOLOCK)
				 LEFT JOIN BIV350T B WITH(NOLOCK) ON A.COMP_CODE= B.COMP_CODE
												 AND A.DIV_CODE	= B.DIV_CODE
												 AND A.LOT_NO 	= B.LOT_NO
												 AND A.WH_CODE 	= B.WH_CODE
												 AND A.ITEM_CODE= B.ITEM_CODE
				WHERE A.COMP_CODE = #{S_COMP_CODE}
				  AND A.DIV_CODE  = #{DIV_CODE}												 
				 UNION ALL
				 SELECT A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE, A.PURCHASE_CUSTOM_CODE
				 ,A.PURCHASE_P, A.PURCHASE_RATE, A.PURCHASE_TYPE, A.SALES_TYPE, A.STOCK_Q AS STOCK_Q
				 FROM UNILITE.VGetDailyStock A WITH(NOLOCK)
					WHERE A.COMP_CODE = #{S_COMP_CODE}
					  AND A.DIV_CODE  = #{DIV_CODE}		 
  ) A

			SELECT
			 A.DIV_CODE
			,A.WH_CODE
			,A.ITEM_CODE
			,C.ITEM_NAME
			,A.PURCHASE_CUSTOM_CODE AS CUSTOM_CODE
			,D.CUSTOM_NAME
			,A.PURCHASE_TYPE
			,A.SALES_TYPE
			,C.SALE_BASIS_P
			,A.PURCHASE_P
			,A.PURCHASE_RATE
			,SUM(A.STOCK_Q) 					AS GOOD_STOCK_Q
			,SUM(A.PURCHASE_P * A.STOCK_Q) 		AS STOCK_COST
			FROM #TEMP_STOCK A
			INNER JOIN (	SELECT A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE
								FROM #TEMP_STOCK A WITH(NOLOCK)
								GROUP BY A.COMP_CODE, A.DIV_CODE, A.WH_CODE, A.ITEM_CODE
								HAVING MIN(A.PURCHASE_P) != MAX(A.PURCHASE_P)
								 )A1 ON A1.COMP_CODE = A.COMP_CODE 
									AND A1.DIV_CODE = A.DIV_CODE 
									AND A1.WH_CODE = A.WH_CODE
									AND A1.ITEM_CODE = A.ITEM_CODE
				INNER JOIN BPR100T  C  WITH(NOLOCK) ON A.COMP_CODE  = C.COMP_CODE 
												   AND A.ITEM_CODE = C.ITEM_CODE
												   AND ISNULL(C.STOCK_CARE_YN,'N') = 'Y'                                      /* 2015.10.02 추가 */
				INNER JOIN BCM100T  D  WITH(NOLOCK) ON A.COMP_CODE  = D.COMP_CODE 
												   AND A.PURCHASE_CUSTOM_CODE = D.CUSTOM_CODE
				LEFT  JOIN BSA210T  E  WITH(NOLOCK)ON A.COMP_CODE = E.COMP_CODE 
													AND A.DIV_CODE = E.TYPE_LEVEL 
													AND A.WH_CODE = E.WH_CODE	
			
			WHERE A.COMP_CODE = #{S_COMP_CODE}
			  AND A.DIV_CODE  = #{DIV_CODE}
			  
			   <if test="@foren.Ognl@isNotEmpty(DEPT_CODE)">
			   AND   E.TREE_LEVEL LIKE (SELECT TREE_LEVEL FROM BSA210T WITH(NOLOCK) WHERE COMP_CODE = E.COMP_CODE AND TYPE_LEVEL=E.TYPE_LEVEL AND TREE_CODE = #{DEPT_CODE}) + '%'
			   </if>			   
			   <if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL1)">
			   AND C.ITEM_LEVEL1 = #{ITEM_LEVEL1}	
			   </if>			   
			   <if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL2)">
			   AND C.ITEM_LEVEL2 = #{ITEM_LEVEL2}
			   </if>			   
			   <if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL3)">
			   AND C.ITEM_LEVEL3 = #{ITEM_LEVEL3}	
			   </if>			   
			   <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">
			   AND D.CUSTOM_CODE = #{CUSTOM_CODE}
			   </if>			   
			   <if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
			   AND C.ITEM_CODE = #{ITEM_CODE}	
			   </if>
			  
			GROUP BY A.WH_CODE, A.ITEM_CODE, C.ITEM_NAME, A.PURCHASE_CUSTOM_CODE, D.CUSTOM_NAME, A.PURCHASE_TYPE, A.SALES_TYPE, C.SALE_BASIS_P, A.PURCHASE_P, A.PURCHASE_RATE, A.DIV_CODE
			ORDER BY A.ITEM_CODE, A.PURCHASE_CUSTOM_CODE
			
			DROP TABLE #TEMP_STOCK

			SET ARITHABORT OFF
			SET NOCOUNT OFF

		END 
		  
	</select>
</mapper>