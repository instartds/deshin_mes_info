<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hat510ukrServiceImpl">

	<select id="hat510ukrServiceImpl.getDutyRule" parameterType="String" resultType="String">
	/* hat510ukrServiceImpl.getDutyRule */
	SELECT DUTY_INPUT_RULE
      FROM HBS400T
     WHERE COMP_CODE = #{S_COMP_CODE}
	</select>
    
    <select id="hat510ukrServiceImpl.getDutycodeTime" parameterType="rMap" resultType="rMap">
    /* hat510ukrServiceImpl.getDutycodeTime */
    SELECT
    	   CASE WHEN A.DUTY_FR_D = 1 THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, CONVERT(DATETIME, #{DUTY_YYYYMMDD}, 112)), 112)
		        WHEN A.DUTY_FR_D = 3 THEN CONVERT(NVARCHAR(8), DATEADD(DAY,  1, CONVERT(DATETIME, #{DUTY_YYYYMMDD}, 112)), 112)
				ELSE #{DUTY_YYYYMMDD}
		    END AS DUTY_FR_D
    	 , RIGHT('00'+CONVERT(NVARCHAR(2), A.DUTY_FR_H), 2) AS DUTY_FR_H
	     , RIGHT('00'+CONVERT(NVARCHAR(2), A.DUTY_FR_M), 2) AS DUTY_FR_M
	     , CASE WHEN A.DUTY_TO_D = 1 THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, CONVERT(DATETIME, #{DUTY_YYYYMMDD}, 112)), 112)
		        WHEN A.DUTY_TO_D = 3 THEN CONVERT(NVARCHAR(8), DATEADD(DAY,  1, CONVERT(DATETIME, #{DUTY_YYYYMMDD}, 112)), 112)
				ELSE #{DUTY_YYYYMMDD}
		    END AS DUTY_TO_D
	     , RIGHT('00'+CONVERT(NVARCHAR(2), A.DUTY_TO_H), 2) AS DUTY_TO_H
	     , RIGHT('00'+CONVERT(NVARCHAR(2), A.DUTY_TO_M), 2) AS DUTY_TO_M
	  FROM       HAT100T A WITH(NOLOCK)
	  INNER JOIN HBS600T B WITH (NOLOCK)  ON B.CAL_DATE = #{DUTY_YYYYMMDD}
										 AND B.HOLY_TYPE = A.HOLY_TYPE
	 WHERE A.COMP_CODE = #{S_COMP_CODE}
	   AND A.WORK_TEAM = #{WORK_TEAM}
    </select>
    
	<select id="hat510ukrServiceImpl.getPostName" parameterType="rMap" resultType="rMap">
	/* hat510ukrServiceImpl.getPostName */
	SELECT CODE_NAME AS POST_NAME
	FROM BSA100T AS B
    WHERE COMP_CODE = #{S_COMP_CODE}
  		AND MAIN_CODE = 'H005'
  		AND SUB_CODE = #{POST_CODE}
	</select>

	<select id="hat510ukrServiceImpl.getDutycode" parameterType="rMap" resultType="rMap">
	/* hat510ukrServiceImpl.getDutyCode */
	SELECT B.SUB_CODE
          , B.CODE_NAME
       FROM HBS100T A
                    INNER JOIN BSA100T B
                            ON A.COMP_CODE = B.COMP_CODE
                           AND A.DUTY_CODE = B.SUB_CODE
      WHERE A.COMP_CODE = #{S_COMP_CODE}
        AND B.MAIN_CODE = 'H033'
        AND B.SUB_CODE &lt;&gt; '$'
        AND A.PAY_CODE  = #{PAY_CODE}
        <if test='DUTY_RULE.equals("Y")'>
		AND A.COTR_TYPE = '2'
		</if>
		<if test='DUTY_RULE.equals("N")'>
		AND A.COTR_TYPE = '1'
		</if>
    ORDER BY B.REF_CODE2, B.SUB_CODE
	</select>

	<select id="hat510ukrServiceImpl.getComboList" parameterType="rMap" resultType="rMap">
		/* hat510ukrServiceImpl.getComboList */
		SELECT B.SUB_CODE
	         , B.CODE_NAME
	      FROM HBS100T A
	                   INNER JOIN BSA100T B
	                           ON A.COMP_CODE = B.COMP_CODE
	                          AND A.DUTY_CODE = B.SUB_CODE
	     WHERE A.COMP_CODE = #{S_COMP_CODE}
	       AND B.MAIN_CODE = 'H033'
	       AND B.USE_YN = 'Y'
	       AND B.SUB_CODE &lt;&gt; '$'
	       <if test="@foren.Ognl@isNotEmpty(PAY_CODE)">
	       AND A.PAY_CODE  = #{PAY_CODE}
	       </if>
	       AND A.COTR_TYPE = '2'
	     ORDER BY B.REF_CODE2, B.SUB_CODE
	</select>

	<select id="hat510ukrServiceImpl.selectList" parameterType="Map" resultType="rMap">
	/* hat510ukrServiceImpl.selectList */
	DECLARE @SUB_CODE  NVARCHAR(1),
			@STRT_DT   VARCHAR(8),
			@END_DT    VARCHAR(8),
			@STRT_DT_Q VARCHAR(8),
			@END_DT_Q  VARCHAR(8),
			@REF_CODE1 NVARCHAR(2),
			@JOIN_DATE  VARCHAR(8),
			@RETR_DATE  VARCHAR(8),
            @PRE_WORKTEAM NVARCHAR(10)
            
	SET @JOIN_DATE = REPLACE(#{JOIN_DATE},'.','')
	SET @RETR_DATE = REPLACE(#{RETR_DATE},'.','')

	SELECT @SUB_CODE = F.SUB_CODE
         , @STRT_DT = CONVERT(VARCHAR(8), CASE F.REF_CODE1 WHEN '00' THEN CONVERT(DATETIME, #{DUTY_YYYYMMDD} + '01')
                                                ELSE DATEADD(DAY, 1, DATEADD(MONTH, -1, CONVERT(DATETIME, #{DUTY_YYYYMMDD} + F.REF_CODE1)))
                                                END, 112)
         , @END_DT = CONVERT(VARCHAR(8), CASE F.REF_CODE1 WHEN '00' THEN DATEADD(DAY, -1, DATEADD(MONTH, 1, CONVERT(DATETIME, #{DUTY_YYYYMMDD} + '01')))
                                                ELSE CONVERT(DATETIME, #{DUTY_YYYYMMDD} + F.REF_CODE1)
                                                END, 112)
         , @REF_CODE1 = F.REF_CODE1
      FROM BSA100T F
     WHERE F.COMP_CODE = #{S_COMP_CODE}
       AND F.MAIN_CODE = 'H031'
       AND F.SUB_CODE &lt;&gt; '$'
       AND F.SUB_CODE  = #{PAY_PROV_FLAG}

    IF @JOIN_DATE &gt; @STRT_DT
    	BEGIN
    	SET @STRT_DT_Q = @JOIN_DATE
    	END
	ELSE
		BEGIN
		SET @STRT_DT_Q = @STRT_DT
		END

	IF @RETR_DATE &lt;&gt; '' AND @RETR_DATE &lt;&gt; '00000000' AND @RETR_DATE &lt; @END_DT
    	BEGIN
    	SET @END_DT_Q = @RETR_DATE
    	END
	ELSE
		BEGIN
		SET @END_DT_Q = @END_DT
		END

	IF @JOIN_DATE &gt; @END_DT
		BEGIN
		SET @STRT_DT_Q = 'kk'
		END

	IF @RETR_DATE &lt;&gt; '' AND @RETR_DATE &lt;&gt; '00000000'
    	BEGIN
		IF @RETR_DATE &lt; @STRT_DT
			BEGIN
			SET @END_DT_Q = 'kk'
			END
    	END
    SELECT @PRE_WORKTEAM =  WORK_TEAM
      FROM HAT400T 
     WHERE PERSON_NUMB = #{PERSON_NUMB}
       AND DUTY_YYYYMMDD = (SELECT CONVERT(NVARCHAR(8),DATEADD(MONTH,0,GETDATE())-DAY(GETDATE()),112))
       
	<if test='DUTY_RULE.equals("Y")'>
	IF @STRT_DT_Q &lt;&gt; 'kk' AND @END_DT_Q &lt;&gt; 'kk'
		BEGIN
		SELECT AAA.FLAG 
              ,AAA.PAY_CODE
              ,AAA.DUTY_YYYYMMDD
              ,AAA.WORK_TEAM
              ,AAA.HOLY_TYPE
              ,AAA.DEPT_NAME
              ,AAA.POST_CODE
              ,AAA.NAME
              ,AAA.PERSON_NUMB
              ,AAA.DUTY_CODE
              ,SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          ELSE CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                     END
                                               FROM HAT100T
                                              WHERE COMP_CODE = BBB.COMP_CODE
                                                AND WORK_TEAM = BBB.WORK_TEAM
                                                AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 1, 4) + '-' +
               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          ELSE  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                     END
                                                FROM HAT100T
                                               WHERE COMP_CODE = BBB.COMP_CODE
                                                 AND WORK_TEAM = BBB.WORK_TEAM
                                                 AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 5, 2) + '-' +
               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          ELSE CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                      END
                                                FROM HAT100T
                                               WHERE COMP_CODE = BBB.COMP_CODE
                                                 AND WORK_TEAM = BBB.WORK_TEAM
                                                 AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 7, 2) AS DUTY_FR_D
              ,RIGHT('0' + CONVERT(NVARCHAR,ISNULL(AAA.DUTY_FR_H,ISNULL(BBB.DUTY_FR_H,'00'))),2) AS DUTY_FR_H
              ,RIGHT('0' + CONVERT(NVARCHAR,ISNULL(AAA.DUTY_FR_M,ISNULL(BBB.DUTY_FR_M,'00'))),2) AS DUTY_FR_M
              ,SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD) )
                                                          ELSE CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                      END
                                                FROM HAT100T
                                               WHERE COMP_CODE = BBB.COMP_CODE
                                                 AND WORK_TEAM = BBB.WORK_TEAM
                                                 AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 1, 4) + '-' +
               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD) )
                                                          ELSE CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                      END
                                                FROM HAT100T
                                               WHERE COMP_CODE = BBB.COMP_CODE
                                                 AND WORK_TEAM = BBB.WORK_TEAM
                                                 AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 5, 2) + '-' +
               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD))
                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, AAA.DUTY_YYYYMMDD) )
                                                          ELSE CONVERT(DATETIME, AAA.DUTY_YYYYMMDD)
                                                      END
                                                FROM HAT100T
                                               WHERE COMP_CODE = BBB.COMP_CODE
                                                 AND WORK_TEAM = BBB.WORK_TEAM
                                                 AND HOLY_TYPE = BBB.HOLY_TYPE), 112), 7, 2) AS DUTY_TO_D
               ,RIGHT('0' + CONVERT(NVARCHAR,ISNULL(AAA.DUTY_TO_H,ISNULL(BBB.DUTY_TO_H,'00'))),2) AS DUTY_TO_H
               ,RIGHT('0' + CONVERT(NVARCHAR,ISNULL(AAA.DUTY_TO_M,ISNULL(BBB.DUTY_TO_M,'00'))),2) AS DUTY_TO_M
        FROM
    		(SELECT ISNULL(T.FLAG, 'Y') AS FLAG
                 , ISNULL(T.PAY_CODE, BB.PAY_CODE) AS PAY_CODE
                 , ISNULL(T.DUTY_YYYYMMDD, SUBSTRING(AA.CAL_DATE,1,4) + '-' + SUBSTRING(AA.CAL_DATE,5,2) + '-' + SUBSTRING(AA.CAL_DATE,7,2)) AS DUTY_YYYYMMDD
                 , CASE WHEN T.WORK_TEAM IS NULL THEN
                        CASE WHEN  LAG(T.WORK_TEAM,1,1) OVER (ORDER BY AA.CAL_DATE) IS NULL THEN  ISNULL(ISNULL((SELECT WORK_TEAM 
                                                                                                                   FROM HAT400T       
                                                                                                                  WHERE PERSON_NUMB = #{PERSON_NUMB}
                                                                                                                    AND DUTY_YYYYMMDD BETWEEN @STRT_DT AND @END_DT
                                                                                                                    AND DUTY_YYYYMMDD = ( SELECT MAX(DUTY_YYYYMMDD)
                                                                                                                                            FROM HAT400T 
                                                                                                                                           WHERE PERSON_NUMB = #{PERSON_NUMB}
                                                                                                                                             AND DUTY_YYYYMMDD BETWEEN @STRT_DT AND @END_DT
                                                                                                                                             AND DUTY_YYYYMMDD &lt;= AA.CAL_DATE
                                                                                                                                             AND ISNULL(WORK_TEAM, '') != '') ), @PRE_WORKTEAM ),'1')
                             ELSE  LAG(T.WORK_TEAM,1,ISNULL(@PRE_WORKTEAM,'1')) OVER (ORDER BY AA.CAL_DATE)
                        END      
                    ELSE T.WORK_TEAM END AS WORK_TEAM
                 , ISNULL(T.HOLY_TYPE, (SELECT HOLY_TYPE
                          FROM HBS600T
                         WHERE COMP_CODE = #{S_COMP_CODE}
                           AND DIV_CODE  = #{DIV_CODE}
                           AND CAL_DATE  = AA.CAL_DATE)) AS HOLY_TYPE
                 , ISNULL(T.DEPT_NAME, BB.DEPT_NAME) AS DEPT_NAME
                 , ISNULL(T.POST_CODE, BB.POST_CODE) AS POST_CODE
                 , ISNULL(T.NAME, BB.NAME) AS NAME
                 , ISNULL(T.PERSON_NUMB, BB.PERSON_NUMB) AS PERSON_NUMB
                 , T.DUTY_CODE     
                 , ISNULL(T.DUTY_YYYYMMDD, SUBSTRING(AA.CAL_DATE,1,4) + '-' + SUBSTRING(AA.CAL_DATE,5,2) + '-' + SUBSTRING(AA.CAL_DATE,7,2)) AS DUTY_FR_D    
                 , T.DUTY_FR_H
                 , T.DUTY_FR_M
                 , ISNULL(T.DUTY_YYYYMMDD, SUBSTRING(AA.CAL_DATE,1,4) + '-' + SUBSTRING(AA.CAL_DATE,5,2) + '-' + SUBSTRING(AA.CAL_DATE,7,2)) AS DUTY_TO_D    
                 , T.DUTY_TO_H
                 , T.DUTY_TO_M
    
    		 FROM (SELECT * 
                     FROM HBS600T 
                    WHERE CAL_DATE 
                    BETWEEN @STRT_DT AND @END_DT
                    AND COMP_CODE = #{S_COMP_CODE}
                    AND DIV_CODE = #{DIV_CODE}
                 ) AA LEFT JOIN
    			(SELECT '' AS FLAG, A.PAY_CODE
    		         , SUBSTRING(B.DUTY_YYYYMMDD,1,4) + '-'  + SUBSTRING(B.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(B.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
    			     , B.WORK_TEAM
    		         , (SELECT HOLY_TYPE
    		              FROM HBS600T
    		             WHERE COMP_CODE = A.COMP_CODE
    		               AND DIV_CODE  = A.DIV_CODE
    		               AND CAL_DATE  = B.DUTY_YYYYMMDD) HOLY_TYPE
    		         , A.DEPT_NAME
    		         , A.POST_CODE
    		         , A.NAME
    		         , B.PERSON_NUMB
    		         , B.DUTY_CODE
    		         , SUBSTRING(B.DUTY_FR_D, 1, 4) + '-' + SUBSTRING(B.DUTY_FR_D, 5, 2) + '-' + SUBSTRING(B.DUTY_FR_D, 7, 2) DUTY_FR_D
    			     , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_FR_H), 2) DUTY_FR_H
    		         , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_FR_M), 2) DUTY_FR_M
    		         , SUBSTRING(B.DUTY_TO_D, 1, 4) + '-' + SUBSTRING(B.DUTY_TO_D, 5, 2) + '-' + SUBSTRING(B.DUTY_TO_D, 7, 2) DUTY_TO_D
    			     , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_TO_H), 2) DUTY_TO_H
    		         , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_TO_M), 2) DUTY_TO_M
    		      FROM HUM100T A
    		                   INNER JOIN HAT500T B
    		                           ON A.COMP_CODE   =  B.COMP_CODE
    		                          AND A.PERSON_NUMB =  B.PERSON_NUMB
    		     WHERE B.COMP_CODE       = #{S_COMP_CODE}
    		       AND B.DUTY_YYYYMMDD  &gt;= @STRT_DT_Q
    		       AND B.DUTY_YYYYMMDD  &lt;= @END_DT
    		       AND A.PERSON_NUMB = #{PERSON_NUMB}
    	    	UNION ALL
    	        SELECT 'Y' AS FLAG, A.PAY_CODE
    	             , SUBSTRING(B.DUTY_YYYYMMDD,1,4) + '-'  + SUBSTRING(B.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(B.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
    			     , B.WORK_TEAM
    	             , (SELECT HOLY_TYPE
    	                  FROM HBS600T
    	                 WHERE COMP_CODE = A.COMP_CODE
    	                   AND DIV_CODE  = A.DIV_CODE
    	                   AND CAL_DATE  = B.DUTY_YYYYMMDD) HOLY_TYPE
    	             , A.DEPT_NAME
    	             , A.POST_CODE
    	             , A.NAME
    	             , A.PERSON_NUMB
    	             , '' AS DUTY_CODE
    	             , SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          ELSE CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 1, 4) + '-' +
    	               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          ELSE  CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 5, 2) + '-' +
    	               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_FR_D = 1 THEN DATEADD(DAY,  -1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_FR_D = 3 THEN DATEADD(DAY,  1, CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          ELSE CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 7, 2) AS DUTY_FR_D
    	             , ISNULL((SELECT RIGHT('0' + CONVERT(NVARCHAR,DUTY_FR_H), 2)
    	                         FROM HAT100T
    	                        WHERE COMP_CODE = B.COMP_CODE
    	                          AND WORK_TEAM = B.WORK_TEAM
    	                          AND HOLY_TYPE = C.HOLY_TYPE),'00') AS DUTY_FR_H
    	             , ISNULL((SELECT RIGHT('0' + CONVERT(NVARCHAR,DUTY_FR_M), 2)
    	                         FROM HAT100T
    	                        WHERE COMP_CODE = B.COMP_CODE
    	                          AND WORK_TEAM = B.WORK_TEAM
    	                          AND HOLY_TYPE = C.HOLY_TYPE),'00') AS DUTY_FR_M
    	             , SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD) )
    	                                                          ELSE CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 1, 4) + '-' +
    	               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD) )
    	                                                          ELSE CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 5, 2) + '-' +
    	               SUBSTRING(CONVERT(VARCHAR(8), (SELECT CASE WHEN DUTY_TO_D = 1 THEN DATEADD(DAY,  -1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD))
    	                                                          WHEN DUTY_TO_D = 3 THEN DATEADD(DAY,  1,  CONVERT(DATETIME, B.DUTY_YYYYMMDD) )
    	                                                          ELSE CONVERT(DATETIME, B.DUTY_YYYYMMDD)
    	                                                          END
    	                                                FROM HAT100T
    	                                               WHERE COMP_CODE = B.COMP_CODE
    	                                                 AND WORK_TEAM = B.WORK_TEAM
    	                                                 AND HOLY_TYPE = C.HOLY_TYPE), 112), 7, 2) AS DUTY_TO_D
    	             , ISNULL((SELECT RIGHT('0' + CONVERT(NVARCHAR,DUTY_TO_H), 2)
    	                         FROM HAT100T
    	                        WHERE COMP_CODE = B.COMP_CODE
    	                          AND WORK_TEAM = B.WORK_TEAM
    	                          AND HOLY_TYPE = C.HOLY_TYPE),'00')  AS DUTY_TO_H
    	             , ISNULL((SELECT RIGHT('0' + CONVERT(NVARCHAR,DUTY_TO_M), 2)
    	                         FROM HAT100T
    	                        WHERE COMP_CODE = B.COMP_CODE
    	                          AND WORK_TEAM = B.WORK_TEAM
    	                          AND HOLY_TYPE = C.HOLY_TYPE),'00')  AS DUTY_TO_M
    	          FROM HUM100T A
    	                       INNER JOIN HAT400T B
    	                               ON A.COMP_CODE     = B.COMP_CODE
    	                              AND A.PERSON_NUMB   = B.PERSON_NUMB
    	                       INNER JOIN HBS600T C
    	                               ON A.COMP_CODE     = C.COMP_CODE
    	                              AND A.DIV_CODE      = C.DIV_CODE
    	                              AND B.DUTY_YYYYMMDD = C.CAL_DATE
    	         WHERE A.COMP_CODE      = #{S_COMP_CODE}
    	           AND A.PERSON_NUMB    = #{PERSON_NUMB}
    	           AND B.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
    	           AND B.DUTY_YYYYMMDD &lt;= @END_DT_Q
    	           AND B.DUTY_YYYYMMDD NOT IN (SELECT A.DUTY_YYYYMMDD
    	                                         FROM HAT500T A
    	                                        WHERE A.COMP_CODE      = #{S_COMP_CODE}
    	                                          AND A.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
    	                                          AND A.DUTY_YYYYMMDD &lt;= @END_DT_Q
    	                                          AND A.PERSON_NUMB    = #{PERSON_NUMB})
    
    	           AND B.DUTY_YYYYMMDD NOT IN (SELECT A.DUTY_YYYYMMDD
    	                                         FROM HAT800T A
    	                                        WHERE A.COMP_CODE      = #{S_COMP_CODE}
    	                                          AND A.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
    	                                          AND A.DUTY_YYYYMMDD &lt;= @END_DT_Q
    	                                          AND A.PERSON_NUMB    = #{PERSON_NUMB})
    
    
    			 UNION ALL
    	        SELECT 'Y' AS FLAG, A.PAY_CODE
    	             , SUBSTRING(B.DUTY_YYYYMMDD,1,4) + '-'  + SUBSTRING(B.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(B.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
    			     , B.WORK_TEAM
    	             , (SELECT HOLY_TYPE
    	                  FROM HBS600T
    	                 WHERE COMP_CODE = A.COMP_CODE
    	                   AND DIV_CODE  = A.DIV_CODE
    	                   AND CAL_DATE  = B.DUTY_YYYYMMDD) AS HOLY_TYPE
    	             , A.DEPT_NAME
    	             , A.POST_CODE
    	             , A.NAME
    	             , A.PERSON_NUMB
    	             , D.DUTY_CODE AS DUTY_CODE
    	             , ''   AS DUTY_FR_D
    	             , '00' AS DUTY_FR_H
    	             , '00' AS DUTY_FR_M
    	             , ''   AS DUTY_TO_D
    	             , '00' AS DUTY_TO_H
    	             , '00' AS DUTY_TO_M
    	          FROM HUM100T A
    	                       INNER JOIN HAT400T B
    	                               ON A.COMP_CODE     = B.COMP_CODE
    	                              AND A.PERSON_NUMB   = B.PERSON_NUMB
    	                       INNER JOIN HBS600T C
    	                               ON A.COMP_CODE     = C.COMP_CODE
    	                              AND A.DIV_CODE      = C.DIV_CODE
    	                              AND B.DUTY_YYYYMMDD = C.CAL_DATE
    	                       INNER JOIN HAT800T D
    	                               ON D.COMP_CODE     = B.COMP_CODE
    	                              AND D.DUTY_YYYYMMDD = B.DUTY_YYYYMMDD
    	                              AND D.PERSON_NUMB   = B.PERSON_NUMB
    	         WHERE A.COMP_CODE      = #{S_COMP_CODE}
    	           AND A.PERSON_NUMB    = #{PERSON_NUMB}
    	           AND B.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
    	           AND B.DUTY_YYYYMMDD &lt;= @END_DT_Q
    	           AND B.DUTY_YYYYMMDD NOT IN (SELECT A.DUTY_YYYYMMDD
    	                                         FROM HAT500T A
    	                                        WHERE A.COMP_CODE      = #{S_COMP_CODE}
    	                                          AND A.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
    	                                          AND A.DUTY_YYYYMMDD &lt;= @END_DT_Q)
    	           ) AS T ON AA.COMP_CODE = #{S_COMP_CODE} AND AA.DIV_CODE = #{DIV_CODE} AND AA.CAL_DATE = REPLACE(T.DUTY_YYYYMMDD,'-','')
                   CROSS JOIN (SELECT TOP 1 * 
                                FROM HUM100T 
                                WHERE COMP_CODE = #{S_COMP_CODE} 
                                AND PERSON_NUMB = #{PERSON_NUMB}) BB
                                                                    )AAA LEFT JOIN HAT100T BBB ON BBB.COMP_CODE = #{S_COMP_CODE}
                                                                                              AND AAA.WORK_TEAM = BBB.WORK_TEAM
                                                                                              AND AAA.HOLY_TYPE = BBB.HOLY_TYPE
			END
		ELSE
			BEGIN
			SELECT '' AS FLAG, A.PAY_CODE
		         , SUBSTRING(B.DUTY_YYYYMMDD,1,4) + '-'  + SUBSTRING(B.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(B.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
			     , B.WORK_TEAM
		         , (SELECT HOLY_TYPE
		              FROM HBS600T
		             WHERE COMP_CODE = A.COMP_CODE
		               AND DIV_CODE  = A.DIV_CODE
		               AND CAL_DATE  = B.DUTY_YYYYMMDD) HOLY_TYPE
		         , A.DEPT_NAME
		         , A.POST_CODE
		         , A.NAME
		         , B.PERSON_NUMB
		         , B.DUTY_CODE
		         , SUBSTRING(B.DUTY_FR_D, 1, 4) + '-' + SUBSTRING(B.DUTY_FR_D, 5, 2) + '-' + SUBSTRING(B.DUTY_FR_D, 7, 2) DUTY_FR_D
			     , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_FR_H), 2) DUTY_FR_H
		         , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_FR_M), 2) DUTY_FR_M
		         , SUBSTRING(B.DUTY_TO_D, 1, 4) + '-' + SUBSTRING(B.DUTY_TO_D, 5, 2) + '-' + SUBSTRING(B.DUTY_TO_D, 7, 2) DUTY_TO_D
			     , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_TO_H), 2) DUTY_TO_H
		         , RIGHT('0' + CONVERT(NVARCHAR,B.DUTY_TO_M), 2) DUTY_TO_M
		      FROM HUM100T A
		                   INNER JOIN HAT500T B
		                           ON A.COMP_CODE   =  B.COMP_CODE
		                          AND A.PERSON_NUMB =  B.PERSON_NUMB
		     WHERE B.COMP_CODE       = #{S_COMP_CODE}
		       AND B.DUTY_YYYYMMDD  &gt;= @STRT_DT_Q
		       AND B.DUTY_YYYYMMDD  &lt;= @END_DT
		       AND A.PERSON_NUMB = #{PERSON_NUMB}
		     ORDER BY B.DUTY_YYYYMMDD
			END
		</if>
		<if test='DUTY_RULE.equals("N")'>
		IF @STRT_DT_Q &lt;&gt; 'kk' AND @END_DT_Q &lt;&gt; 'kk'
			BEGIN
			SELECT ISNULL(T.FLAG, 'Y') AS FLAG
             , ISNULL(T.PAY_CODE, BB.PAY_CODE) AS PAY_CODE
             , ISNULL(T.DUTY_YYYYMMDD, SUBSTRING(AA.CAL_DATE,1,4) + '-' + SUBSTRING(AA.CAL_DATE,5,2) + '-' + SUBSTRING(AA.CAL_DATE,7,2)) AS DUTY_YYYYMMDD
             , CASE WHEN T.WORK_TEAM IS NULL THEN
                    CASE WHEN  LAG(T.WORK_TEAM,1,1) OVER (ORDER BY AA.CAL_DATE) IS NULL THEN  ISNULL(ISNULL((SELECT WORK_TEAM 
                                                                                                               FROM HAT400T       
                                                                                                              WHERE PERSON_NUMB = #{PERSON_NUMB}
                                                                                                                AND DUTY_YYYYMMDD BETWEEN @STRT_DT AND @END_DT
                                                                                                                AND DUTY_YYYYMMDD = ( SELECT MAX(DUTY_YYYYMMDD)
                                                                                                                                        FROM HAT400T 
                                                                                                                                       WHERE PERSON_NUMB = #{PERSON_NUMB}
                                                                                                                                         AND DUTY_YYYYMMDD BETWEEN @STRT_DT AND @END_DT
                                                                                                                                         AND DUTY_YYYYMMDD &lt;= AA.CAL_DATE
                                                                                                                                         AND ISNULL(WORK_TEAM, '') != '') ), @PRE_WORKTEAM ),'1')
                         ELSE  LAG(T.WORK_TEAM,1,ISNULL(@PRE_WORKTEAM,'1')) OVER (ORDER BY AA.CAL_DATE)
                    END      
                ELSE T.WORK_TEAM END AS WORK_TEAM
             , ISNULL(T.HOLY_TYPE, (SELECT HOLY_TYPE
                      FROM HBS600T
                     WHERE COMP_CODE = #{S_COMP_CODE}
                       AND DIV_CODE  = #{DIV_CODE}
                       AND CAL_DATE  = AA.CAL_DATE)) AS HOLY_TYPE
             , ISNULL(T.DEPT_NAME, BB.DEPT_NAME) AS DEPT_NAME
             , ISNULL(T.POST_CODE, BB.POST_CODE) AS POST_CODE
             , ISNULL(T.NAME, BB.NAME) AS NAME
             , ISNULL(T.PERSON_NUMB, BB.PERSON_NUMB) AS PERSON_NUMB
             , ISNULL(T.NUMF,'D') AS NUMF
             , ISNULL(T.NUMC1,'') AS NUMC1
             , ISNULL(T.NUMC,'') AS NUMC
             , ISNULL(T.NUMN,0) AS NUMN
			  <foreach collection="DUTY_CODE" item="item" index="index">
			 , ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, T.TIMEN${item.SUB_CODE})), 2), '00')	AS TIMEN${item.SUB_CODE}
	         , ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, T.TIMEC${item.SUB_CODE})), 2), '00')	AS TIMEC${item.SUB_CODE}
	         , ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, T.TIMET${item.SUB_CODE})), 2), '00')	AS TIMET${item.SUB_CODE}
	         , ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, T.TIMEM${item.SUB_CODE})), 2), '00')	AS TIMEM${item.SUB_CODE}
	         </foreach>

		 FROM (SELECT * 
                 FROM HBS600T 
                WHERE CAL_DATE 
                BETWEEN @STRT_DT AND @END_DT
                AND COMP_CODE = #{S_COMP_CODE}
                AND DIV_CODE = #{DIV_CODE}
             ) AA LEFT JOIN
			(SELECT '' AS FLAG, B.PAY_CODE
	             , SUBSTRING(A.DUTY_YYYYMMDD,1,4) + '-' +  SUBSTRING(A.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(A.DUTY_YYYYMMDD,7,2) DUTY_YYYYMMDD
			     , MAX(A.WORK_TEAM) WORK_TEAM
	             , (SELECT HOLY_TYPE
	                  FROM HBS600T
	                 WHERE COMP_CODE = B.COMP_CODE
	                   AND DIV_CODE  = B.DIV_CODE
	                   AND CAL_DATE  = A.DUTY_YYYYMMDD) AS HOLY_TYPE
	             , (SELECT WEEK_DAY
	                  FROM HBS600T
	                 WHERE COMP_CODE = B.COMP_CODE
	                   AND DIV_CODE  = B.DIV_CODE
	                   AND CAL_DATE  = A.DUTY_YYYYMMDD) AS WEEK_DAY
	             , MAX(B.DEPT_CODE) AS DEPT_CODE
	             , MAX(B.DEPT_NAME) AS DEPT_NAME
	             , MAX(B.POST_CODE) AS POST_CODE
	             , MAX(B.NAME) NAME
	             , MAX(A.PERSON_NUMB) AS PERSON_NUMB
	             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN 'D'
	                        ELSE ''
	                        END) NUMF
	             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_CODE
	                        ELSE ''
	                        END) NUMC1
	             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_CODE
	                        ELSE ''
	                        END) NUMC
	             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_NUM
	                        ELSE 0
	                        END) NUMN
	             , 0 AS NUMT
	             , 0 AS NUMM

	         <foreach collection="DUTY_CODE" item="item" index="index">
	         , CASE WHEN MAX(A.DUTY_CODE)  = '${item.SUB_CODE}' THEN ''
	                ELSE 'D'
	                END AS TIMEF${item.SUB_CODE}
	         , '${item.SUB_CODE}' AS TIMEC${item.SUB_CODE}
	         , 0 AS TIMEN${item.SUB_CODE}
	         , ISNULL(MAX(CASE WHEN A.DUTY_CODE = '${item.SUB_CODE}' THEN ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, REPLACE(A.DUTY_TIME, '.00', ''))), 2), '00') END),0) AS TIMET${item.SUB_CODE}
	         , ISNULL(MAX(CASE WHEN A.DUTY_CODE = '${item.SUB_CODE}' THEN ISNULL(RIGHT(('0' + CONVERT(NVARCHAR, REPLACE(A.DUTY_MINU, '.00', ''))), 2), '00') END),0) AS TIMEM${item.SUB_CODE}
	         </foreach>
	          FROM HAT600T A
	                       LEFT OUTER JOIN HBS100T C
	                                    ON A.COMP_CODE =  C.COMP_CODE
	                                   AND A.DUTY_CODE =  C.DUTY_CODE
	                                   AND C.PAY_CODE  = #{PAY_CODE}
	                            INNER JOIN HUM100T B
	                                    ON A.COMP_CODE   = B.COMP_CODE
	                                   AND A.PERSON_NUMB = B.PERSON_NUMB
	                                   AND C.PAY_CODE    = B.PAY_CODE
	         WHERE A.COMP_CODE      = #{S_COMP_CODE}
	           AND A.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	           AND A.DUTY_YYYYMMDD &lt;= @END_DT
	           AND A.PERSON_NUMB    = #{PERSON_NUMB}
	         GROUP BY A.COMP_CODE, B.COMP_CODE, A.DUTY_YYYYMMDD, A.PERSON_NUMB , B.DIV_CODE, B.PAY_CODE

	        UNION ALL
	        SELECT 'Y' AS FLAG, A.PAY_CODE
	             , SUBSTRING(D.DUTY_YYYYMMDD,1,4) + '-' + SUBSTRING(D.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(D.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
			     , D.WORK_TEAM
	             , (SELECT HOLY_TYPE
	                  FROM HBS600T
	                 WHERE COMP_CODE = A.COMP_CODE
	                   AND DIV_CODE  = A.DIV_CODE
	                   AND CAL_DATE  = D.DUTY_YYYYMMDD) AS HOLY_TYPE
	             , (SELECT WEEK_DAY
	                  FROM HBS600T
	                 WHERE COMP_CODE = A.COMP_CODE
	                   AND DIV_CODE  = A.DIV_CODE
	                   AND CAL_DATE  = D.DUTY_YYYYMMDD) AS WEEK_DAY
	             , DEPT_CODE
	             , DEPT_NAME
	             , POST_CODE
	             , NAME
	             , A.PERSON_NUMB
	             , 'D' AS NUMF
	             , '' AS NUMC1
	             , '' AS NUMC
	             , 0 AS NUMN
	             , 0 AS NUMT
	             , 0 AS NUMM

	         <foreach collection="DUTY_CODE" item="item" index="index">
	         , 'D' AS TIMEF${item.SUB_CODE}
	         , '${item.SUB_CODE}' AS TIMEC${item.SUB_CODE}
	         , 0 AS TIMEN${item.SUB_CODE}
	         , 0 AS TIMET${item.SUB_CODE}
	         , 0 AS TIMEM${item.SUB_CODE}
	          </foreach>

	          FROM HUM100T A
	                       INNER JOIN HAT400T D
	                               ON A.COMP_CODE   = D.COMP_CODE
	                              AND A.PERSON_NUMB = D.PERSON_NUMB
	         WHERE A.COMP_CODE     = #{S_COMP_CODE}
	           AND D.DUTY_YYYYMMDD  NOT IN (SELECT DUTY_YYYYMMDD
	                                          FROM HAT600T
	                                         WHERE COMP_CODE      = #{S_COMP_CODE}
	                                           AND DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	                                           AND DUTY_YYYYMMDD &lt;= @END_DT_Q
	                                           AND PERSON_NUMB    = #{PERSON_NUMB} )

	           AND D.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	           AND D.DUTY_YYYYMMDD &lt;= @END_DT_Q
	           AND D.DUTY_YYYYMMDD  NOT IN (SELECT DUTY_YYYYMMDD
	                                          FROM HAT800T
	                                         WHERE COMP_CODE      = #{S_COMP_CODE}
	                                           AND DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	                                           AND DUTY_YYYYMMDD &lt;= @END_DT_Q
	                                           AND PERSON_NUMB    = #{PERSON_NUMB} )
	           AND D.PERSON_NUMB    = #{PERSON_NUMB}

	         UNION ALL
	        SELECT 'Y' AS FLAG, A.PAY_CODE
	             , SUBSTRING(D.DUTY_YYYYMMDD,1,4) + '-' + SUBSTRING(D.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(D.DUTY_YYYYMMDD,7,2) AS DUTY_YYYYMMDD
			     , D.WORK_TEAM
	             , (SELECT HOLY_TYPE
	                  FROM HBS600T
	                 WHERE COMP_CODE = A.COMP_CODE
	                   AND DIV_CODE  = A.DIV_CODE
	                   AND CAL_DATE  = D.DUTY_YYYYMMDD) AS HOLY_TYPE
	             , (SELECT WEEK_DAY
	                  FROM HBS600T
	                 WHERE COMP_CODE = A.COMP_CODE
	                   AND DIV_CODE  = A.DIV_CODE
	                   AND CAL_DATE  = D.DUTY_YYYYMMDD) AS WEEK_DAY
	             , DEPT_CODE
	             , DEPT_NAME
	             , POST_CODE
	             , NAME
	             , A.PERSON_NUMB
	             , 'D' AS NUMF
	             , F.DUTY_CODE AS NUMC1
	             , F.DUTY_CODE AS NUMC
	             , F.DUTY_NUM  AS NUMN
	             , 0 AS NUMT
	             , 0 AS NUMM

	          <foreach collection="DUTY_CODE" item="item" index="index">
	          , 'D' AS TIMEF${item.SUB_CODE}
	          , '${item.SUB_CODE}' AS TIMEC${item.SUB_CODE}
	          , 0 AS TIMEN${item.SUB_CODE}
	          , 0 AS TIMET${item.SUB_CODE}
	          , 0 AS TIMEM${item.SUB_CODE}
	          </foreach>

	          FROM HUM100T A
	                       INNER JOIN HAT400T D
	                               ON A.COMP_CODE     = D.COMP_CODE
	                              AND A.PERSON_NUMB   = D.PERSON_NUMB
	                       INNER JOIN HAT800T F
	                               ON F.COMP_CODE     = D.COMP_CODE
	                              AND F.PERSON_NUMB   = D.PERSON_NUMB
	                              AND F.DUTY_YYYYMMDD = D.DUTY_YYYYMMDD
	         WHERE D.COMP_CODE     =  #{S_COMP_CODE}
	           AND D.DUTY_YYYYMMDD  NOT IN (SELECT DUTY_YYYYMMDD
	                                          FROM HAT600T
	                                         WHERE COMP_CODE      = #{S_COMP_CODE}
	                                           AND DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	                                           AND DUTY_YYYYMMDD &lt;= @END_DT_Q
	                                           AND PERSON_NUMB = #{PERSON_NUMB} )
	           AND D.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
	           AND D.DUTY_YYYYMMDD &lt;= @END_DT_Q
	           AND D.PERSON_NUMB    = #{PERSON_NUMB}
	           ) AS T ON AA.COMP_CODE = #{S_COMP_CODE} AND AA.DIV_CODE = #{DIV_CODE} AND AA.CAL_DATE = REPLACE(T.DUTY_YYYYMMDD,'-','')
               CROSS JOIN (SELECT TOP 1 * 
                            FROM HUM100T 
                            WHERE COMP_CODE = #{S_COMP_CODE} 
                            AND PERSON_NUMB = #{PERSON_NUMB}) BB
               ORDER BY AA.CAL_DATE
			END
	ELSE
		BEGIN
		SELECT '' AS FLAG, B.PAY_CODE
             , SUBSTRING(A.DUTY_YYYYMMDD,1,4) + '-' +  SUBSTRING(A.DUTY_YYYYMMDD,5,2) + '-' + SUBSTRING(A.DUTY_YYYYMMDD,7,2) DUTY_YYYYMMDD
		     , MAX(A.WORK_TEAM) WORK_TEAM
             , (SELECT HOLY_TYPE
                  FROM HBS600T
                 WHERE COMP_CODE = B.COMP_CODE
                   AND DIV_CODE  = B.DIV_CODE
                   AND CAL_DATE  = A.DUTY_YYYYMMDD) AS HOLY_TYPE
             , (SELECT WEEK_DAY
                  FROM HBS600T
                 WHERE COMP_CODE = B.COMP_CODE
                   AND DIV_CODE  = B.DIV_CODE
                   AND CAL_DATE  = A.DUTY_YYYYMMDD) AS WEEK_DAY
             , MAX(B.DEPT_CODE) AS DEPT_CODE
             , MAX(B.DEPT_NAME) AS DEPT_NAME
             , MAX(B.POST_CODE) AS POST_CODE
             , MAX(B.NAME) NAME
             , MAX(A.PERSON_NUMB) AS PERSON_NUMB
             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN 'D'
                        ELSE ''
                        END) NUMF
             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_CODE
                        ELSE ''
                        END) NUMC1
             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_CODE
                        ELSE ''
                        END) NUMC
             , MAX(CASE WHEN  C.COTR_TYPE = '2' AND A.DUTY_NUM &lt;&gt;'0' THEN A.DUTY_NUM
                        ELSE 0
                        END) NUMN
             , 0 AS NUMT
             , 0 AS NUMM

         <foreach collection="DUTY_CODE" item="item" index="index">
         , CASE WHEN MAX(A.DUTY_CODE)  = '${item.SUB_CODE}' THEN ''
                ELSE 'D'
                END AS TIMEF${item.SUB_CODE}
         , '${item.SUB_CODE}' AS TIMEC${item.SUB_CODE}
         , 0 AS TIMEN${item.SUB_CODE}
         , ISNULL(MAX(CASE WHEN A.DUTY_CODE = '${item.SUB_CODE}' THEN A.DUTY_TIME END),0) AS TIMET${item.SUB_CODE}
         , ISNULL(MAX(CASE WHEN A.DUTY_CODE = '${item.SUB_CODE}' THEN A.DUTY_MINU END),0) AS TIMEM${item.SUB_CODE}
         </foreach>
          FROM HAT600T A
                       LEFT OUTER JOIN HBS100T C
                                    ON A.COMP_CODE =  C.COMP_CODE
                                   AND A.DUTY_CODE =  C.DUTY_CODE
                                   AND C.PAY_CODE  = #{PAY_CODE}
                            INNER JOIN HUM100T B
                                    ON A.COMP_CODE   = B.COMP_CODE
                                   AND A.PERSON_NUMB = B.PERSON_NUMB
                                   AND C.PAY_CODE    = B.PAY_CODE
         WHERE A.COMP_CODE      = #{S_COMP_CODE}
           AND A.DUTY_YYYYMMDD &gt;= @STRT_DT_Q
           AND A.DUTY_YYYYMMDD &lt;= @END_DT
           AND A.PERSON_NUMB    = #{PERSON_NUMB}
         GROUP BY A.COMP_CODE, B.COMP_CODE, A.DUTY_YYYYMMDD, A.PERSON_NUMB , B.DIV_CODE, B.PAY_CODE
         ORDER BY A.DUTY_YYYYMMDD
		END
	</if>
	</select>

	<insert id="hat510ukrServiceImpl.insertList_DutyRule_Y"  parameterType="rMap">
		/* hat510ukrServiceImpl.insertList_DutyRule_Y */
		INSERT INTO HAT500T
           (COMP_CODE
           ,PERSON_NUMB
           ,DUTY_YYYYMMDD
           ,DUTY_FR_D
           ,DUTY_FR_H
           ,DUTY_FR_M
           ,DUTY_TO_D
           ,DUTY_TO_H
           ,DUTY_TO_M
           ,DUTY_CODE
           ,WORK_TEAM
           ,UPDATE_DB_USER
           ,UPDATE_DB_TIME
           ,INSERT_DB_USER
           ,INSERT_DB_TIME)
     VALUES
           (#{S_COMP_CODE}
           ,#{PERSON_NUMB}
           ,#{DUTY_YYYYMMDD}
           ,#{DUTY_FR_D}
           ,#{DUTY_FR_H}
           ,#{DUTY_FR_M}
           ,#{DUTY_TO_D}
           ,#{DUTY_TO_H}
           ,#{DUTY_TO_M}
           ,#{DUTY_CODE}
           ,#{WORK_TEAM}
           ,#{S_USER_ID}
           ,GETDATE()
           ,#{S_USER_ID}
           ,GETDATE())
	</insert>

	<update id="hat510ukrServiceImpl.updateList_DutyRule_Y"  parameterType="rMap">
		/* hat510ukrServiceImpl.updateList_DutyRule_Y */
		UPDATE HAT500T
               SET DUTY_CODE = #{DUTY_CODE}
                 , DUTY_FR_D = #{DUTY_FR_D}
                 , DUTY_FR_H = #{DUTY_FR_H}
                 , DUTY_FR_M = #{DUTY_FR_M}
                 , DUTY_TO_D = #{DUTY_TO_D}
                 , DUTY_TO_H = #{DUTY_TO_H}
                 , DUTY_TO_M = #{DUTY_TO_M}
             WHERE COMP_CODE = #{S_COMP_CODE}
               AND PERSON_NUMB = #{PERSON_NUMB}
               AND DUTY_YYYYMMDD = #{DUTY_YYYYMMDD}
	</update>

	<delete id="hat510ukrServiceImpl.deleteList_DutyRule_Y"  parameterType="rMap">
		/* hat510ukrServiceImpl.deleteList_DutyRule_Y */
		DELETE FROM HAT500T
        WHERE COMP_CODE = #{S_COMP_CODE}
               AND PERSON_NUMB = #{PERSON_NUMB}
               AND DUTY_YYYYMMDD = #{DUTY_YYYYMMDD}
	</delete>

	<insert id="hat510ukrServiceImpl.insertList_DutyRule_N01"  parameterType="rMap">
		/* hat510ukrServiceImpl.insertList_DutyRule_N01 */
		INSERT INTO HAT600T
		     ( DUTY_YYYYMMDD
		     , PERSON_NUMB
		     , WORK_TEAM
		     , DUTY_CODE
		     , DUTY_NUM
		     , DUTY_TIME
		     , DUTY_MINU
		     , UPDATE_DB_USER
		     , UPDATE_DB_TIME
		     , COMP_CODE
		     )
		VALUES
		     ( #{DUTY_YYYYMMDD}
		     , #{PERSON_NUMB}
		     , #{WORK_TEAM}
		     , #{DUTY_CODE}
		     , #{DUTY_NUM}
		     , #{DUTY_TIME}
		     , #{DUTY_MINU}
		     , #{S_USER_ID}
		     , GETDATE()
		     , #{S_COMP_CODE}
		     )
	</insert>

	<insert id="hat510ukrServiceImpl.insertList_DutyRule_N02"  parameterType="rMap">
		/* hat510ukrServiceImpl.insertList_DutyRule_N02 */
		INSERT INTO HAT600T
               (PERSON_NUMB
              , DUTY_YYYYMMDD
              , DUTY_CODE
              , DUTY_NUM
              , DUTY_TIME
              , DUTY_MINU
              , WORK_TEAM
              , UPDATE_DB_USER
              , UPDATE_DB_TIME
              , COMP_CODE)
        SELECT B.PERSON_NUMB
             , #{DUTY_YYYYMMDD}
             , A.SUB_CODE
             , 0, 0, 0, #{WORK_TEAM}
             , #{S_USER_ID}
             , GETDATE()
             , B.COMP_CODE
          FROM BSA100T A
                       INNER JOIN HUM100T B
                               ON A.COMP_CODE = B.COMP_CODE
                       INNER JOIN HBS100T C
                               ON A.COMP_CODE = C.COMP_CODE
                              AND A.SUB_CODE  = C.DUTY_CODE
                              AND B.PAY_CODE  = C.PAY_CODE
         WHERE A.COMP_CODE = #{S_COMP_CODE}
           AND MAIN_CODE = 'H033'
           AND SUB_CODE &lt;&gt; '$'
           AND B.PERSON_NUMB =  #{PERSON_NUMB}
           AND SUB_CODE NOT IN (SELECT DUTY_CODE
                                  FROM HAT600T
                                 WHERE COMP_CODE     = #{S_COMP_CODE}
                                   AND PERSON_NUMB   = #{PERSON_NUMB}
                                   AND DUTY_YYYYMMDD = #{DUTY_YYYYMMDD})
	</insert>

	<update id="hat510ukrServiceImpl.updateList_DutyRule_N"  parameterType="rMap">
		/* hat510ukrServiceImpl.updateList_DutyRule_N */
		UPDATE HAT600T
               SET DUTY_NUM = '1'
           		, UPDATE_DB_USER = #{S_USER_ID}
		     	, UPDATE_DB_TIME = GETDATE()
             WHERE COMP_CODE = #{S_COMP_CODE}
               AND PERSON_NUMB = #{PERSON_NUMB}
               AND DUTY_YYYYMMDD = #{DUTY_YYYYMMDD}
               AND DUTY_CODE = #{NUMC}
	</update>

	<delete id="hat510ukrServiceImpl.deleteList_DutyRule_N"  parameterType="rMap">
		/* hat510ukrServiceImpl.deleteList_DutyRule_N */
		DELETE FROM HAT600T
        WHERE COMP_CODE = #{S_COMP_CODE}
               AND PERSON_NUMB = #{PERSON_NUMB}
               AND DUTY_YYYYMMDD = #{DUTY_YYYYMMDD}
	</delete>

</mapper>