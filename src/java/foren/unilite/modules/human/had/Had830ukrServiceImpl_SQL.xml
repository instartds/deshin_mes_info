<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="had830ukrServiceImpl">
    <select id="had830ukrServiceImpl.closeSalary" parameterType="Map" resultType="rMap">
        -- had830ukrServiceImpl.closeSalary
        SELECT CASE WHEN CLOSE_DATE &gt;= #{PAY_YYMM} THEN 'CLOSED' ELSE '' END CHK
          FROM HBS900T WITH (NOLOCK)
         WHERE COMP_CODE  = #{S_COMP_CODE}
           AND CLOSE_TYPE = '1'
    </select>

    <select id="had830ukrServiceImpl.closedEmployee" parameterType="Map" resultType="rMap">
        -- had830ukrServiceImpl.closedEmployee
        SELECT A.CLOSE_DATE 
          FROM            HBS910T A WITH (NOLOCK)
               INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                 AND B.PERSON_NUMB = A.PERSON_NUMB
               INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                               
                                                 AND C.PERSON_NUMB = A.PERSON_NUMB  
         WHERE A.COMP_CODE     = #{S_COMP_CODE}
           AND A.CLOSE_DATE    = #{PAY_YYMM}
        <if test="@foren.Ognl@isNotEmpty(PROV_TYPE)"> 
           AND C.SUPP_TYPE     = #{PROV_TYPE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
           AND B.PERSON_NUMB   = #{PERSON_NUMB}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
           AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
           AND B.PAY_CODE      = #{PAY_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
           AND B.DIV_CODE      = #{DIV_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
           AND B.DEPT_CODE IN 
            <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="had830ukrServiceImpl.employee" parameterType="Map" resultType="rMap">
        -- had830ukrServiceImpl.employee                                                          
        SELECT #{PAY_YYMM}                                                           
             , #{PROV_TYPE}                                                         
             , A.PERSON_NUMB                                                                
             , #{SUPP_CODE}                                                        
             , ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0)        
          FROM            HAD600T A WITH (NOLOCK)
               INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                               
                                                 AND B.PERSON_NUMB = A.PERSON_NUMB                           
               INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                               
                                                 AND C.PERSON_NUMB = A.PERSON_NUMB                           
               LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                 AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                 AND D.PERSON_NUMB = A.PERSON_NUMB                           
         WHERE A.COMP_CODE     = #{S_COMP_CODE}                                           
           AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
           AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
           AND A.YEAR_YYYY     = #{BASE_DATE}                                             
           AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0) 
           AND A.HALFWAY_TYPE  = #{RETURN_TYPE}      
           AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
           AND B.PERSON_NUMB   = #{PERSON_NUMB}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
           AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
           AND B.PAY_CODE      = #{PAY_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
           AND B.DIV_CODE      = #{DIV_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
           AND B.DEPT_CODE IN 
        	<foreach collection="DEPT" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>

        UNION ALL
        -- 연말정산 1차분납		
        SELECT #{PAY_YYMM}                                                           
             , #{PROV_TYPE}                                                         
             , A.PERSON_NUMB                                                                
             , #{SUPP_CODE}                                                        
             , ISNULL(A.IN_TAX_I_01,0) + ISNULL(A.SP_TAX_I_01,0) + ISNULL(A.LOCAL_TAX_I_01,0)        
          FROM            HAD950T A WITH (NOLOCK)
               INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                               
                                                 AND B.PERSON_NUMB = A.PERSON_NUMB                           
               INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                               
                                                 AND C.PERSON_NUMB = A.PERSON_NUMB
                                                 AND C.PAY_YYYYMM  = A.PAY_YYYYMM_01
         WHERE A.COMP_CODE     = #{S_COMP_CODE}                                           
           AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
           AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
           AND A.YEAR_YYYY     = CONVERT(NVARCHAR(4), #{BASE_DATE} + 1)                                              
           AND (ISNULL(A.IN_TAX_I_01,0) + ISNULL(A.SP_TAX_I_01,0) + ISNULL(A.LOCAL_TAX_I_01,0) != 0) 
           AND 'N'             = #{RETURN_TYPE}      
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
           AND B.PERSON_NUMB   = #{PERSON_NUMB}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
           AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
           AND B.PAY_CODE      = #{PAY_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
           AND B.DIV_CODE      = #{DIV_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
           AND B.DEPT_CODE IN 
        	<foreach collection="DEPT" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>

        UNION ALL
        -- 연말정산 2차분납		
        SELECT #{PAY_YYMM}                                                           
             , #{PROV_TYPE}                                                         
             , A.PERSON_NUMB                                                                
             , #{SUPP_CODE}                                                        
             , ISNULL(A.IN_TAX_I_02,0) + ISNULL(A.SP_TAX_I_02,0) + ISNULL(A.LOCAL_TAX_I_02,0)        
          FROM            HAD950T A WITH (NOLOCK)
               INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                               
                                                 AND B.PERSON_NUMB = A.PERSON_NUMB                           
               INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                               
                                                 AND C.PERSON_NUMB = A.PERSON_NUMB
                                                 AND C.PAY_YYYYMM  = A.PAY_YYYYMM_02
         WHERE A.COMP_CODE     = #{S_COMP_CODE}                                           
           AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
           AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
           AND A.YEAR_YYYY     = CONVERT(NVARCHAR(4), #{BASE_DATE} + 1)                                             
           AND (ISNULL(A.IN_TAX_I_02,0) + ISNULL(A.SP_TAX_I_02,0) + ISNULL(A.LOCAL_TAX_I_02,0) != 0) 
           AND 'N'             = #{RETURN_TYPE}      
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
           AND B.PERSON_NUMB   = #{PERSON_NUMB}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
           AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
           AND B.PAY_CODE      = #{PAY_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
           AND B.DIV_CODE      = #{DIV_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
           AND B.DEPT_CODE IN 
        	<foreach collection="DEPT" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>

        UNION ALL
        -- 연말정산 3차분납		
        SELECT #{PAY_YYMM}                                                           
             , #{PROV_TYPE}                                                         
             , A.PERSON_NUMB                                                                
             , #{SUPP_CODE}                                                        
             , ISNULL(A.IN_TAX_I_03,0) + ISNULL(A.SP_TAX_I_03,0) + ISNULL(A.LOCAL_TAX_I_03,0)        
          FROM            HAD950T A WITH (NOLOCK)
               INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                               
                                                 AND B.PERSON_NUMB = A.PERSON_NUMB                           
               INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                               
                                                 AND C.PERSON_NUMB = A.PERSON_NUMB
                                                 AND C.PAY_YYYYMM  = A.PAY_YYYYMM_03
         WHERE A.COMP_CODE     = #{S_COMP_CODE}                                           
           AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
           AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
           AND A.YEAR_YYYY     = CONVERT(NVARCHAR(4), #{BASE_DATE} + 1)                                            
           AND (ISNULL(A.IN_TAX_I_03,0) + ISNULL(A.SP_TAX_I_03,0) + ISNULL(A.LOCAL_TAX_I_03,0) != 0) 
           AND 'N'             = #{RETURN_TYPE}      
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
           AND B.PERSON_NUMB   = #{PERSON_NUMB}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
           AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
           AND B.PAY_CODE      = #{PAY_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
           AND B.DIV_CODE      = #{DIV_CODE} 
        </if>
        <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
           AND B.DEPT_CODE IN 
        	<foreach collection="DEPT" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
    </select>

    <update id="had830ukrServiceImpl.deleteOld" parameterType="Map">
        IF ('Y' = #{RETR_FLAG})
        BEGIN
            DELETE HPA400T 
              FROM            HPA400T A
                   INNER JOIN HUM100T B ON A.COMP_CODE   = B.COMP_CODE
                                       AND A.PERSON_NUMB = B.PERSON_NUMB
                   INNER JOIN HAD600T C ON A.COMP_CODE   = C.COMP_CODE
                                       AND A.PERSON_NUMB = C.PERSON_NUMB
                   INNER JOIN HPA600T D ON A.COMP_CODE   = D.COMP_CODE
                                       AND A.PERSON_NUMB = D.PERSON_NUMB
                   LEFT  JOIN HAD950T E ON E.COMP_CODE   = C.COMP_CODE                               
                                       AND E.YEAR_YYYY   = CONVERT(NVARCHAR(4), C.YEAR_YYYY + 1)                            
                                       AND E.PERSON_NUMB = C.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}
               AND C.YEAR_YYYY     = #{BASE_DATE}
               AND A.PAY_YYYYMM    = #{PAY_YYMM}  
               AND A.SUPP_TYPE     = #{PROV_TYPE} 
               AND A.PAY_YYYYMM    = D.PAY_YYYYMM 
               AND A.SUPP_TYPE     = D.SUPP_TYPE
               AND A.DED_CODE      = #{SUPP_CODE}
               AND (ISNULL(C.IN_TAX_I,0) + ISNULL(C.SP_TAX_I,0) + ISNULL(C.LOCAL_TAX_I,0) != 0)  
               AND C.HALFWAY_TYPE  = #{RETURN_TYPE}
               AND ISNULL(E.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

			-- 분납신청으로 생성된 공제내역
            DELETE HPA400T 
              FROM            HPA400T A
                   INNER JOIN HUM100T B ON A.COMP_CODE   = B.COMP_CODE
                                       AND A.PERSON_NUMB = B.PERSON_NUMB
                   INNER JOIN HAD600T C ON A.COMP_CODE   = C.COMP_CODE
                                       AND A.PERSON_NUMB = C.PERSON_NUMB
                   INNER JOIN HPA600T D ON A.COMP_CODE   = D.COMP_CODE
                                       AND A.PERSON_NUMB = D.PERSON_NUMB
                   LEFT  JOIN HAD950T E ON E.COMP_CODE   = C.COMP_CODE                               
                                       AND E.YEAR_YYYY   = CONVERT(NVARCHAR(4), C.YEAR_YYYY + 1)             
                                       AND E.PERSON_NUMB = C.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}
               AND C.YEAR_YYYY     = #{BASE_DATE}
               AND A.PAY_YYYYMM    = #{PAY_YYMM}  
               AND A.SUPP_TYPE     = #{PROV_TYPE} 
               AND A.PAY_YYYYMM    = D.PAY_YYYYMM 
               AND A.SUPP_TYPE     = D.SUPP_TYPE
               AND A.DED_CODE      = #{SUPP_CODE}
               AND (ISNULL(C.IN_TAX_I,0) + ISNULL(C.SP_TAX_I,0) + ISNULL(C.LOCAL_TAX_I,0) != 0)  
               AND C.HALFWAY_TYPE  = #{RETURN_TYPE}
               AND ISNULL(E.COMP_CODE,'') != ''
               AND (E.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR E.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR E.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
        ELSE
        BEGIN
            DELETE HPA400T                                                                              
              FROM            HPA400T A 
                   INNER JOIN HUM100T B ON A.COMP_CODE   = B.COMP_CODE                                     
                                       AND A.PERSON_NUMB = B.PERSON_NUMB                                   
                   INNER JOIN HAD600T C ON A.COMP_CODE   = C.COMP_CODE                                     
                                       AND A.PERSON_NUMB = C.PERSON_NUMB                                   
                   INNER JOIN HPA600T D ON A.COMP_CODE   = D.COMP_CODE                                     
                                       AND A.PERSON_NUMB = D.PERSON_NUMB                                   
                   LEFT  JOIN HAD950T E ON E.COMP_CODE   = C.COMP_CODE                               
                                       AND E.YEAR_YYYY   = CONVERT(NVARCHAR(4), C.YEAR_YYYY + 1)                         
                                       AND E.PERSON_NUMB = C.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                                    
               AND C.YEAR_YYYY     = #{BASE_DATE}                                                     
               AND A.PAY_YYYYMM    = #{PAY_YYMM}                                                      
               AND A.SUPP_TYPE     = #{PROV_TYPE}                                                   
               AND A.PAY_YYYYMM    = D.PAY_YYYYMM                                                          
               AND A.SUPP_TYPE     = D.SUPP_TYPE                                                            
               AND A.DED_CODE IN (#{SUPP_CODE1}, #{SUPP_CODE2}, #{SUPP_CODE3})     
               AND (ISNULL(C.IN_TAX_I,0) + ISNULL(C.SP_TAX_I,0) + ISNULL(C.LOCAL_TAX_I,0) != 0)         
               AND C.HALFWAY_TYPE  = #{RETURN_TYPE}  
               AND ISNULL(E.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

			-- 분납신청으로 생성된 공제내역
            DELETE HPA400T 
              FROM            HPA400T A
                   INNER JOIN HUM100T B ON A.COMP_CODE   = B.COMP_CODE
                                       AND A.PERSON_NUMB = B.PERSON_NUMB
                   INNER JOIN HAD600T C ON A.COMP_CODE   = C.COMP_CODE
                                       AND A.PERSON_NUMB = C.PERSON_NUMB
                   INNER JOIN HPA600T D ON A.COMP_CODE   = D.COMP_CODE
                                       AND A.PERSON_NUMB = D.PERSON_NUMB
                   LEFT  JOIN HAD950T E ON E.COMP_CODE   = C.COMP_CODE                               
                                       AND E.YEAR_YYYY   = CONVERT(NVARCHAR(4), C.YEAR_YYYY + 1)                           
                                       AND E.PERSON_NUMB = C.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}
               AND C.YEAR_YYYY     = #{BASE_DATE}
               AND A.PAY_YYYYMM    = #{PAY_YYMM}  
               AND A.SUPP_TYPE     = #{PROV_TYPE} 
               AND A.PAY_YYYYMM    = D.PAY_YYYYMM 
               AND A.SUPP_TYPE     = D.SUPP_TYPE
               AND A.DED_CODE IN (#{SUPP_CODE1}, #{SUPP_CODE2}, #{SUPP_CODE3})     
               AND (ISNULL(C.IN_TAX_I,0) + ISNULL(C.SP_TAX_I,0) + ISNULL(C.LOCAL_TAX_I,0) != 0)  
               AND C.HALFWAY_TYPE  = #{RETURN_TYPE}
               AND ISNULL(E.COMP_CODE,'') != ''
               AND (E.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR E.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR E.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
    </update>

    <update id="had830ukrServiceImpl.batch" parameterType="Map">
        IF ('Y' = #{RETR_FLAG})
        BEGIN
            -- had830ukrServiceImpl.batch 총괄반영
            -- 분납신청이 없는 경우
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                           
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE}                                                           
                 , ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0)         
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 분납신청이 있는 경우
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                           
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE}                                                           
                 , CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_01,0) + ISNULL(D.SP_TAX_I_01,0) + ISNULL(D.LOCAL_TAX_I_01,0)         
                        WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_02,0) + ISNULL(D.SP_TAX_I_02,0) + ISNULL(D.LOCAL_TAX_I_02,0)         
                        WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_03,0) + ISNULL(D.SP_TAX_I_03,0) + ISNULL(D.LOCAL_TAX_I_03,0)  
                                                           ELSE 0
                    END
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
        ELSE
        BEGIN
            -- had830ukrServiceImpl.batch 개별반영
            -- 소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)      
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                          
                 , A.PERSON_NUMB                                                                  
                 , #{SUPP_CODE1}                                                           
                 , ISNULL(A.IN_TAX_I,0)                                                           
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
                    
            -- 지방소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM,SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)       
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                              
                 , #{PROV_TYPE}                                                          
                 , A.PERSON_NUMB                                                                  
                 , #{SUPP_CODE2}                                                           
                 , ISNULL(A.LOCAL_TAX_I,0)                                                        
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
                
            -- 농특세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)      
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                          
                 , A.PERSON_NUMB                                                                  
                 , #{SUPP_CODE3}                                                           
                 , ISNULL(A.SP_TAX_I,0)                                                           
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 분납신청이 있는 경우
            -- 소득세	
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                           
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE1}                                                           
                 , CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_01,0)         
                        WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_02,0)         
                        WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN ISNULL(D.IN_TAX_I_03,0)  
                                                           ELSE 0
                    END
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                          
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 지방소득세	
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                           
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE2}                                                           
                 , CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN ISNULL(D.LOCAL_TAX_I_01,0)         
                        WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN ISNULL(D.LOCAL_TAX_I_02,0)         
                        WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN ISNULL(D.LOCAL_TAX_I_03,0)  
                                                           ELSE 0
                    END
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 농특세	
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                           
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE3}                                                           
                 , CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN ISNULL(D.SP_TAX_I_01,0)         
                        WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN ISNULL(D.SP_TAX_I_02,0)         
                        WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN ISNULL(D.SP_TAX_I_03,0)  
                                                           ELSE 0
                    END
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END

		BEGIN
            -- 분납신청이 없는 경우의 연말정산 급여반영 여부 업데이트            
            UPDATE A
               SET PAY_YYYYMM   = #{PAY_YYMM}                                                             
                 , PAY_APPLY_YN = 'Y'                                                          
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 분납신청이 있는 경우의 분납신청 급여반영 여부 업데이트            
            UPDATE D
               SET PAY_APPLY_YN_01 = CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN 'Y' ELSE PAY_APPLY_YN_01 END         
                 , PAY_APPLY_YN_02 = CASE WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN 'Y' ELSE PAY_APPLY_YN_02 END         
                 , PAY_APPLY_YN_03 = CASE WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN 'Y' ELSE PAY_APPLY_YN_03 END         
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
		END
    </update>

    <update id="had830ukrServiceImpl.cancelBatch" parameterType="Map">
        IF ('Y' = #{RETR_FLAG})
        BEGIN
            -- had830ukrServiceImpl.cancelBatch 취소작업1
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE}                                                           
                 , 0                                                                             
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)     
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                             
                 , #{PROV_TYPE}                                                         
                 , A.PERSON_NUMB                                                                 
                 , #{SUPP_CODE}                                                           
                 , 0                                                                             
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
        ELSE
        BEGIN
            -- had830ukrServiceImpl.cancelBatch 취소작업2
            -- 분납신청이 없는 경우
            -- 소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)       
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                               
                 , #{PROV_TYPE}                                                           
                 , A.PERSON_NUMB                                                                   
                 , #{SUPP_CODE1}                                                            
                 , 0                                                                               
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 지방소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)         
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                                 
                 , #{PROV_TYPE}                                                             
                 , A.PERSON_NUMB                                                                     
                 , #{SUPP_CODE2}                                                              
                 , 0                                                                                 
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                          
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 농특세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)      
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                              
                 , #{PROV_TYPE}                                                          
                 , A.PERSON_NUMB                                                                  
                 , #{SUPP_CODE3}                                                           
                 , 0                                                                              
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 분납신청이 있는 경우
            -- 소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)       
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                               
                 , #{PROV_TYPE}                                                           
                 , A.PERSON_NUMB                                                                   
                 , #{SUPP_CODE1}                                                            
                 , 0                                                                               
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                        
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 지방소득세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)         
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                                 
                 , #{PROV_TYPE}                                                             
                 , A.PERSON_NUMB                                                                     
                 , #{SUPP_CODE2}                                                              
                 , 0                                                                                 
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                       
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 농특세
            INSERT INTO HPA400T (COMP_CODE, PAY_YYYYMM, SUPP_TYPE, PERSON_NUMB, DED_CODE, DED_AMOUNT_I)      
            SELECT #{S_COMP_CODE}                                                            
                 , #{PAY_YYMM}                                                              
                 , #{PROV_TYPE}                                                          
                 , A.PERSON_NUMB                                                                  
                 , #{SUPP_CODE3}                                                           
                 , 0                                                                              
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                      
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END

		BEGIN
            -- 분납신청이 없는 경우의 연말정산 급여반영 여부 업데이트            
            UPDATE A
               SET PAY_YYYYMM   = ''                                                             
                 , PAY_APPLY_YN = 'N'                                                          
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                         
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                               
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                            
               AND A.YEAR_YYYY     = #{BASE_DATE}                                                
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)   
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                         
               AND ISNULL(D.COMP_CODE,'') = ''	-- 분납신청이 없는 경우
               AND A.PAY_YYYYMM    = #{PAY_YYMM}
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>

            -- 분납신청이 있는 경우의 분납신청 급여반영 여부 업데이트            
            UPDATE D
               SET PAY_APPLY_YN_01 = CASE WHEN D.PAY_YYYYMM_01 = #{PAY_YYMM} THEN 'N' ELSE PAY_APPLY_YN_01 END         
                 , PAY_APPLY_YN_02 = CASE WHEN D.PAY_YYYYMM_02 = #{PAY_YYMM} THEN 'N' ELSE PAY_APPLY_YN_02 END         
                 , PAY_APPLY_YN_03 = CASE WHEN D.PAY_YYYYMM_03 = #{PAY_YYMM} THEN 'N' ELSE PAY_APPLY_YN_03 END         
              FROM            HAD600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
                   INNER JOIN HPA600T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE                              
                                                     AND C.PERSON_NUMB = A.PERSON_NUMB                          
                   LEFT  JOIN HAD950T D WITH (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE                               
                                                     AND D.YEAR_YYYY   = CONVERT(NVARCHAR(4), A.YEAR_YYYY + 1)                           
                                                     AND D.PERSON_NUMB = A.PERSON_NUMB                           
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                            
               AND C.PAY_YYYYMM    = #{PAY_YYMM}                                              
               AND C.SUPP_TYPE     = #{PROV_TYPE}                                           
               AND A.YEAR_YYYY     = #{BASE_DATE}                                               
               AND (ISNULL(A.IN_TAX_I,0) + ISNULL(A.SP_TAX_I,0) + ISNULL(A.LOCAL_TAX_I,0) != 0)  
               AND A.HALFWAY_TYPE  = #{RETURN_TYPE}                                        
               AND ISNULL(D.COMP_CODE,'') != ''
               AND (D.PAY_YYYYMM_01 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_02 = #{PAY_YYMM}  
                 OR D.PAY_YYYYMM_03 = #{PAY_YYMM})
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
		END
    </update>

    <update id="had830ukrServiceImpl.dedUpdate" parameterType="Map">
        IF ('Y' = #{RETR_FLAG})
        BEGIN     
             --had830ukrServiceImpl.dedUpdate 공제금액 업데이트 총괄반영
             UPDATE HPA600T                                                                            
                SET DED_TOTAL_I   = (SELECT ISNULL(SUM(DED_AMOUNT_I),0)                                  
                                       FROM HPA400T WITH (NOLOCK)                                                      
                                      WHERE COMP_CODE   = A.COMP_CODE                                    
                                        AND PAY_YYYYMM  = A.PAY_YYYYMM                                   
                                        AND PERSON_NUMB = A.PERSON_NUMB                                  
                                        AND SUPP_TYPE   = A.SUPP_TYPE)                                   
                  , REAL_AMOUNT_I = SUPP_TOTAL_I - (SELECT ISNULL(SUM(DED_AMOUNT_I),0)   
                                                      FROM HPA400T WITH (NOLOCK)                       
                                                     WHERE COMP_CODE   = A.COMP_CODE     
                                                       AND PAY_YYYYMM  = A.PAY_YYYYMM     
                                                       AND PERSON_NUMB = A.PERSON_NUMB   
                                                       AND SUPP_TYPE   = A.SUPP_TYPE)      
              FROM            HPA600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                             
               AND A.PAY_YYYYMM    = #{PAY_YYMM}                                                   
               AND A.SUPP_TYPE     = #{PROV_TYPE}                                  
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
        ELSE
        BEGIN
            --had830ukrServiceImpl.dedUpdate 공제금액 업데이트 개별반영
            UPDATE HPA600T                                                                               
               SET DED_TOTAL_I = (SELECT ISNULL(SUM(DED_AMOUNT_I),0)                                     
                                    FROM HPA400T WITH (NOLOCK)                                                        
                                   WHERE COMP_CODE   = A.COMP_CODE
                                     AND PAY_YYYYMM  = A.PAY_YYYYMM                                       
                                     AND PERSON_NUMB = A.PERSON_NUMB                                     
                                     AND SUPP_TYPE   = A.SUPP_TYPE)                                        
                 , REAL_AMOUNT_I = SUPP_TOTAL_I - (SELECT ISNULL(SUM(DED_AMOUNT_I),0)      
                                                     FROM HPA400T WITH (NOLOCK)                          
                                                    WHERE COMP_CODE   = A.COMP_CODE        
                                                      AND PAY_YYYYMM  = A.PAY_YYYYMM       
                                                      AND PERSON_NUMB = A.PERSON_NUMB      
                                                      AND SUPP_TYPE   = A.SUPP_TYPE)       
              FROM            HPA600T A WITH (NOLOCK)
                   INNER JOIN HUM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE                              
                                                     AND B.PERSON_NUMB = A.PERSON_NUMB                            
             WHERE A.COMP_CODE     = #{S_COMP_CODE}                                                    
               AND A.PAY_YYYYMM    = #{PAY_YYMM}                                                      
               AND A.SUPP_TYPE     = #{PROV_TYPE}                                       
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)"> 
               AND B.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)"> 
               AND B.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PAY_CODE)"> 
               AND B.PAY_CODE      = #{PAY_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)"> 
               AND B.DIV_CODE      = #{DIV_CODE} 
            </if>
            <if test="@foren.Ognl@isNotEmpty(DEPT)"> 
               AND B.DEPT_CODE IN 
                <foreach collection="DEPT" item="item" separator="," close=")" open="(">
                    #{item}
                </foreach>
            </if>
        END
    </update>
</mapper>