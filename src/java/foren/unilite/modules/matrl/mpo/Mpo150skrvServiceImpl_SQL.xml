<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mpo150skrvServiceImpl">

	<select id="mpo150skrvServiceImpl.getLoginUserMailInfo" parameterType="Map" resultType="rMap">
		SELECT USER_ID
			 , USER_NAME
			 , EMAIL_ADDR
		  FROM BSA300T WITH(NOLOCK)
		 WHERE COMP_CODE = #{S_COMP_CODE}
		   AND USER_ID = #{S_USER_ID}
	</select>

	<select id="mpo150skrvServiceImpl.getUserMailInfo" parameterType="Map" resultType="rMap">
		SELECT  SUB_CODE 		AS USER_NAME
			  , CODE_NAME 		AS EMAIL_ADDR
			  , REF_CODE3		AS FROM_NAME
			  , REF_CODE4		AS FROM_NAME_ENG
			  --, uniLITE.fnCipherDecrypt(EMAIL_PASS,'')   AS EMAIL_PASS
		 FROM  BSA100T WITH (NOLOCK)
		WHERE COMP_CODE = #{S_COMP_CODE}
		  AND SUB_CODE  != '$'
		  AND MAIN_CODE = N'M416'
	</select>



	<select id="mpo150skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		/*mpo150skrv.Cmpo150skrv[fnMpo150QStd]query01*/
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE @CompCode	NVARCHAR(08) /* 법인코드	*/
				  , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		
			<!--2021.08 표준화 작업 추가-->
			DECLARE	@RefItem	NVARCHAR(01)
			
			SELECT @RefItem		= ISNULL(NULLIF(REF_ITEM, ''), 0)
			FROM BSA300T
			WHERE COMP_CODE	= #{S_COMP_CODE}
			AND USER_ID		= #{S_USER_ID}

			SET @CompCode = #{S_COMP_CODE}

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
			  FROM BSA100T WITH (NOLOCK)
			 WHERE COMP_CODE = @CompCode
			   AND MAIN_CODE = N'B044'
			   AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

			/* 데이터 조회 */

			SELECT
			   CAST(0 AS BIT)		  AS CHOICE		 /*선택*/
			 , A.MAIL_YN
			 , A.AGREE_STATUS		  AS AGREE_STATUS_CD
			 , F.CODE_NAME			 AS AGREE_STATUS_NM
			 , '2'					 AS CREATE_LOC
			 , A.ORDER_NUM			 AS ORDER_NUM

			 , (CASE WHEN ISNULL(A.ORDER_DATE, '') = ''
				THEN ''
			 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
					   , 'MM'  , SUBSTRING(A.ORDER_DATE, 5, 2))
					   , 'DD'  , SUBSTRING(A.ORDER_DATE, 7, 2))
					END)				AS ORDER_DATE
			 , C.CUSTOM_NAME		 AS CUSTOM_NAME
			 , C.CUSTOM_FULL_NAME		 AS CUSTOM_FULL_NAME
			 , D.CODE_NAME		   AS ORDER_PRSN
			 , E.CODE_NAME		   AS ORDER_TYPE
			 , SUM(B.ORDER_O)		AS ORDER_O
			 , A.MONEY_UNIT		  AS MONEY_UNIT
			 , A.EXCHG_RATE_O		AS EXCHG_RATE_O
			 , H.CODE_NAME		   AS RECEIPT_TYPE
			 , '' AS MAIL_REMARK
			 , A.REMARK			  AS REMARK
			 , A.LC_NUM			  AS LC_NUM
			 , A.PROJECT_NO		  AS PROJECT_NO
			 , C2.PRSN_NAME		  AS CUST_PRSN_NAME
			 , ISNULL(A.TO_PRSN, C2.MAIL_ID) AS CUST_MAIL_ID
			 , ISNULL(A.TO_PRSN, C2.MAIL_ID) AS REAL_MAIL_ID
			 , A.REF_PRSN			AS CUST_MAIL_ID_REF
			 , A.REF_PRSN			AS REAL_MAIL_ID_REF			 
			 , A.DIV_CODE
			 , A.CUSTOM_CODE
			 , ISNULL(K1.EMAIL_ADDR,K2.CODE_NAME) AS EMAIL_ADDR
			  , CASE WHEN (SELECT COUNT(1)
									FROM BSA100T
									WHERE COMP_CODE = A.COMP_CODE
									AND MAIN_CODE = 'M416'
									AND SUB_CODE != '$'
									AND REF_CODE1 = 'Y') > 0 THEN A.ORDER_NUM + '_' + K3.COMP_NAME +' [' + C.CUSTOM_NAME + ']' + ' 주문서' + '|' + MAX(K5.TOP_ITEM_NAME) + MAX(K4.ORDER_CNT)
						ELSE '발주서'
				 END AS MAIL_SUBJECT
            , 'PURCHASE_ORDER_' +	K3.COMP_ENG_NAME +' [' + C.CUSTOM_NAME + ']' + '_' + A.ORDER_NUM AS MAIL_SUBJECT_ENG
			, C2.FAX_NUM
			, ISNULL(C2.TELEPHONE_NUM1,C2.TELEPHONE_NUM2) AS CUST_TEL_NUM
			, MAX(C2.MAIL_ID)			AS CUST_MAIL_ID2			
		  FROM MPO100T A WITH (NOLOCK)
					   INNER JOIN MPO200T B WITH (NOLOCK)
							   ON A.COMP_CODE = B.COMP_CODE
							  AND A.ORDER_NUM = B.ORDER_NUM
						LEFT JOIN BCM100T C WITH (NOLOCK)
							   ON A.COMP_CODE   = C.COMP_CODE
							  AND A.CUSTOM_CODE = C.CUSTOM_CODE
						LEFT JOIN (
										SELECT COMP_CODE, CUSTOM_CODE, PRSN_NAME, MAIL_ID, SEQ, FAX_NUM, TELEPHONE_NUM1, TELEPHONE_NUM2
										FROM BCM120T A WITH (NOLOCK)
										WHERE COMP_CODE=@CompCode
										AND MAIN_BILL_YN='Y'
										AND SEQ = (SELECT MIN(SEQ) FROM BCM120T WITH (NOLOCK) WHERE COMP_CODE=A.COMP_CODE AND CUSTOM_CODE=A.CUSTOM_CODE)
								  ) C2
							   ON C.COMP_CODE   = C2.COMP_CODE
							  AND C.CUSTOM_CODE = C2.CUSTOM_CODE
						LEFT JOIN BSA100T D WITH (NOLOCK)
							   ON D.MAIN_CODE   = N'M201'
							  AND A.ORDER_PRSN  = D.SUB_CODE
							  AND A.COMP_CODE   = D.COMP_CODE
						LEFT JOIN BSA100T E WITH (NOLOCK)
							   ON E.MAIN_CODE   = N'M001'
							  AND A.ORDER_TYPE  = E.SUB_CODE
							  AND A.COMP_CODE   = E.COMP_CODE
						LEFT JOIN BSA100T F WITH (NOLOCK)
							   ON F.MAIN_CODE	 = N'M007'
							  AND A.AGREE_STATUS  = F.SUB_CODE
							  AND A.COMP_CODE	 = F.COMP_CODE
						LEFT JOIN BSA100T G WITH (NOLOCK)
							   ON G.MAIN_CODE			= N'J013'
							  AND ISNULL(A.MAIL_YN, '2') = G.SUB_CODE
							  AND A.COMP_CODE			= G.COMP_CODE
						LEFT JOIN BSA100T H WITH (NOLOCK)
							   ON H.MAIN_CODE			= N'B038'
							  AND A.RECEIPT_TYPE		 = H.SUB_CODE
							  AND A.COMP_CODE			= H.COMP_CODE
						LEFT JOIN BSA300T K1 WITH(NOLOCK)
							ON K1.COMP_CODE	    = D.COMP_CODE
							AND K1.USER_ID      = D.REF_CODE2
						 LEFT JOIN BSA100T K2 WITH (NOLOCK)
							ON  K2.COMP_CODE	    = A.COMP_CODE
							AND K2.SUB_CODE			!= '$'
							AND K2.MAIN_CODE		= N'M416'
						 LEFT JOIN BOR100T K3 WITH (NOLOCK)
						 	ON K3.COMP_CODE = A.COMP_CODE
						LEFT JOIN (
									  SELECT CASE WHEN COUNT(1) = 1 THEN ''
									              ELSE '외 ' + CONVERT(NVARCHAR(5),COUNT(1) - 1 ) + '건'
									         END  AS ORDER_CNT
											,AA.COMP_CODE
											,AA.ORDER_NUM
											,AA.DIV_CODE
									  FROM MPO200T AA INNER JOIN BPR100T BB ON AA.COMP_CODE = BB.COMP_CODE
																		   AND AA.ITEM_CODE = BB.ITEM_CODE
									  WHERE AA.COMP_CODE = @CompCode
									  GROUP BY AA.COMP_CODE, AA.DIV_CODE, AA.ORDER_NUM
									) K4  ON  B.COMP_CODE = K4.COMP_CODE
										  AND B.ORDER_NUM = K4.ORDER_NUM
					    LEFT JOIN (
									  SELECT AA.COMP_CODE
											,AA.ORDER_NUM
											,AA.DIV_CODE
											,MAX(BB.ITEM_NAME) AS TOP_ITEM_NAME
									  FROM MPO200T AA INNER JOIN BPR100T BB ON AA.COMP_CODE = BB.COMP_CODE
																		   AND AA.ITEM_CODE = BB.ITEM_CODE
									  WHERE AA.COMP_CODE = @CompCode
									    AND AA.ORDER_SEQ = (SELECT MIN(ORDER_SEQ) FROM MPO200T WHERE COMP_CODE = AA.COMP_CODE
																							     AND DIV_CODE  = AA.DIV_CODE
																							     AND ORDER_NUM = AA.ORDER_NUM)
									  GROUP BY AA.COMP_CODE, AA.DIV_CODE, AA.ORDER_NUM
									) K5  ON  B.COMP_CODE = K5.COMP_CODE
										  AND B.ORDER_NUM = K5.ORDER_NUM
		 WHERE
		   	A.COMP_CODE	   = @CompCode
			<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
			AND A.DIV_CODE		= #{DIV_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
			AND A.ORDER_DATE	 &gt;= #{ORDER_DATE_FR}
			</if>
			<if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
			AND A.ORDER_DATE	 &lt;= #{ORDER_DATE_TO}
			</if>
			<!--2021.08 표준화 작업 Start-->
			/* 거래처코드		*/
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE = #{CUSTOM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
			</if>
			<if test="@foren.Ognl@isEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
				AND		(@RefItem       = N'0' AND C.CUSTOM_NAME  LIKE N'%' + #{CUSTOM_NAME} + N'%')
					OR	(@RefItem       = N'1' AND C.CUSTOM_NAME1 LIKE N'%' + #{CUSTOM_NAME} + N'%')
					OR	(@RefItem       = N'2' AND C.CUSTOM_NAME2 LIKE N'%' + #{CUSTOM_NAME} + N'%')
			</if>
			<!--2021.08 표준화 작업 End-->
			<if test="MAIL_YN == &quot;2&quot;">
			AND ISNULL(A.MAIL_YN, '2')  = 'N'	   /*재전송포함하지 않음인 경우/재전송포함인 경우는 조회조건 필요없음*/
			</if>
			<if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
			AND A.ORDER_PRSN	  = #{ORDER_PRSN}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CREATE_LOC)">
			AND #{CREATE_LOC} = '2'
			</if>

		 GROUP BY A.ORDER_NUM, G.CODE_NAME, A.AGREE_STATUS, F.CODE_NAME, A.COMP_CODE , A.ORDER_DATE  , C.CUSTOM_NAME
				, D.CODE_NAME, E.CODE_NAME, H.CODE_NAME, A.MONEY_UNIT, A.EXCHG_RATE_O, A.RECEIPT_TYPE
				, A.REMARK	  , A.LC_NUM	, A.PROJECT_NO, A.MAIL_YN,  C2.PRSN_NAME, C2.MAIL_ID, A.DIV_CODE
				, A.CUSTOM_CODE, C.CUSTOM_FULL_NAME,K1.EMAIL_ADDR, K2.CODE_NAME, K3.COMP_NAME, C2.FAX_NUM, ISNULL(C2.TELEPHONE_NUM1,C2.TELEPHONE_NUM2),K3.COMP_ENG_NAME
				, A.REF_PRSN,  A.TO_PRSN

	   UNION ALL

		SELECT
			   CAST(0 AS BIT)			   AS CHOICE		 /*선택*/
			 , MAX(A.MAIL_YN)			   AS MAIL_YN
			 , MAX(A.AGREE_STATUS)		  AS AGREE_STATUS_CD
			 , MAX(F.CODE_NAME)			 AS AGREE_STATUS_NM
			 , '6'						  AS CREATE_LOC
			 , A.SO_SER_NO				  AS ORDER_NUM
			 , MAX(CASE WHEN ISNULL(A.DATE_DEPART, '') = ''
				THEN ''
			 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DATE_DEPART, 1, 4))
					   , 'MM'  , SUBSTRING(A.DATE_DEPART, 5, 2))
					   , 'DD'  , SUBSTRING(A.DATE_DEPART, 7, 2)) END) AS ORDER_DATE
			 , MAX(C.CUSTOM_NAME)		  AS CUSTOM_NAME
			 , MAX(C.CUSTOM_FULL_NAME)	 AS CUSTOM_FULL_NAME
			 , MAX(D.CODE_NAME)			AS ORDER_PRSN
			 , ''						  AS ORDER_TYPE
			 , SUM(B.SO_AMT)			   AS ORDER_O
			 , MAX(A.AMT_UNIT)			 AS MONEY_UNIT
			 , MAX(A.EXCHANGE_RATE)		AS EXCHG_RATE_O
			 , MAX(E.CODE_NAME)			AS RECEIPT_TYPE
			 , '' AS MAIL_REMARK
			 , MAX(A.FREE_TXT1)			AS REMARK
			 , ''						 AS LC_NUM
			 , MAX(A.PROJECT_NO)		 AS PROJECT_NO
			 , MAX(C2.PRSN_NAME)		 AS CUST_PRSN_NAME
			 , ISNULL(MAX(A.TO_PRSN), MAX(C2.MAIL_ID)) AS CUST_MAIL_ID
			 , ISNULL(MAX(A.TO_PRSN), MAX(C2.MAIL_ID)) AS REAL_MAIL_ID	
			 , MAX(A.REF_PRSN)			AS CUST_MAIL_ID_REF
			 , MAX(A.REF_PRSN)			AS REAL_MAIL_ID_REF				 
			 , MAX(A.DIV_CODE)			 AS DIV_CODE
			 , MAX(A.EXPORTER)			 AS CUSTOM_CODE
			 , ISNULL(MAX(K1.EMAIL_ADDR), MAX(K2.CODE_NAME))	 AS EMAIL_ADDR
			 , CASE WHEN (SELECT COUNT(1)
								FROM BSA100T
								WHERE COMP_CODE = @CompCode
								AND MAIN_CODE = 'M416'
								AND SUB_CODE != '$'
								AND REF_CODE1 = 'Y') > 0 THEN  MAX(K3.COMP_NAME) + ' [' +  MAX(C.CUSTOM_NAME) + '] ' + '주문서'
					   ELSE '발주서'
				END AS MAIL_SUBJECT
			 ,'PURCHASE_ORDER_' +	MAX(K3.COMP_ENG_NAME) +' [' + MAX(C.CUSTOM_NAME) + ']' + '_' + A.SO_SER_NO AS MAIL_SUBJECT_ENG
			 , MAX(C2.FAX_NUM)			AS FAX_NUM
			 , MAX(C2.TELEPHONE_NUM1)	AS CUST_TEL_NUM
			 , MAX(C2.MAIL_ID)			AS CUST_MAIL_ID2
	  FROM	   TIA100T A WITH(NOLOCK)
	  INNER JOIN TIA110T B WITH(NOLOCK) ON A.COMP_CODE   = B.COMP_CODE
								  AND A.DIV_CODE	= B.DIV_CODE
								  AND A.SO_SER_NO   = B.SO_SER_NO
	  INNER JOIN BCM100T C WITH(NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
									 AND C.CUSTOM_CODE = A.EXPORTER
	  LEFT  JOIN BCM120T C2 WITH(NOLOCK) ON C2.COMP_CODE   = A.COMP_CODE
										 AND C2.CUSTOM_CODE = A.EXPORTER
	  LEFT  JOIN BSA100T D WITH(NOLOCK) ON D.MAIN_CODE   = N'M201'
								  AND A.IMPORT_NM   = D.SUB_CODE
								  AND A.COMP_CODE   = D.COMP_CODE
	  LEFT  JOIN BSA100T E WITH(NOLOCK) ON E.MAIN_CODE  = N'T016'
								  AND A.PAY_METHODE = E.SUB_CODE
								  AND A.COMP_CODE   = E.COMP_CODE
	  LEFT  JOIN BSA100T F WITH(NOLOCK) ON F.MAIN_CODE	= N'M007'
								  AND A.AGREE_STATUS = F.SUB_CODE
								  AND A.COMP_CODE	= F.COMP_CODE
	  LEFT  JOIN BSA100T G WITH(NOLOCK) ON G.MAIN_CODE	= N'J013'
								  AND ISNULL('', '2') = G.SUB_CODE
								  AND A.COMP_CODE	 = G.COMP_CODE
	  LEFT JOIN BSA300T K1 WITH(NOLOCK)
							ON K1.COMP_CODE	    = D.COMP_CODE
							AND K1.USER_ID      = D.REF_CODE2
	 LEFT JOIN BSA100T K2 WITH (NOLOCK)
							ON  K2.COMP_CODE	    = A.COMP_CODE
							AND K2.SUB_CODE			!= '$'
							AND K2.MAIN_CODE		= N'M416'
	LEFT JOIN BOR100T K3 WITH (NOLOCK) ON K3.COMP_CODE = A.COMP_CODE

	  WHERE A.COMP_CODE	   = @CompCode
		<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		AND A.DIV_CODE		= #{DIV_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
		AND A.DATE_DEPART	 &gt;= #{ORDER_DATE_FR}
		</if>
		<if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
		AND A.DATE_DEPART	 &lt;= #{ORDER_DATE_TO}
		</if>
		<!--2021.08 표준화 작업 Start-->
		/* 거래처코드		*/
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND A.EXPORTER = #{CUSTOM_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
			AND A.EXPORTER LIKE #{CUSTOM_CODE} + '%'
		</if>
		<if test="@foren.Ognl@isEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND		(@RefItem       = N'0' AND C.CUSTOM_NAME  LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'1' AND C.CUSTOM_NAME1 LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'2' AND C.CUSTOM_NAME2 LIKE N'%' + #{CUSTOM_NAME} + N'%')
		</if>
		<!--2021.08 표준화 작업 End-->
		<if test="MAIL_YN == &quot;2&quot;">
		AND ISNULL(A.MAIL_YN, '2')  = 'N'	   /*재전송포함하지 않음인 경우/재전송포함인 경우는 조회조건 필요없음*/
		</if>
		<if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
		AND A.IMPORT_NM	  = #{ORDER_PRSN}
		</if>

		<if test="@foren.Ognl@isNotEmpty(CREATE_LOC)">
		AND #{CREATE_LOC} = '6'
		</if>

	 GROUP BY A.SO_SER_NO

	 SET NOCOUNT OFF
	 SET ARITHABORT OFF

	END
	</select>


	<select id="mpo150skrvServiceImpl.selectList2" parameterType="Map" resultType="rMap">
		--mpo150skrv.Cmpo150skrv[fnMpo150QStd1]query02
		SELECT A.ORDER_SEQ		AS ORDER_SEQ
			 , A.ITEM_CODE		AS ITEM_CODE
			 , B.ITEM_NAME		AS ITEM_NAME
			 , B.SPEC			 AS SPEC
			 , B.STOCK_UNIT	   AS STOCK_UNIT
			 , A.ORDER_UNIT_Q	 AS ORDER_UNIT_Q
			 , A.ORDER_UNIT	   AS ORDER_UNIT
			 , E.CODE_NAME		AS UNIT_PRICE_TYPE
			 , A.ORDER_UNIT_P	 AS ORDER_UNIT_P
			 , A.ORDER_O		  AS ORDER_O
			 , A.DVRY_DATE		AS DVRY_DATE
			 , F.TREE_NAME		AS WH_CODE
			 , A.TRNS_RATE		AS TRNS_RATE
			 , A.ORDER_Q		  AS ORDER_Q
			 , C.CODE_NAME		AS CONTROL_STATUS
			 , A.ORDER_REQ_NUM	AS ORDER_REQ_NUM
			 , D.CODE_NAME		AS INSPEC_FLAG
			 , A.REMARK		   AS REMARK
			 , ISNULL(G.DIV_CODE, '')	AS MY_CUSTOM_CODE	  --사업장코드
			 , ISNULL(G.DIV_NAME, '')	AS MY_CUSTOM_NAME	  --상호
			 , ISNULL(G.REPRE_NAME, '')  AS MY_TOP_NAME		  --대표자
			 , ISNULL(G.COMP_TYPE, '')   AS COMP_TYPE		  --업태
			 , ISNULL(G.COMP_CLASS, '')  AS COMP_CLASS		  --종목
			 , CASE ISNULL(G.COMPANY_NUM,'')
				 WHEN '' THEN ''
				 ELSE		 SUBSTRING(G.COMPANY_NUM,1,3) + '-'
							 + SUBSTRING(G.COMPANY_NUM,4,2) + '-'
							 + SUBSTRING(G.COMPANY_NUM,6,5)
			   END		  AS MY_COMPANY_NUM		  			--등록번호
			 , G.ZIP_CODE	AS MY_ZIP_CODE		  			--우편번호
			 , G.ADDR AS  MY_ADDR			  				--주소
			 , G.TELEPHON									--전화번호
			 , G.FAX_NUM							 		--팩스
			 , G.EMAIL
			 , A.ORDER_NUM
			 , H.COMP_ENG_NAME
			 , H.REPRE_ENG_NAME
			 , H.ENG_ADDR
			 , I.CODE_NAME        AS ORDER_PRSN
			 , I.CODE_NAME_EN     AS ORDER_PRSN_ENG
			 , H.TELEPHON		  AS COM_TELEPHON
			 , H.EMAIL			  AS COM_EMAIL
			 , H.FAX_NUM          AS COM_FAX_NUM
		  FROM	   MPO200T A WITH(NOLOCK)
	      INNER JOIN MPO100T A1 WITH(NOLOCK) ON A1.COMP_CODE  = A.COMP_CODE
										     AND A1.DIV_CODE   = A.DIV_CODE
										     AND A1.ORDER_NUM  = A.ORDER_NUM
		  INNER JOIN BPR100T B WITH(NOLOCK)ON A.COMP_CODE	  = B.COMP_CODE
										  AND A.ITEM_CODE	  = B.ITEM_CODE
		  LEFT  JOIN BSA100T C WITH(NOLOCK)ON C.MAIN_CODE	  = N'M002'
										  AND A.CONTROL_STATUS = C.SUB_CODE
										  AND A.COMP_CODE	  = C.COMP_CODE
		  LEFT  JOIN BSA100T D WITH(NOLOCK)ON D.MAIN_CODE	  = N'Q002'
										  AND A.INSPEC_FLAG	= D.SUB_CODE
										  AND A.COMP_CODE	  = D.COMP_CODE
		  LEFT  JOIN BSA100T E WITH(NOLOCK)ON E.MAIN_CODE	  = N'M301'
										  AND A.UNIT_PRICE_TYPE= E.SUB_CODE
										  AND A.COMP_CODE	  = E.COMP_CODE
		  INNER JOIN BSA220T F WITH(NOLOCK)ON A.COMP_CODE	  = F.COMP_CODE
										  AND A.WH_CODE		= F.TREE_CODE
		  INNER JOIN BOR120T G WITH(NOLOCK)ON G.COMP_CODE	  = A.COMP_CODE
										  AND  G.DIV_CODE	  = A.DIV_CODE
		  LEFT JOIN BOR100T H WITH(NOLOCK) ON H.COMP_CODE   = A.COMP_CODE
		  LEFT JOIN BSA100T I  WITH (NOLOCK) ON I.COMP_CODE    = A1.COMP_CODE
											 AND I.MAIN_CODE    = N'M201'
                                             AND I.SUB_CODE     = A1.ORDER_PRSN
		 WHERE #{CREATE_LOC} = '2'
		   AND A.COMP_CODE   = #{S_COMP_CODE}
		   AND A.DIV_CODE	 = #{DIV_CODE}
		   AND A.ORDER_NUM   = #{ORDER_NUM}

		UNION ALL

		  SELECT   A.SO_SER		   AS ORDER_SEQ
				 , A.ITEM_CODE		AS ITEM_CODE
				 , B.ITEM_NAME		AS ITEM_NAME
				 , B.SPEC			 AS SPEC
				 , B.STOCK_UNIT	   AS STOCK_UNIT
				 , A.QTY			  AS ORDER_UNIT_Q
				 , A.UNIT			 AS ORDER_UNIT
				 , E.CODE_NAME		AS UNIT_PRICE_TYPE
				 , A.PRICE			AS ORDER_UNIT_P
				 , A.SO_AMT		   AS ORDER_O
				 , A.DELIVERY_DATE	AS DVRY_DATE
				 , ''				 AS WH_CODE
				 , A.TRNS_RATE		AS TRNS_RATE
				 , A.STOCK_UNIT_Q	 AS ORDER_Q
				 , C.CODE_NAME		AS CONTROL_STATUS
				 , A.ORDER_REQ_NUM	AS ORDER_REQ_NUM
				 , D.CODE_NAME		AS INSPEC_FLAG
				 , A.REMARK		   AS REMARK
				 , ISNULL(G.DIV_CODE, '')	AS MY_CUSTOM_CODE	  --사업장코드
				 , ISNULL(G.DIV_NAME, '')	AS MY_CUSTOM_NAME	  --상호
				 , ISNULL(G.REPRE_NAME, '')  AS MY_TOP_NAME		  --대표자
				 , ISNULL(G.COMP_TYPE, '')   AS COMP_TYPE		  --업태
				 , ISNULL(G.COMP_CLASS, '')  AS COMP_CLASS		  --종목
				 , CASE ISNULL(G.COMPANY_NUM,'')
					 WHEN '' THEN ''
					 ELSE		 SUBSTRING(G.COMPANY_NUM,1,3) + '-'
								 + SUBSTRING(G.COMPANY_NUM,4,2) + '-'
								 + SUBSTRING(G.COMPANY_NUM,6,5)
				   END		  AS MY_COMPANY_NUM		  	--등록번호
				 , G.ZIP_CODE	AS MY_ZIP_CODE		  	--우편번호
				 , G.ADDR AS  MY_ADDR			  		--주소
				 , G.TELEPHON							--전화번호
				 , G.FAX_NUM							--팩스
				 , G.EMAIL
				 , A.SO_SER_NO				AS ORDER_NUM
				 , F.COMP_ENG_NAME
				 , F.REPRE_ENG_NAME
				 , F.ENG_ADDR
				 , H.CODE_NAME  AS ORDER_PRSN
				 , H.CODE_NAME_EN AS ORDER_PRSN_ENG
				 , F.TELEPHON		  AS COM_TELEPHON
				 , F.EMAIL			  AS COM_EMAIL
				 , F.FAX_NUM          AS COM_FAX_NUM
		  FROM	   TIA110T A WITH(NOLOCK)
		  INNER JOIN TIA100T A1 WITH(NOLOCK) ON A1.COMP_CODE = A.COMP_CODE
											AND A1.DIV_CODE  = A.DIV_CODE
											AND A1.SO_SER_NO = A.SO_SER_NO
		  INNER JOIN BPR100T B WITH(NOLOCK) ON A.COMP_CODE   = B.COMP_CODE
										   AND A.ITEM_CODE   = B.ITEM_CODE
		  LEFT  JOIN BSA100T C WITH(NOLOCK) ON C.MAIN_CODE   = N'T017'
										   AND A.CLOSE_FLAG  = C.SUB_CODE
										   AND A.COMP_CODE   = C.COMP_CODE
		  LEFT  JOIN BSA100T D WITH(NOLOCK) ON D.MAIN_CODE   = N'Q002'
										   AND A.INSPEC_FLAG = D.SUB_CODE
										   AND A.COMP_CODE   = D.COMP_CODE
		  LEFT  JOIN BSA100T E WITH(NOLOCK)ON E.MAIN_CODE	= N'M301'
										  AND 'Y'			= E.SUB_CODE
										  AND A.COMP_CODE	= E.COMP_CODE
		  INNER JOIN BOR120T G WITH(NOLOCK)ON G.COMP_CODE	  = A.COMP_CODE
										  AND G.DIV_CODE	  = A.DIV_CODE
		  LEFT JOIN BOR100T F WITH(NOLOCK) ON F.COMP_CODE   = A.COMP_CODE
		  LEFT JOIN BSA100T H  WITH (NOLOCK) ON  H.COMP_CODE    = A1.COMP_CODE
											 AND H.MAIN_CODE    = N'M201'
                                             AND H.SUB_CODE     = A1.IMPORT_NM
		 WHERE #{CREATE_LOC} = '6'
		   AND A.COMP_CODE   = #{S_COMP_CODE}
		   AND A.DIV_CODE	 = #{DIV_CODE}
		   AND A.SO_SER_NO   = #{ORDER_NUM}

		 ORDER BY A.ORDER_SEQ, A.ITEM_CODE
	</select>

	<select id="mpo150skrvServiceImpl.selectList_yp" parameterType="Map" resultType="rMap">
		SELECT
			   ISNULL(A.ORDER_NUM, '')		AS ORDER_NUM
--			 , ISNULL(A.ORDER_SEQ, '')		AS ORDER_SEQ
			 , ROW_NUMBER() OVER(ORDER BY A.ORDER_NUM, A.DVRY_DATE, A.ORDER_SEQ)  AS ORDER_SEQ
			 , ISNULL(H.CODE_NAME, '')		AS ORDER_PRSN
			 , ISNULL(A2.ORDER_DATE, '')	  AS ORDER_DATE
			 , ISNULL(I.CUSTOM_NAME, '')	  AS CUSTOM_NAME
			 , ISNULL(I.CUSTOM_FULL_NAME,'')		 AS CUSTOM_FULL_NAME
			 , ISNULL(I.TELEPHON, '')		  AS CUST_TEL_PHON
			 , ISNULL(I.FAX_NUM, '')		   AS CUST_FAX_NUM
			 , ISNULL(A.ITEM_CODE, '')		AS ITEM_CODE
			 , ISNULL(B.ITEM_NAME, '')		AS ITEM_NAME
			 , ISNULL(B.SPEC, '')			 AS SPEC
			 , ISNULL(B.STOCK_UNIT, '')	   AS STOCK_UNIT
			 , ISNULL(A.ORDER_UNIT_Q, '')	 AS ORDER_UNIT_Q
			 , ISNULL(A.ORDER_UNIT, '')	   AS ORDER_UNIT
			 , ISNULL(E.CODE_NAME, '')		AS UNIT_PRICE_TYPE
			 , ISNULL(A.ORDER_UNIT_P, 0)	 AS ORDER_UNIT_P
			 , ISNULL(A.ORDER_O, 0)		  AS ORDER_O
			 , ISNULL(A.DVRY_DATE, '')		AS DVRY_DATE
			 , ISNULL(F.TREE_NAME, '')		AS WH_CODE
			 , ISNULL(A.TRNS_RATE, 1)		AS TRNS_RATE
			 , ISNULL(A.ORDER_Q, 0)		  AS ORDER_Q
			 , ISNULL(C.CODE_NAME, '')		AS CONTROL_STATUS
			 , ISNULL(A.ORDER_REQ_NUM, '')	AS ORDER_REQ_NUM
			 , ISNULL(D.CODE_NAME, '')		AS INSPEC_FLAG
			 , ISNULL(A.REMARK, '')		   AS REMARK
			 , ISNULL(A2.REMARK, '')		  AS M_REMARK
			 , ISNULL(G.DIV_CODE, '')	AS MY_CUSTOM_CODE	  --사업장코드
			 , ISNULL(G.DIV_NAME, '')	AS MY_CUSTOM_NAME	  --상호
			 , ISNULL(G.REPRE_NAME, '')  AS MY_TOP_NAME		 --대표자
			 , ISNULL(G.COMP_TYPE, '')   AS COMP_TYPE				   --업태
			 , ISNULL(G.COMP_CLASS, '')  AS COMP_CLASS					 --종목
			 , CASE ISNULL(G.COMPANY_NUM,'')
				 WHEN '' THEN ''
				 ELSE		 SUBSTRING(G.COMPANY_NUM,1,3) + '-'
							 + SUBSTRING(G.COMPANY_NUM,4,2) + '-'
							 + SUBSTRING(G.COMPANY_NUM,6,5)
			 END		  AS MY_COMPANY_NUM		  --등록번호
			 , G.ZIP_CODE	AS MY_ZIP_CODE		  --우편번호
			 , G.ADDR AS  MY_ADDR			  --주소
			 , G.TELEPHON							--전화번호
			 , G.FAX_NUM							 --팩스
			 , J.ADDR			 AS IN_DIV_ADDR				--입고사업장 주소
			 , J.DIV_NAME		 AS IN_DIV_NAME				--입고사업장 명
			 , K.REF_CODE5		 AS RESPONSIBILITY_PHONE --구매담당자 전화번호
			 , K1.EMAIL_ADDR
		  FROM	   MPO200T A WITH(NOLOCK)
		  INNER JOIN MPO100T A2 WITH (NOLOCK)ON A2.COMP_CODE   = A.COMP_CODE
											AND A2.DIV_CODE	= A.DIV_CODE
											AND A2.CUSTOM_CODE = A.CUSTOM_CODE
											AND A2.ORDER_NUM   = A.ORDER_NUM
		  INNER JOIN BPR100T B WITH(NOLOCK)ON A.COMP_CODE	  = B.COMP_CODE
										  AND A.ITEM_CODE	  = B.ITEM_CODE
		  LEFT  JOIN BSA100T C WITH(NOLOCK)ON C.MAIN_CODE	  = N'M002'
										  AND A.CONTROL_STATUS = C.SUB_CODE
										  AND A.COMP_CODE	  = C.COMP_CODE
		  LEFT  JOIN BSA100T D WITH(NOLOCK)ON D.MAIN_CODE	  = N'Q002'
										  AND A.INSPEC_FLAG	= D.SUB_CODE
										  AND A.COMP_CODE	  = D.COMP_CODE
		  LEFT  JOIN BSA100T E WITH(NOLOCK)ON E.MAIN_CODE	  = N'M301'
										  AND A.UNIT_PRICE_TYPE= E.SUB_CODE
										  AND A.COMP_CODE	  = E.COMP_CODE
		  INNER JOIN BSA220T F WITH(NOLOCK)ON A.COMP_CODE	  = F.COMP_CODE
										  AND A.WH_CODE		= F.TREE_CODE
		  INNER JOIN BOR120T G WITH(NOLOCK)ON G.COMP_CODE	  = A.COMP_CODE
										  AND G.DIV_CODE	   = A.DIV_CODE
		  LEFT JOIN  BSA100T H WITH(NOLOCK)ON H.COMP_CODE	  = A.COMP_CODE
										  AND H.MAIN_CODE	  = 'M201'
										  AND H.SUB_CODE	   = A2.ORDER_PRSN
		  INNER JOIN BCM100T I WITH(NOLOCK)ON I.COMP_CODE	  = A.COMP_CODE
										  AND I.CUSTOM_CODE	   = A.CUSTOM_CODE
		 INNER JOIN BOR120T J WITH(NOLOCK)ON J.COMP_CODE	  = A.COMP_CODE
										  AND J.DIV_CODE	  = A.IN_DIV_CODE
		 LEFT  JOIN BSA100T K WITH(NOLOCK)ON A.COMP_CODE	  = K.COMP_CODE
		 								  AND K.MAIN_CODE	  = N'M201'
										  AND K.SUB_CODE	 != '$'
										  AND K.SUB_CODE	  = A2.ORDER_PRSN
		 LEFT JOIN BSA300T K1 WITH(NOLOCK) ON K1.COMP_CODE	  = K.COMP_CODE
										  AND K1.USER_ID      = K.REF_CODE2
		 WHERE #{CREATE_LOC} = '2'
		   AND A.COMP_CODE   = #{S_COMP_CODE}
		   AND A.DIV_CODE	= #{DIV_CODE}
		   AND A.ORDER_NUM   = #{ORDER_NUM}
		 ORDER BY A.COMP_CODE, A.ORDER_NUM,  A.DVRY_DATE, A.ORDER_SEQ
	</select>

	<update id = "mpo150skrvServiceImpl.updateMailYn" parameterType="Map">
	IF #{CREATE_LOC} = '2'
	  BEGIN
		UPDATE MPO100T
		   SET MAIL_YN  = 'Y'
		     , REF_PRSN = #{CUST_MAIL_ID_REF}
		     , TO_PRSN  = #{CUST_MAIL_ID}
		 WHERE COMP_CODE   = #{S_COMP_CODE}
		   AND DIV_CODE	= #{DIV_CODE}
		   AND CUSTOM_CODE = #{CUSTOM_CODE}
		   AND ORDER_NUM   = #{ORDER_NUM}
	  END
	  ELSE
		BEGIN
		   UPDATE TIA100T
			  SET MAIL_YN  = 'Y'
		        , REF_PRSN = #{CUST_MAIL_ID_REF}
		        , TO_PRSN  = #{CUST_MAIL_ID}			  
			WHERE COMP_CODE   = #{S_COMP_CODE}
			  AND DIV_CODE	= #{DIV_CODE}
			  AND EXPORTER	= #{CUSTOM_CODE}
			  AND SO_SER_NO   = #{ORDER_NUM}
	   END
	</update>

	<select id="mpo150skrvServiceImpl.getCustomFormYn" parameterType="Map" resultType="int">
		SELECT  COUNT(1)
		FROM  BSA100T WITH (NOLOCK)
		WHERE COMP_CODE =  #{S_COMP_CODE}
		  AND SUB_CODE  != '$'
		  AND MAIN_CODE = N'M416'
		  AND REF_CODE1 = 'Y'
	</select>

	<select id="mpo150skrvServiceImpl.getPdfFilePath" parameterType="Map" resultType="rMap">
		SELECT  REF_CODE2 		AS PDF_DOWN_PATH
		 FROM  BSA100T WITH (NOLOCK)
		WHERE COMP_CODE = #{S_COMP_CODE}
		  AND SUB_CODE  != '$'
		  AND MAIN_CODE = N'M416'
	</select>

	<select id="mpo150skrvServiceImpl.mainReport" parameterType="Map" resultType="rMap">
		 DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                  , @PRINT_USER          NVARCHAR(100)            --(선택) 출력자
                  , @VIEW_PRINT_INFO_YN  NVARCHAR(01)             --인쇄출력정보 여부
				  , @MAIL_FORM		NVARCHAR(10)
            SET @CompCode  = #{S_COMP_CODE}
            SET @UserId    = #{S_USER_ID}
            SET @LangType  = #{S_LANG_CODE}
			SET @MAIL_FORM = #{MAIL_FORM}  /* 1: 국문, 2: 영문 */
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            SELECT @PRINT_USER = USER_NAME
              FROM BSA300T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND USER_ID = @UserId

            SELECT @VIEW_PRINT_INFO_YN = SUB_CODE
              FROM BSA100T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = 'B249'
               AND SUB_CODE != '$'
               AND REF_CODE1 = 'Y'

            /* 데이터 조회 */
            SELECT  A.ORDER_NUM
                  , ROW_NUMBER () OVER (PARTITION BY A.ORDER_NUM ORDER BY A.ORDER_NUM, A.DVRY_DATE, A.ORDER_SEQ) AS PRINT_SEQ
                 -- , A.ORDER_SEQ         AS PRINT_SEQ
                  , CASE WHEN @MAIL_FORM='1' OR ISNULL(@MAIL_FORM,'') = '' THEN F.CODE_NAME   ELSE F.CODE_NAME_EN END       AS ORDER_PRSN
                  --20200303 추가
                  , CASE WHEN ISNULL(F.CODE_NAME_EN, '') = '' THEN F.CODE_NAME
                         ELSE ISNULL(F.CODE_NAME_EN, '')
                    END                             AS ORDER_PRSN_EN
                  , D.CUSTOM_NAME
                  , ISNULL(D.TELEPHON, '')          AS CUST_TEL_PHON
                  , ISNULL(D.FAX_NUM, '')           AS CUST_FAX_NUM
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  --, A.WH_CODE
                  , J.TREE_NAME AS WH_CODE
                  , A.ORDER_P
                  , A.REMARK
                  , A2.REMARK       AS MASTER_REMARK
                  , A.PROJECT_NO
                  , (CASE WHEN ISNULL(A2.ORDER_DATE, '') = ''
                          THEN ''
                          ELSE REPLACE(REPLACE(REPLACE('YYYY.MM.DD', 'YYYY', SUBSTRING(A2.ORDER_DATE, 1, 4))
                                                                   , 'MM'  , SUBSTRING(A2.ORDER_DATE, 5, 2))
                                                                   , 'DD'  , SUBSTRING(A2.ORDER_DATE, 7, 2))
                    END)                                                     AS ORDER_DATE
                  , E.DIV_CODE    AS MY_CUSTOM_CODE      --사업장코드
                  , E.DIV_NAME    AS MY_CUSTOM_NAME      --상호
                  , E.REPRE_NAME  AS MY_TOP_NAME         --대표자
                  , E.COMP_TYPE                       --업태
                  , E.COMP_CLASS                      --종목
                  , CASE ISNULL(E.COMPANY_NUM,'')
                    WHEN '' THEN ''
                    ELSE         SUBSTRING(E.COMPANY_NUM,1,3) + '-'
                                + SUBSTRING(E.COMPANY_NUM,4,2) + '-'
                                + SUBSTRING(E.COMPANY_NUM,6,5)
                  END          AS MY_COMPANY_NUM          --등록번호
                  , E.ZIP_CODE    AS MY_ZIP_CODE          --우편번호
                  , E.ADDR AS  MY_ADDR              --주소
                  , E.TELEPHON                            --전화번호
                  , E.FAX_NUM                             --팩스
                  , @PRINT_USER                             AS PRINT_USER                   --출력자 이름
                  , @VIEW_PRINT_INFO_YN                     AS VIEW_PRINT_INFO_YN           --인쇄출력정보 표시여부
                  , (SELECT SUM(S1.ORDER_O) FROM MPO200T S1 WHERE S1.ORDER_NUM = A.ORDER_NUM) AS TOT_O
                  , K.REF_CODE3 AS STD_ITEM_ACCOUNT
				  , C.ITEM_ACCOUNT
				  , K2.PRSN_NAME AS CUST_PRSN_NAME
				  , D.REMARK AS CUSTOM_REMARK
				  , K1.GOOD_STOCK_Q
				  , K3.PAY_DURING
				  , CASE WHEN FLOOR(C.PURCH_LDTIME / 7) = 0 THEN 1 ELSE FLOOR(C.PURCH_LDTIME / 7) END AS DVRY_PERIOD
				  , J.PABSTOCK_YN
				  , ISNULL(K4.CODE_NAME, '익월 말') AS RECEIPT_DAY				--20200317 수정: 없을 경우 익월말
				  , CASE WHEN ISNULL(B.ITEM_NAME2, '') = '' THEN B.ITEM_NAME ELSE B.ITEM_NAME2 END EN_ITEM_NAME
				  , F1.EMAIL_ADDR
				  , (SELECT MAX(DVRY_DATE)
				     FROM MPO200T
					 WHERE COMP_CODE = A.COMP_CODE
					 AND DIV_CODE = A.DIV_CODE
					 AND ORDER_NUM = A.ORDER_NUM) AS MAX_DVRY_DATE
				  , ISNULL(K5.MONTH_AVG_Q, 0) AS PRE_INOUT_Q -- 월평균
				  , ISNULL(K5.MONTH_AVG_Q, 0) * (CASE WHEN A2.ORDER_TYPE = '5' THEN 3 ELSE 2 END) AS SAFETY_STOCK_Q -- 안전재고 (전월평균 * 3)  수입:3, 내수:2
		          --20200303 추가: 구매담당자 정보가져오기 위한 로직 추가
		          , ISNULL(Z1.EMAIL_ADDR, Z2.CODE_NAME)    AS ORDER_PRSN_EMAIL_ADDR
		          , ISNULL(Z1.PHONE, Z2.REF_CODE5)         AS ORDER_PRSN_PHONE
		          , ISNULL(K2.TELEPHONE_NUM1, ISNULL(D.TELEPHON, '')) AS TELEPHONE_NUM1
		          , K2.MAIL_ID
		          , D.CUSTOM_FULL_NAME
		          --20200407 수정: 메인 화폐단위로 변경 - A. -> A2.
		          , A2.MONEY_UNIT

				  -- 20210723 추가 - 멕아이씨에스 프로젝트에서 사용
				  , D.CUSTOM_SALE_PRSN
				  , F2.CODE_NAME	AS RECEIPT_DAY
				  , F3.CODE_NAME	AS DELIVERY_METH
				  
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN MPO100T A2 WITH (NOLOCK)ON A2.COMP_CODE = A.COMP_CODE
                                                      AND A2.DIV_CODE = A.DIV_CODE
                                                      AND A2.CUSTOM_CODE = A.CUSTOM_CODE
                                                      AND A2.ORDER_NUM = A.ORDER_NUM
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BCM100T D WITH (NOLOCK) ON D.COMP_CODE = A.COMP_CODE
                                                      AND D.CUSTOM_CODE = A.CUSTOM_CODE
                    INNER JOIN BOR120T E  WITH (NOLOCK)ON E.COMP_CODE   = A.COMP_CODE
                                                      AND E.DIV_CODE    = A.DIV_CODE
                     LEFT JOIN BSA100T F WITH (NOLOCK) ON F.COMP_CODE   = A.COMP_CODE
                                                      AND F.MAIN_CODE   = 'M201'
                                                      AND F.SUB_CODE    = A2.ORDER_PRSN
					 LEFT JOIN BSA300T F1 WITH (NOLOCK)	ON F1.COMP_CODE = F.COMP_CODE
													   AND F1.USER_ID   = F.REF_CODE2
                     LEFT JOIN BSA100T I WITH (NOLOCK) ON I.COMP_CODE   = A.COMP_CODE
                                                      AND I.SUB_CODE   != N'$'
                                                      AND I.MAIN_CODE   = 'M008'
                                                      AND I.REF_CODE1   = 'Y'
                     LEFT JOIN BSA220T J WITH (NOLOCK) ON J.COMP_CODE   = A.COMP_CODE
                                                      AND J.TREE_CODE   = A.WH_CODE
					 LEFT JOIN BSA100T K WITH (NOLOCK) ON K.COMP_CODE	= A.COMP_CODE
													  AND K.MAIN_CODE   = 'B020'
													  AND K.SUB_CODE    = C.ITEM_ACCOUNT
				     LEFT  JOIN ( SELECT COMP_CODE, CUSTOM_CODE, PRSN_NAME, MAIL_ID, SEQ, TELEPHONE_NUM1
                                   FROM BCM120T A WITH (NOLOCK)
                                  WHERE COMP_CODE    = @CompCode
                                    AND MAIN_BILL_YN = 'Y'
                                    AND SEQ = (SELECT MIN(SEQ) FROM BCM120T WITH (NOLOCK) WHERE COMP_CODE=A.COMP_CODE AND CUSTOM_CODE=A.CUSTOM_CODE)
                                ) K2  ON K2.COMP_CODE     = A.COMP_CODE
                                     AND K2.CUSTOM_CODE   = A.CUSTOM_CODE
				 	 LEFT JOIN BIV100T K1 WITH (NOLOCK) ON K1.COMP_CODE  = A.COMP_CODE
												   		AND K1.DIV_CODE  = A.IN_DIV_CODE
												   		AND K1.WH_CODE   = A.WH_CODE
												  		AND K1.ITEM_CODE = A.ITEM_CODE
					  LEFT JOIN BCM103T K3 WITH (NOLOCK) ON K3.COMP_CODE = A.COMP_CODE
													   AND K3.CUSTOM_CODE = A.CUSTOM_CODE
					  LEFT JOIN BSA100T K4 WITH (NOLOCK) ON K4.COMP_CODE = A.COMP_CODE
													    AND K4.MAIN_CODE   = 'B034'
													    AND K4.SUB_CODE    = D.RECEIPT_DAY
					  LEFT JOIN (
									SELECT SUM(INOUT_Q) / 12 AS MONTH_AVG_Q
										 , S1.ITEM_CODE
										 , S1.COMP_CODE
										 , S1.DIV_CODE
									FROM BTR100T S1 WITH (NOLOCK)
										 INNER JOIN BSA220T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.TYPE_LEVEL AND S1.WH_CODE=S2.TREE_CODE
									WHERE S1.COMP_CODE=@CompCode
									AND S1.DIV_CODE=#{DIV_CODE}
									AND S2.GROUP_CD='10'	--원자재창고 출고건
									AND S1.INOUT_TYPE='2'
									AND   LEFT(S1.INOUT_DATE, 6) BETWEEN LEFT(CONVERT(VARCHAR(8), DATEADD(M, -12, GETDATE()), 112),6)
							 										 AND LEFT(CONVERT(VARCHAR(8), DATEADD(M, -1, GETDATE()), 112),6)
									GROUP BY S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE									
								) K5 ON K5.COMP_CODE = A.COMP_CODE
								    AND K5.DIV_CODE  = A.IN_DIV_CODE
								    AND K5.ITEM_CODE = A.ITEM_CODE
      --20200303 추가: 구매담당자 정보가져오기 위한 로직 추가
      LEFT JOIN BSA300T Z1 WITH(NOLOCK) ON Z1.COMP_CODE    = F.COMP_CODE
                                       AND Z1.USER_ID      = F.REF_CODE2
      LEFT JOIN BSA100T Z2 WITH(NOLOCK) ON Z2.COMP_CODE    = A.COMP_CODE
                                       AND Z2.SUB_CODE    != '$'
                                       AND Z2.MAIN_CODE    = 'M416'
                     LEFT JOIN BSA100T F2 WITH (NOLOCK) ON F2.COMP_CODE  = D.COMP_CODE
                                                       AND F2.MAIN_CODE  = 'B034'
                                                       AND F2.SUB_CODE   = D.RECEIPT_DAY
                     LEFT JOIN BSA100T F3 WITH (NOLOCK) ON F3.COMP_CODE  = D.COMP_CODE
                                                       AND F3.MAIN_CODE  = 'B260'
                                                       AND F3.SUB_CODE   = D.DELIVERY_METH
            WHERE   A.COMP_CODE = @CompCode
            AND A.DIV_CODE = #{DIV_CODE}

            AND ((I.SUB_CODE = '1' AND A2.AGREE_STATUS = '2')
                   OR
                 (I.SUB_CODE = '1' AND A2.AGREE_STATUS = '1' AND ISNULL(I.REF_CODE3,'N') = 'Y')
                  OR
                 (I.SUB_CODE = '2' AND A2.AGREE_STATUS IS NOT NULL))

          --  AND A2.ORDER_TYPE  != N'4'    /*외주*/
          --  AND A.CONTROL_STATUS NOT IN ('8', '9')
			AND

			<foreach collection="ORDER_NUMS" item="item" separator="OR" close=")" open="(">
				   (  A.ORDER_NUM = '${item.ORDER_NUM}')
			</foreach>
            ORDER BY A.ORDER_NUM, A.DVRY_DATE, A.ORDER_SEQ
            --ORDER BY A.ORDER_NUM, A.ORDER_SEQ, A.ITEM_CODE

	</select>

	<select id="mpo150skrvServiceImpl.mainReport2" parameterType="Map" resultType="rMap">
		 DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                  , @PRINT_USER          NVARCHAR(100)            --(선택) 출력자
                  , @VIEW_PRINT_INFO_YN  NVARCHAR(01)             --인쇄출력정보 여부
				  , @MAIL_FORM		NVARCHAR(10)
            SET @CompCode  = #{S_COMP_CODE}
            SET @UserId    = #{S_USER_ID}
            SET @LangType  = #{S_LANG_CODE}
			SET @MAIL_FORM = #{MAIL_FORM}  /* 1: 국문, 2: 영문 */
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            SELECT @PRINT_USER = USER_NAME
              FROM BSA300T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND USER_ID = @UserId

            SELECT @VIEW_PRINT_INFO_YN = SUB_CODE
              FROM BSA100T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = 'B249'
               AND SUB_CODE != '$'
               AND REF_CODE1 = 'Y'

		CREATE TABLE #TEMP_TABLE
		(
		        ORDER_NUM          NVARCHAR(100)     NOT NULL
		    ,   ORDER_PRSN         NVARCHAR(100)     NULL
		)


		<foreach collection="ORDER_PRSNS" item="item" separator="" close="" open="">


			INSERT INTO #TEMP_TABLE (

				ORDER_NUM
			   ,ORDER_PRSN
			)VALUES(
				 '${item.ORDER_NUM}'
				,'${item.ORDER_PRSN_EDIT}'
			)

		</foreach>

            /* 데이터 조회 */
            SELECT  A.ORDER_NUM
                  , ROW_NUMBER () OVER (PARTITION BY A.ORDER_NUM ORDER BY A.ORDER_NUM, A.DVRY_DATE, A.ORDER_SEQ) AS PRINT_SEQ
                 -- , A.ORDER_SEQ         AS PRINT_SEQ
                  , CASE WHEN @MAIL_FORM='1' OR ISNULL(@MAIL_FORM,'') = '' THEN ISNULL(Z3.ORDER_PRSN, F.CODE_NAME)
                  							   ELSE F.CODE_NAME_EN
                  						  END      															AS ORDER_PRSN
                  --20200303 추가
                  , CASE WHEN ISNULL(F.CODE_NAME_EN, '') = '' THEN F.CODE_NAME
                         ELSE ISNULL(F.CODE_NAME_EN, '')
                    END                             AS ORDER_PRSN_EN
                  , D.CUSTOM_NAME
                  , ISNULL(D.TELEPHON, '')          AS CUST_TEL_PHON
                  , ISNULL(D.FAX_NUM, '')           AS CUST_FAX_NUM
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  --, A.WH_CODE
                  , J.TREE_NAME AS WH_CODE
                  , A.ORDER_P
                  , A.REMARK
                  , A2.REMARK       AS MASTER_REMARK
                  , A.PROJECT_NO
                  , (CASE WHEN ISNULL(A2.ORDER_DATE, '') = ''
                          THEN ''
                          ELSE REPLACE(REPLACE(REPLACE('YYYY.MM.DD', 'YYYY', SUBSTRING(A2.ORDER_DATE, 1, 4))
                                                                   , 'MM'  , SUBSTRING(A2.ORDER_DATE, 5, 2))
                                                                   , 'DD'  , SUBSTRING(A2.ORDER_DATE, 7, 2))
                    END)                                                     AS ORDER_DATE
                  , E.DIV_CODE    AS MY_CUSTOM_CODE      --사업장코드
                  , E.DIV_NAME    AS MY_CUSTOM_NAME      --상호
                  , E.REPRE_NAME  AS MY_TOP_NAME         --대표자
                  , E.COMP_TYPE                       --업태
                  , E.COMP_CLASS                      --종목
                  , CASE ISNULL(E.COMPANY_NUM,'')
                    WHEN '' THEN ''
                    ELSE         SUBSTRING(E.COMPANY_NUM,1,3) + '-'
                                + SUBSTRING(E.COMPANY_NUM,4,2) + '-'
                                + SUBSTRING(E.COMPANY_NUM,6,5)
                  END          AS MY_COMPANY_NUM          --등록번호
                  , E.ZIP_CODE    AS MY_ZIP_CODE          --우편번호
                  , E.ADDR AS  MY_ADDR              --주소
                  , E.TELEPHON                            --전화번호
                  , E.FAX_NUM                             --팩스
                  , @PRINT_USER                             AS PRINT_USER                   --출력자 이름
                  , @VIEW_PRINT_INFO_YN                     AS VIEW_PRINT_INFO_YN           --인쇄출력정보 표시여부
                  , (SELECT SUM(S1.ORDER_O) FROM MPO200T S1 WHERE S1.ORDER_NUM = A.ORDER_NUM) AS TOT_O
                  , K.REF_CODE3 AS STD_ITEM_ACCOUNT
				  , C.ITEM_ACCOUNT
				  , K2.PRSN_NAME AS CUST_PRSN_NAME
				  , D.REMARK AS CUSTOM_REMARK
				  , K1.GOOD_STOCK_Q
				  , K3.PAY_DURING
				  , CASE WHEN FLOOR(C.PURCH_LDTIME / 7) = 0 THEN 1 ELSE FLOOR(C.PURCH_LDTIME / 7) END AS DVRY_PERIOD
				  , J.PABSTOCK_YN
				  , ISNULL(K4.CODE_NAME, '익월 말') AS RECEIPT_DAY				--20200317 수정: 없을 경우 익월말
				  , CASE WHEN ISNULL(B.ITEM_NAME2, '') = '' THEN B.ITEM_NAME ELSE B.ITEM_NAME2 END EN_ITEM_NAME
				  , F1.EMAIL_ADDR
				  , (SELECT MAX(DVRY_DATE)
				     FROM MPO200T
					 WHERE COMP_CODE = A.COMP_CODE
					 AND DIV_CODE = A.DIV_CODE
					 AND ORDER_NUM = A.ORDER_NUM) AS MAX_DVRY_DATE
				  , ISNULL(K5.MONTH_AVG_Q, 0) AS PRE_INOUT_Q -- 월평균
				  , ISNULL(K5.MONTH_AVG_Q, 0) * (CASE WHEN A2.ORDER_TYPE = '5' THEN 3 ELSE 2 END) AS SAFETY_STOCK_Q -- 안전재고 (전월평균 * 3)
		          --20200303 추가: 구매담당자 정보가져오기 위한 로직 추가
		          , ISNULL(Z1.EMAIL_ADDR, Z2.CODE_NAME)    AS ORDER_PRSN_EMAIL_ADDR
		          , ISNULL(Z1.PHONE, Z2.REF_CODE5)         AS ORDER_PRSN_PHONE
		          , ISNULL(K2.TELEPHONE_NUM1, ISNULL(D.TELEPHON, '')) AS TELEPHONE_NUM1
		          , K2.MAIL_ID
		          , D.CUSTOM_FULL_NAME
		          , A.MONEY_UNIT

            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN MPO100T A2 WITH (NOLOCK)ON A2.COMP_CODE = A.COMP_CODE
                                                      AND A2.DIV_CODE = A.DIV_CODE
                                                      AND A2.CUSTOM_CODE = A.CUSTOM_CODE
                                                      AND A2.ORDER_NUM = A.ORDER_NUM
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BCM100T D WITH (NOLOCK) ON D.COMP_CODE = A.COMP_CODE
                                                      AND D.CUSTOM_CODE = A.CUSTOM_CODE
                    INNER JOIN BOR120T E  WITH (NOLOCK)ON E.COMP_CODE   = A.COMP_CODE
                                                      AND E.DIV_CODE    = A.DIV_CODE
                     LEFT JOIN BSA100T F WITH (NOLOCK) ON F.COMP_CODE   = A.COMP_CODE
                                                      AND F.MAIN_CODE   = 'M201'
                                                      AND F.SUB_CODE    = A2.ORDER_PRSN
					 LEFT JOIN BSA300T F1 WITH (NOLOCK)	ON F1.COMP_CODE = F.COMP_CODE
													   AND F1.USER_ID   = F.REF_CODE2
                     LEFT JOIN BSA100T I WITH (NOLOCK) ON I.COMP_CODE   = A.COMP_CODE
                                                      AND I.SUB_CODE   != N'$'
                                                      AND I.MAIN_CODE   = 'M008'
                                                      AND I.REF_CODE1   = 'Y'
                     LEFT JOIN BSA220T J WITH (NOLOCK) ON J.COMP_CODE   = A.COMP_CODE
                                                      AND J.TREE_CODE   = A.WH_CODE
					 LEFT JOIN BSA100T K WITH (NOLOCK) ON K.COMP_CODE	= A.COMP_CODE
													  AND K.MAIN_CODE   = 'B020'
													  AND K.SUB_CODE    = C.ITEM_ACCOUNT
				     LEFT  JOIN ( SELECT COMP_CODE, CUSTOM_CODE, PRSN_NAME, MAIL_ID, SEQ, TELEPHONE_NUM1
                                   FROM BCM120T A WITH (NOLOCK)
                                  WHERE COMP_CODE    = @CompCode
                                    AND MAIN_BILL_YN = 'Y'
                                    AND SEQ = (SELECT MIN(SEQ) FROM BCM120T WITH (NOLOCK) WHERE COMP_CODE=A.COMP_CODE AND CUSTOM_CODE=A.CUSTOM_CODE)
                                ) K2  ON K2.COMP_CODE     = A.COMP_CODE
                                     AND K2.CUSTOM_CODE   = A.CUSTOM_CODE
				 	 LEFT JOIN BIV100T K1 WITH (NOLOCK) ON K1.COMP_CODE  = A.COMP_CODE
												   		AND K1.DIV_CODE  = A.IN_DIV_CODE
												   		AND K1.WH_CODE   = A.WH_CODE
												  		AND K1.ITEM_CODE = A.ITEM_CODE
					  LEFT JOIN BCM103T K3 WITH (NOLOCK) ON K3.COMP_CODE = A.COMP_CODE
													   AND K3.CUSTOM_CODE = A.CUSTOM_CODE
					  LEFT JOIN BSA100T K4 WITH (NOLOCK) ON K4.COMP_CODE = A.COMP_CODE
													    AND K4.MAIN_CODE   = 'B034'
													    AND K4.SUB_CODE    = D.RECEIPT_DAY
					  LEFT JOIN (
									SELECT SUM(INOUT_Q) / 12 AS MONTH_AVG_Q
										 , S1.ITEM_CODE
										 , S1.COMP_CODE
										 , S1.DIV_CODE
									FROM BTR100T S1 WITH (NOLOCK)
										 INNER JOIN BSA220T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.TYPE_LEVEL AND S1.WH_CODE=S2.TREE_CODE
									WHERE S1.COMP_CODE=@CompCode
									AND S1.DIV_CODE=#{DIV_CODE}
									AND S2.GROUP_CD='10'	--원자재창고 출고건
									AND S1.INOUT_TYPE='2'
									AND   LEFT(S1.INOUT_DATE, 6) BETWEEN LEFT(CONVERT(VARCHAR(8), DATEADD(M, -12, GETDATE()), 112),6)
							 										 AND LEFT(CONVERT(VARCHAR(8), DATEADD(M, -1, GETDATE()), 112),6)
									GROUP BY S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE									
								) K5 ON K5.COMP_CODE = A.COMP_CODE
								    AND K5.DIV_CODE  = A.IN_DIV_CODE
								    AND K5.ITEM_CODE = A.ITEM_CODE
      --20200303 추가: 구매담당자 정보가져오기 위한 로직 추가
      LEFT JOIN BSA300T Z1 WITH(NOLOCK) ON Z1.COMP_CODE    = F.COMP_CODE
                                       AND Z1.USER_ID      = F.REF_CODE2
      LEFT JOIN BSA100T Z2 WITH(NOLOCK) ON Z2.COMP_CODE    = A.COMP_CODE
                                       AND Z2.SUB_CODE    != '$'
                                       AND Z2.MAIN_CODE    = 'M416'
	  LEFT JOIN #TEMP_TABLE Z3 WITH(NOLOCK) ON Z3.ORDER_NUM = A.ORDER_NUM
            WHERE   A.COMP_CODE = @CompCode
            AND A.DIV_CODE = #{DIV_CODE}

            AND ((I.SUB_CODE = '1' AND A2.AGREE_STATUS = '2')
                   OR
                 (I.SUB_CODE = '1' AND A2.AGREE_STATUS = '1' AND ISNULL(I.REF_CODE3,'N') = 'Y')
                  OR
                 (I.SUB_CODE = '2' AND A2.AGREE_STATUS IS NOT NULL))

          --  AND A2.ORDER_TYPE  != N'4'    /*외주*/
          --  AND A.CONTROL_STATUS NOT IN ('8', '9')
			AND

			<foreach collection="ORDER_NUMS" item="item" separator="OR" close=")" open="(">
				   (  A.ORDER_NUM = '${item.ORDER_NUM}')
			</foreach>
            ORDER BY A.ORDER_NUM, A.DVRY_DATE, A.ORDER_SEQ
            --ORDER BY A.ORDER_NUM, A.ORDER_SEQ, A.ITEM_CODE
	DROP TABLE   #TEMP_TABLE
	</select>
</mapper>