<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mpo502ukrvServiceImpl">
    <select id="mpo502ukrvServiceImpl.selectOrderPrsn" parameterType="Map" resultType="rMap">
        --mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query08
        SELECT TOP 1 SUB_CODE
        FROM   BSA100T A WITH (NOLOCK)
        WHERE  A.COMP_CODE  = #{S_COMP_CODE}
        AND    A.MAIN_CODE  = N'M201'
        AND    A.SUB_CODE  != N'$'
        AND    A.REF_CODE2  = #{S_USER_ID}
        AND    A.USE_YN     = N'Y'
    </select>

    <select id="mpo502ukrvServiceImpl.selectOrderNumMasterList" parameterType="Map" resultType="rMap">
        /*mpo501ukrv.Cmpo501ukrv pop*/
    BEGIN
        SET NOCOUNT ON
        SET ARITHABORT ON

        DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
              , @UserId      NVARCHAR(100) /* 사용자ID    */
              , @LangType    NVARCHAR(2)  /* 언어구분    */
              , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
              , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

        SET @CompCode = #{S_COMP_CODE}
        SET @UserId   = #{S_USER_ID}
        SET @LangType = #{S_LANG_CODE}

        /* 명칭 참조 유형 */
        SELECT TOP 1 @RefItem = REF_ITEM
          FROM BSA300T WITH (NOLOCK)
         WHERE USER_ID = @UserId

        SET @RefItem = ISNULL(@RefItem, N'0')

        /* 날짜 포맷 유형 설정 */
        SELECT TOP 1 @DateFormat = CODE_NAME
          FROM BSA100T WITH (NOLOCK)
         WHERE COMP_CODE = @CompCode
           AND MAIN_CODE = N'B044'
           AND REF_CODE1 = N'Y'

        SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

        /* 데이터 조회 */
        SELECT  B.CUSTOM_NAME                                                       AS CUSTOM_NAME
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
                                   , 'MM',   SUBSTRING(A.ORDER_DATE, 5, 2))
                                   , 'DD',   SUBSTRING(A.ORDER_DATE, 7, 2))         AS ORDER_DATE
              , A.ORDER_TYPE                                                        AS ORDER_TYPE
              , A.ORDER_NUM                                                         AS ORDER_NUM
              , A.CUSTOM_CODE                                                       AS CUSTOM_CODE

              , A.ORDER_PRSN                                                        AS ORDER_PRSN
              , A.AGREE_STATUS                                                      AS AGREE_STATUS
              , A.AGREE_PRSN                                                        AS AGREE_PRSN
              , C.USER_NAME                                                         AS AGREE_PRSN_NAME
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                   , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                   , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))         AS AGREE_DATE
              , A.MONEY_UNIT                                                        AS MONEY_UNIT
              , A.LC_NUM                                                            AS LC_NUM
              , A.RECEIPT_TYPE                                                      AS RECEIPT_TYPE
              , A.REMARK                                                            AS REMARK
              , A.EXCHG_RATE_O                                                      AS EXCHG_RATE_O
              , A.DRAFT_YN                                                          AS DRAFT_YN
              , A.DIV_CODE                                                          AS DIV_CODE
              , A.PROJECT_NO                                                        AS PROJECT_NO
              , D.COMP_NAME
        FROM                MPO100T A WITH  (NOLOCK)
                INNER JOIN  BCM100T B WITH  (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                    AND B.CUSTOM_CODE = A.CUSTOM_CODE
                LEFT  JOIN  BSA300T C WITH  (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
                                                    AND C.USER_ID     = A.AGREE_PRSN
                LEFT  JOIN  BOR100T D WITH  (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE
                INNER JOIN  MPO200T E WITH  (NOLOCK) ON E.COMP_CODE   = A.COMP_CODE
                                                    AND E.DIV_CODE    = A.DIV_CODE
                                                    AND E.ORDER_NUM   = A.ORDER_NUM
                                                    AND E.CUSTOM_CODE = A.CUSTOM_CODE
        WHERE   A.COMP_CODE    = @CompCode
        -- AND     A.ORDER_TYPE  != N'4'
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
        AND   A.DIV_CODE       = #{DIV_CODE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
        AND   A.ORDER_TYPE     = #{ORDER_TYPE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
        AND   A.ORDER_DATE    &gt;= #{ORDER_DATE_FR}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
        AND   A.ORDER_DATE    &lt;= #{ORDER_DATE_TO}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
        AND   A.ORDER_PRSN     = #{ORDER_PRSN}
        </if>
        
		<!--2021.08 표준화 작업 Start-->
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND A.CUSTOM_CODE = #{CUSTOM_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
			AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
		</if>
		<if test="@foren.Ognl@isEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND		(@RefItem       = N'0' AND B.CUSTOM_NAME  LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'1' AND B.CUSTOM_NAME1 LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'2' AND B.CUSTOM_NAME2 LIKE N'%' + #{CUSTOM_NAME} + N'%')
		</if>
		<!--2021.08 표준화 작업 End-->

        <if test="@foren.Ognl@isNotEmpty(AGREE_STATUS)">
        AND   A.AGREE_STATUS   = #{AGREE_STATUS}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
        AND   A.ORDER_NUM      = #{ORDER_NUM}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PJT_CODE)">
        AND   A.PROJECT_NO     = #{PJT_CODE}
        </if>   

    GROUP BY   B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM, A.CUSTOM_CODE
            , A.DEPT_CODE, A.ORDER_PRSN, A.AGREE_STATUS
            , A.AGREE_PRSN, C.USER_NAME, A.AGREE_DATE, A.MONEY_UNIT, A.LC_NUM
            , A.RECEIPT_TYPE, A.REMARK, A.EXCHG_RATE_O, A.DRAFT_YN, A.DIV_CODE
            , A.PROJECT_NO, D.COMP_NAME

        ORDER BY B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM

        SET ARITHABORT OFF
        SET NOCOUNT OFF
    END
    </select>

    <select id="mpo502ukrvServiceImpl.selectOrderNumDetail" parameterType="Map" resultType="rMap">
    BEGIN
        SET NOCOUNT ON
        SET ARITHABORT ON

        DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
              , @UserId      NVARCHAR(100) /* 사용자ID    */
              , @LangType    NVARCHAR(2)  /* 언어구분    */
              , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
              , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

        SET @CompCode = #{S_COMP_CODE}
        SET @UserId   = #{S_USER_ID}
        SET @LangType = #{S_LANG_CODE}

        /* 명칭 참조 유형 */
        SELECT TOP 1 @RefItem = REF_ITEM
          FROM BSA300T WITH (NOLOCK)
         WHERE USER_ID = @UserId

        SET @RefItem = ISNULL(@RefItem, N'0')

        /* 날짜 포맷 유형 설정 */
        SELECT TOP 1 @DateFormat = CODE_NAME
          FROM BSA100T WITH (NOLOCK)
         WHERE COMP_CODE = @CompCode
           AND MAIN_CODE = N'B044'
           AND REF_CODE1 = N'Y'

        SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

        /* 데이터 조회 */
        SELECT A.DIV_CODE
             , A.CUSTOM_CODE                                                       AS CUSTOM_CODE              
             , C.CUSTOM_NAME                                                       AS CUSTOM_NAME  
             , (CASE WHEN ISNULL(A.ORDER_DATE, '') = ''
                     THEN ''
                     ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
                                                             , 'MM'  , SUBSTRING(A.ORDER_DATE, 5, 2))
                                                             , 'DD'  , SUBSTRING(A.ORDER_DATE, 7, 2))
                END)                                                               AS ORDER_DATE
             , A.ORDER_TYPE                                                        AS ORDER_TYPE                
		     , B.ITEM_CODE
             , (CASE WHEN @RefItem = '1' THEN D.ITEM_NAME1
                     WHEN @RefItem = '2' THEN D.ITEM_NAME2
                                         ELSE D.ITEM_NAME
                 END)                                                               AS ITEM_NAME
             , ISNULL(D.SPEC,'')                                                    AS SPEC              
		     , B.ORDER_UNIT_Q                                                       AS ORDER_Q
		     , B.MONEY_UNIT
		     , B.ORDER_UNIT_P                                                       AS ORDER_P
		     , B.ORDER_O                                                            AS ORDER_O
             , (CASE WHEN ISNULL(B.DVRY_DATE, '') = ''
                     THEN ''
                     ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(B.DVRY_DATE, 1, 4))
                                                             , 'MM'  , SUBSTRING(B.DVRY_DATE, 5, 2))
                                                             , 'DD'  , SUBSTRING(B.DVRY_DATE, 7, 2))
                END)                                                                AS DVRY_DATE              	      
              , A.ORDER_NUM                                                         AS ORDER_NUM
			  , B.ORDER_SEQ                                                         AS ORDER_SEQ
              , A.PROJECT_NO                                                        AS PROJECT_NO
              , A.ORDER_PRSN                                                        AS ORDER_PRSN
              , A.AGREE_STATUS                                                      AS AGREE_STATUS
              , A.AGREE_PRSN                                                        AS AGREE_PRSN
              , E.USER_NAME                                                         AS AGREE_PRSN_NAME
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                   , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                   , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))         AS AGREE_DATE
			  , A.MONEY_UNIT                                                        AS MONEY_UNIT 
        FROM  MPO100T A WITH  (NOLOCK)
              INNER JOIN MPO200T B WITH  (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                 AND B.DIV_CODE    = A.DIV_CODE
                                                 AND B.ORDER_NUM   = A.ORDER_NUM
                                                 AND B.CUSTOM_CODE = A.CUSTOM_CODE
              INNER JOIN BCM100T C WITH (NOLOCK)  ON C.COMP_CODE   = A.COMP_CODE
                                                 AND C.CUSTOM_CODE = A.CUSTOM_CODE
              INNER JOIN BPR100T D WITH (NOLOCK)  ON D.COMP_CODE   = B.COMP_CODE
                                                 AND D.ITEM_CODE   = B.ITEM_CODE
              LEFT  JOIN BSA300T E WITH (NOLOCK)  ON E.COMP_CODE   = A.COMP_CODE
                                                 AND E.USER_ID     = A.AGREE_PRSN
              LEFT  JOIN BPR200T G WITH (NOLOCK)  ON G.COMP_CODE   = A.COMP_CODE
                                                 AND G.DIV_CODE    = A.DIV_CODE
                                                 AND G.ITEM_CODE   = B.ITEM_CODE
        WHERE   A.COMP_CODE    = @CompCode
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
        AND   A.DIV_CODE       = #{DIV_CODE}
        </if>
		<!--2021.08 표준화 작업 Start-->
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND A.CUSTOM_CODE = #{CUSTOM_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
			AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
		</if>
		<if test="@foren.Ognl@isEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			AND		(@RefItem       = N'0' AND C.CUSTOM_NAME  LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'1' AND C.CUSTOM_NAME1 LIKE N'%' + #{CUSTOM_NAME} + N'%')
				OR	(@RefItem       = N'2' AND C.CUSTOM_NAME2 LIKE N'%' + #{CUSTOM_NAME} + N'%')
		</if>
		<!--2021.08 표준화 작업 End-->
        <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
        AND   A.ORDER_TYPE     = #{ORDER_TYPE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
        AND   A.ORDER_DATE    &gt;= #{ORDER_DATE_FR}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
        AND   A.ORDER_DATE    &lt;= #{ORDER_DATE_TO}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
        AND   A.ORDER_NUM     LIKE #{ORDER_NUM}+ '%'
        </if>        
        <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
        AND   A.ORDER_PRSN     = #{ORDER_PRSN}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PJT_CODE)">
        AND   A.PROJECT_NO     = #{PJT_CODE}
        </if>       

        ORDER BY A.CUSTOM_CODE, A.ORDER_DATE, A.ORDER_NUM, B.ORDER_SEQ

        SET ARITHABORT OFF
        SET NOCOUNT OFF
    END
    </select>
    
    <select id="mpo502ukrvServiceImpl.selectMaster" parameterType="Map" resultType="rMap">
        --mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query045
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE       @DateFormat       NVARCHAR(10)

            SELECT TOP 1 @DateFormat = M1.CODE_NAME
            FROM   BSA100T M1 WITH (NOLOCK)
            WHERE  M1.COMP_CODE = #{S_COMP_CODE}
            AND    M1.MAIN_CODE = N'B044'
            AND    M1.REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY/MM/DD')
        ---------------------------------------------------------------------------------------------------
            SELECT
                   REPLACE(
                   REPLACE(
                   REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                      , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                      , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))   AS AGREE_DATE
                 , A.AGREE_PRSN
                 , ISNULL(B.USER_NAME, '') AS AGREE_PRSN_NAME
                 , A.AGREE_STATUS
                 , A.LC_NUM
                 , A.RECEIPT_TYPE
                 , A.REMARK
                 , A.DRAFT_YN
                 , A.DIV_CODE
                 , A.PROJECT_NO
                 , A.EXCHG_RATE_O
                 , A.ORDER_PRSN
                 , A.ORDER_TYPE
            FROM              MPO100T A WITH (NOLOCK)
                   LEFT  JOIN BSA300T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                     AND B.USER_ID   = A.AGREE_PRSN
            WHERE  A.COMP_CODE   = #{S_COMP_CODE}
            AND    A.ORDER_NUM   = #{ORDER_NUM}
            -- AND    A.ORDER_TYPE != N'4'

            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="mpo502ukrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
        /* mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query01 */
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */

            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}

            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            /* 데이터 조회 */
            SELECT  A.DIV_CODE
                  , A.CUSTOM_CODE
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.UNIT_PRICE_TYPE
                  , A.MONEY_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                  , A.EXCHG_RATE_O
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  , A.INIT_DVRY_DATE                                AS INIT_DVRY_DATE	
                  , A.WH_CODE
                  , A.TRNS_RATE
                  , A.ORDER_Q
                  , A.ORDER_P
                  , A.CONTROL_STATUS
                  , A.ORDER_REQ_NUM
                  --, A.PO_REQ_NUM
                  --, A.PO_REQ_SEQ                                        AS PO_SER_NO
                  , A.INSTOCK_Q
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.PROJECT_NO
                  --, C.LOT_YN
                  , A.LOT_NO
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
                  , A.IN_DIV_CODE
                  , A.SO_NUM
                  , A.SO_SEQ
                  , CASE WHEN ISNULL(A.DVRY_ESTI_DATE,'') = '' THEN 'Y' ELSE 'N' END MODIFY_AUTH_CHK --거래처납품등록 여부(납기예정일로 체크)
                  , C.SUPPLY_TYPE
                  , D1.CUSTOM_CODE AS SO_PLACE
				  , E.CUSTOM_NAME  AS SO_PLACE_NAME
				  , F.ITEM_NAME    AS SO_ITEM_NAME
				  , A.BAD_RETURN_Q
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE
                                                      AND C.ITEM_CODE = A.ITEM_CODE
					LEFT JOIN SOF110T D WITH (NOLOCK) ON D.COMP_CODE  = A.COMP_CODE
													 AND D.DIV_CODE   = A.DIV_CODE
													 AND D.ORDER_NUM  = A.SO_NUM
													 AND D.SER_NO     = A.SO_SEQ
				    LEFT JOIN SOF100T D1 WITH (NOLOCK) ON D1.COMP_CODE = D.COMP_CODE
													  AND D1.DIV_CODE  = D.DIV_CODE
													  AND D1.ORDER_NUM = D.ORDER_NUM
					LEFT JOIN BCM100T E WITH (NOLOCK) ON E.COMP_CODE   = D1.COMP_CODE
													 AND E.CUSTOM_CODE = D1.CUSTOM_CODE
					LEFT JOIN BPR100T F WITH (NOLOCK) ON F.COMP_CODE   = D.COMP_CODE
													 AND F.ITEM_CODE   = D.ITEM_CODE
            WHERE   A.COMP_CODE = @CompCode
            <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
            AND     A.ORDER_NUM = #{ORDER_NUM}
            </if>
            ORDER BY A.ORDER_SEQ

            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="mpo502ukrvServiceImpl.selectList2" parameterType="Map" resultType="rMap">
        --mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query02
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE       @DateFormat       NVARCHAR(10)

            SELECT TOP 1 @DateFormat = M1.CODE_NAME
            FROM   BSA100T M1 WITH (NOLOCK)
            WHERE  M1.COMP_CODE = #{S_COMP_CODE}
            AND    M1.MAIN_CODE = N'B044'
            AND    M1.REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY/MM/DD')
        ---------------------------------------------------------------------------------------------------
            SELECT
                    A.DIV_CODE
                  , A.CUSTOM_CODE
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE
                  , B.ITEM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.UNIT_PRICE_TYPE
                  , A.MONEY_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                  , A.EXCHG_RATE_O
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.DVRY_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.DVRY_DATE, 7, 2))   AS DVRY_DATE
                  , A.DVRY_TIME AS DVRY_TIME
                  , A.WH_CODE
                  , A.TRNS_RATE
                  , A.ORDER_Q
                  , A.ORDER_P
                  , A.CONTROL_STATUS
                  , A.ORDER_REQ_NUM
                  , A.INSTOCK_Q
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.PROJECT_NO
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
                  , ISNULL(( SELECT   ISNULL(A1.ITEM_P, C.PURCHASE_BASE_P)
						FROM uniLITE.BPR400T A1 WITH(NOLOCK)
						INNER JOIN
						(SELECT COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT, MAX(APLY_START_DATE) AS APLY_START_DATE
						 FROM uniLITE.BPR400T WITH(NOLOCK)
						 WHERE APLY_START_DATE &lt;= CONVERT(NVARCHAR(8), GETDATE(), 112)
						 GROUP BY COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT
						 ) B ON A1.COMP_CODE = B.COMP_CODE
							AND A1.TYPE                 	 = B.TYPE
							AND A1.DIV_CODE             = B.DIV_CODE
							AND A1.CUSTOM_CODE      = B.CUSTOM_CODE
							AND A1.ITEM_CODE           = B.ITEM_CODE
							AND A1.MONEY_UNIT         = B.MONEY_UNIT
							AND A1.ORDER_UNIT          = B.ORDER_UNIT
							AND A1.APLY_START_DATE  = B.APLY_START_DATE
						INNER JOIN unilite.BPR200T C WITH(NOLOCK) ON A1.COMP_CODE = C.COMP_CODE
																AND A1.DIV_CODE  = C.DIV_CODE
																AND A1.ITEM_CODE = C.ITEM_CODE
						WHERE A1.ITEM_CODE       = A.ITEM_CODE
						AND A1.CUSTOM_CODE      = #{CUSTOM_CODE}
						AND A1.COMP_CODE          = #{S_COMP_CODE}
						AND A1.DIV_CODE          	 = A.IN_DIV_CODE
						AND A1.TYPE              		 = N'1'
						AND A1.MONEY_UNIT         = #{MONEY_UNIT}
						AND A1.ORDER_UNIT          = A.ORDER_UNIT ), 0) AS ORDER_UNIT_P_CUR  				--현재 단가 가져오기
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
            WHERE   A.COMP_CODE = #{S_COMP_CODE}
            AND     A.ORDER_NUM = #{ORDER_NUM}

            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="mpo502ukrvServiceImpl.selectOrderNumMasterList2" parameterType="Map" resultType="rMap">
        /*mpo501ukrv.Cmpo501ukrv[fnMpo100QStd] Query01*/
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
                  , @UserId      NVARCHAR(100) /* 사용자ID    */
                  , @LangType    NVARCHAR(2)  /* 언어구분    */
                  , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
                  , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}

            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            /* 데이터 조회 */

            SELECT  B.CUSTOM_NAME                                                       AS CUSTOM_NAME
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.ORDER_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.ORDER_DATE, 7, 2))         AS ORDER_DATE
                  , A.ORDER_TYPE                                                        AS ORDER_TYPE
                  , A.ORDER_NUM                                                         AS ORDER_NUM
                  , A.CUSTOM_CODE                                                       AS CUSTOM_CODE
                  , A.ORDER_PRSN                                                        AS ORDER_PRSN
                  , A.AGREE_STATUS                                                      AS AGREE_STATUS
                  , A.AGREE_PRSN                                                        AS AGREE_PRSN
                  , C.USER_NAME                                                         AS AGREE_PRSN_NAME
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))         AS AGREE_DATE
                  , A.MONEY_UNIT                                                        AS MONEY_UNIT
                  , A.LC_NUM                                                            AS LC_NUM
                  , A.RECEIPT_TYPE                                                      AS RECEIPT_TYPE
                  , A.REMARK                                                            AS REMARK
                  , A.EXCHG_RATE_O                                                      AS EXCHG_RATE_O
                  , A.DRAFT_YN                                                          AS DRAFT_YN
                  , A.DIV_CODE                                                          AS DIV_CODE
                  , A.PROJECT_NO                                                        AS PROJECT_NO
                  , A.DEPT_CODE
            FROM                MPO100T A WITH  (NOLOCK)
                    INNER JOIN  BCM100T B WITH  (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                        AND B.CUSTOM_CODE = A.CUSTOM_CODE
                    LEFT  JOIN  BSA300T C WITH  (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
                                                        AND C.USER_ID     = A.AGREE_PRSN
            WHERE   A.COMP_CODE    = @CompCode
            -- AND     A.ORDER_TYPE  != N'4'
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
            AND   A.DIV_CODE       = #{DIV_CODE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
            AND   A.ORDER_TYPE     = #{ORDER_TYPE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
            AND   A.ORDER_DATE    &gt;= #{ORDER_DATE_FR}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
            AND   A.ORDER_DATE    &lt;= #{ORDER_DATE_TO}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
            AND   A.ORDER_PRSN     = #{ORDER_PRSN}
            </if>
			<!--2021.08 표준화 작업 Start-->
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE = #{CUSTOM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
			</if>
			<!--2021.08 표준화 작업 End-->
            <if test="@foren.Ognl@isNotEmpty(AGREE_STATUS)">
            AND   A.AGREE_STATUS   = #{AGREE_STATUS}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
            AND   A.PROJECT_NO     = #{PROJECT_NO}
            </if>

            ORDER BY B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM

            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="mpo502ukrvServiceImpl.selectMrp400tList" parameterType="Map" resultType="rMap">
        SELECT
            A.COMP_CODE                                 AS COMP_CODE
            ,A.DIV_CODE                                 AS DIV_CODE
            ,A.CUSTOM_CODE                              AS CUSTOM_CODE
            ,A.CUSTOM_NAME                              AS CUSTOM_NAME
            ,A.ITEM_CODE                                AS ITEM_CODE
            ,B.ITEM_NAME                                AS ITEM_NAME
            ,B.SPEC                                     AS SPEC
            ,C.ORDER_UNIT                               AS ORDER_UNIT
            ,B.STOCK_UNIT                               AS STOCK_UNIT
            ,A.SUPPLY_TYPE                              AS SUPPLY_TYPE
            ,C.PURCHASE_BASE_P                          AS ORDER_P
            ,A.REQ_PLAN_Q                               AS ORDER_Q
            ,(C.PURCHASE_BASE_P * A.REQ_PLAN_Q)         AS ORDER_O
            ,ISNULL((SELECT SUM(STOCK_Q)
                    FROM BIV100T
                    WHERE ITEM_CODE = B.ITEM_CODE), 0)  AS CSTOCK
            ,C.PURCH_LDTIME                             AS PURCH_LDTIME
            ,A.REMARK                                   AS REMARK
            ,A.MRP_CONTROL_NUM                          AS MRP_CONTROL_NUM
            ,A.ORDER_REQ_NUM                            AS ORDER_REQ_NUM
            ,A.PROJECT_NO                               AS PROJECT_NO
            ,A.PJT_CODE                                 AS ORDER_NUM
            ,A.IN_DIV_CODE
        FROM MRP400T A WITH(NOLOCK)
                INNER JOIN BPR100T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
                                                 AND A.ITEM_CODE = B.ITEM_CODE
                INNER JOIN BPR200T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
                                                 AND A.DIV_CODE  = C.DIV_CODE
                                                 AND A.ITEM_CODE = C.ITEM_CODE
        WHERE A.COMP_CODE = #{S_COMP_CODE}
            AND A.DIV_CODE = #{DIV_CODE}
            AND A.REQ_PLAN_Q > 0
            AND A.ORDER_YN = 'N'
            AND ISNULL(A.CUSTOM_CODE,'') != ''
            AND ISNULL(A.CUSTOM_NAME,'') != ''
            <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
                AND A.PROJECT_NO = #{PROJECT_NO}
            </if>
			<!--2021.08 표준화 작업 Start-->
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE = #{CUSTOM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
			</if>
			<!--2021.08 표준화 작업 End-->

        ORDER BY A.CUSTOM_CODE
    </select>

    <select id="mpo502ukrvServiceImpl.fnOrderPrice" parameterType="Map" resultType="rMap">
        SELECT A.COMP_CODE,
                A.TYPE,
                A.DIV_CODE,
                A.ITEM_CODE,
                A.CUSTOM_CODE,
                A.MONEY_UNIT,
                A.ORDER_UNIT,
                A.ORDER_RATE,
                /* A.PURCHASE_TYPE,
                   A.SALES_TYPE,
                   A.PURCHASE_RATE, */
                ISNULL(A.ITEM_P, C.PURCHASE_BASE_P) AS ORDER_UNIT_P,
                A.APLY_START_DATE
         FROM uniLITE.BPR400T A WITH(NOLOCK)
         INNER JOIN
           (SELECT COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT, MAX(APLY_START_DATE) AS APLY_START_DATE
            FROM uniLITE.BPR400T WITH(NOLOCK)
            WHERE APLY_START_DATE &lt;= CONVERT(NVARCHAR(8), GETDATE(), 112)
            GROUP BY COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT
            ) B ON A.COMP_CODE = B.COMP_CODE
               AND A.TYPE                 = B.TYPE
               AND A.DIV_CODE             = B.DIV_CODE
               AND A.CUSTOM_CODE          = B.CUSTOM_CODE
               AND A.ITEM_CODE            = B.ITEM_CODE
               AND A.MONEY_UNIT           = B.MONEY_UNIT
               AND A.ORDER_UNIT           = B.ORDER_UNIT
               AND A.APLY_START_DATE      = B.APLY_START_DATE
         INNER JOIN unilite.BPR200T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
                                                  AND A.DIV_CODE  = C.DIV_CODE
                                                  AND A.ITEM_CODE = C.ITEM_CODE
        WHERE A.ITEM_CODE           = #{ITEM_CODE}
			<!--2021.08 표준화 작업 Start-->
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE = #{CUSTOM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
				AND A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
			</if>
			<!--2021.08 표준화 작업 End-->
            AND A.COMP_CODE         = #{S_COMP_CODE}
            AND A.DIV_CODE          = #{DIV_CODE}
            AND A.TYPE              = N'1'
            AND A.MONEY_UNIT        = #{MONEY_UNIT}
            AND A.ORDER_UNIT        = #{ORDER_UNIT}
    </select>

    <select id="mpo502ukrvServiceImpl.callInspecyn" parameterType="Map" resultType="rMap">
        Select
            ISNULL(INSPEC_YN, 'N') AS INSPEC_YN
          , ISNULL(WH_CODE, '') AS WH_CODE
          , CASE WHEN PURCH_LDTIME = 0 OR PURCH_LDTIME IS NULL THEN 1
          		 ELSE PURCH_LDTIME
			END  AS PURCH_LDTIME
            FROM BPR200T
            WHERE COMP_CODE = #{S_COMP_CODE}
            AND DIV_CODE    = #{DIV_CODE}
           AND ITEM_CODE   = #{ITEM_CODE}
    </select>

    <select id="mpo502ukrvServiceImpl.userName" parameterType="Map" resultType="rMap">
        /*UMFuncKrv.CMFuncKr[fnGetAgreePrsn] Query01*/
        SELECT B.USER_NAME AS USER_NAME
             , B.USER_ID   AS USER_ID
          FROM          BSA100T A WITH (NOLOCK)
             INNER JOIN BSA300T B WITH (NOLOCK) ON A.REF_CODE1 = B.USER_ID

         WHERE A.MAIN_CODE = N'M201'
           AND A.SUB_CODE  = #{SUB_CODE}
           AND A.COMP_CODE = #{S_COMP_CODE}
         ORDER BY A.SUB_CODE
    </select>

    <select id="mpo502ukrvServiceImpl.userWhcode" parameterType="Map" resultType="rMap">
        SELECT
            A.WH_CODE
        FROM         BSA210T A WITH(NOLOCK)
           LEFT JOIN BSA300T B WITH(NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                           AND B.DEPT_CODE = A.TREE_CODE
        WHERE A.COMP_CODE = #{S_COMP_CODE}
          AND B.USER_ID   = #{S_USER_ID}
    </select>

    <select id="mpo502ukrvServiceImpl.callDeptInspecFlag" parameterType="Map" resultType="rMap">
        SELECT
            ISNULL(INSPEC_FLAG, 'N') AS  INSPEC_FLAG
        FROM BSA210T WITH(NOLOCK)
        WHERE COMP_CODE = #{S_COMP_CODE}
          AND TYPE_LEVEL = #{DIV_CODE}
          AND TREE_CODE = #{DEPT_CODE}
    </select>

    <select id="mpo502ukrvServiceImpl.ref1" parameterType="Map" resultType="rMap">
        SELECT
            REF_CODE1
        FROM
            BSA100T
        WHERE   COMP_CODE = #{S_COMP_CODE}
            AND MAIN_CODE = 'M201'
            AND SUB_CODE  = #{ORDER_PRSN}
    </select>

    <insert id="mpo502ukrvServiceImpl.insertLogDetail" parameterType="Map">
        INSERT INTO L_MPO200T
             ( KEY_VALUE    , OPR_FLAG
             , DIV_CODE     , CUSTOM_CODE   , ORDER_NUM         , ORDER_SEQ         , ITEM_CODE
             , ORDER_UNIT_Q , ORDER_UNIT    , UNIT_PRICE_TYPE   , MONEY_UNIT        , ORDER_UNIT_P
             , ORDER_O      , EXCHG_RATE_O  , ORDER_LOC_P       , ORDER_LOC_O       , DVRY_DATE
             , WH_CODE      , TRNS_RATE     , ORDER_Q           , ORDER_P           , CONTROL_STATUS
             , INSTOCK_Q    , INSPEC_FLAG   , COMP_CODE

             , DVRY_TIME    , ORDER_REQ_NUM , PROJECT_NO        , LOT_NO
             , REMARK       , BAD_RETURN_Q  , ADVAN_AMOUNT      , MAP_Q
             , SO_NUM       , SO_SEQ        , BL_NUM            , DVRY_ESTI_NO      , DVRY_ESTI_QTY
             , DVRY_TOT_QTY , DVRY_ESTI_DATE, DVRY_PRINT_YN     , SUPP_REMARK       , IF_NO
             , IF_YN        , IF_DATETIME   , UPDATE_DB_USER    , UPDATE_DB_TIME    , INSERT_DB_USER        , INSERT_DB_TIME
             , IN_DIV_CODE  , INIT_DVRY_DATE
             )
        VALUES
            (  #{KEY_VALUE}    , #{OPR_FLAG}
             , #{DIV_CODE}     , #{CUSTOM_CODE}   , #{ORDER_NUM}        , #{ORDER_SEQ}   , #{ITEM_CODE}
             , #{ORDER_UNIT_Q} , #{ORDER_UNIT}    , #{UNIT_PRICE_TYPE}  , #{MONEY_UNIT}  , #{ORDER_UNIT_P}
             , #{ORDER_O}      , #{EXCHG_RATE_O}  , #{ORDER_LOC_P}      , #{ORDER_LOC_O} , #{DVRY_DATE}
             , #{WH_CODE}      , #{TRNS_RATE}     , #{ORDER_Q}          , #{ORDER_P}     , #{CONTROL_STATUS}
             , #{INSTOCK_Q}    , #{INSPEC_FLAG}   , #{S_COMP_CODE}

             , #{DVRY_TIME}    , #{ORDER_REQ_NUM}   , #{PROJECT_NO}     , #{LOT_NO}
             , #{REMARK}       , #{BAD_RETURN_Q}    , #{ADVAN_AMOUNT}   , #{MAP_Q}
             , #{SO_NUM}       , #{SO_SEQ}          , #{BL_NUM}         , #{DVRY_ESTI_NO} , #{DVRY_ESTI_QTY}
             , #{DVRY_TOT_QTY} , #{DVRY_ESTI_DATE}  , #{DVRY_PRINT_YN}  , #{SUPP_REMARK}  , #{IF_NO}
             , #{IF_YN}        , #{IF_DATETIME}     , #{S_USER_ID}      , GETDATE()       , #{S_USER_ID}        , GETDATE()
             , #{IN_DIV_CODE}  , #{INIT_DVRY_DATE}
             )
    </insert>

    <insert id="mpo502ukrvServiceImpl.insertLogMaster" parameterType="Map">
        INSERT INTO L_MPO100T
             ( KEY_VALUE      , OPR_FLAG
             , ORDER_DATE     , ORDER_TYPE     , CUSTOM_CODE     , ORDER_NUM     , ORDER_PRSN
             , AGREE_STATUS   , MONEY_UNIT     , EXCHG_RATE_O    , DIV_CODE      , COMP_CODE
             <if test="@foren.Ognl@isNotEmpty(LC_NUM)">
             , LC_NUM
             </if>
             <if test="@foren.Ognl@isNotEmpty(RECEIPT_TYPE)">
             , RECEIPT_TYPE
             </if>
             , DEPT_CODE
             <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
             , PROJECT_NO
             </if>
             <if test="@foren.Ognl@isNotEmpty(REMARK)">
             , REMARK
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_PRSN)">
             , AGREE_PRSN
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_DATE)">
             , AGREE_DATE
             </if>
             , DRAFT_YN
             , INSERT_DB_USER
             , UPDATE_DB_USER
             , INSERT_DB_TIME
             , UPDATE_DB_TIME
             )
        VALUES
            (  #{KEY_VALUE}      , #{OPR_FLAG}
             , #{ORDER_DATE}     , #{ORDER_TYPE}      , #{CUSTOM_CODE}      , #{ORDER_NUM}      , #{ORDER_PRSN}
             , #{AGREE_STATUS}   , #{MONEY_UNIT}      , #{EXCHG_RATE_O}     , #{DIV_CODE}       , #{COMP_CODE}
             <if test="@foren.Ognl@isNotEmpty(LC_NUM)">
             , #{LC_NUM}
             </if>
             <if test="@foren.Ognl@isNotEmpty(RECEIPT_TYPE)">
             , #{RECEIPT_TYPE}
             </if>
             , #{DEPT_CODE}
             <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
             , #{PROJECT_NO}
             </if>
             <if test="@foren.Ognl@isNotEmpty(REMARK)">
             , #{REMARK}
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_PRSN)">
             , #{AGREE_PRSN}
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_DATE)">
             , #{AGREE_DATE}
             </if>
             , #{DRAFT_YN}
             , #{S_USER_ID}
             , #{S_USER_ID}
             , GETDATE()
             , GETDATE()
             )
    </insert>

    <update id="mpo502ukrvServiceImpl.spPurchaseOrder" parameterType="Map" statementType="CALLABLE">
        {call SP_MATRL_PurchaseOrder (
            #{KeyValue, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
            #{LangCode, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
            #{OrderNum, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String},
            #{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
        )}
    </update>

    <update id="mpo502ukrvServiceImpl.spPurchaseOutOrder" parameterType="Map" statementType="CALLABLE">
        {call SP_MATRL_PurchaseOutOrder (
            #{KeyValue, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
            #{LangCode, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
            #{OrderNum, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String},
            #{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
        )}
    </update>

	<update id="mpo502ukrvServiceImpl.insertBpr400t" parameterType="Map">
	    DECLARE @OrderUnitP NUMERIC(30,6)
	        ,@CheckSubCode NVARCHAR(1)

		SET @OrderUnitP = 0;
		SET @CheckSubCode = 'N';

		SELECT TOP 1
		    @CheckSubCode = SUB_CODE
		  FROM BSA100T
		 WHERE COMP_CODE = #{S_COMP_CODE}
		   AND MAIN_CODE = 'M304'
		   AND REF_CODE1 = 'Y'

		IF(@CheckSubCode = 'Y')
		    BEGIN
		        SELECT TOP 1
		            @OrderUnitP = ISNULL(A.ITEM_P,0)
		                FROM BPR400T A WITH(NOLOCK)
		        INNER JOIN (SELECT COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT, MAX(APLY_START_DATE) AS APLY_START_DATE
		                        FROM BPR400T WITH(NOLOCK)
		                    WHERE APLY_START_DATE &lt;= CONVERT(NVARCHAR(8), GETDATE(), 112)
		                    GROUP BY COMP_CODE, TYPE, DIV_CODE, ITEM_CODE, CUSTOM_CODE, MONEY_UNIT, ORDER_UNIT
		                ) B ON A.COMP_CODE = B.COMP_CODE
		                    AND A.TYPE = B.TYPE
		                    AND A.DIV_CODE = B.DIV_CODE
		                    AND A.CUSTOM_CODE = B.CUSTOM_CODE
		                    AND A.ITEM_CODE = B.ITEM_CODE
		                    AND A.MONEY_UNIT = B.MONEY_UNIT
		                    AND A.ORDER_UNIT = B.ORDER_UNIT
		                    AND A.APLY_START_DATE = B.APLY_START_DATE

		            WHERE A.COMP_CODE = #{S_COMP_CODE}
		              AND A.DIV_CODE = #{DIV_CODE}
		              AND A.ITEM_CODE = #{ITEM_CODE}
		              AND A.CUSTOM_CODE = #{CUSTOM_CODE}
		              AND A.TYPE = N'1'
		              AND A.MONEY_UNIT = #{MONEY_UNIT}
		              AND A.ORDER_UNIT = #{ORDER_UNIT}

		        IF @OrderUnitP != #{ORDER_UNIT_P}
		            BEGIN
		                INSERT INTO BPR400T(
		                    COMP_CODE
		                    ,TYPE
		                    ,DIV_CODE
		                    ,ITEM_CODE
		                    ,CUSTOM_CODE
		                    ,MONEY_UNIT
		                    ,ORDER_UNIT
		                    ,APLY_START_DATE
		                    ,ITEM_P
		                    ,ORDER_RATE
		                    ,REMARK
		                    ,INSERT_DB_USER
		                    ,INSERT_DB_TIME
		                    ,UPDATE_DB_USER
		                    ,UPDATE_DB_TIME
		                )
		                VALUES
		                (
		                    #{S_COMP_CODE}
		                    ,'1'
		                    ,#{DIV_CODE}
		                    ,#{ITEM_CODE}
		                    ,#{CUSTOM_CODE}
		                    ,#{MONEY_UNIT}
		                    ,#{ORDER_UNIT}
		                    ,CONVERT(NVARCHAR(8), GETDATE(), 112)
		                    ,#{ORDER_UNIT_P}
		                    ,'100'
		                    ,'발주단가역반영'
		                    ,#{S_USER_ID}
		                    ,GETDATE()
		                    ,#{S_USER_ID}
		                    ,GETDATE()
		                )
		            END
		    END
	</update>

	<insert id="mpo502ukrvServiceImpl.insertExcelMpo502ukrv" parameterType="Map">       /* 엑셀insert */
	/*mpo502ukrvServiceImpl.insertExcelMpo502ukrv*/
	INSERT INTO MPO502UKRV_EXCEL(
	      _EXCEL_JOBID
	    , _EXCEL_ROWNUM
	    , _EXCEL_HAS_ERROR
	    , _EXCEL_ERROR_MSG
	    ,ITEM_CODE
	    ,ITEM_NAME
	    ,ORDER_UNIT
	    ,ORDER_UNIT_Q
	    ,ORDER_UNIT_P
	    ,DVRY_DATE
	    ,WH_CODE
	    ,INSERT_DB_USER
	    ,INSERT_DB_TIME
	    ,UPDATE_DB_USER
	    ,UPDATE_DB_TIME

	)VALUES (
	      #{_EXCEL_JOBID}
	    , #{_EXCEL_ROWNUM}
	    , #{_EXCEL_HAS_ERROR,jdbcType=VARCHAR}
	    , #{_EXCEL_ERROR,jdbcType=VARCHAR}
	    , #{ITEM_CODE}
	    , #{ITEM_NAME}
	    , #{ORDER_UNIT}
	    , #{ORDER_UNIT_Q}
	    , #{ORDER_UNIT_P}
	    , #{DVRY_DATE}
	    , #{WH_CODE}
	    , #{S_USER_ID}
	    , GETDATE()
	    , #{S_USER_ID}
	    , GETDATE()
	)
	</insert>

	<select id="mpo502ukrvServiceImpl.selectExcelUploadSheet1" parameterType="Map" resultType="rMap">   /* 엑셀업로드 */
	/*mpo502ukrvServiceImpl.selectExcelUploadSheet1*/

	    SELECT A._EXCEL_JOBID
	        , A._EXCEL_ROWNUM
	        , A._EXCEL_HAS_ERROR
	        , A._EXCEL_ERROR_MSG

	        , A.ITEM_CODE
	        , CASE WHEN ISNULL(A.ITEM_NAME,'') = '' THEN B.ITEM_NAME
	               ELSE A.ITEM_NAME
	          END ITEM_NAME
	        , A.ORDER_UNIT
	        , A.ORDER_UNIT_Q
	        , A.ORDER_UNIT_P
	        , CASE WHEN ISNULL(A.DVRY_DATE,'') = '' THEN CONVERT(VARCHAR, DATEADD(day,B.PURCH_LDTIME, CONVERT(VARCHAR, GETDATE(), 112)),112)
	               ELSE A.DVRY_DATE
	          END DVRY_DATE
	        , CASE WHEN ISNULL(A.WH_CODE,'') = '' THEN B.WH_CODE
	               ELSE A.WH_CODE
	          END WH_CODE

	        , B.SPEC            --규격
	        , B.STOCK_UNIT      --재고단위
	        , B.TRNS_RATE       --입수
	        , B.BASIS_P AS OREDR_P      --발주단가(재고)
	        , ISNULL(B.INSPEC_YN,'N') AS INSPEC_FLAG    --품질대상여부


	      FROM MPO502UKRV_EXCEL A WITH (NOLOCK)
	INNER JOIN BPR200TV B ON B.COMP_CODE = #{S_COMP_CODE}
	                     AND B.DIV_CODE = #{DIV_CODE}
	                     AND B.ITEM_CODE = A.ITEM_CODE

	     WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
	  ORDER BY A._EXCEL_JOBID, A._EXCEL_ROWNUM

	</select>

    <update id="excelValidate" >
    /*mpo502ukrvServiceImpl.excelValidate*/
    /*다국어 메세지 처리 함수 필요. S_LANG_CODE와 msg_no를 파라미터로 받아 BSA000T에서 조회*/

   UPDATE   A
    SET
            A._EXCEL_HAS_ERROR = (CASE WHEN B.ITEM_CODE IS NULL OR C.ITEM_CODE IS NULL      THEN 'Y'
                                  ELSE A._EXCEL_HAS_ERROR
                                  END),

            A._EXCEL_ERROR_MSG = (CASE WHEN B.ITEM_CODE IS NULL OR C.ITEM_CODE IS NULL      THEN ISNULL(_EXCEL_ERROR_MSG,'') + '사업장에 대한 품목정보가 존재하지 않습니다. '
                                 ELSE A._EXCEL_ERROR_MSG
                                 END)

    FROM MPO502UKRV_EXCEL A
    LEFT JOIN  BPR100T B    ON B.COMP_CODE = #{S_COMP_CODE}
                           AND A.ITEM_CODE = B.ITEM_CODE
    LEFT JOIN  BPR200T C    ON C.COMP_CODE = #{S_COMP_CODE}
                           AND C.DIV_CODE  = #{DIV_CODE}
                           AND A.ITEM_CODE = C.ITEM_CODE
    WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}

    UPDATE  A
    SET
            A._EXCEL_HAS_ERROR = (CASE WHEN B.USE_YN = 'N'
                                        THEN 'Y'
                                       WHEN  ISNULL(B.START_DATE, '19000101') &gt; #{ORDER_DATE}
                                        THEN 'Y'
                                       WHEN  ISNULL(B.STOP_DATE, '99991231') &lt; #{ORDER_DATE}
                                        THEN 'Y'
                                  ELSE A._EXCEL_HAS_ERROR
                                  END),
            A._EXCEL_ERROR_MSG = (CASE WHEN B.USE_YN = 'N'
                                        THEN ISNULL(_EXCEL_ERROR_MSG,'') + '사용중지된 품목입니다.'
                                       WHEN  ISNULL(B.START_DATE, '19000101') &gt; #{ORDER_DATE} OR  ISNULL(B.STOP_DATE, '99991231') &lt; #{ORDER_DATE}
                                        THEN ISNULL(_EXCEL_ERROR_MSG,'') + '사용기간이 경과한 품목입니다.('+ISNULL(B.START_DATE, '')+'~'+ISNULL(B.STOP_DATE, '')+')'
                                  ELSE A._EXCEL_ERROR_MSG END)
    FROM MPO502UKRV_EXCEL A
    INNER JOIN  BPR100T B  ON B.COMP_CODE= #{S_COMP_CODE}
                          AND A.ITEM_CODE = B.ITEM_CODE
    WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
    </update>

    <select id="mpo502ukrvServiceImpl.mainReport" parameterType="Map" resultType="rMap">
        --mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query045
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

             DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                  , @PRINT_USER          NVARCHAR(100)            --(선택) 출력자
                  , @VIEW_PRINT_INFO_YN  NVARCHAR(01)             --인쇄출력정보 여부

            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}

            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            SELECT @PRINT_USER = USER_NAME
              FROM BSA300T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND USER_ID = @UserId

            SELECT @VIEW_PRINT_INFO_YN = SUB_CODE
              FROM BSA100T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = 'B249'
               AND SUB_CODE != '$'
               AND REF_CODE1 = 'Y'

            /* 데이터 조회 */
            SELECT A.ORDER_NUM
                  --, ROW_NUMBER () OVER (PARTITION BY A.ORDER_NUM ORDER BY A.ORDER_NUM, A.DVRY_DATE, B.ITEM_NAME, A.ORDER_SEQ) AS PRINT_SEQ
                  , A.ORDER_SEQ         AS PRINT_SEQ
                  , F.CODE_NAME         AS ORDER_PRSN
                  , D.CUSTOM_NAME
                  , ISNULL(D.TELEPHON, '')          AS CUST_TEL_PHON
                  , ISNULL(D.FAX_NUM, '')           AS CUST_FAX_NUM
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                  , (SELECT SUM(S1.ORDER_O)
                     FROM MPO200T S1
                     WHERE S1.ORDER_NUM = #{ORDER_NUM}) AS TOT_ORDER_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  --, A.WH_CODE
                  , J.TREE_NAME AS WH_CODE
                  , A.ORDER_P
                  , A.REMARK
                  , A2.REMARK       AS MASTER_REMARK
                  , A.PROJECT_NO
                  , (CASE WHEN ISNULL(A2.ORDER_DATE, '') = ''
                          THEN ''
                          ELSE REPLACE(REPLACE(REPLACE('YYYY.MM.DD', 'YYYY', SUBSTRING(A2.ORDER_DATE, 1, 4))
                                                                   , 'MM'  , SUBSTRING(A2.ORDER_DATE, 5, 2))
                                                                   , 'DD'  , SUBSTRING(A2.ORDER_DATE, 7, 2))
                    END)                                                     AS ORDER_DATE
                  , E.DIV_CODE    AS MY_CUSTOM_CODE      --사업장코드
                  , E.DIV_NAME    AS MY_CUSTOM_NAME      --상호
                  , E.REPRE_NAME  AS MY_TOP_NAME         --대표자
                  , E.COMP_TYPE                       --업태
                  , E.COMP_CLASS                      --종목
                  , CASE ISNULL(E.COMPANY_NUM,'')
                    WHEN '' THEN ''
                    ELSE         SUBSTRING(E.COMPANY_NUM,1,3) + '-'
                                + SUBSTRING(E.COMPANY_NUM,4,2) + '-'
                                + SUBSTRING(E.COMPANY_NUM,6,5)
                  END          AS MY_COMPANY_NUM          --등록번호
                  , E.ZIP_CODE    AS MY_ZIP_CODE          --우편번호
                  , E.ADDR AS  MY_ADDR              --주소
                  , E.TELEPHON                            --전화번호
                  , E.FAX_NUM                             --팩스
                  , @PRINT_USER                             AS PRINT_USER                   --출력자 이름
                  , @VIEW_PRINT_INFO_YN                     AS VIEW_PRINT_INFO_YN           --인쇄출력정보 표시여부
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN MPO100T A2 WITH (NOLOCK)ON A2.COMP_CODE = A.COMP_CODE
                                                      AND A2.DIV_CODE = A.DIV_CODE
                                                      AND A2.CUSTOM_CODE = A.CUSTOM_CODE
                                                      AND A2.ORDER_NUM = A.ORDER_NUM
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BCM100T D WITH (NOLOCK) ON D.COMP_CODE = A.COMP_CODE
                                                      AND D.CUSTOM_CODE = A.CUSTOM_CODE
                    INNER JOIN BOR120T E  WITH (NOLOCK)ON E.COMP_CODE   = A.COMP_CODE
                                                      AND E.DIV_CODE    = A.DIV_CODE
                     LEFT JOIN BSA100T F WITH (NOLOCK) ON F.COMP_CODE   = A.COMP_CODE
                                                      AND F.MAIN_CODE   = 'M201'
                                                      AND F.SUB_CODE    = A2.ORDER_PRSN
                     LEFT JOIN BSA100T I WITH (NOLOCK) ON I.COMP_CODE   = A.COMP_CODE
                                                      AND I.SUB_CODE   != N'$'
                                                      AND I.MAIN_CODE   = 'M008'
                                                      AND I.REF_CODE1   = 'Y'

                     LEFT JOIN BSA220T J WITH (NOLOCK) ON J.COMP_CODE   = A.COMP_CODE
                                                      AND J.TYPE_LEVEL  = A.DIV_CODE
                                                      AND J.TREE_CODE   = A.WH_CODE


            WHERE   A.COMP_CODE = @CompCode
            AND A.DIV_CODE = #{DIV_CODE}

            AND ((I.SUB_CODE = '1' AND A2.AGREE_STATUS = '2')
                   OR
                 (I.SUB_CODE = '1' AND A2.AGREE_STATUS = '1' AND ISNULL(I.REF_CODE3,'N') = 'Y')
                  OR
                 (I.SUB_CODE = '2' AND A2.AGREE_STATUS IS NOT NULL))

          --  AND A2.ORDER_TYPE  != N'4'    /*외주*/
            AND A.CONTROL_STATUS NOT IN ('8', '9')

            AND  A.ORDER_SEQ = '1'

            AND A.ORDER_NUM = #{ORDER_NUM}

            ORDER BY A.ORDER_NUM, A.ORDER_SEQ, A.ITEM_CODE


            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="mpo502ukrvServiceImpl.subReport" parameterType="Map" resultType="rMap">
        --mpo501ukrv.Cmpo501ukrv[fnMpo200QStd] Query04
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON


            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(20) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */

            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}

            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'

            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

            /* 데이터 조회 */
            SELECT  A.DIV_CODE
                  , A.CUSTOM_CODE
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.UNIT_PRICE_TYPE
                  , A.MONEY_UNIT
                  , A.ORDER_UNIT_P
                  , CONVERT(INT,A.ORDER_O) AS ORDER_O
                  , A.EXCHG_RATE_O
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  , A.WH_CODE
                  , J.TREE_NAME AS WH_NAME
                  , A.TRNS_RATE
                  , A.ORDER_Q
                  , A.ORDER_P
                  , A.CONTROL_STATUS
                  , A.ORDER_REQ_NUM
                  --, A.PO_REQ_NUM
                  --, A.PO_REQ_SEQ                                        AS PO_SER_NO
                  , A.INSTOCK_Q
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.PROJECT_NO
                  --, C.LOT_YN
                  , A.LOT_NO
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    LEFT JOIN BSA220T J WITH (NOLOCK) ON J.COMP_CODE   = A.COMP_CODE
                                                      AND J.TREE_CODE   = A.WH_CODE

            WHERE   A.COMP_CODE = @CompCode

            AND     A.ORDER_NUM = #{ORDER_NUM}

            ORDER BY A.ORDER_NUM, A.ORDER_SEQ


            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>




<!-- 수주참조 -->
	<select id="mpo502ukrvServiceImpl.selectOrderList" parameterType="Map" resultType="rMap">
		SELECT
			A.DIV_CODE,
    		B.CUSTOM_CODE,
			B.ORDER_NUM,
		    A.SER_NO,
		    A.ITEM_CODE,
		    C.ITEM_NAME,
		    D.SPEC,
		    D.STOCK_UNIT,
		    C.ORDER_UNIT,												--구매단위
		    C.TRNS_RATE,												--구매입수
			A.DVRY_DATE,
		    B.PROJECT_NO,
		    A.ORDER_Q								AS SALE_Q,			--판매수량
		    A.ORDER_Q * D.TRNS_RATE					AS ORDER_Q,			--재고수량
		    A.ORDER_Q * D.TRNS_RATE / C.TRNS_RATE	AS ORDER_UNIT_Q		--구매수량
		FROM			   SOF110T A  WITH(NOLOCK)
		        INNER JOIN SOF100T B  WITH(NOLOCK)  ON  B.COMP_CODE		= A.COMP_CODE
													AND B.DIV_CODE		= A.DIV_CODE
													AND B.ORDER_NUM		= A.ORDER_NUM
		        INNER JOIN BPR200T C WITH(NOLOCK)   ON  C.COMP_CODE		= A.COMP_CODE
		        									AND C.DIV_CODE		= A.DIV_CODE
													AND C.ITEM_CODE		= A.ITEM_CODE
		        INNER JOIN BPR100T D WITH(NOLOCK)   ON  D.COMP_CODE		= A.COMP_CODE
													AND D.ITEM_CODE		= A.ITEM_CODE
		        LEFT  JOIN BCM600T E WITH(NOLOCK)   ON  E.COMP_CODE		= B.COMP_CODE
													AND E.PJT_CODE		= B.PROJECT_NO
				--20190723 발주등록된 데이터는 조회되지 않도록 로직 추가
				LEFT  JOIN (SELECT COMP_CODE, DIV_CODE, CUSTOM_CODE, SO_NUM, SO_SEQ, SUM(ORDER_Q) AS ORDER_Q
							  FROM MPO200T WITH(NOLOCK)
							 WHERE COMP_CODE = #{S_COMP_CODE}
							   AND DIV_CODE  = #{DIV_CODE}
							 GROUP BY COMP_CODE, DIV_CODE, CUSTOM_CODE, SO_NUM, SO_SEQ) F   ON  F.COMP_CODE   = A.COMP_CODE
																							AND F.DIV_CODE    = A.DIV_CODE
																							AND F.CUSTOM_CODE = B.CUSTOM_CODE
																							AND F.SO_NUM      = A.ORDER_NUM
																							AND F.SO_SEQ      = A.SER_NO
		WHERE A.COMP_CODE = #{S_COMP_CODE}
			AND A.OUT_DIV_CODE = #{DIV_CODE}
			--20190723 발주등록된 데이터는 조회되지 않도록 로직 추가
			AND A.ORDER_Q * D.TRNS_RATE &gt; ISNULL(F.ORDER_Q, 0)
		<if test="@foren.Ognl@isNotEmpty(PJT_CODE)">
			AND B.PROJECT_NO		LIKE #{PJT_CODE} + '%'
		</if>
		<if test="@foren.Ognl@isNotEmpty(ITEM_ACCOUNT)">
			AND C.ITEM_ACCOUNT = #{ITEM_ACCOUNT}    /* 품목계정 */
		</if>
		<if test="@foren.Ognl@isNotEmpty(FR_ORDER_DATE)">
			AND B.ORDER_DATE &gt;= #{FR_ORDER_DATE}    	/* 수주일자 */
		</if>
		<if test="@foren.Ognl@isNotEmpty(TO_ORDER_DATE)">
			AND B.ORDER_DATE &lt;= #{TO_ORDER_DATE}    	/* 수주일자 */
		</if>
		<if test="@foren.Ognl@isNotEmpty(FROM_NUM)">
			AND B.ORDER_NUM = #{FROM_NUM}    	/* 수주번호 */
		</if>
		<if test="@foren.Ognl@isNotEmpty(ITEM_CODE_FR)">
			AND A.ITEM_CODE LIKE #{ITEM_CODE_FR}   	/* 수주품번 */
		</if>
		ORDER BY ORDER_NUM DESC, SER_NO, ITEM_CODE
	</select>

	<select id="mpo502ukrvServiceImpl.selectOrderHistoryList" parameterType="Map" resultType="rMap">
        /*mpo502ukrvServiceImpl.selectOrderHistoryList*/
	       SELECT   B.DIV_CODE
	       			   ,A.CUSTOM_CODE
					   ,C.CUSTOM_NAME
					   ,A.ORDER_DATE
					   ,A.ORDER_NUM
					   ,B.ORDER_SEQ
					   ,B.ITEM_CODE
					   ,C1.ITEM_NAME
					   ,C1.SPEC
					   ,B.ORDER_UNIT
					   ,C1.STOCK_UNIT
					   ,B.TRNS_RATE
					   ,B.ORDER_Q
					   ,B.ORDER_UNIT_Q
					   ,B.ORDER_P
					   ,B.ORDER_UNIT_P
					   ,B.ORDER_O
					   ,B.IN_DIV_CODE
					   ,A.ORDER_TYPE
					   ,B.WH_CODE
					   , B.REMARK
					   ,ISNULL(C2.INSPEC_YN, B.INSPEC_FLAG) AS INSPEC_FLAG
				FROM	   MPO100T A
				INNER JOIN MPO200T B ON B.COMP_CODE    = A.COMP_CODE
									 AND B.DIV_CODE    = A.DIV_CODE
									 AND B.ORDER_NUM   = A.ORDER_NUM
				LEFT JOIN  BCM100T C ON  C.COMP_CODE   = A.COMP_CODE
									AND  C.CUSTOM_CODE = A.CUSTOM_CODE
				LEFT JOIN BPR100T C1 ON  C1.COMP_CODE  = B.COMP_CODE
									AND  C1.ITEM_CODE  = B.ITEM_CODE
				LEFT JOIN BPR200T C2 ON  C2.COMP_CODE  = B.COMP_CODE
									AND  C2.DIV_CODE   = B.IN_DIV_CODE
									AND  C2.ITEM_CODE  = B.ITEM_CODE
        	WHERE A.COMP_CODE = #{S_COMP_CODE}
            	AND A.DIV_CODE    = #{DIV_CODE}

            <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">
                AND A.CUSTOM_CODE = #{CUSTOM_CODE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME)">
                AND C.CUSTOM_NAME LIKE '%' + #{CUSTOM_NAME} + '%'
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">
                AND A.ORDER_DATE  >= #{ORDER_DATE_FR}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">
                AND A.ORDER_DATE  <![CDATA[<=]]> #{ORDER_DATE_TO}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
                AND A.ORDER_PRSN  = #{ORDER_PRSN}
            </if>
            <if test="@foren.Ognl@isNotEmpty(AGREE_STATUS)">
                AND A.AGREE_STATUS  = #{AGREE_STATUS}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
                AND B.PROJECT_NO  = #{PROJECT_NO}
            </if>

        ORDER BY A.ORDER_NUM, B.ORDER_SEQ
    </select>
</mapper>