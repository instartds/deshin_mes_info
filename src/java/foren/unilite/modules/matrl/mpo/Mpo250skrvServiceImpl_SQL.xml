<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mpo250skrvServiceImpl">

<select id="mpo250skrvServiceImpl.getThisWeek" parameterType="Map" resultType="rMap">

	SELECT CAL_NO

	FROM BCM420T WITH (NOLOCK)
	WHERE COMP_CODE = #{S_COMP_CODE}
	 AND CAL_TYPE = '3'
	 AND START_DATE &lt;= CONVERT(NVARCHAR(08), getDate(), 112)
	 AND END_DATE &gt;= CONVERT(NVARCHAR(08), getDate(), 112)
</select>


<select id="mpo250skrvServiceImpl.getOrderWeek" parameterType="Map" resultType="comboItem">

	SELECT CAL_NO AS 'value'
		 , CAL_NO AS 'text'
		 , START_DATE AS refCode1
		 , END_DATE AS refCode2

	FROM BCM420T WITH (NOLOCK)
	WHERE COMP_CODE = #{S_COMP_CODE}
	 AND CAL_TYPE = '3'
	 AND CAL_NO >= '2019001'
</select>
<select id="mpo250skrvServiceImpl.selectMasterList" parameterType="Map" resultType="rMap">
      
SELECT 
	A.COMP_CODE                                            
        , A.IN_DIV_CODE
		, B.CUSTOM_CODE -- 거래처 
		, MAX(R2.CUSTOM_NAME) AS CUSTOM_NAME
		, COUNT (DISTINCT B.ORDER_NUM)  AS ORDER_COUNT --발주건수
		, COUNT(A.ITEM_CODE)  AS ITEM_COUNT -- 품목건수
		, COUNT(CASE WHEN A.ORDER_Q - A.INSTOCK_Q &lt;= 0 OR A.CONTROL_STATUS = '9' THEN 1 END) AS INSTOCK_Q_SUM -- 품목대응건수	
		, CONVERT(NUMERIC(30,6), COUNT(CASE WHEN A.ORDER_Q - A.INSTOCK_Q &lt;= 0 OR A.CONTROL_STATUS = '9' THEN 1 END)) / CONVERT(NUMERIC(30,6), COUNT(A.ITEM_CODE)) * 100.00 AS C_RESP_RATE-- 품목대응률
		, SUM(A.ORDER_UNIT_Q) AS ORDER_UNIT_Q_SUM  -- 발주수량
		, SUM(A.INSTOCK_Q) / SUM(A.ORDER_Q) *  100  AS Q_RESP_RATE-- 수량 대응률

 FROM MPO200T A WITH(NOLOCK)
		INNER JOIN MPO100T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
								     AND A.DIV_CODE  = B.DIV_CODE
									 AND A.ORDER_NUM = B.ORDER_NUM
	    LEFT JOIN BPR200T R1 WITH(NOLOCK) ON R1.COMP_CODE = B.COMP_CODE
		                             AND R1.DIV_CODE  = B.DIV_CODE
								     AND R1.ITEM_CODE = A.ITEM_CODE
	    LEFT JOIN BCM100T R2 WITH(NOLOCK) ON R2.COMP_CODE = B.COMP_CODE
		                             AND R2.CUSTOM_CODE  = B.CUSTOM_CODE
	    LEFT JOIN  MRP400T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
	  								 AND A.IN_DIV_CODE   = C.IN_DIV_CODE
	  								 AND A.ORDER_REQ_NUM = C.ORDER_REQ_NUM
	    LEFT JOIN  SOF110T D WITH(NOLOCK) ON C.COMP_CODE = D.COMP_CODE
	  								 AND C.ORDER_NUM = D.ORDER_NUM
	  								 AND C.ORDER_SEQ = D.SER_NO
WHERE A.COMP_CODE = #{S_COMP_CODE}
  AND A.IN_DIV_CODE = #{DIV_CODE}
  AND D.DVRY_DATE &gt;= #{ORDER_DATE_FR}
  AND D.DVRY_DATE &lt;= #{ORDER_DATE_TO}
<if test="@foren.Ognl@isNotEmpty(ITEM_ACCOUNT)">
  AND R1.ITEM_ACCOUNT = #{ITEM_ACCOUNT}
</if>

GROUP BY A.COMP_CODE, A.IN_DIV_CODE, B.CUSTOM_CODE
</select>

<select id="mpo250skrvServiceImpl.selectDetailList1" parameterType="Map" resultType="rMap">
SELECT 
		A.COMP_CODE
		,A.DIV_CODE
		,A.ORDER_NUM
		,A.ORDER_SEQ
		,A.ITEM_CODE
		,R1.ITEM_NAME
		,R1.SPEC
		,A.ORDER_UNIT
		,A.ORDER_UNIT_Q
		,A.INSTOCK_Q / A.TRNS_RATE AS TRNS_INSTOCK_Q
		
		,(CASE WHEN A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE &lt; 0 THEN 0
		     ELSE A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE 
	     END) AS NO_INSTOCK_Q
		 ,(SELECT 
			ISNULL(SUM(S1.RECEIPT_Q),0) - ISNULL(SUM(S1.INSPEC_Q),0) / A.TRNS_RATE 
		   FROM QMS100T S1 WITH(NOLOCK) 
		  WHERE S1.COMP_CODE = A.COMP_CODE
		    AND S1.DIV_CODE = A.DIV_CODE
			AND S1.ORDER_NUM = A.ORDER_NUM
			AND S1.ORDER_SEQ = A.ORDER_SEQ
			AND S1.INSPEC_FLAG = 'Y'

			GROUP BY S1.COMP_CODE, S1.DIV_CODE, S1.ORDER_NUM, S1.ORDER_SEQ
			) AS WAIT_INSPEC_Q
		 ,A.DVRY_DATE
	FROM MPO200T A WITH(NOLOCK) 
		INNER JOIN MPO100T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
								     AND A.DIV_CODE  = B.DIV_CODE
									 AND A.ORDER_NUM = B.ORDER_NUM
	    LEFT JOIN BPR100T R1 WITH(NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
								     AND R1.ITEM_CODE = A.ITEM_CODE
		LEFT JOIN BPR200T R2 WITH(NOLOCK) ON R2.COMP_CODE = B.COMP_CODE
		                             AND R2.DIV_CODE  = B.DIV_CODE
								     AND R2.ITEM_CODE = A.ITEM_CODE
	    LEFT JOIN  MRP400T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
	  								 AND A.IN_DIV_CODE   = C.IN_DIV_CODE
	  								 AND A.ORDER_REQ_NUM = C.ORDER_REQ_NUM
	    LEFT JOIN  SOF110T D WITH(NOLOCK) ON C.COMP_CODE = D.COMP_CODE
	  								 AND C.ORDER_NUM = D.ORDER_NUM
	  								 AND C.ORDER_SEQ = D.SER_NO
	WHERE A.COMP_CODE = #{S_COMP_CODE}
      AND A.IN_DIV_CODE = #{IN_DIV_CODE}
      AND D.DVRY_DATE &gt;= #{ORDER_DATE_FR}
      AND D.DVRY_DATE &lt;= #{ORDER_DATE_TO}
      AND B.CUSTOM_CODE = #{CUSTOM_CODE}
      AND A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE &gt; 0
      AND A.CONTROL_STATUS != '9'
	<if test="@foren.Ognl@isNotEmpty(ITEM_ACCOUNT)">
	  AND R2.ITEM_ACCOUNT = #{ITEM_ACCOUNT}
	</if>
</select>

<select id="mpo250skrvServiceImpl.selectDetailList2" parameterType="Map" resultType="rMap">
      SELECT 
		A.COMP_CODE
		,A.DIV_CODE
		,A.ORDER_NUM
		,A.ORDER_SEQ
		,A.ITEM_CODE
		,R1.ITEM_NAME
		,R1.SPEC
		,A.ORDER_UNIT
		,A.ORDER_UNIT_Q
		,A.INSTOCK_Q / A.TRNS_RATE AS TRNS_INSTOCK_Q
		
		,(CASE WHEN A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE &lt; 0 THEN 0
		     ELSE A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE 
	     END) AS NO_INSTOCK_Q
	    ,A.CONTROL_STATUS
	FROM MPO200T A WITH(NOLOCK) 
		INNER JOIN MPO100T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
								     AND A.DIV_CODE  = B.DIV_CODE
									 AND A.ORDER_NUM = B.ORDER_NUM
         LEFT JOIN BPR100T R1 WITH(NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
								     AND R1.ITEM_CODE = A.ITEM_CODE
		LEFT JOIN BPR200T R2 WITH(NOLOCK) ON R2.COMP_CODE = B.COMP_CODE
		                             AND R2.DIV_CODE  = B.DIV_CODE
								     AND R2.ITEM_CODE = A.ITEM_CODE
	    LEFT JOIN  MRP400T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
	  								 AND A.IN_DIV_CODE   = C.IN_DIV_CODE
	  								 AND A.ORDER_REQ_NUM = C.ORDER_REQ_NUM
	    LEFT JOIN  SOF110T D WITH(NOLOCK) ON C.COMP_CODE = D.COMP_CODE
	  								 AND C.ORDER_NUM = D.ORDER_NUM
	  								 AND C.ORDER_SEQ = D.SER_NO
	WHERE A.COMP_CODE = #{S_COMP_CODE}
      AND A.IN_DIV_CODE = #{IN_DIV_CODE}
      AND D.DVRY_DATE &gt;= #{ORDER_DATE_FR}
      AND D.DVRY_DATE &lt;= #{ORDER_DATE_TO}
      AND B.CUSTOM_CODE = #{CUSTOM_CODE}
      AND (A.ORDER_UNIT_Q - A.INSTOCK_Q / A.TRNS_RATE &lt;= 0
      OR A.CONTROL_STATUS = '9')
	<if test="@foren.Ognl@isNotEmpty(ITEM_ACCOUNT)">
	  AND R2.ITEM_ACCOUNT = #{ITEM_ACCOUNT}
	</if>
</select>

</mapper>