<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="map150skrvServiceImpl">
					
	<select id="map150skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">

BEGIN

SET NOCOUNT ON
SET ARITHABORT ON

DECLARE @START_TIME DATETIME
      , @END_TIME   DATETIME
      , @DIFF_TIME  NUMERIC(10, 0)

SET @START_TIME = GETDATE()

/* 전사 매입집계 현황 조회 */

	DECLARE @COMP_CODE  	NVARCHAR(08)
		   ,@DIV_CODE   	NVARCHAR(08)
		   ,@BILL_DATE_FR	NVARCHAR(08)
		   ,@BILL_DATE_TO	NVARCHAR(08)
		   ,@CUSTOM_CODE	NVARCHAR(20)
		   ,@PAY_YYYYMM		NVARCHAR(06)
		   ,@AGENT_TYPE		NVARCHAR(10)
		   ,@COLLECT_DAY	NVARCHAR(02)
		   ,@PAY_SEQ		NVARCHAR(02)

   SET @COMP_CODE		= #{S_COMP_CODE}   /* 법인 */
   SET @BILL_DATE_FR	= #{FR_DATE}   /* 계산서일자(FROM) */
   SET @BILL_DATE_TO	= #{TO_DATE}   /* 계산서일자(TO) */
   SET @CUSTOM_CODE		= #{CUSTOM_CODE}   /* 매입처 */
   SET @PAY_YYYYMM		= #{PAY_YYYYMM}   	/* 지불월 */
   SET @AGENT_TYPE		= #{AGENT_TYPE}    /* 거래처분류*/
   SET @COLLECT_DAY		= #{COLLECT_DAY}   /* 지불일 */
   SET @PAY_SEQ			= ''     	/* 차수 */
   
   /* [신촌캠퍼스], [국제캠퍼스], 과세/면세/부가세액/합계금액, 지불금액  */

   SELECT
	A.CUSTOM_CODE,		A.CUSTOM_NAME
   ,A.AMOUNT_TAX_01,	A.AMOUNT_EXP_01,  A.TAX_01, A.TOTAL_01, ISNULL(D.PAY_AMT_01, 0) AS PAY_AMT_01
   ,A.AMOUNT_TAX_02,	A.AMOUNT_EXP_02,  A.TAX_02, A.TOTAL_02, ISNULL(D.PAY_AMT_02, 0) AS PAY_AMT_02
   ,A.AMOUNT_TAX_03,	A.AMOUNT_EXP_03,  A.TAX_03, A.TOTAL_03, ISNULL(D.PAY_AMT_03, 0) AS PAY_AMT_03
   ,A.AMOUNT_TAX_TOTAL
   ,A.AMOUNT_EXP_TOTAL
   ,A.TAX_TOTAL
   ,A.TOTAL
   ,ISNULL(D.PAY_AMT_01, 0) + ISNULL(D.PAY_AMT_02, 0) + ISNULL(D.PAY_AMT_03, 0) AS PAY_AMT_TOTAL
   FROM
   (
  SELECT
   A.COMP_CODE
  , A.CUSTOM_CODE
  , MAX(C.CUSTOM_NAME) AS CUSTOM_NAME
  , SUM(CASE WHEN A.DIV_CODE = '01' AND A.BILL_TYPE = '51' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_TAX_01
  , SUM(CASE WHEN A.DIV_CODE = '01' AND A.BILL_TYPE = '57' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_EXP_01
  , SUM(CASE WHEN A.DIV_CODE = '01' THEN B.TAX_I ELSE 0 END) AS TAX_01
  , SUM(CASE WHEN A.DIV_CODE = '01' THEN B.AMOUNT_I + B.TAX_I ELSE 0 END) AS TOTAL_01

  , SUM(CASE WHEN A.DIV_CODE = '02' AND A.BILL_TYPE = '51' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_TAX_02
  , SUM(CASE WHEN A.DIV_CODE = '02' AND A.BILL_TYPE = '57' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_EXP_02
  , SUM(CASE WHEN A.DIV_CODE = '02' THEN B.TAX_I ELSE 0 END) AS TAX_02
  , SUM(CASE WHEN A.DIV_CODE = '02' THEN B.AMOUNT_I + B.TAX_I ELSE 0 END) AS TOTAL_02

  , SUM(CASE WHEN A.DIV_CODE = '03' AND A.BILL_TYPE = '51' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_TAX_03
  , SUM(CASE WHEN A.DIV_CODE = '03' AND A.BILL_TYPE = '57' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_EXP_03
  , SUM(CASE WHEN A.DIV_CODE = '03' THEN B.TAX_I ELSE 0 END) AS TAX_03
  , SUM(CASE WHEN A.DIV_CODE = '03' THEN B.AMOUNT_I + B.TAX_I ELSE 0 END) AS TOTAL_03

  , SUM(CASE WHEN A.BILL_TYPE = '51' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_TAX_TOTAL
  , SUM(CASE WHEN A.BILL_TYPE = '57' THEN B.AMOUNT_I ELSE 0 END) AS AMOUNT_EXP_TOTAL
  , SUM(B.TAX_I)                    AS TAX_TOTAL
  , SUM(B.AMOUNT_I + B.TAX_I)       AS TOTAL
  FROM   	  MAP100T A WITH(NOLOCK)
  INNER JOIN  MAP200T B WITH(NOLOCK) ON  A.COMP_CODE    = B.COMP_CODE 
					                 AND A.DIV_CODE     = B.DIV_CODE 
					                 AND A.CHANGE_BASIS_NUM = B.CHANGE_BASIS_NUM
  INNER JOIN  BCM100T C WITH(NOLOCK) ON A.COMP_CODE    = C.COMP_CODE 
  									AND A.CUSTOM_CODE  = C.CUSTOM_CODE

  WHERE A.COMP_CODE = @COMP_CODE
     AND A.DIV_CODE  &gt; ''
     AND A.BILL_DATE &gt;= @BILL_DATE_FR
     AND A.BILL_DATE &lt;= @BILL_DATE_TO
     AND (@CUSTOM_CODE  = '' OR (@CUSTOM_CODE  != '' AND A.CUSTOM_CODE = @CUSTOM_CODE))
     AND (@AGENT_TYPE   = '' OR (@AGENT_TYPE   != '' AND C.AGENT_TYPE  = @AGENT_TYPE))
     AND (@COLLECT_DAY  = '' OR (@COLLECT_DAY  != '' AND C.COLLECT_DAY = @COLLECT_DAY))

  GROUP BY A.COMP_CODE, C.CUSTOM_NAME, A.CUSTOM_CODE
 ) A 
    LEFT JOIN (
		       SELECT COMP_CODE, CUSTOM_CODE
				      ,SUM(CASE WHEN DIV_CODE = '01'  THEN ISNULL(PAY_AMT, 0) ELSE 0 END) AS PAY_AMT_01
				      ,SUM(CASE WHEN DIV_CODE = '02'  THEN ISNULL(PAY_AMT, 0) ELSE 0 END) AS PAY_AMT_02
				      ,SUM(CASE WHEN DIV_CODE = '03'  THEN ISNULL(PAY_AMT, 0) ELSE 0 END) AS PAY_AMT_03
		      FROM MAP050T WITH(NOLOCK)
		        WHERE COMP_CODE = @COMP_CODE
		          AND PAY_YYYYMM = @PAY_YYYYMM
		          AND (@CUSTOM_CODE = '' OR (@CUSTOM_CODE != '' AND CUSTOM_CODE = @CUSTOM_CODE))
		          AND (@PAY_SEQ     = '' OR (@PAY_SEQ     != '' AND @PAY_SEQ    = COLLECT_DAY))
		
		      GROUP BY COMP_CODE, CUSTOM_CODE

		      ) D  ON A.COMP_CODE    = D.COMP_CODE
		          AND A.CUSTOM_CODE  = D.CUSTOM_CODE

 ORDER BY A.CUSTOM_NAME, A.CUSTOM_CODE


SET @END_TIME   = GETDATE()

SET @DIFF_TIME = DATEDIFF(S, @START_TIME, @END_TIME)

EXEC uniLITE.SP_QRY_TIME 'map150skrv', '전사 매입집계현황 조회', @BILL_DATE_FR, @BILL_DATE_TO, @DIFF_TIME

 SET ARITHABORT OFF
 SET NOCOUNT OFF

END
    </select>
	
	
</mapper>