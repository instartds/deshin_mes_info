<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_mpo501ukrv_jwServiceImpl">
	
    <select id="s_mpo501ukrv_jwServiceImpl.mainReport" parameterType="Map" resultType="rMap">	
    	/* s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo200QStd] Query01 */
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
            
            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                        
            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}
            
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId
            
            SET @RefItem = ISNULL(@RefItem, N'0')
            
            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
        
            /* 데이터 조회 */
            SELECT  A.DIV_CODE
                  , A.CUSTOM_CODE
				  , R1.CUSTOM_NAME
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE										--제품코드
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME							--제품명
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q					--ROLL(발주수량)
                  , A.ORDER_UNIT

                  , A.ORDER_UNIT_P					--PRICE
                  , A.ORDER_O						--AMOUNT
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE		--납기일
                  , A.DVRY_TIME
                  , A.WH_CODE							--창고코드
				  , T.TREE_NAME							--납품장소
                  , A.TRNS_RATE							--LENTH
                  , A.INSPEC_FLAG
                  , A.REMARK							--비고
                  , A2.REMARK	AS TOP_REMARK						--비고
                  , B.ITEM_WIDTH					--폭(WIDTH)

               --   , A.DELIVERY_PLACE							--업체코드
				  , S.CODE_NAME			AS DELIVERY_PLACE			--업체
                  , A.USAGE_PLACE						

				  , CASE WHEN B.ITEM_WIDTH = 0 THEN A.ORDER_UNIT_Q * A.TRNS_RATE
				         ELSE A.ORDER_UNIT_Q * A.TRNS_RATE * B.ITEM_WIDTH / 1000 
				    END AS SQM
				  , A2.ORDER_DATE
				, R1.FAX_NUM

            FROM               MPO200T A WITH (NOLOCK)
					INNER JOIN MPO100T A2 WITH(NOLOCK) ON A2.COMP_CODE = A.COMP_CODE
													  AND A2.DIV_CODE = A.DIV_CODE
													  AND A2.ORDER_NUM = A.ORDER_NUM
													  AND A2.CUSTOM_CODE = A.CUSTOM_CODE
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE                                                      
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    LEFT JOIN BSA100T S WITH(NOLOCK) ON S.COMP_CODE = A.COMP_CODE 
													AND S.MAIN_CODE = 'Z009'
													AND S.SUB_CODE = A.DELIVERY_PLACE
					LEFT JOIN BSA220T T WITH(NOLOCK) ON T.COMP_CODE = A.COMP_CODE
													AND T.TREE_CODE = A.WH_CODE

					LEFT JOIN BCM100T R1 WITH(NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
													 AND R1.CUSTOM_CODE = A.CUSTOM_CODE

            WHERE   A.COMP_CODE = #{S_COMP_CODE}
             
            AND     A.ORDER_NUM = #{ORDER_NUM}
             
        	ORDER BY A.COMP_CODE, A.DIV_CODE,A.ORDER_NUM,A.ORDER_SEQ
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END 
    
    </select>
	
	
	
	
    <select id="s_mpo501ukrv_jwServiceImpl.selectOrderPrsn" parameterType="Map" resultType="rMap">	
    	--s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo200QStd] Query08
        SELECT TOP 1 SUB_CODE
        FROM   BSA100T A WITH (NOLOCK)
        WHERE  A.COMP_CODE  = #{S_COMP_CODE}
        AND    A.MAIN_CODE  = N'M201'
        AND    A.SUB_CODE  != N'$'
        AND    A.REF_CODE2  = #{S_USER_ID}
        AND    A.USE_YN     = N'Y'
    </select>
    	
    <select id="s_mpo501ukrv_jwServiceImpl.selectOrderNumMasterList" parameterType="Map" resultType="rMap">
    	/*s_mpo501ukrv_jw.Cs_mpo501ukrv_jw pop*/
    BEGIN
        SET NOCOUNT ON
        SET ARITHABORT ON
    
        DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
              , @UserId      NVARCHAR(100) /* 사용자ID    */
              , @LangType    NVARCHAR(2)  /* 언어구분    */
              , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
              , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
    
    	SET @CompCode = #{S_COMP_CODE}
        SET @UserId   = #{S_USER_ID}
        SET @LangType = #{S_LANG_CODE}    
    
        /* 명칭 참조 유형 */
        SELECT TOP 1 @RefItem = REF_ITEM
          FROM BSA300T WITH (NOLOCK)
         WHERE USER_ID = @UserId
    
        SET @RefItem = ISNULL(@RefItem, N'0')
    
        /* 날짜 포맷 유형 설정 */
        SELECT TOP 1 @DateFormat = CODE_NAME
          FROM BSA100T WITH (NOLOCK)
         WHERE COMP_CODE = @CompCode
           AND MAIN_CODE = N'B044'
           AND REF_CODE1 = N'Y'
    
        SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
    
        /* 데이터 조회 */
        SELECT  B.CUSTOM_NAME                                                       AS CUSTOM_NAME
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
                                   , 'MM',   SUBSTRING(A.ORDER_DATE, 5, 2))
                                   , 'DD',   SUBSTRING(A.ORDER_DATE, 7, 2))         AS ORDER_DATE
              , A.ORDER_TYPE                                                        AS ORDER_TYPE
              , A.ORDER_NUM                                                         AS ORDER_NUM
              , A.CUSTOM_CODE                                                       AS CUSTOM_CODE
            
              , A.ORDER_PRSN                                                        AS ORDER_PRSN
              , A.AGREE_STATUS                                                      AS AGREE_STATUS
              , A.AGREE_PRSN                                                        AS AGREE_PRSN
              , C.USER_NAME                                                         AS AGREE_PRSN_NAME
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                   , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                   , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))         AS AGREE_DATE
              , A.MONEY_UNIT                                                        AS MONEY_UNIT
              , A.LC_NUM                                                            AS LC_NUM
              , A.RECEIPT_TYPE                                                      AS RECEIPT_TYPE
              , A.REMARK                                                            AS REMARK
              , A.EXCHG_RATE_O                                                      AS EXCHG_RATE_O
              , A.DRAFT_YN                                                          AS DRAFT_YN
              , A.DIV_CODE                                                          AS DIV_CODE
              , A.PROJECT_NO                                                        AS PROJECT_NO
              ,	D.COMP_NAME
        FROM                MPO100T A WITH  (NOLOCK)
                INNER JOIN  BCM100T B WITH  (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                    AND B.CUSTOM_CODE = A.CUSTOM_CODE
                LEFT  JOIN  BSA300T C WITH  (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
                                                    AND C.USER_ID     = A.AGREE_PRSN
     			LEFT  JOIN  BOR100T D WITH  (NOLOCK) ON D.COMP_CODE   = A.COMP_CODE
     			INNER JOIN  MPO200T E WITH  (NOLOCK) ON E.COMP_CODE   = A.COMP_CODE
     												AND E.DIV_CODE	  = A.DIV_CODE
     												AND E.ORDER_NUM	  = A.ORDER_NUM
     												AND E.CUSTOM_CODE = A.CUSTOM_CODE
        WHERE   A.COMP_CODE    = @CompCode
        AND     A.ORDER_TYPE  != N'4'
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">    
        AND   A.DIV_CODE       = #{DIV_CODE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">          
        AND   A.ORDER_TYPE     = #{ORDER_TYPE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">        
        AND   A.ORDER_DATE    &gt;= #{ORDER_DATE_FR}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">     
        AND   A.ORDER_DATE    &lt;= #{ORDER_DATE_TO}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">    
        AND   A.ORDER_PRSN     = #{ORDER_PRSN}
        </if>
        <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">        
        AND   A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
        </if>
        <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME)">        
        AND   B.CUSTOM_NAME LIKE #{CUSTOM_NAME} + '%'
        </if>
        <if test="@foren.Ognl@isNotEmpty(AGREE_STATUS)"> 
        AND   A.AGREE_STATUS   = #{AGREE_STATUS}
        </if>
        <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">      
        AND   A.ORDER_NUM      = #{ORDER_NUM}
        </if>     
        <if test="@foren.Ognl@isNotEmpty(WH_CODE)">      
        AND   E.WH_CODE        = #{WH_CODE}
        </if>     
    
    GROUP BY   B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM, A.CUSTOM_CODE  
    		, A.DEPT_CODE, A.ORDER_PRSN, A.AGREE_STATUS
    		, A.AGREE_PRSN, C.USER_NAME, A.AGREE_DATE, A.MONEY_UNIT, A.LC_NUM
    		, A.RECEIPT_TYPE, A.REMARK, A.EXCHG_RATE_O, A.DRAFT_YN, A.DIV_CODE     
    		, A.PROJECT_NO, D.COMP_NAME    
    
        ORDER BY B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM
        
        SET ARITHABORT OFF
        SET NOCOUNT OFF
    END
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.selectMaster" parameterType="Map" resultType="rMap">
        --s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo200QStd] Query04
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
        
            DECLARE       @DateFormat       NVARCHAR(10)
        
            SELECT TOP 1 @DateFormat = M1.CODE_NAME
            FROM   BSA100T M1 WITH (NOLOCK)
            WHERE  M1.COMP_CODE = #{S_COMP_CODE}
            AND    M1.MAIN_CODE = N'B044'
            AND    M1.REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY/MM/DD')
        ---------------------------------------------------------------------------------------------------
            SELECT 
                   REPLACE(
                   REPLACE(
                   REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                      , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                      , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))   AS AGREE_DATE
                 , A.AGREE_PRSN
                 , ISNULL(B.USER_NAME, '') AS AGREE_PRSN_NAME
                 , A.AGREE_STATUS
                 , A.LC_NUM
                 , A.RECEIPT_TYPE
                 , A.REMARK
                 , A.DRAFT_YN
                 , A.DIV_CODE
                 , A.PROJECT_NO
            FROM              MPO100T A WITH (NOLOCK)
                   LEFT  JOIN BSA300T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                     AND B.USER_ID   = A.AGREE_PRSN
            WHERE  A.COMP_CODE   = #{S_COMP_CODE}
            AND    A.ORDER_NUM   = #{ORDER_NUM}
            AND    A.ORDER_TYPE != N'4'
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>
    	
    <select id="s_mpo501ukrv_jwServiceImpl.selectList" parameterType="Map" resultType="rMap">
    	/* s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo200QStd] Query01 */
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
            
            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                        
            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}   
            
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId
            
            SET @RefItem = ISNULL(@RefItem, N'0')
            
            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
        
            /* 데이터 조회 */
            SELECT  A.DIV_CODE
                  , A.CUSTOM_CODE
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.UNIT_PRICE_TYPE
                  , A.MONEY_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                  , A.EXCHG_RATE_O
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  , A.WH_CODE
                  , A.TRNS_RATE
                  , A.ORDER_Q
                  , A.ORDER_P
                  , A.CONTROL_STATUS
                  , A.ORDER_REQ_NUM
                  , A.PO_REQ_NUM
                  , A.PO_REQ_SEQ                                        AS PO_SER_NO
                  , A.INSTOCK_Q
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.PROJECT_NO
                  , C.LOT_YN
                  , A.LOT_NO
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
                  , A.SO_NUM
                  , A.SO_SEQ
--                  , CASE WHEN ISNULL(B.ITEM_WIDTH, 0) = 0 THEN 1000
--                  		 ELSE B.ITEM_WIDTH
--                  	END													AS ITEM_WIDTH
                  , B.ITEM_WIDTH
                  , A.DELIVERY_PLACE
                  , A.USAGE_PLACE
                  --20181218 추가
                  , A.RECEIPT_Q
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE                                                      
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    
            WHERE   A.COMP_CODE = @CompCode
            <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
            AND     A.ORDER_NUM = #{ORDER_NUM}
            </if>
        	ORDER BY A.ORDER_SEQ
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.selectList2" parameterType="Map" resultType="rMap">
        --s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo200QStd] Query02
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
        
            DECLARE       @DateFormat       NVARCHAR(10)
        
            SELECT TOP 1 @DateFormat = M1.CODE_NAME
            FROM   BSA100T M1 WITH (NOLOCK)
            WHERE  M1.COMP_CODE = #{S_COMP_CODE}
            AND    M1.MAIN_CODE = N'B044'
            AND    M1.REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY/MM/DD')
        ---------------------------------------------------------------------------------------------------
            SELECT 
                    A.DIV_CODE
                  , A.CUSTOM_CODE
                  , A.ORDER_NUM
                  , A.ORDER_SEQ
                  , A.ITEM_CODE
                  , B.ITEM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.UNIT_PRICE_TYPE
                  , A.MONEY_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                  , A.EXCHG_RATE_O
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.DVRY_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.DVRY_DATE, 7, 2))   AS DVRY_DATE
                  , A.DVRY_TIME AS DVRY_TIME
                  , A.WH_CODE
                  , A.TRNS_RATE
                  , A.ORDER_Q
                  , A.ORDER_P
                  , A.CONTROL_STATUS
                  , A.ORDER_REQ_NUM
                  , A.INSTOCK_Q
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.PROJECT_NO
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
--                  , CASE WHEN ISNULL(B.ITEM_WIDTH, 0) = 0 THEN 1000
--                  		 ELSE B.ITEM_WIDTH
--                  	END													AS ITEM_WIDTH
                  , B.ITEM_WIDTH
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
            WHERE   A.COMP_CODE = #{S_COMP_CODE}
            AND     A.ORDER_NUM = #{ORDER_NUM}
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END  
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.selectOrderNumMasterList2" parameterType="Map" resultType="rMap">
    	/*s_mpo501ukrv_jw.Cs_mpo501ukrv_jw[fnMpo100QStd] Query01*/
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
        
            DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
                  , @UserId      NVARCHAR(100) /* 사용자ID    */
                  , @LangType    NVARCHAR(2)  /* 언어구분    */
                  , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
                  , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
        
        	SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}    
        
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId
        
            SET @RefItem = ISNULL(@RefItem, N'0')
        
            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'
        
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
        
            /* 데이터 조회 */
        
            SELECT  B.CUSTOM_NAME                                                       AS CUSTOM_NAME
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.ORDER_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.ORDER_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.ORDER_DATE, 7, 2))         AS ORDER_DATE
                  , A.ORDER_TYPE                                                        AS ORDER_TYPE
                  , A.ORDER_NUM                                                         AS ORDER_NUM
                  , A.CUSTOM_CODE                                                       AS CUSTOM_CODE
                  , A.ORDER_PRSN                                                        AS ORDER_PRSN
                  , A.AGREE_STATUS                                                      AS AGREE_STATUS
                  , A.AGREE_PRSN                                                        AS AGREE_PRSN
                  , C.USER_NAME                                                         AS AGREE_PRSN_NAME
                  , REPLACE(
                    REPLACE(
                    REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.AGREE_DATE, 1, 4))
                                       , 'MM',   SUBSTRING(A.AGREE_DATE, 5, 2))
                                       , 'DD',   SUBSTRING(A.AGREE_DATE, 7, 2))         AS AGREE_DATE
                  , A.MONEY_UNIT                                                        AS MONEY_UNIT
                  , A.LC_NUM                                                            AS LC_NUM
                  , A.RECEIPT_TYPE                                                      AS RECEIPT_TYPE
                  , A.REMARK                                                            AS REMARK
                  , A.EXCHG_RATE_O                                                      AS EXCHG_RATE_O
                  , A.DRAFT_YN                                                          AS DRAFT_YN
                  , A.DIV_CODE                                                          AS DIV_CODE
                  , A.PROJECT_NO                                                        AS PROJECT_NO
                  , A.DEPT_CODE
            FROM                MPO100T A WITH  (NOLOCK)
                    INNER JOIN  BCM100T B WITH  (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
                                                        AND B.CUSTOM_CODE = A.CUSTOM_CODE
                    LEFT  JOIN  BSA300T C WITH  (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
                                                        AND C.USER_ID     = A.AGREE_PRSN
            WHERE   A.COMP_CODE    = @CompCode
            AND     A.ORDER_TYPE  != N'4'
            <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">    
            AND   A.DIV_CODE       = #{DIV_CODE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">          
            AND   A.ORDER_TYPE     = #{ORDER_TYPE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_FR)">        
            AND   A.ORDER_DATE    &gt;= #{ORDER_DATE_FR}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_DATE_TO)">     
            AND   A.ORDER_DATE    &lt;= #{ORDER_DATE_TO}
            </if>
            <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">    
            AND   A.ORDER_PRSN     = #{ORDER_PRSN}
            </if>
            <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">        
            AND   A.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
            </if>
            <if test="@foren.Ognl@isNotEmpty(AGREE_STATUS)"> 
            AND   A.AGREE_STATUS   = #{AGREE_STATUS}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">      
            AND   A.PROJECT_NO     = #{PROJECT_NO}
            </if> 
        
            ORDER BY B.CUSTOM_NAME, A.ORDER_DATE, A.ORDER_TYPE, A.ORDER_NUM
            
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>

    <select id="s_mpo501ukrv_jwServiceImpl.selectMre100tList" parameterType="Map" resultType="rMap">
        /* mre100ukrv.Cmre100ukrv[fnMre200QStd] Query01 */
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
            
            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                        
            SET @CompCode = 'master'
            SET @UserId   = 'unilite5'
            SET @LangType = 'ko'   
            
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId
            
            SET @RefItem = ISNULL(@RefItem, N'0')
            
            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
        
            /* 데이터 조회 */
            SELECT  A.DIV_CODE
                  , A.PO_REQ_NUM
                  , A.PO_SER_NO
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , C.CUSTOM_CODE
                  , C.CUSTOM_NAME
                  , B.SPEC
                  , B.STOCK_UNIT         
                  , A.ORDER_UNIT_Q
                  , ISNULL(A.ORDER_UNIT_Q, 0) - ISNULL(F.ORDER_UNIT_Q, 0) AS REMAIN_Q
                  , A.ORDER_UNIT
                  , A.MONEY_UNIT
                  , A.EXCHG_RATE_O      
                              
                  , A.UNIT_PRICE_TYPE         
                  , A.ORDER_P
                  , A.ORDER_O       
                  , A.ORDER_LOC_P
                  , A.ORDER_LOC_O
                  
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , CASE WHEN ISNULL(A.WH_CODE, '') = '' THEN D.WH_CODE
                         ELSE A.WH_CODE             
                     END                            AS  WH_CODE
                  , A.TRNS_RATE
                  
                  , A.ORDER_Q
                  , A.R_ORDER_Q
                  , A.SUPPLY_TYPE
                  , A.CUSTOM_CODE
                  , C.CUSTOM_NAME                                   AS CUSTOM_NAME
                  , (CASE WHEN ISNULL(A.PO_REQ_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PO_REQ_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.PO_REQ_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.PO_REQ_DATE, 7, 2))
                     END)                                           AS PO_REQ_DATE
                  , A.INSPEC_FLAG
                  , A.REMARK
                  , A.ORDER_REQ_NUM
                  , A.MRP_CONTROL_NUM
                  , A.ORDER_YN
                  , A.UPDATE_DB_USER
                  , A.UPDATE_DB_TIME
                  , A.COMP_CODE
                  , D.PURCH_LDTIME
                  , D.INSPEC_YN         AS  INSPEC_FLAG
                  , D.LOT_YN
            FROM               MRE110T A WITH (NOLOCK)
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    LEFT JOIN  BCM100T C WITH  (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
                                                       AND C.CUSTOM_CODE = A.CUSTOM_CODE
                    LEFT JOIN  BPR200T D WITH  (NOLOCK) ON D.COMP_CODE = A.COMP_CODE
                                                       AND D.ITEM_CODE = A.ITEM_CODE
                                                       AND D.DIV_CODE  = A.DIV_CODE
                    INNER JOIN MRE100T E WITH  (NOLOCK) ON E.COMP_CODE   = A.COMP_CODE
                                                       AND E.DIV_CODE    = A.DIV_CODE
                                                       AND E.PO_REQ_NUM  = A.PO_REQ_NUM
                    LEFT JOIN (SELECT COMP_CODE
                                    , DIV_CODE
                                    , PO_REQ_NUM
                                    , PO_REQ_SEQ
                                    , SUM(ISNULL(ORDER_UNIT_Q, 0)) AS ORDER_UNIT_Q
                                 FROM MPO200T WITH(NOLOCK)
                                WHERE COMP_CODE = @CompCode
                                  AND DIV_CODE  = #{DIV_CODE}
                                  AND PO_REQ_NUM > ''
                               GROUP BY COMP_CODE, DIV_CODE, PO_REQ_NUM, PO_REQ_SEQ
                               ) F ON F.COMP_CODE  = A.COMP_CODE
                                  AND F.DIV_CODE   = A.DIV_CODE
                                  AND F.PO_REQ_NUM = A.PO_REQ_NUM
                                  AND F.PO_REQ_SEQ = A.PO_SER_NO

            WHERE   E.COMP_CODE     = @CompCode
            AND     E.DIV_CODE      = #{DIV_CODE}
            AND     ISNULL(A.ORDER_UNIT_Q, 0) - ISNULL(F.ORDER_UNIT_Q, 0) > 0
            
            <if test="@foren.Ognl@isNotEmpty(PO_REQ_NUM)">  
            AND     E.PO_REQ_NUM    LIKE '%' + #{PO_REQ_NUM} + '%'
            </if>
            AND     E.PO_REQ_DATE   &gt;= #{PO_REQ_DATE_FR}
            AND     E.PO_REQ_DATE   &lt;= #{PO_REQ_DATE_TO}
            <if test="@foren.Ognl@isNotEmpty(DEPT_CODE)">  
            AND     E.TREE_CODE     = #{DEPT_CODE}
            </if>
            <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)">  
            AND     E.PERSON_NUMB   = #{PERSON_NUMB}
            </if>
            <if test="@foren.Ognl@isNotEmpty(MONEY_UNIT)">  
            AND     A.MONEY_UNIT    = #{MONEY_UNIT}
            </if>
            AND     E.SUPPLY_TYPE   = #{SUPPLY_TYPE}
            <if test="@foren.Ognl@isNotEmpty(ITEM_ACCOUNT)">  
            AND     E.ITEM_ACCOUNT  = #{ITEM_ACCOUNT}
            </if>
            <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">  
            AND     A.CUSTOM_CODE   = #{CUSTOM_CODE}
            </if>
            
            ORDER BY A.PO_SER_NO
        
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END   
    </select>

    <select id="s_mpo501ukrv_jwServiceImpl.fnOrderPrice" parameterType="Map" resultType="rMap">
    	--UMFuncKrv.CMFuncKr[fnGetOrderPrice] Query03
        SELECT #{ORDER_UNIT}   AS ORDER_UNIT 
             , #{STOCK_UNIT}   AS STOCK_UNIT
             , CASE #{ORDER_UNIT} 
                    WHEN #{STOCK_UNIT} 
                         THEN 1
                         ELSE ISNULL(ISNULL(ISNULL((SELECT A.TRNS_RATE
                                                      FROM BPR300T A WITH (NOLOCK)
                                                     WHERE A.TYPE            = N'1' 
                                                       AND CUSTOM_CODE       = #{CUSTOM_CODE}
                                                       AND A.ITEM_CODE       = #{ITEM_CODE}
                                                       AND A.ORDER_UNIT      = #{ORDER_UNIT}
                                                       AND A.COMP_CODE       = #{S_COMP_CODE}
                                                       AND A.DIV_CODE        = #{DIV_CODE}
                                                       AND A.APLY_START_DATE = (SELECT MAX(APLY_START_DATE) 
                                                                                  FROM BPR300T WITH (NOLOCK)
                                                                                 WHERE TYPE             = A.TYPE
                                                                                   AND COMP_CODE        = A.COMP_CODE
                                                                                   AND DIV_CODE         = A.DIV_CODE
                                                                                   AND ITEM_CODE        = A.ITEM_CODE
                                                                                   AND CUSTOM_CODE      = A.CUSTOM_CODE
                                                                                   AND APLY_START_DATE &lt;= CONVERT(VARCHAR(8), GETDATE() ,112))) 
                                           , (SELECT A.TRNS_RATE
                                                FROM BPR200T A WITH (NOLOCK)
                                                   , BPR100T B WITH (NOLOCK)
                                               WHERE A.COMP_CODE  = B.COMP_CODE
                                                 AND A.ITEM_CODE  = B.ITEM_CODE
                                                 AND A.ITEM_CODE  = #{ITEM_CODE}  
                                                 AND A.COMP_CODE  = #{S_COMP_CODE} 
                                                 AND A.DIV_CODE   = #{DIV_CODE}
                                                 AND A.ORDER_UNIT = #{ORDER_UNIT}))
                                    , (SELECT TRNS_RATE
                                         FROM BPR600T WITH (NOLOCK)
                                        WHERE COMP_CODE  = #{S_COMP_CODE}
                                          AND STOCK_UNIT = #{STOCK_UNIT}
                                          AND ORDER_UNIT = #{ORDER_UNIT})),1)
                END AS TRNS_RATE
             , ISNULL((SELECT uniLITE.fnformat(#{S_COMP_CODE}, MAX(ITEM_P), 'M_FSET_PS')
                         FROM BPR400T WITH (NOLOCK)
                        WHERE TYPE            = N'1'
                          AND ITEM_CODE       = #{ITEM_CODE}
                          AND CUSTOM_CODE     = #{CUSTOM_CODE}
                          AND MONEY_UNIT      = #{MONEY_UNIT}
                          AND ORDER_UNIT      = #{ORDER_UNIT}
                          AND COMP_CODE       = #{S_COMP_CODE}
                          AND DIV_CODE        = #{DIV_CODE}
                          AND APLY_START_DATE = (SELECT MAX(APLY_START_DATE)
                                                   FROM BPR400T WITH (NOLOCK)
                                                  WHERE APLY_START_DATE &lt;= #{ORDER_DATE}
                                                    AND TYPE             = N'1'
                                                    AND ITEM_CODE        = #{ITEM_CODE}
                                                    AND CUSTOM_CODE      = #{CUSTOM_CODE}
                                                    AND MONEY_UNIT       = #{MONEY_UNIT}
                                                    AND COMP_CODE        = #{S_COMP_CODE}
                                                    AND DIV_CODE         = #{DIV_CODE}
                                                    AND ORDER_UNIT       = #{ORDER_UNIT}))
             , (SELECT uniLITE.fnformat(#{S_COMP_CODE}, ISNULL(MAX(PURCHASE_BASE_P),0), 'M_FSET_PS')
                  FROM BPR200T WITH (NOLOCK)
                 WHERE COMP_CODE = #{S_COMP_CODE}
                   AND DIV_CODE  = #{DIV_CODE}
                   AND ITEM_CODE = #{ITEM_CODE})) AS ORDER_P
             , ISNULL((SELECT uniLITE.fnformat(#{S_COMP_CODE}, BASIS_P,'M_FSET_PS')
                         FROM BPR200T WITH (NOLOCK)
                        WHERE ITEM_CODE = #{ITEM_CODE}
                          AND COMP_CODE = #{S_COMP_CODE}
                          AND DIV_CODE  = #{DIV_CODE}),0) AS STOCK_P
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.callInspecyn" parameterType="Map" resultType="rMap">
        Select 
        	ISNULL(INSPEC_YN, 'N') AS INSPEC_YN
        	FROM BPR200T 
        	WHERE COMP_CODE = #{S_COMP_CODE}
        	AND DIV_CODE    = #{DIV_CODE}
    	   AND ITEM_CODE   = #{ITEM_CODE}
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.userName" parameterType="Map" resultType="rMap">
        /*UMFuncKrv.CMFuncKr[fnGetAgreePrsn] Query01*/
    	SELECT B.USER_NAME AS USER_NAME
    	     , B.USER_ID   AS USER_ID
    	  FROM 		    BSA100T A WITH (NOLOCK)
    	     INNER JOIN BSA300T B WITH (NOLOCK) ON A.REF_CODE1 = B.USER_ID
    	     
    	 WHERE A.MAIN_CODE = N'M201'
    	   AND A.SUB_CODE  = #{SUB_CODE}
    	   AND A.COMP_CODE = #{S_COMP_CODE}
    	 ORDER BY A.SUB_CODE
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.userWhcode" parameterType="Map" resultType="rMap">
        SELECT
        	A.WH_CODE
        FROM         BSA210T A WITH(NOLOCK)
           LEFT JOIN BSA300T B WITH(NOLOCK) ON B.COMP_CODE = A.COMP_CODE
        								   AND B.DEPT_CODE = A.TREE_CODE
        WHERE A.COMP_CODE = #{S_COMP_CODE}
          AND B.USER_ID   = #{S_USER_ID}
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.callDeptInspecFlag" parameterType="Map" resultType="rMap">
        SELECT 
        	ISNULL(INSPEC_FLAG, 'N') AS  INSPEC_FLAG
        FROM BSA210T WITH(NOLOCK) 
        WHERE COMP_CODE = #{S_COMP_CODE}
          AND TYPE_LEVEL = #{DIV_CODE}
          AND TREE_CODE = #{DEPT_CODE}
    </select>
    
    <select id="s_mpo501ukrv_jwServiceImpl.ref1" parameterType="Map" resultType="rMap">
        SELECT 
        	REF_CODE1
        FROM
        	BSA100T WITH(NOLOCK)
        WHERE	COMP_CODE = #{S_COMP_CODE}
        	AND MAIN_CODE = 'M201'
        	AND SUB_CODE  = #{ORDER_PRSN} 
    </select>
    
    <insert id="s_mpo501ukrv_jwServiceImpl.insertLogDetail" parameterType="Map">
     	INSERT INTO L_MPO200T
             ( KEY_VALUE	, OPR_FLAG     
             , DIV_CODE     , CUSTOM_CODE	, ORDER_NUM     	, ORDER_SEQ     	, ITEM_CODE     
             , ORDER_UNIT_Q , ORDER_UNIT    , UNIT_PRICE_TYPE   , MONEY_UNIT     	, ORDER_UNIT_P     
             , ORDER_O      , EXCHG_RATE_O  , ORDER_LOC_P       , ORDER_LOC_O     	, DVRY_DATE     
             , WH_CODE      , TRNS_RATE     , ORDER_Q     		, ORDER_P     		, CONTROL_STATUS     
             , INSTOCK_Q    , INSPEC_FLAG   , COMP_CODE         , PO_REQ_NUM        , PO_REQ_SEQ
             
        	 , DVRY_TIME	, ORDER_REQ_NUM	, PROJECT_NO		, LOT_NO                
        	 , REMARK   	, BAD_RETURN_Q  , ADVAN_AMOUNT      , MAP_Q                 
        	 , SO_NUM       , SO_SEQ		, BL_NUM            , DVRY_ESTI_NO      , DVRY_ESTI_QTY         
        	 , DVRY_TOT_QTY , DVRY_ESTI_DATE, DVRY_PRINT_YN     , SUPP_REMARK       , IF_NO
        	 , IF_YN        , IF_DATETIME	, UPDATE_DB_USER	, UPDATE_DB_TIME	, INSERT_DB_USER    	, INSERT_DB_TIME
        	 --20180724 추가
        	 , DELIVERY_PLACE, USAGE_PLACE
             ) 
        VALUES
            (  #{KEY_VALUE}    , #{OPR_FLAG}
             , #{DIV_CODE}     , #{CUSTOM_CODE}   , #{ORDER_NUM}     	, #{ORDER_SEQ}   , #{ITEM_CODE}
             , #{ORDER_UNIT_Q} , #{ORDER_UNIT}    , #{UNIT_PRICE_TYPE}  , #{MONEY_UNIT}  , #{ORDER_UNIT_P}
             , #{ORDER_O}      , #{EXCHG_RATE_O}  , #{ORDER_LOC_P}      , #{ORDER_LOC_O} , #{DVRY_DATE}
             , #{WH_CODE}      , #{TRNS_RATE}     , #{ORDER_Q}     		, #{ORDER_P}     , #{CONTROL_STATUS}
             , #{INSTOCK_Q}    , #{INSPEC_FLAG}   , #{S_COMP_CODE}      , #{PO_REQ_NUM}  , #{PO_SER_NO}
             
             , #{DVRY_TIME}	   , #{ORDER_REQ_NUM}	, #{PROJECT_NO}		, #{LOT_NO}                
        	 , #{REMARK}       , #{BAD_RETURN_Q}    , #{ADVAN_AMOUNT}   , #{MAP_Q}                
        	 , #{SO_NUM}       , #{SO_SEQ}			, #{BL_NUM}         , #{DVRY_ESTI_NO} , #{DVRY_ESTI_QTY}         
        	 , #{DVRY_TOT_QTY} , #{DVRY_ESTI_DATE}	, #{DVRY_PRINT_YN}  , #{SUPP_REMARK}  , #{IF_NO}                 
        	 , #{IF_YN}        , #{IF_DATETIME} 	, #{S_USER_ID}     	, GETDATE()	      , #{S_USER_ID}     	, GETDATE()
        	 --20180724 추가
        	 , #{DELIVERY_PLACE}, #{USAGE_PLACE}
             ) 
    </insert>
    	  	
    <insert id="s_mpo501ukrv_jwServiceImpl.insertLogMaster" parameterType="Map">
     	INSERT INTO L_MPO100T
             ( KEY_VALUE      , OPR_FLAG 
             , ORDER_DATE     , ORDER_TYPE     , CUSTOM_CODE     , ORDER_NUM     , ORDER_PRSN
             , AGREE_STATUS   , MONEY_UNIT     , EXCHG_RATE_O    , DIV_CODE      , COMP_CODE
             <if test="@foren.Ognl@isNotEmpty(LC_NUM)">   
             , LC_NUM         
             </if>
             <if test="@foren.Ognl@isNotEmpty(RECEIPT_TYPE)">  
             , RECEIPT_TYPE  
             </if> 
             , DEPT_CODE 
             <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
        	 , PROJECT_NO	 
             </if>
             <if test="@foren.Ognl@isNotEmpty(REMARK)">  
        	 , REMARK  
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_PRSN)">
        	 , AGREE_PRSN  
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_DATE)">
        	 , AGREE_DATE
             </if>
             , DRAFT_YN       
             )
    	VALUES
            (  #{KEY_VALUE}      , #{OPR_FLAG}
             , #{ORDER_DATE}     , #{ORDER_TYPE}      , #{CUSTOM_CODE}      , #{ORDER_NUM}      , #{ORDER_PRSN}
             , #{AGREE_STATUS}   , #{MONEY_UNIT}      , #{EXCHG_RATE_O}     , #{DIV_CODE}       , #{COMP_CODE}
             <if test="@foren.Ognl@isNotEmpty(LC_NUM)">
             , #{LC_NUM}
             </if>
             <if test="@foren.Ognl@isNotEmpty(RECEIPT_TYPE)">  
             , #{RECEIPT_TYPE} 
             </if>     
             , #{DEPT_CODE} 
             <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
        	 , #{PROJECT_NO}
             </if>
             <if test="@foren.Ognl@isNotEmpty(REMARK)">
             , #{REMARK}            
             </if>
             <if test="@foren.Ognl@isNotEmpty(AGREE_PRSN)"> 
             , #{AGREE_PRSN}           
             </if>   
             <if test="@foren.Ognl@isNotEmpty(AGREE_DATE)">  
             , #{AGREE_DATE}
             </if>
             <if test="@foren.Ognl@isNotEmpty(DRAFT_YN)">
             , #{DRAFT_YN}
             </if>
             <if test="@foren.Ognl@isEmpty(DRAFT_YN)">
             , 'N'
             </if>
             ) 
    </insert>	  	
    	  	
    <update id="s_mpo501ukrv_jwServiceImpl.spPurchaseOrder" parameterType="Map" statementType="CALLABLE">
    	{call SP_MATRL_PurchaseOrder (
    		#{KeyValue, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
    		#{LangCode, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
    		#{OrderNum, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String},
    		#{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
    	)}
    </update>	



    <insert id="s_mpo501ukrv_jwServiceImpl.insertExcelMPO501T" parameterType="Map">
    	/* INSERT INTO MPO101T */
        INSERT INTO MPO501T_EXCEL
    		(_EXCEL_JOBID
            , _EXCEL_ROWNUM
            , _EXCEL_HAS_ERROR
            , _EXCEL_ERROR_MSG
            , ITEM_CODE
            , ITEM_NAME
            , TRNS_RATE
            , SPEC
            , STOC_UNIT
            , ORDER_UNIT
            , INSPEC_YN
            , ORDER_UNIT_P
            , ORDER_O
            , WH_CODE
            , ORDER_UNIT_Q
            )
    	VALUES 
            ( #{_EXCEL_JOBID}
            , #{_EXCEL_ROWNUM}
            , #{_EXCEL_HAS_ERROR,jdbcType=VARCHAR}
            , #{_EXCEL_ERROR,jdbcType=VARCHAR}
            , REPLACE(#{ITEM_CODE}, ' ', '')
            , #{ITEM_NAME}
            , #{TRNS_RATE}
            , #{SPEC}
            , #{STOCK_UNIT}
            , #{ORDER_UNIT}
            , #{INSPEC_YN}
            , #{ORDER_UNIT_P}
            , #{ORDER_O}
            , #{WH_CODE}
            , #{ORDER_UNIT_Q}
    	)
    </insert>  
    
	<select id="s_mpo501ukrv_jwServiceImpl.selectExcelUploadSheet1" parameterType="Map" resultType="rMap">
            BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
        
            DECLARE  @RefItem       NVARCHAR(01)
        
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = #{S_USER_ID}
        
            SET @RefItem = ISNULL(@RefItem, N'0')

            /* 구매담당자정보 조회 */
            DECLARE @OrderPrsn      NVARCHAR(02)
                  , @OrderPrsnYN    NVARCHAR(01)
        
            SELECT TOP 1 @OrderPrsn   = SUB_CODE
                 ,       @OrderPrsnYN = 'Y'
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE  = #{S_COMP_CODE}
               AND MAIN_CODE  = 'M201'
               AND SUB_CODE  != '$'
               AND REF_CODE2  = #{S_USER_ID}
               AND USE_YN     = 'Y'
        
            SET @OrderPrsn   = ISNULL(@OrderPrsn  , '' )
            SET @OrderPrsnYN = ISNULL(@OrderPrsnYN, 'N')
        
            /* 데이터 조회 */
            SELECT A._EXCEL_JOBID
                 , A._EXCEL_ROWNUM
                 , A._EXCEL_HAS_ERROR
                 , A._EXCEL_ERROR_MSG
                 , A.ITEM_CODE
                 , (CASE WHEN @RefItem = '0' THEN C.ITEM_NAME
                         WHEN @RefItem = '1' THEN C.ITEM_NAME1
                         WHEN @RefItem = '2' THEN C.ITEM_NAME2
                                             ELSE C.ITEM_NAME
                     END)														AS ITEM_NAME
                 , ISNULL(C.SPEC, '')											AS SPEC
                 , C.STOCK_UNIT
                 , C.ORDER_UNIT
                 , A.TRNS_RATE												AS TRNS_RATE
                 , C.INSPEC_YN
                 , A.ORDER_UNIT_P
                 , (A.ORDER_UNIT_Q *  A.ORDER_UNIT_P) AS ORDER_O        
                 , ISNULL(C.WH_CODE, '')										AS WH_CODE
                 , A.ORDER_UNIT_Q
--                 , CASE WHEN ISNULL(C.ITEM_WIDTH, 0) = 0 THEN 1000
--                 		ELSE C.ITEM_WIDTH
--                   END														AS ITEM_WIDTH
                  , C.ITEM_WIDTH
   
              FROM MPO501T_EXCEL  A WITH (NOLOCK)  
         INNER JOIN BPR200TV   C   ON  C.COMP_CODE  = #{S_COMP_CODE}
                                  AND  C.DIV_CODE   = #{DIV_CODE}
                                  AND  A.ITEM_CODE  = C.ITEM_CODE  
             WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
             ORDER BY A._EXCEL_JOBID, A._EXCEL_ROWNUM
        END

		
	</select>

	<update id="excelValidate" >
		/*s_mpo501ukrv_jwServiceImpl.excelValidate*/
		/*다국어 메세지 처리 함수 필요. S_LANG_CODE와 msg_no를 파라미터로 받아 BSA000T에서 조회*/
		DECLARE @LANG_CODE	NVARCHAR(02)
		 
			SET @LANG_CODE = #{S_LANG_CODE}

	   UPDATE   A
		SET 
				A._EXCEL_HAS_ERROR = (CASE WHEN B.ITEM_CODE IS NULL OR C.ITEM_CODE IS NULL  
										   THEN 'Y' 
								      ELSE A._EXCEL_HAS_ERROR 
								      END),
				A._EXCEL_ERROR_MSG = (CASE WHEN B.ITEM_CODE IS NULL OR C.ITEM_CODE IS NULL  
										   THEN ISNULL(_EXCEL_ERROR_MSG,'') + uniLITE.fnGetErrorMsg_omega('800010', '', @LANG_CODE) --800010;사업장에 대한 품목정보가 존재하지 않습니다. 
									  ELSE A._EXCEL_ERROR_MSG END)
		FROM MPO501T_EXCEL A 
		LEFT JOIN  BPR100T B    ON B.COMP_CODE= #{S_COMP_CODE}
							   AND A.ITEM_CODE = B.ITEM_CODE
		LEFT JOIN  BPR200T C    ON C.COMP_CODE= #{S_COMP_CODE}	
		  					   AND C.DIV_CODE = #{DIV_CODE}				   
							   AND A.ITEM_CODE = C.ITEM_CODE
		WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
		
		UPDATE  A
		SET 
				A._EXCEL_HAS_ERROR = (CASE WHEN B.USE_YN = 'N' 
											THEN 'Y' 
										   WHEN  ISNULL(B.START_DATE, '19000101') &gt; #{ORDER_DATE} 
											THEN 'Y'
										   WHEN  ISNULL(B.STOP_DATE, '99991231') &lt; #{ORDER_DATE}
											THEN 'Y'
								      ELSE A._EXCEL_HAS_ERROR 
								      END),
				A._EXCEL_ERROR_MSG = (CASE WHEN B.USE_YN = 'N' 
											THEN ISNULL(_EXCEL_ERROR_MSG,'') + uniLITE.fnGetErrorMsg_omega('800011', '', @LANG_CODE) --800011;사용중지된 품목입니다.
										   WHEN  ISNULL(B.START_DATE, '19000101') &gt; #{ORDER_DATE} OR  ISNULL(B.STOP_DATE, '99991231') &lt; #{ORDER_DATE}
											THEN ISNULL(_EXCEL_ERROR_MSG,'') + uniLITE.fnGetErrorMsg_omega('800012', '', @LANG_CODE) + '(' + ISNULL(B.START_DATE, '') + '~' + ISNULL(B.STOP_DATE, '') + ')'
									  ELSE A._EXCEL_ERROR_MSG END)
		FROM MPO501T_EXCEL A 
		INNER JOIN  BPR100T B  ON B.COMP_CODE= #{S_COMP_CODE}
							  AND A.ITEM_CODE = B.ITEM_CODE
		WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
	   
	</update>



	<select id="s_mpo501ukrv_jwServiceImpl.printList" parameterType="Map" resultType="rMap">
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON
            
            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */
                  , @PRINT_USER          NVARCHAR(100)            --(선택) 출력자
                  , @VIEW_PRINT_INFO_YN  NVARCHAR(01)             --인쇄출력정보 여부
                        
            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = 'ko'
            
            /* 명칭 참조 유형 */
            SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId
            
            SET @RefItem = ISNULL(@RefItem, N'0')
            
            /* 날짜 포맷 유형 설정 */
            SELECT TOP 1 @DateFormat = CODE_NAME
              FROM BSA100T WITH (NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = N'B044'
               AND REF_CODE1 = N'Y'
            
            SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')
            
            SELECT @PRINT_USER = USER_NAME 
              FROM BSA300T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND USER_ID = @UserId
                
            SELECT @VIEW_PRINT_INFO_YN = SUB_CODE
              FROM BSA100T WITH(NOLOCK)
             WHERE COMP_CODE = @CompCode
               AND MAIN_CODE = 'B249'
               AND SUB_CODE != '$'
               AND REF_CODE1 = 'Y'

            /* 데이터 조회 */
            SELECT  A.ORDER_NUM 
                  , ROW_NUMBER () OVER (PARTITION BY A.ORDER_NUM ORDER BY A.ORDER_SEQ) AS PRINT_SEQ
                  , F.CODE_NAME         AS ORDER_PRSN
                  , D.CUSTOM_NAME
                  , ISNULL(D.TELEPHON, '')          AS CUST_TEL_PHON
                  , ISNULL(D.FAX_NUM, '')           AS CUST_FAX_NUM    
                  , A.ITEM_CODE
                  ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME
                  , B.SPEC
                  , A.ORDER_UNIT_Q
                  , A.ORDER_UNIT
                  , A.ORDER_UNIT_P
                  , A.ORDER_O
                 , (CASE WHEN ISNULL(A.DVRY_DATE, '') = ''
                         THEN ''
                         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.DVRY_DATE, 1, 4))
                                                                 , 'MM'  , SUBSTRING(A.DVRY_DATE, 5, 2))
                                                                 , 'DD'  , SUBSTRING(A.DVRY_DATE, 7, 2))
                     END)                                           AS DVRY_DATE
                  , A.DVRY_TIME
                  , A.WH_CODE
                  , A.ORDER_P
                  , A.REMARK
                  , A2.REMARK       AS MASTER_REMARK
                  , A.PROJECT_NO
                  , (CASE WHEN ISNULL(#{ORDER_DATE}, '') = ''
                          THEN ''
                          ELSE REPLACE(REPLACE(REPLACE('YYYY.MM.DD', 'YYYY', SUBSTRING(#{ORDER_DATE}, 1, 4))
                                                                   , 'MM'  , SUBSTRING(#{ORDER_DATE}, 5, 2))
                                                                   , 'DD'  , SUBSTRING(#{ORDER_DATE}, 7, 2))
                    END)                                                            AS ORDER_DATE
                  , E.DIV_CODE    AS MY_CUSTOM_CODE      --사업장코드                                                                 
                  , E.DIV_NAME    AS MY_CUSTOM_NAME      --상호 
                  , E.REPRE_NAME  AS MY_TOP_NAME         --대표자   
                  , E.COMP_TYPE                       --업태       
                  , E.COMP_CLASS                      --종목                                                       
                  , CASE ISNULL(E.COMPANY_NUM,'')                                                                         
                    WHEN '' THEN ''                                                                                  
                    ELSE         SUBSTRING(E.COMPANY_NUM,1,3) + '-'                                                  
                                + SUBSTRING(E.COMPANY_NUM,4,2) + '-'                                                  
                                + SUBSTRING(E.COMPANY_NUM,6,5)                                                        
                  END          AS MY_COMPANY_NUM          --등록번호                                                                  
                  , E.ZIP_CODE    AS MY_ZIP_CODE          --우편번호                                                                
                  , E.ADDR AS  MY_ADDR              --주소                                                      
                  , E.TELEPHON                            --전화번호
                  , E.FAX_NUM                             --팩스
                  , @PRINT_USER                             AS PRINT_USER                   --출력자 이름
                  , @VIEW_PRINT_INFO_YN                     AS VIEW_PRINT_INFO_YN           --인쇄출력정보 표시여부 
            FROM               MPO200T A WITH (NOLOCK)
                    INNER JOIN MPO100T A2 WITH (NOLOCK)ON A2.COMP_CODE = A.COMP_CODE
                                                      AND A2.DIV_CODE = A.DIV_CODE
                                                      AND A2.CUSTOM_CODE = A.CUSTOM_CODE
                                                      AND A2.ORDER_NUM = A.ORDER_NUM
                    INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
                                                      AND B.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = A.COMP_CODE
                                                      AND C.DIV_CODE = A.DIV_CODE                                                      
                                                      AND C.ITEM_CODE = A.ITEM_CODE
                    INNER JOIN BCM100T D WITH (NOLOCK) ON D.COMP_CODE = A.COMP_CODE
                                                      AND D.CUSTOM_CODE = A.CUSTOM_CODE
                    INNER JOIN BOR120T E  WITH (NOLOCK)ON E.COMP_CODE   = A.COMP_CODE                                    
                                                      AND E.DIV_CODE    = A.DIV_CODE
                     LEFT JOIN BSA100T F WITH (NOLOCK) ON F.COMP_CODE   = A.COMP_CODE                                    
                                                      AND F.MAIN_CODE   = 'M201'
                                                      AND F.SUB_CODE    = A2.ORDER_PRSN
                     LEFT JOIN BSA100T I WITH (NOLOCK) ON I.COMP_CODE   = A.COMP_CODE
                                                      AND I.SUB_CODE   != N'$'
                                                      AND I.MAIN_CODE   = 'M008'
                                                      AND I.REF_CODE1   = 'Y'
                    
            WHERE   A.COMP_CODE = @CompCode
            AND A.DIV_CODE = #{DIV_CODE}
            AND ((I.SUB_CODE = '1' AND A2.AGREE_STATUS = '2')
                   OR
                 (I.SUB_CODE = '2' AND A2.AGREE_STATUS IS NOT NULL))
            AND A2.ORDER_TYPE  != N'4'    /*외주*/ 
            AND A.CONTROL_STATUS NOT IN ('8', '9')
            AND A.ORDER_NUM = #{ORDER_NUM}
             
            ORDER BY A.DVRY_DATE, B.ITEM_NAME, A.ORDER_SEQ
            
            SET ARITHABORT OFF
            SET NOCOUNT OFF
        END 
	</select>
</mapper>