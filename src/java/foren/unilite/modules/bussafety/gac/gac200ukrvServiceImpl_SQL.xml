<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gac200ukrvServiceImpl">
	<insert id="gac200ukrvServiceImpl.insert" parameterType="Map">
		<if test="ACCIDENT_DIV == &quot;대인&quot; ">
		UPDATE GAC110T
			SET  TOTAL_EXPECT_AMOUNT = #{EXPECT_AMOUNT}
				,UPDATE_DB_USER = #{S_USER_ID}
				,UPDATE_DB_TIME = GETDATE()
		WHERE COMP_CODE = #{S_COMP_CODE}
		  AND DIV_CODE  = #{DIV_CODE}
		  AND ACCIDENT_NUM = #{ACCIDENT_NUM}
		  AND ACCIDENT_SEQ = #{ACCIDENT_SEQ}
		</if>
		<if test="ACCIDENT_DIV == &quot;대물&quot; ">
		UPDATE GAC120T
			SET TOTAL_EXPECT_AMOUNT = #{EXPECT_AMOUNT}
				,DIRECT_LOSS = #{DAMAGE_AMOUNT}
				,UPDATE_DB_USER = #{S_USER_ID}
				,UPDATE_DB_TIME = GETDATE()
		WHERE COMP_CODE = #{S_COMP_CODE}
		  AND DIV_CODE  = #{DIV_CODE}
		  AND ACCIDENT_NUM = #{ACCIDENT_NUM}
		  AND ACCIDENT_SEQ = #{ACCIDENT_SEQ}
		</if>
	</insert>
	<insert id="gac200ukrvServiceImpl.insertExcelGac200" parameterType="Map">
    	/*gac200ukrvServiceImpl.insertExcelGcd102t*/
    	INSERT INTO GAC202T
		(_EXCEL_JOBID, _EXCEL_ROWNUM, _EXCEL_HAS_ERROR, _EXCEL_ERROR_MSG, 
		  	ACCIDENT_DATE,	ACCIDENT_TIME,	VEHICLE_NAME,	ACCIDENT_DIV, 
			DAMAGE_NAME,	DAMAGE_AMOUNT,	EXPECT_AMOUNT,	DRIVER_NAME
		)
    	VALUES (
    		#{_EXCEL_JOBID}, #{_EXCEL_ROWNUM}, #{_EXCEL_HAS_ERROR,jdbcType=VARCHAR}, #{_EXCEL_ERROR,jdbcType=VARCHAR}, 
			#{ACCIDENT_DATE},	REPLACE(#{ACCIDENT_TIME},':',''),	#{VEHICLE_NAME},	#{ACCIDENT_DIV}, 
			#{DAMAGE_NAME},		#{DAMAGE_AMOUNT},	#{EXPECT_AMOUNT},	#{DRIVER_NAME}
    	)
    </insert>  
    <select id="gac200ukrvServiceImpl.selectExcelUploadSheet1" parameterType="Map" resultType="rMap">
		/*gac200ukrvServiceImpl.selectExcelUploadSheet1*/
		
		SELECT A._EXCEL_ROWNUM
			 , A._EXCEL_HAS_ERROR
			 , A._EXCEL_ERROR_MSG
			 , A.ACCIDENT_DATE
			 , A.ACCIDENT_TIME
			 , A.VEHICLE_NAME 
			 , A.ACCIDENT_DIV 
			 , A.DAMAGE_NAME  
			 , A.DAMAGE_AMOUNT
			 , A.EXPECT_AMOUNT
			 , A.DRIVER_NAME
			 , A.DRIVER_CODE
			 , A.ACCIDENT_NUM
			 , A.ACCIDENT_SEQ
			 , A.VEHICLE_CODE
			 , V.VEHICLE_REGIST_NO
		  FROM GAC202T A			  
			  LEFT JOIN GVE100T V ON V.COMP_CODE = #{S_COMP_CODE}
							  	 AND V.DIV_CODE  = #{S_DIV_CODE}
							  	 AND V.VEHICLE_CODE =  A.VEHICLE_CODE 
		 WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
		 ORDER BY A._EXCEL_JOBID, A._EXCEL_ROWNUM
	</select>
	<update id="gac200ukrvServiceImpl.excelValidate" >
		/*gac200ukrvServiceImpl.excelValidate*/
		
	  	UPDATE A
		   SET A._EXCEL_HAS_ERROR = (CASE WHEN B.ACCIDENT_NUM IS NULL THEN 'Y' 
										  ELSE A._EXCEL_HAS_ERROR 
									 END),
				A._EXCEL_ERROR_MSG = (CASE WHEN B.ACCIDENT_NUM IS NULL THEN ISNULL(_EXCEL_ERROR_MSG,'') + '사고정보가 존재하지 않습니다. ' 
										   ELSE A._EXCEL_ERROR_MSG END),
				A.ACCIDENT_NUM = ISNULL(B.ACCIDENT_NUM, ''),
				A.VEHICLE_CODE = B.VEHICLE_CODE,
				A.DRIVER_CODE = B.DRIVER_CODE
		  FROM GAC202T A 
		  LEFT JOIN GVE100T V ON  V.COMP_CODE 		= #{S_COMP_CODE}
							  AND V.DIV_CODE 		= #{S_DIV_CODE}
							  AND V.VEHICLE_NAME 	= A.VEHICLE_NAME
		  LEFT JOIN GAC100T B ON  B.COMP_CODE 		= #{S_COMP_CODE}
							  AND B.DIV_CODE 		= #{S_DIV_CODE}
							  AND B.ACCIDENT_DATE 	= A.ACCIDENT_DATE 
							  AND B.ACCIDENT_TIME 	= A.ACCIDENT_TIME
							  AND B.VEHICLE_CODE 	= V.VEHICLE_CODE
		  WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
		
		UPDATE A
		   SET A._EXCEL_HAS_ERROR = (CASE WHEN B.VICTIM_NAME IS NULL AND C.OTHER_DAMAGE IS NULL THEN 'Y' 
										  ELSE A._EXCEL_HAS_ERROR 
									 END),
				A._EXCEL_ERROR_MSG = (CASE WHEN B.VICTIM_NAME IS NULL AND C.OTHER_DAMAGE IS NULL THEN ISNULL(_EXCEL_ERROR_MSG,'') + '부상자/차량 정보가 존재하지 않습니다. ' 
										   ELSE A._EXCEL_ERROR_MSG END),
				A.ACCIDENT_SEQ = CASE WHEN A.ACCIDENT_DIV = '대인' THEN B.ACCIDENT_SEQ ELSE C.ACCIDENT_SEQ END 
		  FROM GAC202T A 
		  LEFT JOIN GAC110T B  ON  B.COMP_CODE 	 = #{S_COMP_CODE}
							  AND B.DIV_CODE  	 = #{S_DIV_CODE}
							  AND B.ACCIDENT_NUM = A.ACCIDENT_NUM 
							  AND B.VICTIM_NAME	 = A.DAMAGE_NAME
		  LEFT JOIN GAC120T C  ON  C.COMP_CODE 	 = #{S_COMP_CODE}
							  AND C.DIV_CODE  	 = #{S_DIV_CODE}
							  AND C.ACCIDENT_NUM = A.ACCIDENT_NUM 
							  AND C.OTHER_DAMAGE = A.DAMAGE_NAME
		  WHERE A._EXCEL_JOBID = #{_EXCEL_JOBID}
	</update>
</mapper>