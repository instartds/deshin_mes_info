<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_str139skrv_mitServiceImpl">
	<select id="s_str139skrv_mitServiceImpl.selectList" parameterType="Map" resultType="rMap">
		/* s_str139skrv_mitServiceImpl.selectList */

		DECLARE @NOW_MONTH NVARCHAR(6), @PREV_MONTH NVARCHAR(6)
		SET @NOW_MONTH = LEFT(#{PRODT_DATE_FR},6)
		SET @PREV_MONTH = CONVERT(VARCHAR(6), DATEADD(MONTH, -1, @NOW_MONTH+'01'), 112)
		
		;WITH PRODT_T AS (
				SELECT --TOP 100 LEFT(A.PRODT_DATE,6) PRODT_YM, SUM(A.WORK_Q) MONTH_PRODT_Q
						A2.ITEM_CODE, B.ITEM_NAME
						, SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = @PREV_MONTH THEN A.WORK_Q ELSE 0 END) AS PREV_PRODT_Q
						, SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = @NOW_MONTH THEN A.WORK_Q ELSE 0 END) AS NOW_PRODT_Q
						, SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = @PREV_MONTH THEN A.MAN_HOUR ELSE 0 END) AS PREV_MAN_HOUR
						, SUM(CASE WHEN LEFT(A.PRODT_DATE,6) = @NOW_MONTH THEN A.MAN_HOUR ELSE 0 END) AS NOW_MAN_HOUR
				FROM PMR100T A WITH (NOLOCK)
					 INNER JOIN PMP100T A2 WITH (NOLOCK) ON A.COMP_CODE=A2.COMP_CODE AND A.DIV_CODE=A2.DIV_CODE AND A.WKORD_NUM=A2.WKORD_NUM AND A2.LINE_END_YN='Y'
					 INNER JOIN BPR200T B  WITH (NOLOCK) ON A2.COMP_CODE=B.COMP_CODE AND A2.DIV_CODE=B.DIV_CODE AND A2.ITEM_CODE=B.ITEM_CODE
				WHERE A.COMP_CODE=#{S_COMP_CODE}
				AND A.DIV_CODE=#{DIV_CODE}
				AND A.PRODT_DATE &gt;= @PREV_MONTH + '01'
				AND A.PRODT_DATE &lt;= @NOW_MONTH + '31'
			     <if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
			       AND A2.ITEM_CODE      LIKE #{ITEM_CODE} +'%'
			     </if>		
				AND B.ITEM_ACCOUNT='10'
				GROUP BY A2.ITEM_CODE, B.ITEM_NAME
		)
		SELECT ITEM_CODE, ITEM_NAME, PREV_PRODT_Q, NOW_PRODT_Q
				, CASE WHEN NOW_PRODT_Q = 0 THEN 0 ELSE (NOW_PRODT_Q-PREV_PRODT_Q)/NOW_PRODT_Q * 100 END AS RISE_RATE
				, CASE WHEN PREV_MAN_HOUR = 0 THEN 0 ELSE PREV_MAN_HOUR END AS PREV_MAN_HOUR
				, CASE WHEN NOW_MAN_HOUR = 0 THEN 0 ELSE NOW_MAN_HOUR END AS NOW_MAN_HOUR
				, CASE WHEN PREV_MAN_HOUR= 0 THEN 0 ELSE (PREV_MAN_HOUR-NOW_MAN_HOUR)/PREV_MAN_HOUR * 100 END AS LOSE_RATE
		FROM PRODT_T

	</select>
</mapper>