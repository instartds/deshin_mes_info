<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_agc760ukr_mitServiceImpl">

	<select id="s_agc760ukr_mitServiceImpl.selectList" parameterType="Map" resultType="rMap">
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON 

		    DECLARE @CompCode       NVARCHAR(08)   /* 법인코드            */
		          , @DivCode        NVARCHAR(08)   /* 사업장코드          */
		          , @BasisDate      NVARCHAR(08)   /* 조회일            */

				  
				  
		          , @UserId         NVARCHAR(100)  /* 사용자ID            */
		          , @RefItem        NVARCHAR(01)   /* 명칭 참조 유형      */
		
		    SET @CompCode    = #{S_COMP_CODE}
		    SET @DivCode     = #{DIV_CODE}
		    SET @BasisDate   = #{BASIS_DATE}
		    
		    SET @UserId     = #{S_USER_ID}
		
		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId
		
		    SET @RefItem = ISNULL(@RefItem, N'0')
		
		    /* 조회 */
		    SELECT    DIV_CODE                                --사업장(BOR120T)
					, BASIS_DATE                              --조회기준일
					, GUBUN                                   --연도별구분
	                , FR_DATE AS FR_MONTH                     --조회시작월
	                , TO_DATE AS TO_MONTH                     --조회종료월
					, FR_DATE                                 --조회시작월
					, TO_DATE                                 --조회종료월
					, SALE_AMT                                --매출
					, COST_AMT                                --비용
					, SALE_COST_RATE                          --비율
		           
		      FROM  S_AGC760T_MIT   WITH (NOLOCK)
		           
		     WHERE  COMP_CODE     = @CompCode   
		       AND  DIV_CODE      = @DivCode    
		       AND  BASIS_DATE    = @BasisDate
		  ORDER BY  GUBUN

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>
	<select id="s_agc760ukr_mitServiceImpl.selectNewDataList" parameterType="Map" resultType="rMap">
		DECLARE @CompCode       NVARCHAR(08)    /* 법인코드            */
	          , @DivCode        NVARCHAR(08)    /* 사업장코드          */
	          , @BasisDate      NVARCHAR(08)    /* 조회일              */
	
	          , @Gubun010FrDate     NVARCHAR(08)    /* 구분코드 010 3년전(실제)     집계기간 FR */
	          , @Gubun010ToDate     NVARCHAR(08)    /* 구분코드 010 3년전(실제)     집계기간 TO */
	          , @Gubun020FrDate     NVARCHAR(08)    /* 구분코드 020 2년전(실제)     집계기간 FR */
	          , @Gubun020ToDate     NVARCHAR(08)    /* 구분코드 020 2년전(실제)     집계기간 TO */
	          , @Gubun030FrDate     NVARCHAR(08)    /* 구분코드 030 전년도(실제)    집계기간 FR */
	          , @Gubun030ToDate     NVARCHAR(08)    /* 구분코드 030 전년도(실제)    집계기간 TO */
	          , @Gubun040FrDate     NVARCHAR(08)    /* 구분코드 040 당해년도(실제)  집계기간 FR */
	          , @Gubun040ToDate     NVARCHAR(08)    /* 구분코드 040 당해년도(실제)  집계기간 TO */
	          , @Gubun050FrDate     NVARCHAR(08)    /* 구분코드 050 당해년도(추정)  집계기간 FR */
	          , @Gubun050ToDate     NVARCHAR(08)    /* 구분코드 050 당해년도(추정)  집계기간 TO */
	          , @Gubun060FrDate     NVARCHAR(08)    /* 구분코드 060 익년도(추정)    집계기간 FR */
	          , @Gubun060ToDate     NVARCHAR(08)    /* 구분코드 060 익년도(추정)    집계기간 TO */
	          , @Gubun070FrDate     NVARCHAR(08)    /* 구분코드 070 2년후(추정)     집계기간 FR */
	          , @Gubun070ToDate     NVARCHAR(08)    /* 구분코드 070 2년후(추정)     집계기간 TO */
	          , @Gubun080FrDate     NVARCHAR(08)    /* 구분코드 080 3년후(추정)     집계기간 FR */
	          , @Gubun080ToDate     NVARCHAR(08)    /* 구분코드 080 3년후(추정)     집계기간 TO */
	          , @Gubun090FrDate     NVARCHAR(08)    /* 구분코드 090 4년후(추정)     집계기간 FR */
	          , @Gubun090ToDate     NVARCHAR(08)    /* 구분코드 090 4년후(추정)     집계기간 TO */
	          , @Gubun100FrDate     NVARCHAR(08)    /* 구분코드 100 5년후이상(추정) 집계기간 FR */
	
	    SET @CompCode    = #{S_COMP_CODE}
	    SET @DivCode     = #{DIV_CODE}
	    SET @BasisDate   = #{BASIS_DATE}
	
	    /* 집계기간 셋팅 */
	    SET @Gubun010FrDate = CONVERT(NVARCHAR(8), DATEADD(DAY, 1, DATEADD(YEAR, -3, CONVERT(DATETIME, @BasisDate))), 112)
	    SET @Gubun010ToDate = LEFT(@Gubun010FrDate,4) + '1231'
	
	    SET @Gubun020FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, -2, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun020ToDate = LEFT(@Gubun020FrDate,4) + '1231'
	
	    SET @Gubun030FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, -1, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun030ToDate = LEFT(@Gubun030FrDate,4) + '1231'
	
	    SET @Gubun040FrDate = LEFT(@BasisDate,4) + '0101'
	    SET @Gubun040ToDate = @BasisDate
	
	    SET @Gubun050FrDate = CONVERT(NVARCHAR(8), DATEADD(DAY, 1, CONVERT(DATETIME, @BasisDate)), 112)
	    SET @Gubun050ToDate = LEFT(@Gubun050FrDate,4) + '1231'
	
	    SET @Gubun060FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, 1, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun060ToDate = LEFT(@Gubun060FrDate,4) + '1231'
	
	    SET @Gubun070FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, 2, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun070ToDate = LEFT(@Gubun070FrDate,4) + '1231'
	
	    SET @Gubun080FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, 3, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun080ToDate = LEFT(@Gubun080FrDate,4) + '1231'
	
	    SET @Gubun090FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, 4, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	    SET @Gubun090ToDate = LEFT(@Gubun090FrDate,4) + '1231'
	
	    SET @Gubun100FrDate = CONVERT(NVARCHAR(4), DATEADD(DAY, 1, DATEADD(YEAR, 5, CONVERT(DATETIME, @BasisDate))), 112) + '0101'
	
	    /*
	    SELECT @BasisDate
	         , @Gubun010FrDate, @Gubun010ToDate
	         , @Gubun020FrDate, @Gubun020ToDate
	         , @Gubun030FrDate, @Gubun030ToDate
	         , @Gubun040FrDate, @Gubun040ToDate
	         , @Gubun050FrDate, @Gubun050ToDate
	         , @Gubun060FrDate, @Gubun060ToDate
	         , @Gubun070FrDate, @Gubun070ToDate
	         , @Gubun080FrDate, @Gubun080ToDate
	         , @Gubun090FrDate, @Gubun090ToDate
	         , @Gubun100FrDate
	    */
	
	    /* 임시 테이블 선언 */
	    IF EXISTS (SELECT TOP 1 1 FROM tempdb..sysobjects WHERE id = OBJECT_ID('tempdb..#OMEGAPLUS202009291104'))
	       DROP TABLE #OMEGAPLUS202009291104
	
	    CREATE TABLE #OMEGAPLUS202009291104
	        ( COMP_CODE            NVARCHAR(08)
		    , DIV_CODE             NVARCHAR(08)
	        , BASIS_DATE           NVARCHAR(08)
		    , GUBUN                NVARCHAR(03)
	        , FR_DATE              NVARCHAR(08)
	        , TO_DATE              NVARCHAR(08)
	        , SALE_AMT             NUMERIC(30,6)
	        , COST_AMT             NUMERIC(30,6)
	        , SALE_COST_RATE       NUMERIC(30,6) )
	
	    /* 데이터 집계 */
	    INSERT INTO #OMEGAPLUS202009291104
	    -- 구분코드 010 3년전(실제)
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '010'
	         , @Gubun010FrDate
	         , @Gubun010ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun010FrDate AND A.EXPIRATION_DATE &gt;= @Gubun010ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun010FrDate), CONVERT(DATETIME,LEFT(@Gubun010ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun010FrDate AND A.EXPIRATION_DATE &gt;= @Gubun010ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun010ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun010FrDate AND A.EXPIRATION_DATE &lt;  @Gubun010ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun010FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun010FrDate), CONVERT(DATETIME,LEFT(@Gubun010ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , ISNULL((SELECT SUM(COST_SUM)
	                     FROM S_AGC720T_MIT WITH (NOLOCK)
	                    WHERE COMP_CODE = @CompCode
	                      AND DIV_CODE  = @DivCode
	                      AND FR_DATE   = LEFT(@Gubun010FrDate,6)
	                      AND TO_DATE   = LEFT(@Gubun010ToDate,6)),0)
	          , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun010FrDate AND A.SALE_DATE &lt;= @Gubun010ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun010FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun010FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 020 2년전(실제)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '020'
	         , @Gubun020FrDate
	         , @Gubun020ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun020FrDate AND A.EXPIRATION_DATE &gt;= @Gubun020ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun020FrDate), CONVERT(DATETIME,LEFT(@Gubun020ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun020FrDate AND A.EXPIRATION_DATE &gt;= @Gubun020ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun020ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun020FrDate AND A.EXPIRATION_DATE &lt;  @Gubun020ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun020FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun020FrDate), CONVERT(DATETIME,LEFT(@Gubun020ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , ISNULL((SELECT SUM(COST_SUM)
	                     FROM S_AGC720T_MIT WITH (NOLOCK)
	                    WHERE COMP_CODE = @CompCode
	                      AND DIV_CODE  = @DivCode
	                      AND FR_DATE   = LEFT(@Gubun020FrDate,6)
	                      AND TO_DATE   = LEFT(@Gubun020ToDate,6)),0)
	          , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun020FrDate AND A.SALE_DATE &lt;= @Gubun020ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun020FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun020FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 030 전년도(실제)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '030'
	         , @Gubun030FrDate
	         , @Gubun030ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun030FrDate AND A.EXPIRATION_DATE &gt;= @Gubun030ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun030FrDate), CONVERT(DATETIME,LEFT(@Gubun030ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun030FrDate AND A.EXPIRATION_DATE &gt;= @Gubun030ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun030ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun030FrDate AND A.EXPIRATION_DATE &lt;  @Gubun030ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun030FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun030FrDate), CONVERT(DATETIME,LEFT(@Gubun030ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , ISNULL((SELECT SUM(COST_SUM)
	                     FROM S_AGC720T_MIT WITH (NOLOCK)
	                    WHERE COMP_CODE = @CompCode
	                      AND DIV_CODE  = @DivCode
	                      AND FR_DATE   = LEFT(@Gubun030FrDate,6)
	                      AND TO_DATE   = LEFT(@Gubun030ToDate,6)),0)
	          , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun030FrDate AND A.SALE_DATE &lt;= @Gubun030ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun030FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun030FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 040 당해년도(실제)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '040'
	         , @Gubun040FrDate
	         , @Gubun040ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun040FrDate AND A.EXPIRATION_DATE &gt;= @Gubun040ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun040FrDate), CONVERT(DATETIME,LEFT(@Gubun040ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun040FrDate AND A.EXPIRATION_DATE &gt;= @Gubun040ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun040ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun040FrDate AND A.EXPIRATION_DATE &lt;  @Gubun040ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun040FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun040FrDate), CONVERT(DATETIME,LEFT(@Gubun040ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , ISNULL((SELECT SUM(COST_SUM)
	                     FROM S_AGC720T_MIT WITH (NOLOCK)
	                    WHERE COMP_CODE = @CompCode
	                      AND DIV_CODE  = @DivCode
	                      AND FR_DATE   = LEFT(@Gubun040FrDate,6)
	                      AND TO_DATE   = LEFT(@Gubun040ToDate,6)),0)
	          , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun040FrDate AND A.SALE_DATE &lt;= @Gubun040ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun040FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun040FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A

	    -- 구분코드 050 당해년도(추정)
	    INSERT INTO #OMEGAPLUS202009291104
		SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '050'
	         , @Gubun050FrDate
	         , @Gubun050ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun050FrDate AND A.EXPIRATION_DATE &gt;= @Gubun050ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun050FrDate), CONVERT(DATETIME,LEFT(@Gubun050ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun050FrDate AND A.EXPIRATION_DATE &gt;= @Gubun050ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun050ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun050FrDate AND A.EXPIRATION_DATE &lt;  @Gubun050ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun050FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun050FrDate), CONVERT(DATETIME,LEFT(@Gubun050ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun050FrDate AND A.SALE_DATE &lt;= @Gubun050ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun050FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun050FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 060 익년도(추정)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '060'
	         , @Gubun060FrDate
	         , @Gubun060ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun060FrDate AND A.EXPIRATION_DATE &gt;= @Gubun060ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun060FrDate), CONVERT(DATETIME,LEFT(@Gubun060ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun060FrDate AND A.EXPIRATION_DATE &gt;= @Gubun060ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun060ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun060FrDate AND A.EXPIRATION_DATE &lt;  @Gubun060ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun060FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun060FrDate), CONVERT(DATETIME,LEFT(@Gubun060ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun060FrDate AND A.SALE_DATE &lt;= @Gubun060ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun060FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun060FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 070 2년후(추정)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '070'
	         , @Gubun070FrDate
	         , @Gubun070ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun070FrDate AND A.EXPIRATION_DATE &gt;= @Gubun070ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun070FrDate), CONVERT(DATETIME,LEFT(@Gubun070ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun070FrDate AND A.EXPIRATION_DATE &gt;= @Gubun070ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun070ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun070FrDate AND A.EXPIRATION_DATE &lt;  @Gubun070ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun070FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun070FrDate), CONVERT(DATETIME,LEFT(@Gubun070ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun070FrDate AND A.SALE_DATE &lt;= @Gubun070ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun070FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun070FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 080 3년후(추정)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '080'
	         , @Gubun080FrDate
	         , @Gubun080ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun080FrDate AND A.EXPIRATION_DATE &gt;= @Gubun080ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun080FrDate), CONVERT(DATETIME,LEFT(@Gubun080ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun080FrDate AND A.EXPIRATION_DATE &gt;= @Gubun080ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun080ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun080FrDate AND A.EXPIRATION_DATE &lt;  @Gubun080ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun080FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun080FrDate), CONVERT(DATETIME,LEFT(@Gubun080ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun080FrDate AND A.SALE_DATE &lt;= @Gubun080ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun080FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun080FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 090 4년후(추정)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '090'
	         , @Gubun090FrDate
	         , @Gubun090ToDate
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun090FrDate AND A.EXPIRATION_DATE &gt;= @Gubun090ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun090FrDate), CONVERT(DATETIME,LEFT(@Gubun090ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun090FrDate AND A.EXPIRATION_DATE &gt;= @Gubun090ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT(@Gubun090ToDate,6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun090FrDate AND A.EXPIRATION_DATE &lt;  @Gubun090ToDate THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun090FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun090FrDate), CONVERT(DATETIME,LEFT(@Gubun090ToDate,6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun090FrDate AND A.SALE_DATE &lt;= @Gubun090ToDate)
			         OR (A.SALE_DATE &lt;  @Gubun090FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun090FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
	    -- 구분코드 100 5년후이상(추정)
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '100'
	         , @Gubun100FrDate
	         , ''
             , SUM(CASE WHEN A.WARR_MONTH = 0
		            THEN 0
		            ELSE A.SALE_AMT
                       * (CASE WHEN A.SALE_DATE &lt;= @Gubun100FrDate AND A.EXPIRATION_DATE &gt;= '29991231' THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun100FrDate), CONVERT(DATETIME,LEFT('29991231',6) + '01'   )) + 1
                               WHEN A.SALE_DATE &gt;  @Gubun100FrDate AND A.EXPIRATION_DATE &gt;= '29991231' THEN DATEDIFF(MONTH, CONVERT(DATETIME,A.SALE_DATE   ), CONVERT(DATETIME,LEFT('29991231',6) + '01'   )) + 1
                               WHEN A.SALE_DATE &lt;= @Gubun100FrDate AND A.EXPIRATION_DATE &lt;  '29991231' THEN DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun100FrDate), CONVERT(DATETIME,A.EXPIRATION_DATE))
                                                                                                                ELSE DATEDIFF(MONTH, CONVERT(DATETIME,@Gubun100FrDate), CONVERT(DATETIME,LEFT('29991231',6) + '01'   )) + 1
                           END)
                       / A.WARR_MONTH
		        END) AS SALE_AMT
	         , 0
	         , 0
		  FROM (SELECT A.SALE_DATE
		             , ISNULL(B.WARR_MONTH,0) AS WARR_MONTH             /* 무상보증기간(개월) */
		             , CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
		                    THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
		                    ELSE A.SALE_DATE
		                END AS EXPIRATION_DATE                          /* 무상보증기간완료일 */
		             , SUM(B.SALE_LOC_AMT_I) AS SALE_AMT
		          FROM            SSA100T A  WITH (NOLOCK)
		               INNER JOIN SSA110T B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                                  AND B.DIV_CODE  = A.DIV_CODE
		                                                  AND B.BILL_NUM  = A.BILL_NUM
		               INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                                  AND C2.DIV_CODE    = B.DIV_CODE
		                                                  AND C2.ITEM_CODE   = B.ITEM_CODE
		         WHERE A.COMP_CODE     = @CompCode
		           AND A.DIV_CODE      = @DivCode
		           AND C2.ITEM_ACCOUNT = '10'
			       AND ISNULL(B.WARR_MONTH,0) &gt; 0
			       AND ((A.SALE_DATE &gt;= @Gubun100FrDate)
			         OR (A.SALE_DATE &lt;  @Gubun100FrDate AND (CASE WHEN ISNUMERIC(ISNULL(B.WARR_MONTH,0)) = 1
                                		                            THEN CONVERT(NVARCHAR(8), DATEADD(DAY, -1, DATEADD(MONTH, CONVERT(NUMERIC,ISNULL(B.WARR_MONTH,0)), CONVERT(DATETIME, A.SALE_DATE))), 112)
                                		                            ELSE A.SALE_DATE
                                		                        END) &gt;= @Gubun100FrDate))
	         	 GROUP BY A.SALE_DATE, ISNULL(B.WARR_MONTH,0)) A
	
        /* 금액 반올림 처리 */
	    UPDATE #OMEGAPLUS202009291104
	       SET SALE_AMT = ROUND(SALE_AMT,0)
             , COST_AMT = ROUND(COST_AMT,0)

	    /* 실제 비율 */
	    UPDATE #OMEGAPLUS202009291104
	       SET SALE_COST_RATE = ROUND((CASE WHEN SALE_AMT = 0 THEN 0 ELSE COST_AMT / SALE_AMT END) * 100, 2)
	     WHERE GUBUN IN ('010','020','030','040')
	
	    /* 추정 비율 */
	    UPDATE #OMEGAPLUS202009291104
	       SET SALE_COST_RATE = ROUND((SELECT AVG(SALE_COST_RATE)
	                                     FROM #OMEGAPLUS202009291104
  	                                    WHERE GUBUN IN ('010','020','030','040')),2)
	     WHERE GUBUN IN ('050','060','070','080','090','100')
	
	    /* 추정 비용 */
	    UPDATE #OMEGAPLUS202009291104
	       SET COST_AMT = ROUND(SALE_AMT * SALE_COST_RATE / 100, 0)
	     WHERE GUBUN IN ('050','060','070','080','090','100')
	
	    /* 보증충당부채추정액(당해년도) */
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '110'
	         , ''
	         , ''
	         , 0
	         , (SELECT SUM(COST_AMT)
	              FROM #OMEGAPLUS202009291104
	             WHERE GUBUN IN ('050','060','070','080','090','100'))
	         , 0
	
	    /* 보증충당부채추정액(전년도) */
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '120'
	         , ''
	         , ''
	         , 0
	         , 0
	         , 0
	
	    /* 당기설정액 */
	    INSERT INTO #OMEGAPLUS202009291104
	    SELECT @CompCode
	         , @DivCode
	         , @BasisDate
	         , '130'
	         , ''
	         , ''
	         , 0
	         , (SELECT COST_AMT FROM #OMEGAPLUS202009291104 WHERE GUBUN = '110') - (SELECT COST_AMT FROM #OMEGAPLUS202009291104 WHERE GUBUN = '120')
	         , 0
	
	    /* 조회 */
	    SELECT COMP_CODE     
		     , DIV_CODE      
	         , BASIS_DATE    
		     , GUBUN         
	         , FR_DATE AS FR_MONTH       
	         , TO_DATE AS TO_MONTH       
	         , FR_DATE       
	         , TO_DATE       
	         , SALE_AMT      
	         , COST_AMT      
	         , SALE_COST_RATE
	      FROM #OMEGAPLUS202009291104 WITH (NOLOCK)
	     ORDER BY GUBUN
	
	    SET NOCOUNT OFF
	    SET ARITHABORT OFF
	</select>
	<update  id="s_agc760ukr_mitServiceImpl.insertList" parameterType="Map">
	   		INSERT INTO S_AGC760T_MIT
			(
				  COMP_CODE                               --법인
				, DIV_CODE                                --사업장(BOR120T)
				, BASIS_DATE                              --조회기준일
				, GUBUN                                   --연도별구분
				, FR_DATE                                 --조회시작월
				, TO_DATE                                 --조회종료월
				, SALE_AMT                                --매출
				, COST_AMT                                --비용
				, SALE_COST_RATE                          --비율
				, INSERT_DB_USER                          --
				, INSERT_DB_TIME                          --
				, UPDATE_DB_USER                          --
				, UPDATE_DB_TIME                          --
			) VALUES (
				  #{S_COMP_CODE}
				, #{DIV_CODE}
				, #{BASIS_DATE}
				, #{GUBUN}
				, #{FR_DATE}
				, #{TO_DATE}
				, #{SALE_AMT}
				, #{COST_AMT}
				, #{SALE_COST_RATE}
				, #{S_USER_ID}
				, GETDATE()
				, #{S_USER_ID}
				, GETDATE()
			)
	</update>
	<update  id="s_agc760ukr_mitServiceImpl.updateList" parameterType="Map">
	   		UPDATE S_AGC760T_MIT
	   		  SET   FR_DATE          = #{FR_DATE}
				  ,	TO_DATE          = #{TO_DATE}
				  ,	SALE_AMT         = #{SALE_AMT}
				  ,	COST_AMT         = #{COST_AMT}
				  ,	SALE_COST_RATE   = #{SALE_COST_RATE}
				  , UPDATE_DB_USER   = #{S_USER_ID}                      
				  , UPDATE_DB_TIME   =  GETDATE()      
			WHERE COMP_CODE          = #{S_COMP_CODE}
			  AND DIV_CODE           = #{DIV_CODE}
			  AND BASIS_DATE         = #{BASIS_DATE}
			  AND GUBUN              =  #{GUBUN}
				
	</update>
	<update id="s_agc760ukr_mitServiceImpl.deleteAll" parameterType="Map">
		DELETE  FROM   S_AGC760T_MIT
	    WHERE   COMP_CODE                        = #{S_COMP_CODE}
		  AND   DIV_CODE                         = #{DIV_CODE}
		  AND   BASIS_DATE                       = #{BASIS_DATE}
	</update>
</mapper>