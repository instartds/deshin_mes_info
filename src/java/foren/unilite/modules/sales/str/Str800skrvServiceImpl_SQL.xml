<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="str800skrvServiceImpl">
						
	<select id="str800skrvServiceImpl.selectPrintList" parameterType="Map" resultType="rMap">
		SELECT 
			  A.COMP_CODE
			, A.DIV_CODE
			, A.ITEM_CODE
			, MAX(C.ITEM_NAME) AS ITEM_NAME
			, MAX(A.PACK_DATE) AS PACK_DATE
			, SUM(A.QTY) AS SUM_QTY
			, B.CUSTOM_ITEM_CODE
			, A.BOX_BARCODE
			, (SELECT S1.PRODT_DATE FROM PMR100T S1 WITH(NOLOCK) WHERE S1.COMP_CODE = A.COMP_CODE AND S1.DIV_CODE = A.DIV_CODE AND S1.LOT_NO = MAX(A.LOT_NO)) AS PRODT_DATE
			, MAX(C.ITEM_MODEL) AS ITEM_MODEL
			, A.LABEL_CUSTOM
			, MAX(R1.CODE_NAME) AS LABEL_COSTOM_NAME
			, A.LABEL_TYPE
			, A.PO_NO
			, A.BOX_QTY
			 , MAX(B.REMARK)		AS REMARK
		FROM STR800T A WITH(NOLOCK)
		 LEFT JOIN BSA100T K WITH(NOLOCK) ON K.COMP_CODE = A.COMP_CODE 
										 AND K.MAIN_CODE = 'S105'
										 AND K.SUB_CODE = A.LABEL_CUSTOM
		 LEFT JOIN BPR300T B WITH(NOLOCK) ON B.COMP_CODE = A.COMP_CODE
										 AND B.DIV_CODE = A.DIV_CODE
										 AND B.TYPE = '2'
										 AND B.ITEM_CODE = A.ITEM_CODE
										--AND B.CUSTOM_CODE = A.LABEL_CUSTOM
										 AND B.CUSTOM_CODE = ISNULL(K.REF_CODE2, '')
										 AND A.PACK_DATE BETWEEN B.APLY_START_DATE AND B.APLY_END_DATE
	
	    LEFT JOIN BPR100T C WITH(NOLOCK) ON C.COMP_CODE = A.COMP_CODE
									    AND C.ITEM_CODE = A.ITEM_CODE
									    
		LEFT JOIN BSA100T R1 WITH(NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
										 AND R1.MAIN_CODE = 'S105'
										 AND R1.SUB_CODE != '$'
										 AND R1.SUB_CODE = A.LABEL_CUSTOM
		WHERE A.COMP_CODE = #{S_COMP_CODE}
		  AND A.DIV_CODE = #{DIV_CODE}
		  AND A.BOX_BARCODE = #{BOX_BARCODE}
	
		GROUP BY A.COMP_CODE, A.DIV_CODE, A.BOX_BARCODE, A.ITEM_CODE,B.CUSTOM_ITEM_CODE,A.LABEL_CUSTOM,A.LABEL_TYPE, A.PO_NO, A.BOX_QTY--, A.PACK_DATE 
	</select>
	
	
	
	<select id="str800skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		/* str800ukrvServiceImpl.selectDetailList */
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON
		
			DECLARE		@CompCode	NVARCHAR(08) /* 법인코드  */
					  , @UserId		NVARCHAR(100) /* 사용자ID */
					  , @RefItem	NVARCHAR(01) /* 명칭 참조 유형  */
		
		     SET @CompCode = #{S_COMP_CODE}
		     SET @UserId   = #{S_USER_ID}
		
		     /* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
			  FROM BSA300T WITH (NOLOCK)
			 WHERE COMP_CODE	= @CompCode
			   AND USER_ID		= @UserId
		
			 SET @RefItem = ISNULL(@RefItem, '0')
		
			SELECT
				   A.COMP_CODE
				 , A.DIV_CODE
				 , A.BOX_BARCODE
				 , A.PACK_DATE
				 , A.ITEM_CODE
				 ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
						WHEN @RefItem = '2' THEN B.ITEM_NAME2
											ELSE B.ITEM_NAME
				   END)											AS ITEM_NAME
				 , B.SPEC
				 , B.STOCK_UNIT									AS UNIT
				 --, A.LOT_NO
				 --, A.QTY
				 , MAX(A.LOT_NO) AS LOT_NO
				 , SUM(A.QTY) AS QTY
				 
				 -- LOT 현재고추가
				 , SUM(ISNULL(X.STOCK_Q, 0))					AS STOCK_QTY --재고수량.(추가)
				 
				 , A.REMARK
				 , A.WH_CODE
				 , R1.TREE_NAME AS WH_NAME
				 , A.LABEL_CUSTOM
				 , R2.CODE_NAME AS LABEL_CUSTOM_NAME
				 , A.LABEL_TYPE
				 , R3.CODE_NAME AS LABEL_TYPE_NAME
				 
				 
				 ,R4.CUSTOM_ITEM_CODE
				--,(SELECT S1.PRODT_DATE FROM PMR100T S1 WITH(NOLOCK) WHERE S1.COMP_CODE = A.COMP_CODE AND S1.DIV_CODE = A.DIV_CODE AND S1.LOT_NO = A.LOT_NO) AS PRODT_DATE
				--,B.ITEM_MODEL AS ITEM_MODEL
				 ,(SELECT S1.PRODT_DATE FROM PMR100T S1 WITH(NOLOCK) WHERE S1.COMP_CODE = A.COMP_CODE AND S1.DIV_CODE = A.DIV_CODE AND S1.LOT_NO = MAX(A.LOT_NO)) AS PRODT_DATE
				 , MAX(B.ITEM_MODEL) AS ITEM_MODEL
				 , A.PO_NO
				 , A.BOX_QTY
				 --20190117
				 , R2.REF_CODE3				AS PO_TYPE
			  FROM		STR800T A  WITH (NOLOCK)

			  -- LOT 현재고추가
			  LEFT JOIN BIV150T X WITH(NOLOCK) ON X.COMP_CODE	= A.COMP_CODE
												AND X.DIV_CODE	= A.DIV_CODE
												AND X.ITEM_CODE	= A.ITEM_CODE
												AND X.LOT_NO	= A.LOT_NO
												AND X.WH_CODE	= A.WH_CODE
			  --
			  
			  LEFT JOIN BPR100T B  WITH (NOLOCK) ON B.COMP_CODE	= A.COMP_CODE
												AND B.ITEM_CODE	= A.ITEM_CODE
			  LEFT JOIN BSA220T R1 WITH (NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
			  									AND R1.TREE_CODE = A.WH_CODE
			  LEFT JOIN BSA100T R2 WITH (NOLOCK) ON R2.COMP_CODE = A.COMP_CODE
			  									AND R2.MAIN_CODE = 'S105'
			  									AND R2.SUB_CODE != '$'
			  									AND R2.SUB_CODE = A.LABEL_CUSTOM
			  LEFT JOIN BSA100T R3 WITH (NOLOCK) ON R3.COMP_CODE = A.COMP_CODE
			  									AND R3.MAIN_CODE = 'S106'
			  									AND R3.SUB_CODE != '$' 
			  									AND R3.SUB_CODE = A.LABEL_TYPE
			  LEFT JOIN BSA100T K  WITH (NOLOCK) ON K.COMP_CODE = A.COMP_CODE 
												AND K.MAIN_CODE = 'S105'
												AND K.SUB_CODE = A.LABEL_CUSTOM
			  LEFT JOIN BPR300T R4 WITH (NOLOCK) ON R4.COMP_CODE = A.COMP_CODE
												AND R4.DIV_CODE = A.DIV_CODE
												AND R4.TYPE = '2'
												AND R4.ITEM_CODE = A.ITEM_CODE
												--AND R4.CUSTOM_CODE = A.LABEL_CUSTOM
												AND R4.CUSTOM_CODE = ISNULL(K.REF_CODE2, '')
												AND A.PACK_DATE BETWEEN R4.APLY_START_DATE AND R4.APLY_END_DATE
			 WHERE A.COMP_CODE = @CompCode
			   AND A.DIV_CODE = #{DIV_CODE}
			   AND A.PACK_DATE &gt;= #{PACK_DATE_FR}
			   AND A.PACK_DATE &lt;= #{PACK_DATE_TO}
			 <if test="@foren.Ognl@isNotEmpty(BOX_BARCODE)">
			   AND A.BOX_BARCODE = #{BOX_BARCODE}
			 </if>
			 <if test="@foren.Ognl@isNotEmpty(LABEL_CUSTOM)">
			   AND A.LABEL_CUSTOM = #{LABEL_CUSTOM}
			 </if>
			 <if test="@foren.Ognl@isNotEmpty(LABEL_TYPE)">
			   AND A.LABEL_TYPE = #{LABEL_TYPE}
			 </if>
			 
			 <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
			 AND A.ITEM_CODE   = #{ITEM_CODE}					/* 품목코드  */
			 </if>
			 <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
			 AND A.ITEM_CODE   LIKE #{ITEM_CODE} + '%'			/* 품목코드  */
			 </if>
			 <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
			 AND CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
					  WHEN @RefItem = '2' THEN B.ITEM_NAME2
										  ELSE B.ITEM_NAME
					  END LIKE '%' + #{ITEM_NAME} + '%'			/* 품목명  */
			 </if>

			 GROUP BY  A.COMP_CODE, A.DIV_CODE, A.BOX_BARCODE, A.PACK_DATE, A.ITEM_CODE
				 ,(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
						WHEN @RefItem = '2' THEN B.ITEM_NAME2
											ELSE B.ITEM_NAME
				   END)										
				 , B.SPEC, B.STOCK_UNIT, A.REMARK, A.WH_CODE, R1.TREE_NAME 
				 , A.LABEL_CUSTOM, R2.CODE_NAME, A.LABEL_TYPE, R3.CODE_NAME, R4.CUSTOM_ITEM_CODE
				 , A.PO_NO
				 , A.BOX_QTY
				 --20190117 추가
				 , R2.REF_CODE3
			 ORDER BY A.BOX_BARCODE, A.PACK_DATE --, A.INSERT_DB_TIME
		
		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>
	
		<select id="str800skrvServiceImpl.selectPrintList2" parameterType="Map" resultType="rMap">
		SELECT 
			  A.COMP_CODE
			, A.DIV_CODE
			, A.ITEM_CODE
			, MAX(C.ITEM_NAME) AS ITEM_NAME
			, MAX(A.PACK_DATE) AS PACK_DATE
			, SUM(A.QTY) AS SUM_QTY
			, B.CUSTOM_ITEM_CODE
			, A.BOX_BARCODE
			, (SELECT S1.PRODT_DATE FROM PMR100T S1 WITH(NOLOCK) WHERE S1.COMP_CODE = A.COMP_CODE AND S1.DIV_CODE = A.DIV_CODE AND S1.LOT_NO = MAX(A.LOT_NO)) AS PRODT_DATE
			, MAX(C.ITEM_MODEL) AS ITEM_MODEL
			, A.LABEL_CUSTOM
			, MAX(R1.CODE_NAME) AS LABEL_COSTOM_NAME
			, A.LABEL_TYPE
			, A.PO_NO
			, A.BOX_QTY
			 , MAX(B.REMARK)		AS REMARK
			  , R1.CODE_NAME AS CUSTOM_CODE
		FROM STR800T A WITH(NOLOCK)
		 LEFT JOIN BSA100T K WITH(NOLOCK) ON K.COMP_CODE = A.COMP_CODE 
										 AND K.MAIN_CODE = 'S105'
										 AND K.SUB_CODE = A.LABEL_CUSTOM
		 LEFT JOIN BPR300T B WITH(NOLOCK) ON B.COMP_CODE = A.COMP_CODE
										 AND B.DIV_CODE = A.DIV_CODE
										 AND B.TYPE = '2'
										 AND B.ITEM_CODE = A.ITEM_CODE
										--AND B.CUSTOM_CODE = A.LABEL_CUSTOM
										 AND B.CUSTOM_CODE = ISNULL(K.REF_CODE2, '')
										 AND A.PACK_DATE BETWEEN B.APLY_START_DATE AND B.APLY_END_DATE
	
	    LEFT JOIN BPR100T C WITH(NOLOCK) ON C.COMP_CODE = A.COMP_CODE
									    AND C.ITEM_CODE = A.ITEM_CODE
									    
		LEFT JOIN BSA100T R1 WITH(NOLOCK) ON R1.COMP_CODE = A.COMP_CODE
										 AND R1.MAIN_CODE = 'S105'
										 AND R1.SUB_CODE != '$'
										 AND R1.SUB_CODE = A.LABEL_CUSTOM
		WHERE A.COMP_CODE = #{S_COMP_CODE}
		  AND A.DIV_CODE = #{DIV_CODE}
		  AND A.BOX_BARCODE IN (select value from  uniLITE.fnSplit(#{BOX_NUMS}, ','))
	
		GROUP BY A.COMP_CODE, A.DIV_CODE, A.BOX_BARCODE, A.ITEM_CODE,B.CUSTOM_ITEM_CODE,A.LABEL_CUSTOM,A.LABEL_TYPE, A.PO_NO, A.BOX_QTY, R1.CODE_NAME
	</select>
	  
</mapper>