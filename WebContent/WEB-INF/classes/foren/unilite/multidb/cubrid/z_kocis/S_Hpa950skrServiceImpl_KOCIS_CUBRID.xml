<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_hpa950skrServiceImpl_KOCIS">

    <select id="s_hpa950skrServiceImpl_KOCIS.getCostPoolName" parameterType="Map" resultType="rMap">
        SELECT NVL(REF_CODE2, '') AS REF_CODE2
          FROM BSA100T
         WHERE COMP_CODE    = #{S_COMP_CODE}
           AND MAIN_CODE    = 'H175'
           AND SUB_CODE     = '10'
           AND REF_CODE1    = 'Y'           
    </select>
    
    <select id="s_hpa950skrServiceImpl_KOCIS.selectColumns" parameterType="loginVO" resultType="rMap">
        --s_hpa950skrServiceImpl_KOCIS.selectColumns
        
        SET @KEY_VALUE = '';
        
        DO(
            SELECT @KEY_VALUE := fnGetHpa950skrSelectCol1(#{S_COMP_CODE})
          );
        
        
        SELECT WAGES_NAME
        FROM T_HPA950SKR_3
        WHERE KEY_VALUE = @KEY_VALUE;
        
        DELETE FROM T_HPA950SKR_1 WHERE KEY_VALUE = @KEY_VALUE;
        DELETE FROM T_HPA950SKR_2 WHERE KEY_VALUE = @KEY_VALUE;
        DELETE FROM T_HPA950SKR_3 WHERE KEY_VALUE = @KEY_VALUE;      
        
    </select>

    <select id="s_hpa950skrServiceImpl_KOCIS.selectColumns2" parameterType="Map" resultType="rMap">     
    --s_hpa950skrServiceImpl_KOCIS.selectColumns2
        
        SET @KEY_VALUE = '';
        
        DO(
            SELECT @KEY_VALUE := fnGetHpa950skrSelectCol2(#{S_COMP_CODE}, #{DATE_FR}, #{DATE_TO})
          );
        
        
        -- KEY_VALUE 추가, 화면에서 KEY_VALUE를 selectList호출시 파라미터로 넘겨줘야함.
        SELECT WAGES_NAME, @KEY_VALUE AS KEY_VALUE
        FROM T_HPA950SKR_3
        WHERE KEY_VALUE = @KEY_VALUE;
  
-- 조회시 s_hpa950skrServiceImpl_KOCIS.selectList 에서 하단 테이블의 값을 사용하므로 삭제하지 않아야함.        
--        DELETE FROM T_HPA950SKR_1 WHERE KEY_VALUE = @KEY_VALUE;
--        DELETE FROM T_HPA950SKR_2 WHERE KEY_VALUE = @KEY_VALUE;
        DELETE FROM T_HPA950SKR_3 WHERE KEY_VALUE = @KEY_VALUE;     
        
    </select>
    
    <select id="s_hpa950skrServiceImpl_KOCIS.selectList" parameterType="Map" resultType="rMap"> 
    --s_hpa950skrServiceImpl_KOCIS.selectList
        
        -- 화면 파라미터
        SET @KeyValue = #{KEY_VALUE};
        

    
    --  [ 1. 날짜 포맷 유형 설정 ] -------------------------------------------------------------------------------------------
        SET @DateFormat = (
                                        SELECT  M1.CODE_NAME
                                        FROM   BSA100T M1
                                        WHERE  M1.COMP_CODE = #{S_COMP_CODE}
                                        AND     M1.MAIN_CODE   = 'B044'
                                        AND     M1.REF_CODE1    = 'Y'
                                     );
        SET @DateFormat = NVL(@DateFormat, 'YYYY.MM.DD');
        
        SET @DateFormatMM = (
                                            SELECT M1.REF_CODE2
                                            FROM   BSA100T M1
                                            WHERE  M1.COMP_CODE = #{S_COMP_CODE}
                                            AND      M1.MAIN_CODE  = 'B044'
                                            AND      M1.REF_CODE1   = 'Y'
                                          );
        SET @DateFormatMM = NVL(@DateFormatMM, 'YYYY.MM');                                        
        
    
    --  [ 3. 급여내역 INSERT ] ----------------------------------------------------------------------------------------------
     INSERT INTO T_HPA950SKR_4
           (KEY_VALUE,   GUBUN           , DIV_CODE      , DEPT_CODE         , DEPT_NAME     , POST_NAME         , NAME      , PERSON_NUMB
          , JOIN_DATE       , PAY_YYYYMM    , SUPP_NAME         , SUPP_DATE     , SUPP_TYPE         , ABIL_NAME
          , SUPP_TOTAL_I        , DED_TOTAL_I   , REAL_AMOUNT_I     , BUSI_SHARE_I  , WORKER_COMPEN_I
          , S1              , S2            , S3                , S4            , S5
          , S6              , S7            , S8                , S9            , S10
          , S11             , S12           , S13               , S14           , S15
          , S16             , S17           , S18               , S19           , S20
          , S21             , S22           , S23               , S24           , S25
          , S26             , S27           , S28               , S29           , S30
          , S31             , S32           , S33               , S34           , S35
          , S36             , S37           , S38               , S39           , S40
    
          , D1              , D2            , D3                , D4            , D5
          , D6              , D7            , D8                , D9            , D10
          , D11             , D12           , D13               , D14           , D15
          , D16             , D17           , D18               , D19           , D20
     
          , COST_POOL       , OFFICE_NAME   , SEX_NAME          , EMPLOY_TYPE   , PAY_CODE         , SECT_CODE
           )
    
     SELECT 
            @KeyValue
          , '1'                                                             AS GUBUN
          , B.DIV_NAME                                                      AS DIV_CODE
          , M1.DEPT_CODE                                                    AS DEPT_CODE
          , M1.DEPT_NAME                                                    AS DEPT_NAME
          , M6.CODE_NAME                                                    AS POST_NAME
          , M0.NAME                                                         AS NAME
          , M1.PERSON_NUMB                                                  AS PERSON_NUMB
          , REPLACE(
            REPLACE(
            REPLACE(@DateFormat, 'YYYY', SUBSTRING(M0.JOIN_DATE, 1, 4))
                               , 'MM'  , SUBSTRING(M0.JOIN_DATE, 5, 2))
                               , 'DD'  , SUBSTRING(M0.JOIN_DATE, 7, 2))     AS JOIN_DATE
          , REPLACE(
            REPLACE(@DateFormatMM, 'YYYY', SUBSTRING(M1.PAY_YYYYMM, 1, 4))
                                 , 'MM'  , SUBSTRING(M1.PAY_YYYYMM, 5, 2))  AS PAY_YYYYMM
          , M8.CODE_NAME                                                    AS SUPP_NAME
          , CASE WHEN M1.SUPP_DATE = '00000000' THEN NULL
                 ELSE REPLACE(
                      REPLACE(
                      REPLACE(@DateFormat, 'YYYY', SUBSTRING(M1.SUPP_DATE, 1, 4))
                                         , 'MM'  , SUBSTRING(M1.SUPP_DATE, 5, 2))
                                         , 'DD'  , SUBSTRING(M1.SUPP_DATE, 7, 2))
            END                                                             AS SUPP_DATE
          , M1.SUPP_TYPE                                                    AS SUPP_TYPE
          , NVL(M7.CODE_NAME, '')                                        AS ABIL_NAME
          , M1.SUPP_TOTAL_I                                                 AS SUPP_TOTAL_I
          , M1.DED_TOTAL_I                                                  AS DED_TOTAL_I
          , M1.REAL_AMOUNT_I                                                AS REAL_AMOUNT_I
          , M1.BUSI_SHARE_I                                                 AS BUSI_SHARE_I
          , M1.WORKER_COMPEN_I                                              AS WORKER_COMPEN_I
          , NVL(M2.S1,0)  AS S1      , NVL(M2.S2,0)  AS S2       , NVL(M2.S3,0)  AS S3
          , NVL(M2.S4,0)  AS S4      , NVL(M2.S5,0)  AS S5       , NVL(M2.S6,0)  AS S6
          , NVL(M2.S7,0)  AS S7      , NVL(M2.S8,0)  AS S8       , NVL(M2.S9,0)  AS S9
          , NVL(M2.S10,0) AS S10     , NVL(M2.S11,0) AS S11      , NVL(M2.S12,0) AS S12
          , NVL(M2.S13,0) AS S13     , NVL(M2.S14,0) AS S14      , NVL(M2.S15,0) AS S15
          , NVL(M2.S16,0) AS S16     , NVL(M2.S17,0) AS S17      , NVL(M2.S18,0) AS S18
          , NVL(M2.S19,0) AS S19     , NVL(M2.S20,0) AS S20      , NVL(M2.S21,0) AS S21
          , NVL(M2.S22,0) AS S22     , NVL(M2.S23,0) AS S23      , NVL(M2.S24,0) AS S24
          , NVL(M2.S25,0) AS S25     , NVL(M2.S26,0) AS S26      , NVL(M2.S27,0) AS S27
          , NVL(M2.S28,0) AS S28     , NVL(M2.S29,0) AS S29      , NVL(M2.S30,0) AS S30
          , NVL(M2.S31,0) AS S31     , NVL(M2.S32,0) AS S32      , NVL(M2.S33,0) AS S33
          , NVL(M2.S34,0) AS S34     , NVL(M2.S35,0) AS S35      , NVL(M2.S36,0) AS S36
          , NVL(M2.S37,0) AS S37     , NVL(M2.S38,0) AS S38      , NVL(M2.S39,0) AS S39
          , NVL(M2.S40,0) AS S40
    
            -- 공제
          , NVL(M3.D1,0)  AS D1      , NVL(M3.D2,0)  AS D2       , NVL(M3.D3,0)  AS D3
          , NVL(M3.D4,0)  AS D4      , NVL(M3.D5,0)  AS D5       , NVL(M3.D6,0)  AS D6
          , NVL(M3.D7,0)  AS D7      , NVL(M3.D8,0)  AS D8       , NVL(M3.D9,0)  AS D9
          , NVL(M3.D10,0) AS D10     , NVL(M3.D11,0) AS D11      , NVL(M3.D12,0) AS D12
          , NVL(M3.D13,0) AS D13     , NVL(M3.D14,0) AS D14      , NVL(M3.D15,0) AS D15
          , NVL(M3.D16,0) AS D16     , NVL(M3.D17,0) AS D17      , NVL(M3.D18,0) AS D18
          , NVL(M3.D19,0) AS D19     , NVL(M3.D20,0) AS D20
    
          , M4.COST_POOL_NAME                                               AS COST_POOL
          , NVL(M9.CODE_NAME, '')                                        AS OFFICE_NAME   
          , CASE WHEN M0.SEX_CODE = 'M' THEN fnGetTxt('H0027')
                 ELSE fnGetTxt('H0028')
            END                                                             AS SEX_NAME   
          , M10.CODE_NAME                                                   AS EMPLOY_TYPE
          , M11.CODE_NAME                                                   AS PAY_CODE
          , B2.DIV_NAME                                                     AS SECT_CODE
    
       FROM               HUM100T M0 
            INNER JOIN HPA600T  M1  ON M1.COMP_CODE    = M0.COMP_CODE
                                                  AND M1.PERSON_NUMB = M0.PERSON_NUMB 
            LEFT JOIN (
                             SELECT T1.PERSON_NUMB
                                        , T1.PAY_YYYYMM
                                        , T1.SUPP_TYPE
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C1  THEN T1.AMOUNT_I ELSE 0 END) AS S1
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C2  THEN T1.AMOUNT_I ELSE 0 END) AS S2
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C3  THEN T1.AMOUNT_I ELSE 0 END) AS S3
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C4  THEN T1.AMOUNT_I ELSE 0 END) AS S4
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C5  THEN T1.AMOUNT_I ELSE 0 END) AS S5
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C6  THEN T1.AMOUNT_I ELSE 0 END) AS S6
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C7  THEN T1.AMOUNT_I ELSE 0 END) AS S7
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C8  THEN T1.AMOUNT_I ELSE 0 END) AS S8
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C9  THEN T1.AMOUNT_I ELSE 0 END) AS S9
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C10 THEN T1.AMOUNT_I ELSE 0 END) AS S10   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C11 THEN T1.AMOUNT_I ELSE 0 END) AS S11   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C12 THEN T1.AMOUNT_I ELSE 0 END) AS S12   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C13 THEN T1.AMOUNT_I ELSE 0 END) AS S13   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C14 THEN T1.AMOUNT_I ELSE 0 END) AS S14   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C15 THEN T1.AMOUNT_I ELSE 0 END) AS S15   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C16 THEN T1.AMOUNT_I ELSE 0 END) AS S16   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C17 THEN T1.AMOUNT_I ELSE 0 END) AS S17   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C18 THEN T1.AMOUNT_I ELSE 0 END) AS S18   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C19 THEN T1.AMOUNT_I ELSE 0 END) AS S19   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C20 THEN T1.AMOUNT_I ELSE 0 END) AS S20   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C21 THEN T1.AMOUNT_I ELSE 0 END) AS S21   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C22 THEN T1.AMOUNT_I ELSE 0 END) AS S22   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C23 THEN T1.AMOUNT_I ELSE 0 END) AS S23   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C24 THEN T1.AMOUNT_I ELSE 0 END) AS S24   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C25 THEN T1.AMOUNT_I ELSE 0 END) AS S25   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C26 THEN T1.AMOUNT_I ELSE 0 END) AS S26   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C27 THEN T1.AMOUNT_I ELSE 0 END) AS S27   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C28 THEN T1.AMOUNT_I ELSE 0 END) AS S28   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C29 THEN T1.AMOUNT_I ELSE 0 END) AS S29   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C30 THEN T1.AMOUNT_I ELSE 0 END) AS S30   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C31 THEN T1.AMOUNT_I ELSE 0 END) AS S31   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C32 THEN T1.AMOUNT_I ELSE 0 END) AS S32   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C33 THEN T1.AMOUNT_I ELSE 0 END) AS S33   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C34 THEN T1.AMOUNT_I ELSE 0 END) AS S34   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C35 THEN T1.AMOUNT_I ELSE 0 END) AS S35   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C36 THEN T1.AMOUNT_I ELSE 0 END) AS S36   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C37 THEN T1.AMOUNT_I ELSE 0 END) AS S37   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C38 THEN T1.AMOUNT_I ELSE 0 END) AS S38   
                                        , SUM(CASE WHEN T1.WAGES_CODE = T4.C39 THEN T1.AMOUNT_I ELSE 0 END) AS S39   
                                        , MAX(CASE WHEN T4.C40 = 'zzz' 
                                                        THEN NVL(T5.ETC_AMT,0)   
                                                        ELSE (CASE WHEN T1.WAGES_CODE = T4.C40 THEN T1.AMOUNT_I ELSE 0 END) 
                                               END)                                                         AS S40 
                                        , T1.COMP_CODE
                         FROM HPA300T T1
                         LEFT JOIN (
                                          SELECT PERSON_NUMB
                                                   , PAY_YYYYMM
                                                   , SUPP_TYPE
                                                   , SUM(AMOUNT_I) AS ETC_AMT 
                                                   , COMP_CODE
                                          FROM HPA300T 
                                          WHERE COMP_CODE      = #{S_COMP_CODE}
                                          AND    SUPP_TYPE      LIKE #{SUPP_TYPE} + '%'
                                          AND    PAY_YYYYMM   &gt;=  #{DATE_FR}
                                          AND    PAY_YYYYMM   &lt;=  #{DATE_TO}
                                          AND    WAGES_CODE IN (SELECT WAGES_CODE FROM T_HPA950SKR_2   WHERE KEY_VALUE = @KeyValue AND W_SEQ &gt;= 30 )  
                                          GROUP BY PERSON_NUMB, PAY_YYYYMM, SUPP_TYPE, COMP_CODE
                                          
                                        ) T5 ON T5.COMP_CODE    = T1.COMP_CODE
                                            AND T5.PERSON_NUMB = T1.PERSON_NUMB 
                                            AND T5.PAY_YYYYMM   = T1.PAY_YYYYMM
                                            AND T5.SUPP_TYPE       = T1.SUPP_TYPE 
                                    , (
                                           SELECT MAX(CASE WHEN W_SEQ = 1  THEN WAGES_CODE ELSE '' END) AS C1
                                                    , MAX(CASE WHEN W_SEQ = 2  THEN WAGES_CODE ELSE '' END) AS C2
                                                    , MAX(CASE WHEN W_SEQ = 3  THEN WAGES_CODE ELSE '' END) AS C3
                                                    , MAX(CASE WHEN W_SEQ = 4  THEN WAGES_CODE ELSE '' END) AS C4
                                                    , MAX(CASE WHEN W_SEQ = 5  THEN WAGES_CODE ELSE '' END) AS C5
                                                    , MAX(CASE WHEN W_SEQ = 6  THEN WAGES_CODE ELSE '' END) AS C6
                                                    , MAX(CASE WHEN W_SEQ = 7  THEN WAGES_CODE ELSE '' END) AS C7
                                                    , MAX(CASE WHEN W_SEQ = 8  THEN WAGES_CODE ELSE '' END) AS C8
                                                    , MAX(CASE WHEN W_SEQ = 9  THEN WAGES_CODE ELSE '' END) AS C9
                                                    , MAX(CASE WHEN W_SEQ = 10 THEN WAGES_CODE ELSE '' END) AS C10
                                                    , MAX(CASE WHEN W_SEQ = 11 THEN WAGES_CODE ELSE '' END) AS C11
                                                    , MAX(CASE WHEN W_SEQ = 12 THEN WAGES_CODE ELSE '' END) AS C12
                                                    , MAX(CASE WHEN W_SEQ = 13 THEN WAGES_CODE ELSE '' END) AS C13
                                                    , MAX(CASE WHEN W_SEQ = 14 THEN WAGES_CODE ELSE '' END) AS C14
                                                    , MAX(CASE WHEN W_SEQ = 15 THEN WAGES_CODE ELSE '' END) AS C15
                                                    , MAX(CASE WHEN W_SEQ = 16 THEN WAGES_CODE ELSE '' END) AS C16
                                                    , MAX(CASE WHEN W_SEQ = 17 THEN WAGES_CODE ELSE '' END) AS C17
                                                    , MAX(CASE WHEN W_SEQ = 18 THEN WAGES_CODE ELSE '' END) AS C18
                                                    , MAX(CASE WHEN W_SEQ = 19 THEN WAGES_CODE ELSE '' END) AS C19
                                                    , MAX(CASE WHEN W_SEQ = 20 THEN WAGES_CODE ELSE '' END) AS C20
                                                    , MAX(CASE WHEN W_SEQ = 21 THEN WAGES_CODE ELSE '' END) AS C21
                                                    , MAX(CASE WHEN W_SEQ = 22 THEN WAGES_CODE ELSE '' END) AS C22
                                                    , MAX(CASE WHEN W_SEQ = 23 THEN WAGES_CODE ELSE '' END) AS C23
                                                    , MAX(CASE WHEN W_SEQ = 24 THEN WAGES_CODE ELSE '' END) AS C24
                                                    , MAX(CASE WHEN W_SEQ = 25 THEN WAGES_CODE ELSE '' END) AS C25
                                                    , MAX(CASE WHEN W_SEQ = 26 THEN WAGES_CODE ELSE '' END) AS C26
                                                    , MAX(CASE WHEN W_SEQ = 27 THEN WAGES_CODE ELSE '' END) AS C27
                                                    , MAX(CASE WHEN W_SEQ = 28 THEN WAGES_CODE ELSE '' END) AS C28
                                                    , MAX(CASE WHEN W_SEQ = 29 THEN WAGES_CODE ELSE '' END) AS C29
                                                    , MAX(CASE WHEN W_SEQ = 30 THEN WAGES_CODE ELSE '' END) AS C30
                                                    , MAX(CASE WHEN W_SEQ = 31 THEN WAGES_CODE ELSE '' END) AS C31
                                                    , MAX(CASE WHEN W_SEQ = 32 THEN WAGES_CODE ELSE '' END) AS C32
                                                    , MAX(CASE WHEN W_SEQ = 33 THEN WAGES_CODE ELSE '' END) AS C33
                                                    , MAX(CASE WHEN W_SEQ = 34 THEN WAGES_CODE ELSE '' END) AS C34
                                                    , MAX(CASE WHEN W_SEQ = 35 THEN WAGES_CODE ELSE '' END) AS C35
                                                    , MAX(CASE WHEN W_SEQ = 36 THEN WAGES_CODE ELSE '' END) AS C36
                                                    , MAX(CASE WHEN W_SEQ = 37 THEN WAGES_CODE ELSE '' END) AS C37
                                                    , MAX(CASE WHEN W_SEQ = 38 THEN WAGES_CODE ELSE '' END) AS C38
                                                    , MAX(CASE WHEN W_SEQ = 39 THEN WAGES_CODE ELSE '' END) AS C39
                                                    , MAX(CASE WHEN W_SEQ &gt;= 40 THEN 'zzz'  
                                                                      ELSE (CASE WHEN W_SEQ = 40 THEN WAGES_CODE ELSE '' END) 
                                                              END) AS C40
                                         FROM T_HPA950SKR_2
                                         WHERE KEY_VALUE = @KeyValue
                                      ) T4
                            WHERE T1.SUPP_TYPE  LIKE #{SUPP_TYPE} + '%'
                              AND T1.PAY_YYYYMM &gt;= #{DATE_FR}
                              AND T1.PAY_YYYYMM &lt;= #{DATE_TO}
                              AND T1.COMP_CODE   = #{S_COMP_CODE}
                            GROUP BY T1.PERSON_NUMB,T1.PAY_YYYYMM, T1.SUPP_TYPE, T1.COMP_CODE
                            
                            
                            ) M2 ON M2.COMP_CODE     = M1.COMP_CODE
                                 AND M2.PERSON_NUMB  = M1.PERSON_NUMB  
                                 AND M2.SUPP_TYPE        = M1.SUPP_TYPE   
                                 AND M2.PAY_YYYYMM    = M1.PAY_YYYYMM  
            LEFT  JOIN (
                             SELECT T1.PERSON_NUMB
                                      , T1.PAY_YYYYMM
                                      , T1.SUPP_TYPE 
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D1  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D1 
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D2  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D2 
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D3  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D3
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D4  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D4
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D5  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D5
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D6  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D6
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D7  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D7
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D8  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D8
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D9  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D9
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D10 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D10
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D11 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D11
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D12 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D12
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D13 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D13
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D14 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D14
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D15 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D15
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D16 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D16
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D17 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D17
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D18 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D18
                                      , SUM(CASE WHEN T1.DED_CODE = T4.D19 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D19
                                      , MAX(CASE WHEN T4.D20 = 'zz' THEN NVL(T5.ETC_AMT,0)  
                                                        ELSE (CASE WHEN T1.DED_CODE = T4.D20 THEN T1.DED_AMOUNT_I ELSE 0 END) 
                                                END ) AS D20 
                             , T1.COMP_CODE 
                            FROM HPA400T T1
                            LEFT JOIN   (
                                               SELECT PERSON_NUMB
                                                         , PAY_YYYYMM
                                                         , SUPP_TYPE
                                                         , SUM(DED_AMOUNT_I) AS ETC_AMT 
                                                         , COMP_CODE
                                               FROM HPA400T
                                               WHERE COMP_CODE       = #{S_COMP_CODE}
                                               AND    SUPP_TYPE       LIKE #{SUPP_TYPE} + '%'
                                               AND    PAY_YYYYMM     &gt;= #{DATE_FR}
                                               AND    PAY_YYYYMM     &lt;= #{DATE_TO}
                                               AND    DED_CODE IN (SELECT SUB_CODE 
                                                                               FROM T_HPA950SKR_1
                                                                               WHERE SEQ &gt;= 20 ) 
                                               GROUP BY PERSON_NUMB, PAY_YYYYMM, SUPP_TYPE, COMP_CODE 
                                             ) T5 ON T5.COMP_CODE    = T1.COMP_CODE
                                                 AND T5.PERSON_NUMB = T1.PERSON_NUMB  
                                                 AND T5.PAY_YYYYMM   = T1.PAY_YYYYMM  
                                                 AND T5.SUPP_TYPE       = T1.SUPP_TYPE  
                                           ,  (
                                                SELECT MAX(CASE WHEN A.SEQ = 1  THEN A.SUB_CODE ELSE '' END) AS D1  
                                                         , MAX(CASE WHEN A.SEQ = 2  THEN A.SUB_CODE ELSE '' END) AS D2  
                                                         , MAX(CASE WHEN A.SEQ = 3  THEN A.SUB_CODE ELSE '' END) AS D3  
                                                         , MAX(CASE WHEN A.SEQ = 4  THEN A.SUB_CODE ELSE '' END) AS D4  
                                                         , MAX(CASE WHEN A.SEQ = 5  THEN A.SUB_CODE ELSE '' END) AS D5  
                                                         , MAX(CASE WHEN A.SEQ = 6  THEN A.SUB_CODE ELSE '' END) AS D6  
                                                         , MAX(CASE WHEN A.SEQ = 7  THEN A.SUB_CODE ELSE '' END) AS D7  
                                                         , MAX(CASE WHEN A.SEQ = 8  THEN A.SUB_CODE ELSE '' END) AS D8  
                                                         , MAX(CASE WHEN A.SEQ = 9  THEN A.SUB_CODE ELSE '' END) AS D9  
                                                         , MAX(CASE WHEN A.SEQ = 10 THEN A.SUB_CODE ELSE '' END) AS D10  
                                                         , MAX(CASE WHEN A.SEQ = 11 THEN A.SUB_CODE ELSE '' END) AS D11  
                                                         , MAX(CASE WHEN A.SEQ = 12 THEN A.SUB_CODE ELSE '' END) AS D12  
                                                         , MAX(CASE WHEN A.SEQ = 13 THEN A.SUB_CODE ELSE '' END) AS D13  
                                                         , MAX(CASE WHEN A.SEQ = 14 THEN A.SUB_CODE ELSE '' END) AS D14  
                                                         , MAX(CASE WHEN A.SEQ = 15 THEN A.SUB_CODE ELSE '' END) AS D15  
                                                         , MAX(CASE WHEN A.SEQ = 16 THEN A.SUB_CODE ELSE '' END) AS D16  
                                                         , MAX(CASE WHEN A.SEQ = 17 THEN A.SUB_CODE ELSE '' END) AS D17  
                                                         , MAX(CASE WHEN A.SEQ = 18 THEN A.SUB_CODE ELSE '' END) AS D18  
                                                         , MAX(CASE WHEN A.SEQ = 19 THEN A.SUB_CODE ELSE '' END) AS D19  
                                                         , MAX(CASE WHEN A.SEQ &gt;= 20 THEN 'zz' ELSE   CASE WHEN A.SEQ = 20 THEN A.SUB_CODE ELSE '' END END) AS D20 
                                               FROM T_HPA950SKR_1  A 
                                               WHERE A.KEY_VALUE = @KeyValue
                                             ) T4
                               WHERE T1.COMP_CODE        = #{S_COMP_CODE}
                               AND    T1.SUPP_TYPE       LIKE #{SUPP_TYPE} + '%'
                               AND    T1.PAY_YYYYMM     &gt;= #{DATE_FR}
                               AND    T1.PAY_YYYYMM     &lt;= #{DATE_TO}
                              GROUP BY T1.PERSON_NUMB, T1.PAY_YYYYMM, T1.SUPP_TYPE, T1.COMP_CODE
                          ) M3 ON M3.COMP_CODE    = M1.COMP_CODE
                               AND M3.PERSON_NUMB = M1.PERSON_NUMB 
                               AND M3.PAY_YYYYMM   = M1.PAY_YYYYMM  
                               AND M3.SUPP_TYPE       = M1.SUPP_TYPE   
            LEFT  JOIN CBM600T   M4 ON M4.COMP_CODE           = M1.COMP_CODE
                                                AND M4.COST_POOL_CODE   = M1.COST_KIND
            LEFT  JOIN BSA100T   M5  ON M5.COMP_CODE           = M0.COMP_CODE
                                                AND M5.MAIN_CODE            = 'H024'
                                                AND M5.SUB_CODE              = M0.EMPLOY_TYPE
            LEFT  JOIN BSA100T   M6 ON M6.COMP_CODE            = M1.COMP_CODE
                                               AND M6.MAIN_CODE             = 'H005'
                                               AND M6.SUB_CODE               = M1.POST_CODE
            LEFT  JOIN BSA100T   M7  ON M7.COMP_CODE           = M1.COMP_CODE
                                                 AND M7.MAIN_CODE           = 'H006'
                                                 AND M7.SUB_CODE             = M1.ABIL_CODE
            LEFT  JOIN BSA100T   M8  ON M8.COMP_CODE           = M1.COMP_CODE
                                                 AND M8.MAIN_CODE           = 'H032'
                                                 AND M8.SUB_CODE             = M1.SUPP_TYPE
            LEFT  JOIN BSA100T   M9  ON M9.COMP_CODE           = M0.COMP_CODE
                                                 AND M9.MAIN_CODE           = 'GO01'
                                                 AND M9.SUB_CODE             = M0.OFFICE_CODE
            LEFT  JOIN BSA100T   M10 ON M10.COMP_CODE        = M0.COMP_CODE
                                                 AND M10.MAIN_CODE         = 'H024'
                                                 AND M10.SUB_CODE            = M0.EMPLOY_TYPE
            LEFT  JOIN BSA100T   M11 ON M11.COMP_CODE        = M0.COMP_CODE
                                                 AND M11.MAIN_CODE         = 'H028'
                                                 AND M11.SUB_CODE          = M0.PAY_CODE
            LEFT  JOIN BOR120T   B   ON B.COMP_CODE              = M1.COMP_CODE
                                              AND B.DIV_CODE                  = M1.DIV_CODE
            LEFT  JOIN BOR120T   B2 ON B2.COMP_CODE            = M1.COMP_CODE
                                              AND B2.DIV_CODE                = M1.SECT_CODE
     WHERE M1.COMP_CODE      = #{S_COMP_CODE}
     AND     M1.PAY_YYYYMM  &gt;= #{DATE_FR}
     AND     M1.PAY_YYYYMM  &lt;= #{DATE_TO}
    
    <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
           AND M1.DIV_CODE LIKE #{DIV_CODE} + '%'
    </if>
    <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)">
           AND  M1.PERSON_NUMB LIKE #{PERSON_NUMB} + '%'
    </if>
    <if test="@foren.Ognl@isNotEmpty(NAME)">
           AND  M0.NAME LIKE #{NAME} + '%'
    </if>

    <if test="@foren.Ognl@isNotEmpty(SUPP_TYPE)">
       AND  M1.SUPP_TYPE LIKE #{SUPP_TYPE} + '%'
    </if>

    <if test="@foren.Ognl@isNotEmpty(PAY_CODE)">
       AND M1.Pay_Code = #{PAY_CODE}
    </if>
    <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)">
       AND M1.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
    </if>
    <if test="@foren.Ognl@isNotEmpty(PAY_GUBUN)">
       AND M1.PAY_GUBUN = #{PAY_GUBUN}
    </if>
    <if test="@foren.Ognl@isNotEmpty(rdoSelect2)">
       AND M1.PAY_GUBUN2 = #{rdoSelect2}
    </if>
    <if test="rdoSelect1 == &quot;1&quot;">
       AND (M0.RETR_DATE = '00000000' OR M0.RETR_DATE IS NULL)
    </if>
    <if test="rdoSelect1 == &quot;2&quot;">
       AND (M0.RETR_DATE != '00000000' AND M0.RETR_DATE IS NOT NULL)
    </if>

    <if test="@foren.Ognl@isNotEmpty(PERSON_GROUP)">
       AND M5.REF_CODE1   = #{PERSON_GROUP}
    </if>
     
    <if test="@foren.Ognl@isNotEmpty(AFFILE_CODE)">
       AND M0.AFFIL_CODE  = #{AFFILE_CODE}
    </if>
    
    <if test="@foren.Ognl@isNotEmpty(SUPP_DATE_FR)">
       AND M1.SUPP_DATE >= #{SUPP_DATE_FR}
    </if>
    
    <if test="@foren.Ognl@isNotEmpty(SUPP_DATE_TO)">
       AND M1.SUPP_DATE &lt;= #{SUPP_DATE_TO}
    </if>
    
    <if test="@foren.Ognl@isNotEmpty(MAKE_SALE)">
       AND M0.MAKE_SALE  = #{MAKE_SALE}
    </if>
    
    <if test="@foren.Ognl@isNotEmpty(BILL_DIV_CODE)">
       AND M1.SECT_CODE  = #{BILL_DIV_CODE}     -- 신고사업장 추가
    </if>
    
     ORDER BY M0.DIV_CODE, M0.DEPT_CODE, M0.POST_CODE, M0.JOIN_DATE, M0.NAME, M0.PERSON_NUMB, M1.PAY_YYYYMM, M1.SUPP_TYPE;
    
    --  [ 4. 인원수 계산 ] ----------------------------------------------------------------------------------------------

        SET @Cnt = (
                                SELECT COUNT(DISTINCT PERSON_NUMB)
                                FROM     T_HPA950SKR_4
                                WHERE   KEY_VALUE = '20170530145950591183'
                                AND      GUBUN = '1'
                             );
                             
        SET @Cnt = NVL(@Cnt, 0);
    
    --  [ 5. 합계 INSERT ] ----------------------------------------------------------------------------------------------
        INSERT INTO T_HPA950SKR_4
               (KEY_VALUE    , GUBUN           , DIV_CODE
              , SUPP_TOTAL_I    , DED_TOTAL_I   , REAL_AMOUNT_I     , BUSI_SHARE_I  , WORKER_COMPEN_I
              , S1              , S2            , S3                , S4            , S5
              , S6              , S7            , S8                , S9            , S10
              , S11             , S12           , S13               , S14           , S15
              , S16             , S17           , S18               , S19           , S20
              , S21             , S22           , S23               , S24           , S25
              , S26             , S27           , S28               , S29           , S30
              , S31             , S32           , S33               , S34           , S35
              , S36             , S37           , S38               , S39           , S40
      
              , D1              , D2            , D3                , D4            , D5
              , D6              , D7            , D8                , D9            , D10
              , D11             , D12           , D13               , D14           , D15
              , D16             , D17           , D18               , D19           , D20
               )
        SELECT @KeyValue
                 , '2'                                             AS GUBUN
                 , fnGetTxt('A0194') + ' (' + TO_CHAR(@Cnt) + fnGetTxt('H0136') + ')' AS DIV_CODE        -- 총계 (xx명)
                 , SUM(SUPP_TOTAL_I)                               AS SUPP_TOTAL_I
                 , SUM(DED_TOTAL_I)                                AS DED_TOTAL_I
                 , SUM(REAL_AMOUNT_I)                              AS REAL_AMOUNT_I
                 , SUM(BUSI_SHARE_I)                               AS BUSI_SHARE_I
                 , SUM(WORKER_COMPEN_I)                            AS WORKER_COMPEN_I
    
                 , SUM(S1)     , SUM(S2)       , SUM(S3)       , SUM(S4)       , SUM(S5)
                 , SUM(S6)     , SUM(S7)       , SUM(S8)       , SUM(S9)       , SUM(S10)
                 , SUM(S11)    , SUM(S12)      , SUM(S13)      , SUM(S14)      , SUM(S15)
                 , SUM(S16)    , SUM(S17)      , SUM(S18)      , SUM(S19)      , SUM(S20)
                 , SUM(S21)    , SUM(S22)      , SUM(S23)      , SUM(S24)      , SUM(S25)
                 , SUM(S26)    , SUM(S27)      , SUM(S28)      , SUM(S29)      , SUM(S30)
                 , SUM(S31)    , SUM(S32)      , SUM(S33)      , SUM(S34)      , SUM(S35)
                 , SUM(S36)    , SUM(S37)      , SUM(S38)      , SUM(S39)      , SUM(S40)
              
                 , SUM(D1)     , SUM(D2)       , SUM(D3)       , SUM(D4)       , SUM(D5)
                 , SUM(D6)     , SUM(D7)       , SUM(D8)       , SUM(D9)       , SUM(D10)
                 , SUM(D11)    , SUM(D12)      , SUM(D13)      , SUM(D14)      , SUM(D15)
                 , SUM(D16)    , SUM(D17)      , SUM(D18)      , SUM(D19)      , SUM(D20)
        FROM    T_HPA950SKR_4
        WHERE  KEY_VALUE = @KeyValue
        AND     GUBUN       = '1'
        HAVING (SUM(SUPP_TOTAL_I) != 0 OR SUM(DED_TOTAL_I) != 0 OR SUM(REAL_AMOUNT_I) != 0);
    
    --  [ 6. Main Query ] ----------------------------------------------------------------------------------------------
         SELECT
                    GUBUN
                  , DIV_CODE
                  , DEPT_CODE
                  , DEPT_NAME
                  , POST_NAME
                  , NAME
                  , PERSON_NUMB
                  , JOIN_DATE
                  , PAY_YYYYMM
                  , SUPP_NAME
                  , SUPP_DATE
                  , SUPP_TYPE
                  , ABIL_NAME
    
                  , SUPP_TOTAL_I
                  , DED_TOTAL_I
                  , REAL_AMOUNT_I
                  , BUSI_SHARE_I
                  , WORKER_COMPEN_I
    
                  , S1          , S2            , S3            , S4            , S5
                  , S6          , S7            , S8            , S9            , S10
                  , S11         , S12           , S13           , S14           , S15
                  , S16         , S17           , S18           , S19           , S20
                  , S21         , S22           , S23           , S24           , S25
                  , S26         , S27           , S28           , S29           , S30
                  , S31         , S32           , S33           , S34           , S35
                  , S36         , S37           , S38           , S39           , S40
              
                  , D1          , D2            , D3            , D4            , D5
                  , D6          , D7            , D8            , D9            , D10
                  , D11         , D12           , D13           , D14           , D15
                  , D16         , D17           , D18           , D19           , D20
    
                  , COST_POOL
                  , OFFICE_NAME
                  , SEX_NAME
                  , EMPLOY_TYPE
                  , PAY_CODE
                  , SECT_CODE
        FROM    T_HPA950SKR_4 
        WHERE  KEY_VALUE = @KeyValue       
        ORDER BY GUBUN, DOC_ID;
    
        DELETE FROM T_HPA950SKR_1 WHERE KEY_VALUE = @KeyValue;
        DELETE FROM T_HPA950SKR_2 WHERE KEY_VALUE = @KeyValue;          
        DELETE FROM T_HPA950SKR_3 WHERE KEY_VALUE = @KeyValue;                                      
        DELETE FROM T_HPA950SKR_4 WHERE KEY_VALUE = @KeyValue;

    
    </select>
            
    <select id="s_hpa950skrServiceImpl_KOCIS.selectList3" parameterType="Map" resultType="rMap">        
    --s_hpa950skrServiceImpl_KOCIS.selectList3
    
        -- 화면 파라미터
        SET @KeyValue = @KeyValue;
        
        --  [ 1. 날짜 포맷 유형 설정 ] -------------------------------------------------------------------------------------------

            SET @DateFormat = (
                                            SELECT M1.CODE_NAME
                                            FROM   BSA100T M1 
                                            WHERE  M1.COMP_CODE   = #{S_COMP_CODE}
                                            AND    M1.MAIN_CODE   = 'B044'
                                            AND    M1.REF_CODE1   = 'Y'
                                        );
            SET @DateFormat = NVL(@DateFormat, 'YYYY.MM.DD');
            
            SET @DateFormatMM = (                                       
                                                SELECT M1.REF_CODE2
                                                FROM   BSA100T M1
                                                WHERE  M1.COMP_CODE = #{S_COMP_CODE}
                                                AND    M1.MAIN_CODE = 'B044'
                                                AND    M1.REF_CODE1 = 'Y'
                                              );
            SET @DateFormatMM = NVL(@DateFormatMM, 'YYYY.MM');
                                                          
    
        --  [ 3. 급여내역 INSERT ] ----------------------------------------------------------------------------------------------
         INSERT INTO T_HPA950SKR_5
               (KEY_VALUE,   GUBUN           , DIV_CODE      , DEPT_CODE         , DEPT_NAME     , POST_NAME         , NAME      , PERSON_NUMB
              , JOIN_DATE       , PAY_YYYYMM    , SUPP_NAME         , SUPP_DATE     , SUPP_TYPE         , ABIL_NAME
              , SUPP_TOTAL_I    , DED_TOTAL_I   , REAL_AMOUNT_I     , BUSI_SHARE_I  , WORKER_COMPEN_I
              , S1              , S2            , S3                , S4            , S5
              , S6              , S7            , S8                , S9            , S10
              , S11             , S12           , S13               , S14           , S15
              , S16             , S17           , S18               , S19           , S20
              , S21             , S22           , S23               , S24           , S25
              , S26             , S27           , S28               , S29           , S30
              , S31             , S32           , S33               , S34           , S35
              , S36             , S37           , S38               , S39           , S40
        
              , D1              , D2            , D3                , D4            , D5
              , D6              , D7            , D8                , D9            , D10
              , D11             , D12           , D13               , D14           , D15
              , D16             , D17           , D18               , D19           , D20
         
              , COST_POOL       , OFFICE_NAME   , SEX_NAME          , EMPLOY_TYPE   , PAY_CODE
               )        
         SELECT 
                @KeyValue
              , '1'                                                             AS GUBUN
              , B.DIV_NAME                                                      AS DIV_CODE
              , M1.DEPT_CODE                                                    AS DEPT_CODE
              , M1.DEPT_NAME                                                    AS DEPT_NAME
              , M6.CODE_NAME                                                    AS POST_NAME
              , M0.NAME                                                         AS NAME
              , M1.PERSON_NUMB                                                  AS PERSON_NUMB
              , REPLACE(
                REPLACE(
                REPLACE(@DateFormat, 'YYYY', SUBSTRING(M0.JOIN_DATE, 1, 4))
                                   , 'MM'  , SUBSTRING(M0.JOIN_DATE, 5, 2))
                                   , 'DD'  , SUBSTRING(M0.JOIN_DATE, 7, 2))     AS JOIN_DATE
              , REPLACE(
                REPLACE(@DateFormatMM, 'YYYY', SUBSTRING(M1.PAY_YYYYMM, 1, 4))
                                     , 'MM'  , SUBSTRING(M1.PAY_YYYYMM, 5, 2))  AS PAY_YYYYMM
              , M8.CODE_NAME                                                    AS SUPP_NAME
              , CASE WHEN M1.SUPP_DATE = '00000000' THEN NULL
                     ELSE REPLACE(
                          REPLACE(
                          REPLACE(@DateFormat, 'YYYY', SUBSTRING(M1.SUPP_DATE, 1, 4))
                                             , 'MM'  , SUBSTRING(M1.SUPP_DATE, 5, 2))
                                             , 'DD'  , SUBSTRING(M1.SUPP_DATE, 7, 2))
                END                                                             AS SUPP_DATE
              , M1.SUPP_TYPE                                                    AS SUPP_TYPE
              , NVL(M7.CODE_NAME, '')                                           AS ABIL_NAME
              , M1.SUPP_TOTAL_I                                                 AS SUPP_TOTAL_I
              , M1.DED_TOTAL_I                                                  AS DED_TOTAL_I
              , M1.REAL_AMOUNT_I                                                AS REAL_AMOUNT_I
              , M1.BUSI_SHARE_I                                                 AS BUSI_SHARE_I
              , M1.WORKER_COMPEN_I                                              AS WORKER_COMPEN_I
              , NVL(M2.S1,0)  AS S1      , NVL(M2.S2,0)  AS S2       , NVL(M2.S3,0)  AS S3
              , NVL(M2.S4,0)  AS S4      , NVL(M2.S5,0)  AS S5       , NVL(M2.S6,0)  AS S6
              , NVL(M2.S7,0)  AS S7      , NVL(M2.S8,0)  AS S8       , NVL(M2.S9,0)  AS S9
              , NVL(M2.S10,0) AS S10     , NVL(M2.S11,0) AS S11      , NVL(M2.S12,0) AS S12
              , NVL(M2.S13,0) AS S13     , NVL(M2.S14,0) AS S14      , NVL(M2.S15,0) AS S15
              , NVL(M2.S16,0) AS S16     , NVL(M2.S17,0) AS S17      , NVL(M2.S18,0) AS S18
              , NVL(M2.S19,0) AS S19     , NVL(M2.S20,0) AS S20      , NVL(M2.S21,0) AS S21
              , NVL(M2.S22,0) AS S22     , NVL(M2.S23,0) AS S23      , NVL(M2.S24,0) AS S24
              , NVL(M2.S25,0) AS S25     , NVL(M2.S26,0) AS S26      , NVL(M2.S27,0) AS S27
              , NVL(M2.S28,0) AS S28     , NVL(M2.S29,0) AS S29      , NVL(M2.S30,0) AS S30
              , NVL(M2.S31,0) AS S31     , NVL(M2.S32,0) AS S32      , NVL(M2.S33,0) AS S33
              , NVL(M2.S34,0) AS S34     , NVL(M2.S35,0) AS S35      , NVL(M2.S36,0) AS S36
              , NVL(M2.S37,0) AS S37     , NVL(M2.S38,0) AS S38      , NVL(M2.S39,0) AS S39
              , NVL(M2.S40,0) AS S40
        
                -- 공제
              , NVL(M3.D1,0)  AS D1      , NVL(M3.D2,0)  AS D2       , NVL(M3.D3,0)  AS D3
              , NVL(M3.D4,0)  AS D4      , NVL(M3.D5,0)  AS D5       , NVL(M3.D6,0)  AS D6
              , NVL(M3.D7,0)  AS D7      , NVL(M3.D8,0)  AS D8       , NVL(M3.D9,0)  AS D9
              , NVL(M3.D10,0) AS D10     , NVL(M3.D11,0) AS D11      , NVL(M3.D12,0) AS D12
              , NVL(M3.D13,0) AS D13     , NVL(M3.D14,0) AS D14      , NVL(M3.D15,0) AS D15
              , NVL(M3.D16,0) AS D16     , NVL(M3.D17,0) AS D17      , NVL(M3.D18,0) AS D18
              , NVL(M3.D19,0) AS D19     , NVL(M3.D20,0) AS D20
        
              , M4.COST_POOL_NAME                                               AS COST_POOL
              , NVL(M9.CODE_NAME, '')                                           AS OFFICE_NAME   
              , CASE WHEN M0.SEX_CODE = 'M' THEN fnGetTxt('H0027')
                     ELSE fnGetTxt('H0028')
                END                                                             AS SEX_NAME   
              , M10.CODE_NAME                                                   AS EMPLOY_TYPE
              , M11.CODE_NAME                                                   AS PAY_CODE
        
           FROM          HUM100T M0
           INNER JOIN HPA600T M1 ON M1.COMP_CODE   = M0.COMP_CODE
                                                   AND M1.PERSON_NUMB = M0.PERSON_NUMB 
           LEFT JOIN (
                                   SELECT T1.PERSON_NUMB
                                            , T1.PAY_YYYYMM
                                            , T1.SUPP_TYPE
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C1  THEN T1.AMOUNT_I ELSE 0 END) AS S1
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C2  THEN T1.AMOUNT_I ELSE 0 END) AS S2
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C3  THEN T1.AMOUNT_I ELSE 0 END) AS S3
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C4  THEN T1.AMOUNT_I ELSE 0 END) AS S4
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C5  THEN T1.AMOUNT_I ELSE 0 END) AS S5
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C6  THEN T1.AMOUNT_I ELSE 0 END) AS S6
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C7  THEN T1.AMOUNT_I ELSE 0 END) AS S7
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C8  THEN T1.AMOUNT_I ELSE 0 END) AS S8
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C9  THEN T1.AMOUNT_I ELSE 0 END) AS S9
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C10 THEN T1.AMOUNT_I ELSE 0 END) AS S10   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C11 THEN T1.AMOUNT_I ELSE 0 END) AS S11   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C12 THEN T1.AMOUNT_I ELSE 0 END) AS S12   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C13 THEN T1.AMOUNT_I ELSE 0 END) AS S13   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C14 THEN T1.AMOUNT_I ELSE 0 END) AS S14   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C15 THEN T1.AMOUNT_I ELSE 0 END) AS S15   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C16 THEN T1.AMOUNT_I ELSE 0 END) AS S16   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C17 THEN T1.AMOUNT_I ELSE 0 END) AS S17   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C18 THEN T1.AMOUNT_I ELSE 0 END) AS S18   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C19 THEN T1.AMOUNT_I ELSE 0 END) AS S19   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C20 THEN T1.AMOUNT_I ELSE 0 END) AS S20   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C21 THEN T1.AMOUNT_I ELSE 0 END) AS S21   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C22 THEN T1.AMOUNT_I ELSE 0 END) AS S22   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C23 THEN T1.AMOUNT_I ELSE 0 END) AS S23   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C24 THEN T1.AMOUNT_I ELSE 0 END) AS S24   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C25 THEN T1.AMOUNT_I ELSE 0 END) AS S25   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C26 THEN T1.AMOUNT_I ELSE 0 END) AS S26   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C27 THEN T1.AMOUNT_I ELSE 0 END) AS S27   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C28 THEN T1.AMOUNT_I ELSE 0 END) AS S28   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C29 THEN T1.AMOUNT_I ELSE 0 END) AS S29   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C30 THEN T1.AMOUNT_I ELSE 0 END) AS S30   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C31 THEN T1.AMOUNT_I ELSE 0 END) AS S31   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C32 THEN T1.AMOUNT_I ELSE 0 END) AS S32   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C33 THEN T1.AMOUNT_I ELSE 0 END) AS S33   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C34 THEN T1.AMOUNT_I ELSE 0 END) AS S34   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C35 THEN T1.AMOUNT_I ELSE 0 END) AS S35   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C36 THEN T1.AMOUNT_I ELSE 0 END) AS S36   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C37 THEN T1.AMOUNT_I ELSE 0 END) AS S37   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C38 THEN T1.AMOUNT_I ELSE 0 END) AS S38   
                                            , SUM(CASE WHEN T1.WAGES_CODE = T4.C39 THEN T1.AMOUNT_I ELSE 0 END) AS S39   
                                            , MAX(CASE WHEN T4.C40 = 'zzz'  THEN NVL(T5.ETC_AMT,0)   
                                                              ELSE (CASE WHEN T1.WAGES_CODE = T4.C40 THEN T1.AMOUNT_I ELSE 0 END) 
                                                      END)                                                         AS S40 
                                            , T1.COMP_CODE
                             FROM HPA300T T1
                             LEFT JOIN (
                                              SELECT PERSON_NUMB
                                                       , PAY_YYYYMM
                                                       , SUPP_TYPE
                                                       , SUM(AMOUNT_I) AS ETC_AMT 
                                                       , COMP_CODE
                                              FROM HPA300T
                                              WHERE COMP_CODE       = #{S_COMP_CODE}
                                              AND    SUPP_TYPE      LIKE #{SUPP_TYPE} + '%'
                                              AND    PAY_YYYYMM    &gt;= #{DATE_FR}
                                              AND    PAY_YYYYMM    &lt;= #{DATE_TO}
                                              AND    WAGES_CODE IN (SELECT WAGES_CODE FROM T_HPA950SKR_2   WHERE KEY_VALUE = @KeyValue AND W_SEQ &gt;= 30 )  
                                              GROUP BY PERSON_NUMB, PAY_YYYYMM, SUPP_TYPE, COMP_CODE
                                              ) T5 ON T5.COMP_CODE    = T1.COMP_CODE
                                                  AND T5.PERSON_NUMB = T1.PERSON_NUMB 
                                                  AND T5.PAY_YYYYMM   = T1.PAY_YYYYMM
                                                  AND T5.SUPP_TYPE       = T1.SUPP_TYPE 
                                          , (
                                               SELECT MAX(CASE WHEN W_SEQ = 1  THEN WAGES_CODE ELSE '' END) AS C1
                                                        , MAX(CASE WHEN W_SEQ = 2  THEN WAGES_CODE ELSE '' END) AS C2
                                                        , MAX(CASE WHEN W_SEQ = 3  THEN WAGES_CODE ELSE '' END) AS C3
                                                        , MAX(CASE WHEN W_SEQ = 4  THEN WAGES_CODE ELSE '' END) AS C4
                                                        , MAX(CASE WHEN W_SEQ = 5  THEN WAGES_CODE ELSE '' END) AS C5
                                                        , MAX(CASE WHEN W_SEQ = 6  THEN WAGES_CODE ELSE '' END) AS C6
                                                        , MAX(CASE WHEN W_SEQ = 7  THEN WAGES_CODE ELSE '' END) AS C7
                                                        , MAX(CASE WHEN W_SEQ = 8  THEN WAGES_CODE ELSE '' END) AS C8
                                                        , MAX(CASE WHEN W_SEQ = 9  THEN WAGES_CODE ELSE '' END) AS C9
                                                        , MAX(CASE WHEN W_SEQ = 10 THEN WAGES_CODE ELSE '' END) AS C10
                                                        , MAX(CASE WHEN W_SEQ = 11 THEN WAGES_CODE ELSE '' END) AS C11
                                                        , MAX(CASE WHEN W_SEQ = 12 THEN WAGES_CODE ELSE '' END) AS C12
                                                        , MAX(CASE WHEN W_SEQ = 13 THEN WAGES_CODE ELSE '' END) AS C13
                                                        , MAX(CASE WHEN W_SEQ = 14 THEN WAGES_CODE ELSE '' END) AS C14
                                                        , MAX(CASE WHEN W_SEQ = 15 THEN WAGES_CODE ELSE '' END) AS C15
                                                        , MAX(CASE WHEN W_SEQ = 16 THEN WAGES_CODE ELSE '' END) AS C16
                                                        , MAX(CASE WHEN W_SEQ = 17 THEN WAGES_CODE ELSE '' END) AS C17
                                                        , MAX(CASE WHEN W_SEQ = 18 THEN WAGES_CODE ELSE '' END) AS C18
                                                        , MAX(CASE WHEN W_SEQ = 19 THEN WAGES_CODE ELSE '' END) AS C19
                                                        , MAX(CASE WHEN W_SEQ = 20 THEN WAGES_CODE ELSE '' END) AS C20
                                                        , MAX(CASE WHEN W_SEQ = 21 THEN WAGES_CODE ELSE '' END) AS C21
                                                        , MAX(CASE WHEN W_SEQ = 22 THEN WAGES_CODE ELSE '' END) AS C22
                                                        , MAX(CASE WHEN W_SEQ = 23 THEN WAGES_CODE ELSE '' END) AS C23
                                                        , MAX(CASE WHEN W_SEQ = 24 THEN WAGES_CODE ELSE '' END) AS C24
                                                        , MAX(CASE WHEN W_SEQ = 25 THEN WAGES_CODE ELSE '' END) AS C25
                                                        , MAX(CASE WHEN W_SEQ = 26 THEN WAGES_CODE ELSE '' END) AS C26
                                                        , MAX(CASE WHEN W_SEQ = 27 THEN WAGES_CODE ELSE '' END) AS C27
                                                        , MAX(CASE WHEN W_SEQ = 28 THEN WAGES_CODE ELSE '' END) AS C28
                                                        , MAX(CASE WHEN W_SEQ = 29 THEN WAGES_CODE ELSE '' END) AS C29
                                                        , MAX(CASE WHEN W_SEQ = 30 THEN WAGES_CODE ELSE '' END) AS C30
                                                        , MAX(CASE WHEN W_SEQ = 31 THEN WAGES_CODE ELSE '' END) AS C31
                                                        , MAX(CASE WHEN W_SEQ = 32 THEN WAGES_CODE ELSE '' END) AS C32
                                                        , MAX(CASE WHEN W_SEQ = 33 THEN WAGES_CODE ELSE '' END) AS C33
                                                        , MAX(CASE WHEN W_SEQ = 34 THEN WAGES_CODE ELSE '' END) AS C34
                                                        , MAX(CASE WHEN W_SEQ = 35 THEN WAGES_CODE ELSE '' END) AS C35
                                                        , MAX(CASE WHEN W_SEQ = 36 THEN WAGES_CODE ELSE '' END) AS C36
                                                        , MAX(CASE WHEN W_SEQ = 37 THEN WAGES_CODE ELSE '' END) AS C37
                                                        , MAX(CASE WHEN W_SEQ = 38 THEN WAGES_CODE ELSE '' END) AS C38
                                                        , MAX(CASE WHEN W_SEQ = 39 THEN WAGES_CODE ELSE '' END) AS C39
                                                        , MAX(CASE WHEN W_SEQ &gt;= 40 THEN 'zzz'  
                                                                          ELSE (CASE WHEN W_SEQ = 40 THEN WAGES_CODE ELSE '' END) 
                                                                  END)  AS C40
                                                 FROM T_HPA950SKR_2 
                                                 WHERE KEY_VALUE = @KeyValue
                                             ) T4
                            WHERE T1.SUPP_TYPE      LIKE #{SUPP_TYPE} + '%'
                            AND    T1.PAY_YYYYMM    &gt;= #{DATE_FR}
                            AND    T1.PAY_YYYYMM    &lt;= #{DATE_TO}
                            AND    T1.COMP_CODE       = #{S_COMP_CODE}
                            GROUP BY T1.PERSON_NUMB,T1.PAY_YYYYMM, T1.SUPP_TYPE, T1.COMP_CODE
                            ) M2 ON M2.COMP_CODE    = M1.COMP_CODE
                                 AND M2.PERSON_NUMB = M1.PERSON_NUMB  
                                 AND M2.SUPP_TYPE       = M1.SUPP_TYPE   
                                 AND M2.PAY_YYYYMM   = M1.PAY_YYYYMM  
        LEFT  JOIN (
                                  SELECT   T1.PERSON_NUMB
                                             , T1.PAY_YYYYMM
                                             , T1.SUPP_TYPE 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D1  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D1 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D2  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D2 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D3  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D3
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D4  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D4 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D5  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D5 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D6  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D6 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D7  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D7 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D8  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D8
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D9  THEN T1.DED_AMOUNT_I ELSE 0 END) AS D9 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D10 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D10 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D11 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D11 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D12 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D12 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D13 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D13 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D14 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D14 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D15 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D15 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D16 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D16 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D17 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D17 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D18 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D18 
                                             , SUM(CASE WHEN T1.DED_CODE = T4.D19 THEN T1.DED_AMOUNT_I ELSE 0 END) AS D19 
                                             , MAX(CASE WHEN T4.D20 = 'zz' THEN NVL(T5.ETC_AMT,0)  
                                                               ELSE (CASE WHEN T1.DED_CODE = T4.D20 THEN T1.DED_AMOUNT_I ELSE 0 END) 
                                                       END )  AS D20 
                                             , T1.COMP_CODE 
                                  FROM HPA400T T1 
                                  LEFT JOIN (
                                               SELECT PERSON_NUMB
                                                        , PAY_YYYYMM
                                                        , SUPP_TYPE
                                                        , SUM(DED_AMOUNT_I) AS ETC_AMT 
                                                        , COMP_CODE
                                               FROM HPA400T
                                               WHERE COMP_CODE        = #{S_COMP_CODE}
                                               AND SUPP_TYPE          LIKE #{SUPP_TYPE} + '%'
                                               AND PAY_YYYYMM        &gt;= #{DATE_FR}
                                               AND PAY_YYYYMM        &lt;= #{DATE_TO}
                                               AND DED_CODE IN (SELECT SUB_CODE 
                                                                             FROM T_HPA950SKR_1
                                                                             WHERE KEY_VALUE = @KeyValue
                                                                             AND    SEQ &gt;= 20 
                                                                            ) 
                                               GROUP BY PERSON_NUMB, PAY_YYYYMM, SUPP_TYPE, COMP_CODE 
                                             ) T5 ON T5.COMP_CODE    = T1.COMP_CODE
                                                 AND T5.PERSON_NUMB = T1.PERSON_NUMB  
                                                 AND T5.PAY_YYYYMM   = T1.PAY_YYYYMM  
                                                 AND T5.SUPP_TYPE       = T1.SUPP_TYPE  
                                         , (
                                            SELECT MAX(CASE WHEN A.SEQ = 1  THEN A.SUB_CODE ELSE '' END) AS D1 
                                                     , MAX(CASE WHEN A.SEQ = 2  THEN A.SUB_CODE ELSE '' END) AS D2  
                                                     , MAX(CASE WHEN A.SEQ = 3  THEN A.SUB_CODE ELSE '' END) AS D3  
                                                     , MAX(CASE WHEN A.SEQ = 4  THEN A.SUB_CODE ELSE '' END) AS D4  
                                                     , MAX(CASE WHEN A.SEQ = 5  THEN A.SUB_CODE ELSE '' END) AS D5  
                                                     , MAX(CASE WHEN A.SEQ = 6  THEN A.SUB_CODE ELSE '' END) AS D6  
                                                     , MAX(CASE WHEN A.SEQ = 7  THEN A.SUB_CODE ELSE '' END) AS D7  
                                                     , MAX(CASE WHEN A.SEQ = 8  THEN A.SUB_CODE ELSE '' END) AS D8  
                                                     , MAX(CASE WHEN A.SEQ = 9  THEN A.SUB_CODE ELSE '' END) AS D9  
                                                     , MAX(CASE WHEN A.SEQ = 10 THEN A.SUB_CODE ELSE '' END) AS D10  
                                                     , MAX(CASE WHEN A.SEQ = 11 THEN A.SUB_CODE ELSE '' END) AS D11  
                                                     , MAX(CASE WHEN A.SEQ = 12 THEN A.SUB_CODE ELSE '' END) AS D12  
                                                     , MAX(CASE WHEN A.SEQ = 13 THEN A.SUB_CODE ELSE '' END) AS D13  
                                                     , MAX(CASE WHEN A.SEQ = 14 THEN A.SUB_CODE ELSE '' END) AS D14  
                                                     , MAX(CASE WHEN A.SEQ = 15 THEN A.SUB_CODE ELSE '' END) AS D15  
                                                     , MAX(CASE WHEN A.SEQ = 16 THEN A.SUB_CODE ELSE '' END) AS D16  
                                                     , MAX(CASE WHEN A.SEQ = 17 THEN A.SUB_CODE ELSE '' END) AS D17  
                                                     , MAX(CASE WHEN A.SEQ = 18 THEN A.SUB_CODE ELSE '' END) AS D18  
                                                     , MAX(CASE WHEN A.SEQ = 19 THEN A.SUB_CODE ELSE '' END) AS D19  
                                                     , MAX(CASE WHEN A.SEQ &gt;= 20 THEN 'zz' ELSE   CASE WHEN A.SEQ = 20 THEN A.SUB_CODE ELSE '' END END) AS D20 
                                           FROM T_HPA950SKR_1  A 
                                           WHERE A.KEY_VALUE = @KeyValue
                                          ) T4

                             WHERE T1.COMP_CODE         = #{S_COMP_CODE}
                             AND    T1.SUPP_TYPE        LIKE #{SUPP_TYPE} + '%'
                             AND    T1.PAY_YYYYMM      &gt;= #{DATE_FR}
                             AND    T1.PAY_YYYYMM      &lt;= #{DATE_TO}
                             GROUP BY T1.PERSON_NUMB, T1.PAY_YYYYMM, T1.SUPP_TYPE, T1.COMP_CODE
                           ) M3 ON M3.COMP_CODE    = M1.COMP_CODE
                                AND M3.PERSON_NUMB = M1.PERSON_NUMB 
                                AND M3.PAY_YYYYMM   = M1.PAY_YYYYMM  
                                AND M3.SUPP_TYPE       = M1.SUPP_TYPE   
                LEFT  JOIN CBM600T   M4 ON M4.COMP_CODE        = M1.COMP_CODE
                                       AND M4.COST_POOL_CODE   = M1.COST_KIND
                LEFT  JOIN BSA100T   M5 ON M5.COMP_CODE        = M0.COMP_CODE
                                       AND M5.MAIN_CODE        = 'H024'
                                       AND M5.SUB_CODE         = M0.EMPLOY_TYPE
                LEFT  JOIN BSA100T   M6 ON M6.COMP_CODE        = M1.COMP_CODE
                                       AND M6.MAIN_CODE        = 'H005'
                                       AND M6.SUB_CODE         = M1.POST_CODE
                LEFT  JOIN BSA100T   M7 ON M7.COMP_CODE        = M1.COMP_CODE
                                       AND M7.MAIN_CODE        = 'H006'
                                       AND M7.SUB_CODE         = M1.ABIL_CODE
                LEFT  JOIN BSA100T   M8 ON M8.COMP_CODE        = M1.COMP_CODE
                                       AND M8.MAIN_CODE        = 'H032'
                                       AND M8.SUB_CODE         = M1.SUPP_TYPE
                LEFT  JOIN BSA100T   M9 ON M9.COMP_CODE        = M0.COMP_CODE
                                       AND M9.MAIN_CODE        = 'GO01'
                                       AND M9.SUB_CODE         = M0.OFFICE_CODE
                LEFT  JOIN BSA100T   M10 ON M10.COMP_CODE      = M0.COMP_CODE
                                        AND M10.MAIN_CODE      = 'H024'
                                        AND M10.SUB_CODE       = M0.EMPLOY_TYPE
                LEFT  JOIN BSA100T   M11  ON M11.COMP_CODE     = M0.COMP_CODE
                                         AND M11.MAIN_CODE     = 'H028'
                                         AND M11.SUB_CODE      = M0.PAY_CODE
                LEFT  JOIN BOR120T   B  ON B.COMP_CODE         = M1.COMP_CODE
                                       AND B.DIV_CODE          = M1.DIV_CODE
         WHERE M1.COMP_CODE    = #{S_COMP_CODE}
           AND M1.PAY_YYYYMM  &gt;= #{DATE_FR}
           AND M1.PAY_YYYYMM  &lt;= #{DATE_TO}
    
        <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
            AND M1.DIV_CODE LIKE #{DIV_CODE} + '%'
        </if>
           
        <if test="@foren.Ognl@isNotEmpty(PERSON_NUMB)">
           AND  M1.PERSON_NUMB LIKE #{PERSON_NUMB} + '%'
        </if>
        <if test="@foren.Ognl@isNotEmpty(NAME)">
           AND  M0.NAME LIKE #{NAME} + '%'
        </if>
        
        <if test="@foren.Ognl@isNotEmpty(SUPP_TYPE)">
           AND  M1.SUPP_TYPE LIKE #{SUPP_TYPE} + '%'
        </if>
    
        <if test="@foren.Ognl@isNotEmpty(PAY_CODE)">
           AND M1.Pay_Code = #{PAY_CODE}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_DAY_FLAG)">
           AND M1.PAY_PROV_FLAG = #{PAY_DAY_FLAG}
        </if>
        <if test="@foren.Ognl@isNotEmpty(PAY_GUBUN)">
           AND M1.PAY_GUBUN = #{PAY_GUBUN}
        </if>
        <if test="@foren.Ognl@isNotEmpty(rdoSelect2)">
           AND M1.PAY_GUBUN2 = #{rdoSelect2}
        </if>
        <if test="rdoSelect1 == &quot;1&quot;">
           AND (M0.RETR_DATE = '00000000' OR M0.RETR_DATE IS NULL)
        </if>
        <if test="rdoSelect1 == &quot;2&quot;">
           AND (M0.RETR_DATE != '00000000' AND M0.RETR_DATE IS NOT NULL)
        </if>
         
        <if test="@foren.Ognl@isNotEmpty(PERSON_GROUP)">
           AND M5.REF_CODE1   = #{PERSON_GROUP}
        </if>
         
        <if test="@foren.Ognl@isNotEmpty(AFFILE_CODE)">
           AND M0.AFFIL_CODE  = #{AFFILE_CODE}
        </if>
        
        <if test="@foren.Ognl@isNotEmpty(SUPP_DATE_FR)">
           AND M1.SUPP_DATE &gt;= #{SUPP_DATE_FR}
        </if>
        
        <if test="@foren.Ognl@isNotEmpty(SUPP_DATE_TO)">
           AND M1.SUPP_DATE &lt;= #{SUPP_DATE_TO}
        </if>
        
        <if test="@foren.Ognl@isNotEmpty(MAKE_SALE)">
           AND M0.MAKE_SALE  = #{MAKE_SALE}
        </if>
        
        <if test="@foren.Ognl@isNotEmpty(BILL_DIV_CODE)">
           AND M1.SECT_CODE  = #{BILL_DIV_CODE}     -- 신고사업장 추가
        </if>
        
         ORDER BY M0.DIV_CODE, M0.DEPT_CODE, M0.POST_CODE, M0.JOIN_DATE, M0.NAME, M0.PERSON_NUMB, M1.PAY_YYYYMM, M1.SUPP_TYPE ;
        
        --  [ 4. 인원수 계산 ] ----------------------------------------------------------------------------------------------
    
            SET @Cnt = (
                                SELECT  COUNT(DISTINCT PERSON_NUMB)
                                FROM    T_HPA950SKR_5
                                WHERE   KEY_VALUE = @KeyValue
                                AND      GUBUN = '1'
                              );
            SET     @Cnt = NVL(@Cnt, 0);



        --  [ 5. 개인별 합계 INSERT ] ----------------------------------------------------------------------------------------------
            INSERT INTO T_HPA950SKR_5
                   (KEY_VALUE , GUBUN           , DIV_CODE      , DEPT_CODE         , NAME          , PERSON_NUMB
                  , SUPP_TOTAL_I    , DED_TOTAL_I   , REAL_AMOUNT_I     , BUSI_SHARE_I  , WORKER_COMPEN_I
                  , S1              , S2            , S3                , S4            , S5
                  , S6              , S7            , S8                , S9            , S10
                  , S11             , S12           , S13               , S14           , S15
                  , S16             , S17           , S18               , S19           , S20
                  , S21             , S22           , S23               , S24           , S25
                  , S26             , S27           , S28               , S29           , S30
                  , S31             , S32           , S33               , S34           , S35
                  , S36             , S37           , S38               , S39           , S40
          
                  , D1              , D2            , D3                , D4            , D5
                  , D6              , D7            , D8                , D9            , D10
                  , D11             , D12           , D13               , D14           , D15
                  , D16             , D17           , D18               , D19           , D20
                   )
            SELECT @KeyValue
                  , '2'                               AS GUBUN
                  , DIV_CODE                          AS DIV_CODE 
                  , DEPT_CODE                         AS DEPT_CODE
                  , MAX(fnGetTxt('H0118'))            AS NAME              -- 개인별 합계
                  , PERSON_NUMB                       AS PERSON_NUMB
                  , SUM(SUPP_TOTAL_I)                 AS SUPP_TOTAL_I
                  , SUM(DED_TOTAL_I)                  AS DED_TOTAL_I
                  , SUM(REAL_AMOUNT_I)                AS REAL_AMOUNT_I
                  , SUM(BUSI_SHARE_I)                 AS BUSI_SHARE_I
                  , SUM(WORKER_COMPEN_I)              AS WORKER_COMPEN_I
        
                  , SUM(S1)     , SUM(S2)       , SUM(S3)       , SUM(S4)       , SUM(S5)
                  , SUM(S6)     , SUM(S7)       , SUM(S8)       , SUM(S9)       , SUM(S10)
                  , SUM(S11)    , SUM(S12)      , SUM(S13)      , SUM(S14)      , SUM(S15)
                  , SUM(S16)    , SUM(S17)      , SUM(S18)      , SUM(S19)      , SUM(S20)
                  , SUM(S21)    , SUM(S22)      , SUM(S23)      , SUM(S24)      , SUM(S25)
                  , SUM(S26)    , SUM(S27)      , SUM(S28)      , SUM(S29)      , SUM(S30)
                  , SUM(S31)    , SUM(S32)      , SUM(S33)      , SUM(S34)      , SUM(S35)
                  , SUM(S36)    , SUM(S37)      , SUM(S38)      , SUM(S39)      , SUM(S40)
                  
                  , SUM(D1)     , SUM(D2)       , SUM(D3)       , SUM(D4)       , SUM(D5)
                  , SUM(D6)     , SUM(D7)       , SUM(D8)       , SUM(D9)       , SUM(D10)
                  , SUM(D11)    , SUM(D12)      , SUM(D13)      , SUM(D14)      , SUM(D15)
                  , SUM(D16)    , SUM(D17)      , SUM(D18)      , SUM(D19)      , SUM(D20)
             FROM    T_HPA950SKR_5
            WHERE   KEY_VALUE =  @KeyValue
            AND      GUBUN       = '1'
            GROUP BY PERSON_NUMB,DEPT_CODE, DIV_CODE
            HAVING (SUM(SUPP_TOTAL_I) != 0 OR SUM(DED_TOTAL_I) != 0 OR SUM(REAL_AMOUNT_I) != 0 )
            ORDER BY DEPT_CODE;
            
        --   6. 합계 INSERT  ----------------------------------------------------------------------------------------------
            INSERT INTO T_HPA950SKR_5
                   (KEY_VALUE, GUBUN           , DIV_CODE       , DEPT_CODE         , NAME
                  , SUPP_TOTAL_I    , DED_TOTAL_I   , REAL_AMOUNT_I     , BUSI_SHARE_I  , WORKER_COMPEN_I
                  , S1              , S2            , S3                , S4            , S5
                  , S6              , S7            , S8                , S9            , S10
                  , S11             , S12           , S13               , S14           , S15
                  , S16             , S17           , S18               , S19           , S20
                  , S21             , S22           , S23               , S24           , S25
                  , S26             , S27           , S28               , S29           , S30
                  , S31             , S32           , S33               , S34           , S35
                  , S36             , S37           , S38               , S39           , S40
          
                  , D1              , D2            , D3                , D4            , D5
                  , D6              , D7            , D8                , D9            , D10
                  , D11             , D12           , D13               , D14           , D15
                  , D16             , D17           , D18               , D19           , D20
                   )
            SELECT  @KeyValue  
                  , '3'                                             AS GUBUN
                  , fnGetTxt('A0194') + ' (' + TO_CHAR(@Cnt) + fnGetTxt('H0136') + ')' AS DIV_CODE        -- 총계 (xx명)
                  , '총계'                                            AS DEPT_CODE
                  , MAX(fnGetTxt('H0118'))                          AS NAME 
                  , SUM(SUPP_TOTAL_I)                               AS SUPP_TOTAL_I
                  , SUM(DED_TOTAL_I)                                AS DED_TOTAL_I
                  , SUM(REAL_AMOUNT_I)                              AS REAL_AMOUNT_I
                  , SUM(BUSI_SHARE_I)                               AS BUSI_SHARE_I
                  , SUM(WORKER_COMPEN_I)                            AS WORKER_COMPEN_I
        
                  , SUM(S1)     , SUM(S2)       , SUM(S3)       , SUM(S4)       , SUM(S5)
                  , SUM(S6)     , SUM(S7)       , SUM(S8)       , SUM(S9)       , SUM(S10)
                  , SUM(S11)    , SUM(S12)      , SUM(S13)      , SUM(S14)      , SUM(S15)
                  , SUM(S16)    , SUM(S17)      , SUM(S18)      , SUM(S19)      , SUM(S20)
                  , SUM(S21)    , SUM(S22)      , SUM(S23)      , SUM(S24)      , SUM(S25)
                  , SUM(S26)    , SUM(S27)      , SUM(S28)      , SUM(S29)      , SUM(S30)
                  , SUM(S31)    , SUM(S32)      , SUM(S33)      , SUM(S34)      , SUM(S35)
                  , SUM(S36)    , SUM(S37)      , SUM(S38)      , SUM(S39)      , SUM(S40)
                  
                  , SUM(D1)     , SUM(D2)       , SUM(D3)       , SUM(D4)       , SUM(D5)
                  , SUM(D6)     , SUM(D7)       , SUM(D8)       , SUM(D9)       , SUM(D10)
                  , SUM(D11)    , SUM(D12)      , SUM(D13)      , SUM(D14)      , SUM(D15)
                  , SUM(D16)    , SUM(D17)      , SUM(D18)      , SUM(D19)      , SUM(D20)
            FROM    T_HPA950SKR_5
            WHERE   KEY_VALUE = @KeyValue
            AND      GUBUN = '1'
            HAVING (SUM(SUPP_TOTAL_I) != 0 OR SUM(DED_TOTAL_I) != 0 OR SUM(REAL_AMOUNT_I) != 0);
        
        --  6. Main QUERY  ----------------------------------------------------------------------------------------------
             SELECT
                    GUBUN
                  , DIV_CODE
                  , DEPT_CODE
                  , DEPT_NAME
                  , POST_NAME
                  , NAME
                  , PERSON_NUMB
                  , JOIN_DATE
                  , PAY_YYYYMM
                  , SUPP_NAME
                  , SUPP_DATE
                  , SUPP_TYPE
                  , ABIL_NAME
        
                  , SUPP_TOTAL_I
                  , DED_TOTAL_I
                  , REAL_AMOUNT_I
                  , BUSI_SHARE_I
                  , WORKER_COMPEN_I
        
                  , S1          , S2            , S3            , S4            , S5
                  , S6          , S7            , S8            , S9            , S10
                  , S11         , S12           , S13           , S14           , S15
                  , S16         , S17           , S18           , S19           , S20
                  , S21         , S22           , S23           , S24           , S25
                  , S26         , S27           , S28           , S29           , S30
                  , S31         , S32           , S33           , S34           , S35
                  , S36         , S37           , S38           , S39           , S40
                  
                  , D1          , D2            , D3            , D4            , D5
                  , D6          , D7            , D8            , D9            , D10
                  , D11         , D12           , D13           , D14           , D15
                  , D16         , D17           , D18           , D19           , D20
        
                  , COST_POOL
                  , OFFICE_NAME
                  , SEX_NAME
                  , EMPLOY_TYPE
                  , PAY_CODE
             FROM    T_HPA950SKR_5
             WHERE  KEY_VALUE = @KeyValue
             
        <if test="CHECKBOX == &quot;N&quot;">
            AND GUBUN != '2'
        </if>
            ORDER BY DEPT_CODE, PERSON_NUMB, DOC_ID;

            DELETE FROM T_HPA950SKR_1 WHERE KEY_VALUE = @KeyValue;
            DELETE FROM T_HPA950SKR_2 WHERE KEY_VALUE = @KeyValue;          
            DELETE FROM T_HPA950SKR_3 WHERE KEY_VALUE = @KeyValue;                                      
            DELETE FROM T_HPA950SKR_5 WHERE KEY_VALUE = @KeyValue;

        </select>
    
</mapper>