<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_pmp110ukrv_ypServiceImpl">
	<select id="s_pmp110ukrv_ypServiceImpl.selectDetailList" parameterType="Map" resultType="rMap">
	/* pmp110ukrv.Cpmp110ukrv[fnPmp110QStd] Query02  Grid 조회 */
	BEGIN
		SET NOCOUNT ON
		SET ARITHABORT ON

		DECLARE   @CompCode	 NVARCHAR(08)		/* 법인코드			*/
				, @UserId	   NVARCHAR(100)		/* 사용자ID		*/
				, @LangType	 NVARCHAR(2)		/* 언어구분			*/
				, @RefItem	  NVARCHAR(01)		/* 명칭 참조 유형		*/
				, @DateFormat   NVARCHAR(10)	/* 날짜 포맷 유형 설정	*/

		SET @CompCode = #{S_COMP_CODE}
		SET @UserId   = #{S_USER_ID}
		SET @LangType = #{S_LANG_CODE}

		/* 명칭 참조 유형 */
		SELECT TOP 1 @RefItem = REF_ITEM
			FROM BSA300T WITH (NOLOCK)
			WHERE USER_ID = @UserId

		SET @RefItem = ISNULL(@RefItem, N'0')

		/* 날짜 포맷 유형 설정 */
		SELECT TOP 1 @DateFormat = CODE_NAME
			FROM BSA100T WITH (NOLOCK)
			WHERE COMP_CODE = @CompCode
			AND MAIN_CODE = N'B044'
			AND REF_CODE1 = N'Y'

		SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		/* 데이터 조회 */
		 SELECT A.SEQ
			  , A.TOP_WKORD_NUM
			  , A.LINE_SEQ
			  , A.PROG_WORK_CODE
			  , B.PROG_WORK_NAME
			  , unilite.fnformat(@CompCode, A.PROG_UNIT_Q, 'P_FSET_QS')	AS PROG_UNIT_Q
			  , unilite.fnformat(@CompCode, A.WKORD_Q, 'P_FSET_QS')		AS WKORD_Q
			  , A.PROG_UNIT
			  , A.DIV_CODE
			  , A.WKORD_NUM
			  , A.WORK_SHOP_CODE
			  , (CASE WHEN ISNULL(A.PRODT_WKORD_DATE, '') = ''
						THEN ''
						ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_WKORD_DATE, 1, 4))
																, 'MM'  , SUBSTRING(A.PRODT_WKORD_DATE, 5, 2))
																, 'DD'  , SUBSTRING(A.PRODT_WKORD_DATE, 7, 2))
				END)													AS PRODT_WKORD_DATE
			  , (CASE WHEN ISNULL(A.PRODT_START_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_START_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(A.PRODT_START_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(A.PRODT_START_DATE, 7, 2))
					END)												AS PRODT_START_DATE
			  , (CASE WHEN ISNULL(A.PRODT_END_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_END_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(A.PRODT_END_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(A.PRODT_END_DATE, 7, 2))
					END)												AS PRODT_END_DATE
			  , A.ITEM_CODE
			  , A.REMARK
			  , A.WK_PLAN_NUM
			  , A.LINE_END_YN
			  , CASE WHEN @RefItem = '0' THEN C.ITEM_NAME
					 WHEN @RefItem = '1' THEN C.ITEM_NAME1
					 WHEN @RefItem = '2' THEN C.ITEM_NAME2
					 ELSE					 C.ITEM_NAME
			   END														AS ITEM_NAME
			  , C.SPEC
			  , A.WORK_END_YN
			  , A.PROJECT_NO
			  , A.PJT_CODE
			  , A.LOT_NO
			  , A.REWORK_YN
			  , A.STOCK_EXCHG_TYPE
			  , CONVERT(NVARCHAR(10), A.UPDATE_DB_USER)					AS UPDATE_DB_USER
			  , CONVERT(NVARCHAR(20), A.UPDATE_DB_TIME)					AS UPDATE_DB_TIME
			  , A.COMP_CODE

			  , D.PACK_QTY
			  , CEILING(A.WKORD_Q / D.PACK_QTY)							AS LABEL_Q
			  , CEILING(A.WKORD_Q / D.PACK_QTY) *2						AS GR_LABEL_Q
			  , A.ORDER_NUM
			  , A.SER_NO

			  , F.ORDER_Q
			  , F.PREV_ORDER_Q
			  , F.DVRY_DATE
			  , G.ORDER_DATE
			  , G.CUSTOM_CODE
			  , G.ORDER_TYPE
			  , (CASE	WHEN @RefItem = '1' THEN H.CUSTOM_NAME1
						WHEN @RefItem = '2' THEN H.CUSTOM_NAME2
											ELSE H.CUSTOM_NAME
				END)													AS CUSTOM_NAME
			  , X.PRODT_YEAR
			  , X.EXP_DATE
			  , X.DETAIL_ITEM_CODE										AS DETAIL_ITEM_CODE
			  , X.BOM_UNIT_Q											AS BOM_UNIT_Q
			  , X.PROD_UNIT_Q
			  , ISNULL(X.PRODT_RATE, 100)								AS PRODT_RATE

		 FROM			   PMP100T A WITH(NOLOCK)
				LEFT JOIN (SELECT MAX(COMP_CODE)						AS COMP_CODE
							     , MAX(DIV_CODE)						AS DIV_CODE
							     , WKORD_NUM							AS WKORD_NUM
							     , MAX(PRODT_YEAR)						AS PRODT_YEAR
							     , MAX(EXP_DATE)						AS EXP_DATE
							     , MAX(CHILD_ITEM_CODE)					AS DETAIL_ITEM_CODE
							     , MAX(UNIT_Q)							AS BOM_UNIT_Q
							     , MAX(PROD_UNIT_Q)						AS PROD_UNIT_Q
							     , MAX(ISNULL(PRODT_RATE, 100))			AS PRODT_RATE
						      FROM PMP200T WITH(NOLOCK)
						  GROUP BY WKORD_NUM) X	  ON  X.COMP_CODE		= A.COMP_CODE
												  AND X.DIV_CODE		= A.DIV_CODE
												  AND X.WKORD_NUM		= A.WKORD_NUM
--				INNER JOIN PMP200T X WITH(NOLOCK) ON  X.COMP_CODE		= A.COMP_CODE
--												  AND X.DIV_CODE		= A.DIV_CODE
--												  AND X.WKORD_NUM		= A.WKORD_NUM
--												  AND X.ITEM_CODE		= A.ITEM_CODE
				INNER JOIN PBS200T B WITH(NOLOCK) ON  B.COMP_CODE		= A.COMP_CODE
												  AND B.DIV_CODE		= A.DIV_CODE
												  AND B.WORK_SHOP_CODE	= A.WORK_SHOP_CODE
												  AND B.PROG_WORK_CODE	= A.PROG_WORK_CODE
				INNER JOIN BPR100T C WITH(NOLOCK) ON  C.COMP_CODE		= A.COMP_CODE
												  AND C.ITEM_CODE		= A.ITEM_CODE
				INNER JOIN BPR200T D WITH(NOLOCK) ON  D.COMP_CODE		= A.COMP_CODE
												  AND D.DIV_CODE		= A.DIV_CODE
												  AND D.ITEM_CODE		= A.ITEM_CODE
				LEFT  JOIN SOF110T F WITH(NOLOCK) ON  F.COMP_CODE		= A.COMP_CODE
												  AND F.DIV_CODE		= A.DIV_CODE
												  AND F.ORDER_NUM		= A.ORDER_NUM
												  AND F.SER_NO			= A.SER_NO
				LEFT  JOIN SOF100T G WITH(NOLOCK) ON  G.COMP_CODE		= A.COMP_CODE
												  AND G.DIV_CODE		= A.DIV_CODE
												  AND G.ORDER_NUM		= A.ORDER_NUM
				LEFT  JOIN BCM100T H WITH(NOLOCK) ON  H.COMP_CODE		= G.COMP_CODE
												  AND H.CUSTOM_CODE		= G.CUSTOM_CODE
		 WHERE  A.COMP_CODE			= @CompCode
			AND A.WORK_SHOP_CODE	= #{WORK_SHOP_CODE}
			AND A.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
			AND A.PRODT_START_DATE	= #{PRODT_START_DATE}
			AND A.PRODT_END_DATE	= #{PRODT_END_DATE}
		 <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
			AND  A.DIV_CODE			= #{DIV_CODE}
		 </if>
		 <if test="@foren.Ognl@isNotEmpty(TOP_WKORD_NUM)">
			AND  A.TOP_WKORD_NUM	= #{TOP_WKORD_NUM}
		 </if>
		 <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
			AND  G.ORDER_TYPE		= #{ORDER_TYPE}
		 </if>

		  ORDER BY A.ITEM_CODE, A.TOP_WKORD_NUM, A.WKORD_NUM ASC

		  SET NOCOUNT OFF
		  SET ARITHABORT OFF
	END
	</select>

	<select id="s_pmp110ukrv_ypServiceImpl.selectS_PMP201T_YP" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.selectS_PMP201T_YP */
		SELECT A.COMP_CODE
			 , A.DIV_CODE
			 , A.TOP_WKORD_NUM
			 , A.REF_TYPE
			 , A.PATH_CODE
			 , A.ITEM_CODE
			 , B.ITEM_NAME
			 , B.SPEC
			 , B.STOCK_UNIT								AS PROG_UNIT
			 , SUM(A.ALLOCK_Q)							AS OUTSTOCK_REQ_Q
			 , A.LOT_NO
			 , A.LOT_NO									AS ORG_LOT_NO
			 , A.WH_CODE
			 , SUM(CEILING(X.WKORD_Q / C.PACK_QTY) * 2)	AS LABEL_Q
			 , A.ONHAND_Q
			 , A.PRODT_YEAR
			 , A.EXP_DATE
			 , C.LOT_YN
			 --, SUM(D.UNIT_Q * (X.WKORD_Q / D.PROD_UNIT_Q) / ISNULL(C.PRODT_RATE, 100) * 100)	AS UNIT_Q

		  FROM		 PMP200T A WITH(NOLOCK)
		  INNER JOIN PMP100T X WITH(NOLOCK) ON X.COMP_CODE			= A.COMP_CODE
										   AND X.WORK_SHOP_CODE		= #{WORK_SHOP_CODE}
										   AND X.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
										   AND X.PRODT_START_DATE	= #{PRODT_START_DATE}
										   AND X.PRODT_END_DATE		= #{PRODT_END_DATE}
		  INNER JOIN BPR100T B WITH(NOLOCK) ON B.COMP_CODE			= A.COMP_CODE
										   AND B.ITEM_CODE			= A.ITEM_CODE
		  INNER JOIN BPR200T C WITH(NOLOCK) ON C.COMP_CODE			= X.COMP_CODE
										   AND C.ITEM_CODE			= X.ITEM_CODE
										   AND C.DIV_CODE			= X.DIV_CODE
		   LEFT JOIN SOF100T G WITH(NOLOCK) ON G.COMP_CODE			= X.COMP_CODE
										   AND G.DIV_CODE			= X.DIV_CODE
										   AND G.ORDER_NUM			= X.ORDER_NUM
		 WHERE A.COMP_CODE		= #{S_COMP_CODE}
		   AND A.DIV_CODE		= #{DIV_CODE}
		   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}
		   AND A.WKORD_NUM		= X.WKORD_NUM
		   AND ISNULL(A.LOT_NO, '') != ''
		 <if test="@foren.Ognl@isNotEmpty(TOP_WKORD_NUM)">
		   AND A.TOP_WKORD_NUM	= #{TOP_WKORD_NUM}
		 </if>
		 <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
			AND  G.ORDER_TYPE		= #{ORDER_TYPE}
		 </if>
		 GROUP BY A.COMP_CODE, A.DIV_CODE, A.TOP_WKORD_NUM, A.REF_TYPE, A.PATH_CODE, A.ITEM_CODE, B.ITEM_NAME
				, B.SPEC, B.STOCK_UNIT, A.LOT_NO, A.WH_CODE, A.ONHAND_Q, A.PRODT_YEAR, A.EXP_DATE, C.LOT_YN
			--, A.LABEL_Q
	</select>

	<select id="s_pmp110ukrv_ypServiceImpl.selectPMP200T" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.selectPMP200T */
		SELECT A.COMP_CODE
			 , A.DIV_CODE
			 , A.TOP_WKORD_NUM
			 , A.WKORD_NUM
			 , A.REF_TYPE
			 , A.PATH_CODE
			 , A.ITEM_CODE
			 , B.ITEM_NAME
			 , B.SPEC
			 , B.STOCK_UNIT					AS PROG_UNIT
			 , A.ALLOCK_Q					AS OUTSTOCK_REQ_Q
			 , A.LOT_NO
			 , A.LOT_NO						AS ORG_LOT_NO
			 , A.WH_CODE
			 , 1							AS LABEL_Q
			 , A.ONHAND_Q
			 , A.SEQ
			 , A.PRODT_YEAR
			 , A.EXP_DATE
			 , C.LOT_YN
			 , A.CHILD_ITEM_CODE
			 , A.UNIT_Q						AS BOM_UNIT_Q
			 , A.PROD_UNIT_Q
			 , ISNULL(A.PRODT_RATE, 100)	AS PRODT_RATE
			 , A.ORDER_NUM
			 , A.SER_NO
			 , A.ALLOCK_Q					AS ORG_OUTSTOCK_REQ_Q
		  FROM		 PMP200T A WITH(NOLOCK)
		  INNER JOIN PMP100T X WITH(NOLOCK) ON X.COMP_CODE			= A.COMP_CODE
										   AND X.WORK_SHOP_CODE		= #{WORK_SHOP_CODE}
										   AND X.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
										   AND X.PRODT_START_DATE	= #{PRODT_START_DATE}
										   AND X.PRODT_END_DATE		= #{PRODT_END_DATE}
		  INNER JOIN BPR100T B WITH(NOLOCK) ON B.COMP_CODE			= A.COMP_CODE
										   AND B.ITEM_CODE			= A.ITEM_CODE
		  INNER JOIN BPR200T C WITH(NOLOCK) ON C.COMP_CODE			= A.COMP_CODE
										   AND C.ITEM_CODE			= A.ITEM_CODE
										   AND C.DIV_CODE			= A.DIV_CODE
		   LEFT JOIN SOF100T G WITH(NOLOCK) ON G.COMP_CODE			= X.COMP_CODE
										   AND G.DIV_CODE			= X.DIV_CODE
										   AND G.ORDER_NUM			= X.ORDER_NUM
		 WHERE A.COMP_CODE		= #{S_COMP_CODE}
		   AND A.DIV_CODE		= #{DIV_CODE}
		   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}
		   AND A.WKORD_NUM		= X.WKORD_NUM
		 <if test="@foren.Ognl@isNotEmpty(TOP_WKORD_NUM)">
		   AND A.TOP_WKORD_NUM	= #{TOP_WKORD_NUM}
		 </if>
		 <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
			AND  G.ORDER_TYPE		= #{ORDER_TYPE}
		 </if>
	</select>






	<!-- 공정코드 가져오는 로직 -->
	<select id="s_pmp110ukrv_ypServiceImpl.getProgWorkCode" parameterType="Map" resultType="rMap">
		DECLARE @PROG_WORK_CODE		NVARCHAR(08)
			  , @LINE_SEQ			NVARCHAR(03)

		SELECT @PROG_WORK_CODE	= PROG_WORK_CODE
			 , @LINE_SEQ			= LINE_SEQ
		  FROM PBS300T WITH(NOLOCK)
		 WHERE COMP_CODE		= #{S_COMP_CODE}
		   AND DIV_CODE			= #{DIV_CODE}
		   AND ITEM_CODE		= #{ITEM_CODE}
		   AND WORK_SHOP_CODE	= #{WORK_SHOP_CODE}

		IF (ISNULL(@PROG_WORK_CODE, '') = '')
		BEGIN
			SELECT @PROG_WORK_CODE = PROG_WORK_CODE
			  FROM PBS200T WITH(NOLOCK)
			 WHERE COMP_CODE		= #{S_COMP_CODE}
			   AND DIV_CODE			= #{DIV_CODE}
			   AND WORK_SHOP_CODE	= #{WORK_SHOP_CODE}
		END

		SELECT ISNULL(@PROG_WORK_CODE, '')	AS PROG_WORK_CODE
			 , ISNULL(@LINE_SEQ, '')		AS LINE_SEQ
	</select>

	<insert id="s_pmp110ukrv_ypServiceImpl.insertLogMaster" parameterType="Map">
		/*s_pmp110ukrv_ypServiceImpl.insertLogMaster*/
		INSERT INTO L_PMP100T_YP
			 ( KEY_VALUE
			 , OPR_FLAG
			 , SEQ
			 , COMP_CODE
			 , DIV_CODE
			 , PROG_WORK_CODE
			 , TOP_WKORD_NUM
			 , ITEM_CODE
			 , DETAIL_ITEM_CODE
			 , WKORD_Q
			 , WKORD_NUM
			 , WORK_SHOP_CODE
			 , PRODT_START_DATE
			 , PRODT_END_DATE
			 , PRODT_WKORD_DATE
			 , PROG_UNIT
			 , PROG_UNIT_Q
			 , REMARK
			 , LOT_NO
			 , LINE_SEQ
			 , LINE_END_YN
			 , ORDER_NUM
			 , SER_NO
			 , INSERT_DB_USER
			 , INSERT_DB_TIME
			 )
		VALUES
			 ( #{KEY_VALUE}
			 , #{OPR_FLAG}
			 , #{SEQ}
			 , #{S_COMP_CODE}
			 , #{DIV_CODE}
			 , #{PROG_WORK_CODE}
			 , #{TOP_WKORD_NUM}
			 , #{ITEM_CODE}
			 , #{DETAIL_ITEM_CODE}
			 , #{WKORD_Q}
			 , #{WKORD_NUM}
			 , #{WORK_SHOP_CODE}
			 , #{PRODT_START_DATE}
			 , #{PRODT_END_DATE}
			 , #{PRODT_WKORD_DATE}
			 , #{PROG_UNIT}
			 , #{PROG_UNIT_Q}
			 , #{REMARK}
			 , #{LOT_NO}
			 , #{LINE_SEQ}
			 , #{LINE_END_YN}
			 , #{ORDER_NUM}
			 , #{SER_NO}
			 , #{S_USER_ID}
			 , GETDATE()
			 )
	</insert>

	<insert id="s_pmp110ukrv_ypServiceImpl.insertLogDetail" parameterType="Map">
		/*s_pmp110ukrv_ypServiceImpl.insertLogDetail*/
		INSERT INTO L_PMP200T_YP		--L_PMP100T와 동일하게 생성 (단, SEQ, 라벨수량, 재고수량 추가: 최대한 단순하게 생성)
			 ( KEY_VALUE
			 , OPR_FLAG
			 , SEQ
			 , COMP_CODE
			 , DIV_CODE
			 , WORK_SHOP_CODE
			 , ITEM_CODE
			 , TOP_WKORD_NUM
			 , WKORD_NUM
			 , WKORD_Q
			 , LABEL_Q
			 , ONHAND_Q
			 , LOT_NO
			 , WH_CODE
			 , CHILD_ITEM_CODE
			 , PRODT_YEAR
			 , EXP_DATE
			 , UNIT_Q
			 , PRODT_RATE
			 , PROD_UNIT_Q
			 , ORG_LOT_NO
			 , ORDER_NUM
			 , SER_NO
			 , INSERT_DB_USER
			 , INSERT_DB_TIME
			 )
		VALUES
			 ( #{KEY_VALUE}
			 , #{OPR_FLAG}
			 , #{SEQ}
			 , #{COMP_CODE}
			 , #{DIV_CODE}
			 , #{WORK_SHOP_CODE}
			 , #{ITEM_CODE}
			 , #{TOP_WKORD_NUM}
			 , #{WKORD_NUM}
			 , #{OUTSTOCK_REQ_Q}
			 , #{LABEL_Q}
			 , #{ONHAND_Q}
			 , #{LOT_NO}
			 , #{WH_CODE}
			 , #{CHILD_ITEM_CODE}
			 , #{PRODT_YEAR}
			 , #{EXP_DATE}
			 , #{UNIT_Q}
			 , #{PRODT_RATE}
			 , #{PROD_UNIT_Q}
			 , #{ORG_LOT_NO}
			 , #{ORDER_NUM}
			 , #{SER_NO}
			 , #{S_USER_ID}
			 , GETDATE()
			 )
	</insert>

	<!--내부에서 SP_PRODT_WorkOrders_YP 호출 (체크로직만 넣어놓음 - 세부내용 확인 필요) -->
	<update id="s_pmp110ukrv_ypServiceImpl.USP_PRODT_PMP100UKR_YP" parameterType="Map" statementType="CALLABLE">
		{call USP_PRODT_PMP100UKR_YP (
			#{KeyValue		, mode=IN	, jdbcType=VARCHAR	, javaType=java.lang.String},
			#{USER_ID		, mode=IN	, jdbcType=VARCHAR	, javaType=java.lang.String},
			#{TOP_WKORD_NUM	, mode=OUT	, jdbcType=VARCHAR	, javaType=java.lang.String},
			#{ErrorDesc		, mode=OUT	, jdbcType=VARCHAR	, javaType=java.lang.String}
		)}
	</update>






	<!-- 작업지시조회 팝업 조회쿼리 (사용 안 함: 조회창 없이 무조건 조회 되도록 pg 변경 됨) -->
	<select id="s_pmp110ukrv_ypServiceImpl.selectWorkNum" parameterType="Map" resultType="rMap">
	/* uniLITE5Popup.CPopup[fnGetWkordNum] Query01   조회창  */
	BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE   @CompCode	 NVARCHAR(08) /* 법인코드		  */
					, @UserId	   NVARCHAR(100) /* 사용자ID		 */
					, @LangType	 NVARCHAR(2)  /* 언어구분		  */
					, @RefItem	  NVARCHAR(01) /* 명칭 참조 유형	  */
					, @DateFormat   NVARCHAR(10) /* 날짜 포맷 유형 설정	 */

			SET @CompCode = #{S_COMP_CODE}
			SET @UserId   = #{S_USER_ID}
			SET @LangType = #{S_LANG_CODE}

			/* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
				FROM BSA300T WITH (NOLOCK)
				WHERE USER_ID = @UserId

			SET @RefItem = ISNULL(@RefItem, N'0')

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
				FROM BSA100T WITH (NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND MAIN_CODE = N'B044'
				AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

			/* 데이터 조회 */

		SELECT TOP 1 @RefItem = REF_ITEM
		FROM   BSA300T WITH (NOLOCK)
		WHERE  COMP_CODE = @CompCode
		AND	USER_ID   = @UserId

		SET @RefItem = ISNULL(@RefItem, N'0')

		SELECT A.TOP_WKORD_NUM
			 , A.WKORD_NUM
			 , A.ITEM_CODE
			 , CASE WHEN @RefItem = '0' THEN C1.ITEM_NAME
					WHEN @RefItem = '1' THEN C1.ITEM_NAME1
					WHEN @RefItem = '2' THEN C1.ITEM_NAME2
					ELSE					 C1.ITEM_NAME
			   END														 AS ITEM_NAME
			 , C1.SPEC
			 , (CASE WHEN ISNULL(A.PRODT_WKORD_DATE, '') = ''
					 THEN ''
					 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_WKORD_DATE, 1, 4))
															 , 'MM'  , SUBSTRING(A.PRODT_WKORD_DATE, 5, 2))
															 , 'DD'  , SUBSTRING(A.PRODT_WKORD_DATE, 7, 2))
				END)													   AS PRODT_WKORD_DATE
			 , (CASE WHEN ISNULL(A.PRODT_START_DATE, '') = ''
					 THEN ''
					 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_START_DATE, 1, 4))
															 , 'MM'  , SUBSTRING(A.PRODT_START_DATE, 5, 2))
															 , 'DD'  , SUBSTRING(A.PRODT_START_DATE, 7, 2))
				END)													  AS PRODT_START_DATE
			 , (CASE WHEN ISNULL(A.PRODT_END_DATE, '') = ''
					 THEN ''
					 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_END_DATE, 1, 4))
															 , 'MM'  , SUBSTRING(A.PRODT_END_DATE, 5, 2))
															 , 'DD'  , SUBSTRING(A.PRODT_END_DATE, 7, 2))
				END)													  AS PRODT_END_DATE
			 , CASE WHEN ISNULL(A.PROG_UNIT_Q, 0) = 0 THEN 0
					ELSE ISNULL(A.WKORD_Q, 0) / ISNULL(A.PROG_UNIT_Q, 0)
			   END														AS WKORD_Q
			 , A.WK_PLAN_NUM
			 , A.DIV_CODE
			 , A.WORK_SHOP_CODE
			 , B.ORDER_NUM
			 , ISNULL(B.ORDER_Q, 0)									   AS ORDER_Q
			 , A.REMARK
			 , ISNULL(A.PRODT_Q, 0)									   AS PRODT_Q
			 , (CASE WHEN ISNULL(C.DVRY_DATE, '') = ''
					 THEN ''
					 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(C.DVRY_DATE, 1, 4))
															 , 'MM'  , SUBSTRING(C.DVRY_DATE, 5, 2))
															 , 'DD'  , SUBSTRING(C.DVRY_DATE, 7, 2))
				END)													  AS DVRY_DATE
			 , C1.STOCK_UNIT
			 , A.PROJECT_NO
			 , A.PJT_CODE
			 , A.LOT_NO
			 , A.REWORK_YN
			 , A.STOCK_EXCHG_TYPE
			 , B.REMARK  AS CUSTOM
		FROM			  PMP100T A  WITH (NOLOCK)
			   LEFT  JOIN PPL100T B  WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
												  AND B.DIV_CODE	= A.DIV_CODE
												  AND B.WK_PLAN_NUM = A.WK_PLAN_NUM
			   LEFT  JOIN SOF110T C  WITH (NOLOCK) ON C.COMP_CODE   = B.COMP_CODE
												  AND C.DIV_CODE	= B.DIV_CODE
												  AND C.ORDER_NUM   = B.ORDER_NUM
												  AND C.SER_NO	  = B.SEQ
			   INNER JOIN BPR100T C1 WITH (NOLOCK) ON C1.COMP_CODE  = A.COMP_CODE
												  AND C1.ITEM_CODE  = A.ITEM_CODE
		WHERE  A.COMP_CODE		 = @CompCode
		  AND  LINE_END_YN		 = 'Y'
		<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
			AND  A.DIV_CODE	  = #{DIV_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(WKORD_NUM)">
			AND  A.WKORD_NUM	  = #{WKORD_NUM}
		</if>
		<if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
			AND A.ITEM_CODE	  LIKE #{ITEM_CODE} +  '%'	   /*품목코드*/
		</if>
		<if test="@foren.Ognl@isNotEmpty(FR_PRODT_DATE)">
		AND	 A.PRODT_START_DATE &gt;=#{FR_PRODT_DATE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(TO_PRODT_DATE)">
		AND	 A.PRODT_START_DATE &lt;= #{TO_PRODT_DATE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(WORK_SHOP_CODE)">
		AND	 A.WORK_SHOP_CODE	 = #{WORK_SHOP_CODE}
		</if>

		<if test="@foren.Ognl@isNotEmpty(ITEM_NAME)">
		AND (CASE WHEN @RefItem = '1' THEN C1.ITEM_NAME1
				  WHEN @RefItem = '2' THEN C1.ITEM_NAME2
									  ELSE C1.ITEM_NAME
			  END)			 LIKE #{ITEM_NAME} + '%'
		</if>
		<if test="@foren.Ognl@isNotEmpty(LOT_NO)">
			AND  A.LOT_NO	  = #{LOT_NO}
		</if>

		ORDER BY A.WKORD_NUM

		SET NOCOUNT OFF
		SET ARITHABORT OFF
	END
	</select>



	<!-- 수주정보 참조 -->
	<select id="s_pmp110ukrv_ypServiceImpl.selectSalesOrderList" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.selectSalesOrderList */
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE   @CompCode	NVARCHAR(08)/* 법인코드	*/
					, @UserId	  NVARCHAR(100)/* 사용자ID	*/
					, @LangType	NVARCHAR(2) /* 언어구분	*/
					, @RefItem	 NVARCHAR(01)/* 명칭 참조 유형  */
					, @DateFormat  NVARCHAR(10)/* 날짜 포맷 유형 설정 */
					, @TimeSI	  NVARCHAR(01)
					, @TimeSR	  NVARCHAR(01)
					, @TimeSS	  NVARCHAR(01)

			SELECT @TimeSI = MAX(CASE WHEN SUB_CODE = 'SI' THEN REF_CODE1 ELSE '' END)
				 , @TimeSR = MAX(CASE WHEN SUB_CODE = 'SR' THEN REF_CODE1 ELSE '' END)
				 , @TimeSS = MAX(CASE WHEN SUB_CODE = 'SS' THEN REF_CODE1 ELSE '' END)
			 FROM BSA100T
			WHERE COMP_CODE = @CompCode
			  AND MAIN_CODE = N'S048'
			  AND SUB_CODE IN(N'SI', N'SR', N'SS')

			IF @TimeSI IS NULL
				SET @TimeSI = 'N'
			IF @TimeSR IS NULL
				SET @TimeSR = 'N'
			IF @TimeSS IS NULL
				SET @TimeSS = 'N'

			SET @CompCode = #{S_COMP_CODE}
			SET @UserId   = #{S_USER_ID}
			SET @LangType = #{S_LANG_CODE}

			/* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
			  FROM BSA300T WITH(NOLOCK)
			 WHERE USER_ID = @UserId

			SET @RefItem = ISNULL(@RefItem, N'0')

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
			  FROM BSA100T WITH(NOLOCK)
			 WHERE COMP_CODE = @CompCode
			   AND MAIN_CODE = N'B044'
			   AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

			SELECT
				  CAST(0 AS BIT)AS CHOICE
				, A.COMP_CODE
				, 'SALES'														AS FLAG
				, A.ORDER_NUM
				, A.SER_NO
				, A.SO_KIND
				, ISNULL(C4.REF_CODE2,'')										AS INOUT_TYPE_DETAIL
				, A.ITEM_CODE
				, (CASE WHEN @RefItem = '1' THEN C2.ITEM_NAME1
						WHEN @RefItem = '2' THEN C2.ITEM_NAME2
											ELSE C2.ITEM_NAME
					END)														AS ITEM_NAME
				, C2.SPEC
				, A.ORDER_UNIT
				, A.TRANS_RATE
				,(CASE WHEN ISNULL(A.DVRY_DATE , '')= ''
					   THEN ''
					   ELSE REPLACE(REPLACE(REPLACE(@DateFormat , 'YYYY' , SUBSTRING(A.DVRY_DATE, 1, 4))
																, 'MM'   , SUBSTRING(A.DVRY_DATE, 5, 2))
																, 'DD'   , SUBSTRING(A.DVRY_DATE, 7, 2))
				END)+ RTRIM(' ' + CASE @TimeSS WHEN 'Y' THEN ISNULL(A.DVRY_DATE,'')
												ELSE ''
									END)										AS DVRY_DATE
				,(A.ORDER_Q + A.RETURN_Q - A.OUTSTOCK_Q
				  - (ISNULL(SUM(C.ISSUE_REQ_QTY - C.ISSUE_QTY), 0)))			AS NOT_INOUT_Q
				, A.ORDER_Q
				, A.PREV_ORDER_Q
				, A.ISSUE_REQ_Q
				, A.ORDER_WGT_Q
				, A.ORDER_VOL_Q
				, ISNULL(A.PROJECT_NO, B.PROJECT_NO)							AS PROJECT_NO
				, (CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
						WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
											ELSE C1.CUSTOM_NAME
					END)														AS CUSTOM_NAME
				, A.PO_NUM
				, CONVERT(NVARCHAR, '')											AS PAY_METHODE1
				, CONVERT(NVARCHAR, '')											AS LC_SER_NO
				, B.CUSTOM_CODE
				, CONVERT(NVARCHAR, A.OUT_DIV_CODE)								AS OUT_DIV_CODE
				, A.ORDER_P
				, A.ORDER_O
				, A.TAX_TYPE
				, A.TEMPC_01													AS WH_CODE
				, B.MONEY_UNIT
				, B.EXCHG_RATE_O
				, A.ACCOUNT_YNC
				, A.DISCOUNT_RATE
				, B.ORDER_PRSN													AS ORDER_PRSN
				, A.DVRY_CUST_CD
				, A.SALE_CUST_CD
				,(SELECT CUSTOM_NAME
					FROM BCM100T WITH(NOLOCK)
					WHERE COMP_CODE   = A.COMP_CODE
					AND CUSTOM_CODE = A.SALE_CUST_CD)							AS SALE_CUST_NM
				, B.BILL_TYPE
				, B.ORDER_TYPE
				, A.PRICE_YN
				, A.PO_SEQ
				, C1.CREDIT_YN
				, ISNULL(C1.WON_CALC_BAS , '3')									AS WON_CALC_BAS
				, B.TAX_INOUT
				, B.AGENT_TYPE
				, ISNULL(C2.STOCK_CARE_YN, 'Y')									AS STOCK_CARE_YN
				, C2.STOCK_UNIT
				,(SELECT DVRY_CUST_NM
					FROM SCM100T WITH(NOLOCK)
					WHERE COMP_CODE   = A.COMP_CODE
					AND CUSTOM_CODE = B.CUSTOM_CODE
					AND CAST(DVRY_CUST_SEQ AS NVARCHAR(8))= A.DVRY_CUST_CD)		AS DVRY_CUST_NAME
				,(CASE A.RETURN_Q
						WHEN 0
							THEN 'N'
							ELSE(CASE(A.RETURN_Q / ABS(A.RETURN_Q))
										WHEN -1
											THEN 'N'
										WHEN 0
											THEN 'N'
											ELSE 'Y'
									END)
					END)														AS RETURN_Q_YN
				, A.DIV_CODE													/* 영업담당의 사업장 */
				, A.ORDER_TAX_O													/* 세액 */
				,(SELECT ISNULL(EXCESS_RATE,0)
					FROM BPR100T WITH(NOLOCK)
					WHERE COMP_CODE = A.COMP_CODE
					AND ITEM_CODE = A.ITEM_CODE)								AS EXCESS_RATE
				, B.DEPT_CODE
				, C3.ITEM_ACCOUNT
				, ISNULL(C5.GOOD_STOCK_Q, 0)									AS STOCK_Q
				, A.REMARK
				, A.PRICE_TYPE
				, A.ORDER_WGT_P													AS ORDER_FOR_WGT_P
				, A.ORDER_VOL_P													AS ORDER_FOR_VOL_P
				, A.ORDER_WGT_P * B.EXCHG_RATE_O								AS ORDER_WGT_P
				, A.ORDER_VOL_P * B.EXCHG_RATE_O								AS ORDER_VOL_P
				, A.WGT_UNIT
				, A.UNIT_WGT
				, A.VOL_UNIT
				, A.UNIT_VOL
				, C3.LOT_YN
				, B.NATION_INOUT
				, A.PROD_END_DATE
				, C6.CHILD_ITEM_CODE
				, (CASE WHEN @RefItem = '1' THEN C7.ITEM_NAME1
						WHEN @RefItem = '2' THEN C7.ITEM_NAME2
											ELSE C7.ITEM_NAME
					END)														AS CHILD_ITEM_NAME
				, B.ORDER_DATE

				, C6.UNIT_Q														AS BOM_UNIT_Q
				, C6.PROD_UNIT_Q
				, ISNULL(C3.PRODT_RATE, 100)									AS PRODT_RATE
			FROM		   SOF110T A  WITH(NOLOCK)
				INNER JOIN SOF100T B  WITH(NOLOCK)   ON B.COMP_CODE			= A.COMP_CODE
													AND B.DIV_CODE			= A.DIV_CODE
													AND B.ORDER_NUM			= A.ORDER_NUM
				LEFT  JOIN SRQ100T C  WITH(NOLOCK)   ON C.COMP_CODE			= A.COMP_CODE
													AND C.ISSUE_DIV_CODE	= A.OUT_DIV_CODE
													AND C.ORDER_NUM			= A.ORDER_NUM
													AND C.SER_NO			= A.SER_NO
				INNER JOIN BCM100T C1 WITH(NOLOCK)  ON  C1.COMP_CODE		= B.COMP_CODE
													AND C1.CUSTOM_CODE		= B.CUSTOM_CODE
				INNER JOIN BPR100T C2 WITH(NOLOCK)   ON C2.COMP_CODE		= A.COMP_CODE
													AND C2.ITEM_CODE		= A.ITEM_CODE
				INNER JOIN BPR200T C3 WITH(NOLOCK)   ON C3.COMP_CODE		= A.COMP_CODE
													AND C3.DIV_CODE			= A.DIV_CODE
													AND C3.ITEM_CODE		= A.ITEM_CODE
				LEFT  JOIN BSA100T C4 WITH(NOLOCK)   ON C4.COMP_CODE		= A.COMP_CODE
													AND C4.MAIN_CODE		= 'S065'
													AND C4.SUB_CODE			= A.SO_KIND
				LEFT  JOIN BIV100T C5 WITH(NOLOCK)   ON C5.COMP_CODE		= A.COMP_CODE
													AND C5.DIV_CODE			= A.DIV_CODE
													AND C5.WH_CODE			= C3.WH_CODE
													AND C5.ITEM_CODE		= A.ITEM_CODE
				LEFT  JOIN BPR500T C6 WITH(NOLOCK)   ON C6.COMP_CODE		= A.COMP_CODE
													AND C6.DIV_CODE			= A.DIV_CODE
													AND C6.PROD_ITEM_CODE	= A.ITEM_CODE
													AND C6.CHILD_ITEM_CODE != '$'
													AND C6.PATH_CODE		= '0'
													AND A.PROD_END_DATE BETWEEN C6.START_DATE AND C6.STOP_DATE
				LEFT  JOIN BPR100T C7 WITH(NOLOCK)   ON C7.COMP_CODE		= C6.COMP_CODE
													AND C7.ITEM_CODE		= C6.CHILD_ITEM_CODE
				LEFT  JOIN PMP100T Z  WITH(NOLOCK)   ON Z.COMP_CODE			= A.COMP_CODE
													AND Z.DIV_CODE			= A.DIV_CODE
													AND Z.ORDER_NUM			= A.ORDER_NUM
													AND Z.SER_NO			= A.SER_NO
				LEFT JOIN S_PMP111T_YP Z1 WITH(NOLOCK) ON Z1.COMP_CODE		= A.COMP_CODE
													AND Z1.DIV_CODE			= A.DIV_CODE
													AND Z1.ORDER_NUM		= A.ORDER_NUM
													AND Z1.SER_NO			= A.SER_NO

			WHERE A.COMP_CODE			= @CompCode
			  AND A.ORDER_STATUS		= 'N'							/* 미마감인 건만 조회 */
			  AND ISNULL(B.STATUS,'6')	= '6'							/* 승인완결여부 */
--			  AND C3.SUPPLY_TYPE		= '2'							/* 사내가공 (1:구매, 3:외주) */
			<if test="@foren.Ognl@isNotEmpty(MONEY_UNIT)">
			  AND B.MONEY_UNIT			= #{MONEY_UNIT}					/*마스터폼 정보*/
			</if>
			<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
			  AND A.OUT_DIV_CODE		= #{DIV_CODE}					/*마스터폼 정보*/
			</if>

			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
			   AND B.CUSTOM_CODE = #{CUSTOM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
			   AND (B.CUSTOM_CODE LIKE #{CUSTOM_CODE} + '%'
				   OR C1.CUSTOM_NAME LIKE #{CUSTOM_CODE} + '%')
			</if>
			<if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME) and @foren.Ognl@isEmpty(CUSTOM_CODE)">
			   AND (B.CUSTOM_CODE LIKE #{CUSTOM_NAME} + '%'
				   OR C1.CUSTOM_NAME LIKE #{CUSTOM_NAME} + '%')
			</if>

			<if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
			   AND A.ITEM_CODE	= #{ITEM_CODE}
			</if>
			<if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
			   AND (A.ITEM_CODE	LIKE #{ITEM_CODE} + '%'
				   OR C2.ITEM_NAME LIKE #{ITEM_CODE} + '%')
			</if>
			<if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
			   AND (A.ITEM_CODE	LIKE #{ITEM_NAME} + '%'
				   OR C2.ITEM_NAME LIKE #{ITEM_NAME} + '%')
			</if>

			<if test="@foren.Ognl@isNotEmpty(PROD_END_DATE_FR)">
			  AND A.PROD_END_DATE	&gt;= #{PROD_END_DATE_FR}
			</if>
			<if test="@foren.Ognl@isNotEmpty(PROD_END_DATE_TO)">
			  AND A.PROD_END_DATE	&lt;= #{PROD_END_DATE_TO}
			</if>
			<if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
			  AND A.ORDER_NUM		LIKE #{ORDER_NUM} + '%'
			</if>
			<if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
			  AND A.PROJECT_NO		LIKE #{PROJECT_NO} + '%'
			</if>
			<if test="@foren.Ognl@isNotEmpty(NATION_INOUT)">
			  AND B.NATION_INOUT		= #{NATION_INOUT}
			</if>
			<if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
			  AND B.ORDER_TYPE  LIKE #{ORDER_TYPE} + '%'
			</if>
			<if test="@foren.Ognl@isNotEmpty(SUPPLY_TYPE)">
			  AND C3.SUPPLY_TYPE		 = #{SUPPLY_TYPE}
			</if>

			AND ( Z.ORDER_NUM IS NULL AND Z1.ORDER_NUM IS NULL)	--기 등록된 데이터는 조회되지 않음(작업지시, 구매품작업지시 모두 확인)


			GROUP BY  A.ORDER_NUM		, A.SER_NO			, C1.CUSTOM_NAME	, B.CUSTOM_CODE		, A.ITEM_CODE
					, C2.ITEM_NAME		, C2.SPEC			, A.ORDER_UNIT		, A.TRANS_RATE		, A.DVRY_DATE
					, A.ORDER_Q			, A.RETURN_Q		, A.OUTSTOCK_Q		, A.ISSUE_REQ_Q		, A.PROJECT_NO
					, A.PO_NUM			, A.OUT_DIV_CODE	, A.ORDER_P			, A.ORDER_O	 		, A.TAX_TYPE
					, B.MONEY_UNIT		, B.EXCHG_RATE_O	, A.ACCOUNT_YNC		, A.DISCOUNT_RATE	, B.PROJECT_NO
					, A.DVRY_CUST_CD	, A.SALE_CUST_CD	, B.BILL_TYPE		, B.ORDER_TYPE		, A.PRICE_YN
					, A.PO_SEQ			, C1.CREDIT_YN		, C1.WON_CALC_BAS	, B.TAX_INOUT		, B.AGENT_TYPE
					, C2.STOCK_CARE_YN	, C2.STOCK_UNIT		, A.DIV_CODE		, A.ORDER_STATUS	, A.ORDER_TAX_O
					, A.COMP_CODE		, A.DVRY_TIME		, B.DEPT_CODE		, B.ORDER_PRSN		, C3.ITEM_ACCOUNT
					, C5.GOOD_STOCK_Q	, A.REMARK			, A.ORDER_WGT_Q		, A.ORDER_VOL_Q		, A.PRICE_TYPE
					, A.PRICE_TYPE		, A.ORDER_WGT_P		, A.ORDER_VOL_P		, A.WGT_UNIT		, A.SO_KIND			, C4.REF_CODE2
					, A.UNIT_WGT		, A.UNIT_WGT		, A.VOL_UNIT		, A.UNIT_VOL		, C1.CUSTOM_NAME1
					, C1.CUSTOM_NAME2	, C2.ITEM_NAME1		, C2.ITEM_NAME2		, A.TEMPC_01		, C3.LOT_YN
					, B.NATION_INOUT	, A.PROD_END_DATE	, C6.CHILD_ITEM_CODE
					, C7.ITEM_NAME		, C7.ITEM_NAME1		, C7.ITEM_NAME2		, A.PREV_ORDER_Q
					, B.ORDER_DATE		, C6.UNIT_Q			, C6.PROD_UNIT_Q	, C3.PRODT_RATE
			--HAVING A.ORDER_Q + A.RETURN_Q - A.OUTSTOCK_Q  - (ISNULL(SUM(C.ISSUE_REQ_QTY - C.ISSUE_QTY), 0)) &gt; 0
			HAVING A.ORDER_Q + A.RETURN_Q - A.OUTSTOCK_Q  &gt; 0
			ORDER BY C2.ITEM_NAME, C2.ITEM_NAME1, C2.ITEM_NAME2, A.ORDER_NUM, A.SER_NO, C1.CUSTOM_NAME, B.ORDER_PRSN, A.ITEM_CODE, A.DVRY_DATE

			SET NOCOUNT OFF
			SET ARITHABORT OFF
		END
	</select>



	<!-- 공정정보 조회 -->
	<select id="s_pmp110ukrv_ypServiceImpl.selectProgInfo" parameterType="Map" resultType="rMap">
	/* pmp110ukrv.Cpmp110ukrv[fnProgInfo] Query   */
		DECLARE @COMP_CODE			NVARCHAR(08)
			  , @DIV_CODE			NVARCHAR(08)
			  , @WORK_SHOP_CODE		NVARCHAR(08)
			  , @ITEM_CODE			NVARCHAR(20)

		SET	 @COMP_CODE			= #{S_COMP_CODE}
		SET	 @DIV_CODE			= #{DIV_CODE}
		SET	 @WORK_SHOP_CODE	= #{WORK_SHOP_CODE}
		SET	 @ITEM_CODE			= #{ITEM_CODE}

		SELECT A.DIV_CODE
			 , A.ITEM_CODE
			 , A.LINE_SEQ
			 , A.PROG_WORK_CODE
			 , B.PROG_WORK_NAME
			 , unilite.fnFormat(@COMP_CODE, ISNULL(A.PROG_UNIT_Q, 1), 'P_FSET_QS') AS PROG_UNIT_Q
			 , ISNULL(A.PROG_UNIT,'') AS PROG_UNIT
		FROM			  PBS300T A WITH(NOLOCK)
			   INNER JOIN PBS200T B WITH(NOLOCK) ON  B.COMP_CODE		= A.COMP_CODE
												 AND B.DIV_CODE			= A.DIV_CODE
												 AND B.PROG_WORK_CODE	= A.PROG_WORK_CODE
												 AND B.WORK_SHOP_CODE	= A.WORK_SHOP_CODE
		WHERE  A.COMP_CODE		= @COMP_CODE
		  AND  ((A.DIV_CODE		= @DIV_CODE			AND @DIV_CODE != '')		OR (@DIV_CODE		= ''))
		  AND  ((B.WORK_SHOP_CODE = @WORK_SHOP_CODE	AND @WORK_SHOP_CODE	!= '')	OR (@WORK_SHOP_CODE	= ''))
		  AND  ((A.ITEM_CODE	  = @ITEM_CODE		AND @ITEM_CODE		!= '')	OR (@ITEM_CODE		= ''))
		ORDER BY LINE_SEQ ASC
	</select>



	<!-- 신규 / 수주참조 시, PMP200T 조회 -->
	<select id="s_pmp110ukrv_ypServiceImpl.getPMP200T" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.getPMP200T */
		SELECT A.COMP_CODE
			 , A.DIV_CODE
			 , A.PATH_CODE
			 , A.PROD_ITEM_CODE																			AS MASTER_ITEM_CODE
			 , A.CHILD_ITEM_CODE																		AS ITEM_CODE
			 , B.ITEM_NAME
			 , B.SPEC
			 , A.UNIT_Q * (#{WKORD_Q} / A.PROD_UNIT_Q) * (1+(100 - ISNULL(D.PRODT_RATE, 100)) /100) 	AS OUTSTOCK_REQ_Q
			 , A.PROD_UNIT_Q
			 , ISNULL(D.PRODT_RATE, 100)																AS PRODT_RATE
			-- , B.SALE_UNIT																				AS PROG_UNIT
			 , B.STOCK_UNIT																				AS PROG_UNIT
			 , ISNULL(C.STOCK_Q, 0)																		AS ONHAND_Q
			 , ISNULL(D.PRODT_RATE, 100)																AS PRODT_RATE
			 , D.LOT_YN
			 , A.UNIT_Q																					AS BOM_UNIT_Q
		  FROM BPR500T		A WITH(NOLOCK)
		 INNER JOIN BPR100T B WITH(NOLOCK) ON B.COMP_CODE	= A.COMP_CODE
										  AND B.ITEM_CODE	= A.CHILD_ITEM_CODE
		  LEFT JOIN BIV100T C WITH(NOLOCK) ON C.COMP_CODE	= A.COMP_CODE
										  AND C.DIV_CODE	= A.DIV_CODE
										  AND C.WH_CODE		= #{WORK_SHOP_CODE}
										  AND C.ITEM_CODE	= A.CHILD_ITEM_CODE
		 INNER JOIN BPR200T D WITH(NOLOCK) ON D.COMP_CODE	= A.COMP_CODE
										  AND D.DIV_CODE	= A.DIV_CODE
										  AND D.ITEM_CODE	= A.PROD_ITEM_CODE
		 WHERE A.COMP_CODE		= #{S_COMP_CODE}
		   AND A.DIV_CODE		= #{DIV_CODE}
		   <if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
		   AND A.PROD_ITEM_CODE	= #{ITEM_CODE}
		   </if>
		   <if test="@foren.Ognl@isNotEmpty(ITEM_CODE_ARR)">
		   AND A.PROD_ITEM_CODE	IN
			 <foreach collection="ITEM_CODE_ARR" item="item" index="index" separator="," close=")" open="(">
							   #{item}
			</foreach>
		   </if>
		   AND #{PRESENT_DATE} BETWEEN A.START_DATE AND ISNULL(A.STOP_DATE, '99999999')
	</select>






	<!-- 배송분류표 데이터 생성 -->
	<select id="s_pmp110ukrv_ypServiceImpl.makeDeliveryLabel" parameterType="Map" resultType="rMap">
	/* s_pmp110ukrv_ypServiceImpl.makeDeliveryLabel (배송분류표 데이터 생성) */
	BEGIN
		SET NOCOUNT ON
		SET ARITHABORT ON

		DECLARE   @CompCode	 NVARCHAR(08)		/* 법인코드			*/
				, @UserId	   NVARCHAR(100)		/* 사용자ID		*/
				, @LangType	 NVARCHAR(2)		/* 언어구분			*/
				, @RefItem	  NVARCHAR(01)		/* 명칭 참조 유형		*/
				, @DateFormat   NVARCHAR(10)	/* 날짜 포맷 유형 설정	*/

		SET @CompCode = #{S_COMP_CODE}
		SET @UserId   = #{S_USER_ID}
		SET @LangType = #{S_LANG_CODE}

		/* 명칭 참조 유형 */
		SELECT TOP 1 @RefItem = REF_ITEM
			FROM BSA300T WITH (NOLOCK)
			WHERE USER_ID = @UserId

		SET @RefItem = ISNULL(@RefItem, N'0')

		/* 날짜 포맷 유형 설정 */
		SELECT TOP 1 @DateFormat = CODE_NAME
			FROM BSA100T WITH (NOLOCK)
			WHERE COMP_CODE = @CompCode
			AND MAIN_CODE = N'B044'
			AND REF_CODE1 = N'Y'

		SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		/* 데이터 조회 */
		 SELECT A.WKORD_NUM
			  , (CASE	WHEN @RefItem = '1' THEN H.CUSTOM_NAME1
						WHEN @RefItem = '2' THEN H.CUSTOM_NAME2
											ELSE H.CUSTOM_NAME
				END)													AS CUSTOM_NAME
			  , CASE WHEN @RefItem = '0' THEN C.ITEM_NAME
					 WHEN @RefItem = '1' THEN C.ITEM_NAME1
					 WHEN @RefItem = '2' THEN C.ITEM_NAME2
					 ELSE					 C.ITEM_NAME
			   END														AS ITEM_NAME
			  --, ISNULL(C.SPEC, '')										AS SPEC
			  , ISNULL(F.ORDER_UNIT, 'Kg')								AS SPEC
			  , unilite.fnformat(@CompCode, A.WKORD_Q, 'P_FSET_QS')		AS WKORD_Q
			  , CEILING(A.WKORD_Q / D.PACK_QTY)							AS LABEL_Q
			  , (CASE WHEN ISNULL(F.EXP_ISSUE_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(F.EXP_ISSUE_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(F.EXP_ISSUE_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(F.EXP_ISSUE_DATE, 7, 2))
					END)												AS DELIVERY_DATE
			  , (CASE WHEN ISNULL(G.ORDER_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(G.ORDER_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(G.ORDER_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(G.ORDER_DATE, 7, 2))
					END)												AS ORDER_DATE
			  , (CASE WHEN ISNULL(F.PROD_END_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(F.PROD_END_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(F.PROD_END_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(F.PROD_END_DATE, 7, 2))
					END)												AS PACK_DATE
			  , '10℃이하'												AS STORAGE_METHOD
			  , (CASE WHEN ISNULL(X.EXP_DATE, '') = ''
						THEN ''
						ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(X.EXP_DATE, 1, 4))
																, 'MM'  , SUBSTRING(X.EXP_DATE, 5, 2))
																, 'DD'  , SUBSTRING(X.EXP_DATE, 7, 2)) + ' 까지'
					END)												AS EXP_DATE
			  , ''														AS CAR_NUMBER
			  , '별도표기'													AS ORIGIN		--원산지
			  , X.PRODT_YEAR
			  , '특'														AS QUALITY_GRADE
			  , I.COMP_NAME												AS SUPPLIER
			  , '전처리작업일 : '	+ (CASE WHEN ISNULL(F.PROD_END_DATE, '') = ''
									THEN ''
									ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(F.PROD_END_DATE, 1, 4))
																			, 'MM'  , SUBSTRING(F.PROD_END_DATE, 5, 2))
																			, 'DD'  , SUBSTRING(F.PROD_END_DATE, 7, 2))
								END)									AS PRE_WORK_DATE
		 FROM			   PMP100T A WITH(NOLOCK)
				INNER JOIN PMP200T X WITH(NOLOCK) ON  X.COMP_CODE		= A.COMP_CODE
												  AND X.DIV_CODE		= A.DIV_CODE
												  AND X.WKORD_NUM		= A.WKORD_NUM
												  --AND X.ITEM_CODE		= A.ITEM_CODE
				INNER JOIN BPR100T C WITH(NOLOCK) ON  C.COMP_CODE		= A.COMP_CODE
												  AND C.ITEM_CODE		= A.ITEM_CODE
				INNER JOIN BPR200T D WITH(NOLOCK) ON  D.COMP_CODE		= A.COMP_CODE
												  AND D.DIV_CODE		= A.DIV_CODE
												  AND D.ITEM_CODE		= A.ITEM_CODE
				LEFT  JOIN SOF110T F WITH(NOLOCK) ON  F.COMP_CODE		= A.COMP_CODE
												  AND F.DIV_CODE		= A.DIV_CODE
												  AND F.ORDER_NUM		= A.ORDER_NUM
												  AND F.SER_NO			= A.SER_NO
				LEFT  JOIN SOF100T G WITH(NOLOCK) ON  G.COMP_CODE		= A.COMP_CODE
												  AND G.DIV_CODE		= A.DIV_CODE
												  AND G.ORDER_NUM		= A.ORDER_NUM
				LEFT  JOIN BCM100T H WITH(NOLOCK) ON  H.COMP_CODE		= G.COMP_CODE
												  AND H.CUSTOM_CODE		= G.CUSTOM_CODE
				INNER JOIN BOR100T I WITH(NOLOCK) ON I.COMP_CODE		= A.COMP_CODE
		 WHERE  A.COMP_CODE			= @CompCode
			AND A.WORK_SHOP_CODE	= #{WORK_SHOP_CODE}
			AND A.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
			AND A.PRODT_START_DATE	= #{PRODT_START_DATE}
			AND A.PRODT_END_DATE	= #{PRODT_END_DATE}
			AND A.DIV_CODE			= #{DIV_CODE}
		<if test="@foren.Ognl@isNotEmpty(WKORD_NUM)">
			AND A.WKORD_NUM IN
			<foreach collection="WKORD_NUM" item="item" separator="," close=")" open="(">
				#{item}
			</foreach>
		</if>

		  ORDER BY A.ITEM_CODE, A.TOP_WKORD_NUM, A.WKORD_NUM ASC

		  SET NOCOUNT OFF
		  SET ARITHABORT OFF
	END
	</select>

	<!-- 친환경(소) 데이터 생성 -->
	<select id="s_pmp110ukrv_ypServiceImpl.makeGreen01Label" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.makeGreen01Label (친환경(소) 데이터 생성) */
		DECLARE   @CompCode		NVARCHAR(08)	/* 법인코드				*/
				, @UserId		NVARCHAR(100)	/* 사용자ID			*/
				, @LangType		NVARCHAR(02)	/* 언어구분				*/
				, @RefItem		NVARCHAR(01)	/* 명칭 참조 유형			*/
				, @DateFormat	NVARCHAR(10)	/* 날짜 포맷 유형 설정		*/
				, @charArray	NVARCHAR(23)	/* 인증번호 생성을 위한 array	*/

		SET @CompCode = #{S_COMP_CODE}
		SET @UserId   = #{S_USER_ID}
		SET @LangType = #{S_LANG_CODE}
		SET @charArray = 'A,B,C,D,E,F,G,H,I,J,K,L'

		/* 명칭 참조 유형 */
		SELECT TOP 1 @RefItem = REF_ITEM
			FROM BSA300T WITH (NOLOCK)
			WHERE USER_ID = @UserId

		SET @RefItem = ISNULL(@RefItem, N'0')

		/* 날짜 포맷 유형 설정 */
		SELECT TOP 1 @DateFormat = CODE_NAME
			FROM BSA100T WITH (NOLOCK)
			WHERE COMP_CODE = @CompCode
			AND MAIN_CODE = N'B044'
			AND REF_CODE1 = N'Y'

		SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		SELECT A.COMP_CODE
			 , D.COMP_NAME
			 , A.DIV_CODE
			 , CASE WHEN ISNULL(F1.CERT_NO, '') = '' THEN  '3-6-1'
					ELSE F1.CERT_NO
			   END													AS COMP_CERF_CODE
			 , D.TELEPHON
			 , D.ADDR
			 , A.TOP_WKORD_NUM
			 , A.WKORD_NUM
			 , A.REF_TYPE
			 , A.PATH_CODE
			 , A.ITEM_CODE
			 , B.ITEM_NAME
			 , ISNULL(B.SPEC, '')									AS SPEC
			 , B.STOCK_UNIT											AS PROG_UNIT
			 , CASE WHEN ISNULL(E2.FARM_NAME, '') = '' THEN  ISNULL(E3.REF_CODE1, '') + '(' + E.CUSTOM_NAME + ')'
					ELSE E2.ORIGIN  + '(' + E2.FARM_NAME + ')'
			   END													AS PRODT_PERSON
			 , A.PRODT_YEAR
			 , B.SALE_UNIT											AS SALE_UNIT
			 , CASE WHEN ISNULL(E2.CERT_NO, '') != '' THEN ISNULL(E2.CERT_NO, '')
					ELSE ISNULL(E1.CERT_NO, '')
			   END													AS BARCODE			--바코드
			 , ISNULL(A.ITEM_CODE, '') + '-' + ISNULL(A.LOT_NO, '') + '-' +
			   ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,7, 2), '') + ISNULL((SELECT VALUE FROM fnSplit(@charArray, ',')
																	   WHERE IDX = ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,5, 2), '')),'') + ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,3, 2), '') + '-' +
			   ISNULL(C1.CUSTOM_CODE, '')							AS MANAGE_NO		--이력번호
			 , ISNULL(E1.CERT_ORG, '')								AS CENTER
			 , CASE WHEN ISNULL(C2.CUSTOM_NAME1, '') = '' THEN ISNULL(C2.CUSTOM_NAME, '')
			 		ELSE ISNULL(C2.CUSTOM_NAME1, '')
			   END													AS CUSTOM_NAME
			 , 1													AS LABEL_Q

		  FROM		 PMP200T		A WITH(NOLOCK)
		  INNER JOIN PMP100T		X WITH(NOLOCK)	ON X.COMP_CODE			= A.COMP_CODE
												   AND X.WORK_SHOP_CODE		= #{WORK_SHOP_CODE}
												   AND X.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
												   AND X.PRODT_START_DATE	= #{PRODT_START_DATE}
												   AND X.PRODT_END_DATE		= #{PRODT_END_DATE}
		  INNER JOIN BPR100T		B WITH(NOLOCK)	ON B.COMP_CODE			= A.COMP_CODE
												   AND B.ITEM_CODE			= A.ITEM_CODE
		   LEFT JOIN SOF110T		C WITH(NOLOCK)	ON C.COMP_CODE			= X.COMP_CODE
												   AND C.DIV_CODE			= X.DIV_CODE
												   AND C.ORDER_NUM			= X.ORDER_NUM
												   AND C.SER_NO				= X.SER_NO
		   LEFT JOIN SOF100T		C1 WITH(NOLOCK)	ON C1.COMP_CODE			= C.COMP_CODE
												   AND C1.DIV_CODE			= C.DIV_CODE
												   AND C1.ORDER_NUM			= C.ORDER_NUM
		   LEFT  JOIN BCM100T		C2 WITH(NOLOCK)	ON C2.COMP_CODE			= C1.COMP_CODE
												   AND C2.CUSTOM_CODE		= C1.CUSTOM_CODE
		  INNER JOIN BOR100T		D WITH(NOLOCK)	ON D.COMP_CODE			= A.COMP_CODE
		   LEFT JOIN BCM100T		E WITH(NOLOCK)	ON E.COMP_CODE			= A.COMP_CODE
												   AND E.CHANNEL			= LEFT(A.LOT_NO, 2)
		   LEFT JOIN S_BCM100T_YP	E1 WITH(NOLOCK)	ON E1.COMP_CODE			= E.COMP_CODE
												   AND E1.CUSTOM_CODE		= E.CUSTOM_CODE
												   AND E1.TYPE				= SUBSTRING(A.LOT_NO, 10, 1)
												   AND ( X.PRODT_WKORD_DATE BETWEEN E1.APLY_START_DATE AND E1.APLY_END_DATE )
		   LEFT JOIN S_BCM106T_YP	E2 WITH(NOLOCK)	ON E2.COMP_CODE			= E.COMP_CODE
												   AND E2.CUSTOM_CODE		= E.CUSTOM_CODE
												   AND E2.FARM_CODE			= SUBSTRING(A.LOT_NO, 8, 2)
		   LEFT JOIN BSA100T		E3 WITH(NOLOCK)	ON E3.COMP_CODE			= E.COMP_CODE
												   AND E3.MAIN_CODE			= 'B056'
												   AND E3.SUB_CODE			= E.AREA_TYPE
		   LEFT JOIN BCM100T		F WITH(NOLOCK)	ON F.COMP_CODE			= A.COMP_CODE
												   AND F.CUSTOM_CODE		= (SELECT CODE_NAME FROM BSA100T WITH(NOLOCK)
																				WHERE COMP_CODE = A.COMP_CODE
																				  AND MAIN_CODE = 'T000'
																				  AND SUB_CODE  = 'T000' )
		   LEFT JOIN S_BCM100T_YP	F1 WITH(NOLOCK)	ON F1.COMP_CODE			= F.COMP_CODE
												   AND F1.CUSTOM_CODE		= F.CUSTOM_CODE
												   AND X.PRODT_WKORD_DATE BETWEEN F1.APLY_START_DATE AND F1.APLY_END_DATE

		 WHERE A.COMP_CODE		= #{S_COMP_CODE}
		   AND A.DIV_CODE		= #{DIV_CODE}
		   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}
		   AND A.WKORD_NUM		= X.WKORD_NUM
		<if test="@foren.Ognl@isNotEmpty(WKORD_NUM)">
		   AND A.WKORD_NUM IN
			<foreach collection="WKORD_NUM" item="item" separator="," close=")" open="(">
				#{item}
			</foreach>
		</if>
	</select>

	<!-- 친환경(대) 데이터 생성 -->
	<select id="s_pmp110ukrv_ypServiceImpl.makeGreen02Label" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.makeGreen02Label (친환경(대) 데이터 생성) */
		DECLARE   @CompCode		NVARCHAR(08)	/* 법인코드				*/
				, @UserId		NVARCHAR(100)	/* 사용자ID			*/
				, @LangType		NVARCHAR(02)	/* 언어구분				*/
				, @RefItem		NVARCHAR(01)	/* 명칭 참조 유형			*/
				, @DateFormat	NVARCHAR(10)	/* 날짜 포맷 유형 설정		*/
				, @charArray	NVARCHAR(23)	/* 인증번호 생성을 위한 array	*/

		SET @CompCode = #{S_COMP_CODE}
		SET @UserId   = #{S_USER_ID}
		SET @LangType = #{S_LANG_CODE}
		SET @charArray = 'A,B,C,D,E,F,G,H,I,J,K,L'

		/* 명칭 참조 유형 */
		SELECT TOP 1 @RefItem = REF_ITEM
			FROM BSA300T WITH (NOLOCK)
			WHERE USER_ID = @UserId

		SET @RefItem = ISNULL(@RefItem, N'0')

		/* 날짜 포맷 유형 설정 */
		SELECT TOP 1 @DateFormat = CODE_NAME
			FROM BSA100T WITH (NOLOCK)
			WHERE COMP_CODE = @CompCode
			AND MAIN_CODE = N'B044'
			AND REF_CODE1 = N'Y'

		SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		SELECT A.COMP_CODE
			 , D.COMP_NAME																--법인명
			 , A.WKORD_NUM
			 , A.DIV_CODE
			 , CASE WHEN ISNULL(F1.CERT_NO, '') = '' THEN  '3-6-1'
					ELSE F1.CERT_NO
			   END													AS COMP_CERF_CODE	--양평공사 인증번호
			 , D.TELEPHON																--양평공사 전화번호
			 , D.ADDR																	--양평공사 주소
			 , A.ITEM_CODE
			 , B.ITEM_NAME																--품목명
			 , '추청'													AS ITEM_KIND		--품종
			 , '경기 양평'												AS PROD_AREA		--산지
			 , ''													AS ITEM_WEIGHT		--중량
			 , A.PRODT_YEAR + '년산'									AS PRODT_YEAR		--산년
			 , (CASE WHEN ISNULL(C.PROD_END_DATE, '') = ''
							THEN ''
							ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(C.PROD_END_DATE, 1, 4))
																	, 'MM'  , SUBSTRING(C.PROD_END_DATE, 5, 2))
																	, 'DD'  , SUBSTRING(C.PROD_END_DATE, 7, 2))
					END)											AS PRODT_DATE		--도정일
			 , CASE WHEN ISNULL(E2.FARM_NAME, '') = '' THEN  CASE WHEN ISNULL(E.CUSTOM_NAME1, '') = '' THEN ISNULL(E.CUSTOM_NAME, '') + '(' + ISNULL(E1.CERT_NO, '') + ')'
																  ELSE ISNULL(E.CUSTOM_NAME1, '') + '(' + ISNULL(E1.CERT_NO, '') + ')'
															 END
					ELSE E2.FARM_NAME  + '(' + ISNULL(E2.CERT_NO, '') + ')'
			   END													AS PRODT_PERSON		--생산자
			 , ISNULL(A.ITEM_CODE, '') + '-' + ISNULL(A.LOT_NO, '') + '-' +
			   ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,7, 2), '') + ISNULL((SELECT VALUE FROM fnSplit(@charArray, ',')
																	   WHERE IDX = ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,5, 2), '')),'') + ISNULL(SUBSTRING(C.EXP_ISSUE_DATE,3, 2), '') + '-' +
			   ISNULL(C1.CUSTOM_CODE, '')							AS MANAGE_NO		--이력번호
			 , CASE WHEN ISNULL(E2.CERT_NO, '') != '' THEN ISNULL(E2.CERT_NO, '')
					ELSE ISNULL(E1.CERT_NO, '')
			   END													AS BARCODE			--바코드
			 , ISNULL(E1.CERT_ORG, '')								AS CENTER			--친환경인증센터
			 , CASE WHEN ISNULL(C2.CUSTOM_NAME1, '') = '' THEN ISNULL(C2.CUSTOM_NAME, '')
			 		ELSE ISNULL(C2.CUSTOM_NAME1, '')
			   END													AS CUSTOM_NAME
			 , 1													AS LABEL_Q			--매수
	-----------------------------------------------조회 내용 중 E1.으로 된 것들은 추후 확인 필요함(PRODT_PERSON(E1.CERT_NO), CENTER(E1.CERT_ORG), BARCODE(E1.CERT_NO))
		  FROM		 PMP200T		A WITH(NOLOCK)
		  INNER JOIN PMP100T		X WITH(NOLOCK)	ON X.COMP_CODE			= A.COMP_CODE
												   AND X.WORK_SHOP_CODE		= #{WORK_SHOP_CODE}
												   AND X.PRODT_WKORD_DATE	= #{PRODT_WKORD_DATE}
												   AND X.PRODT_START_DATE	= #{PRODT_START_DATE}
												   AND X.PRODT_END_DATE		= #{PRODT_END_DATE}
		  INNER JOIN BPR100T		B WITH(NOLOCK)	ON B.COMP_CODE			= A.COMP_CODE
												   AND B.ITEM_CODE			= A.ITEM_CODE
		   LEFT JOIN SOF110T		C WITH(NOLOCK)	ON C.COMP_CODE			= X.COMP_CODE
												   AND C.DIV_CODE			= X.DIV_CODE
												   AND C.ORDER_NUM			= X.ORDER_NUM
												   AND C.SER_NO				= X.SER_NO
		   LEFT JOIN SOF100T		C1 WITH(NOLOCK)	ON C1.COMP_CODE			= C.COMP_CODE
												   AND C1.DIV_CODE			= C.DIV_CODE
												   AND C1.ORDER_NUM			= C.ORDER_NUM
		   LEFT  JOIN BCM100T		C2 WITH(NOLOCK)	ON C2.COMP_CODE			= C1.COMP_CODE
												   AND C2.CUSTOM_CODE		= C1.CUSTOM_CODE
		  INNER JOIN BOR100T		D WITH(NOLOCK)	ON D.COMP_CODE			= A.COMP_CODE
		   LEFT JOIN BCM100T		E WITH(NOLOCK)	ON E.COMP_CODE			= A.COMP_CODE
												   AND E.CHANNEL			= LEFT(A.LOT_NO, 2)
		   LEFT JOIN S_BCM100T_YP	E1 WITH(NOLOCK)	ON E1.COMP_CODE			= E.COMP_CODE
												   AND E1.CUSTOM_CODE		= E.CUSTOM_CODE
												   AND E1.TYPE				= SUBSTRING(A.LOT_NO, 10, 1)
												   AND ( X.PRODT_WKORD_DATE BETWEEN E1.APLY_START_DATE AND E1.APLY_END_DATE )
		   LEFT JOIN S_BCM106T_YP	E2 WITH(NOLOCK)	ON E2.COMP_CODE			= E.COMP_CODE
												   AND E2.CUSTOM_CODE		= E.CUSTOM_CODE
												   AND E2.FARM_CODE			= SUBSTRING(A.LOT_NO, 8, 2)
		   LEFT JOIN BSA100T		E3 WITH(NOLOCK)	ON E3.COMP_CODE			= E.COMP_CODE
												   AND E3.MAIN_CODE			= 'B056'
												   AND E3.SUB_CODE			= E.AREA_TYPE
		   LEFT JOIN BCM100T		F WITH(NOLOCK)	ON F.COMP_CODE			= A.COMP_CODE
												   AND F.CUSTOM_CODE		= (SELECT CODE_NAME FROM BSA100T WITH(NOLOCK)
																				WHERE COMP_CODE = A.COMP_CODE
																				  AND MAIN_CODE = 'T000'
																				  AND SUB_CODE  = 'T000' )
		   LEFT JOIN S_BCM100T_YP	F1 WITH(NOLOCK)	ON F1.COMP_CODE			= F.COMP_CODE
												   AND F1.CUSTOM_CODE		= F.CUSTOM_CODE
												   AND X.PRODT_WKORD_DATE BETWEEN F1.APLY_START_DATE AND F1.APLY_END_DATE

		 WHERE A.COMP_CODE		= #{S_COMP_CODE}
		   AND A.DIV_CODE		= #{DIV_CODE}
		   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}
		   AND A.WKORD_NUM		= X.WKORD_NUM
		<if test="@foren.Ognl@isNotEmpty(WKORD_NUM)">
		   AND A.WKORD_NUM IN
			<foreach collection="WKORD_NUM" item="item" separator="," close=")" open="(">
				#{item}
			</foreach>
		</if>
	</select>



	<select id="s_pmp110ukrv_ypServiceImpl.printList" parameterType="Map" resultType="rMap">
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE   @CompCode				NVARCHAR(08)	/* 법인코드			*/
					, @UserId				NVARCHAR(100)	/* 사용자ID		*/
					, @LangType				NVARCHAR(2)		/* 언어구분			*/
					, @RefItem				NVARCHAR(01)	/* 명칭 참조 유형		*/
					, @DateFormat			NVARCHAR(10)	/* 날짜 포맷 유형 설정 	*/
					, @PRINT_USER			NVARCHAR(100)	--(선택) 출력자
					, @VIEW_PRINT_INFO_YN	NVARCHAR(01)	--인쇄출력정보 여부

			SET @CompCode = #{S_COMP_CODE}
			SET @UserId   = #{S_USER_ID}

			/*출력자*/
			SELECT @PRINT_USER = USER_NAME
				FROM BSA300T WITH(NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND USER_ID = @UserId

			/*출력정보 표시여부*/
			SELECT @VIEW_PRINT_INFO_YN = SUB_CODE
				FROM BSA100T WITH(NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND MAIN_CODE = 'B249'
				AND SUB_CODE != '$'
				AND REF_CODE1 = 'Y'

			/* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
				FROM BSA300T WITH (NOLOCK)
				WHERE USER_ID = @UserId

			SET @RefItem = ISNULL(@RefItem, N'0')

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
				FROM BSA100T WITH (NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND MAIN_CODE = N'B044'
				AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

			/* 데이터 조회 */
			 SELECT A.SEQ
				  , A.TOP_WKORD_NUM																	--통합작지번호
				  , A.WKORD_NUM																		--작지번호
				  , A.ITEM_CODE																		--상품코드
				  , CASE WHEN @RefItem = '0' THEN C.ITEM_NAME
						 WHEN @RefItem = '1' THEN C.ITEM_NAME1
						 WHEN @RefItem = '2' THEN C.ITEM_NAME2
						 ELSE					C.ITEM_NAME
				   END														AS ITEM_NAME			--상품명
				  , G.CUSTOM_CODE
				  , (CASE   WHEN @RefItem = '1' THEN H.CUSTOM_NAME1
							WHEN @RefItem = '2' THEN H.CUSTOM_NAME2
												ELSE H.CUSTOM_NAME
					END)													AS CUSTOM_NAME			--거래처
				  , SUBSTRING(#{PRODT_START_DATE}, 1, 4) + '-' + SUBSTRING(#{PRODT_START_DATE}, 5, 2) + '-' + SUBSTRING(#{PRODT_START_DATE}, 7, 2)  AS PRODT_START_DATE
				  , SUBSTRING(F.EXP_ISSUE_DATE, 5, 2) + '/' + SUBSTRING(F.EXP_ISSUE_DATE, 7, 2) AS EXP_ISSUE_DATE
				  , unilite.fnformat(@CompCode, A.WKORD_Q, 'P_FSET_QS')		AS WKORD_Q				--수량
				  , A.DIV_CODE																		--사업장 코드
				  , I.DIV_NAME																		--사업장 명
				  , A.REMARK																		--비고
				  , @PRINT_USER												AS PRINT_USER			--출력자 이름
				  , @VIEW_PRINT_INFO_YN										AS VIEW_PRINT_INFO_YN	--인쇄출력정보 표시여부

			 FROM			  PMP100T A WITH(NOLOCK)
					LEFT JOIN PMP200T X WITH(NOLOCK) ON  X.COMP_CODE		= A.COMP_CODE
													  AND X.DIV_CODE		= A.DIV_CODE
													  AND X.WKORD_NUM		= A.WKORD_NUM
													  AND X.ITEM_CODE		= A.ITEM_CODE
					INNER JOIN PBS200T B WITH(NOLOCK) ON  B.COMP_CODE		= A.COMP_CODE
													  AND B.DIV_CODE		= A.DIV_CODE
													  AND B.WORK_SHOP_CODE	= A.WORK_SHOP_CODE
													  AND B.PROG_WORK_CODE	= A.PROG_WORK_CODE
					INNER JOIN BPR100T C WITH(NOLOCK) ON  C.COMP_CODE		= A.COMP_CODE
													  AND C.ITEM_CODE		= A.ITEM_CODE
					INNER JOIN BPR200T D WITH(NOLOCK) ON  D.COMP_CODE		= A.COMP_CODE
													  AND D.DIV_CODE		= A.DIV_CODE
													  AND D.ITEM_CODE		= A.ITEM_CODE
					LEFT  JOIN SOF110T F WITH(NOLOCK) ON  F.COMP_CODE		= A.COMP_CODE
													  AND F.DIV_CODE		= A.DIV_CODE
													  AND F.ORDER_NUM		= A.ORDER_NUM
													  AND F.SER_NO			= A.SER_NO
					LEFT  JOIN SOF100T G WITH(NOLOCK) ON  G.COMP_CODE		= A.COMP_CODE
													  AND G.DIV_CODE		= A.DIV_CODE
													  AND G.ORDER_NUM		= A.ORDER_NUM
					LEFT  JOIN BCM100T H WITH(NOLOCK) ON  H.COMP_CODE		= G.COMP_CODE
													  AND H.CUSTOM_CODE		= G.CUSTOM_CODE
					INNER JOIN BOR120T I WITH (NOLOCK) ON I.COMP_CODE	= A.COMP_CODE
													  AND I.DIV_CODE	= A.DIV_CODE
					INNER JOIN uniLITE.fnSplit(#{WKORD_NUM}, ',') AS J ON J.VALUE = A.WKORD_NUM

			  WHERE  A.COMP_CODE	= @CompCode
				AND  A.DIV_CODE		= #{DIV_CODE}
			  ORDER BY C.ITEM_NAME, A.ITEM_CODE, G.CUSTOM_CODE, F.EXP_ISSUE_DATE

			  SET NOCOUNT OFF
			  SET ARITHABORT OFF
		END
	</select>






<!-- 라벨 출력 clipreport로 변경 -->
<!-- 친환경(소) -->
	<insert id="s_pmp110ukrv_ypServiceImpl.insertPrintData" parameterType="Map" useGeneratedKeys="false">
		IF NOT EXISTS (SELECT TOP 1 1 FROM tempdb..sysobjects  WHERE id=object_id('tempdb..##s_pmp110ukrv_ypService_TEMP'))
		CREATE TABLE ##s_pmp110ukrv_ypService_TEMP (
		       COMP_NAME        NVARCHAR(MAX),
		       COMP_CERF_CODE   NVARCHAR(MAX),
		       TELEPHON         NVARCHAR(MAX),
		       ADDR             NVARCHAR(MAX),
		       ITEM_NAME        NVARCHAR(MAX),
		       PRODT_PERSON     NVARCHAR(MAX),
		       PRODT_YEAR       NVARCHAR(MAX),
		       SALE_UNIT        NVARCHAR(MAX),
		       CUSTOM_NAME      NVARCHAR(MAX),
		       CENTER           NVARCHAR(MAX),
		       BARCODE          NVARCHAR(MAX),
		       MANAGE_NO        NVARCHAR(MAX),
		);

		INSERT ##s_pmp110ukrv_ypService_TEMP (
		       COMP_NAME
		     , COMP_CERF_CODE
		     , TELEPHON
		     , ADDR
		     , ITEM_NAME
		     , PRODT_PERSON
		     , PRODT_YEAR
		     , SALE_UNIT
		     , CUSTOM_NAME
		     , CENTER
		     , BARCODE
		     , MANAGE_NO
		) VALUES (
		       #{COMP_NAME}
		     , #{COMP_CERF_CODE}
		     , #{TELEPHON}
		     , #{ADDR}
		     , #{ITEM_NAME}
		     , #{PRODT_PERSON}
		     , #{PRODT_YEAR}
		     , #{SALE_UNIT}
		     , #{CUSTOM_NAME}
		     , #{CENTER}
		     , #{BARCODE}
		     , #{MANAGE_NO}
		)
	</insert>

	<select id="s_pmp110ukrv_ypServiceImpl.getGreen02Label" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.getGreen02Label */
		SELECT COMP_NAME
		     , COMP_CERF_CODE
		     , TELEPHON
		     , ADDR
		     , ITEM_NAME
		     , PRODT_PERSON
		     , PRODT_YEAR
		     , SALE_UNIT
		     , CUSTOM_NAME
		     , CENTER
		     , BARCODE
		     , MANAGE_NO
		  FROM ##s_pmp110ukrv_ypService_TEMP

		  delete from ##s_pmp110ukrv_ypService_TEMP
	</select>


<!-- 배송분류표 -->
	<insert id="s_pmp110ukrv_ypServiceImpl.insertPrint2Data" parameterType="Map" useGeneratedKeys="false">
		IF NOT EXISTS (SELECT TOP 1 1 FROM tempdb..sysobjects  WHERE id=object_id('tempdb..##s_pmp110ukrv_ypService_TEMP2'))
		CREATE TABLE ##s_pmp110ukrv_ypService_TEMP2 (
		       CUSTOM_NAME     NVARCHAR(MAX),
		       ITEM_NAME       NVARCHAR(MAX),
		       SPEC            NVARCHAR(MAX),
		       ORDER_Q         NVARCHAR(MAX),
		       BOX_Q           NVARCHAR(MAX),
		       DELIVERY_DATE   NVARCHAR(MAX),
		       ORDER_DATE      NVARCHAR(MAX),
		       PACK_DATE       NVARCHAR(MAX),
		       STORAGE_METHOD  NVARCHAR(MAX),
		       EXP_DATE        NVARCHAR(MAX),
		       CAR_NUMBER      NVARCHAR(MAX),
		       ORIGIN          NVARCHAR(MAX),
		       PRODT_YEAR      NVARCHAR(MAX),
		       QUALITY_GRADE   NVARCHAR(MAX),
		       SUPPLIER        NVARCHAR(MAX),
		       PRE_WORK_DATE   NVARCHAR(MAX)
		);

		INSERT ##s_pmp110ukrv_ypService_TEMP2 (
		       CUSTOM_NAME
		     , ITEM_NAME
		     , SPEC
		     , ORDER_Q
		     , BOX_Q
		     , DELIVERY_DATE
		     , ORDER_DATE
		     , PACK_DATE
		     , STORAGE_METHOD
		     , EXP_DATE
		     , CAR_NUMBER
		     , ORIGIN
		     , PRODT_YEAR
		     , QUALITY_GRADE
		     , SUPPLIER
		     , PRE_WORK_DATE
		) VALUES (
		       #{CUSTOM_NAME}
		     , #{ITEM_NAME}
		     , #{SPEC}
		     , #{ORDER_Q}
		     , #{BOX_Q}
		     , #{DELIVERY_DATE}
		     , #{ORDER_DATE}
		     , #{PACK_DATE}
		     , #{STORAGE_METHOD}
		     , #{EXP_DATE}
		     , #{CAR_NUMBER}
		     , #{ORIGIN}
		     , #{PRODT_YEAR}
		     , #{QUALITY_GRADE}
		     , #{SUPPLIER}
		     , #{PRE_WORK_DATE}
		)
	</insert>

	<select id="s_pmp110ukrv_ypServiceImpl.getDeliveryLabel" parameterType="Map" resultType="rMap">
		/* s_pmp110ukrv_ypServiceImpl.getPrintData */
		SELECT CUSTOM_NAME
		     , ITEM_NAME
		     , SPEC
		     , ORDER_Q
		     , BOX_Q
		     , DELIVERY_DATE
		     , ORDER_DATE
		     , PACK_DATE
		     , STORAGE_METHOD
		     , EXP_DATE
		     , CAR_NUMBER
		     , ORIGIN
		     , PRODT_YEAR
		     , QUALITY_GRADE
		     , SUPPLIER
		     , PRE_WORK_DATE
		  FROM ##s_pmp110ukrv_ypService_TEMP2

		  delete from ##s_pmp110ukrv_ypService_TEMP2
	</select>
</mapper>
