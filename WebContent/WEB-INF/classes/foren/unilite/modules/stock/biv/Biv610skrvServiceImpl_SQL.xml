<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="biv610skrvService">	
	
    <select id="biv610skrvService.selectList1" parameterType="Map" resultType="rMap">
		SELECT 
		ITEM_GROUP, 
		ITEM_GROUP_NAME, 
		ITEM_GROUP_SPEC, 
		ITEM_CODE, 
		ITEM_NAME, 
		SPEC,
		 IN_Q, 
		 OUT_Q, 
		 SAFE_STOCK_Q, 
		 PRODUCT_LDTIME, 
		 STOCK_Q, 
		 CASE 
		WHEN SAFE_STOCK_Q &lt; 0 THEN 0
		ELSE STOCK_Q - SAFE_STOCK_Q
	END AS OVER_Q
FROM (
	SELECT ITEM_GROUP
		, (
			SELECT ITEM_NAME
			FROM BPR100T
			WHERE ITEM_CODE = AA.ITEM_GROUP
		) AS ITEM_GROUP_NAME
		, (
			SELECT SPEC
			FROM BPR100T
			WHERE ITEM_CODE = AA.ITEM_GROUP
		) AS ITEM_GROUP_SPEC, ITEM_CODE, ITEM_NAME, SPEC
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = AA.ITEM_CODE
				AND INOUT_TYPE = '1'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS IN_Q
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = AA.ITEM_CODE
				AND INOUT_TYPE = '2'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS OUT_Q
		, (
			SELECT SAFE_STOCK_Q
			FROM BPR200T
			WHERE ITEM_CODE = AA.ITEM_CODE
		) AS SAFE_STOCK_Q, ISNULL((
			SELECT SUM(GOOD_STOCK_Q)
			FROM BIV100T
			WHERE ITEM_CODE = AA.ITEM_CODE
		), 0) AS STOCK_Q
		, ISNULL((
			SELECT MAX_PRODT_Q
			FROM BPR200T
			WHERE ITEM_CODE = AA.ITEM_CODE
		), 0) AS PRODUCT_LDTIME
	FROM (
		SELECT ITEM_LEVEL3, ITEM_GROUP, ITEM_CODE, ITEM_NAME, SPEC
			, (
				SELECT CODE_NAME
				FROM BSA100T
				WHERE MAIN_CODE = 'B020'
					AND SUB_CODE = (
						SELECT ITEM_ACCOUNT
						FROM BPR200T
						WHERE ITEM_CODE = A.ITEM_CODE
					)
			) AS ITEM_ACCOUNT
		FROM BPR100T A
		WHERE ITEM_GROUP IN (
			SELECT ITEM_CODE
			FROM BPR100T
			WHERE
				ITEM_CODE LIKE 'Y%'
				 <if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL3)">
		    	AND ITEM_LEVEL3 = #{ITEM_LEVEL3}  
		    	</if>
		)
	) AA
	WHERE ITEM_ACCOUNT = '제품'
		OR ITEM_ACCOUNT = '반제품'
) ZZ
ORDER BY ITEM_GROUP, ITEM_GROUP_NAME, ITEM_GROUP_SPEC, ITEM_CODE
    </select>
    
    <select id="biv610skrvService.selectList2" parameterType="Map" resultType="rMap">
		SELECT 
		ITEM_GROUP, 
		ITEM_GROUP_NAME, 
		ITEM_GROUP_SPEC, 
		ITEM_CODE, ITEM_NAME, 
		SPEC, 
		CASE 
			WHEN SUPPLY_TYPE &lt;&gt; 3 THEN IN_Q
			ELSE RCV_Q
		END AS RCV_Q, 
		IN_Q, 
		OUT_Q, 
		(
			SELECT SAFE_STOCK_Q
			FROM BPR200T
			WHERE ITEM_CODE = TT.ITEM_CODE
		) AS SAFE_STOCK_Q
		, (
			SELECT MAX_PRODT_Q
			FROM BPR200T
			WHERE ITEM_CODE = TT.ITEM_CODE
		) AS PRODUCT_LDTIME, STOCK_Q
		, CASE 
		WHEN (
						SELECT SAFE_STOCK_Q
						FROM BPR200T
						WHERE ITEM_CODE = TT.ITEM_CODE
					) - STOCK_Q &lt; 0 THEN 0
		ELSE STOCK_Q - (
						SELECT SAFE_STOCK_Q
						FROM BPR200T
						WHERE ITEM_CODE = TT.ITEM_CODE
					)
		END AS OVER_Q
FROM (
	SELECT PROD_ITEM_CODE AS ITEM_GROUP
		, (
			SELECT ITEM_NAME
			FROM BPR100T
			WHERE ITEM_CODE = A.PROD_ITEM_CODE
		) AS ITEM_GROUP_NAME
		, (
			SELECT SPEC
			FROM BPR100T
			WHERE ITEM_CODE = A.PROD_ITEM_CODE
		) AS ITEM_GROUP_SPEC
		, (
			SELECT SUPPLY_TYPE
			FROM BPR200T
			WHERE ITEM_CODE = A.CHILD_ITEM_CODE
		) AS SUPPLY_TYPE, CHILD_ITEM_CODE AS ITEM_CODE, ITEM_NAME, SPEC
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = A.CHILD_ITEM_CODE
				AND INOUT_TYPE = '1'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS IN_Q
		, ISNULL((
			SELECT SUM(T.RCV_Q)
			FROM (
				SELECT SUM(RECEIPT_Q) AS RCV_Q, ITEM_CODE
				FROM QMS100T
				WHERE RECEIPT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
				GROUP BY ITEM_CODE, RECEIPT_DATE
				) T
			WHERE T.ITEM_CODE = A.CHILD_ITEM_CODE
		), 0) AS RCV_Q
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = A.CHILD_ITEM_CODE
				AND INOUT_TYPE = '2'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS OUT_Q
		, ISNULL((
			SELECT SUM(GOOD_STOCK_Q)
			FROM BIV100T
			WHERE ITEM_CODE = A.CHILD_ITEM_CODE
		), 0) AS STOCK_Q
	FROM (
		SELECT PROD_ITEM_CODE, CHILD_ITEM_CODE
			, (
				SELECT CODE_NAME
				FROM BSA100T
				WHERE MAIN_CODE = 'B020'
					AND SUB_CODE = (
						SELECT ITEM_ACCOUNT
						FROM BPR200T
						WHERE ITEM_CODE = A.CHILD_ITEM_CODE
					)
			) AS ITEM_ACCOUNT
			, (
				SELECT ITEM_NAME
				FROM BPR100T
				WHERE ITEM_CODE = A.CHILD_ITEM_CODE
			) AS ITEM_NAME
			, (
				SELECT SPEC
				FROM BPR100T
				WHERE ITEM_CODE = A.CHILD_ITEM_CODE
			) AS SPEC
		FROM BPR500T A
	) A, (
			SELECT DISTINCT ITEM_GROUP
			FROM BPR100T
			WHERE ITEM_GROUP IN (
				SELECT ITEM_CODE
				FROM BPR100T
				WHERE
				ITEM_CODE LIKE 'Y%'
				 <if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL3)">
		    	AND ITEM_LEVEL3 = #{ITEM_LEVEL3}  
		    	</if>
			)
		) B
	WHERE A.PROD_ITEM_CODE = B.ITEM_GROUP
		AND CHILD_ITEM_CODE &lt;&gt; '$'
		AND ITEM_ACCOUNT = '반제품'
) TT
ORDER BY ITEM_GROUP, ITEM_CODE DESC
    </select>
    
    <select id="biv610skrvService.selectList3" parameterType="Map" resultType="rMap">
SELECT ITEM_CODE, ITEM_NAME, SPEC, RCV_Q, IN_Q
	, OUT_Q
	, (
		SELECT PURCH_LDTIME
		FROM BPR200T
		WHERE ITEM_CODE = TT.ITEM_CODE
	) AS PURCH_LDTIME
	, (
		SELECT SAFE_STOCK_Q
		FROM BPR200T
		WHERE ITEM_CODE = TT.ITEM_CODE
	) AS SAFE_STOCK_Q, STOCK_Q
	, CASE 
		WHEN (
			SELECT SAFE_STOCK_Q
			FROM BPR200T
			WHERE ITEM_CODE = TT.ITEM_CODE
		) - STOCK_Q &lt; 0 THEN 0
		ELSE STOCK_Q - (
			SELECT SAFE_STOCK_Q
			FROM BPR200T
			WHERE ITEM_CODE = TT.ITEM_CODE
		)
	END AS OVER_Q
FROM (
	SELECT ITEM_CODE, ITEM_NAME, SPEC
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = AA.ITEM_CODE
				AND INOUT_TYPE = '1'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS IN_Q		
		, ISNULL((
			SELECT SUM(T.RCV_Q)
			FROM (
				SELECT SUM(RECEIPT_Q) AS RCV_Q, ITEM_CODE
				FROM QMS100T
				WHERE RECEIPT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
				GROUP BY ITEM_CODE, RECEIPT_DATE
				) T
			WHERE T.ITEM_CODE = AA.ITEM_CODE
		), 0) AS RCV_Q
		, ISNULL((
			SELECT SUM(INOUT_Q)
			FROM BTR100T
			WHERE ITEM_CODE = AA.ITEM_CODE
				AND INOUT_TYPE = '2'
				AND INOUT_DATE BETWEEN #{INOUT_DATE_FR} AND #{INOUT_DATE_TO}
		), 0) AS OUT_Q
		, ISNULL((
			SELECT SUM(GOOD_STOCK_Q)
			FROM BIV100T
			WHERE ITEM_CODE = AA.ITEM_CODE
		), 0) AS STOCK_Q
	FROM (
		SELECT A.ITEM_LEVEL3, A.ITEM_GROUP, A.ITEM_CODE, A.ITEM_NAME, A.SPEC, B.ITEM_ACCOUNT
		FROM BPR100T A WITH(NOLOCK) 
			INNER JOIN BPR200T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
											 AND B.DIV_CODE  = #{DIV_CODE}
											 AND A.ITEM_CODE = B.ITEM_CODE
		WHERE 
			ITEM_LEVEL3 IN ('A01', 'A02', 'A11', 'A12', 'A13', 'A14', 'A15', 'B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'C01')
			<if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL1)">
	    	AND ITEM_LEVEL1 = #{ITEM_LEVEL1}  
	    	</if>
	    	<if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL2)">
	    	AND ITEM_LEVEL2 = #{ITEM_LEVEL2}  
	    	</if>
	    	<if test="@foren.Ognl@isNotEmpty(ITEM_LEVEL3)">
	    	AND ITEM_LEVEL3 = #{ITEM_LEVEL3}  
	    	</if>
		) AA
	WHERE AA.ITEM_ACCOUNT = '40'
) TT
ORDER BY ITEM_CODE
    </select>
    
</mapper>