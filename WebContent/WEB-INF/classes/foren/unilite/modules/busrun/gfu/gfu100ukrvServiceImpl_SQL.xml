<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gfu100ukrvServiceImpl">
	<select id="gfu100ukrvServiceImpl.selectListX" parameterType="Map" resultType="rMap">
		/* gfu100ukrvServiceImpl.selectList */
		SELECT    A.DIV_CODE
				, A.OPERATION_DATE AS SUPPLY_DATE
				, A.OFFICE_CODE
				, A.ROUTE_GROUP
				, A.ROUTE_CODE
				, ROW_NUMBER() OVER(PARTITION BY A.ROUTE_CODE ORDER BY A.OPERATION_DATE, R.ROUTE_NUM, A.VEHICLE_CODE) AS ROUTE_ROWNUM
				, A.VEHICLE_CODE
				, V.VEHICLE_NAME
				, V.VEHICLE_REGIST_NO
				, A.DRIVER_CODE
				, MO.NOTINSERVICE_YN
				, H.NAME AS DRIVER_NAME
				, ISNULL(G.FUEL_AMOUNT,0) AS FUEL_AMOUNT
				, R.ROUTE_NUM
		  FROM GOP300T A
		LEFT JOIN GFU100T G  ON G.COMP_CODE 	= A.COMP_CODE
							AND G.DIV_CODE		= A.DIV_CODE
							AND G.SUPPLY_DATE	= A.OPERATION_DATE
							AND G.ROUTE_CODE	= A.ROUTE_CODE
							AND G.VEHICLE_CODE	= A.VEHICLE_CODE
		LEFT JOIN HUM100T H  ON H.COMP_CODE		= A.COMP_CODE
						    AND H.DIV_CODE		= A.DIV_CODE
						    AND H.PERSON_NUMB	= A.DRIVER_CODE
		LEFT JOIN GVE100T V  ON V.COMP_CODE 	= A.COMP_CODE
		                    AND V.DIV_CODE 		= A.DIV_CODE
		                    AND V.VEHICLE_CODE 	= A.VEHICLE_CODE 
		LEFT JOIN GRT100T R  ON R.COMP_CODE 	= A.COMP_CODE
		                    AND R.DIV_CODE 		= A.DIV_CODE
		                    AND R.ROUTE_CODE 	= A.ROUTE_CODE
		INNER JOIN (	
					  SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT, RUN_COUNT,NOTINSERVICE_YN
						FROM (
							SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT,  
								   MIN(CONVERT(NUMERIC(10,0), RUN_COUNT)) OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT)  AS  RUN_COUNT, 
								   MAX(CASE WHEN RNK2=1 THEN NOTINSERVICE_YN ELSE '' END) OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT) AS NOTINSERVICE_YN
								   
							FROM (
								SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT, RUN_COUNT, NOTINSERVICE_YN, 
									   RANK() OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT ORDER BY CONVERT(NUMERIC(10,0),RUN_COUNT) ASC )  AS RNK,
									   RANK() OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT ORDER BY CONVERT(NUMERIC(10,0),RUN_COUNT) DESC ) AS RNK2
								FROM GOP300T
								WHERE COMP_CODE = #{S_COMP_CODE}
								  AND DIV_CODE = #{DIV_CODE}
								  AND OPERATION_DATE = #{SUPPLY_DATE}
								  AND OTHER_VEHICLE_YN != 'Y'
								  <if test="@foren.Ognl@isNotEmpty(DRIVER_CODE)">
								  AND DRIVER_CODE = #{DRIVER_CODE}
								  </if>	
								  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
								  AND ROUTE_GROUP = #{ROUTE_GROUP}
								  </if>
								  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
								  AND ROUTE_CODE = #{ROUTE_CODE}
								  </if>	
								  <if test="@foren.Ognl@isNotEmpty(VEHICLE_CODE)">
								  AND VEHICLE_CODE = #{VEHICLE_CODE}
								  </if> 
								  <if test="@foren.Ognl@isNotEmpty(OFFICE_CODE)">
								   AND OFFICE_CODE = #{OFFICE_CODE}
								  </if> 
							  ) L
							WHERE RNK =1  OR RNK2 =1
							) L2 
							GROUP BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT,  RUN_COUNT,NOTINSERVICE_YN  
						) MO  ON MO.COMP_CODE		= A.COMP_CODE
							 AND MO.DIV_CODE		= A.DIV_CODE
							 AND MO.OPERATION_DATE	= A.OPERATION_DATE
							 AND MO.ROUTE_CODE		= A.ROUTE_CODE
							 AND MO.OPERATION_COUNT = A.OPERATION_COUNT
							 AND MO.RUN_COUNT		= A.RUN_COUNT
		 WHERE A.COMP_CODE 			= #{S_COMP_CODE}
		   AND A.DIV_CODE 			= #{DIV_CODE}
		   AND A.OPERATION_DATE 	= #{SUPPLY_DATE}
		   AND A.OTHER_VEHICLE_YN 	!= 'Y'
		  <if test="@foren.Ognl@isNotEmpty(DRIVER_CODE)">
		   AND A.DRIVER_CODE = #{DRIVER_CODE}
		  </if>	
		  <if test="@foren.Ognl@isNotEmpty(DRIVER_NAME)">
		   AND H.NAME LIKE '%'+ #{DRIVER_NAME} +'%'
		  </if>	
		  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
		   AND A.ROUTE_GROUP = #{ROUTE_GROUP}
		  </if>
		  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
		   AND A.ROUTE_CODE = #{ROUTE_CODE}
		  </if>	
		  <if test="@foren.Ognl@isNotEmpty(VEHICLE_CODE)">
		   AND A.VEHICLE_CODE = #{VEHICLE_CODE}
		  </if> 
		  <if test="@foren.Ognl@isNotEmpty(VEHICLE_NAME)">
		   AND V.VEHICLE_NAME LIKE '%' + #{VEHICLE_NAME} + '%'
		  </if>
		  <if test="@foren.Ognl@isNotEmpty(OFFICE_CODE)">
		   AND A.OFFICE_CODE = #{OFFICE_CODE}
		  </if> 
		 ORDER BY A.OPERATION_DATE, R.ROUTE_NAME, A.VEHICLE_CODE
	</select>
	<select id="gfu100ukrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		/* gfu100ukrvServiceImpl.selectList */
		SELECT	 A1.ROUTE_NUM
				,ISNULL(G.SUPPLY_DATE, #{SUPPLY_DATE}) AS SUPPLY_DATE
				,B1.VEHICLE_CODE 
				,V.VEHICLE_NAME
				,V.VEHICLE_REGIST_NO
				,A.OFFICE_CODE
				,A.ROUTE_GROUP
				,A.ROUTE_CODE
				,A1.ROUTE_NUM
				,ROW_NUMBER() OVER(PARTITION BY A.ROUTE_CODE ORDER BY A1.ROUTE_NUM, B1.VEHICLE_CODE) AS ROUTE_ROWNUM
				,A.ROUTE_START_DATE
				,A.ROUTE_END_DATE
				,B.ASSIGN_START_DATE
				,B.ASSIGN_END_DATE
				,G.SUPPLY_DATE
				,G.FUEL_AMOUNT
				,CASE WHEN G.NOTINSERVICE_YN = 'Y' THEN 'true' ELSE 'false' END AS  NOTINSERVICE_YN
		FROM GRT110T A
		INNER JOIN GRT100T A1 ON A1.COMP_CODE			= A.COMP_CODE
							 AND A1.DIV_CODE			= A.DIV_CODE
							 AND A1.ROUTE_CODE			= A.ROUTE_CODE
		INNER JOIN GAG100T B  ON  B.COMP_CODE			= A.COMP_CODE
							 AND  B.DIV_CODE			= A.DIV_CODE
							 AND  B.ROUTE_CODE			= A.ROUTE_CODE
							 AND  B.ROUTE_START_DATE	= A.ROUTE_START_DATE
		INNER JOIN GAG120T B1 ON B1.COMP_CODE			= B.COMP_CODE
							 AND B1.DIV_CODE			= B.DIV_CODE
							 AND B1.ROUTE_CODE			= B.ROUTE_CODE
							 AND B1.ROUTE_START_DATE	= B.ROUTE_START_DATE
							 AND B1.ASSIGN_START_DATE	= B.ASSIGN_START_DATE
		INNER JOIN GVE100T V  ON  V.COMP_CODE			= B1.COMP_CODE
							 AND  V.DIV_CODE			= B1.DIV_CODE
							 AND  V.VEHICLE_CODE		= B1.VEHICLE_CODE
		LEFT JOIN  (SELECT COMP_CODE, DIV_CODE, SUPPLY_DATE,ROUTE_CODE, VEHICLE_CODE, FUEL_AMOUNT, NOTINSERVICE_YN
					  FROM GFU100T 
					 WHERE SUPPLY_DATE = #{SUPPLY_DATE}
					)      G  ON  G.COMP_CODE			= B1.COMP_CODE
							 AND  G.DIV_CODE			= B1.DIV_CODE
							 AND  G.ROUTE_CODE			= B1.ROUTE_CODE   
							 AND  G.VEHICLE_CODE		= B1.VEHICLE_CODE   
							 AND  G.SUPPLY_DATE		&gt;= B.ASSIGN_START_DATE 
							 AND  G.SUPPLY_DATE		&lt;= B.ASSIGN_END_DATE
		WHERE A.COMP_CODE	= #{S_COMP_CODE}
		  AND A.DIV_CODE 	= #{DIV_CODE}
		  AND #{SUPPLY_DATE} BETWEEN A.ROUTE_START_DATE AND A.ROUTE_END_DATE
		  AND #{SUPPLY_DATE} BETWEEN B.ASSIGN_START_DATE AND B.ASSIGN_END_DATE
		  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
		   AND A.ROUTE_GROUP = #{ROUTE_GROUP}
		  </if>
		  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
		   AND A.ROUTE_CODE = #{ROUTE_CODE}
		  </if>	
		  <if test="@foren.Ognl@isNotEmpty(VEHICLE_CODE)">
		   AND B1.VEHICLE_CODE  = #{VEHICLE_CODE}
		  </if> 
		  <if test="@foren.Ognl@isNotEmpty(VEHICLE_NAME)">
		   AND V.VEHICLE_NAME LIKE '%' + #{VEHICLE_NAME} + '%'
		  </if>
		  <if test="@foren.Ognl@isNotEmpty(OFFICE_CODE)">
		   AND A.OFFICE_CODE = #{OFFICE_CODE}
		  </if> 
		 ORDER BY A.OFFICE_CODE, A1.ROUTE_NUM, V.VEHICLE_NAME
	</select>	
	<update id="gfu100ukrvServiceImpl.update" parameterType="Map">
		IF EXISTS(
				SELECT FUEL_AMOUNT
				    FROM GFU100T 
				   WHERE COMP_CODE 		= #{S_COMP_CODE}
				     AND DIV_CODE 		= #{DIV_CODE}
				     AND SUPPLY_DATE 	= #{SUPPLY_DATE}
				     AND ROUTE_CODE 	= #{ROUTE_CODE}
				     AND VEHICLE_CODE 	= #{VEHICLE_CODE} 
		)
		BEGIN
			UPDATE GFU100T
			SET 
				FUEL_AMOUNT 		= #{FUEL_AMOUNT},
				NOTINSERVICE_YN		= #{NOTINSERVICE_YN},
				UPDATE_DB_USER 		= #{S_USER_ID},
				UPDATE_DB_TIME 		= GETDATE()
			WHERE COMP_CODE 	= #{COMP_CODE} 
			  AND DIV_CODE 		= #{DIV_CODE}  
			  AND SUPPLY_DATE 	= #{SUPPLY_DATE} 
			  AND ROUTE_CODE 	= #{ROUTE_CODE}
			  AND VEHICLE_CODE 	= #{VEHICLE_CODE}
		END
		ELSE
		BEGIN
			INSERT INTO GFU100T
			(
				COMP_CODE            
				, DIV_CODE             
				, SUPPLY_DATE					
				, ROUTE_CODE						
				, VEHICLE_CODE				
				                     
				, OFFICE_CODE						
				, ROUTE_GROUP						
				, FUEL_AMOUNT			
				, NOTINSERVICE_YN		
				, REMARK			
				, INSERT_DB_USER   
				, INSERT_DB_TIME   
				, UPDATE_DB_USER   
				, UPDATE_DB_TIME   
			)
			VALUES
			(
				#{S_COMP_CODE}          
				, #{DIV_CODE}             
				, #{SUPPLY_DATE}					
				, #{ROUTE_CODE}						
				, #{VEHICLE_CODE}					
				                     
				, #{OFFICE_CODE}						
				, #{ROUTE_GROUP}						
				, #{FUEL_AMOUNT}			
				, #{NOTINSERVICE_YN}                     
				, #{REMARK}								
				             
				, #{S_USER_ID}
				, GETDATE()
				, #{S_USER_ID}
				, GETDATE()
			)
		END
	</update>
</mapper>