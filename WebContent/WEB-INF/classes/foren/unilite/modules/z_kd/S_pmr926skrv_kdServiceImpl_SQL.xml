<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_pmr926skrv_kdService">
	<select id="s_pmr926skrv_kdService.selectList" parameterType="Map" resultType="rMap">  
	<![CDATA[   
        /* 작업장별 제품가용량 조회 */

      DECLARE @COMP_CODE NVARCHAR(10), @DIV_CODE NVARCHAR(10), @WORK_SHOP_CODE NVARCHAR(10), @BASIS_YYYMM NVARCHAR(6), @NEXT_YYYMM NVARCHAR(6)
      , @ITEM_CODE NVARCHAR(20)
      
 --     SET @COMP_CODE		= 'MASTER'
 --     SET @DIV_CODE		= '01'
 --     SET @WORK_SHOP_CODE = '3333'
 --     SET @BASIS_YYYMM	= '201807'
 --     SET @NEXT_YYYMM		= CONVERT(VARCHAR(6), DATEADD(MONTH, 1, @BASIS_YYYMM+'01'), 112)
 --     SET @ITEM_CODE = ''

      SET @COMP_CODE       = #{S_COMP_CODE}       --법인(필수)
      SET @DIV_CODE        = #{DIV_CODE}          --사업장(필수)
      SET @WORK_SHOP_CODE  = #{WORK_SHOP_CODE}    --작업장(옵션)
      SET @BASIS_YYYMM     = #{BASIS_DATE}        --기준년월(필수)
      SET @ITEM_CODE       = #{ITEM_CODE}         --품목코드(옵션)

      SET @NEXT_YYYMM		= CONVERT(VARCHAR(6), DATEADD(MONTH, 1, @BASIS_YYYMM+'01'), 112)
                                                                                          
      SELECT A.COMP_CODE               AS COMP_CODE        --법인
          , A.DIV_CODE                AS DIV_CODE         --사업장
          , K5.TREE_CODE				AS WORK_SHOP_CODE
		  , K5.TREE_NAME				AS WORK_SHOP_NAME
          , A.ITEM_CODE
          , A.ITEM_NAME
          , B.SPEC
          , B.OEM_ITEM_CODE
      		, ISNULL(K1.SALES_NEXT_PLAN_Q,0)  AS NEXT_PLAN_Q   --익월판매계획
      		, ISNULL(K1.SALES_PLAN_Q,0)       AS CUR_PLAN_Q     --당월판매계획       
      		, ISNULL(K2.STOCK_Q,0) AS STOCK_Q
      		, ISNULL(K3.INOUT_Q,0) AS INOUT_Q
      		, ISNULL(K4.WKORD_Q,0) AS WIP_Q             	--재공수량
      		, ISNULL(K1.SALES_PLAN_Q,0) - ISNULL(K2.STOCK_Q,0) - ISNULL(K3.INOUT_Q,0) AS SHORTAGE_Q	--부족량
      FROM BPR200T A WITH (NOLOCK)
      	 INNER JOIN BPR100T B WITH (NOLOCK) ON A.COMP_CODE=B.COMP_CODE AND A.ITEM_CODE=B.ITEM_CODE
      	 LEFT  JOIN (
      
      					SELECT COMP_CODE, DIV_CODE, PLAN_TYPE2_CODE AS ITEM_CODE
      							,SUM (CASE WHEN RIGHT(@BASIS_YYYMM, 2) = @DIV_CODE THEN (CASE WHEN ISNULL(MOD_PLAN_Q1, 0) != 0 THEN MOD_PLAN_Q1  ELSE PLAN_QTY1  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '02' THEN (CASE WHEN ISNULL(MOD_PLAN_Q2, 0) != 0 THEN MOD_PLAN_Q2  ELSE PLAN_QTY2  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '03' THEN (CASE WHEN ISNULL(MOD_PLAN_Q3, 0) != 0 THEN MOD_PLAN_Q3  ELSE PLAN_QTY3  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '04' THEN (CASE WHEN ISNULL(MOD_PLAN_Q4, 0) != 0 THEN MOD_PLAN_Q4  ELSE PLAN_QTY4  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '05' THEN (CASE WHEN ISNULL(MOD_PLAN_Q5, 0) != 0 THEN MOD_PLAN_Q5  ELSE PLAN_QTY5  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '06' THEN (CASE WHEN ISNULL(MOD_PLAN_Q6, 0) != 0 THEN MOD_PLAN_Q6  ELSE PLAN_QTY6  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '07' THEN (CASE WHEN ISNULL(MOD_PLAN_Q7, 0) != 0 THEN MOD_PLAN_Q7  ELSE PLAN_QTY7  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '08' THEN (CASE WHEN ISNULL(MOD_PLAN_Q8, 0) != 0 THEN MOD_PLAN_Q8  ELSE PLAN_QTY8  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '09' THEN (CASE WHEN ISNULL(MOD_PLAN_Q9, 0) != 0 THEN MOD_PLAN_Q9  ELSE PLAN_QTY9  END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '10' THEN (CASE WHEN ISNULL(MOD_PLAN_Q10,0) != 0 THEN MOD_PLAN_Q10 ELSE PLAN_QTY10 END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '11' THEN (CASE WHEN ISNULL(MOD_PLAN_Q11,0) != 0 THEN MOD_PLAN_Q11 ELSE PLAN_QTY11 END)
      												WHEN RIGHT(@NEXT_YYYMM, 2) = '12' THEN (CASE WHEN ISNULL(MOD_PLAN_Q12,0) != 0 THEN MOD_PLAN_Q12 ELSE PLAN_QTY12 END)
      										ELSE 0 END) AS SALES_NEXT_PLAN_Q
      							,SUM (CASE WHEN RIGHT(@BASIS_YYYMM, 2) = @DIV_CODE THEN (CASE WHEN ISNULL(MOD_PLAN_Q1, 0) != 0 THEN MOD_PLAN_Q1  ELSE PLAN_QTY1  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '02' THEN (CASE WHEN ISNULL(MOD_PLAN_Q2, 0) != 0 THEN MOD_PLAN_Q2  ELSE PLAN_QTY2  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '03' THEN (CASE WHEN ISNULL(MOD_PLAN_Q3, 0) != 0 THEN MOD_PLAN_Q3  ELSE PLAN_QTY3  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '04' THEN (CASE WHEN ISNULL(MOD_PLAN_Q4, 0) != 0 THEN MOD_PLAN_Q4  ELSE PLAN_QTY4  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '05' THEN (CASE WHEN ISNULL(MOD_PLAN_Q5, 0) != 0 THEN MOD_PLAN_Q5  ELSE PLAN_QTY5  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '06' THEN (CASE WHEN ISNULL(MOD_PLAN_Q6, 0) != 0 THEN MOD_PLAN_Q6  ELSE PLAN_QTY6  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '07' THEN (CASE WHEN ISNULL(MOD_PLAN_Q7, 0) != 0 THEN MOD_PLAN_Q7  ELSE PLAN_QTY7  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '08' THEN (CASE WHEN ISNULL(MOD_PLAN_Q8, 0) != 0 THEN MOD_PLAN_Q8  ELSE PLAN_QTY8  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '09' THEN (CASE WHEN ISNULL(MOD_PLAN_Q9, 0) != 0 THEN MOD_PLAN_Q9  ELSE PLAN_QTY9  END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '10' THEN (CASE WHEN ISNULL(MOD_PLAN_Q10,0) != 0 THEN MOD_PLAN_Q10 ELSE PLAN_QTY10 END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '11' THEN (CASE WHEN ISNULL(MOD_PLAN_Q11,0) != 0 THEN MOD_PLAN_Q11 ELSE PLAN_QTY11 END)
      												WHEN RIGHT(@BASIS_YYYMM, 2) = '12' THEN (CASE WHEN ISNULL(MOD_PLAN_Q12,0) != 0 THEN MOD_PLAN_Q12 ELSE PLAN_QTY12 END)
      										ELSE 0 END) AS SALES_PLAN_Q
      					FROM S_SSP100T_KD WITH (NOLOCK)
      					WHERE PLAN_YEAR=LEFT(@BASIS_YYYMM,4)
      					AND PLAN_TYPE1='10'
      					AND PLAN_TYPE2='6'
      					AND MONEY_UNIT = 'KRW' ---기준화폐
      					AND PLAN_TYPE2_CODE LIKE @ITEM_CODE + '%'
      					GROUP BY COMP_CODE, DIV_CODE, PLAN_TYPE2_CODE
      	 ) K1 ON A.COMP_CODE=K1.COMP_CODE AND A.DIV_CODE=K1.DIV_CODE AND A.ITEM_CODE=K1.ITEM_CODE
      	 LEFT JOIN (
      			SELECT S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE, SUM(S1.GOOD_STOCK_Q) AS STOCK_Q
      			FROM BIV100T S1 WITH (NOLOCK)
      				 INNER JOIN BSA220T S2 WITH (NOLOCK) ON S1.COMP_CODE=S2.COMP_CODE AND S1.DIV_CODE=S2.TYPE_LEVEL AND S1.WH_CODE=S2.TREE_CODE AND S2.PABSTOCK_YN = 'Y'
      			WHERE S1.COMP_CODE = @COMP_CODE
      			AND S1.DIV_CODE=@DIV_CODE
      			AND S1.ITEM_CODE LIKE @ITEM_CODE + '%'
      			GROUP BY S1.COMP_CODE, S1.DIV_CODE, S1.ITEM_CODE
      	 
      	 ) K2  ON A.COMP_CODE=K2.COMP_CODE AND A.DIV_CODE=K2.DIV_CODE AND A.ITEM_CODE=K2.ITEM_CODE
      	 LEFT JOIN (
      
      		 SELECT COMP_CODE, DIV_CODE, ITEM_CODE, SUM(INOUT_Q) AS INOUT_Q
      		 FROM BTR100T WITH (NOLOCK)
      		 WHERE COMP_CODE=@COMP_CODE
      		 AND DIV_CODE=@DIV_CODE
      		 AND INOUT_DATE LIKE @BASIS_YYYMM + '%'
      		 AND INOUT_TYPE='2'
      		 AND CREATE_LOC='1'
      		 AND INOUT_CODE_TYPE='4'
      		 AND ITEM_CODE LIKE @ITEM_CODE + '%'
      		 GROUP BY COMP_CODE, DIV_CODE, ITEM_CODE	 
      	 
      	 ) K3 ON A.COMP_CODE=K3.COMP_CODE AND A.DIV_CODE=K3.DIV_CODE AND A.ITEM_CODE=K3.ITEM_CODE
      	 LEFT  JOIN (
      		SELECT COMP_CODE, DIV_CODE, ITEM_CODE, SUM(WKORD_Q) AS WKORD_Q
      		FROM PMP100T WITH (NOLOCK)
      		WHERE COMP_CODE=@COMP_CODE
      		AND DIV_CODE=@DIV_CODE
      		AND LINE_END_YN='Y'
      		AND WKORD_STATUS <> '9'
      		AND PRODT_WKORD_DATE <= @BASIS_YYYMM + '31'
      		AND WORK_SHOP_CODE LIKE @WORK_SHOP_CODE + '%'
      		AND ITEM_CODE LIKE @ITEM_CODE + '%'
      		GROUP BY COMP_CODE, DIV_CODE, ITEM_CODE
      	 
      	 ) K4 ON A.COMP_CODE=K4.COMP_CODE AND A.DIV_CODE=K4.DIV_CODE AND A.ITEM_CODE=K4.ITEM_CODE
 		 LEFT JOIN BSA230T K5 WITH(NOLOCK) ON K5.COMP_CODE	= A.COMP_CODE
										  AND K5.TYPE_LEVEL	= A.DIV_CODE
										  AND K5.TREE_CODE	= A.WORK_SHOP_CODE
      WHERE A.COMP_CODE=@COMP_CODE
      AND A.DIV_CODE=@DIV_CODE
      AND A.WORK_SHOP_CODE LIKE @WORK_SHOP_CODE + '%'
      AND A.ITEM_CODE LIKE @ITEM_CODE +'%'
      AND A.ITEM_ACCOUNT = '10'
      AND ISNULL(K1.SALES_NEXT_PLAN_Q,0) + ISNULL(K1.SALES_PLAN_Q,0) <> 0
      
    ]]>
    </select>
</mapper>