<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="s_pmr928rkrv_kdServiceImpl">

    <select id="s_pmr928rkrv_kdServiceImpl.selectList" parameterType="Map" resultType="rMap">
    	<![CDATA[

        --s_pmr928rkrv_kdServiceImpl.selectList
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @COMP_CODE      NVARCHAR(08)    -- (필수) 법인코드
                  , @DIV_CODE       NVARCHAR(08)    -- (필수) 사업장코드
                  , @GUBUN          NVARCHAR(01)    -- (필수) 구분(생산실적 : '1', 생산검사 : '2')
                  , @FR_DATE        NVARCHAR(08)    -- (필수) FROM_DATE
                  , @TO_DATE        NVARCHAR(08)    -- (필수) TO_DATE
                  , @ITEM_ACCOUNT    NVARCHAR(08)    -- (필수) 품목코드

            SET @COMP_CODE  = #{S_COMP_CODE}
            SET @DIV_CODE   = #{DIV_CODE}
            SET @GUBUN      = #{GUBUN}
            SET @FR_DATE    = #{FR_DATE}
            SET @TO_DATE    = #{TO_DATE}
            SET @ITEM_ACCOUNT = #{ITEM_ACCOUNT}

            SELECT 0                                                     AS INOUT_SEQ        ---순번
                 ,  ''                                                      AS INOUT_DATE       ---입고일
                 ,  ISNULL(C6.SUB_CODE, 'KRW')                              AS MONEY_UNIT       ---화폐단위
                 ,  1                                                       AS EXCHG_RATE_O     ---환율
                 ,  A.COMP_CODE                                             AS COMP_CODE        ---법인
                 ,  A.DIV_CODE                                              AS DIV_CODE         ---사업장
                 ,  A.PRODT_NUM                                             AS PRODT_NUM        ---생산실적번호
                 ,  A.WKORD_NUM                                             AS WKORD_NUM        ---작업지시번호
                 ,  A.ITEM_CODE                                             AS ITEM_CODE        ---품목코드
                 ,  C2.ITEM_NAME                                            AS ITEM_NAME        ---품목명
                 ,  C2.SPEC                                                 AS SPEC             ---규격
                 ,  C2.STOCK_UNIT                                           AS ORDER_UNIT       ---단위
                 ,  ISNULL(C1.BASIS_P, 0)                                   AS ORDER_UNIT_P     ---단가(기준단가)
                 ,  C1.ITEM_ACCOUNT                                         AS ITEM_ACCOUNT     ---품목계정
                 ,  A.PRODT_DATE                                            AS PRODT_DATE       ---실적일자
                 ,  B.INSPEC_DATE                                           AS INSPEC_DATE      ---검사일자
                 ,  A.PRODT_Q                                               AS PRODT_Q          ---실적량
                 ,  B.GOOD_INSPEC_Q                                         AS GOOD_INSPEC_Q    ---합격수량
                 ,  B.BAD_INSPEC_Q                                          AS BAD_INSPEC_Q     ---불량수량
                 ,  B.GOOD_INSPEC_Q - ISNULL(D.GOOD_INOUT_Q, 0)             AS NOT_INSTOCK_Q    ---미입고량
                 ,  ISNULL(D.GOOD_INOUT_Q, 0)                               AS INSTOCK_Q        ---입고량
                 ,  0                                                       AS ORDER_UNIT_Q     ---수량
                 ,  '1'                                                     AS ITEM_STATUS      ---품목상태
                 ,  A.WORK_SHOP_CODE                                        AS WORK_SHOP_CODE   ---작업장코드
                 ,  C3.TREE_NAME                                            AS WORK_SHOP_NAME   ---작업장명
                 ,  C1.WH_CODE                                              AS WH_CODE          ---창고코드
                 ,  C4.TREE_NAME                                            AS WH_NAME          ---창고명
                 ,  A.PROJECT_NO                                            AS PROJECT_NO       ---프로젝트번호
                 ,  A.LOT_NO                                                AS LOT_NO           ---LOT번호
                 ,  NULL                                                    AS ORDER_NUM        ---재고이동 요청번호
                 ,  0                                                       AS ORDER_SEQ        ---재고이동 요청순번
                 ,  A.PRODT_NUM                                             AS BASIS_NUM        ---근거번호
                 ,  0                                                       AS BASIS_SEQ        ---근거순번
                 ,  B.INSPEC_NUM                                            AS INSPEC_NUM       ---검사번호
                 ,  B.INSPEC_SEQ                                            AS INSPEC_SEQ       ---검사순번
                 ,  A.WORK_SHOP_CODE                                        AS INOUT_CODE       ---수불처(작업장)
                 ,  C2.OEM_ITEM_CODE
            FROM               PMR200T A  WITH (NOLOCK)
                    INNER JOIN QMS400T B  WITH (NOLOCK) ON B.COMP_CODE      = A.COMP_CODE
                                                       AND B.DIV_CODE       = A.DIV_CODE
                                                       AND B.PRODT_NUM      = A.PRODT_NUM
                                                       AND B.WKORD_NUM      = A.WKORD_NUM
                    INNER JOIN BPR200T C1 WITH (NOLOCK) ON C1.COMP_CODE     = A.COMP_CODE
                                                       AND C1.DIV_CODE      = A.DIV_CODE
                                                       AND C1.ITEM_CODE     = A.ITEM_CODE
                    INNER JOIN BPR100T C2 WITH (NOLOCK) ON C2.COMP_CODE     = A.COMP_CODE
                                                       AND C2.ITEM_CODE     = A.ITEM_CODE
                    LEFT  JOIN BSA230T C3 WITH (NOLOCK) ON C3.COMP_CODE     = A.COMP_CODE
                                                       AND C3.TYPE_LEVEL    = A.DIV_CODE
                                                       AND C3.TREE_CODE     = A.WORK_SHOP_CODE
                    LEFT  JOIN BSA220T C4 WITH (NOLOCK) ON C4.COMP_CODE     = C1.COMP_CODE
                                                       AND C4.TYPE_LEVEL    = C1.DIV_CODE
                                                       AND C4.TREE_CODE     = C1.WH_CODE
                    LEFT  JOIN BSA100T C5 WITH (NOLOCK) ON C5.COMP_CODE     = A.COMP_CODE
                                                       AND C5.MAIN_CODE     = N'P007'
                                                       AND C5.SUB_CODE      = N'1'
                                                       AND C5.REF_CODE1     = N'Y'
                    LEFT  JOIN BSA100T C6 WITH (NOLOCK) ON A.COMP_CODE      = C6.COMP_CODE
                                                       AND C6.MAIN_CODE     = 'B004'
                                                       AND C6.SUB_CODE     <> '$'
                                                       AND C6.REF_CODE1     = 'Y'
                    LEFT  JOIN (
                                SELECT  COMP_CODE, DIV_CODE, BASIS_NUM, BASIS_SEQ, INSPEC_NUM, INSPEC_SEQ
                                     ,  SUM(CASE WHEN ITEM_STATUS = '1' THEN INOUT_Q ELSE 0 END) AS GOOD_INOUT_Q
                                     ,  SUM(CASE WHEN ITEM_STATUS = '2' THEN INOUT_Q ELSE 0 END) AS BAD_INOUT_Q
                                FROM    BTR100T WITH (NOLOCK)
                                WHERE   COMP_CODE  = @COMP_CODE
                                AND     DIV_CODE   = @DIV_CODE
                                AND     INOUT_TYPE = '1'   -- 입고
                                AND     CREATE_LOC = '1'   -- 영업
                                AND     INOUT_NUM  > ' ' AND INOUT_SEQ > 0 AND INSPEC_NUM > '' AND BASIS_NUM  > ''
                                GROUP   BY COMP_CODE, DIV_CODE, BASIS_NUM, BASIS_SEQ, INSPEC_NUM, INSPEC_SEQ
                                )      D                ON D.COMP_CODE      = B.COMP_CODE
                                                       AND D.DIV_CODE       = B.DIV_CODE
                                                       AND D.INSPEC_NUM     = B.INSPEC_NUM
                                                       AND D.INSPEC_SEQ     = B.INSPEC_SEQ
                                                       AND D.BASIS_NUM      = B.PRODT_NUM
                                                       AND D.BASIS_SEQ      = 0

            WHERE   A.COMP_CODE                 = @COMP_CODE
            AND     A.DIV_CODE                  = @DIV_CODE
            AND     ISNULL(C1.INSPEC_YN, 'N')   = 'Y'
--            AND     @GUBUN                      = '2'
            AND     B.INSPEC_DATE              >= @FR_DATE
            AND     B.INSPEC_DATE              <= @TO_DATE
            AND     C1.ITEM_ACCOUNT             = @ITEM_ACCOUNT
        --    AND     B.GOOD_INSPEC_Q - ISNULL(D.GOOD_INOUT_Q, 0) > 0

            -- 생산실적(양품/불량)내역 조회
            UNION ALL

            SELECT  *
            FROM    (
                    SELECT 0                                                          AS INOUT_SEQ        ---순번
                         ,  ''                                                          AS INOUT_DATE       ---입고일
                         ,  'KRW'                                                       AS MONEY_UNIT       ---화폐단위
                         ,  1                                                           AS EXCHG_RATE_O     ---환율
                         ,  A.COMP_CODE                                                 AS COMP_CODE         ---법인
                         ,  A.DIV_CODE                                                  AS DIV_CODE         ---사업장
                         ,  A.PRODT_NUM                                                 AS PRODT_NUM        ---생산실적번호
                         ,  A.WKORD_NUM                                                 AS WKORD_NUM        ---작업지시번호
                         ,  A.ITEM_CODE                                                 AS ITEM_CODE        ---품목코드
                         ,  C1.ITEM_NAME                                                AS ITEM_NAME        ---품목명
                         ,  C1.SPEC                                                     AS SPEC             ---규격
                         ,  C1.STOCK_UNIT                                               AS ORDER_UNIT       ---단위
                         ,  ISNULL(C2.BASIS_P, 0)                                       AS ORDER_UNIT_P     ---단가(기준단가)
                         ,  C2.ITEM_ACCOUNT                                             AS ITEM_ACCOUNT     ---품목계정
                         ,  A.PRODT_DATE                                                AS PRODT_DATE       ---실적일자
                         ,  ''                                                          AS INSPEC_DATE      ---검사일자
                         ,  A.PRODT_Q                                                   AS PRODT_Q          ---실적량
                         ,  A.GOOD_PRODT_Q                                              AS GOOD_PRODT_Q     ---합격수량
                         ,  A.BAD_PRODT_Q                                               AS BAD_PRODT_Q      ---불량수량
                         ,  ISNULL(A.GOOD_PRODT_Q, 0) - ISNULL(B.GOOD_INOUT_Q, 0)       AS NOT_INSTOCK_Q    ---미입고수량
                         ,  ISNULL(B.GOOD_INOUT_Q, 0)                                   AS INSTOCK_Q        ---입고수량
                         ,  0                                                           AS ORDER_UNIT_Q     ---수량
                         ,  '1'                                                         AS ITEM_STATUS      ---품목상태
                         ,  A.WORK_SHOP_CODE                                            AS WORK_SHOP_CODE   ---작업장코드
                         ,  C3.TREE_NAME                                                AS WORK_SHOP_NAME   ---작업장명
                         ,  C2.WH_CODE                                                  AS WH_CODE          ---창고코드
                         ,  ''                                                          AS WH_NAME          ---창고명
                         ,  A.PROJECT_NO                                                AS PROJECT_NO       ---프로젝트번호
                         ,  A.LOT_NO                                                    AS LOT_NO           ---LOT번호
                         ,  A.WKORD_NUM                                                 AS ORDER_NUM        ---작업지시번호
                         ,  0                                                           AS ORDER_SEQ        ---/
                         ,  A.PRODT_NUM                                                 AS BASIS_NUM        ---근거번호
                         ,  0                                                           AS BASIS_SEQ        ---근거순번
                         ,  ''                                                          AS INSPEC_NUM       ---검사번호
                         ,  0                                                           AS INSPEC_SEQ       ---검사순번
                         ,  A.WORK_SHOP_CODE                                            AS INOUT_CODE       ---수불처(작업장)
                         ,  C1.OEM_ITEM_CODE
                    FROM              PMR200T A  WITH (NOLOCK)
                            LEFT  JOIN (
                                        SELECT  COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                             ,  SUM(INOUT_Q) AS GOOD_INOUT_Q
                                        FROM    BTR100T WITH (NOLOCK)
                                        WHERE   COMP_CODE   = @COMP_CODE
                                        AND     DIV_CODE    = @DIV_CODE
                                        AND     INOUT_TYPE  = '1'
                                        AND     CREATE_LOC  = '1'
                                        AND     ITEM_STATUS = '1'
                                        GROUP   BY COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                        )       B               ON A.COMP_CODE   = B.COMP_CODE
                                                               AND A.DIV_CODE    = B.DIV_CODE
                                                               AND A.PRODT_NUM   = B.BASIS_NUM
                            INNER JOIN BPR100T C1 WITH (NOLOCK) ON C1.COMP_CODE  = A.COMP_CODE
                                                               AND C1.ITEM_CODE  = A.ITEM_CODE
                            INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE  = A.COMP_CODE
                                                               AND C2.DIV_CODE   = A.DIV_CODE
                                                               AND C2.ITEM_CODE  = A.ITEM_CODE
                            INNER JOIN BSA230T C3 WITH (NOLOCK) ON C3.COMP_CODE  = A.COMP_CODE
                                                               AND C3.TYPE_LEVEL = A.DIV_CODE
                                                               AND C3.TREE_CODE  = A.WORK_SHOP_CODE
                    WHERE   A.COMP_CODE                 = @COMP_CODE
                    AND     A.DIV_CODE                  = @DIV_CODE
                    AND     ISNULL(C2.INSPEC_YN, 'N')   = 'N'
--                    AND     @GUBUN                      = '1'
                    AND     A.PRODT_DATE               >= @FR_DATE
                    AND     A.PRODT_DATE               <= @TO_DATE
                    AND     C2.ITEM_ACCOUNT             = @ITEM_ACCOUNT
                --    AND     A.GOOD_PRODT_Q - ISNULL(B.GOOD_INOUT_Q, 0) > 0
                     ) A

            SET NOCOUNT OFF
            SET ARITHABORT OFF
        END
        ]]>
	</select>

    <select id="s_pmr928rkrv_kdServiceImpl.printList" parameterType="Map" resultType="rMap">
        <![CDATA[

        --s_pmr928rkrv_kdServiceImpl.printList
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @COMP_CODE      NVARCHAR(08)    -- (필수) 법인코드
                  , @DIV_CODE       NVARCHAR(08)    -- (필수) 사업장코드
                  , @GUBUN          NVARCHAR(01)    -- (필수) 구분(생산실적 : '1', 생산검사 : '2')
                  , @REQ_NUM        NVARCHAR(20)    -- (필수) 생산실적번호
                  , @INSPEC_NUM     NVARCHAR(20)    -- (필수) 검사번호
                  , @DIV_NAME       NVARCHAR(50)

            SET @COMP_CODE  = #{S_COMP_CODE}
            SET @DIV_CODE   = #{DIV_CODE}
            SET @GUBUN      = '1'
            SET @REQ_NUM    = #{S_REQ_NUM}
            SET @DIV_NAME   = (SELECT DIV_NAME FROM BOR120T WHERE COMP_CODE = @COMP_CODE AND DIV_CODE = @DIV_CODE)

      			SELECT  0                                                          AS INOUT_SEQ        ---순번
                      ,  @GUBUN                                                      AS GUBUN            --구분(1 : 생산실적, 2 : 생산검사)
                      ,  ''                                                          AS INOUT_DATE       ---입고일
                      ,  'KRW'                                                       AS MONEY_UNIT       ---화폐단위
                      ,  1                                                           AS EXCHG_RATE_O     ---환율
                      ,  A.COMP_CODE                                                 AS COMP_CODE         ---법인
                      ,  A.DIV_CODE                                                  AS DIV_CODE         ---사업장
                      ,  X.REQ_NUM
                      ,  '*' + X.REQ_NUM + '*'                                       AS BARCODE_PRODT_NUM
                      ,  '*' + '' + '*'                                              AS BARCODE_INSPEC_NUM
                      ,  @DIV_NAME                                                   AS DIV_NAME
                      ,  ROW_NUMBER() OVER(ORDER BY A.COMP_CODE, A.DIV_CODE, A.ITEM_CODE) AS SEQ
                      ,  X.REMARK
                      ,  A.PRODT_NUM                                                 AS PRODT_NUM        ---생산실적번호
                      ,  A.WKORD_NUM                                                 AS WKORD_NUM        ---작업지시번호
                      ,  A.ITEM_CODE                                                 AS ITEM_CODE        ---품목코드
                      ,  C1.ITEM_NAME                                                AS ITEM_NAME        ---품목명
                      ,  C1.SPEC                                                     AS SPEC             ---규격
                      ,  C1.STOCK_UNIT                                               AS ORDER_UNIT       ---단위
                      ,  ISNULL(C2.BASIS_P, 0)                                       AS ORDER_UNIT_P     ---단가(기준단가)
                      ,  C2.ITEM_ACCOUNT                                             AS ITEM_ACCOUNT     ---품목계정
                      --,  A.PRODT_DATE                                                AS PRODT_DATE       ---실적일자
                      ,  uniLITE.fnGetUserDateComp(A.COMP_CODE, A.PRODT_DATE)        AS PRODT_DATE       ---실적일자
                      ,  ''                                                          AS INSPEC_DATE      ---검사일자
                      ,  A.PRODT_Q                                                   AS PRODT_Q          ---실적량
                      ,  A.GOOD_PRODT_Q                                              AS GOOD_PRODT_Q     ---합격수량
                      ,  A.BAD_PRODT_Q                                               AS BAD_PRODT_Q      ---불량수량
                      ,  ISNULL(A.GOOD_PRODT_Q, 0) - ISNULL(B.GOOD_INOUT_Q, 0)       AS NOT_INSTOCK_Q    ---미입고수량
                      ,  ISNULL(B.GOOD_INOUT_Q, 0)                                   AS INSTOCK_Q        ---입고수량
                      ,  0                                                           AS ORDER_UNIT_Q     ---수량
                      ,  '1'                                                         AS ITEM_STATUS      ---품목상태
                      ,  A.WORK_SHOP_CODE                                            AS WORK_SHOP_CODE   ---작업장코드
                      ,  C3.TREE_NAME                                                AS WORK_SHOP_NAME   ---작업장명
                      ,  C2.WH_CODE                                                  AS WH_CODE          ---창고코드
                      ,  ''                                                          AS WH_NAME          ---창고명
                      ,  A.PROJECT_NO                                                AS PROJECT_NO       ---프로젝트번호
                      ,  A.LOT_NO                                                    AS LOT_NO           ---LOT번호
                      ,  A.WKORD_NUM                                                 AS ORDER_NUM        ---작업지시번호
                      ,  0                                                           AS ORDER_SEQ        ---/
                      ,  A.PRODT_NUM                                                 AS BASIS_NUM        ---근거번호
                      ,  0                                                           AS BASIS_SEQ        ---근거순번
                      ,  ''                                                          AS INSPEC_NUM       ---검사번호
                      ,  0                                                           AS INSPEC_SEQ       ---검사순번
                      ,  A.WORK_SHOP_CODE                                            AS INOUT_CODE       ---수불처(작업장)
                      ,  C1.OEM_ITEM_CODE
              FROM               PMR200T A  WITH (NOLOCK)
      				INNER JOIN L_PMR928T_KD X WITH (NOLOCK) ON A.COMP_CODE=X.COMP_CODE AND A.DIV_CODE=X.DIV_CODE AND A.PRODT_NUM=X.PRODT_NUM
                      LEFT  JOIN (
                                  SELECT  COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                          ,  SUM(INOUT_Q) AS GOOD_INOUT_Q
                                  FROM    BTR100T WITH (NOLOCK)
                                  WHERE   COMP_CODE   = @COMP_CODE
                                  AND     DIV_CODE    = @DIV_CODE
                                  AND     INOUT_TYPE  = '1'
                                  AND     CREATE_LOC  = '1'
                                  AND     ITEM_STATUS = '1'
                                  GROUP   BY COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                  )       B               ON A.COMP_CODE   = B.COMP_CODE
                                                          AND A.DIV_CODE    = B.DIV_CODE
                                                          AND A.PRODT_NUM   = B.BASIS_NUM
                      INNER JOIN BPR100T C1 WITH (NOLOCK) ON C1.COMP_CODE  = A.COMP_CODE
                                                          AND C1.ITEM_CODE  = A.ITEM_CODE
                      INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE  = A.COMP_CODE
                                                          AND C2.DIV_CODE   = A.DIV_CODE
                                                          AND C2.ITEM_CODE  = A.ITEM_CODE
                      INNER JOIN BSA230T C3 WITH (NOLOCK) ON C3.COMP_CODE  = A.COMP_CODE
                                                          AND C3.TYPE_LEVEL = A.DIV_CODE
                                                          AND C3.TREE_CODE  = A.WORK_SHOP_CODE
              WHERE   A.COMP_CODE                 = @COMP_CODE
              AND     A.DIV_CODE                  = @DIV_CODE
              --AND     A.PRODT_NUM                 = @PRODT_NUM
      		    AND	    X.REQ_NUM                   = @REQ_NUM

            SET NOCOUNT OFF
            SET ARITHABORT OFF
        END
        ]]>
    </select>

    <select id="s_pmr928rkrv_kdServiceImpl.selectList2" parameterType="Map" resultType="rMap">
    	<![CDATA[

        --s_pmr928rkrv_kdServiceImpl.selectList2
        BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @COMP_CODE      NVARCHAR(08)    -- (필수) 법인코드
                  , @DIV_CODE       NVARCHAR(08)    -- (필수) 사업장코드
                  , @GUBUN          NVARCHAR(01)    -- (필수) 구분(생산실적 : '1', 생산검사 : '2')
                  , @FR_DATE        NVARCHAR(08)    -- (필수) FROM_DATE
                  , @TO_DATE        NVARCHAR(08)    -- (필수) TO_DATE
                  , @ITEM_ACCOUNT    NVARCHAR(08)    -- (필수) 품목코드

            SET @COMP_CODE  = #{S_COMP_CODE}
            SET @DIV_CODE   = #{DIV_CODE}
            SET @GUBUN      = #{GUBUN}
            SET @FR_DATE    = #{FR_DATE}
            SET @TO_DATE    = #{TO_DATE}
            SET @ITEM_ACCOUNT = #{ITEM_ACCOUNT}

            SELECT 0                                                     AS INOUT_SEQ        ---순번
                 ,  ''                                                      AS INOUT_DATE       ---입고일
                 ,  ISNULL(C6.SUB_CODE, 'KRW')                              AS MONEY_UNIT       ---화폐단위
                 ,  1                                                       AS EXCHG_RATE_O     ---환율
                 ,  A.COMP_CODE                                             AS COMP_CODE        ---법인
                 ,  A.DIV_CODE                                              AS DIV_CODE         ---사업장
                 ,  A.PRODT_NUM                                             AS PRODT_NUM        ---생산실적번호
                 ,  A.WKORD_NUM                                             AS WKORD_NUM        ---작업지시번호
                 ,  A.ITEM_CODE                                             AS ITEM_CODE        ---품목코드
                 ,  C2.ITEM_NAME                                            AS ITEM_NAME        ---품목명
                 ,  C2.SPEC                                                 AS SPEC             ---규격
                 ,  C2.STOCK_UNIT                                           AS ORDER_UNIT       ---단위
                 ,  ISNULL(C1.BASIS_P, 0)                                   AS ORDER_UNIT_P     ---단가(기준단가)
                 ,  C1.ITEM_ACCOUNT                                         AS ITEM_ACCOUNT     ---품목계정
                 ,  A.PRODT_DATE                                            AS PRODT_DATE       ---실적일자
                 ,  B.INSPEC_DATE                                           AS INSPEC_DATE      ---검사일자
                 ,  A.PRODT_Q                                               AS PRODT_Q          ---실적량
                 ,  B.GOOD_INSPEC_Q                                         AS GOOD_INSPEC_Q    ---합격수량
                 ,  B.BAD_INSPEC_Q                                          AS BAD_INSPEC_Q     ---불량수량
                 ,  B.GOOD_INSPEC_Q - ISNULL(D.GOOD_INOUT_Q, 0)             AS NOT_INSTOCK_Q    ---미입고량
                 ,  ISNULL(D.GOOD_INOUT_Q, 0)                               AS INSTOCK_Q        ---입고량
                 ,  0                                                       AS ORDER_UNIT_Q     ---수량
                 ,  '1'                                                     AS ITEM_STATUS      ---품목상태
                 ,  A.WORK_SHOP_CODE                                        AS WORK_SHOP_CODE   ---작업장코드
                 ,  C3.TREE_NAME                                            AS WORK_SHOP_NAME   ---작업장명
                 ,  C1.WH_CODE                                              AS WH_CODE          ---창고코드
                 ,  C4.TREE_NAME                                            AS WH_NAME          ---창고명
                 ,  A.PROJECT_NO                                            AS PROJECT_NO       ---프로젝트번호
                 ,  A.LOT_NO                                                AS LOT_NO           ---LOT번호
                 ,  NULL                                                    AS ORDER_NUM        ---재고이동 요청번호
                 ,  0                                                       AS ORDER_SEQ        ---재고이동 요청순번
                 ,  A.PRODT_NUM                                             AS BASIS_NUM        ---근거번호
                 ,  0                                                       AS BASIS_SEQ        ---근거순번
                 ,  B.INSPEC_NUM                                            AS INSPEC_NUM       ---검사번호
                 ,  B.INSPEC_SEQ                                            AS INSPEC_SEQ       ---검사순번
                 ,  A.WORK_SHOP_CODE                                        AS INOUT_CODE       ---수불처(작업장)
                 ,  C2.OEM_ITEM_CODE
            FROM               PMR200T A  WITH (NOLOCK)
                    INNER JOIN QMS400T B  WITH (NOLOCK) ON B.COMP_CODE      = A.COMP_CODE
                                                       AND B.DIV_CODE       = A.DIV_CODE
                                                       AND B.PRODT_NUM      = A.PRODT_NUM
                                                       AND B.WKORD_NUM      = A.WKORD_NUM
                    INNER JOIN BPR200T C1 WITH (NOLOCK) ON C1.COMP_CODE     = A.COMP_CODE
                                                       AND C1.DIV_CODE      = A.DIV_CODE
                                                       AND C1.ITEM_CODE     = A.ITEM_CODE
                    INNER JOIN BPR100T C2 WITH (NOLOCK) ON C2.COMP_CODE     = A.COMP_CODE
                                                       AND C2.ITEM_CODE     = A.ITEM_CODE
                    LEFT  JOIN BSA230T C3 WITH (NOLOCK) ON C3.COMP_CODE     = A.COMP_CODE
                                                       AND C3.TYPE_LEVEL    = A.DIV_CODE
                                                       AND C3.TREE_CODE     = A.WORK_SHOP_CODE
                    LEFT  JOIN BSA220T C4 WITH (NOLOCK) ON C4.COMP_CODE     = C1.COMP_CODE
                                                       AND C4.TYPE_LEVEL    = C1.DIV_CODE
                                                       AND C4.TREE_CODE     = C1.WH_CODE
                    LEFT  JOIN BSA100T C5 WITH (NOLOCK) ON C5.COMP_CODE     = A.COMP_CODE
                                                       AND C5.MAIN_CODE     = N'P007'
                                                       AND C5.SUB_CODE      = N'1'
                                                       AND C5.REF_CODE1     = N'Y'
                    LEFT  JOIN BSA100T C6 WITH (NOLOCK) ON A.COMP_CODE      = C6.COMP_CODE
                                                       AND C6.MAIN_CODE     = 'B004'
                                                       AND C6.SUB_CODE     <> '$'
                                                       AND C6.REF_CODE1     = 'Y'
                    LEFT  JOIN (
                                SELECT  COMP_CODE, DIV_CODE, BASIS_NUM, BASIS_SEQ, INSPEC_NUM, INSPEC_SEQ
                                     ,  SUM(CASE WHEN ITEM_STATUS = '1' THEN INOUT_Q ELSE 0 END) AS GOOD_INOUT_Q
                                     ,  SUM(CASE WHEN ITEM_STATUS = '2' THEN INOUT_Q ELSE 0 END) AS BAD_INOUT_Q
                                FROM    BTR100T WITH (NOLOCK)
                                WHERE   COMP_CODE  = @COMP_CODE
                                AND     DIV_CODE   = @DIV_CODE
                                AND     INOUT_TYPE = '1'   -- 입고
                                AND     CREATE_LOC = '1'   -- 영업
                                AND     INOUT_NUM  > ' ' AND INOUT_SEQ > 0 AND INSPEC_NUM > '' AND BASIS_NUM  > ''
                                GROUP   BY COMP_CODE, DIV_CODE, BASIS_NUM, BASIS_SEQ, INSPEC_NUM, INSPEC_SEQ
                                )      D                ON D.COMP_CODE      = B.COMP_CODE
                                                       AND D.DIV_CODE       = B.DIV_CODE
                                                       AND D.INSPEC_NUM     = B.INSPEC_NUM
                                                       AND D.INSPEC_SEQ     = B.INSPEC_SEQ
                                                       AND D.BASIS_NUM      = B.PRODT_NUM
                                                       AND D.BASIS_SEQ      = 0

            WHERE   A.COMP_CODE                 = @COMP_CODE
            AND     A.DIV_CODE                  = @DIV_CODE
            AND     ISNULL(C1.INSPEC_YN, 'N')   = 'Y'
--            AND     @GUBUN                      = '2'
            AND     B.INSPEC_DATE              >= @FR_DATE
            AND     B.INSPEC_DATE              <= @TO_DATE
            AND     C1.ITEM_ACCOUNT             = @ITEM_ACCOUNT
        --    AND     B.GOOD_INSPEC_Q - ISNULL(D.GOOD_INOUT_Q, 0) > 0

            -- 생산실적(양품/불량)내역 조회
            UNION ALL

            SELECT  *
            FROM    (
                    SELECT 0                                                          AS INOUT_SEQ        ---순번
                         ,  ''                                                          AS INOUT_DATE       ---입고일
                         ,  'KRW'                                                       AS MONEY_UNIT       ---화폐단위
                         ,  1                                                           AS EXCHG_RATE_O     ---환율
                         ,  A.COMP_CODE                                                 AS COMP_CODE         ---법인
                         ,  A.DIV_CODE                                                  AS DIV_CODE         ---사업장
                         ,  A.PRODT_NUM                                                 AS PRODT_NUM        ---생산실적번호
                         ,  A.WKORD_NUM                                                 AS WKORD_NUM        ---작업지시번호
                         ,  A.ITEM_CODE                                                 AS ITEM_CODE        ---품목코드
                         ,  C1.ITEM_NAME                                                AS ITEM_NAME        ---품목명
                         ,  C1.SPEC                                                     AS SPEC             ---규격
                         ,  C1.STOCK_UNIT                                               AS ORDER_UNIT       ---단위
                         ,  ISNULL(C2.BASIS_P, 0)                                       AS ORDER_UNIT_P     ---단가(기준단가)
                         ,  C2.ITEM_ACCOUNT                                             AS ITEM_ACCOUNT     ---품목계정
                         ,  A.PRODT_DATE                                                AS PRODT_DATE       ---실적일자
                         ,  ''                                                          AS INSPEC_DATE      ---검사일자
                         ,  A.PRODT_Q                                                   AS PRODT_Q          ---실적량
                         ,  A.GOOD_PRODT_Q                                              AS GOOD_PRODT_Q     ---합격수량
                         ,  A.BAD_PRODT_Q                                               AS BAD_PRODT_Q      ---불량수량
                         ,  ISNULL(A.GOOD_PRODT_Q, 0) - ISNULL(B.GOOD_INOUT_Q, 0)       AS NOT_INSTOCK_Q    ---미입고수량
                         ,  ISNULL(B.GOOD_INOUT_Q, 0)                                   AS INSTOCK_Q        ---입고수량
                         ,  0                                                           AS ORDER_UNIT_Q     ---수량
                         ,  '1'                                                         AS ITEM_STATUS      ---품목상태
                         ,  A.WORK_SHOP_CODE                                            AS WORK_SHOP_CODE   ---작업장코드
                         ,  C3.TREE_NAME                                                AS WORK_SHOP_NAME   ---작업장명
                         ,  C2.WH_CODE                                                  AS WH_CODE          ---창고코드
                         ,  ''                                                          AS WH_NAME          ---창고명
                         ,  A.PROJECT_NO                                                AS PROJECT_NO       ---프로젝트번호
                         ,  A.LOT_NO                                                    AS LOT_NO           ---LOT번호
                         ,  A.WKORD_NUM                                                 AS ORDER_NUM        ---작업지시번호
                         ,  0                                                           AS ORDER_SEQ        ---/
                         ,  A.PRODT_NUM                                                 AS BASIS_NUM        ---근거번호
                         ,  0                                                           AS BASIS_SEQ        ---근거순번
                         ,  ''                                                          AS INSPEC_NUM       ---검사번호
                         ,  0                                                           AS INSPEC_SEQ       ---검사순번
                         ,  A.WORK_SHOP_CODE                                            AS INOUT_CODE       ---수불처(작업장)
                         ,  C1.OEM_ITEM_CODE
                    FROM              PMR200T A  WITH (NOLOCK)
                            LEFT  JOIN (
                                        SELECT  COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                             ,  SUM(INOUT_Q) AS GOOD_INOUT_Q
                                        FROM    BTR100T WITH (NOLOCK)
                                        WHERE   COMP_CODE   = @COMP_CODE
                                        AND     DIV_CODE    = @DIV_CODE
                                        AND     INOUT_TYPE  = '1'
                                        AND     CREATE_LOC  = '1'
                                        AND     ITEM_STATUS = '1'
                                        GROUP   BY COMP_CODE, DIV_CODE, BASIS_NUM, ITEM_STATUS
                                        )       B               ON A.COMP_CODE   = B.COMP_CODE
                                                               AND A.DIV_CODE    = B.DIV_CODE
                                                               AND A.PRODT_NUM   = B.BASIS_NUM
                            INNER JOIN BPR100T C1 WITH (NOLOCK) ON C1.COMP_CODE  = A.COMP_CODE
                                                               AND C1.ITEM_CODE  = A.ITEM_CODE
                            INNER JOIN BPR200T C2 WITH (NOLOCK) ON C2.COMP_CODE  = A.COMP_CODE
                                                               AND C2.DIV_CODE   = A.DIV_CODE
                                                               AND C2.ITEM_CODE  = A.ITEM_CODE
                            INNER JOIN BSA230T C3 WITH (NOLOCK) ON C3.COMP_CODE  = A.COMP_CODE
                                                               AND C3.TYPE_LEVEL = A.DIV_CODE
                                                               AND C3.TREE_CODE  = A.WORK_SHOP_CODE
                    WHERE   A.COMP_CODE                 = @COMP_CODE
                    AND     A.DIV_CODE                  = @DIV_CODE
                    AND     ISNULL(C2.INSPEC_YN, 'N')   = 'N'
--                    AND     @GUBUN                      = '1'
                    AND     A.PRODT_DATE               >= @FR_DATE
                    AND     A.PRODT_DATE               <= @TO_DATE
                    AND     C2.ITEM_ACCOUNT             = @ITEM_ACCOUNT
                --    AND     A.GOOD_PRODT_Q - ISNULL(B.GOOD_INOUT_Q, 0) > 0
                     ) A

            SET NOCOUNT OFF
            SET ARITHABORT OFF
        END
        ]]>
	</select>
	<insert id="s_pmr928rkrv_kdServiceImpl.insertL_PMR928T_KD" parameterType="Map" >

		INSERT INTO L_PMR928T_KD
		     ( COMP_CODE
		     , DIV_CODE
		     , REQ_NUM
		     , REQ_SEQ
		     , PRODT_NUM
		     , ITEM_CODE
		     , REF_INOUT_NUM
		     , REF_INOUT_SEQ
		     , REMARK
		     , INSERT_DB_USER
		     , INSERT_DB_TIME
		     , UPDATE_DB_USER
		     , UPDATE_DB_TIME
		     )
		VALUES
		     ( #{COMP_CODE}
		     , #{DIV_CODE}
		     , #{REQ_NUM}
		     , #{REQ_SEQ}
		     , #{PRODT_NUM}
		     , #{ITEM_CODE}
		     , #{REF_INOUT_NUM}
		     , #{REF_INOUT_SEQ}
		     , #{REMARK}
		     , #{S_USER_ID}
		     , GETDATE()
		     , #{S_USER_ID}
		     , GETDATE()
		     )

	</insert>
	 <select id="s_pmr928rkrv_kdServiceImpl.selectAutoReqNum" parameterType="Map" resultType="String">

	 	/*
		입고요청번호채번
		*/

		DECLARE @COMP_CODE NVARCHAR(8)
		, @DIV_CODE NVARCHAR(8)
		, @REQ_DATE NVARCHAR(8)
		, @REQ_NUM NVARCHAR(20)

		SET @COMP_CODE = #{S_COMP_CODE}
		SET @DIV_CODE =  #{S_DIV_CODE}
		SET @REQ_DATE = CONVERT(VARCHAR(8), GETDATE(), 112)
		EXEC uniLITE.SP_GetAutoNumComp @COMP_CODE, @DIV_CODE, 'L_PMR928T_KD', 'R', @REQ_DATE, '1', @REQ_NUM OUTPUT     -- 일채번
		SELECT @REQ_NUM



	 </select>
</mapper>