<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ssa100ukrvServiceImpl">
	<select id="ssa100ukrvServiceImpl.selectMaster" parameterType="Map" resultType="rMap">
		 /*ssa100ukrv.Cssa100ukrv[fnSsa100QStd] Query1*/
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /* 데이터 조회 */
		    SELECT A.DIV_CODE
		         , A.BILL_NUM
		         , A.BILL_TYPE
		         , A.SALE_DATE
		         , A.ORDER_TYPE
		         , A.SALE_CUSTOM_CODE
		         , CASE WHEN @RefItem = '0' THEN C1.CUSTOM_NAME
		                WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                    ELSE C1.CUSTOM_NAME
		           END                                              As CUSTOM_NAME
		         , A.MONEY_UNIT
		         , A.EXCHG_RATE_O
		         , A.VAT_RATE
		         , A.SALE_PRSN
		         , A.TAX_TYPE
		         , A.CARD_CUST_CD
		         , C2.CREDIT_NAME                                   AS CARD_CUST_NM
		         , A.PROJECT_NO
		         --20200103 추가: 프로젝트명 가져오기 위해 추가
		         , Z1.PJT_NAME
		         , A.REMARK
		         , A.EX_DATE
		         , A.EX_NUM
		         , A.AC_DATE
--		         , D.TREE_CODE	AS DEPT_CODE
--		         , D.TREE_NAME  AS DEPT_NAME
		         , SUM(CASE WHEN B.TAX_TYPE = '1' THEN ISNULL(B.SALE_LOC_AMT_I, 0)
		                    ELSE 0
		               END)                                         AS TOT_SALE_TAX_I
		         , SUM(CASE WHEN B.TAX_TYPE = '2' THEN ISNULL(B.SALE_LOC_AMT_I, 0)
		                    ELSE 0
		               END)                                         AS TOT_SALE_EXP_I
		         , SUM(CASE WHEN B.TAX_TYPE = '1' THEN ISNULL(B.TAX_AMT_O, 0)
		                    ELSE 0
		               END)                                         AS TOT_TAX_AMT
		         , SUM(CASE WHEN B.TAX_TYPE = '1' THEN ISNULL(B.SALE_AMT_O, 0)
		                    ELSE 0
		               END)                                         AS TOT_SALE_TAX_O
		         , SUM(CASE WHEN B.TAX_TYPE = '2' THEN ISNULL(B.SALE_AMT_O, 0)
		                    ELSE 0
		               END)                                         AS TOT_SALE_EXP_O
		         , M1.CODE_NAME                                     AS CARD_NM
		         --20200629 추가: 구매확인서 번호, 발급일자
		         , A.PURCH_DOC_NO
		         , A.ISSUE_DATE
		         -- 20210222 : 카드사(CARD_CUSTOM_CODE) 추가
		         , A.CARD_CUSTOM_CODE
		         
		         -- 20210705 : 결제조건, 결제예정일 추가
		         , A.PAYMENT_TERM
		         , A.PAYMENT_DAY
		    FROM              SSA100T  A  WITH (NOLOCK)
		           INNER JOIN SSA110T  B  WITH (NOLOCK) ON B.COMP_CODE    = A.COMP_CODE
		                                               AND B.DIV_CODE     = A.DIV_CODE
		                                               AND B.BILL_NUM     = A.BILL_NUM
		           LEFT  JOIN BCM100T  C1 WITH (NOLOCK) ON C1.COMP_CODE   = A.COMP_CODE
		                                               AND C1.CUSTOM_CODE = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BCM200T  C2 WITH (NOLOCK) ON C2.COMP_CODE   = A.COMP_CODE
		                                               AND A.CARD_CUST_CD = C2.CREDIT_CODE + C2.CARD_COMP_CODE
		           LEFT  JOIN BSA100T  M1 WITH (NOLOCK) ON M1.COMP_CODE   = C2.COMP_CODE
		                                               AND M1.MAIN_CODE   = 'A028'                          /* 단가유형*/
		                                               AND M1.SUB_CODE    = C2.CARD_COMP_CODE
--		           INNER JOIN BSA210T D WITH (NOLOCK)   ON D.COMP_CODE    = A.COMP_CODE
--		                                               AND D.TYPE_LEVEL   = A.DIV_CODE
--		                                               AND D.TREE_CODE 	  = A.DEPT_CODE
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           LEFT  JOIN BCM600T Z1 WITH(NOLOCK) ON Z1.COMP_CODE      = A.COMP_CODE
		                                             AND Z1.PJT_CODE       = A.PROJECT_NO
		     WHERE A.COMP_CODE = @CompCode
		<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		     AND   A.DIV_CODE  = #{DIV_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(BILL_NUM)">
		     AND   A.BILL_NUM  = #{BILL_NUM}
		</if>
		     GROUP BY A.DIV_CODE, A.BILL_NUM, A.BILL_TYPE, A.SALE_DATE, A.ORDER_TYPE, A.SALE_CUSTOM_CODE, A.MONEY_UNIT, A.EXCHG_RATE_O
		            , A.VAT_RATE, A.SALE_PRSN, A.TAX_TYPE, A.CARD_CUST_CD, C2.CREDIT_NAME, A.PROJECT_NO, A.REMARK, A.EX_DATE, A.EX_NUM, A.AC_DATE
		            , C1.CUSTOM_NAME, C1.CUSTOM_NAME1, C1.CUSTOM_NAME2, M1.CODE_NAME
		            --20200103 추가: 프로젝트명 가져오기 위해 추가
		            , Z1.PJT_NAME
		            --20200629 추가: 구매확인서 번호, 발급일자
		            , A.PURCH_DOC_NO
		            , A.ISSUE_DATE
		            -- 20210222 : 카드사(CARD_CUSTOM_CODE) 추가
		            , A.CARD_CUSTOM_CODE
		            -- 20210705 : 결제조건, 결제예정일 추가
		            , A.PAYMENT_TERM , A.PAYMENT_DAY
		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>

	<select id="ssa100ukrvServiceImpl.selectDetailList" parameterType="Map" resultType="rMap">
		/*ssa100ukrv.Cssa100ukrv[fnMakeQuery] Query1*/
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /*데이터 조회*/
		    SELECT B.BILL_SEQ
		         , B.INOUT_TYPE_DETAIL
		         , B.OUT_DIV_CODE
		         , B.WH_CODE
		         --20190906 추가
		         , B.WH_CELL_CODE
		         , B.ITEM_CODE
		         , CASE WHEN @RefItem = '1' THEN C1.ITEM_NAME1
		                WHEN @RefItem = '2' THEN C1.ITEM_NAME2
		                ELSE C1.ITEM_NAME
		           END                                               AS ITEM_NAME
		         , C1.SPEC
		         , B.SALE_UNIT
		         , B.PRICE_TYPE
		         , B.TRANS_RATE
		         , B.SALE_Q
		         , B.SALE_P
		         , ISNULL(B.SALE_WGT_Q    , 0)                       AS SALE_WGT_Q
		         , ISNULL(B.SALE_FOR_WGT_P, 0)                       AS SALE_FOR_WGT_P
		         , ISNULL(B.SALE_VOL_Q    , 0)                       AS SALE_VOL_Q
		         , ISNULL(B.SALE_FOR_VOL_P, 0)                       AS SALE_FOR_VOL_P
		         , ISNULL(B.SALE_WGT_P    , 0)                       AS SALE_WGT_P
		         , ISNULL(B.SALE_VOL_P    , 0)                       AS SALE_VOL_P
		         , B.SALE_AMT_O
		         , B.TAX_TYPE
		         , B.TAX_AMT_O
		         , (B.SALE_AMT_O + B.TAX_AMT_O)                      AS ORDER_O_TAX_O
		         , B.WGT_UNIT                                                                      /*중량단위*/
		         , ISNULL(B.UNIT_WGT, 0)                             AS UNIT_WGT                   /*단위중량*/
		         , B.VOL_UNIT                                                                      /*부피단위*/
		         , ISNULL(B.UNIT_VOL, 0)                             AS UNIT_VOL                   /*단위부피*/
		         , B.DISCOUNT_RATE
		         , ISNULL(D2.GOOD_STOCK_Q, 0)                        AS STOCK_Q
		         , B.DVRY_CUST_CD
		         , C2.DVRY_CUST_NM                                   AS DVRY_CUST_NAME
		         , B.PRICE_YN
		         , D1.LOT_NO
		         , B.INOUT_NUM
		         , B.INOUT_SEQ
		         , uniLITE.fnGetUserdate(B.COMP_CODE, D1.INOUT_DATE) AS INOUT_DATE
		         , B.ORDER_NUM
		         , B.PUB_NUM
		         , B.DIV_CODE
		         , B.BILL_NUM
		         , B.SALE_LOC_AMT_I
		         , B.INOUT_TYPE
		         , B.SER_NO
		         , C1.STOCK_UNIT
		         , D1.ITEM_STATUS
		         , D1.ACCOUNT_YNC
		         , B.SALE_Q                                          AS ORIGIN_Q
		         --20191021 수정
		         , B.ORDER_PRSN                                      AS REF_SALE_PRSN
		         --, A.SALE_PRSN                                       AS REF_SALE_PRSN
		         , A.SALE_CUSTOM_CODE                                AS REF_CUSTOM_CODE
		         , A.SALE_DATE                                       AS REF_SALE_DATE
		         , A.BILL_TYPE                                       AS REF_BILL_TYPE
		         , A.CARD_CUST_CD                                    AS REF_CARD_CUST_CD
		         , A.ORDER_TYPE                                      AS REF_SALE_TYPE
		         , B.PROJECT_NO                                      AS REF_PROJECT_NO
		         --20200103 추가: 프로젝트명 가져오기 위해 추가
		         , Z1.PJT_NAME
		         , A.TAX_TYPE                                        AS REF_TAX_INOUT
		         --20191210 수정
		         , B.REMARK                                          AS REF_REMARK
		         , A.EX_NUM                                          AS REF_EX_NUM
		         , A.MONEY_UNIT                                      AS REF_MONEY_UNIT
		         , A.EXCHG_RATE_O                                    AS REF_EXCHG_RATE_O
		         , ISNULL(C1.STOCK_CARE_YN, 'Y')                     AS STOCK_CARE_YN
		         , CASE WHEN D1.INOUT_TYPE = '2' THEN (ISNULL(D1.ORDER_UNIT_Q, 0) - ISNULL(D1.ACCOUNT_Q, 0))
		                WHEN D1.INOUT_TYPE = '3' THEN (ISNULL(D1.ORDER_UNIT_Q, 0) - ISNULL(D1.ACCOUNT_Q, 0)) * (-1)
		           END                                               AS UNSALE_Q
		         , B.UPDATE_DB_USER
		         , B.UPDATE_DB_TIME
		         , 'T'                                               AS DATA_REF_FLAG
		         , B.CUSTOM_CODE                                     AS SRC_CUSTOM_CODE
		         , CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                ELSE C4.CUSTOM_NAME
		           END                                               AS SRC_CUSTOM_NAME
		         , D4.ORDER_PRSN                                     AS SRC_ORDER_PRSN
		         , CASE WHEN ISNULL(M1.REF_CODE2, '') = '' THEN M1.SUB_CODE
		                                                   ELSE M1.REF_CODE2
		           END                                               AS REF_CODE2
		         , D3.ACCOUNT_YNC                                    AS SOF110T_ACCOUNT_YNC
		         , B.COMP_CODE
		         , D1.INOUT_CODE                                     AS INOUT_CUSTOM_CODE
		         , CASE WHEN @RefItem = '1' THEN C3.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C3.CUSTOM_NAME2
		                ELSE C3.CUSTOM_NAME
		           END                                               AS INOUT_CUSTOM_NAME
		         , C3.AGENT_TYPE                                     AS INOUT_AGENT_TYPE
		         , B.ADVAN_YN                                        AS ADVAN_YN
		         , 'FEFER'                                           AS GUBUN
		         , B.WARR_MONTH
		         -- 20210222 : CARD_CUSTOM_CODE(카드사 ) 추가
		         , A.CARD_CUSTOM_CODE
		    FROM              SSA100T  A  WITH (NOLOCK)
		           INNER JOIN SSA110T  B  WITH (NOLOCK) ON B.COMP_CODE    = A.COMP_CODE
		                                               AND B.DIV_CODE     = A.DIV_CODE
		                                               AND B.BILL_NUM     = A.BILL_NUM
		           LEFT  JOIN BTR100T  D1 WITH (NOLOCK) ON D1.COMP_CODE   = B.COMP_CODE
		                                               AND D1.SALE_DIV_CODE    = B.DIV_CODE
		                                               AND D1.INOUT_NUM   = B.INOUT_NUM
		                                               AND D1.INOUT_SEQ   = B.INOUT_SEQ
		                                               AND D1.INOUT_TYPE  = B.INOUT_TYPE
		           LEFT  JOIN BIV100T  D2 WITH (NOLOCK) ON D2.COMP_CODE   = B.COMP_CODE
		                                               AND D2.DIV_CODE    = B.OUT_DIV_CODE
		                                               AND D2.WH_CODE     = B.WH_CODE
		                                               AND D2.ITEM_CODE   = B.ITEM_CODE
		           LEFT  JOIN SOF110T  D3 WITH (NOLOCK) ON D3.COMP_CODE   = B.COMP_CODE
		                                               AND D3.DIV_CODE    = B.DIV_CODE
		                                               AND D3.ORDER_NUM   = B.ORDER_NUM
		                                               AND D3.SER_NO      = B.SER_NO
		           LEFT  JOIN SOF100T  D4 WITH (NOLOCK) ON D4.COMP_CODE   = D3.COMP_CODE
		                                               AND D4.DIV_CODE    = D3.DIV_CODE
		                                               AND D4.ORDER_NUM   = D3.ORDER_NUM
		           LEFT  JOIN BPR100T  C1 WITH (NOLOCK) ON C1.COMP_CODE   = B.COMP_CODE
		                                               AND C1.ITEM_CODE   = B.ITEM_CODE
		           LEFT  JOIN SCM100T  C2 WITH (NOLOCK) ON C2.COMP_CODE   = B.COMP_CODE
		                                               AND C2.CUSTOM_CODE = B.CUSTOM_CODE
		                                               AND CONVERT(NVARCHAR(08), C2.DVRY_CUST_SEQ) = B.DVRY_CUST_CD
		           LEFT  JOIN BCM100T  C3 WITH (NOLOCK) ON C3.COMP_CODE   = D1.COMP_CODE
		                                               AND C3.CUSTOM_CODE = D1.INOUT_CODE
		           LEFT  JOIN BCM100T  C4 WITH (NOLOCK) ON C4.COMP_CODE   = B.COMP_CODE
		                                               AND C4.CUSTOM_CODE = B.CUSTOM_CODE
		           LEFT  JOIN BSA100T  M1 WITH (NOLOCK) ON M1.COMP_CODE   = B.COMP_CODE
		                                               AND M1.MAIN_CODE   = 'S007'                          /* 단가유형*/
		                                               AND M1.SUB_CODE    = B.INOUT_TYPE_DETAIL
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           LEFT  JOIN BCM600T  Z1 WITH (NOLOCK) ON Z1.COMP_CODE   = B.COMP_CODE
		                                               AND Z1.PJT_CODE    = B.PROJECT_NO
		     WHERE  A.COMP_CODE = @CompCode
		<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		       AND A.DIV_CODE   = #{DIV_CODE}
		</if>
		<if test="@foren.Ognl@isNotEmpty(BILL_NUM)">
		       AND A.BILL_NUM   = #{BILL_NUM}
		</if>
		     ORDER BY B.BILL_SEQ

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>

	<select id="ssa100ukrvServiceImpl.selectSalesNumMaster" parameterType="Map" resultType="rMap">
		/* ssa101ukrv.Cssa101ukrv[fnSsa101QPop] Query1 */
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE	@CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /* 데이터 조회 */
		    SELECT A.DIV_CODE
		         , A.SALE_CUSTOM_CODE
		         , (CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                 WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                     ELSE C1.CUSTOM_NAME
		             END)                                            AS CUSTOM_NAME
		         , (SELECT TOP 1 ITEM_CODE FROM SSA110T WHERE COMP_CODE = A.COMP_CODE AND DIV_CODE = A.DIV_CODE AND BILL_NUM = A.BILL_NUM ORDER BY SER_NO) AS ITEM_CODE
		         , (SELECT ITEM_NAME
		              FROM BPR100T WITH(NOLOCK)
		             WHERE COMP_CODE = A.COMP_CODE
		               AND ITEM_CODE = (SELECT TOP 1 ITEM_CODE
		                                  FROM SSA110T WITH(NOLOCK)
		                                 WHERE COMP_CODE = A.COMP_CODE
		                                  AND DIV_CODE = A.DIV_CODE
		                                  AND BILL_NUM = A.BILL_NUM
		                                ORDER BY SER_NO))            AS ITEM_NAME
		         , (SELECT SPEC
		              FROM BPR100T WITH(NOLOCK)
		             WHERE COMP_CODE = A.COMP_CODE
		               AND ITEM_CODE = (SELECT TOP 1 ITEM_CODE
		                                  FROM SSA110T WITH(NOLOCK)
		                                 WHERE COMP_CODE = A.COMP_CODE
		                                   AND DIV_CODE = A.DIV_CODE
		                                   AND BILL_NUM = A.BILL_NUM
		                                  ORDER BY SER_NO))         AS SPEC
		         , CAST(A.SALE_DATE AS DATETIME)                    AS SALE_DATE
		         , A.BILL_TYPE
		         , A.ORDER_TYPE                                     AS SALE_TYPE
		         , M1.CODE_NAME                                     AS SALE_TYPE_NAME
		         , SUM(ISNULL(B.SALE_Q, 0))                         AS SALE_Q
		         , (A.SALE_AMT_O + ISNULL(A.SALE_LOC_EXP_I, 0) + A.TAX_AMT_O ) AS SALE_TOT_O
		         , A.SALE_LOC_AMT_I
		         , A.SALE_LOC_EXP_I
		         , A.TAX_AMT_O
		         , A.SALE_PRSN
		         , M2.CODE_NAME                                     AS SALE_PRSN_NAME
		         , A.BILL_NUM
		         , A.PROJECT_NO
--		         , B.INOUT_NUM
		         , C1.AGENT_TYPE
		         , C1.CREDIT_YN
		         , C1.WON_CALC_BAS
		         , C1.TAX_CALC_TYPE
		         , C1.TAX_TYPE
		         , A.PAYMENT_TERM
		         , A.PAYMENT_DAY
		    FROM              SSA100T  A  WITH (NOLOCK)
		           INNER JOIN SSA110T  B  WITH (NOLOCK) ON B.COMP_CODE    = A.COMP_CODE
		                                               AND B.DIV_CODE     = A.DIV_CODE
		                                               AND B.BILL_NUM     = A.BILL_NUM
		           INNER JOIN BCM100T  C1 WITH (NOLOCK) ON C1.COMP_CODE   = A.COMP_CODE
		                                               AND C1.CUSTOM_CODE = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BSA100T  M1 WITH (NOLOCK) ON M1.COMP_CODE   = A.COMP_CODE
		                                               AND M1.MAIN_CODE   = 'S002'                          /* 수주유형 */
		                                               AND M1.SUB_CODE    = A.ORDER_TYPE
		           LEFT  JOIN BSA100T  M2 WITH (NOLOCK) ON M2.COMP_CODE   = A.COMP_CODE
		                                               AND M2.MAIN_CODE   = 'S010'                          /* 영업담당 */
		                                               AND M2.SUB_CODE    = A.SALE_PRSN
		           LEFT  JOIN BPR100T  M3 WITH (NOLOCK) ON M3.COMP_CODE   = B.COMP_CODE
		                                               AND M3.ITEM_CODE   = B.ITEM_CODE
--		           INNER JOIN BSA210T D WITH (NOLOCK)   ON D.COMP_CODE    = A.COMP_CODE
--		                                               AND D.TYPE_LEVEL   = A.DIV_CODE
--		                                               AND D.TREE_CODE    = A.DEPT_CODE
		    WHERE  A.COMP_CODE           = @CompCode
		    <if test="@foren.Ognl@isNotEmpty(SALE_DATE_FR)">
		      AND    A.SALE_DATE       &gt;= #{SALE_DATE_FR} /* (필수) 시작 매출일 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(SALE_DATE_TO)">
		      AND    A.SALE_DATE       &lt;= #{SALE_DATE_TO} /* (필수) 종료 매출일 */
		    </if>
		      AND    A.DIV_CODE            = #{DIV_CODE}     /*(필수) 사업장코드 */
		      
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		      AND A.SALE_CUSTOM_CODE 		= #{CUSTOM_CODE}					/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
		      AND A.SALE_CUSTOM_CODE 		LIKE  #{CUSTOM_CODE} + '%'			/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME) and @foren.Ognl@isEmpty(CUSTOM_CODE)">
		      AND C1.CUSTOM_NAME	 		LIKE '%' + #{CUSTOM_NAME} + '%'		/* 거래처명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(SALE_PRSN)">
		      AND    A.SALE_PRSN           = #{SALE_PRSN}    /* 영업담당 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
		      AND    A.ORDER_TYPE          = #{ORDER_TYPE}   /* 판매유형 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(BILL_TYPE)">
		      AND    A.BILL_TYPE           = #{BILL_TYPE}    /* 부가세유형 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		      AND    A.PROJECT_NO       LIKE #{PROJECT_NO}   /* 관리번호 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_NUM)">
		      AND    B.INOUT_NUM        LIKE #{INOUT_NUM}    /* 출고번호 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(BILL_NUM)">
		      AND    A.BILL_NUM         LIKE #{BILL_NUM}     /* 매출번호 */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 		= #{ITEM_CODE}						/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 		LIKE #{ITEM_CODE} + '%'				/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
		    AND M3.ITEM_NAME 		LIKE '%' + #{ITEM_NAME} + '%'		/* 품목명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(DEPT_CODE)">    /*부서*/
		      AND    D.TREE_LEVEL          LIKE  (SELECT TREE_LEVEL FROM BSA210T WITH(NOLOCK) WHERE COMP_CODE =D.COMP_CODE AND TYPE_LEVEL=D.TYPE_LEVEL AND TREE_CODE = #{DEPT_CODE}) + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(TAX_TYPE2)">
		      AND    B.TAX_TYPE       = #{TAX_TYPE2} /* 과세구분 */
		    </if>
		    GROUP BY A.COMP_CODE    , A.DIV_CODE        , A.SALE_DATE   , A.BILL_TYPE       , A.ORDER_TYPE
		           , A.SALE_AMT_O   , A.SALE_LOC_EXP_I  , A.TAX_AMT_O   , A.SALE_LOC_AMT_I  , A.SALE_LOC_EXP_I
		           , A.TAX_AMT_O    , A.SALE_PRSN       , A.BILL_NUM    , A.PROJECT_NO      , A.SALE_CUSTOM_CODE
		           , C1.CUSTOM_NAME , M1.CODE_NAME      , M2.CODE_NAME  , C1.CUSTOM_NAME1
		           , C1.CUSTOM_NAME2, C1.AGENT_TYPE     , C1.CREDIT_YN  , C1.WON_CALC_BAS   , C1.TAX_CALC_TYPE
		           , C1.TAX_TYPE    , A.PAYMENT_TERM    , A.PAYMENT_DAY
		    ORDER BY C1.CUSTOM_NAME, A.SALE_DATE, A.BILL_NUM, A.SALE_AMT_O

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
    </select>

	<select id="ssa100ukrvServiceImpl.selectSalesNumDetail" parameterType="Map" resultType="rMap">
		/* ssa100ukrv.Cssa100ukrv[fnSsa100QPopDetail] Query1 */
		BEGIN
		     SET NOCOUNT ON
		     SET ARITHABORT ON

		     DECLARE    @CompCode    NVARCHAR(08) /* 법인코드    */
		              , @UserId      NVARCHAR(100) /* 사용자ID    */
		              , @LangType    NVARCHAR(2)  /* 언어구분    */
		              , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		              , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

		     SET @CompCode = #{S_COMP_CODE}
		     SET @UserId   = #{S_USER_ID}
		     SET @LangType = #{S_LANG_CODE}

		     /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')


		    SELECT A.DIV_CODE
		         , A.SALE_CUSTOM_CODE
		         , (CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                 WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                     ELSE C1.CUSTOM_NAME
		             END)                                           AS CUSTOM_NAME
		         , B.ITEM_CODE
		         , (CASE WHEN @RefItem = '1' THEN M3.ITEM_NAME1
		                 WHEN @RefItem = '2' THEN M3.ITEM_NAME2
		                                     ELSE M3.ITEM_NAME
		             END)                                           AS ITEM_NAME
		         , M3.SPEC
		         , CAST((CASE WHEN ISNULL(A.SALE_DATE, '') = ''
		                 THEN ''
		                 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.SALE_DATE, 1, 4))
		                                                         , 'MM'  , SUBSTRING(A.SALE_DATE, 5, 2))
		                                                         , 'DD'  , SUBSTRING(A.SALE_DATE, 7, 2))
		                  END)AS DATETIME)                          AS SALE_DATE
		         , A.BILL_TYPE
		         , A.ORDER_TYPE                                     AS SALE_TYPE
		         , M1.CODE_NAME                                     AS SALE_TYPE_NAME
		         , ISNULL(B.SALE_Q, 0)                              AS SALE_Q
		         , (A.SALE_AMT_O + A.SALE_LOC_EXP_I + A.TAX_AMT_O ) AS SALE_TOT_O
		         , A.SALE_LOC_AMT_I
		         , A.SALE_LOC_EXP_I
		         , A.TAX_AMT_O
		         , A.SALE_PRSN
		         , M2.CODE_NAME                                     AS SALE_PRSN_NAME
		         , A.BILL_NUM
		         , A.PROJECT_NO
		         , B.INOUT_NUM
		    FROM              SSA100T  A  WITH (NOLOCK)
		           INNER JOIN SSA110T  B  WITH (NOLOCK) ON B.COMP_CODE    = A.COMP_CODE
		                                               AND B.DIV_CODE     = A.DIV_CODE
		                                               AND B.BILL_NUM     = A.BILL_NUM
		           INNER JOIN BCM100T  C1 WITH (NOLOCK) ON C1.COMP_CODE   = A.COMP_CODE
		                                               AND C1.CUSTOM_CODE = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BSA100T  M1 WITH (NOLOCK) ON M1.COMP_CODE   = A.COMP_CODE
		                                               AND M1.MAIN_CODE   = 'S002'                          /* 수주유형 */
		                                               AND M1.SUB_CODE    = A.ORDER_TYPE
		           LEFT  JOIN BSA100T  M2 WITH (NOLOCK) ON M2.COMP_CODE   = A.COMP_CODE
		                                               AND M2.MAIN_CODE   = 'S010'                          /* 영업담당 */
		                                               AND M2.SUB_CODE    = A.SALE_PRSN
		           LEFT  JOIN BPR100T  M3 WITH (NOLOCK) ON M3.COMP_CODE   = B.COMP_CODE
		                                               AND M3.ITEM_CODE   = B.ITEM_CODE
--				   INNER JOIN BSA210T D WITH (NOLOCK)   ON D.COMP_CODE    = A.COMP_CODE
--		                                               AND D.TYPE_LEVEL   = A.DIV_CODE
--		                                               AND D.TREE_CODE    = A.DEPT_CODE
		    WHERE    A.COMP_CODE           = @CompCode       /* (필수) 법인코드 */
		    <if test="@foren.Ognl@isNotEmpty(SALE_DATE_FR)">
		      AND    A.SALE_DATE       &gt;= #{SALE_DATE_FR} /* (필수) 시작 매출일 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(SALE_DATE_TO)">
		      AND    A.SALE_DATE       &lt;= #{SALE_DATE_TO} /* (필수) 종료 매출일 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		      AND    A.DIV_CODE            = #{DIV_CODE}     /*(필수) 사업장코드 */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		      AND A.SALE_CUSTOM_CODE 		= #{CUSTOM_CODE}					/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
		      AND A.SALE_CUSTOM_CODE 		LIKE  #{CUSTOM_CODE} + '%'			/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME) and @foren.Ognl@isEmpty(CUSTOM_CODE)">
		      AND C1.CUSTOM_NAME 			LIKE '%' + #{CUSTOM_NAME} + '%'		/* 거래처명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(SALE_PRSN)">
		      AND    A.SALE_PRSN           = #{SALE_PRSN}    /* 영업담당 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
		      AND    A.ORDER_TYPE          = #{ORDER_TYPE}   /* 판매유형 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(BILL_TYPE)">
		      AND    A.BILL_TYPE           = #{BILL_TYPE}    /* 부가세유형 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		      AND    A.PROJECT_NO       LIKE #{PROJECT_NO}   /* 관리번호 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_NUM)">
		      AND    B.INOUT_NUM        LIKE #{INOUT_NUM}    /* 출고번호 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(BILL_NUM)">
		      AND    A.BILL_NUM         LIKE #{BILL_NUM}     /* 매출번호 */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
		      AND B.ITEM_CODE 		= #{ITEM_CODE}						/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
		      AND B.ITEM_CODE 		LIKE #{ITEM_CODE} + '%'				/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
		      AND M3.ITEM_NAME 		LIKE '%' + #{ITEM_NAME} + '%'		/* 품목명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(DEPT_CODE)">    /*부서*/
		      AND    D.TREE_LEVEL          LIKE  (SELECT TREE_LEVEL FROM BSA210T WITH(NOLOCK) WHERE COMP_CODE =D.COMP_CODE AND TYPE_LEVEL=D.TYPE_LEVEL AND TREE_CODE = #{DEPT_CODE}) + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(TAX_TYPE2)">
		      AND    B.TAX_TYPE       = #{TAX_TYPE2} /* 과세구분 */
		    </if>
		   ORDER BY C1.CUSTOM_NAME, A.SALE_DATE, A.BILL_NUM, B.ITEM_CODE
		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>

	<select id="ssa100ukrvServiceImpl.selectSalesOrderList" parameterType="Map" resultType="rMap">
		/* ssa100ukrv.Cssa100ukrv[fnSof101QRef] Query1 */
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode         NVARCHAR(08) /* 법인코드  */
		          , @UserId           NVARCHAR(100) /* 사용자ID */
		          , @LangType         NVARCHAR(2)  /* 언어구분  */
		          , @RefItem          NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat       NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @DIV_CODE         NVARCHAR(08) /* (필수) 사업장코드 */
		          , @FR_DVRY_DATE     NVARCHAR(08) /* 시작 납기일 */
		          , @TO_DVRY_DATE     NVARCHAR(08) /* 종료 납기일 */
		          , @ITEM_CODE        NVARCHAR(20) /* 품목코드 */

		    SET @CompCode     = #{S_COMP_CODE}
		    SET @UserId       = #{S_USER_ID}
		    SET @LangType     = #{S_LANG_CODE}
		    SET @DIV_CODE     = #{DIV_CODE}		/*마스터폼 정보*/
		    SET @FR_DVRY_DATE = #{FR_DVRY_DATE}
		    SET @TO_DVRY_DATE = #{TO_DVRY_DATE}
		    SET @ITEM_CODE    = #{ITEM_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /* 데이터 조회 */
		    SELECT CAST(0 AS BIT) AS CHOICE
		         , B.ORDER_NUM
		         , B.SER_NO
		         , B.SO_KIND
		         , ISNULL(C4.REF_CODE2,'') AS INOUT_TYPE_DETAIL
		         , B.ITEM_CODE
		         , (CASE WHEN @RefItem = '1' THEN C1.ITEM_NAME1
		                 WHEN @RefItem = '2' THEN C1.ITEM_NAME2
		                                     ELSE C1.ITEM_NAME
		            END)                                                                                    AS ITEM_NAME
		         , C1.SPEC
		         , B.ORDER_UNIT
		         , B.TRANS_RATE
		         , CAST(B.DVRY_DATE AS DATETIME) AS DVRY_DATE
		         , (B.ORDER_Q + B.RETURN_Q - B.OUTSTOCK_Q - (B.ISSUE_REQ_Q - ISNULL(SUM(D1.ISSUE_QTY), 0))) AS NOT_SALE_Q
		         , B.ORDER_Q
		         --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		         , B.PROJECT_NO
		         --20200103 추가: 프로젝트명 가져오기 위해 추가
		         , Z1.PJT_NAME
		         , (CASE WHEN @RefItem = '1' THEN C3.CUSTOM_NAME1
		                 WHEN @RefItem = '2' THEN C3.CUSTOM_NAME2
		                                     ELSE C3.CUSTOM_NAME
		            END)                                                                                    AS CUSTOM_NAME
		         , A.ORDER_PRSN
		         , B.PO_NUM
		         , A.CUSTOM_CODE
		         , B.OUT_DIV_CODE
		         , B.ORDER_P
		         , B.ORDER_O
		         , B.TAX_TYPE
		         , C2.WH_CODE                                                                                AS WH_CODE
		         , A.MONEY_UNIT
		         , A.EXCHG_RATE_O
		         , B.ACCOUNT_YNC
		         , B.DISCOUNT_RATE
		         , B.DVRY_CUST_CD
		         , A.BILL_TYPE
		         , A.ORDER_TYPE
		         , B.PRICE_YN
		         , ISNULL(C1.STOCK_CARE_YN, 'Y')                                                             AS STOCK_CARE_YN
		         , C1.STOCK_UNIT
		         , D2.DVRY_CUST_NM                                                                           AS DVRY_CUST_NAME
		         , A.TAX_INOUT
		         , B.ORDER_TAX_O
		    FROM              SOF100T  A  WITH (NOLOCK)
		           INNER JOIN SOF110T  B  WITH (NOLOCK) ON B.COMP_CODE       = A.COMP_CODE
		                                               AND B.DIV_CODE        = A.DIV_CODE
		                                               AND B.ORDER_NUM       = A.ORDER_NUM
		                                               AND B.ORDER_STATUS    = 'N'
		                                               AND ((@DIV_CODE      != '' AND B.OUT_DIV_CODE = @DIV_CODE)        OR (@DIV_CODE     = ''))
		                                               AND ((@FR_DVRY_DATE  != '' AND B.DVRY_DATE   &gt;= @FR_DVRY_DATE)    OR (@FR_DVRY_DATE = ''))
		                                               AND ((@TO_DVRY_DATE  != '' AND B.DVRY_DATE   &lt;= @TO_DVRY_DATE)    OR (@TO_DVRY_DATE = ''))
		                                               
		           LEFT  JOIN BPR100T  C1 WITH (NOLOCK) ON C1.COMP_CODE      = B.COMP_CODE
		                                               AND C1.ITEM_CODE      = B.ITEM_CODE
		           LEFT  JOIN BPR200T  C2 WITH (NOLOCK) ON C2.COMP_CODE      = B.COMP_CODE
		                                               AND C2.DIV_CODE       = B.OUT_DIV_CODE
		                                               AND C2.ITEM_CODE      = B.ITEM_CODE
		           LEFT  JOIN BCM100T  C3 WITH (NOLOCK) ON C3.COMP_CODE      = A.COMP_CODE
		                                               AND C3.CUSTOM_CODE    = A.CUSTOM_CODE
		           LEFT  JOIN BSA100T  C4 WITH (NOLOCK) ON C4.COMP_CODE      = B.COMP_CODE
		                                               AND C4.MAIN_CODE      = 'S065'
		                                               AND C4.SUB_CODE       = B.SO_KIND
		           LEFT  JOIN SRQ100T  D1 WITH (NOLOCK) ON D1.COMP_CODE      = B.COMP_CODE
		                                               AND D1.ISSUE_DIV_CODE = B.OUT_DIV_CODE
		                                               AND D1.ORDER_NUM      = B.ORDER_NUM
		                                               AND D1.SER_NO         = B.SER_NO
		           LEFT  JOIN SCM100T  D2 WITH (NOLOCK) ON D2.COMP_CODE      = A.COMP_CODE
		                                               AND D2.CUSTOM_CODE    = A.CUSTOM_CODE
		                                               AND CONVERT(NVARCHAR(08), D2.DVRY_CUST_SEQ) = B.DVRY_CUST_CD
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           LEFT  JOIN BCM600T  Z1 WITH (NOLOCK) ON Z1.COMP_CODE   = B.COMP_CODE
		                                               AND Z1.PJT_CODE    = B.PROJECT_NO
		    WHERE  A.COMP_CODE      = @CompCode
		    AND    (A.STATUS IS NULL OR A.STATUS = '6')
		    AND    A.MONEY_UNIT      = #{MONEY_UNIT}   	/*마스터폼(히든)*/
		    <if test="@foren.Ognl@isNotEmpty(TAX_INOUT)">
		    AND    A.TAX_INOUT       = #{TAX_INOUT}
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 		= @ITEM_CODE						/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 		LIKE @ITEM_CODE + '%'				/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
		    AND (CASE WHEN @RefItem = '1' THEN C1.ITEM_NAME1
		              WHEN @RefItem = '2' THEN C1.ITEM_NAME2
		                                  ELSE C1.ITEM_NAME
		         END) 			LIKE '%' + #{ITEM_NAME} + '%'		/* 품목명  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		    AND A.CUSTOM_CODE 		= #{CUSTOM_CODE}					/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
		    AND A.CUSTOM_CODE 		LIKE  #{CUSTOM_CODE} + '%'			/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME) and @foren.Ognl@isEmpty(CUSTOM_CODE)">
		    AND C3.CUSTOM_NAME 		LIKE '%' + #{CUSTOM_NAME} + '%'		/* 거래처명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
		    AND    A.ORDER_NUM    LIKE #{ORDER_NUM} + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		    --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		    AND    B.PROJECT_NO   LIKE #{PROJECT_NO} + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
		    AND     A.ORDER_PRSN 	= #{ORDER_PRSN}
		    </if>
		    GROUP BY B.ORDER_STATUS     , A.CUSTOM_CODE  , C3.CUSTOM_NAME , C3.CUSTOM_NAME1, C3.CUSTOM_NAME2,
		             B.ORDER_NUM        , B.SER_NO       , B.ITEM_CODE    , C1.ITEM_NAME, C1.ITEM_NAME1, C1.ITEM_NAME2
		           , C1.SPEC            , B.ORDER_UNIT   , B.TRANS_RATE
		           , B.DVRY_DATE        , B.ORDER_Q      , B.RETURN_Q     , B.OUTSTOCK_Q , B.ISSUE_REQ_Q
		           , B.PO_NUM           , B.OUT_DIV_CODE , B.ORDER_P      , B.ORDER_O    , B.TAX_TYPE
		           --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		           , B.PROJECT_NO
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           , Z1.PJT_NAME
		           , A.MONEY_UNIT   , A.EXCHG_RATE_O , B.ACCOUNT_YNC, A.ORDER_PRSN
		           , B.DVRY_CUST_CD     , A.BILL_TYPE    , A.ORDER_TYPE   , B.PRICE_YN   , B.DISCOUNT_RATE
		           , C1.STOCK_CARE_YN   , C1.STOCK_UNIT  , A.TAX_INOUT    , B.ORDER_TAX_O, B.COMP_CODE
		           , C2.WH_CODE         , D2.DVRY_CUST_NM, B.SO_KIND      , C4.REF_CODE2
		    HAVING B.ORDER_Q +
		    B.RETURN_Q - B.OUTSTOCK_Q - (B.ISSUE_REQ_Q - ISNULL(SUM(D1.ISSUE_QTY), 0)) &gt; 0
		    ORDER BY C3.CUSTOM_NAME, B.DVRY_DATE, B.ORDER_NUM, B.SER_NO

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
	</select>

	<select id="ssa100ukrvServiceImpl.selectPreviousSalesOrderList" parameterType="Map" resultType="rMap">
		/* ssa100ukrv.Cssa100ukrv[fnSof101QRef] Query1 */
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode         NVARCHAR(08) /* 법인코드  */
		          , @UserId           NVARCHAR(100) /* 사용자ID */
		          , @LangType         NVARCHAR(2)  /* 언어구분  */
		          , @RefItem          NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat       NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @DIV_CODE         NVARCHAR(08) /* (필수) 사업장코드 */
		          , @FR_DVRY_DATE     NVARCHAR(08) /* 시작 납기일 */
		          , @TO_DVRY_DATE     NVARCHAR(08) /* 종료 납기일 */
		          , @ITEM_CODE        NVARCHAR(20) /* 품목코드 */

		    SET @CompCode     = #{S_COMP_CODE}
		    SET @UserId       = #{S_USER_ID}
		    SET @LangType     = #{S_LANG_CODE}
		    SET @DIV_CODE     = #{DIV_CODE}		/*마스터폼 정보*/
		    SET @FR_DVRY_DATE = #{FR_DVRY_DATE}
		    SET @TO_DVRY_DATE = #{TO_DVRY_DATE}
		    SET @ITEM_CODE    = #{ITEM_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /* 데이터 조회 */
		    SELECT CAST(0 AS BIT) AS CHOICE
		         , B.ORDER_NUM
		         , B.SER_NO
		         , B.ITEM_CODE
		         , C1.ITEM_NAME
		         , C1.SPEC
		         , B.ORDER_UNIT
		         , B.TRANS_RATE
		         , CAST(B.DVRY_DATE AS DATETIME) AS DVRY_DATE
		         , (B.ORDER_Q - B.SALE_Q) AS NOT_SALE_Q
		         , B.ORDER_Q
		         --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		         , B.PROJECT_NO
		         --20200103 추가: 프로젝트명 가져오기 위해 추가
		         , Z1.PJT_NAME
		         , C3.CUSTOM_NAME
		         , A.ORDER_PRSN
		         , B.PO_NUM
		         , A.CUSTOM_CODE
		         , B.OUT_DIV_CODE
		         , B.ORDER_P
		         , B.ORDER_O
		         , ISNULL(B.ADVAN_AMOUNT, 0) AS ADVAN_AMOUNT
		         , (ISNULL(B.ORDER_O, 0) - ISNULL(B.ADVAN_AMOUNT, 0))  AS NOT_AMOUNT
		         , B.TAX_TYPE
		         , C2.WH_CODE                                                                                AS WH_CODE
		         , A.MONEY_UNIT
		         , A.EXCHG_RATE_O
		         , B.ACCOUNT_YNC
		         , B.DISCOUNT_RATE
		         , B.DVRY_CUST_CD
		         , A.BILL_TYPE
		         , A.ORDER_TYPE
		         , B.PRICE_YN
		         , ISNULL(C1.STOCK_CARE_YN, 'Y')                                                             AS STOCK_CARE_YN
		         , C1.STOCK_UNIT
		         , D2.DVRY_CUST_NM AS DVRY_CUST_NAME
		         , A.TAX_INOUT
		         , (ISNULL(B.ORDER_O, 0) - ISNULL(B.ADVAN_AMOUNT, 0)) * 0.1 AS ORDER_TAX_O
		         , C.INOUT_NUM
		         , C.INOUT_SEQ
		         , C.INOUT_DATE
		    FROM              SOF100T  A  WITH (NOLOCK)
		           INNER JOIN SOF110T  B  WITH (NOLOCK) ON B.COMP_CODE       = A.COMP_CODE
		                                               AND B.DIV_CODE        = A.DIV_CODE
		                                               AND B.ORDER_NUM       = A.ORDER_NUM
		                                               AND B.ORDER_STATUS    = 'N'
		                                               AND ((@DIV_CODE      != '' AND B.OUT_DIV_CODE = @DIV_CODE)        OR (@DIV_CODE     = ''))
		                                               AND ((@FR_DVRY_DATE  != '' AND B.DVRY_DATE   &gt;= @FR_DVRY_DATE)    OR (@FR_DVRY_DATE = ''))
		                                               AND ((@TO_DVRY_DATE  != '' AND B.DVRY_DATE   &lt;= @TO_DVRY_DATE)    OR (@TO_DVRY_DATE = ''))
		           LEFT  JOIN BTR100T  C  WITH (NOLOCK) ON C.COMP_CODE       = B.COMP_CODE
		                                               AND C.DIV_CODE        = B.DIV_CODE
		                                               AND C.ORDER_NUM       = B.ORDER_NUM
		                                               AND C.ORDER_SEQ       = B.SER_NO
		                                               AND C.ITEM_CODE       = B.ITEM_CODE
		           LEFT  JOIN BPR100T  C1 WITH (NOLOCK) ON C1.COMP_CODE      = B.COMP_CODE
		                                               AND C1.ITEM_CODE      = B.ITEM_CODE
		           LEFT  JOIN BPR200T  C2 WITH (NOLOCK) ON C2.COMP_CODE      = B.COMP_CODE
		                                               AND C2.DIV_CODE       = B.OUT_DIV_CODE
		                                               AND C2.ITEM_CODE      = B.ITEM_CODE
		           LEFT  JOIN BCM100T  C3 WITH (NOLOCK) ON C3.COMP_CODE      = A.COMP_CODE
		                                               AND C3.CUSTOM_CODE    = A.CUSTOM_CODE
		           LEFT  JOIN SRQ100T  D1 WITH (NOLOCK) ON D1.COMP_CODE      = B.COMP_CODE
		                                               AND D1.ISSUE_DIV_CODE = B.OUT_DIV_CODE
		                                               AND D1.ORDER_NUM      = B.ORDER_NUM
		                                               AND D1.SER_NO         = B.SER_NO
		           LEFT  JOIN SCM100T  D2 WITH (NOLOCK) ON D2.COMP_CODE      = A.COMP_CODE
		                                               AND D2.CUSTOM_CODE    = A.CUSTOM_CODE
		                                               AND CONVERT(NVARCHAR(08), D2.DVRY_CUST_SEQ) = B.DVRY_CUST_CD
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           LEFT  JOIN BCM600T  Z1 WITH (NOLOCK) ON Z1.COMP_CODE   = B.COMP_CODE
		                                               AND Z1.PJT_CODE    = B.PROJECT_NO
		    WHERE  A.COMP_CODE      = @CompCode
		    AND    (A.STATUS IS NULL OR A.STATUS = '6')
		    AND    A.MONEY_UNIT      = #{MONEY_UNIT}   	/*마스터폼(히든)*/
		    <if test="@foren.Ognl@isNotEmpty(TAX_INOUT)">
		    AND    A.TAX_INOUT       = #{TAX_INOUT}
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 			= @ITEM_CODE						/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
		    AND B.ITEM_CODE 			LIKE @ITEM_CODE + '%'				/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
		    AND C1.ITEM_NAME 		LIKE '%' + #{ITEM_NAME} + '%'		/* 품목명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		    AND A.CUSTOM_CODE 		= #{CUSTOM_CODE}					/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE) and @foren.Ognl@isEmpty(CUSTOM_NAME)">
		    AND A.CUSTOM_CODE 		LIKE  #{CUSTOM_CODE} + '%'			/* 거래처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME) and @foren.Ognl@isEmpty(CUSTOM_CODE)">
		    AND C3.CUSTOM_NAME 		LIKE '%' + #{CUSTOM_NAME} + '%'		/* 거래처명  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ORDER_NUM)">
		    AND    A.ORDER_NUM    LIKE #{ORDER_NUM} + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		    --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		    AND    B.PROJECT_NO   LIKE #{PROJECT_NO} + '%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ORDER_PRSN)">
		    AND     A.ORDER_PRSN 	= #{ORDER_PRSN}
		    </if>
		    AND    ISNULL(B.OUTSTOCK_Q, 0)  = 0
		    GROUP BY B.ORDER_STATUS,   A.CUSTOM_CODE , C3.CUSTOM_NAME, B.ORDER_NUM  , B.SER_NO
		           , B.ITEM_CODE,      C1.ITEM_NAME,   C1.SPEC,        B.ORDER_UNIT , B.TRANS_RATE
		           , B.DVRY_DATE,      B.ORDER_Q,      B.RETURN_Q,     B.OUTSTOCK_Q , B.ISSUE_REQ_Q
		           , B.PO_NUM,         B.OUT_DIV_CODE, B.ORDER_P     , B.ORDER_O    , B.TAX_TYPE
		           --20200103 수정: detail의 PROJECT_NO 가져오도록 수정
		           , B.PROJECT_NO
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           , Z1.PJT_NAME
		           , A.MONEY_UNIT,     A.EXCHG_RATE_O, B.ACCOUNT_YNC , A.ORDER_PRSN
		           , B.DVRY_CUST_CD,   A.BILL_TYPE   , A.ORDER_TYPE  , B.PRICE_YN   , B.DISCOUNT_RATE
		           , C1.STOCK_CARE_YN, C1.STOCK_UNIT,  A.TAX_INOUT   , B.ORDER_TAX_O, B.COMP_CODE
		           , C2.WH_CODE, D2.DVRY_CUST_NM, B.ADVAN_AMOUNT , B.SALE_Q, C.INOUT_NUM, C.INOUT_SEQ, C.INOUT_DATE
		    HAVING B.ORDER_Q - B.SALE_Q > 0
		    ORDER BY C3.CUSTOM_NAME, B.DVRY_DATE, B.ORDER_NUM, B.SER_NO

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
    </select>

	<select id="ssa100ukrvServiceImpl.selectIssueList" parameterType="Map" resultType="rMap">
		/* ssa100ukrv.Cssa100ukrv[fnStr101QRef] Query1 */
		/* 매출등록  [출고(미매출)/반품참조] */
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE	@CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @TAX_INOUT   NVARCHAR(01) /* 세액 포함여부(1:별도, 2:포함) */
		          , @ITEM_NAME   NVARCHAR(200) /* 품명 */

		    SET @CompCode     = #{S_COMP_CODE}
		    SET @UserId       = #{S_USER_ID}
		    SET @LangType     = #{S_LANG_CODE}
		    SET @TAX_INOUT    = #{TAX_INOUT}
		    SET @ITEM_NAME    = #{ITEM_NAME}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		      WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		    /* 데이터 조회&gt; */
		    SELECT CAST(0 AS BIT) AS CHOICE
		         , A.ITEM_CODE
		         , CASE WHEN @RefItem = '0' THEN C1.ITEM_NAME
		                WHEN @RefItem = '1' THEN C1.ITEM_NAME1
		                WHEN @RefItem = '2' THEN C1.ITEM_NAME2
		                ELSE C1.ITEM_NAME
		           END                                              AS ITEM_NAME
		         , C1.SPEC
		         , A.ORDER_UNIT
		         , CASE WHEN C.ADVAN_AMOUNT &gt; 0 THEN C.ORDER_Q - C.SALE_Q
		                ELSE CASE WHEN A.INOUT_TYPE = '2' THEN (A.ORDER_UNIT_Q - A.ACCOUNT_Q)
		                          WHEN A.INOUT_TYPE = '3' THEN (A.ORDER_UNIT_Q - A.ACCOUNT_Q) * (-1)
		                     END
		           END AS NOT_SALE_Q
		         , A.ORDER_UNIT_Q
		         , A.INOUT_WGT_Q
		         , A.INOUT_VOL_Q
		         , A.ORDER_UNIT_P
		         , CASE WHEN C.ADVAN_AMOUNT &gt; 0 THEN (C.ORDER_Q - C.SALE_Q) * A.ORDER_UNIT_P
		                ELSE A.ORDER_UNIT_O
		           END * (CASE  WHEN A.INOUT_TYPE = '3' THEN -1 ELSE 1 END) AS ORDER_UNIT_O
		         , CASE WHEN C.ADVAN_AMOUNT &gt; 0 THEN (C.ORDER_Q - C.SALE_Q) * A.ORDER_UNIT_P * 0.1
		                ELSE A.INOUT_TAX_AMT
		           END * (CASE  WHEN A.INOUT_TYPE = '3' THEN -1 ELSE 1 END) AS INOUT_TAX_AMT
		         , A.PROJECT_NO
		         --20200103 추가: 프로젝트명 가져오기 위해 추가
		         , Z2.PJT_NAME
		         , A.INOUT_NUM
		         , A.INOUT_SEQ
		         , A.INOUT_TYPE
		         , CASE WHEN @RefItem = '1' THEN C2.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C2.CUSTOM_NAME2
		                                    ELSE C2.CUSTOM_NAME
		           END                                              AS CUSTOM_NAME
		         , A.DIV_CODE
		         , A.INOUT_TYPE_DETAIL
		         , A.WH_CODE
		         --20190906 추가
		         , A.WH_CELL_CODE
		         , A.TRNS_RATE
		         , A.MONEY_UNIT
		         , A.EXCHG_RATE_O
		         , A.ORDER_NUM
		         , A.ORDER_SEQ
		         , A.TAX_TYPE
		         , A.DVRY_CUST_CD
		         , A.LOT_NO
		         , A.PRICE_YN
		         , ISNULL(A.DISCOUNT_RATE, 0)                       AS DISCOUNT_RATE
		         , ISNULL(C1.STOCK_CARE_YN, 'Y')                    AS STOCK_CARE_YN
		         , C1.STOCK_UNIT
		         , A.ACCOUNT_YNC
		         , C3.DVRY_CUST_NM                                  AS DVRY_CUST_NAME
		         , A.INOUT_CODE                                     AS CUSTOM_CODE
		         , CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                                    ELSE C4.CUSTOM_NAME
		           END                                              AS INOUT_NAME
		         , B.ORDER_PRSN
		         , CASE WHEN ISNULL(A.ORDER_NUM, '') = '' THEN C2.TAX_TYPE
		                ELSE B.TAX_INOUT
		           END                                              AS SOF100_TAX_INOUT
		         , (CASE WHEN ISNULL(A.INOUT_DATE, '') = ''
		                 THEN ''
		                 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.INOUT_DATE, 1, 4))
		                                                         , 'MM'  , SUBSTRING(A.INOUT_DATE, 5, 2))
		                                                         , 'DD'  , SUBSTRING(A.INOUT_DATE, 7, 2))
		            END)                                             AS INOUT_DATE
		         , CASE WHEN ISNULL(M1.REF_CODE2, '') = '' THEN M1.SUB_CODE
		                ELSE M1.REF_CODE2
		           END                                              AS REF_CODE2
		         , A.AGENT_TYPE
		         , A.PRICE_TYPE
		         , A.INOUT_FOR_WGT_P
		         , A.INOUT_WGT_P
		         , A.INOUT_FOR_VOL_P
		         , A.INOUT_VOL_P
		         , A.WGT_UNIT
		         , A.UNIT_WGT
		         , A.VOL_UNIT
		         , A.UNIT_VOL
		         , ISNULL(A.REMARK,'') AS REMARK
		    FROM              BTR100T  A  WITH (NOLOCK, INDEX(BTR100T_IDX02))
		           LEFT  JOIN SOF100T  B  WITH (NOLOCK) ON B.COMP_CODE    = A.COMP_CODE
		                                        --       AND B.DIV_CODE     = A.SALE_DIV_CODE
		                                               AND B.ORDER_NUM    = A.ORDER_NUM
		                                               AND ((@TAX_INOUT  != '' AND B.TAX_INOUT = @TAX_INOUT) OR (@TAX_INOUT = ''))
		           LEFT  JOIN SOF110T  C  WITH (NOLOCK) ON C.COMP_CODE    = A.COMP_CODE
		                                       --        AND C.DIV_CODE     = A.SALE_DIV_CODE
		                                               AND C.ORDER_NUM    = A.ORDER_NUM
		                                               AND C.SER_NO       = A.ORDER_SEQ
		                                               AND C.ITEM_CODE    = A.ITEM_CODE
		                                               AND C.SALE_Q       &lt; C.ORDER_UNIT_Q
		           LEFT  JOIN BPR100T  C1 WITH (NOLOCK) ON C1.COMP_CODE   = A.COMP_CODE
		                                               AND C1.ITEM_CODE   = A.ITEM_CODE
		           LEFT  JOIN BCM100T  C2 WITH (NOLOCK) ON C2.COMP_CODE   = A.COMP_CODE
		                                               AND C2.CUSTOM_CODE = A.SALE_CUSTOM_CODE
		           LEFT  JOIN SCM100T  C3 WITH (NOLOCK) ON C3.COMP_CODE   = A.COMP_CODE
		                                               AND C3.CUSTOM_CODE = A.SALE_CUSTOM_CODE
		                                               AND CONVERT(NVARCHAR(08), C3.DVRY_CUST_SEQ) = A.DVRY_CUST_CD
		           LEFT  JOIN BCM100T  C4 WITH (NOLOCK) ON C4.COMP_CODE   = A.COMP_CODE
		                                               AND C4.CUSTOM_CODE = A.INOUT_CODE
		           LEFT  JOIN BSA100T  M1 WITH (NOLOCK) ON M1.COMP_CODE   = A.COMP_CODE
		                                               AND M1.MAIN_CODE   = 'S007'                          /* 단가유형 */
		                                               AND M1.SUB_CODE    = A.INOUT_TYPE_DETAIL
		           LEFT  JOIN SCM100T  Z1 WITH(NOLOCK)  ON Z1.COMP_CODE   = B.COMP_CODE
		                                               AND Z1.CUSTOM_CODE = B.CUSTOM_CODE
		                                               AND CONVERT(NVARCHAR(40), Z1.DVRY_CUST_SEQ) = C.DVRY_CUST_CD
		           --20200103 추가: 프로젝트명 가져오기 위해 추가
		           LEFT  JOIN BCM600T  Z2 WITH (NOLOCK) ON Z2.COMP_CODE   = A.COMP_CODE
		                                               AND Z2.PJT_CODE    = A.PROJECT_NO
		    WHERE  A.COMP_CODE         = @CompCode
		    <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		    AND    A.SALE_DIV_CODE     = #{DIV_CODE} /* 마스터폼 정보 */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_TYPE)">
		    AND    A.INOUT_TYPE        = #{INOUT_TYPE}  --INOUT_TYPE:3 (반품)
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(INOUT_CODE) and @foren.Ognl@isNotEmpty(INOUT_NAME)">
		    AND  A.SALE_CUSTOM_CODE 		= #{INOUT_CODE}					/* 출고처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_CODE) and @foren.Ognl@isEmpty(INOUT_NAME)">
		    AND A.SALE_CUSTOM_CODE 		LIKE  #{INOUT_CODE} + '%'			/* 출고처코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_NAME) and @foren.Ognl@isEmpty(INOUT_CODE)">
		    AND (CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		              WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                                  ELSE C4.CUSTOM_NAME
		           END) 				LIKE '%' + #{INOUT_NAME} + '%'		/* 출고처명  */
		    </if>
		
		    AND    A.CREATE_LOC        = '1'
		    --AND    A.ACCOUNT_YNC       = 'Y'
		    --S155 미매출대상 참조가능여부 옵션 체크
		    AND A.ACCOUNT_YNC =	CASE WHEN ISNULL(( SELECT TOP 1 SUB_CODE
		                                             FROM BSA100T WITH (NOLOCK)
		                                            WHERE COMP_CODE = 'MASTER'
		                                              AND MAIN_CODE = 'S155'
		                                              AND REF_CODE1 = 'Y'), 'N') = 'Y' THEN A.ACCOUNT_YNC ELSE 'Y' END
		    AND    A.INOUT_CODE_TYPE   = '4'
		    AND    A.ACCOUNT_Q         != A.ORDER_UNIT_Q
		    AND    A.MONEY_UNIT        = #{MONEY_UNIT}
		    <if test="@foren.Ognl@isNotEmpty(TAX_TYPE)">
		    AND    A.TAX_TYPE       = #{TAX_TYPE}
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(TAX_INOUT)">
		    --20190916 추가: 20191021 수정
		    AND   ((ISNULL(A.ORDER_NUM, '') != '' AND ISNULL(B.TAX_INOUT, '') = @TAX_INOUT)
		        OR (ISNULL(A.ORDER_NUM, '')  = '' AND ISNULL(C2.TAX_TYPE, '') = @TAX_INOUT))
--		    AND    CASE WHEN ISNULL(B.TAX_INOUT, '') = '' THEN ISNULL(C2.TAX_TYPE, '1')
--		                ELSE ISNULL(B.TAX_INOUT, '')
--		           END              = @TAX_INOUT
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_DATE_FR)">
		    AND    A.INOUT_DATE       &gt;= #{INOUT_DATE_FR}
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_DATE_TO)">
		    AND    A.INOUT_DATE       &lt;= #{INOUT_DATE_TO}
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_NUM)">
		    AND    A.INOUT_NUM     LIKE #{INOUT_NUM} +'%'
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isNotEmpty(ITEM_NAME)">
		    AND A.ITEM_CODE 		= #{ITEM_CODE}						/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_CODE) and @foren.Ognl@isEmpty(ITEM_NAME)">
		    AND A.ITEM_CODE 		LIKE #{ITEM_CODE} + '%'				/* 품목코드  */
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(ITEM_NAME) and @foren.Ognl@isEmpty(ITEM_CODE)">
		    AND (CASE WHEN @RefItem = '1' THEN C1.ITEM_NAME1
		              WHEN @RefItem = '2' THEN C1.ITEM_NAME2
		                                  ELSE C1.ITEM_NAME
		         END) 				LIKE '%' + #{ITEM_NAME} + '%'		/* 품목명  */
		    </if>
		    
		    <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		    AND    A.PROJECT_NO    LIKE #{PROJECT_NO} +'%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(INOUT_PRSN)">
		    AND    A.INOUT_PRSN    LIKE #{INOUT_PRSN} +'%'
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(DELIVERY_NAME)">
		    --20190729 수정
		    AND    Z1.DVRY_CUST_NM    LIKE #{DELIVERY_NAME} +'%'
		    </if>
		    --AND ISNULL(C.ORDER_STATUS,'N') = 'N'	--마감된것 제외: 20190925 - 주석처리(마감된 데이터도 나와야함: 한상용 차장님 요청)
		    <if test="@foren.Ognl@isNotEmpty(WH_CODE)">
		    AND    A.WH_CODE      = #{WH_CODE}
		    </if>
		    <if test="@foren.Ognl@isNotEmpty(WH_CELL_CODE)">
		    AND    A.WH_CELL_CODE = #{WH_CELL_CODE}
		    </if>

/*
		--하람아이그룹웨어 사용시 결재완료된것만 표시
		--결재와상관없이 표시되도록 수정
		    AND ISNULL(A.GW_FLAG,'N') = (CASE WHEN (SELECT TOP 1 SUB_CODE
		                                              FROM BSA100T WITH(NOLOCK)
		                                             WHERE COMP_CODE=A.COMP_CODE
		                                               AND MAIN_CODE='A099'
		                                               AND REF_CODE1='Y') = '40'
		                                      THEN '3'
		                                      ELSE ISNULL(A.GW_FLAG,'N')
		                                 END)
*/
		    ORDER BY C2.CUSTOM_NAME, A.INOUT_DATE, A.INOUT_NUM, A.INOUT_SEQ
		END
	</select>

	<select id="ssa100ukrvServiceImpl.getCustCredit" parameterType="Map" resultType="rMap">
		/* USFuncKrv.CSFuncKr[fnGetCRedit] Query01 */
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT uniLITE.fnGetCredit( #{S_COMP_CODE}
		                          , #{DIV_CODE}   /* 사업장 */
		                          , #{CUSTOM_CODE}
		                          , #{SALE_DATE}  /* 매출일 */
		                          , #{MONEY_UNIT} ) AS CREDIT
	</select>

	<select id="ssa100ukrvServiceImpl.getGsManageLotNoYN" parameterType="Map" resultType="rMap">
		SELECT CASE WHEN ISNULL(B.SUB_CODE, '2') = '1' THEN ISNULL(A.REF_CODE1, 'N') ELSE 'N' END AS MNG_LOT
		     , CASE WHEN ISNULL(B.SUB_CODE, '2') = '1' THEN ISNULL(A.REF_CODE2, 'N') ELSE 'N' END AS ESS_YN
		     , CASE WHEN ISNULL(B.SUB_CODE, '2') = '1' THEN ISNULL(A.REF_CODE3, '' ) ELSE ''  END AS ESS_ACCOUNT
		  FROM            BSA100T   A  WITH (NOLOCK)
		       LEFT  JOIN BSA100T   B  WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                            AND B.MAIN_CODE = N'S035'
		                                            AND B.REF_CODE1 = N'Y'
		 WHERE A.COMP_CODE = #{S_COMP_CODE}
		   AND A.MAIN_CODE = N'B090'
		   AND A.SUB_CODE  = N'SE'      /* 매출 */
		 ORDER BY A.SUB_CODE
	</select>

	<select id="ssa100ukrvServiceImpl.getGlSubCdTotCnt" parameterType="Map" resultType="rMap">
		/* USFuncKrv.CSFuncKr[fnGetRefCode2] Query01 */
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT (CASE ISNULL(REF_CODE2,'') WHEN '' THEN SUB_CODE ELSE REF_CODE2 END) AS REF_CODE
		  FROM BSA100T WITH(NOLOCK)
		 WHERE COMP_CODE = #{S_COMP_CODE}
		   AND MAIN_CODE = 'S007'
		   AND SUB_CODE != '$'
		   AND (CASE ISNULL(REF_CODE2,'') WHEN '' THEN SUB_CODE ELSE REF_CODE2 END)  = '95'
	</select>


	<select id="ssa100ukrvServiceImpl.getGetClosingInfo" parameterType="Map" resultType="rMap">
	</select>

	<select id="ssa100ukrvServiceImpl.getDeptName" parameterType="Map" resultType="rMap">
		SELECT TREE_NAME AS DEPT_NAME
		  FROM BSA210 WITH(NOLOCK)
		 WHERE COMP_CODE = #{S_COMP_CODE}
		   AND USE_YN    = 'Y'
		   AND TREE_CODE = #{DEPT_CODE}
	</select>

	<insert id="ssa100ukrvServiceImpl.insertLogMaster" parameterType="Map">
		/*ssa100ukrvServiceImpl.insertLogMaster*/
		INSERT INTO L_SSA100T
		     ( KEY_VALUE              , OPR_FLAG
		     , DIV_CODE               , BILL_NUM                , BILL_TYPE               , SALE_DATE               , SALE_CUSTOM_CODE
		     , MONEY_UNIT             , EXCHG_RATE_O            , SALE_AMT_O              , SALE_LOC_AMT_I          , SALE_LOC_EXP_I
		     , VAT_RATE               , TAX_AMT_O               , SALE_PRSN               , TAX_TYPE                , TAX_CALC_TYPE
		     , REMARK                 , CREATE_LOC              , PROJECT_NO              , CARD_CUST_CD
		     , AGENT_TYPE             , ORDER_TYPE              , COMP_CODE
		     --20200629 추가: 구매확인서 번호, 발급일자
		     , PURCH_DOC_NO           , ISSUE_DATE
		     , INSERT_DB_USER         , INSERT_DB_TIME          , UPDATE_DB_USER          , UPDATE_DB_TIME
		     -- 20210222 : CARD_CUSTOM_CODE(카드사 ) 추가
		     , CARD_CUSTOM_CODE
		     -- 20210705 : 결제조건, 결제예정일 추가
		     , PAYMENT_TERM
		     , PAYMENT_DAY
		)
		VALUES
		     ( #{KEY_VALUE}           , #{OPR_FLAG}
		     , #{DIV_CODE}            , #{BILL_NUM}             , #{BILL_TYPE}            , #{SALE_DATE}            , #{SALE_CUSTOM_CODE}
		     , #{MONEY_UNIT}          , #{EXCHG_RATE_O}         , #{SALE_AMT_O}           , #{TOT_SALE_TAX_O}       , #{TOT_SALE_EXP_O}
		     , #{VAT_RATE}            , #{TOT_TAX_AMT}          , #{SALE_PRSN}            , #{TAX_TYPE}             , #{TAX_CALC_TYPE}
		     , #{REMARK}              , '1'                     , #{PROJECT_NO}           , #{CARD_CUST_CD}
		     , #{AGENT_TYPE}          , #{ORDER_TYPE}           , #{S_COMP_CODE}
		     --20200629 추가: 구매확인서 번호, 발급일자
		     , #{PURCH_DOC_NO}        , #{ISSUE_DATE}
		     , #{S_USER_ID}           , GETDATE()               , #{S_USER_ID}            , GETDATE()
		     -- 20210222 : CARD_CUSTOM_CODE(카드사 ) 추가
		     , #{CARD_CUSTOM_CODE}
		     -- 20210705 : 결제조건, 결제예정일 추가
		     , #{PAYMENT_TERM}
		     , #{PAYMENT_DAY}
		)
	</insert>

	<insert id="ssa100ukrvServiceImpl.insertLogDetail" parameterType="Map">
		/*ssa100ukrvServiceImpl.insertLogDetail*/
		INSERT INTO L_SSA110T
		     ( KEY_VALUE            , OPR_FLAG
		     , COMP_CODE            , DIV_CODE              , BILL_NUM              , BILL_SEQ              , INOUT_NUM
		     , INOUT_SEQ            , INOUT_TYPE            , INOUT_TYPE_DETAIL     , ITEM_CODE             , SALE_UNIT
		     , TRANS_RATE           , SALE_Q                , SALE_P                , SALE_AMT_O            , SALE_LOC_AMT_I
		     , TAX_AMT_O            , WH_CODE               , TAX_TYPE              , DISCOUNT_RATE         , DVRY_CUST_CD
		     , ORDER_NUM            , SER_NO                , LC_NUM                , PROJECT_NO            , PJT_CODE
		     , PUB_NUM              , BEFORE_PUB_NUM        , TO_DIV_CODE           , PRICE_YN              , CUSTOM_CODE
		     , ORDER_PRSN           , OUT_DIV_CODE          , AS_NUM                , ADVAN_YN              , CHANGE_REASON
		     , REMARK               , PRICE_TYPE            , WGT_UNIT              , UNIT_WGT              , VOL_UNIT
		     , UNIT_VOL             , SALE_WGT_Q            , SALE_WGT_P            , SALE_FOR_WGT_P        , SALE_VOL_Q
		     , SALE_VOL_P           , SALE_FOR_VOL_P        , UPDATE_DB_USER
		     --20190906 추가
		     , WH_CELL_CODE
		     --20200806 추가
		     , WARR_MONTH)
		VALUES
		     ( #{KEY_VALUE}         , #{OPR_FLAG}
		     , #{COMP_CODE}         , #{DIV_CODE}           , #{BILL_NUM}           , #{BILL_SEQ}           , #{INOUT_NUM}
		     , #{INOUT_SEQ}         , #{INOUT_TYPE}         , #{INOUT_TYPE_DETAIL}  , #{ITEM_CODE}          , #{SALE_UNIT}
		     , #{TRANS_RATE}        , #{SALE_Q}             , #{SALE_P}             , #{SALE_AMT_O}         , #{SALE_LOC_AMT_I}
		     , #{TAX_AMT_O}         , #{WH_CODE}            , #{TAX_TYPE}           , #{DISCOUNT_RATE}      , #{DVRY_CUST_CD}
		     , #{ORDER_NUM}         , #{SER_NO}             , #{LC_NUM}             , #{REF_PROJECT_NO}     , #{PJT_CODE}
		     , #{PUB_NUM}           , #{BEFORE_PUB_NUM}     , #{TO_DIV_CODE}        , #{PRICE_YN}           , #{REF_CUSTOM_CODE}
		     , #{REF_SALE_PRSN}     , #{OUT_DIV_CODE}       , #{AS_NUM}             , #{ADVAN_YN}           , #{CHANGE_REASON}
		     --20191210 수정: REMARK -> REF_REMARK
		     , #{REF_REMARK}        , #{PRICE_TYPE}         , #{WGT_UNIT}           , #{UNIT_WGT}           , #{VOL_UNIT}
		     , #{UNIT_VOL}          , #{SALE_WGT_Q}         , #{SALE_WGT_P}         , #{SALE_FOR_WGT_P}     , #{SALE_VOL_Q}
		     , #{SALE_VOL_P}        , #{SALE_FOR_VOL_P}     , #{S_USER_ID}
		     --20190906 추가
		     , #{WH_CELL_CODE}
		     --20200806 추가
		     , #{WARR_MONTH})
	</insert>

	<select id="ssa100ukrvServiceImpl.updateMaster" parameterType="Map" resultType="string">
<!-- 20200629 추가: SSA100T 업데이트 시, 기표/세금계산서 발행여부 확인하여 처리하는 로직 추가 -->
		DECLARE @ERROR_DESC NVARCHAR(2000)
		SET     @ERROR_DESC = ''

		SELECT TOP 1 @ERROR_DESC = '54415;'       ---회계전표가 생성된 매출자료는 수정이 불가능합니다.(매출)
		  FROM SSA100T A WITH(NOLOCK)
		 WHERE A.COMP_CODE = #{COMP_CODE}
		   AND A.DIV_CODE  = #{DIV_CODE}
		   AND A.BILL_NUM  = #{BILL_NUM}
		   AND ISNULL(A.EX_DATE, '') != ''

		SELECT TOP 1 @ERROR_DESC ='54476;'   ---계산서가 발행된 매출자료는 수정/삭제가 불가능합니다.(매출)
		  FROM SSA110T A WITH(NOLOCK)
		 WHERE A.COMP_CODE = #{COMP_CODE}
		   AND A.DIV_CODE  = #{DIV_CODE}
		   AND A.BILL_NUM  = #{BILL_NUM}
		   AND ISNULL(A.PUB_NUM, '') != ''

		IF(@ERROR_DESC = '')
		    BEGIN
		        UPDATE SSA100T
		           SET BILL_TYPE      = #{BILL_TYPE}
		             , CARD_CUST_CD   = #{CARD_CUST_CD}
		             , ORDER_TYPE     = #{ORDER_TYPE}
		             , PROJECT_NO     = #{PROJECT_NO}
		             , TAX_TYPE       = #{TAX_TYPE}
		             , REMARK         = #{REMARK}
		             --20190709 추가
		             , SALE_PRSN      = #{SALE_PRSN}
		             --20200629 추가: 구매확인서 번호, 발급일자, UPDATE_DB_TIME, UPDATE_DB_USER
		             , PURCH_DOC_NO   = #{PURCH_DOC_NO}
		             , ISSUE_DATE     = #{ISSUE_DATE}
		             , UPDATE_DB_TIME = GETDATE()
		             , UPDATE_DB_USER = #{S_USER_ID}
		             , CARD_CUSTOM_CODE = #{CARD_CUSTOM_CODE}   -- 20210222 : 카드사(CARD_CUSTOM_CODE) 추가
		             
		             -- 20210705 : 결제조건(PAYMENT_TERM), 결제예정일(PAYMENT_DAY) 추가
		             , PAYMENT_TERM   = #{PAYMENT_TERM}
		             , PAYMENT_DAY    = #{PAYMENT_DAY}
		         WHERE COMP_CODE = #{COMP_CODE}
		           AND DIV_CODE  = #{DIV_CODE}
		           AND BILL_NUM  = #{BILL_NUM}
		    END

		SELECT @ERROR_DESC AS ERROR_DESC
	</select>

	<update id="ssa100ukrvServiceImpl.spReceiving" parameterType="Map" statementType="CALLABLE">
		{call USP_SALES_Ssa100ukr (
			#{KeyValue, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
			#{BillNum, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String},
			#{ErrorDesc, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
		)}
	</update>

	<select id="ssa100ukrvServiceImpl.deptWhcode" parameterType="Map" resultType="rMap">
		SELECT WH_CODE
		  FROM BSA210T WITH(NOLOCK)
		 WHERE COMP_CODE = #{S_COMP_CODE}
		   AND TYPE_LEVEL = #{DIV_CODE}
		   AND TREE_CODE = #{DEPT_CODE}
	</select>
</mapper>