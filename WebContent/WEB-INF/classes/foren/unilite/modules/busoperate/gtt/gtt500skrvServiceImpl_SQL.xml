<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gtt500skrvServiceImpl">
	<select id="gtt500skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		DECLARE @SDATE NVARCHAR(10),
				@EDATE NVARCHAR(10)
		SELECT @SDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_FR},112),120 ),@EDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_TO},112),120 )
		
		SELECT PERSON_NUMB,REPLACE(ATT_DATE,'-','') AS ATT_DATE, IN_TIME, OUT_TIME , CARD_IN_TIME, CARD_OUT_TIME, FP_IN_TIME, FP_OUT_TIME
		  INTO #AttTimeBusV
		  FROM AttTimeBusV
		 WHERE ATT_DATE BETWEEN @SDATE
							AND @EDATE
						 		
		SELECT	  OP.DIV_CODE
				, OP.ROUTE_CODE
				, OP.ROUTE_NUM
				, OP.ROUTE_GROUP
				, B.CODE_NAME AS ROUTE_GROUP_NAME
				, OP2.OPERATION_COUNT_CNT
				, OP.RUN_OPERATION_CNT 
				, OP3.NOTINSERVICE_CNT
				, OP.DRIVER_CNT
				, OP.LATE_CNT
				, OP.EARLY_CNT  
				, OP.ASSIGNED_DRIVER_CNT
				, OP.NO_DRIVER_CNT
				, OP.NO_TAG_IN_CNT
				, OP.NO_TAG_OUT_CNT
				, OP.TAG_IN_CNT
				, OP.TAG_OUT_CNT
				, OP.NO_TAG_CNT
				, OP.TAG_CNT
				, BIS.LATE_DEPARTURE_CNT
				, BIS.DEPARTURE_CNT
				, BIS.NOT_DEPARTURE_CNT
		FROM 
		/*  노선별 기사 근태 */
		(
		SELECT	 O.DIV_CODE
				,O.ROUTE_CODE
				, R.ROUTE_NUM
				, O.ROUTE_GROUP
				, COUNT(O.OPERATION_COUNT) AS RUN_OPERATION_CNT
				, COUNT(O.DRIVER_CODE) AS DRIVER_CNT
				, SUM(CASE WHEN DATEDIFF(MINUTE,
						 G.IN_TIME,
						 CONVERT(DATETIME, ISNULL(DUTY_FR_DATE, O.OPERATION_DATE)+' '+DUTY_FR_TIME, 114)
						 ) &lt; 0 THEN 1 ELSE 0 END )  AS LATE_CNT
				, SUM(CASE WHEN DATEDIFF(MINUTE,
						 CONVERT(DATETIME, ISNULL(DUTY_TO_DATE, O.OPERATION_DATE)+' '+DUTY_TO_TIME, 114),
						 G.OUT_TIME
						 ) &lt; 0 THEN 1 ELSE 0 END ) AS EARLY_CNT  
				, SUM(CASE WHEN ISNULL(O.DRIVER_CODE,'')	!='' THEN 1 ELSE 0 END) AS ASSIGNED_DRIVER_CNT
				, SUM(CASE WHEN ISNULL(O.DRIVER_CODE,'')	 ='' THEN 1 ELSE 0 END) AS NO_DRIVER_CNT
				, SUM(CASE WHEN ISNULL(G.IN_TIME,'')		 ='' AND  ISNULL(O.DRIVER_CODE,'')	!='' THEN 1 ELSE 0 END) AS NO_TAG_IN_CNT
				, SUM(CASE WHEN ISNULL(G.OUT_TIME,'')		 ='' AND  ISNULL(O.DRIVER_CODE,'')	!='' THEN 1 ELSE 0 END) AS NO_TAG_OUT_CNT
				, SUM(CASE WHEN ISNULL(G.IN_TIME,'')		!='' AND  ISNULL(O.DRIVER_CODE,'')	!='' THEN 1 ELSE 0 END) AS TAG_IN_CNT
				, SUM(CASE WHEN ISNULL(G.OUT_TIME,'')		!='' AND  ISNULL(O.DRIVER_CODE,'')	!='' THEN 1 ELSE 0 END) AS TAG_OUT_CNT
				, SUM(CASE WHEN	  (ISNULL(G.IN_TIME,'')		 ='' AND  ISNULL(O.DRIVER_CODE,'')	!='' )
							  OR  (ISNULL(G.OUT_TIME,'')	 ='' AND  ISNULL(O.DRIVER_CODE,'')	!='' )
						 THEN 0 ELSE 1 END)										AS NO_TAG_CNT
				, SUM(CASE WHEN	  ISNULL(G.IN_TIME,'')		!='' 
							  AND ISNULL(G.OUT_TIME,'')		!=''
							  AND ISNULL(O.DRIVER_CODE,'')	!='' 
						 THEN 0 ELSE 1 END)										AS TAG_CNT
			
		FROM (SELECT   GOP.COMP_CODE
					 , GOP.DIV_CODE
					 , GOP.OPERATION_DATE
					 , GOP.OPERATION_COUNT
					 , GOP.ROUTE_CODE
					 , GOP.ROUTE_GROUP
					 , DRIVER_CODE
					 
					 , DUTY_FR_DATE 
					 , CASE WHEN ISNULL(DUTY_FR_TIME,'') != '' 	THEN left(DUTY_FR_TIME, 2)+':'+SUBSTRING(DUTY_FR_TIME,3,2)+':'+ (CASE WHEN LEN(DUTY_FR_TIME)= 6 THEN SUBSTRING(DUTY_FR_TIME,5,2) ELSE '00' END)  ELSE '' END AS DUTY_FR_TIME
							  
					 , DUTY_TO_DATE 
					 , CASE WHEN ISNULL(DUTY_TO_TIME,'') != '' 	THEN left(DUTY_TO_TIME, 2)+':'+SUBSTRING(DUTY_TO_TIME,3,2)+':'+ (CASE WHEN LEN(DUTY_TO_TIME)= 6 THEN SUBSTRING(DUTY_TO_TIME,5,2) ELSE '00' END)  ELSE '' END AS DUTY_TO_TIME 
					
				FROM GOP300T GOP
				INNER JOIN (
					/* 기사의 근태는 마지막 운행한 운전자 기준이므로 마지만 회차의 기사정보만 이용한다. */
					SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT,  RUN_COUNT
					FROM (
						SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT, RUN_COUNT,NOTINSERVICE_YN,
						RANK() OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT ORDER BY CONVERT(NUMERIC(10,0),RUN_COUNT) DESC )  AS RNK
						FROM GOP300T
						WHERE COMP_CODE = #{S_COMP_CODE}
						  AND DIV_CODE = #{DIV_CODE}
						  AND OPERATION_DATE &gt;= #{ATT_DATE_FR}
						  AND OPERATION_DATE &lt;= #{ATT_DATE_TO}
						  AND OTHER_VEHICLE_YN != 'Y'
						  <if test="@foren.Ognl@isNotEmpty(DRIVER_CODE)">
						  AND DRIVER_CODE = #{DRIVER_CODE}
						  </if>
						  <if test="@foren.Ognl@isNotEmpty(WORK_TEAM_CODE)">
						  AND WORK_TEAM_CODE = #{WORK_TEAM_CODE}
						  </if>	
						  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
						  AND ROUTE_GROUP = #{ROUTE_GROUP}
						  </if>
						  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
						  AND ROUTE_CODE = #{ROUTE_CODE}
						  </if>	
						  <if test="@foren.Ognl@isNotEmpty(VEHICLE_CODE)">
						  AND VEHICLE_CODE = #{VEHICLE_CODE}
						  </if>
						  <if test="SEARCH_KIND == '02'">
						  AND ISNULL(DRIVER_CODE, '') != ''
						  </if>	  
					  ) L
					WHERE RNK =1
					  AND NOTINSERVICE_YN != 'Y'
				) MO  ON GOP.COMP_CODE = MO.COMP_CODE
					 AND GOP.DIV_CODE = MO.DIV_CODE
					 AND GOP.OPERATION_DATE = MO.OPERATION_DATE
					 AND GOP.ROUTE_CODE = MO.ROUTE_CODE
					 AND GOP.OPERATION_COUNT = MO.OPERATION_COUNT
					 AND GOP.RUN_COUNT = MO.RUN_COUNT
				
				WHERE GOP.COMP_CODE = #{S_COMP_CODE}
				  AND GOP.DIV_CODE = #{DIV_CODE}
				  AND GOP.OPERATION_DATE &gt;= #{ATT_DATE_FR}
				  AND GOP.OPERATION_DATE &lt;= #{ATT_DATE_TO}
				  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
				  AND GOP.ROUTE_GROUP = #{ROUTE_GROUP}
				  </if>
				  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
				  AND GOP.ROUTE_CODE = #{ROUTE_CODE}
				  </if>	
				  
				  AND GOP.NOTINSERVICE_YN != 'Y'
				  AND GOP.OTHER_VEHICLE_YN != 'Y'
					 
			 ) O 
		LEFT JOIN #AttTimeBusV G ON O.DRIVER_CODE = G.PERSON_NUMB
							AND O.OPERATION_DATE = G.ATT_DATE
		LEFT JOIN GRT100T R 
							  ON O.COMP_CODE = R.COMP_CODE
							 AND O.DIV_CODE = R.DIV_CODE
							 AND O.ROUTE_CODE = R.ROUTE_CODE
		
		WHERE O.COMP_CODE = #{S_COMP_CODE}
		  AND O.DIV_CODE = #{DIV_CODE}
		GROUP BY O.ROUTE_GROUP, O.ROUTE_CODE, R.ROUTE_NUM, O.DIV_CODE
		) AS OP
		/* 계획운행 수( 승무지시) */
		LEFT JOIN (
			SELECT 
				  COMP_CODE
				, DIV_CODE
				, OPERATION_DATE
				, ROUTE_CODE
				, COUNT(OPERATION_COUNT) AS OPERATION_COUNT_CNT
			FROM GOP200T
			WHERE COMP_CODE = #{S_COMP_CODE}
			  AND DIV_CODE = #{DIV_CODE}
			  AND OPERATION_DATE &gt;= #{ATT_DATE_FR}
			  AND OPERATION_DATE &lt;= #{ATT_DATE_TO}
			  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
			  AND ROUTE_GROUP = #{ROUTE_GROUP}
			  </if>
			  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
			  AND ROUTE_CODE = #{ROUTE_CODE}
			  </if>	
			  AND OTHER_VEHICLE_YN != 'Y'
			GROUP BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE
		) OP2  ON  OP2.ROUTE_CODE 		= OP.ROUTE_CODE
		/* 운휴 수 */
		LEFT JOIN (
			SELECT 
				  COMP_CODE
				, DIV_CODE
				, OPERATION_DATE
				, ROUTE_CODE
				, COUNT(OPERATION_COUNT) AS NOTINSERVICE_CNT
			FROM (SELECT  COMP_CODE
						, DIV_CODE
						, OPERATION_DATE
						, ROUTE_CODE
						, OPERATION_COUNT
				   FROM GOP300T 
				  WHERE COMP_CODE = #{S_COMP_CODE}
					AND DIV_CODE = #{DIV_CODE}
					AND OPERATION_DATE &gt;= #{ATT_DATE_FR}
					AND OPERATION_DATE &lt;= #{ATT_DATE_TO}
					<if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
					AND ROUTE_GROUP = #{ROUTE_GROUP}
					</if>
					<if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
					AND ROUTE_CODE = #{ROUTE_CODE}
					</if>	
					AND OTHER_VEHICLE_YN != 'Y'
					AND NOTINSERVICE_YN = 'Y'
				  GROUP BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE , OPERATION_COUNT
			) AS A
			GROUP BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE
		) OP3  ON  OP3.ROUTE_CODE 		= OP.ROUTE_CODE
		/* BIS 첫차 출발시각*/
		LEFT JOIN(
				SELECT	  O.ROUTE_CODE
						, O.ROUTE_GROUP
						, SUM(CASE WHEN ISNULL(RUN_DEPARTURE_TIME,'') = '' THEN 0 
							  ELSE
								  CASE WHEN DATEDIFF(MINUTE
													 ,CONVERT(DATETIME, O.RUN_DEPARTURE_DATE+' '+O.RUN_DEPARTURE_TIME,114)
													 ,CONVERT(DATETIME, O.DEPARTURE_DATE+' '+O.DEPARTURE_TIME,114)
												    ) &lt; 0 
									   THEN 1 
								  ELSE 0 
								  END 
							  END)  AS LATE_DEPARTURE_CNT
						, SUM(CASE WHEN ISNULL(RUN_DEPARTURE_TIME,'') = '' THEN 0 
							  ELSE
								  CASE WHEN DATEDIFF(MINUTE
													 ,CONVERT(DATETIME, O.RUN_DEPARTURE_DATE+' '+O.RUN_DEPARTURE_TIME,114)
													 ,CONVERT(DATETIME, O.DEPARTURE_DATE+' '+O.DEPARTURE_TIME,114)
												    ) &gt;= 0 
									   THEN 1 
								  ELSE 0 
								  END 
							  END)  AS DEPARTURE_CNT
						, SUM(CASE WHEN ISNULL(RUN_DEPARTURE_TIME,'') = '' THEN 1 ELSE 0 END) AS NOT_DEPARTURE_CNT
				FROM
				(SELECT   
					   GOP.ROUTE_CODE
					 , GOP.ROUTE_GROUP
					 , GOP.DEPARTURE_DATE
					 , CASE WHEN ISNULL(GOP.DEPARTURE_TIME,'') != '' 	THEN left(GOP.DEPARTURE_TIME, 2)+':'+SUBSTRING(GOP.DEPARTURE_TIME,3,2)+':'+ (CASE WHEN LEN(GOP.DEPARTURE_TIME)= 6 THEN SUBSTRING(GOP.DEPARTURE_TIME,5,2) ELSE '00' END)  ELSE '' END AS DEPARTURE_TIME	  
					 , GOP.RUN_DEPARTURE_DATE
					 , CASE WHEN ISNULL(GOP.RUN_DEPARTURE_TIME,'') != '' 	THEN left(GOP.RUN_DEPARTURE_TIME, 2)+':'+SUBSTRING(GOP.RUN_DEPARTURE_TIME,3,2)+':'+ (CASE WHEN LEN(GOP.RUN_DEPARTURE_TIME)= 6 THEN SUBSTRING(GOP.RUN_DEPARTURE_TIME,5,2) ELSE '00' END)  ELSE '' END AS RUN_DEPARTURE_TIME
				FROM GOP300T GOP
				INNER JOIN (
					SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT,  MIN(RUN_COUNT) AS RUN_COUNT
					FROM (
						SELECT COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT, RUN_COUNT,NOTINSERVICE_YN,
						RANK() OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT ORDER BY CONVERT(NUMERIC(10,0),RUN_COUNT) DESC )  AS RNK1,
						RANK() OVER(PARTITION BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT ORDER BY CONVERT(NUMERIC(10,0),RUN_COUNT ))  AS RNK2
						FROM GOP300T
						WHERE COMP_CODE = #{S_COMP_CODE}
						  AND DIV_CODE = #{DIV_CODE}
						  AND OPERATION_DATE &gt;= #{ATT_DATE_FR}
						  AND OPERATION_DATE &lt;= #{ATT_DATE_TO}
						  AND OTHER_VEHICLE_YN != 'Y'
						  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
						  AND ROUTE_GROUP = #{ROUTE_GROUP}
						  </if>
						  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
						  AND ROUTE_CODE = #{ROUTE_CODE}
						  </if>
					  ) L
					  WHERE (RNK2 =1 OR  RNK1 =1)
					    AND NOTINSERVICE_YN != 'Y'
					  GROUP BY COMP_CODE, DIV_CODE, OPERATION_DATE, ROUTE_CODE, OPERATION_COUNT
					  HAVING COUNT(RUN_COUNT) = 2
				) MO  ON GOP.COMP_CODE = MO.COMP_CODE
					 AND GOP.DIV_CODE = MO.DIV_CODE
					 AND GOP.OPERATION_DATE = MO.OPERATION_DATE
					 AND GOP.ROUTE_CODE = MO.ROUTE_CODE
					 AND GOP.OPERATION_COUNT = MO.OPERATION_COUNT
					 AND GOP.RUN_COUNT = MO.RUN_COUNT
				WHERE GOP.COMP_CODE = #{S_COMP_CODE}
				  AND GOP.DIV_CODE = #{DIV_CODE}
				  AND GOP.OPERATION_DATE &gt;= #{ATT_DATE_FR}
				  AND GOP.OPERATION_DATE &lt;= #{ATT_DATE_TO}
				  AND GOP.NOTINSERVICE_YN != 'Y'
				  AND GOP.OTHER_VEHICLE_YN != 'Y'
				  <if test="@foren.Ognl@isNotEmpty(ROUTE_GROUP)">
				  AND GOP.ROUTE_GROUP = #{ROUTE_GROUP}
				  </if>
				  <if test="@foren.Ognl@isNotEmpty(ROUTE_CODE)">
				  AND GOP.ROUTE_CODE = #{ROUTE_CODE}
				  </if>
				) AS O
				GROUP BY ROUTE_GROUP, ROUTE_CODE
			 ) AS  BIS  ON BIS.ROUTE_CODE = OP.ROUTE_CODE
		LEFT JOIN BSA100T B  ON B.COMP_CODE = #{S_COMP_CODE}
							AND B.MAIN_CODE = 'GO16'
							AND B.SUB_CODE = OP.ROUTE_GROUP
		ORDER BY OP.ROUTE_NUM

		DROP TABLE #AttTimeBusV
	</select>
	<select id="gtt500skrvServiceImpl.selectMechanicList" parameterType="Map" resultType="rMap">
		DECLARE @SDATE NVARCHAR(10),
				@EDATE NVARCHAR(10)
		SELECT @SDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_FR},112),120 ),@EDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_TO},112),120 )

		SELECT PERSON_NUMB,REPLACE(ATT_DATE,'-','') AS ATT_DATE, IN_TIME, OUT_TIME , CARD_IN_TIME, CARD_OUT_TIME, FP_IN_TIME, FP_OUT_TIME
		  INTO #AttTimeBusV
		  FROM AttTimeBusV
		 WHERE ATT_DATE BETWEEN @SDATE
							AND @EDATE
		
		SELECT A.DIV_CODE
			 , SUM(CASE WHEN C.IN_TIME  IS NOT NULL THEN 1 ELSE 0 END) AS  TAG_IN_CNT
			 , SUM(CASE WHEN C.OUT_TIME IS NOT NULL THEN 1 ELSE 0 END) AS  TAG_OUT_CNT			 
		  FROM            HUM100T     A WITH (NOLOCK)
		       INNER JOIN BSA100T     B WITH (NOLOCK) ON B.COMP_CODE            = A.COMP_CODE
		                                             AND B.MAIN_CODE            = 'H024'            --사원구분
		                                             AND B.SUB_CODE             = A.EMPLOY_TYPE
		                                             AND ISNULL(B.REF_CODE1,'') = '4'               --정비직
		       INNER JOIN #AttTimeBusV C               ON C.PERSON_NUMB          = A.PERSON_NUMB
		  WHERE A.COMP_CODE = #{S_COMP_CODE}
		    AND A.DIV_CODE = #{DIV_CODE}
   		  GROUP BY A.DIV_CODE

		DROP TABLE #AttTimeBusV
	</select>
	<select id="gtt500skrvServiceImpl.selectOfficerList" parameterType="Map" resultType="rMap">
		DECLARE @SDATE NVARCHAR(10),
				@EDATE NVARCHAR(10)
		SELECT @SDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_FR},112),120 ),@EDATE=CONVERT(NVARCHAR(10), CONVERT(DATETIME,#{ATT_DATE_TO},112),120 )

		SELECT PERSON_NUMB,REPLACE(ATT_DATE,'-','') AS ATT_DATE, IN_TIME, OUT_TIME , CARD_IN_TIME, CARD_OUT_TIME, FP_IN_TIME, FP_OUT_TIME
		  INTO #AttTimeBusV
		  FROM AttTimeBusV
		 WHERE ATT_DATE BETWEEN @SDATE
							AND @EDATE
		
		SELECT A.DIV_CODE
			 , SUM(CASE WHEN C.IN_TIME  IS NOT NULL THEN 1 ELSE 0 END) AS  TAG_IN_CNT
			 , SUM(CASE WHEN C.OUT_TIME IS NOT NULL THEN 1 ELSE 0 END) AS  TAG_OUT_CNT			 
		  FROM            HUM100T     A WITH (NOLOCK)
		       INNER JOIN BSA100T     B WITH (NOLOCK) ON B.COMP_CODE            = A.COMP_CODE
		                                             AND B.MAIN_CODE            = 'H024'            --사원구분
		                                             AND B.SUB_CODE             = A.EMPLOY_TYPE
		                                             AND ISNULL(B.REF_CODE1,'') = '2'               --내근직
		       INNER JOIN #AttTimeBusV C               ON C.PERSON_NUMB          = A.PERSON_NUMB
		  WHERE A.COMP_CODE = #{S_COMP_CODE}
		    AND A.DIV_CODE = #{DIV_CODE}
   		  GROUP BY A.DIV_CODE

		DROP TABLE #AttTimeBusV
	</select>
</mapper>