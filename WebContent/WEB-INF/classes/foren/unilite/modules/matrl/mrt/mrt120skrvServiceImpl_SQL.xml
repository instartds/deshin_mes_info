<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mrt120skrvServiceImpl">
					
	<select id="mrt120skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		BEGIN
		
		SET NOCOUNT ON
		SET ARITHABORT ON
			
DECLARE @START_TIME DATETIME
      , @END_TIME   DATETIME
      , @DIFF_TIME  NUMERIC(10, 0)

SET @START_TIME = GETDATE()

			
		DECLARE @CompCode   NVARCHAR(08)	/* 법인코드  */
		    SET @CompCode = #{S_COMP_CODE}

	 	SELECT 
	 	 A.COMP_CODE
	 	,A.DIV_CODE
	    ,A.CUSTOM_CODE
	    ,C.CUSTOM_NAME
		,SUM(CASE WHEN B.PURCHASE_TYPE = '1' THEN B.BUY_Q		ELSE 0 END) AS CON_BUY_Q
		,SUM(CASE WHEN B.PURCHASE_TYPE = '1' THEN B.AMOUNT_I	ELSE 0 END) AS CON_AMT
		,SUM(CASE WHEN B.PURCHASE_TYPE = '1' THEN B.TAX_I		ELSE 0 END) AS CON_TAX
		,SUM(CASE WHEN B.PURCHASE_TYPE = '1' THEN B.AMOUNT_I + B.TAX_I ELSE 0 END) AS SUM_CONSIGNMENT
		
		,SUM(CASE WHEN B.PURCHASE_TYPE = '2' THEN B.BUY_Q		ELSE 0 END) AS NOW_BUY_Q
		,SUM(CASE WHEN B.PURCHASE_TYPE = '2' THEN B.AMOUNT_I	ELSE 0 END) AS NOW_AMT
		,SUM(CASE WHEN B.PURCHASE_TYPE = '2' THEN B.TAX_I		ELSE 0 END) AS NOW_TAX
		,SUM(CASE WHEN B.PURCHASE_TYPE = '2' THEN B.AMOUNT_I + B.TAX_I ELSE 0 END) AS SUM_BUYNOW
		
		,SUM(CASE WHEN B.PURCHASE_TYPE IN ('1', '2') THEN B.BUY_Q  ELSE 0 END) AS TOTAL_BUY_Q
		
		,SUM(CASE WHEN B.PURCHASE_TYPE IN ('1', '2') THEN B.AMOUNT_I  ELSE 0 END) AS TOTAL_AMT
		,SUM(CASE WHEN B.PURCHASE_TYPE IN ('1', '2') THEN B.TAX_I  ELSE 0 END) AS TOTAL_TAX
		,SUM(CASE WHEN B.PURCHASE_TYPE IN ('1', '2') THEN B.AMOUNT_I + B.TAX_I  ELSE 0 END) AS TOTAL_SUM
				
		FROM 	   MAP100T A WITH(NOLOCK)
		INNER JOIN MAP200T B WITH(NOLOCK) ON A.COMP_CODE   = B.COMP_CODE
										 AND A.DIV_CODE    = B.DIV_CODE
										 AND A.CUSTOM_CODE = B.CUSTOM_CODE
										 AND A.CHANGE_BASIS_NUM = B.CHANGE_BASIS_NUM
		INNER JOIN BCM100T C WITH(NOLOCK) ON A.COMP_CODE   = C.COMP_CODE
							 			 AND A.CUSTOM_CODE = C.CUSTOM_CODE
		
		WHERE A.COMP_CODE  = @CompCode
		  AND B.INOUT_TYPE = '4'
		
		<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		    AND A.DIV_CODE = #{DIV_CODE} 
		</if>
		<if test="@foren.Ognl@isNotEmpty(BASIS_DATA_FR)">
			AND A.CHANGE_BASIS_DATE &gt;= #{BASIS_DATA_FR}
		</if>
		<if test="@foren.Ognl@isNotEmpty(BASIS_DATA_TO)">
			AND A.CHANGE_BASIS_DATE &lt;= #{BASIS_DATA_TO}
		</if>
		<if test="@foren.Ognl@isNotEmpty(CUST_CODE1)">
		    AND A.CUSTOM_CODE &gt;= #{CUST_CODE1} 
		</if>
		<if test="@foren.Ognl@isNotEmpty(CUST_CODE2)">
			AND A.CUSTOM_CODE &lt;= #{CUST_CODE2}
		</if>
		<if test="@foren.Ognl@isNotEmpty(DEPT_CODE)">
			AND A.DEPT_CODE = #{DEPT_CODE}
		</if>
      
		GROUP BY A.COMP_CODE, A.DIV_CODE, A.CUSTOM_CODE, C.CUSTOM_NAME
	    ORDER BY C.CUSTOM_NAME
	    
SET @END_TIME   = GETDATE()

SET @DIFF_TIME = DATEDIFF(S, @START_TIME, @END_TIME)

EXEC uniLITE.SP_QRY_TIME 'mrt120skrv', '반품 지급결의현황 조회', #{BASIS_DATA_FR}, #{BASIS_DATA_TO}, @DIFF_TIME

	    
	SET ARITHABORT OFF
	SET NOCOUNT OFF
	
	END
    </select>
	
	
</mapper>