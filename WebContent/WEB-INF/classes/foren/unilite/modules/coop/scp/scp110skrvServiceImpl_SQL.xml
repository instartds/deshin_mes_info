<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="scp110skrvServiceImpl">
	
	<select id="scp110skrvServiceImpl.selectList" parameterType="Map" resultType="rMap">
		BEGIN
				SET NOCOUNT ON
				SET ARITHABORT ON
					
				DECLARE @CompCode		NVARCHAR(08)	/* 법인코드  */
				      , @UserId			NVARCHAR(100)	/* 사용자ID */
				      , @LangType		NVARCHAR(2)		/* 언어구분 */
				      , @RefItem		NVARCHAR(01)
				      , @DateFormat		NVARCHAR(10)
					
				SET @CompCode = #{S_COMP_CODE}
				SET @UserId   = #{S_USER_ID}
				SET @LangType = #{S_LANG_CODE}
					
				/* 명칭 참조 유형 */
				SELECT TOP 1 @RefItem = REF_ITEM
					FROM BSA300T WITH (NOLOCK)
					WHERE COMP_CODE = @CompCode
						AND USER_ID = @UserId
					
				SET @RefItem = ISNULL(@RefItem, N'0')
					
				/* 날짜 포맷 유형 설정 */
				SELECT TOP 1 @DateFormat = CODE_NAME
					FROM BSA100T WITH (NOLOCK)
					WHERE COMP_CODE = @CompCode
					AND MAIN_CODE = N'B044'
					AND REF_CODE1 = N'Y'
					
				SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')	

			SELECT 
			     A.ITEM_CODE
			   , B.ITEM_NAME
			   /* 카드매출  */
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '01' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_01_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '01' THEN ISNULL(A.SALE_AMT_O,0) END),'0')  CARD_01_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '02' THEN ISNULL(A.SALE_Q,0) END),'0') 	    CARD_02_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '02' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_02_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '03' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_03_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '03' THEN ISNULL(A.SALE_AMT_O,0) END),'0')  CARD_03_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '04' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_04_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '04' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_04_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '05' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_05_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '05' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_05_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '06' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_06_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '06' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_06_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '07' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_07_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '07' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_07_O
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '08' THEN ISNULL(A.SALE_Q,0) END),'0') 		CARD_08_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '08' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 	CARD_08_O			   
			   /* 카드자동환불 */
			  -- , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '03' THEN ISNULL(A.SALE_Q,0) END),'0') 										CARD_REFUND_Q
			  -- , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '03' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 									CARD_REFUND_O
			   
			   /* 총 합계*/
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '01' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '02' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '03' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '04' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '05' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '06' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '07' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '08' THEN ISNULL(A.SALE_Q,0) END),'0') 
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '03' THEN ISNULL(A.SALE_Q,0) END),'0') 									AS CARD_TOTAL_QTY
			   
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '01' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '02' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '03' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '04' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '05' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '06' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '07' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   + ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '01' AND A.COLLECT_TYPE_DETAIL = '08' THEN ISNULL(A.SALE_AMT_O,0) END),'0')
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '03' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 								AS CARD_TOTAL_AMT				 
			   
			   /* 사이버머니 */
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '02' THEN ISNULL(A.SALE_Q,0) END),'0') 									CYBER_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '02' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 								CYBER_O
			   /* 사이버재적립 */
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '04' THEN ISNULL(A.SALE_Q,0) END),'0') 									CYBER_REPOINT_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '04' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 								CYBER_REPOINT_O
			   /* 자동환불 */
			   --, ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '05' THEN ISNULL(A.SALE_Q,0) END),'0')									CYBER_REFUND_Q
			   --, ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '05' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 							CYBER_REFUND_O			   			   
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '06' THEN ISNULL(A.SALE_Q,0) END),'0')									CYBER_REFUND_Q
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '06' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 								CYBER_REFUND_O			   			   			   
			   
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '02' THEN ISNULL(A.SALE_Q,0) END),'0')
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '04' THEN ISNULL(A.SALE_Q,0) END),'0')
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '06' THEN ISNULL(A.SALE_Q,0) END),'0')									 AS CYBER_TOTAL_Q
			   
			   , ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '02' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '04' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 
			   - ISNULL(SUM(CASE WHEN A.COLLECT_TYPE = '06' THEN ISNULL(A.SALE_AMT_O,0) END),'0') 								CYBER_TOTAL_O
			   
			   
			   FROM 
							   SSA500T A WITH(NOLOCK)
			   INNER      JOIN BPR200T B WITH(NOLOCK) ON A.COMP_CODE = B.COMP_CODE
										      		 AND A.DIV_CODE  = B.DIV_CODE
											  		 AND A.ITEM_CODE = B.ITEM_CODE	   
							   
			   LEFT OUTER JOIN BSA100T C WITH(NOLOCK) ON A.COMP_CODE = C.COMP_CODE
													 AND C.MAIN_CODE = 'A028'
													 AND C.SUB_CODE != N'$'
													 AND A.COLLECT_TYPE_DETAIL = C.SUB_CODE

   					
									
			   WHERE A.COMP_CODE         = @CompCode
			   <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
				 AND A.DIV_CODE 		= #{DIV_CODE}
	           </if>
		       <if test="@foren.Ognl@isNotEmpty(SALE_DATE_FR)">     
			   AND    A.SALE_DATE      &gt;= #{SALE_DATE_FR}
			   </if>
			   <if test="@foren.Ognl@isNotEmpty(SALE_DATE_TO)">     
			   AND    A.SALE_DATE      &lt;= #{SALE_DATE_TO}
			   </if>
			   
			   
				GROUP BY A.ITEM_CODE, B.ITEM_NAME
				ORDER BY B.ITEM_NAME    
			
			SET NOCOUNT OFF
			SET ARITHABORT OFF
		END
		
    </select>	
</mapper>