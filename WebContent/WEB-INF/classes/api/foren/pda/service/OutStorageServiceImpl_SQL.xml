<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="outStorageServiceImpl">
    	<select id="outStorageServiceImpl.selectSrq100" parameterType="Map" resultType="rMap">
		/* srq100ukrv.Csrq100ukrv[fnSrq101QPop] Query01 */
		BEGIN
			 SET NOCOUNT ON
			 SET ARITHABORT ON

			 DECLARE	@CompCode    NVARCHAR(08) /* 법인코드    */
					  , @UserId      NVARCHAR(100) /* 사용자ID    */
					  , @LangType    NVARCHAR(2)  /* 언어구분    */
					  , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
					  , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */

			 SET @CompCode = #{S_COMP_CODE}
			 SET @UserId   = #{S_USER_ID}
			 SET @LangType = #{S_LANG_CODE}

			 /* 명칭 참조 유형 */
				SELECT TOP 1 @RefItem = REF_ITEM
				  FROM BSA300T WITH (NOLOCK)
				 WHERE USER_ID = @UserId

				SET @RefItem = ISNULL(@RefItem, N'0')

			 /* 날짜 포맷 유형 설정 */
				SELECT TOP 1 @DateFormat = CODE_NAME
				  FROM BSA100T WITH (NOLOCK)
				 WHERE COMP_CODE = @CompCode
				   AND MAIN_CODE = N'B044'
				   AND REF_CODE1 = N'Y'

				SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

			 /* 데이터 조회 */


		    SELECT A.CUSTOM_CODE
		         , (CASE WHEN @RefItem = '1' THEN B.CUSTOM_NAME1
		                 WHEN @RefItem = '2' THEN B.CUSTOM_NAME2
											 ELSE B.CUSTOM_NAME
					END)					AS CUSTOM_NAME

		         , A.ITEM_CODE
		         , (CASE WHEN @RefItem = '1' THEN C.ITEM_NAME1
						 WHEN @RefItem = '2' THEN C.ITEM_NAME2
		                                     ELSE C.ITEM_NAME
		            END)					AS ITEM_NAME

		         , C.SPEC
		         , A.ISSUE_REQ_QTY
		         , (CASE WHEN ISNULL ( A.ISSUE_REQ_DATE , '' ) = ''
						 THEN ''
						 ELSE REPLACE ( REPLACE( REPLACE ( @DateFormat , 'YYYY' , SUBSTRING (A.ISSUE_REQ_DATE, 1, 4))
											                           , 'MM'   , SUBSTRING (A.ISSUE_REQ_DATE, 5, 2))
												                       , 'DD'   , SUBSTRING (A.ISSUE_REQ_DATE, 7, 2))
		              END)												AS ISSUE_REQ_DATE

		         , (CASE WHEN ISNULL ( A.ISSUE_DATE , '' ) = ''
						 THEN ''
						 ELSE REPLACE ( REPLACE( REPLACE ( @DateFormat , 'YYYY' , SUBSTRING (A.ISSUE_DATE, 1, 4))
											                           , 'MM'   , SUBSTRING (A.ISSUE_DATE, 5, 2))
												                       , 'DD'   , SUBSTRING (A.ISSUE_DATE, 7, 2))
		              END)												AS ISSUE_DATE
		         , A.ISSUE_DIV_CODE
		         , A.WH_CODE
		         , A.ORDER_TYPE
		         , A.INOUT_TYPE_DETAIL
		         , A.PROJECT_NO
		         , A.ISSUE_REQ_NUM
		         , A.DIV_CODE      ,A.ISSUE_QTY
		         , RTRIM(A.ISSUE_REQ_NUM) + RTRIM(CONVERT(VARCHAR(4),A.ISSUE_REQ_SEQ)) AS SORT_KEY
		         , ISNULL(B.WON_CALC_BAS, '')					AS WON_CALC_BAS
		         , ISNULL(B.MONEY_UNIT, E.SUB_CODE)				AS MONEY_UNIT
		         , ISNULL(B.TAX_TYPE, '')						AS TAX_TYPE
		         , ISNULL(B.BUSI_PRSN, '')						AS BUSI_PRSN


		      FROM            SRQ100T A WITH (NOLOCK)
		           INNER JOIN BCM100T B WITH (NOLOCK) ON B.COMP_CODE   = A.COMP_CODE
		                                             AND B.CUSTOM_CODE = A.CUSTOM_CODE
		           LEFT JOIN BSA100T E WITH (NOLOCK) ON E.COMP_CODE   = A.COMP_CODE
													AND E.MAIN_CODE   = N'B004'
													AND E.SUB_CODE   != '$'
													AND E.REF_CODE1   = 'Y'
		           INNER JOIN BPR100T C WITH (NOLOCK) ON C.COMP_CODE   = A.COMP_CODE
		                                             AND C.ITEM_CODE   = A.ITEM_CODE
													<if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">
													 AND A.CUSTOM_CODE    LIKE #{CUSTOM_CODE} + '%'
													</if>
													<if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME)">
													 AND B.CUSTOM_NAME    LIKE #{CUSTOM_NAME} + '%'
													</if>
													<if test="@foren.Ognl@isNotEmpty(ISSUE_REQ_PRSN)">
													 AND A.ISSUE_REQ_PRSN    = #{ISSUE_REQ_PRSN}
													</if>
													<if test="@foren.Ognl@isNotEmpty(ORDER_TYPE)">
													 AND A.ORDER_TYPE        = #{ORDER_TYPE}
													</if>
													<if test="@foren.Ognl@isNotEmpty(INOUT_TYPE_DETAIL)">
													 AND A.INOUT_TYPE_DETAIL = #{INOUT_TYPE_DETAIL}
													</if>
													<if test="@foren.Ognl@isNotEmpty(ISSUE_REQ_DATE_FR)">
													 AND A.ISSUE_REQ_DATE   &gt;= #{ISSUE_REQ_DATE_FR}
													</if>
													<if test="@foren.Ognl@isNotEmpty(ISSUE_REQ_DATE_TO)">
													 AND A.ISSUE_REQ_DATE   &lt;= #{ISSUE_REQ_DATE_TO}
													</if>
													<if test="@foren.Ognl@isNotEmpty(ISSUE_DIV_CODE)">
													 AND A.ISSUE_DIV_CODE    = #{ISSUE_DIV_CODE}
													</if>
													<if test="@foren.Ognl@isNotEmpty(WH_CODE)">
													 AND A.WH_CODE           = #{WH_CODE}
													</if>
													<if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
													 AND A.ITEM_CODE      LIKE #{ITEM_CODE} + '%'
													</if>
													<if test="@foren.Ognl@isNotEmpty(ITEM_NAME)">
													 AND C.ITEM_NAME      LIKE #{ITEM_NAME} + '%'
													</if>
													<if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
													 AND A.PROJECT_NO        = #{PROJECT_NO}
													</if>
													<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
													 AND A.DIV_CODE          = #{DIV_CODE}
													</if>
													<if test="@foren.Ognl@isNotEmpty(COMP_CODE)">
													 AND A.COMP_CODE         = #{COMP_CODE}
													</if>
		    ORDER BY A.CUSTOM_CODE, A.ISSUE_REQ_DATE, A.ISSUE_REQ_NUM
			SET NOCOUNT OFF
			SET ARITHABORT OFF
		END
    </select>
    <select id="outStorageServiceImpl.selectPmp100List" parameterType="Map" resultType="rMap">

   		/* pmp120skrv.Cpmp120skrv [fnPmp120QStd] QUERY01 */
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE @CompCode		NVARCHAR(08)	/* 법인코드  */
			      , @UserId			NVARCHAR(100)	/* 사용자ID */
			      , @LangType		NVARCHAR(2)		/* 언어구분 */
			      , @RefItem		NVARCHAR(01)
			      , @DateFormat		NVARCHAR(10)

			SET @CompCode = #{S_COMP_CODE}
			SET @UserId   = #{S_USER_ID}
			SET @LangType = #{S_LANG_CODE}

			/* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
				FROM BSA300T WITH (NOLOCK)
				WHERE USER_ID = @UserId

			SET @RefItem = ISNULL(@RefItem, N'0')

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
				FROM BSA100T WITH (NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND MAIN_CODE = N'B044'
				AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		/*  조회  */
			SELECT DISTINCT
					   CASE WHEN A.WORK_END_YN != 'Y'
						 	THEN CASE WHEN D.CONTROL_STATUS = '9'
								   	  THEN '9'
								      ELSE '3'
					   END
									  ELSE '8'
						END AS WORK_END_YN
					 , A.WKORD_NUM
					 , A.ITEM_CODE
		/*			 , uniLITE.fnItemNameComp(N'MASTER',N'UNILITE5', C.ITEM_CODE) AS ITEM_NAME  */
			 	 , (CASE WHEN @RefItem = '1' THEN C.ITEM_NAME1
				         WHEN @RefItem = '2' THEN C.ITEM_NAME2
				                             ELSE C.ITEM_NAME
				     END)                                                                               AS ITEM_NAME
					 , C.SPEC
					 , C.STOCK_UNIT
		/*			 , uniLITE.fnGetUserDate(A.COMP_CODE, A.PRODT_START_DATE) AS PRODT_START_DATE */
				 , (CASE WHEN ISNULL(A.PRODT_START_DATE, '') = ''
				         THEN ''
				         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_START_DATE, 1, 4))
				                                                 , 'MM'  , SUBSTRING(A.PRODT_START_DATE, 5, 2))
				                                                 , 'DD'  , SUBSTRING(A.PRODT_START_DATE, 7, 2))
				     END)																				AS PRODT_START_DATE

		/*			 , uniLITE.fnGetUserDate(A.COMP_CODE, A.PRODT_END_DATE)   AS PRODT_END_DATE */
				 , (CASE WHEN ISNULL(A.PRODT_END_DATE, '') = ''
				         THEN ''
				         ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.PRODT_END_DATE, 1, 4))
				                                                 , 'MM'  , SUBSTRING(A.PRODT_END_DATE, 5, 2))
				                                                 , 'DD'  , SUBSTRING(A.PRODT_END_DATE, 7, 2))
				     END)																				AS PRODT_END_DATE
					 , ISNULL(A.WKORD_Q, 0) WKORD_Q
					 , ISNULL(A.PRODT_Q, 0) PRODT_Q
					 , ISNULL(A.WORK_Q, 0) WORK_Q
					 , A.REMARK REMARK1
					 , B.ORDER_NUM
					 , CASE WHEN B.PLAN_TYPE != 'T'
								 THEN ISNULL((SELECT
													 ISNULL(ORDER_Q, 0) ORDER_Q
												FROM SOF110T WITH (NOLOCK)
											   WHERE COMP_CODE = @CompCode
												 AND ORDER_NUM = B.ORDER_NUM
												 AND SER_NO    = B.SEQ), 0)
								 ELSE ISNULL((SELECT
													 ISNULL(QTY, 0) * ISNULL(TRANS_RATE, 0) ORDER_Q
												FROM TEA110T WITH (NOLOCK)
											   WHERE COMP_CODE = @CompCode
												 AND SO_SER_NO = B.ORDER_NUM
												 AND SO_SER    = B.SEQ), 0)
						END ORDER_Q
					 , CASE WHEN B.PLAN_TYPE != 'T'
								 THEN (SELECT uniLITE.fnGetUserDate(COMP_CODE, DVRY_DATE)     AS DVRY_DATE
										FROM SOF110T WITH (NOLOCK)
										WHERE COMP_CODE = @CompCode
											AND ORDER_NUM = B.ORDER_NUM
											AND SER_NO    = B.SEQ)
								 ELSE (SELECT uniLITE.fnGetUserDate(COMP_CODE, DELIVERY_DATE) AS DVRY_DATE
										FROM TEA110T WITH (NOLOCK)
										WHERE COMP_CODE = @CompCode
											AND SO_SER_NO = B.ORDER_NUM
											AND SO_SER    = B.SEQ)
						END DVRY_DATE
					 , A.LOT_NO
					 , B.REMARK REMARK2
					 , A.PROJECT_NO
					 , A.PJT_CODE
					 , A.PRODT_WKORD_DATE
					 , A.WORK_SHOP_CODE
					 , C.BARCODE
					 , C.SPEC
					 , E.ORDER_UNIT
				  FROM PMP100T A WITH (NOLOCK)
					   LEFT JOIN PPL100T B WITH (NOLOCK) ON A.COMP_CODE   = B.COMP_CODE
														AND A.DIV_CODE    = B.DIV_CODE
														AND A.WK_PLAN_NUM = B.WK_PLAN_NUM
					   LEFT JOIN BPR100T C WITH (NOLOCK) ON A.COMP_CODE   = C.COMP_CODE
														AND A.ITEM_CODE   = C.ITEM_CODE
					   LEFT JOIN BPR200T E WITH (NOLOCK) ON E.COMP_CODE = C.COMP_CODE
                                                      AND E.DIV_CODE = #{DIV_CODE}
                                                      AND E.ITEM_CODE = C.ITEM_CODE
					   INNER JOIN (SELECT DISTINCT
										  E.WKORD_NUM
										, ISNULL(F.CONTROL_STATUS, 3) AS CONTROL_STATUS
									 FROM           PMP100T E WITH (NOLOCK)
										  LEFT JOIN PMR100T F WITH (NOLOCK) ON E.COMP_CODE   = F.COMP_CODE
																		   AND E.LINE_END_YN = F.LINE_END_YN
																		   AND E.WKORD_NUM   = F.WKORD_NUM
									WHERE E.COMP_CODE   = @CompCode
									  AND E.LINE_END_YN = 'Y'
									GROUP BY E.WKORD_NUM, F.CONTROL_STATUS) AS D ON A.WKORD_NUM = D.WKORD_NUM

				 WHERE A.COMP_CODE = @CompCode
				   AND A.LINE_END_YN = 'Y'

				/*조회조건*/
				<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
				   AND A.DIV_CODE = #{DIV_CODE}									/*사업장*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(WORK_SHOP_CODE)">
				   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}						/*작업장*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(PRODT_START_DATE_FR)">
				   AND A.PRODT_START_DATE &gt;= #{PRODT_START_DATE_FR}			/*착수예정일 FR*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(PRODT_START_DATE_TO)">
				   AND A.PRODT_START_DATE &lt;= #{PRODT_START_DATE_TO}			/*착수예정일 TO*/
				</if>

				/* 진행사항 조건 */
				/* 전체*/
				/* 진행*/
				<if test="WORK_END_YN == &quot;N&quot;">  /* 진행 */
				   AND A.WORK_END_YN LIKE N'N%'
				   AND D.CONTROL_STATUS != '9'
				</if>
				/* 완료*/
				<if test="WORK_END_YN == &quot;Y&quot;">   /* 완료 */
				   AND A.WORK_END_YN LIKE N'N%'
				   AND D.CONTROL_STATUS LIKE N'9%'
				</if>
				/* 마감*/
				<if test="WORK_END_YN == &quot;F&quot;">    /* 마감 */
				   AND A.WORK_END_YN LIKE N'Y%'
				</if>

			SET NOCOUNT OFF
			SET ARITHABORT OFF
		END
	</select>

    <select id="outStorageServiceImpl.selectPmp300List" parameterType="Map" resultType="rMap">

   		/* pmp300skrv.Cpmp300skrv [fnPmp300QStd] QUERY01 */
		BEGIN
			SET NOCOUNT ON
			SET ARITHABORT ON

			DECLARE @CompCode		NVARCHAR(08)	/* 법인코드  */
			      , @UserId			NVARCHAR(100)	/* 사용자ID */
			      , @LangType		NVARCHAR(2)		/* 언어구분 */
			      , @RefItem		NVARCHAR(01)
			      , @DateFormat		NVARCHAR(10)

			SET @CompCode = #{S_COMP_CODE}
			SET @UserId   = #{S_USER_ID}
			SET @LangType = #{S_LANG_CODE}

			/* 명칭 참조 유형 */
			SELECT TOP 1 @RefItem = REF_ITEM
				FROM BSA300T WITH (NOLOCK)
				WHERE USER_ID = @UserId

			SET @RefItem = ISNULL(@RefItem, N'0')

			/* 날짜 포맷 유형 설정 */
			SELECT TOP 1 @DateFormat = CODE_NAME
				FROM BSA100T WITH (NOLOCK)
				WHERE COMP_CODE = @CompCode
				AND MAIN_CODE = N'B044'
				AND REF_CODE1 = N'Y'

			SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')

		/*  조회  */
			SELECT
					  A.OUTSTOCK_NUM as WKORD_NUM
					 , (CASE WHEN ISNULL(A.OUTSTOCK_REQ_DATE, '') = ''
	                 		 THEN ''
	                 		 ELSE REPLACE(REPLACE(REPLACE(@DateFormat, 'YYYY', SUBSTRING(A.OUTSTOCK_REQ_DATE, 1, 4))
	                         		                                 , 'MM'  , SUBSTRING(A.OUTSTOCK_REQ_DATE, 5, 2))
	                                 		                         , 'DD'  , SUBSTRING(A.OUTSTOCK_REQ_DATE, 7, 2))
	             		END) AS PRODT_WKORD_DATE
	             	 , A.WORK_SHOP_CODE
			  		 , SUM(ISNULL(A.OUTSTOCK_REQ_Q, 0)) AS WKORD_Q
			  		 , SUM(ISNULL(A.OUTSTOCK_Q,     0)) AS PRODT_Q

				  FROM PMP300T A WITH (NOLOCK)
				 WHERE A.COMP_CODE = @CompCode

				/*조회조건*/
				<if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
				   AND A.DIV_CODE = #{DIV_CODE}									/*사업장*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(WORK_SHOP_CODE)">
				   AND A.WORK_SHOP_CODE = #{WORK_SHOP_CODE}						/*작업장*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(PRODT_START_DATE_FR)">
				   AND A.OUTSTOCK_REQ_DATE &gt;= #{PRODT_START_DATE_FR}			/*착수예정일 FR*/
				</if>
				<if test="@foren.Ognl@isNotEmpty(PRODT_START_DATE_TO)">
				   AND A.OUTSTOCK_REQ_DATE &lt;= #{PRODT_START_DATE_TO}			/*착수예정일 TO*/
				</if>
	    		GROUP BY A.COMP_CODE, A.WORK_SHOP_CODE, A.OUTSTOCK_NUM, A.OUTSTOCK_REQ_DATE
				ORDER BY A.OUTSTOCK_REQ_DATE DESC

			SET NOCOUNT OFF
			SET ARITHABORT OFF
		END
	</select>

	<select id="outStorageServiceImpl.selectOutStorageDetailList" parameterType="Map" resultType="rMap">        /* 출고요청참조 */
        --mtr200ukrv.Cmtr200ukrv[fnMtr200QRef] Query01
        CREATE TABLE #PMP300T_TEMP
        (      COMP_CODE           NVARCHAR(08)    NOT NULL DEFAULT 'MASTER'
             , DIV_CODE            NVARCHAR(08)    NOT NULL
             , OUTSTOCK_NUM        NVARCHAR(20)    NOT NULL
             , ITEM_CODE           NVARCHAR(20)    NOT NULL
             , REF_WKORD_NUM       NVARCHAR(20)    NOT NULL
             , PATH_CODE           NVARCHAR(08)    NOT NULL
        )
        CREATE INDEX PMP300T_TEMP_IDX01 ON #PMP300T_TEMP(COMP_CODE, DIV_CODE, OUTSTOCK_NUM, ITEM_CODE, REF_WKORD_NUM, PATH_CODE)


        --mtr200ukrv.Cmtr200ukrv[fnMtr200QRef] Query03
        DECLARE     @COMP_CODE              NVARCHAR(08)            -- (필수) 법인코드
                  , @DIV_CODE               NVARCHAR(08)            -- (필수) 사업장코드
                  , @WORK_SHOP_CODE         NVARCHAR(08)            -- (선택) 작업장
                  , @REQ_FR_DATE            NVARCHAR(08)            -- (선택) 출고요청일자(FROM)
                  , @REQ_TO_DATE            NVARCHAR(08)            -- (선택) 출고요청일자(TO)
                  , @OUT_WH_CODE            NVARCHAR(08)            -- (선택) 출고창고
                  , @ITEM_CODE              NVARCHAR(20)            -- (선택) 품목코드
                  , @ITEM_NAME              NVARCHAR(200)           -- (선택) 품목명
                  , @OUTSTOCK_NUM           NVARCHAR(20)            -- (선택) 출고요청번호
                  , @WKORD_NUM              NVARCHAR(20)            -- (선택) 작업지시번호
                  , @INOUT_CODE_TYPE        NVARCHAR(01)            -- (필수) 출고처구분
                  , @MAIN_WH_CODE           NVARCHAR(08)            -- (필수) 주창고
                  , @WORK_WH_CODE           NVARCHAR(08)            -- (필수) 가공창고
                  , @WH_CELL_CODE           NVARCHAR(20)            -- (필수) Cell창고
                  , @LOT_NO                 NVARCHAR(40)            -- (선택) LOT NO
                  , @USER_ID                NVARCHAR(20)            -- (필수) 사용자ID

        SET @COMP_CODE              = #{S_COMP_CODE}
        SET @DIV_CODE               = #{DIV_CODE}
        SET @WORK_SHOP_CODE         = #{WORK_SHOP_CODE}
        SET @REQ_FR_DATE            = #{REQ_FR_DATE}
        SET @REQ_TO_DATE            = #{REQ_TO_DATE}
        SET @OUT_WH_CODE            = #{OUT_WH_CODE}
        SET @ITEM_CODE              = #{ITEM_CODE}
        SET @ITEM_NAME              = #{ITEM_NAME}
        SET @OUTSTOCK_NUM           = #{OUTSTOCK_NUM}
        SET @WKORD_NUM              = #{WKORD_NUM}
        SET @INOUT_CODE_TYPE        = #{INOUT_CODE_TYPE}
        SET @MAIN_WH_CODE           = #{MAIN_WH_CODE}
        SET @WORK_WH_CODE           = #{WORK_WH_CODE}
        SET @WH_CELL_CODE           = #{WH_CELL_CODE}
        SET @LOT_NO                 = #{LOT_NO}
        SET @USER_ID                = #{S_USER_ID}

        DECLARE     @RefItem                NVARCHAR(01)             -- 사용자 품목명 참조 유형

        SELECT TOP 1 @RefItem = REF_ITEM
        FROM   BSA300T WITH (NOLOCK)
        WHERE  COMP_CODE = @COMP_CODE
        AND    USER_ID   = @USER_ID

        SET @RefItem = ISNULL(@RefItem, '0')

        SELECT CAST(0 AS BIT)                                                           AS CHOICE
             , A.COMP_CODE
             , A.DIV_CODE
             , A.WORK_SHOP_CODE
             , C4.TREE_NAME                                                             AS WORK_SHOP_NAME
             , CASE WHEN ISNULL(B.WH_CODE, '') = '' THEN
                         CASE WHEN C2.COMMITEM_YN = 'Y' THEN ISNULL(C4.SECTION_CD, ISNULL(C4.WH_CODE, ''))  -- 공용창고
                              ELSE ISNULL(C4.WH_CODE, '')                                                   -- 가공창고
                         END
                    ELSE B.WH_CODE
               END                                                                      AS WORK_WH_CODE
             , C5.TREE_NAME                                                             AS WORK_WH_NAME
--             , ''                                                                     AS WORK_WH_CELL_CODE
              , (SELECT TOP 1 WH_CELL_CODE FROM BSA230T WITH(NOLOCK)
                                          WHERE COMP_CODE  = @COMP_CODE
                                            AND TYPE_LEVEL = @DIV_CODE
                                            AND TREE_CODE  = A.WORK_SHOP_CODE
                                            AND WH_CODE    = (CASE WHEN ISNULL(B.WH_CODE, '') = '' THEN
                                                                       CASE WHEN C2.COMMITEM_YN = 'Y' THEN ISNULL(C4.SECTION_CD, ISNULL(C4.WH_CODE, ''))  -- 공용창고
                                                                        ELSE ISNULL(C4.WH_CODE, '')                                                   -- 가공창고
                                                                       END
                                                             ELSE B.WH_CODE
                                                             END)
                                                                                      ) AS WORK_WH_CELL_CODE
             , ''                                                                       AS WORK_WH_CELL_NAME
             , A.ITEM_CODE
             , CASE WHEN @RefItem = '0' THEN C1.ITEM_NAME
                    WHEN @RefItem = '1' THEN C1.ITEM_NAME1
                    WHEN @RefItem = '2' THEN C1.ITEM_NAME2
                    ELSE                     C1.ITEM_NAME
               END                                                                      AS ITEM_NAME
             , C1.SPEC
             , C1.STOCK_UNIT

             , (CASE WHEN C1.BARCODE IS NULL THEN C1.ITEM_CODE
   				  		  WHEN C1.BARCODE ='' THEN C1.ITEM_CODE
   				  		  ELSE C1.BARCODE END)	AS BARCODE
             , A.PATH_CODE
             , uniLITE.fnGetUserDate(A.COMP_CODE, A.OUTSTOCK_REQ_DATE)                  AS OUTSTOCK_REQ_DATE
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(A.OUTSTOCK_REQ_Q, 0), 'M_FSET_QS')   AS OUTSTOCK_REQ_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(A.OUTSTOCK_Q, 0),     'M_FSET_QS')   AS OUTSTOCK_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(A.OUTSTOCK_REQ_Q, 0)
                                          - ISNULL(A.OUTSTOCK_Q, 0),     'M_FSET_QS')   AS NOT_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(D.STOCK_Q, 0),        'M_FSET_QS')   AS STOCK_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(D.GOOD_STOCK_Q, 0),   'M_FSET_QS')   AS GOOD_STOCK_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(D.BAD_STOCK_Q, 0),    'M_FSET_QS')   AS BAD_STOCK_Q
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(D.AVERAGE_P, 0),      'M_FSET_PS')   AS AVERAGE_P
             , C2.WH_CODE                                                               AS MAIN_WH_CODE
             , C7.TREE_NAME                                                             AS MAIN_WH_NAME
             , A.OUTSTOCK_NUM
             , A.CONTROL_STATUS
             , uniLITE.fnFormat(@COMP_CODE, ISNULL(A.CANCEL_Q, 0),       'M_FSET_QS')   AS CANCEL_Q
             , A.REMARK
             , A.PROJECT_NO
             , @OUT_WH_CODE                                                             AS WH_CODE
             , @WH_CELL_CODE                                                            AS WH_CELL_CODE
             , A.REF_WKORD_NUM
             , ISNULL(C.LOT_NO, '')                                                     AS WK_LOT_NO
             , ISNULL(C.REMARK, '')                                                     AS WK_REMARK
             , ISNULL(C.PROJECT_NO, '')                                                 AS WK_PROJECT_NO
             , C.ITEM_CODE                                                              AS PROD_ITEM_CODE
             , C2.LOT_YN
             , CASE WHEN @RefItem = '0' THEN C3.ITEM_NAME
                    WHEN @RefItem = '1' THEN C3.ITEM_NAME1
                    WHEN @RefItem = '2' THEN C3.ITEM_NAME2
                    ELSE                     C3.ITEM_NAME
               END                                                                      AS PROD_ITEM_NAME
        FROM               PMP300T      A  WITH (NOLOCK)
               LEFT  JOIN  PMP200T      B  WITH (NOLOCK) ON B.COMP_CODE     = A.COMP_CODE
                                                        AND B.DIV_CODE      = A.DIV_CODE
                                                        AND B.ITEM_CODE     = A.ITEM_CODE
                                                        AND B.WKORD_NUM     = A.REF_WKORD_NUM
                                                        AND B.PATH_CODE     = A.PATH_CODE
               LEFT  JOIN  PMP100TV1    C  WITH (NOLOCK) ON C.COMP_CODE     = A.COMP_CODE
                                                        AND C.DIV_CODE      = A.DIV_CODE
                                                        AND C.WKORD_NUM     = A.REF_WKORD_NUM
               LEFT  JOIN  BIV100T      D  WITH (NOLOCK) ON D.COMP_CODE     = A.COMP_CODE
                                                        AND D.DIV_CODE      = A.DIV_CODE
                                                        AND D.ITEM_CODE     = A.ITEM_CODE
                                                        AND D.WH_CODE       = @OUT_WH_CODE
               LEFT  JOIN #PMP300T_TEMP E  WITH (NOLOCK) ON E.COMP_CODE     = A.COMP_CODE
                                                        AND E.DIV_CODE      = A.DIV_CODE
                                                        AND E.OUTSTOCK_NUM  = A.OUTSTOCK_NUM
                                                        AND E.ITEM_CODE     = A.ITEM_CODE
                                                        AND E.REF_WKORD_NUM = A.REF_WKORD_NUM
                                                        AND E.PATH_CODE     = A.PATH_CODE
               INNER JOIN  BPR100T      C1 WITH (NOLOCK) ON C1.COMP_CODE    = A.COMP_CODE
                                                        AND C1.ITEM_CODE    = A.ITEM_CODE
               INNER JOIN  BPR200T      C2 WITH (NOLOCK) ON C2.COMP_CODE    = A.COMP_CODE
                                                        AND C2.DIV_CODE     = A.DIV_CODE
                                                        AND C2.ITEM_CODE    = A.ITEM_CODE
               LEFT  JOIN  BPR100T      C3 WITH (NOLOCK) ON C3.COMP_CODE    = C.COMP_CODE
                                                        AND C3.ITEM_CODE    = C.ITEM_CODE
               INNER JOIN  BSA230T      C4 WITH (NOLOCK) ON C4.COMP_CODE    = A.COMP_CODE
                                                        AND C4.TYPE_LEVEL   = A.DIV_CODE
                                                        AND C4.TREE_CODE    = A.WORK_SHOP_CODE
               LEFT  JOIN  BSA220T      C5 WITH (NOLOCK) ON C5.COMP_CODE    = C4.COMP_CODE
                                                        AND C5.TYPE_LEVEL   = C4.TYPE_LEVEL
                                                        AND C5.TREE_CODE    = CASE WHEN ISNULL(B.WH_CODE, '') = '' THEN
                                                                                        CASE WHEN C2.COMMITEM_YN = 'Y' THEN ISNULL(C4.SECTION_CD, ISNULL(C4.WH_CODE, ''))
                                                                                             ELSE ISNULL(C4.WH_CODE, '')
                                                                                        END
                                                                                   ELSE B.WH_CODE
                                                                              END
               LEFT  JOIN  BSA220T      C7 WITH (NOLOCK) ON C7.COMP_CODE    = C2.COMP_CODE
                                                        AND C7.TYPE_LEVEL   = C2.DIV_CODE
                                                        AND C7.TREE_CODE    = C2.WH_CODE
        WHERE  A.COMP_CODE              = @COMP_CODE
        AND    A.CONTROL_STATUS         &lt; '8'
        AND    A.OUTSTOCK_REQ_Q         &gt; A.OUTSTOCK_Q
        AND    A.DIV_CODE               = @DIV_CODE
        AND    A.AGREE_STATUS           = '2'          -- 승인내역만 조회되도록 추가
        AND    E.OUTSTOCK_NUM          IS NULL

        AND   ((A.WORK_SHOP_CODE        =       @WORK_SHOP_CODE                        AND @WORK_SHOP_CODE != '') OR (@WORK_SHOP_CODE  = ''))
        AND   ((A.OUTSTOCK_REQ_DATE    &gt;=       @REQ_FR_DATE                           AND @REQ_FR_DATE    != '') OR (@REQ_FR_DATE     = ''))
        AND   ((A.OUTSTOCK_REQ_DATE    &lt;=       @REQ_TO_DATE                           AND @REQ_TO_DATE    != '') OR (@REQ_TO_DATE     = ''))
        AND   ((A.ITEM_CODE          LIKE       @ITEM_CODE    + '%'                    AND @ITEM_CODE      != '') OR (@ITEM_CODE       = ''))
        AND   ((C1.ITEM_NAME         LIKE '%' + @ITEM_NAME    + '%' AND @RefItem = '0' AND @ITEM_NAME      != '')
            OR (C1.ITEM_NAME1        LIKE '%' + @ITEM_NAME    + '%' AND @RefItem = '1' AND @ITEM_NAME      != '')
            OR (C1.ITEM_NAME2        LIKE '%' + @ITEM_NAME    + '%' AND @RefItem = '2' AND @ITEM_NAME      != '') OR (@ITEM_NAME       = ''))
        --AND   ((A.OUTSTOCK_NUM       LIKE       @OUTSTOCK_NUM + '%'                    AND @OUTSTOCK_NUM   != '') OR (@OUTSTOCK_NUM    = ''))
        AND   A.OUTSTOCK_NUM      =       @WKORD_NUM

            --'출고처구분 : 창고  (가공창고가 설정되어 있는 데이터 조회), 작업장(가공창고가 설정되어 있지 않은 데이터 조회)
        --AND   ((ISNULL(C5.TREE_CODE, '') != '' AND @INOUT_CODE_TYPE = '2') OR (ISNULL(C5.TREE_CODE, '') = '' AND @INOUT_CODE_TYPE = '3'))

        AND   ((C2.WH_CODE              =       @MAIN_WH_CODE                          AND @MAIN_WH_CODE   != '') OR (@MAIN_WH_CODE    = ''))
        AND   ((C5.TREE_CODE            =       @WORK_WH_CODE                          AND @WORK_WH_CODE   != '') OR (@WORK_WH_CODE    = ''))
        AND   ((C.LOT_NO             LIKE       @LOT_NO       + '%'                    AND @LOT_NO         != '') OR (@LOT_NO          = ''))

        ORDER BY A.COMP_CODE, A.DIV_CODE, A.WORK_SHOP_CODE, C5.TREE_CODE, A.ITEM_CODE, A.PATH_CODE


        DROP TABLE #PMP300T_TEMP
    </select>


    <select id="outStorageServiceImpl.selectOutInstructDetailList" parameterType="Map" resultType="rMap">
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @TimeSI      NVARCHAR(01)
		          , @TimeSR      NVARCHAR(01)
		          , @TimeSS      NVARCHAR(01)

		    SELECT @TimeSI = MAX(CASE WHEN SUB_CODE = 'SI' THEN REF_CODE1 ELSE '' END)
		         , @TimeSR = MAX(CASE WHEN SUB_CODE = 'SR' THEN REF_CODE1 ELSE '' END)
		         , @TimeSS = MAX(CASE WHEN SUB_CODE = 'SS' THEN REF_CODE1 ELSE '' END)

		     FROM BSA100T
		    WHERE COMP_CODE = @CompCode
		      AND MAIN_CODE = N'S048'
		      AND SUB_CODE IN (N'SI', N'SR', N'SS')

		    IF @TimeSI IS NULL
		        SET @TimeSI = 'N'
		    IF @TimeSR IS NULL
		        SET @TimeSR = 'N'
		    IF @TimeSS IS NULL
		        SET @TimeSS = 'N'

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')


		    /* 데이터 조회 */
		    SELECT
		           CAST(0 AS BIT)                                                          AS CHOICE
		         ,(CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                    ELSE C1.CUSTOM_NAME
		            END)                                                                   AS CUSTOM_NAME
		         , A.ITEM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C2.ITEM_NAME1
		                WHEN @RefItem = '2' THEN C2.ITEM_NAME2
		                                    ELSE C2.ITEM_NAME
		            END)                                                                   AS ITEM_NAME
		         , C2.SPEC

		         , (CASE WHEN C2.BARCODE IS NULL THEN A.ITEM_CODE
   				  		  WHEN C2.BARCODE ='' THEN A.ITEM_CODE
   				  		  ELSE C2.BARCODE END)	AS BARCODE
		         , A.ORDER_UNIT
		         , A.TRANS_RATE
		         , CAST(A.ISSUE_REQ_DATE AS DATETIME) AS ISSUE_REQ_DATE
		         ,(CASE WHEN ISNULL(A.ISSUE_DATE , '') = ''
		                     THEN ''
		                     ELSE REPLACE(REPLACE(REPLACE(@DateFormat , 'YYYY' , SUBSTRING(A.ISSUE_DATE, 1, 4))
		                                                              , 'MM'   , SUBSTRING(A.ISSUE_DATE, 5, 2))
		                                                              , 'DD'   , SUBSTRING(A.ISSUE_DATE, 7, 2))
		                END) + RTRIM(' ' + CASE @TimeSR WHEN 'Y' THEN ISNULL(A.DELIVERY_TIME,'')
		                                                ELSE ''
		                                    END)                                          AS ISSUE_DATE
		         ,(A.ISSUE_REQ_QTY - A.ISSUE_QTY)                                         AS NOT_REQ_Q
		         , A.ISSUE_REQ_QTY
		         , A.ISSUE_WGT_Q
		         , A.ISSUE_VOL_Q
		         , ISNULL(D.GOOD_STOCK_Q, 0)                                              AS STOCK_Q
		         , A.WH_CODE
		         , A.ORDER_NUM
		         , A.ISSUE_REQ_NUM
		         , A.ISSUE_REQ_SEQ
		         , A.PROJECT_NO
		         , E.PAY_METHODE1                                                         AS PAY_METHODE1
		         , E1.LC_SER_NO                                                           AS LC_SER_NO
		         , A.LOT_NO
		         , B.RECEIVER_ID
		         , B.RECEIVER_NAME
		         , B.TELEPHONE_NUM1
		         , B.TELEPHONE_NUM2
		         , ISNULL(B.ADDRESS1, '') + ISNULL(B.ADDRESS2, '')                        AS ADDRESS
		         ,(CASE WHEN @RefItem = '1' THEN C6.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C6.CUSTOM_NAME2
		                                    ELSE C6.CUSTOM_NAME
		            END)                                                                  AS ORDER_CUST_CD
		         , A.DIV_CODE
		         , A.CUSTOM_CODE
		         , A.INOUT_TYPE_DETAIL
		         , A.WH_CELL_CODE
		         , C5.WH_CELL_NAME
		         , A.ISSUE_REQ_PRICE
		         , A.ISSUE_REQ_AMT
		         , A.ISSUE_REQ_TAX_AMT
		         , A.TAX_TYPE
		         , A.MONEY_UNIT
		         , A.EXCHANGE_RATE
		         , A.ACCOUNT_YNC
		         , A.DISCOUNT_RATE
		         , A.ISSUE_REQ_PRSN                                                       AS ISSUE_REQ_PRSN
		         , A.DVRY_CUST_CD
		         , A.REMARK
		         , A.SER_NO
		         , A.SALE_CUSTOM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                                     ELSE C4.CUSTOM_NAME
		            END)                                                                  AS SALE_CUST_CD
		         , A.ISSUE_DIV_CODE
		         , A.BILL_TYPE
		         , A.ORDER_TYPE
		         , A.PRICE_YN
		         , A.PO_NUM
		         , A.PO_SEQ
		         , C1.CREDIT_YN
		         , ISNULL(C1.WON_CALC_BAS , '3')                                          AS WON_CALC_BAS
		         , ISNULL(C1.TAX_TYPE     , '1')                                          AS TAX_INOUT
		         , A.AGENT_TYPE
		         , ISNULL(C2.STOCK_CARE_YN, 'Y')                                          AS STOCK_CARE_YN
		         , C2.STOCK_UNIT
		         , C7.DVRY_CUST_NM                                                        AS DVRY_CUST_NAME
		         , C.TAX_INOUT                                                            AS SOF100_TAX_INOUT
		         , CASE WHEN ISNULL(B.RETURN_Q, 0) &gt; 0 THEN 'Y' ELSE 'N' END              AS RETURN_Q_YN
		         , CASE WHEN ISNULL(A.REF_LOC, '1') = '1' THEN ISNULL(B.ORDER_Q, 0)
		                                                  ELSE ISNULL(E1.QTY, 0)
		            END                                                                   AS ORDER_Q
		         , CASE WHEN ISNULL(M1.REF_CODE2, '') = '' THEN M1.SUB_CODE
		                ELSE M1.REF_CODE2
		           END                                                                    AS REF_CODE2
		         , ISNULL(C2.EXCESS_RATE, 0)                                              AS EXCESS_RATE
		         , A.DEPT_CODE
		         , C3.ITEM_ACCOUNT
		         , A.PRICE_TYPE
		         , A.ISSUE_FOR_WGT_P
		         , A.ISSUE_WGT_P
		         , A.ISSUE_FOR_VOL_P
		         , A.ISSUE_VOL_P
		         , A.WGT_UNIT
		         , A.UNIT_WGT
		         , A.VOL_UNIT
		         , A.UNIT_VOL

		      FROM            SRQ100T A  WITH (NOLOCK)
		           LEFT  JOIN SOF110T B  WITH (NOLOCK) ON  B.COMP_CODE      = A.COMP_CODE
		                                              AND  B.DIV_CODE       = A.DIV_CODE
		                                              AND  B.ORDER_NUM      = A.ORDER_NUM
		                                              AND  B.SER_NO         = A.SER_NO
		           LEFT  JOIN SOF100T C  WITH (NOLOCK) ON  C.COMP_CODE      = B.COMP_CODE
		                                              AND  C.DIV_CODE       = B.DIV_CODE
		                                              AND  C.ORDER_NUM      = B.ORDER_NUM
		           LEFT  JOIN BIV100T D  WITH (NOLOCK) ON  D.COMP_CODE      = A.COMP_CODE
		                                              AND  D.DIV_CODE       = A.ISSUE_DIV_CODE
		                                              AND  D.WH_CODE        = A.WH_CODE
		                                              AND  D.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BCM100T C1 WITH (NOLOCK) ON C1.COMP_CODE      = A.COMP_CODE
		                                              AND C1.CUSTOM_CODE    = A.CUSTOM_CODE
		           INNER JOIN BPR100T C2 WITH (NOLOCK) ON C2.COMP_CODE      = A.COMP_CODE
		                                              AND C2.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BPR200T C3 WITH (NOLOCK) ON C3.COMP_CODE      = A.COMP_CODE
		                                              AND C3.DIV_CODE       = A.DIV_CODE
		                                              AND C3.ITEM_CODE      = A.ITEM_CODE
		           LEFT  JOIN BCM100T C4 WITH (NOLOCK) ON C4.COMP_CODE      = A.COMP_CODE
		                                              AND C4.CUSTOM_CODE    = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BSA225T C5 WITH (NOLOCK) ON C5.COMP_CODE      = A.COMP_CODE
		                                              AND C5.DIV_CODE       = A.DIV_CODE
		                                              AND C5.WH_CODE        = A.WH_CODE
		                                              AND C5.WH_CELL_CODE   = A.WH_CELL_CODE
		           LEFT  JOIN BCM100T C6 WITH (NOLOCK) ON C6.COMP_CODE      = C.COMP_CODE
		                                              AND C6.CUSTOM_CODE    = C.CUSTOM_CODE
		           LEFT  JOIN SCM100T C7 WITH (NOLOCK) ON C7.COMP_CODE      = A.COMP_CODE
		                                              AND C7.CUSTOM_CODE    = A.CUSTOM_CODE
		                                              AND CONVERT(NVARCHAR, C7.DVRY_CUST_SEQ) = A.DVRY_CUST_CD
		           LEFT  JOIN BSA100T M1 WITH (NOLOCK) ON M1.COMP_CODE      = A.COMP_CODE
		                                              AND M1.MAIN_CODE      = N'S007'
		                                              AND M1.SUB_CODE       = A.INOUT_TYPE_DETAIL
		           LEFT  JOIN TEA100T E  WITH (NOLOCK) ON E.COMP_CODE       = A.COMP_CODE
		                                              AND E.DIV_CODE        = A.DIV_CODE
		                                              AND E.SO_SER_NO       = A.ORDER_NUM
		           LEFT  JOIN TEA110T E1 WITH (NOLOCK) ON E1.COMP_CODE      = A.COMP_CODE
		                                              AND E1.DIV_CODE       = A.DIV_CODE
		                                              AND E1.SO_SER_NO      = A.ORDER_NUM
		                                              AND E1.SO_SER         = A.SER_NO

		     WHERE A.COMP_CODE        = @CompCode
		      -- AND A.ISSUE_REQ_QTY    &gt; A.ISSUE_QTY
		     <if test="@foren.Ognl@isNotEmpty(CREATE_LOC)">
		       AND ISNULL(A.REF_LOC, '1') = #{CREATE_LOC}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		       AND A.ISSUE_DIV_CODE   	  = #{DIV_CODE}		/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(MONEY_UNIT)">
		       AND A.MONEY_UNIT           = #{MONEY_UNIT}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">
		       AND A.CUSTOM_CODE          = #{CUSTOM_CODE}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		       AND C1.CUSTOM_NAME         = #{CUSTOM_NAME}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(WH_CODE)">
		     AND B.RECEIVER_NAME 	   LIKE #{CREATE_LOC} + '%'   /*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
		       AND A.ITEM_CODE     	   LIKE #{ITEM_CODE} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ITEM_NAME)">
		       AND C2.ITEM_NAME        LIKE #{ITEM_NAME} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_FR)">
		       AND A.ISSUE_DATE       &gt;= #{ISSUE_DATE_FR}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_TO)">
		       AND A.ISSUE_DATE       &lt;= #{ISSUE_DATE_TO}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_REQ_NUM)">
		       AND A.ISSUE_REQ_NUM     = #{ISSUE_REQ_NUM}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		       AND A.PROJECT_NO        LIKE #{PROJECT_NO} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(WH_CODE)">
		       AND A.WH_CODE  			  = #{WH_CODE}
		     </if>

		     GROUP BY A.CUSTOM_CODE      , C1.CUSTOM_NAME    , A.ITEM_CODE        , C2.ITEM_NAME       , C2.ITEM_NAME1
		            , C2.ITEM_NAME2      , C2.SPEC		 	, C2.BARCODE
		            , A.ORDER_UNIT       , A.TRANS_RATE        , A.ISSUE_REQ_DATE   , A.ISSUE_DATE       , A.DELIVERY_TIME
		            , A.ISSUE_REQ_QTY    , A.ISSUE_QTY         , D.GOOD_STOCK_Q     , A.ISSUE_REQ_NUM    , A.ISSUE_REQ_SEQ
		            , A.PROJECT_NO       , A.LOT_NO            , B.RECEIVER_ID      , B.RECEIVER_NAME    , B.TELEPHONE_NUM1
		            , B.TELEPHONE_NUM2   , B.ADDRESS1          , B.ADDRESS2         , C6.CUSTOM_NAME     , C6.CUSTOM_NAME1
		            , C6.CUSTOM_NAME2    , A.INOUT_TYPE_DETAIL , A.ISSUE_DIV_CODE , A.BILL_TYPE
		            , A.WH_CODE          , A.WH_CELL_CODE      , C5.WH_CELL_NAME    , A.ISSUE_REQ_PRICE  , A.ISSUE_REQ_AMT
		            , A.ISSUE_REQ_TAX_AMT, A.TAX_TYPE          , A.MONEY_UNIT       , A.EXCHANGE_RATE    , A.ACCOUNT_YNC
		            , A.DISCOUNT_RATE    , A.ISSUE_REQ_PRSN    , A.DVRY_CUST_CD     , A.REMARK           , A.ORDER_NUM
		            , A.SER_NO           , A.SALE_CUSTOM_CODE  , C4.CUSTOM_NAME     , C4.CUSTOM_NAME1     , C4.CUSTOM_NAME2
		            , A.ORDER_TYPE       , A.PRICE_YN          , A.PO_NUM           , A.PO_SEQ           , C1.CREDIT_YN
		            , C1.WON_CALC_BAS    , C1.TAX_TYPE         , A.AGENT_TYPE       , C2.STOCK_CARE_YN   , C2.STOCK_UNIT
		            , C7.DVRY_CUST_NM    , C.TAX_INOUT         , B.RETURN_Q         , B.ORDER_Q          , M1.REF_CODE2
		            , M1.SUB_CODE        , C2.EXCESS_RATE      , A.DEPT_CODE        , A.COMP_CODE        , A.DIV_CODE
		            , E.PAY_METHODE1     , E1.LC_SER_NO        , C3.ITEM_ACCOUNT    , C1.CUSTOM_NAME1     , C1.CUSTOM_NAME2
		            , A.REF_LOC          , E1.QTY              , A.ISSUE_WGT_Q      , A.ISSUE_VOL_Q
		            , A.PRICE_TYPE       , A.ISSUE_FOR_WGT_P   , A.ISSUE_WGT_P      , A.ISSUE_VOL_P      , A.ISSUE_FOR_VOL_P
		            , A.WGT_UNIT         , A.UNIT_WGT          , A.VOL_UNIT         , A.UNIT_VOL

		     ORDER BY A.ISSUE_REQ_NUM, A.ISSUE_REQ_SEQ, C1.CUSTOM_NAME, A.ISSUE_REQ_PRSN DESC, A.ITEM_CODE, A.ISSUE_DATE

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
    </select>
    <select id="outStorageServiceImpl.selectOutInstructDetailList_yg" parameterType="Map" resultType="rMap">
		BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @TimeSI      NVARCHAR(01)
		          , @TimeSR      NVARCHAR(01)
		          , @TimeSS      NVARCHAR(01)

		    SELECT @TimeSI = MAX(CASE WHEN SUB_CODE = 'SI' THEN REF_CODE1 ELSE '' END)
		         , @TimeSR = MAX(CASE WHEN SUB_CODE = 'SR' THEN REF_CODE1 ELSE '' END)
		         , @TimeSS = MAX(CASE WHEN SUB_CODE = 'SS' THEN REF_CODE1 ELSE '' END)

		     FROM BSA100T
		    WHERE COMP_CODE = @CompCode
		      AND MAIN_CODE = N'S048'
		      AND SUB_CODE IN (N'SI', N'SR', N'SS')

		    IF @TimeSI IS NULL
		        SET @TimeSI = 'N'
		    IF @TimeSR IS NULL
		        SET @TimeSR = 'N'
		    IF @TimeSS IS NULL
		        SET @TimeSS = 'N'

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')


		    /* 데이터 조회 */
		    SELECT
		           CAST(0 AS BIT)                                                          AS CHOICE
		         ,(CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                    ELSE C1.CUSTOM_NAME
		            END)                                                                   AS CUSTOM_NAME
		         , A.ITEM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C2.ITEM_NAME1
		                WHEN @RefItem = '2' THEN C2.ITEM_NAME2
		                                    ELSE C2.ITEM_NAME
		            END)                                                                   AS ITEM_NAME
		         , C2.SPEC

		         , (CASE WHEN C2.BARCODE IS NULL THEN A.ITEM_CODE
   				  		  WHEN C2.BARCODE ='' THEN A.ITEM_CODE
   				  		  ELSE C2.BARCODE END)	AS BARCODE
		         , A.ORDER_UNIT
		         , A.TRANS_RATE
		         , CAST(A.ISSUE_REQ_DATE AS DATETIME) AS ISSUE_REQ_DATE
		         ,(CASE WHEN ISNULL(A.ISSUE_DATE , '') = ''
		                     THEN ''
		                     ELSE REPLACE(REPLACE(REPLACE(@DateFormat , 'YYYY' , SUBSTRING(A.ISSUE_DATE, 1, 4))
		                                                              , 'MM'   , SUBSTRING(A.ISSUE_DATE, 5, 2))
		                                                              , 'DD'   , SUBSTRING(A.ISSUE_DATE, 7, 2))
		                END) + RTRIM(' ' + CASE @TimeSR WHEN 'Y' THEN ISNULL(A.DELIVERY_TIME,'')
		                                                ELSE ''
		                                    END)                                          AS ISSUE_DATE
		         ,(A.ISSUE_REQ_QTY - A.ISSUE_QTY)                                         AS NOT_REQ_Q
		         , A.ISSUE_REQ_QTY
		         , A.ISSUE_WGT_Q
		         , A.ISSUE_VOL_Q
		         , ISNULL(D.GOOD_STOCK_Q, 0)                                              AS STOCK_Q
		         , A.WH_CODE
		         , A.ORDER_NUM
		         , A.ISSUE_REQ_NUM
		         , A.ISSUE_REQ_SEQ
		         , A.PROJECT_NO
		         , E.PAY_METHODE1                                                         AS PAY_METHODE1
		         , E1.LC_SER_NO                                                           AS LC_SER_NO
		        -- , A.LOT_NO
		         , B.RECEIVER_ID
		         , B.RECEIVER_NAME
		         , B.TELEPHONE_NUM1
		         , B.TELEPHONE_NUM2
		         , ISNULL(B.ADDRESS1, '') + ISNULL(B.ADDRESS2, '')                        AS ADDRESS
		         ,(CASE WHEN @RefItem = '1' THEN C6.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C6.CUSTOM_NAME2
		                                    ELSE C6.CUSTOM_NAME
		            END)                                                                  AS ORDER_CUST_CD
		         , A.DIV_CODE
		         , A.CUSTOM_CODE
		         , A.INOUT_TYPE_DETAIL
		         , A.WH_CELL_CODE
		         , C5.WH_CELL_NAME
		         , A.ISSUE_REQ_PRICE
		         , A.ISSUE_REQ_AMT
		         , A.ISSUE_REQ_TAX_AMT
		         , A.TAX_TYPE
		         , A.MONEY_UNIT
		         , A.EXCHANGE_RATE
		         , A.ACCOUNT_YNC
		         , A.DISCOUNT_RATE
		         , A.ISSUE_REQ_PRSN                                                       AS ISSUE_REQ_PRSN
		         , A.DVRY_CUST_CD
		         , A.REMARK
		         , A.SER_NO
		         , A.SALE_CUSTOM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                                     ELSE C4.CUSTOM_NAME
		            END)                                                                  AS SALE_CUST_CD
		         , A.ISSUE_DIV_CODE
		         , A.BILL_TYPE
		         , A.ORDER_TYPE
		         , A.PRICE_YN
		         , A.PO_NUM
		         , A.PO_SEQ
		         , C1.CREDIT_YN
		         , ISNULL(C1.WON_CALC_BAS , '3')                                          AS WON_CALC_BAS
		         , ISNULL(C1.TAX_TYPE     , '1')                                          AS TAX_INOUT
		         , A.AGENT_TYPE
		         , ISNULL(C2.STOCK_CARE_YN, 'Y')                                          AS STOCK_CARE_YN
		         , C2.STOCK_UNIT
		         , C7.DVRY_CUST_NM                                                        AS DVRY_CUST_NAME
		         , C.TAX_INOUT                                                            AS SOF100_TAX_INOUT
		         , CASE WHEN ISNULL(B.RETURN_Q, 0) &gt; 0 THEN 'Y' ELSE 'N' END              AS RETURN_Q_YN
		         , CASE WHEN ISNULL(A.REF_LOC, '1') = '1' THEN ISNULL(B.ORDER_Q, 0)
		                                                  ELSE ISNULL(E1.QTY, 0)
		            END                                                                   AS ORDER_Q
		         , CASE WHEN ISNULL(M1.REF_CODE2, '') = '' THEN M1.SUB_CODE
		                ELSE M1.REF_CODE2
		           END                                                                    AS REF_CODE2
		         , ISNULL(C2.EXCESS_RATE, 0)                                              AS EXCESS_RATE
		         , A.DEPT_CODE
		         , C3.ITEM_ACCOUNT
		         , A.PRICE_TYPE
		         , A.ISSUE_FOR_WGT_P
		         , A.ISSUE_WGT_P
		         , A.ISSUE_FOR_VOL_P
		         , A.ISSUE_VOL_P
		         , A.WGT_UNIT
		         , A.UNIT_WGT
		         , A.VOL_UNIT
		         , A.UNIT_VOL
		      FROM            SRQ100T A  WITH (NOLOCK)
		           LEFT  JOIN SOF110T B  WITH (NOLOCK) ON  B.COMP_CODE      = A.COMP_CODE
		                                              AND  B.DIV_CODE       = A.DIV_CODE
		                                              AND  B.ORDER_NUM      = A.ORDER_NUM
		                                              AND  B.SER_NO         = A.SER_NO
		           LEFT  JOIN SOF100T C  WITH (NOLOCK) ON  C.COMP_CODE      = B.COMP_CODE
		                                              AND  C.DIV_CODE       = B.DIV_CODE
		                                              AND  C.ORDER_NUM      = B.ORDER_NUM
		           LEFT  JOIN BIV100T D  WITH (NOLOCK) ON  D.COMP_CODE      = A.COMP_CODE
		                                              AND  D.DIV_CODE       = A.ISSUE_DIV_CODE
		                                              AND  D.WH_CODE        = A.WH_CODE
		                                              AND  D.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BCM100T C1 WITH (NOLOCK) ON C1.COMP_CODE      = A.COMP_CODE
		                                              AND C1.CUSTOM_CODE    = A.CUSTOM_CODE
		           INNER JOIN BPR100T C2 WITH (NOLOCK) ON C2.COMP_CODE      = A.COMP_CODE
		                                              AND C2.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BPR200T C3 WITH (NOLOCK) ON C3.COMP_CODE      = A.COMP_CODE
		                                              AND C3.DIV_CODE       = A.DIV_CODE
		                                              AND C3.ITEM_CODE      = A.ITEM_CODE
		           LEFT  JOIN BCM100T C4 WITH (NOLOCK) ON C4.COMP_CODE      = A.COMP_CODE
		                                              AND C4.CUSTOM_CODE    = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BSA225T C5 WITH (NOLOCK) ON C5.COMP_CODE      = A.COMP_CODE
		                                              AND C5.DIV_CODE       = A.DIV_CODE
		                                              AND C5.WH_CODE        = A.WH_CODE
		                                              AND C5.WH_CELL_CODE   = A.WH_CELL_CODE
		           LEFT  JOIN BCM100T C6 WITH (NOLOCK) ON C6.COMP_CODE      = C.COMP_CODE
		                                              AND C6.CUSTOM_CODE    = C.CUSTOM_CODE
		           LEFT  JOIN SCM100T C7 WITH (NOLOCK) ON C7.COMP_CODE      = A.COMP_CODE
		                                              AND C7.CUSTOM_CODE    = A.CUSTOM_CODE
		                                              AND CONVERT(NVARCHAR, C7.DVRY_CUST_SEQ) = A.DVRY_CUST_CD
		           LEFT  JOIN BSA100T M1 WITH (NOLOCK) ON M1.COMP_CODE      = A.COMP_CODE
		                                              AND M1.MAIN_CODE      = N'S007'
		                                              AND M1.SUB_CODE       = A.INOUT_TYPE_DETAIL
		           LEFT  JOIN TEA100T E  WITH (NOLOCK) ON E.COMP_CODE       = A.COMP_CODE
		                                              AND E.DIV_CODE        = A.DIV_CODE
		                                              AND E.SO_SER_NO       = A.ORDER_NUM
		           LEFT  JOIN TEA110T E1 WITH (NOLOCK) ON E1.COMP_CODE      = A.COMP_CODE
		                                              AND E1.DIV_CODE       = A.DIV_CODE
		                                              AND E1.SO_SER_NO      = A.ORDER_NUM
		                                              AND E1.SO_SER         = A.SER_NO

		     WHERE A.COMP_CODE        = @CompCode
		       --AND A.ISSUE_REQ_QTY    &gt; A.ISSUE_QTY
		     <if test="@foren.Ognl@isNotEmpty(CREATE_LOC)">
		       AND ISNULL(A.REF_LOC, '1') = #{CREATE_LOC}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(DIV_CODE)">
		       AND A.ISSUE_DIV_CODE   	  = #{DIV_CODE}		/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(MONEY_UNIT)">
		       AND A.MONEY_UNIT           = #{MONEY_UNIT}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(CUSTOM_CODE)">
		       AND A.CUSTOM_CODE          = #{CUSTOM_CODE}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(CUSTOM_NAME)">
		       AND C1.CUSTOM_NAME         = #{CUSTOM_NAME}	/*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(WH_CODE)">
		     AND B.RECEIVER_NAME 	   LIKE #{CREATE_LOC} + '%'   /*마스터폼 param*/
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ITEM_CODE)">
		       AND A.ITEM_CODE     	   LIKE #{ITEM_CODE} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ITEM_NAME)">
		       AND C2.ITEM_NAME        LIKE #{ITEM_NAME} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_FR)">
		       AND A.ISSUE_DATE       &gt;= #{ISSUE_DATE_FR}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_DATE_TO)">
		       AND A.ISSUE_DATE       &lt;= #{ISSUE_DATE_TO}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(ISSUE_REQ_NUM)">
		       AND A.ISSUE_REQ_NUM     = #{ISSUE_REQ_NUM}
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(PROJECT_NO)">
		       AND A.PROJECT_NO        LIKE #{PROJECT_NO} + '%'
		     </if>
		     <if test="@foren.Ognl@isNotEmpty(WH_CODE)">
		       AND A.WH_CODE  			  = #{WH_CODE}
		     </if>

		     GROUP BY A.CUSTOM_CODE      , C1.CUSTOM_NAME    , A.ITEM_CODE        , C2.ITEM_NAME       , C2.ITEM_NAME1
		            , C2.ITEM_NAME2      , C2.SPEC		 	, C2.BARCODE
		            , A.ORDER_UNIT       , A.TRANS_RATE        , A.ISSUE_REQ_DATE   , A.ISSUE_DATE       , A.DELIVERY_TIME
		            , A.ISSUE_REQ_QTY    , A.ISSUE_QTY         , D.GOOD_STOCK_Q     , A.ISSUE_REQ_NUM    , A.ISSUE_REQ_SEQ
		            , A.PROJECT_NO       , A.LOT_NO            , B.RECEIVER_ID      , B.RECEIVER_NAME    , B.TELEPHONE_NUM1
		            , B.TELEPHONE_NUM2   , B.ADDRESS1          , B.ADDRESS2         , C6.CUSTOM_NAME     , C6.CUSTOM_NAME1
		            , C6.CUSTOM_NAME2    , A.INOUT_TYPE_DETAIL , A.ISSUE_DIV_CODE , A.BILL_TYPE
		            , A.WH_CODE          , A.WH_CELL_CODE      , C5.WH_CELL_NAME    , A.ISSUE_REQ_PRICE  , A.ISSUE_REQ_AMT
		            , A.ISSUE_REQ_TAX_AMT, A.TAX_TYPE          , A.MONEY_UNIT       , A.EXCHANGE_RATE    , A.ACCOUNT_YNC
		            , A.DISCOUNT_RATE    , A.ISSUE_REQ_PRSN    , A.DVRY_CUST_CD     , A.REMARK           , A.ORDER_NUM
		            , A.SER_NO           , A.SALE_CUSTOM_CODE  , C4.CUSTOM_NAME     , C4.CUSTOM_NAME1     , C4.CUSTOM_NAME2
		            , A.ORDER_TYPE       , A.PRICE_YN          , A.PO_NUM           , A.PO_SEQ           , C1.CREDIT_YN
		            , C1.WON_CALC_BAS    , C1.TAX_TYPE         , A.AGENT_TYPE       , C2.STOCK_CARE_YN   , C2.STOCK_UNIT
		            , C7.DVRY_CUST_NM    , C.TAX_INOUT         , B.RETURN_Q         , B.ORDER_Q          , M1.REF_CODE2
		            , M1.SUB_CODE        , C2.EXCESS_RATE      , A.DEPT_CODE        , A.COMP_CODE        , A.DIV_CODE
		            , E.PAY_METHODE1     , E1.LC_SER_NO        , C3.ITEM_ACCOUNT    , C1.CUSTOM_NAME1     , C1.CUSTOM_NAME2
		            , A.REF_LOC          , E1.QTY              , A.ISSUE_WGT_Q      , A.ISSUE_VOL_Q
		            , A.PRICE_TYPE       , A.ISSUE_FOR_WGT_P   , A.ISSUE_WGT_P      , A.ISSUE_VOL_P      , A.ISSUE_FOR_VOL_P
		            , A.WGT_UNIT         , A.UNIT_WGT          , A.VOL_UNIT         , A.UNIT_VOL
		     ORDER BY A.ISSUE_REQ_NUM, A.ISSUE_REQ_SEQ, C1.CUSTOM_NAME, A.ISSUE_REQ_PRSN DESC, A.ITEM_CODE, A.ISSUE_DATE

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
    </select>
    <update id="outStorageServiceImpl.updatePmr160t" parameterType="Map">
    	UPDATE PMR160T
    	SET INOUT_NUM = #{INOUT_NUM},
    		INOUT_SEQ = #{INOUT_SEQ}
    	WHERE BOX_BARCODE = #{BOX_BARCODE}
    	  AND ITEM_SERIAL_NO = #{ITEM_SERIAL_NO}
    	  AND COMP_CODE = #{S_COMP_CODE}

    </update>
     <select id="outStorageServiceImpl.selectOutInstructItem_yg1" parameterType="Map" resultType="rMap">
     BEGIN
            SET NOCOUNT ON
            SET ARITHABORT ON

            DECLARE @CompCode       NVARCHAR(08) /* 법인코드                */
                  , @UserId         NVARCHAR(100) /* 사용자ID                */
                  , @LangType       NVARCHAR(2)  /* 언어구분                */
                  , @RefItem        NVARCHAR(01) /* 명칭 참조 유형            */
                  , @DateFormat     NVARCHAR(10) /* 날짜 포맷 유형 설정     */

            SET @CompCode = #{S_COMP_CODE}
            SET @UserId   = #{S_USER_ID}
            SET @LangType = #{S_LANG_CODE}

     	SELECT TOP 1 @RefItem = REF_ITEM
              FROM BSA300T WITH (NOLOCK)
             WHERE USER_ID = @UserId

            SET @RefItem = ISNULL(@RefItem, N'0')

		     SELECT	A.COMP_CODE	,
					A.DIV_CODE	,
					A.BOX_BARCODE	,
					A.ITEM_SERIAL_NO AS BARCODE,
					A.ITEM_SERIAL_NO	,
					A.PACKING_DATE	,
					CASE WHEN ISNULL(A.ITEM_SERIAL_NO, '') = '' THEN ''
		                ELSE RIGHT(A.ITEM_SERIAL_NO,3)
		            END                                                                    AS SERIAL,
		            CASE WHEN ISNULL(A.ITEM_SERIAL_NO, '') = '' THEN ''
		                ELSE LEFT(RIGHT(A.ITEM_SERIAL_NO,9),6)
		            END                                                                    AS LOT_NO,
					B.ITEM_CODE,
					(CASE WHEN @RefItem = '1' THEN B.ITEM_NAME1
                    WHEN @RefItem = '2' THEN B.ITEM_NAME2
                                        ELSE B.ITEM_NAME
                     END)      AS ITEM_NAME,
                  	B.SPEC,
                  	B.STOCK_UNIT,
                  	C.ORDER_UNIT,
                  	C.ITEM_ACCOUNT,
                  	C.WH_CODE
			 FROM PMR160T A  WITH (NOLOCK)
			 INNER JOIN BPR100T B WITH (NOLOCK) ON B.COMP_CODE = A.COMP_CODE
		                                        AND CASE WHEN LEN(A.ITEM_SERIAL_NO)-11>0 THEN SUBSTRING(A.ITEM_SERIAL_NO,1,LEN(A.ITEM_SERIAL_NO)-11)
												 ELSE ''
												END   = B.ITEM_CODE
		     INNER JOIN BPR200T C WITH (NOLOCK) ON C.COMP_CODE = B.COMP_CODE
                                                      AND C.DIV_CODE = #{DIV_CODE}
                                                      AND C.ITEM_CODE = B.ITEM_CODE
			 WHERE A.COMP_CODE = #{S_COMP_CODE}
		 	   AND (A.INOUT_NUM	 IS NULL OR A.INOUT_NUM	='')
		 	<if test="@foren.Ognl@isNotEmpty(BOX_BARCODE)">
		       AND A.BOX_BARCODE = #{BOX_BARCODE}
	     	</if>
	     	<if test="@foren.Ognl@isNotEmpty(BARCODE)">
		       AND A.ITEM_SERIAL_NO = #{BARCODE}
	     	</if>
     		SET ARITHABORT OFF
            SET NOCOUNT OFF
        END
    </select>
    <select id="outStorageServiceImpl.selectOutInstructItem_yg" parameterType="Map" resultType="rMap">
     BEGIN
		    SET NOCOUNT ON
		    SET ARITHABORT ON

		    DECLARE @CompCode    NVARCHAR(08) /* 법인코드    */
		          , @UserId      NVARCHAR(100) /* 사용자ID    */
		          , @LangType    NVARCHAR(2)  /* 언어구분    */
		          , @RefItem     NVARCHAR(01) /* 명칭 참조 유형  */
		          , @DateFormat  NVARCHAR(10) /* 날짜 포맷 유형 설정 */
		          , @TimeSI      NVARCHAR(01)
		          , @TimeSR      NVARCHAR(01)
		          , @TimeSS      NVARCHAR(01)

		    SELECT @TimeSI = MAX(CASE WHEN SUB_CODE = 'SI' THEN REF_CODE1 ELSE '' END)
		         , @TimeSR = MAX(CASE WHEN SUB_CODE = 'SR' THEN REF_CODE1 ELSE '' END)
		         , @TimeSS = MAX(CASE WHEN SUB_CODE = 'SS' THEN REF_CODE1 ELSE '' END)

		     FROM BSA100T
		    WHERE COMP_CODE = @CompCode
		      AND MAIN_CODE = N'S048'
		      AND SUB_CODE IN (N'SI', N'SR', N'SS')

		    IF @TimeSI IS NULL
		        SET @TimeSI = 'N'
		    IF @TimeSR IS NULL
		        SET @TimeSR = 'N'
		    IF @TimeSS IS NULL
		        SET @TimeSS = 'N'

		    SET @CompCode = #{S_COMP_CODE}
		    SET @UserId   = #{S_USER_ID}
		    SET @LangType = #{S_LANG_CODE}

		    /* 명칭 참조 유형 */
		    SELECT TOP 1 @RefItem = REF_ITEM
		      FROM BSA300T WITH (NOLOCK)
		     WHERE USER_ID = @UserId

		    SET @RefItem = ISNULL(@RefItem, N'0')

		    /* 날짜 포맷 유형 설정 */
		    SELECT TOP 1 @DateFormat = CODE_NAME
		      FROM BSA100T WITH (NOLOCK)
		     WHERE COMP_CODE = @CompCode
		       AND MAIN_CODE = N'B044'
		       AND REF_CODE1 = N'Y'

		    SET @DateFormat = ISNULL(@DateFormat, 'YYYY.MM.DD')


		    /* 데이터 조회 */
		    SELECT
		           CAST(0 AS BIT)                                                          AS CHOICE
		         ,(CASE WHEN @RefItem = '1' THEN C1.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C1.CUSTOM_NAME2
		                                    ELSE C1.CUSTOM_NAME
		            END)                                                                   AS CUSTOM_NAME
		         , A.ITEM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C2.ITEM_NAME1
		                WHEN @RefItem = '2' THEN C2.ITEM_NAME2
		                                    ELSE C2.ITEM_NAME
		            END)                                                                   AS ITEM_NAME
		         , C2.SPEC

		         , A.ORDER_UNIT
		         , A.TRANS_RATE
		         , CAST(A.ISSUE_REQ_DATE AS DATETIME) AS ISSUE_REQ_DATE
		         ,(CASE WHEN ISNULL(A.ISSUE_DATE , '') = ''
		                     THEN ''
		                     ELSE REPLACE(REPLACE(REPLACE(@DateFormat , 'YYYY' , SUBSTRING(A.ISSUE_DATE, 1, 4))
		                                                              , 'MM'   , SUBSTRING(A.ISSUE_DATE, 5, 2))
		                                                              , 'DD'   , SUBSTRING(A.ISSUE_DATE, 7, 2))
		                END) + RTRIM(' ' + CASE @TimeSR WHEN 'Y' THEN ISNULL(A.DELIVERY_TIME,'')
		                                                ELSE ''
		                                    END)                                          AS ISSUE_DATE
		         ,(A.ISSUE_REQ_QTY - A.ISSUE_QTY)                                         AS NOT_REQ_Q
		         , A.ISSUE_REQ_QTY
		         , A.ISSUE_WGT_Q
		         , A.ISSUE_VOL_Q
		         , ISNULL(D.GOOD_STOCK_Q, 0)                                              AS STOCK_Q
		         , A.WH_CODE
		         , A.ORDER_NUM
		         , A.ISSUE_REQ_NUM
		         , A.ISSUE_REQ_SEQ
		         , A.PROJECT_NO
		         , E.PAY_METHODE1                                                         AS PAY_METHODE1
		         , E1.LC_SER_NO                                                           AS LC_SER_NO
		        -- , A.LOT_NO
		         , B.RECEIVER_ID
		         , B.RECEIVER_NAME
		         , B.TELEPHONE_NUM1
		         , B.TELEPHONE_NUM2
		         , ISNULL(B.ADDRESS1, '') + ISNULL(B.ADDRESS2, '')                        AS ADDRESS
		         ,(CASE WHEN @RefItem = '1' THEN C6.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C6.CUSTOM_NAME2
		                                    ELSE C6.CUSTOM_NAME
		            END)                                                                  AS ORDER_CUST_CD
		         , A.DIV_CODE
		         , A.CUSTOM_CODE
		         , A.INOUT_TYPE_DETAIL
		         , A.WH_CELL_CODE
		         , C5.WH_CELL_NAME
		         , A.ISSUE_REQ_PRICE
		         , A.ISSUE_REQ_AMT
		         , A.ISSUE_REQ_TAX_AMT
		         , A.TAX_TYPE
		         , A.MONEY_UNIT
		         , A.EXCHANGE_RATE
		         , A.ACCOUNT_YNC
		         , A.DISCOUNT_RATE
		         , A.ISSUE_REQ_PRSN                                                       AS ISSUE_REQ_PRSN
		         , A.DVRY_CUST_CD
		         , A.REMARK
		         , A.SER_NO
		         , A.SALE_CUSTOM_CODE
		         ,(CASE WHEN @RefItem = '1' THEN C4.CUSTOM_NAME1
		                WHEN @RefItem = '2' THEN C4.CUSTOM_NAME2
		                                     ELSE C4.CUSTOM_NAME
		            END)                                                                  AS SALE_CUST_CD
		         , A.ISSUE_DIV_CODE
		         , A.BILL_TYPE
		         , A.ORDER_TYPE
		         , A.PRICE_YN
		         , A.PO_NUM
		         , A.PO_SEQ
		         , C1.CREDIT_YN
		         , ISNULL(C1.WON_CALC_BAS , '3')                                          AS WON_CALC_BAS
		         , ISNULL(C1.TAX_TYPE     , '1')                                          AS TAX_INOUT
		         , A.AGENT_TYPE
		         , ISNULL(C2.STOCK_CARE_YN, 'Y')                                          AS STOCK_CARE_YN
		         , C2.STOCK_UNIT
		         , C7.DVRY_CUST_NM                                                        AS DVRY_CUST_NAME
		         , C.TAX_INOUT                                                            AS SOF100_TAX_INOUT
		         , CASE WHEN ISNULL(B.RETURN_Q, 0) &gt; 0 THEN 'Y' ELSE 'N' END              AS RETURN_Q_YN
		         , CASE WHEN ISNULL(A.REF_LOC, '1') = '1' THEN ISNULL(B.ORDER_Q, 0)
		                                                  ELSE ISNULL(E1.QTY, 0)
		            END                                                                   AS ORDER_Q
		         , CASE WHEN ISNULL(M1.REF_CODE2, '') = '' THEN M1.SUB_CODE
		                ELSE M1.REF_CODE2
		           END                                                                    AS REF_CODE2
		         , ISNULL(C2.EXCESS_RATE, 0)                                              AS EXCESS_RATE
		         , A.DEPT_CODE
		         , C3.ITEM_ACCOUNT
		         , A.PRICE_TYPE
		         , A.ISSUE_FOR_WGT_P
		         , A.ISSUE_WGT_P
		         , A.ISSUE_FOR_VOL_P
		         , A.ISSUE_VOL_P
		         , A.WGT_UNIT
		         , A.UNIT_WGT
		         , A.VOL_UNIT
		         , A.UNIT_VOL
				 , F.ITEM_SERIAL_NO
				 , F.BOX_BARCODE
				 , F.BOX_BARCODE AS BARCODE
				 , CASE WHEN ISNULL(F.ITEM_SERIAL_NO, '') = '' THEN ''
		                ELSE RIGHT(F.ITEM_SERIAL_NO,3)
		           END                                                                    AS SERIAL
		         , CASE WHEN ISNULL(F.ITEM_SERIAL_NO, '') = '' THEN ''
		                ELSE LEFT(RIGHT(F.ITEM_SERIAL_NO,9),6)
		           END                                                                    AS LOT_NO
		      FROM            SRQ100T A  WITH (NOLOCK)
		      	   INNER JOIN PMR160T F  WITH (NOLOCK) ON F.COMP_CODE      = A.COMP_CODE
		      	   									  AND (F.INOUT_NUM	 IS NULL OR F.INOUT_NUM	='')
		      	   									  AND CASE WHEN LEN(F.ITEM_SERIAL_NO)-9>0 THEN SUBSTRING(F.ITEM_SERIAL_NO,1,LEN(F.ITEM_SERIAL_NO)-9)
														 ELSE ''
														END   = A.ITEM_CODE
													  AND F.BOX_BARCODE = #{BARCODE}
		           LEFT  JOIN SOF110T B  WITH (NOLOCK) ON  B.COMP_CODE      = A.COMP_CODE
		                                              AND  B.DIV_CODE       = A.DIV_CODE
		                                              AND  B.ORDER_NUM      = A.ORDER_NUM
		                                              AND  B.SER_NO         = A.SER_NO
		           LEFT  JOIN SOF100T C  WITH (NOLOCK) ON  C.COMP_CODE      = B.COMP_CODE
		                                              AND  C.DIV_CODE       = B.DIV_CODE
		                                              AND  C.ORDER_NUM      = B.ORDER_NUM
		           LEFT  JOIN BIV100T D  WITH (NOLOCK) ON  D.COMP_CODE      = A.COMP_CODE
		                                              AND  D.DIV_CODE       = A.ISSUE_DIV_CODE
		                                              AND  D.WH_CODE        = A.WH_CODE
		                                              AND  D.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BCM100T C1 WITH (NOLOCK) ON C1.COMP_CODE      = A.COMP_CODE
		                                              AND C1.CUSTOM_CODE    = A.CUSTOM_CODE
		           INNER JOIN BPR100T C2 WITH (NOLOCK) ON C2.COMP_CODE      = A.COMP_CODE
		                                              AND C2.ITEM_CODE      = A.ITEM_CODE
		           INNER JOIN BPR200T C3 WITH (NOLOCK) ON C3.COMP_CODE      = A.COMP_CODE
		                                              AND C3.DIV_CODE       = A.DIV_CODE
		                                              AND C3.ITEM_CODE      = A.ITEM_CODE
		           LEFT  JOIN BCM100T C4 WITH (NOLOCK) ON C4.COMP_CODE      = A.COMP_CODE
		                                              AND C4.CUSTOM_CODE    = A.SALE_CUSTOM_CODE
		           LEFT  JOIN BSA225T C5 WITH (NOLOCK) ON C5.COMP_CODE      = A.COMP_CODE
		                                              AND C5.DIV_CODE       = A.DIV_CODE
		                                              AND C5.WH_CODE        = A.WH_CODE
		                                              AND C5.WH_CELL_CODE   = A.WH_CELL_CODE
		           LEFT  JOIN BCM100T C6 WITH (NOLOCK) ON C6.COMP_CODE      = C.COMP_CODE
		                                              AND C6.CUSTOM_CODE    = C.CUSTOM_CODE
		           LEFT  JOIN SCM100T C7 WITH (NOLOCK) ON C7.COMP_CODE      = A.COMP_CODE
		                                              AND C7.CUSTOM_CODE    = A.CUSTOM_CODE
		                                              AND CONVERT(NVARCHAR, C7.DVRY_CUST_SEQ) = A.DVRY_CUST_CD
		           LEFT  JOIN BSA100T M1 WITH (NOLOCK) ON M1.COMP_CODE      = A.COMP_CODE
		                                              AND M1.MAIN_CODE      = N'S007'
		                                              AND M1.SUB_CODE       = A.INOUT_TYPE_DETAIL
		           LEFT  JOIN TEA100T E  WITH (NOLOCK) ON E.COMP_CODE       = A.COMP_CODE
		                                              AND E.DIV_CODE        = A.DIV_CODE
		                                              AND E.SO_SER_NO       = A.ORDER_NUM
		           LEFT  JOIN TEA110T E1 WITH (NOLOCK) ON E1.COMP_CODE      = A.COMP_CODE
		                                              AND E1.DIV_CODE       = A.DIV_CODE
		                                              AND E1.SO_SER_NO      = A.ORDER_NUM
		                                              AND E1.SO_SER         = A.SER_NO

		     WHERE A.COMP_CODE        = @CompCode
		       AND A.ISSUE_REQ_NUM     = #{ISSUE_REQ_NUM}

		     ORDER BY A.ISSUE_REQ_NUM, A.ISSUE_REQ_SEQ, C1.CUSTOM_NAME, A.ISSUE_REQ_PRSN DESC, A.ITEM_CODE, A.ISSUE_DATE

		    SET NOCOUNT OFF
		    SET ARITHABORT OFF
		END
    </select>
</mapper>